"use strict";(self.webpackChunk_jstpierre_noclip_website=self.webpackChunk_jstpierre_noclip_website||[]).push([[84],{3084(t,e,r){r.d(e,{makeDebugTextDrawer:()=>B});var n,i,s,a=r(7714),o=r(2003),c=r(4439),h=r(7684),l=r(4796),g=r(329),u=r(5339),f=r(7459),d=r(5974),p=r(4107),C=r(8771),m=r(1659),U=r(3489);!function(t){t[t.Glyph=0]="Glyph",t[t.Texture=1]="Texture"}(n||(n={})),function(t){t[t.UTF8=0]="UTF8",t[t.UTF16=1]="UTF16",t[t.SJIS=2]="SJIS",t[t.CP1252=3]="CP1252"}(i||(i={})),function(t){t[t.Offset=0]="Offset",t[t.Array=1]="Array",t[t.Dict=2]="Dict"}(s||(s={}));class w{constructor(t,e){this.rfnt=e,this.gfxTextures=[],this.viewerTextures=[];for(let e=0;e<this.rfnt.textures.length;e++){const r=(0,p.HY)(this.rfnt.textures[e]),n=(0,C.ln)(t,r);this.gfxTextures.push(n.gfxTexture),this.viewerTextures.push(n.viewerTexture)}const r=new m.I(this.rfnt.name);r.setChanCtrl(o.UQ.COLOR0A0,!1,o.uj.REG,o.uj.VTX,0,o.jN.NONE,o.bg.NONE),r.setTexCoordGen(o.gw.TEXCOORD0,o.s3.MTX2x4,o.Kx.TEX0,o.b1.IDENTITY),r.setTevOrder(0,o.gw.TEXCOORD0,o.zH.TEXMAP0,o.Ug.COLOR_ZERO),r.setTevColorIn(0,o.CC.C0,o.CC.C1,o.CC.TEXC,o.CC.ZERO),r.setTevAlphaIn(0,o.CA.A0,o.CA.A1,o.CA.TEXA,o.CA.ZERO),r.setTevColorOp(0,o.fQ.ADD,o.bt.ZERO,o.mX.SCALE_1,!0,o.UZ.PREV),r.setTevAlphaOp(0,o.fQ.ADD,o.bt.ZERO,o.mX.SCALE_1,!0,o.UZ.PREV),r.setTevOrder(1,o.gw.TEXCOORD_NULL,o.zH.TEXMAP_NULL,o.Ug.COLOR0A0),r.setTevColorIn(1,o.CC.ZERO,o.CC.CPREV,o.CC.RASC,o.CC.ZERO),r.setTevAlphaIn(1,o.CA.ZERO,o.CA.APREV,o.CA.RASA,o.CA.ZERO),r.setTevColorOp(1,o.fQ.ADD,o.bt.ZERO,o.mX.SCALE_1,!0,o.UZ.PREV),r.setTevAlphaOp(1,o.fQ.ADD,o.bt.ZERO,o.mX.SCALE_1,!0,o.UZ.PREV),r.setZMode(!1,o.oH.ALWAYS,!1),r.setBlendMode(o.Nx.BLEND,o.dn.SRCALPHA,o.dn.INVSRCALPHA),r.setUsePnMtxIdx(!1),this.materialHelper=new C.kg(r.finish())}destroy(t){for(let e=0;e<this.gfxTextures.length;e++)t.destroyTexture(this.gfxTextures[e])}}function T(t,e){const r=t.cmap[e];return 65535===r?t.defaultGlyphIndex:r}const A=new C.gA;class x{constructor(){this.cursor=g.vt(),this.origin=g.vt(),this.scale=g.vt(),this.charSpacing=0,this.lineHeight=0,this.numVertex=0,this.colorT=(0,f.Zv)(f.c),this.colorB=(0,f.Zv)(f.c),this.color0=(0,f.Zv)(f.gh),this.color1=(0,f.Zv)(f.c),this.materialChanged=!1,this.textureMapping=(0,d.y5)(1,()=>new U.C$)}setFont(t,e=null,r=null,n=null,i=null){this.font=t;const s=this.font.rfnt;this.scale[0]=null!==n?n/s.width:1,this.scale[1]=null!==i?i/s.height:1,null!==e&&(this.charSpacing=e),null!==r&&(this.lineHeight=r)}setColorMapping(t,e=t){(0,f.z5)(this.color0,t),(0,f.z5)(this.color1,e),this.materialChanged=!0}getScaledLineHeight(){return this.lineHeight+this.font.rfnt.advanceHeight*this.scale[1]}calcRectFromCursor(t){t[0]=Math.min(t[0],this.cursor[0]),t[1]=Math.min(t[1],this.cursor[1]),t[2]=Math.max(t[2],this.cursor[0]),t[3]=Math.max(t[3],this.cursor[1])}advanceCharacter(t,e,r){r&&(this.cursor[0]+=this.charSpacing);const n=T(this.font.rfnt,e),i=this.font.rfnt.glyphInfo[n];this.cursor[0]+=i.cwdh.advanceWidth*this.scale[0],this.calcRectFromCursor(t),this.numVertex+=4}calcRect(t,e,r=null){let n=!1;this.numVertex=0,t[0]=this.cursor[0],t[1]=this.cursor[1],t[2]=this.cursor[0],t[3]=this.cursor[1],null!==r&&r.reset(this,t);for(let i=0;i<e.length;i++){const s=e.charCodeAt(i);s<32?null!==r&&(i=r.processTag(this,t,e,i)-1):(this.advanceCharacter(t,s,n),n=!0)}this.cursor[1]-=this.getScaledLineHeight(),this.calcRectFromCursor(t)}drawStringGlyph(t,e){const r=this.font.rfnt,n=e.cwdh,i=this.cursor[0]+n.leftSideBearing*this.scale[0],s=i+n.width*this.scale[0],a=this.cursor[1]-(r.ascent-r.glyphBaseline)*this.scale[1],c=a-r.height*this.scale[1],h=this.cursor[2],l=(e.s1b+e.cwdh.width)*e.s1m;t.begin(o.uB.DRAW_QUADS,4),t.position3f32(i,a,h),t.color4color(o.cg.CLR0,this.colorT),t.texCoord2f32(o.cg.TEX0,e.s0,e.t0),t.position3f32(s,a,h),t.color4color(o.cg.CLR0,this.colorT),t.texCoord2f32(o.cg.TEX0,l,e.t0),t.position3f32(s,c,h),t.color4color(o.cg.CLR0,this.colorB),t.texCoord2f32(o.cg.TEX0,l,e.t1),t.position3f32(i,c,h),t.color4color(o.cg.CLR0,this.colorB),t.texCoord2f32(o.cg.TEX0,e.s0,e.t1),t.end()}drawStringFlush(t,e){if(!e.hasIndicesToDraw())return;const r=e.makeRenderInst(t);r.setSamplerBindingsFromTextureMappings(this.textureMapping),t.submitRenderInst(r)}makeMaterialUBO(t){(0,f.z5)(A.u_Color[C.k2.C0],this.color0),(0,f.z5)(A.u_Color[C.k2.C1],this.color1),this.font.materialHelper.allocateMaterialParamsDataOnInst(t,A)}writeCharacter(t,e){e&&(this.cursor[0]+=this.charSpacing);const r=T(this.font.rfnt,t),n=this.font.rfnt.glyphInfo[r],i=this.font.gfxTextures[n.textureIndex],s=i!==this.textureMapping[0].gfxTexture;(s||this.materialChanged)&&(this.drawStringFlush(this.renderInstManager,this.ddraw),s&&(this.textureMapping[0].gfxTexture=i),this.materialChanged&&(this.makeMaterialUBO(this.renderInstManager.getTemplateRenderInst()),this.materialChanged=!1)),this.drawStringGlyph(this.ddraw,n),this.cursor[0]+=n.cwdh.advanceWidth*this.scale[0]}drawString(t,e,r,n,i=null){this.textureMapping[0].gfxSampler=e.createSampler({wrapS:a.Vf.Clamp,wrapT:a.Vf.Clamp,minFilter:a.gD.Bilinear,magFilter:a.gD.Bilinear,mipFilter:a.P.Nearest,minLOD:0,maxLOD:100}),this.renderInstManager=t,this.ddraw=r;const s=t.pushTemplateRenderInst();this.font.materialHelper.setOnRenderInst(e,s),this.makeMaterialUBO(s),this.textureMapping[0].gfxTexture=null,null!==i&&i.reset(this,null);let o=!1;for(let t=0;t<n.length;t++){const e=n.charCodeAt(t);e<32?null!==i&&(t=i.processTag(this,null,n,t)-1):(this.writeCharacter(e,o),o=!0)}this.drawStringFlush(t,r),t.popTemplateRenderInst(),this.renderInstManager=null,this.ddraw=null}}var D,v,R=r(305),S=r(1413);function y(t){const e=S.T.yaz0dec(t.createTypedArray(Uint8Array));return R.A.fromView(e)}!function(t){t[t.Normal=1]="Normal",t[t.Directory=2]="Directory",t[t.Compressed=4]="Compressed",t[t.CompressionType=128]="CompressionType"}(D||(D={})),function(t){t[t.None=0]="None",t[t.Yay0=1]="Yay0",t[t.Yaz0=2]="Yaz0",t[t.ASR=3]="ASR"}(v||(v={}));class O{constructor(t,e,r){this.files=t,this.root=e,this.name=r}findDirParts(t){let e=this.root;for(let r=0;r<t.length;r++){const n=t[r];if(e=e.subdirs.find(t=>t.name.toLowerCase()===n),void 0===e)return null}return e}findDir(t){return this.findDirParts(t.toLowerCase().split("/"))}findFile(t){const e=(t=t.toLowerCase()).split("/"),r=e.pop(),n=this.findDirParts(e);return null===n?null:function(t,e){return t.files.find(t=>t.name.toLowerCase()===e.toLowerCase())||null}(n,r)}findFileData(t){const e=this.findFile(t);return null===e?null:e.buffer}findFilenameData(t){for(let e=0;e<this.files.length;e++)if(this.files[e].name.toLowerCase()===t.toLowerCase())return this.files[e].buffer;return null}}function E(t,e){if(e===v.Yaz0)return y(t);if(e===v.Yay0)return function(t){const e=t.createDataView();(0,d.vA)("Yay0"===(0,d.E3)(t,0,4));let r=e.getUint32(4,!1),n=e.getUint32(8,!1),i=e.getUint32(12,!1),s=16;const a=new Uint8Array(r);let o=0;for(;;){const t=e.getUint8(s++);let c=8;for(;c--;){if(t&1<<c)r--,a[o++]=e.getUint8(i++);else{const t=e.getUint16(n,!1);n+=2;const s=1+(4095&t);let c=2+(t>>12);2===c&&(c+=e.getUint8(i++)+16),(0,d.vA)(c>=3&&c<=273);let h=o-s;for(r-=c;c--;)a[o++]=a[h++]}if(r<=0)return new R.A(a.buffer)}}}(t);throw"whoops"}var I=r(738),b=r(9667),L=r(8528),P=r(9918);const F=h.vt(),M=l.vt(),Z=new C.TD;class _{constructor(t,e){this.fontData=e,this.charWriter=new x,this.ddraw=new I.l,this.textColor=(0,f.Zv)(f.c),this.strokeColor=(0,f.Zv)(f.jR),this.renderCache=new P.g(t),this.charWriter.setFont(e,0,0);const r=this.ddraw;r.setVtxDesc(o.cg.POS,!0),r.setVtxDesc(o.cg.CLR0,!0),r.setVtxDesc(o.cg.TEX0,!0)}setSceneParams(t,e,r,n){let i=t.allocateUniformBuffer(b.vn.ub_SceneParams,C.sl);const s=t.mapUniformBufferF32(b.vn.ub_SceneParams);(0,u.Gh)(Z.u_Projection,0,e,0,r,-1e4,1e4),(0,L._)(Z.u_Projection,n,a.uA.NegativeOne),(0,C.E_)(s,i,Z)}setDrawParams(t){let e=t.allocateUniformBuffer(b.vn.ub_DrawParams,16);const r=t.mapUniformBufferF32(b.vn.ub_DrawParams);h.D_(F),e+=(0,c.s2)(r,e,F)}beginDraw(){this.ddraw.beginDraw(this.renderCache)}endDraw(t){this.ddraw.endDraw(t)}setFontScale(t){this.charWriter.scale[0]=t,this.charWriter.scale[1]=t}getScaledLineHeight(){return this.charWriter.getScaledLineHeight()}reserveString(t,e=4){const r=(1+e)*t;this.ddraw.allocPrimitives(o.uB.DRAW_QUADS,4*r)}drawString(t,e,r,n,i,s,a=1,o=4){const c=this.renderCache;g.v_(this.charWriter.origin),g.C(this.charWriter.cursor,this.charWriter.origin),this.charWriter.calcRect(M,n);const h=M[0];i-=(M[2]-h)/2;const l=t.pushTemplateRenderInst();l.setBindingLayouts(C.md);const d=c.device.queryVendorInfo().clipSpaceNearZ;this.setSceneParams(l,e,r,d),this.setDrawParams(l),(0,f.z5)(this.charWriter.color1,this.strokeColor);for(let e=0;e<o;e++){const r=e*u.wZ.TAU/o,h=a*Math.sin(r),l=a*Math.cos(r);g.hZ(this.charWriter.cursor,i+l,s+h,0),this.charWriter.drawString(t,c,this.ddraw,n)}(0,f.z5)(this.charWriter.color1,this.textColor),g.hZ(this.charWriter.cursor,i,s,0),this.charWriter.drawString(t,c,this.ddraw,n),t.popTemplateRenderInst()}destroy(t){this.fontData.destroy(t),this.ddraw.destroy(t),this.renderCache.destroy()}}async function B(t){return t.dataShare.ensureObject("DebugTextDrawer",async()=>{const e=await t.dataFetcher.fetchData("SuperMarioGalaxy/LayoutData/Font.arc"),r=function(t){const e=t.createDataView();(0,d.vA)("RFNT"===(0,d.E3)(t,0,4));const r=e.getUint16(4);(0,d.vA)(65279===r||65534===r);const a=65534===r;(0,d.vA)(!a);const o=e.getUint16(6);(0,d.vA)(260===o),e.getUint32(8);const c=e.getUint16(12),h=e.getUint16(14);let l=c+0,g=null,u=null,f=null;const p=new Uint16Array(65536).fill(65535),C=[];for(let r=0;r<h;r++){const r=l,a=(0,d.E3)(t,r+0,4,!1),o=e.getUint32(r+4),c=r+8;if("FINF"===a){const t=e.getUint8(c+0);(0,d.vA)(t===n.Texture);const r=e.getUint8(c+1),s=e.getUint16(c+2);f={leftSideBearing:e.getInt8(c+4),width:e.getUint8(c+5),advanceWidth:e.getInt8(c+6)};const a=e.getUint8(c+7);(0,d.vA)(a===i.UTF16);const o=e.getUint8(c+20);g={advanceHeight:r,encoding:a,width:e.getUint8(c+21),height:o,ascent:e.getUint8(c+22),defaultGlyphIndex:s}}else if("TGLP"===a){const r=e.getUint8(c+0),n=e.getUint8(c+1),i=e.getUint8(c+2),s=(e.getUint8(c+3),e.getUint32(c+4)),a=e.getUint16(c+8),o=e.getUint16(c+10),h=e.getUint16(c+12),l=e.getUint16(c+14),g=e.getUint16(c+16),d=e.getUint16(c+18),p=[];let m=e.getUint32(c+20),U=0;for(let e=0;e<a;e++,m+=s){const i=e;p.push({name:`${t.name} Texture ${e}`,width:g,height:d,format:o,data:t.subarray(m,s),mipCount:1});for(let t=0;t<l;t++){const e=t*(n+1)/d,s=(t*(n+1)+n)/d;for(let t=0;t<h;t++){const n=t*(r+1)/g,a=t*(r+1),o=1/g;C[U++]={textureIndex:i,s0:n,t0:e,s1b:a,s1m:o,t1:s,cwdh:f}}}}u={glyphBaseline:i,textures:p}}else if("CWDH"===a){const t=e.getUint16(c+0),r=e.getUint16(c+2);let n=c+8;for(let i=t;i<=r;i++,n+=3){const t=e.getInt8(n+0),r=e.getUint8(n+1),s=e.getInt8(n+2);C[i].cwdh={leftSideBearing:t,width:r,advanceWidth:s}}}else{if("CMAP"!==a)throw"whoops";{const t=e.getUint16(c+0),r=e.getUint16(c+2),n=e.getUint16(c+4);if(n===s.Offset){const n=e.getUint16(c+12);for(let e=t;e<=r;e++)p[e]=e-t+n}else if(n==s.Array){let n=c+12;for(let i=t;i<=r;i++,n+=2)p[i]=e.getUint16(n+0)}else if(n===s.Dict){const t=e.getUint16(c+12);let r=c+10;for(let n=0;n<=t;n++,r+=4)p[e.getUint16(r+0)]=e.getUint16(r+2)}}}l+=o}return Object.assign(Object.assign(Object.assign({},(0,d.Z1)(g)),(0,d.Z1)(u)),{name:t.name,cmap:p,glyphInfo:C})}(function(t,e=""){const r=t.createDataView(),n=(0,d.E3)(t,0,4);(0,d.vA)("RARC"===n||"CRAR"===n);const i="CRAR"===n,s=(r.getUint32(4,i),r.getUint32(8,i));(0,d.vA)(32===s);const a=r.getUint32(12,i),o=(r.getUint32(16,i),r.getUint32(20,i),r.getUint32(24,i),s+a),c=r.getUint32(32,i),h=r.getUint32(36,i)+s,l=(r.getUint32(40,i),r.getUint32(44,i)+s),g=r.getUint32(52,i)+s;let u=h;const f=[],p=[];for(let e=0;e<c;e++){let e=(0,d.E3)(t,u+0,4,!1);i&&(e=e[3]+e[2]+e[1]+e[0]);const n=r.getUint32(u+4,i),s=(0,d.E3)(t,g+n,-1,!0),a=(r.getUint16(u+8,i),r.getUint16(u+10,i)),c=[],h=[];let C=l+20*r.getUint32(u+12,i);for(let e=0;e<a;e++){const e=(C-l)/20,n=r.getUint16(C+0,i),s=(r.getUint16(C+2,i),r.getUint32(C+4,i));let a=s>>>24&255;const u=16777215&s,f=(0,d.E3)(t,g+u,-1,!0),m=r.getUint32(C+8,i),U=r.getUint32(C+12,i);if(C+=20,"."!==f&&".."!==f)if(a&D.Directory){const t=m;h.push(t)}else{const r=o+m,i=t.slice(r,r+U);let s,h=v.None;a&D.Compressed&&(h=a&D.CompressionType?v.Yaz0:v.Yay0),s=h!==v.None?E(i,h):i,s.name=f;const l={index:e,id:n,name:f,flags:a,compressionType:h,buffer:s};c.push(l),p.push(l)}}f.push({name:s,type:e,files:c,subdirIndexes:h}),u+=16}const C=[],m=function t(e){if(void 0!==C[e])return C[e];const r=f[e],n=r.name,i=r.type,s=r.files,a=r.subdirIndexes.map(e=>t(e)),o={name:n,type:i,files:s,subdirs:a};return C[e]=o,o}(0);return(0,d.vA)("ROOT"===m.type),new O(p,m,e)}(await y(e)).findFileData("messagefont26.brfnt")),a=new w(t.device,r);return new _(t.device,a)})}}}]);