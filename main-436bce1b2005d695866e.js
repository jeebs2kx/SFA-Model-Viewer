/*! For license information please see main-436bce1b2005d695866e.js.LICENSE.txt */
(()=>{var e,t,s,n,i,r,a,o,l,h,c,u,d,m,p,f,g,T,x,v,C,b,_,y,S,w,A,E,R,I,k,M,P,D,B,L,O,F,U,N,X,V,G,K,$,W,H,Y,Z,z,j,q,Q,J,ee,te,se,ne,ie,re,ae,oe,le,he,ce,ue,de,me,pe={7823(e,t,s){"use strict";s.d(t,{p8:()=>n,tb:()=>i});var n=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;Math.random,Math.PI,Math.PI},7684(e,t,s){"use strict";s.d(t,{$0:()=>v,B8:()=>u,C:()=>a,CV:()=>x,D_:()=>h,N9:()=>b,Ny:()=>A,Qr:()=>g,TV:()=>E,Tl:()=>d,Z8:()=>f,e$:()=>p,fA:()=>o,hZ:()=>l,hs:()=>m,i1:()=>C,kN:()=>T,lK:()=>R,mg:()=>c,o8:()=>r,sC:()=>_,t5:()=>S,v3:()=>y,vt:()=>i,xI:()=>w});var n=s(7823);function i(){var e=new n.tb(16);return n.tb!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function r(e){var t=new n.tb(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function a(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function o(e,t,s,i,r,a,o,l,h,c,u,d,m,p,f,g){var T=new n.tb(16);return T[0]=e,T[1]=t,T[2]=s,T[3]=i,T[4]=r,T[5]=a,T[6]=o,T[7]=l,T[8]=h,T[9]=c,T[10]=u,T[11]=d,T[12]=m,T[13]=p,T[14]=f,T[15]=g,T}function l(e,t,s,n,i,r,a,o,l,h,c,u,d,m,p,f,g){return e[0]=t,e[1]=s,e[2]=n,e[3]=i,e[4]=r,e[5]=a,e[6]=o,e[7]=l,e[8]=h,e[9]=c,e[10]=u,e[11]=d,e[12]=m,e[13]=p,e[14]=f,e[15]=g,e}function h(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function c(e,t){if(e===t){var s=t[1],n=t[2],i=t[3],r=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=s,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=r,e[11]=t[14],e[12]=i,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function u(e,t){var s=t[0],n=t[1],i=t[2],r=t[3],a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],u=t[9],d=t[10],m=t[11],p=t[12],f=t[13],g=t[14],T=t[15],x=s*o-n*a,v=s*l-i*a,C=s*h-r*a,b=n*l-i*o,_=n*h-r*o,y=i*h-r*l,S=c*f-u*p,w=c*g-d*p,A=c*T-m*p,E=u*g-d*f,R=u*T-m*f,I=d*T-m*g,k=x*I-v*R+C*E+b*A-_*w+y*S;return k?(k=1/k,e[0]=(o*I-l*R+h*E)*k,e[1]=(i*R-n*I-r*E)*k,e[2]=(f*y-g*_+T*b)*k,e[3]=(d*_-u*y-m*b)*k,e[4]=(l*A-a*I-h*w)*k,e[5]=(s*I-i*A+r*w)*k,e[6]=(g*C-p*y-T*v)*k,e[7]=(c*y-d*C+m*v)*k,e[8]=(a*R-o*A+h*S)*k,e[9]=(n*A-s*R-r*S)*k,e[10]=(p*_-f*C+T*x)*k,e[11]=(u*C-c*_-m*x)*k,e[12]=(o*w-a*E-l*S)*k,e[13]=(s*E-n*w+i*S)*k,e[14]=(f*v-p*b-g*x)*k,e[15]=(c*b-u*v+d*x)*k,e):null}function d(e,t,s){var n,i,r,a,o,l,h,c,u,d,m,p,f=s[0],g=s[1],T=s[2];return t===e?(e[12]=t[0]*f+t[4]*g+t[8]*T+t[12],e[13]=t[1]*f+t[5]*g+t[9]*T+t[13],e[14]=t[2]*f+t[6]*g+t[10]*T+t[14],e[15]=t[3]*f+t[7]*g+t[11]*T+t[15]):(n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],m=t[10],p=t[11],e[0]=n,e[1]=i,e[2]=r,e[3]=a,e[4]=o,e[5]=l,e[6]=h,e[7]=c,e[8]=u,e[9]=d,e[10]=m,e[11]=p,e[12]=n*f+o*g+u*T+t[12],e[13]=i*f+l*g+d*T+t[13],e[14]=r*f+h*g+m*T+t[14],e[15]=a*f+c*g+p*T+t[15]),e}function m(e,t,s){var n=s[0],i=s[1],r=s[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function p(e,t,s,i){var r,a,o,l,h,c,u,d,m,p,f,g,T,x,v,C,b,_,y,S,w,A,E,R,I=i[0],k=i[1],M=i[2],P=Math.sqrt(I*I+k*k+M*M);return P<n.p8?null:(I*=P=1/P,k*=P,M*=P,r=Math.sin(s),o=1-(a=Math.cos(s)),l=t[0],h=t[1],c=t[2],u=t[3],d=t[4],m=t[5],p=t[6],f=t[7],g=t[8],T=t[9],x=t[10],v=t[11],C=I*I*o+a,b=k*I*o+M*r,_=M*I*o-k*r,y=I*k*o-M*r,S=k*k*o+a,w=M*k*o+I*r,A=I*M*o+k*r,E=k*M*o-I*r,R=M*M*o+a,e[0]=l*C+d*b+g*_,e[1]=h*C+m*b+T*_,e[2]=c*C+p*b+x*_,e[3]=u*C+f*b+v*_,e[4]=l*y+d*S+g*w,e[5]=h*y+m*S+T*w,e[6]=c*y+p*S+x*w,e[7]=u*y+f*S+v*w,e[8]=l*A+d*E+g*R,e[9]=h*A+m*E+T*R,e[10]=c*A+p*E+x*R,e[11]=u*A+f*E+v*R,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function f(e,t,s){var n=Math.sin(s),i=Math.cos(s),r=t[0],a=t[1],o=t[2],l=t[3],h=t[8],c=t[9],u=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i-h*n,e[1]=a*i-c*n,e[2]=o*i-u*n,e[3]=l*i-d*n,e[8]=r*n+h*i,e[9]=a*n+c*i,e[10]=o*n+u*i,e[11]=l*n+d*i,e}function g(e,t,s){var n=Math.sin(s),i=Math.cos(s),r=t[0],a=t[1],o=t[2],l=t[3],h=t[4],c=t[5],u=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i+h*n,e[1]=a*i+c*n,e[2]=o*i+u*n,e[3]=l*i+d*n,e[4]=h*i-r*n,e[5]=c*i-a*n,e[6]=u*i-o*n,e[7]=d*i-l*n,e}function T(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function x(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function v(e,t,s){var i,r,a,o=s[0],l=s[1],h=s[2],c=Math.sqrt(o*o+l*l+h*h);return c<n.p8?null:(o*=c=1/c,l*=c,h*=c,i=Math.sin(t),a=1-(r=Math.cos(t)),e[0]=o*o*a+r,e[1]=l*o*a+h*i,e[2]=h*o*a-l*i,e[3]=0,e[4]=o*l*a-h*i,e[5]=l*l*a+r,e[6]=h*l*a+o*i,e[7]=0,e[8]=o*h*a+l*i,e[9]=l*h*a-o*i,e[10]=h*h*a+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function C(e,t){var s=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function b(e,t){var s=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function _(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}var y=function(e,t,s,n,i,r,a){var o=1/(t-s),l=1/(n-i),h=1/(r-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*h,e[11]=0,e[12]=(t+s)*o,e[13]=(i+n)*l,e[14]=(a+r)*h,e[15]=1,e};function S(e,t,s,i){var r,a,o,l,c,u,d,m,p,f,g=t[0],T=t[1],x=t[2],v=i[0],C=i[1],b=i[2],_=s[0],y=s[1],S=s[2];return Math.abs(g-_)<n.p8&&Math.abs(T-y)<n.p8&&Math.abs(x-S)<n.p8?h(e):(d=g-_,m=T-y,p=x-S,r=C*(p*=f=1/Math.sqrt(d*d+m*m+p*p))-b*(m*=f),a=b*(d*=f)-v*p,o=v*m-C*d,(f=Math.sqrt(r*r+a*a+o*o))?(r*=f=1/f,a*=f,o*=f):(r=0,a=0,o=0),l=m*o-p*a,c=p*r-d*o,u=d*a-m*r,(f=Math.sqrt(l*l+c*c+u*u))?(l*=f=1/f,c*=f,u*=f):(l=0,c=0,u=0),e[0]=r,e[1]=l,e[2]=d,e[3]=0,e[4]=a,e[5]=c,e[6]=m,e[7]=0,e[8]=o,e[9]=u,e[10]=p,e[11]=0,e[12]=-(r*g+a*T+o*x),e[13]=-(l*g+c*T+u*x),e[14]=-(d*g+m*T+p*x),e[15]=1,e)}function w(e,t,s,n){var i=t[0],r=t[1],a=t[2],o=n[0],l=n[1],h=n[2],c=i-s[0],u=r-s[1],d=a-s[2],m=c*c+u*u+d*d;m>0&&(c*=m=1/Math.sqrt(m),u*=m,d*=m);var p=l*d-h*u,f=h*c-o*d,g=o*u-l*c;return(m=p*p+f*f+g*g)>0&&(p*=m=1/Math.sqrt(m),f*=m,g*=m),e[0]=p,e[1]=f,e[2]=g,e[3]=0,e[4]=u*g-d*f,e[5]=d*p-c*g,e[6]=c*f-u*p,e[7]=0,e[8]=c,e[9]=u,e[10]=d,e[11]=0,e[12]=i,e[13]=r,e[14]=a,e[15]=1,e}function A(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12]*s,e[13]=t[13]*s,e[14]=t[14]*s,e[15]=t[15]*s,e}function E(e,t,s,n){return e[0]=t[0]+s[0]*n,e[1]=t[1]+s[1]*n,e[2]=t[2]+s[2]*n,e[3]=t[3]+s[3]*n,e[4]=t[4]+s[4]*n,e[5]=t[5]+s[5]*n,e[6]=t[6]+s[6]*n,e[7]=t[7]+s[7]*n,e[8]=t[8]+s[8]*n,e[9]=t[9]+s[9]*n,e[10]=t[10]+s[10]*n,e[11]=t[11]+s[11]*n,e[12]=t[12]+s[12]*n,e[13]=t[13]+s[13]*n,e[14]=t[14]+s[14]*n,e[15]=t[15]+s[15]*n,e}var R=function(e,t,s){var n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],m=t[10],p=t[11],f=t[12],g=t[13],T=t[14],x=t[15],v=s[0],C=s[1],b=s[2],_=s[3];return e[0]=v*n+C*o+b*u+_*f,e[1]=v*i+C*l+b*d+_*g,e[2]=v*r+C*h+b*m+_*T,e[3]=v*a+C*c+b*p+_*x,v=s[4],C=s[5],b=s[6],_=s[7],e[4]=v*n+C*o+b*u+_*f,e[5]=v*i+C*l+b*d+_*g,e[6]=v*r+C*h+b*m+_*T,e[7]=v*a+C*c+b*p+_*x,v=s[8],C=s[9],b=s[10],_=s[11],e[8]=v*n+C*o+b*u+_*f,e[9]=v*i+C*l+b*d+_*g,e[10]=v*r+C*h+b*m+_*T,e[11]=v*a+C*c+b*p+_*x,v=s[12],C=s[13],b=s[14],_=s[15],e[12]=v*n+C*o+b*u+_*f,e[13]=v*i+C*l+b*d+_*g,e[14]=v*r+C*h+b*m+_*T,e[15]=v*a+C*c+b*p+_*x,e}},329(e,t,s){"use strict";s.d(t,{$A:()=>T,Bw:()=>a,C:()=>l,Il:()=>E,Io:()=>m,Ln:()=>d,Om:()=>g,S8:()=>f,WQ:()=>c,Z0:()=>x,Z8:()=>C,eL:()=>v,fA:()=>o,g7:()=>_,hZ:()=>h,hs:()=>u,jb:()=>w,o8:()=>r,t2:()=>S,v_:()=>y,vt:()=>i,x6:()=>b,xg:()=>A,ze:()=>p});var n=s(7823);function i(){var e=new n.tb(3);return n.tb!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(e){var t=new n.tb(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function a(e){var t=e[0],s=e[1],n=e[2];return Math.sqrt(t*t+s*s+n*n)}function o(e,t,s){var i=new n.tb(3);return i[0]=e,i[1]=t,i[2]=s,i}function l(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function h(e,t,s,n){return e[0]=t,e[1]=s,e[2]=n,e}function c(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function u(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function d(e,t,s,n){return e[0]=t[0]+s[0]*n,e[1]=t[1]+s[1]*n,e[2]=t[2]+s[2]*n,e}function m(e,t){var s=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(s*s+n*n+i*i)}function p(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function f(e,t){var s=t[0],n=t[1],i=t[2],r=s*s+n*n+i*i;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function g(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function T(e,t,s){var n=t[0],i=t[1],r=t[2],a=s[0],o=s[1],l=s[2];return e[0]=i*l-r*o,e[1]=r*a-n*l,e[2]=n*o-i*a,e}function x(e,t,s){var n=t[0],i=t[1],r=t[2],a=s[3]*n+s[7]*i+s[11]*r+s[15];return a=a||1,e[0]=(s[0]*n+s[4]*i+s[8]*r+s[12])/a,e[1]=(s[1]*n+s[5]*i+s[9]*r+s[13])/a,e[2]=(s[2]*n+s[6]*i+s[10]*r+s[14])/a,e}function v(e,t,s,n){var i=[],r=[];return i[0]=t[0]-s[0],i[1]=t[1]-s[1],i[2]=t[2]-s[2],r[0]=i[0],r[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),r[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),e[0]=r[0]+s[0],e[1]=r[1]+s[1],e[2]=r[2]+s[2],e}function C(e,t,s,n){var i=[],r=[];return i[0]=t[0]-s[0],i[1]=t[1]-s[1],i[2]=t[2]-s[2],r[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),r[1]=i[1],r[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),e[0]=r[0]+s[0],e[1]=r[1]+s[1],e[2]=r[2]+s[2],e}function b(e,t,s,n){var i=[],r=[];return i[0]=t[0]-s[0],i[1]=t[1]-s[1],i[2]=t[2]-s[2],r[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),r[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),r[2]=i[2],e[0]=r[0]+s[0],e[1]=r[1]+s[1],e[2]=r[2]+s[2],e}function _(e,t){var s=e[0],n=e[1],i=e[2],r=t[0],a=t[1],o=t[2],l=Math.sqrt((s*s+n*n+i*i)*(r*r+a*a+o*o)),h=l&&g(e,t)/l;return Math.acos(Math.min(Math.max(h,-1),1))}function y(e){return e[0]=0,e[1]=0,e[2]=0,e}function S(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var w=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e},A=m,E=a;i()},4796(e,t,s){"use strict";s.d(t,{Bw:()=>u,C:()=>o,Cc:()=>f,Om:()=>p,S8:()=>m,WQ:()=>h,Z0:()=>g,fA:()=>a,hZ:()=>l,hs:()=>c,m3:()=>d,o8:()=>r,t2:()=>T,vt:()=>i});var n=s(7823);function i(){var e=new n.tb(4);return n.tb!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function r(e){var t=new n.tb(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function a(e,t,s,i){var r=new n.tb(4);return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r}function o(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function l(e,t,s,n,i){return e[0]=t,e[1]=s,e[2]=n,e[3]=i,e}function h(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e}function c(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e}function u(e){var t=e[0],s=e[1],n=e[2],i=e[3];return Math.sqrt(t*t+s*s+n*n+i*i)}function d(e){var t=e[0],s=e[1],n=e[2],i=e[3];return t*t+s*s+n*n+i*i}function m(e,t){var s=t[0],n=t[1],i=t[2],r=t[3],a=s*s+n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a)),e[0]=s*a,e[1]=n*a,e[2]=i*a,e[3]=r*a,e}function p(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function f(e,t,s,n){var i=t[0],r=t[1],a=t[2],o=t[3];return e[0]=i+n*(s[0]-i),e[1]=r+n*(s[1]-r),e[2]=a+n*(s[2]-a),e[3]=o+n*(s[3]-o),e}function g(e,t,s){var n=t[0],i=t[1],r=t[2],a=t[3];return e[0]=s[0]*n+s[4]*i+s[8]*r+s[12]*a,e[1]=s[1]*n+s[5]*i+s[9]*r+s[13]*a,e[2]=s[2]*n+s[6]*i+s[10]*r+s[14]*a,e[3]=s[3]*n+s[7]*i+s[11]*r+s[15]*a,e}function T(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}i()},4741(e,t,s){var n;!function(e){!function(){var t="object"==typeof s.g?s.g:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),n=i(e);function i(e,t){return function(s,n){"function"!=typeof e[s]&&Object.defineProperty(e,s,{configurable:!0,writable:!0,value:n}),t&&t(s,n)}}void 0===t.Reflect?t.Reflect=e:n=i(t.Reflect,n),function(e){var t=Object.prototype.hasOwnProperty,s="function"==typeof Symbol,n=s&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",i=s&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",r="function"==typeof Object.create,a={__proto__:[]}instanceof Array,o=!r&&!a,l={create:r?function(){return O(Object.create(null))}:a?function(){return O({__proto__:null})}:function(){return O({})},has:o?function(e,s){return t.call(e,s)}:function(e,t){return t in e},get:o?function(e,s){return t.call(e,s)?e[s]:void 0}:function(e,t){return e[t]}},h=Object.getPrototypeOf(Function),c="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,u=c||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?function(){var e={},t=[],s=function(){function e(e,t,s){this._index=0,this._keys=e,this._values=t,this._selector=s}return e.prototype["@@iterator"]=function(){return this},e.prototype[i]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var s=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:s,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var s=this._find(e,!0);return this._values[s]=t,this},t.prototype.delete=function(t){var s=this._find(t,!1);if(s>=0){for(var n=this._keys.length,i=s+1;i<n;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new s(this._keys,this._values,n)},t.prototype.values=function(){return new s(this._keys,this._values,r)},t.prototype.entries=function(){return new s(this._keys,this._values,a)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[i]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function n(e,t){return e}function r(e,t){return t}function a(e,t){return[e,t]}}():Map,d=c||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?function(){function e(){this._map=new u}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[i]=function(){return this.keys()},e}():Set,m=new(c||"function"!=typeof WeakMap?function(){var e=l.create(),s=n();return function(){function e(){this._key=n()}return e.prototype.has=function(e){var t=i(e,!1);return void 0!==t&&l.has(t,this._key)},e.prototype.get=function(e){var t=i(e,!1);return void 0!==t?l.get(t,this._key):void 0},e.prototype.set=function(e,t){return i(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=i(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=n()},e}();function n(){var t;do{t="@@WeakMap@@"+a()}while(l.has(e,t));return e[t]=!0,t}function i(e,n){if(!t.call(e,s)){if(!n)return;Object.defineProperty(e,s,{value:l.create()})}return e[s]}function r(e,t){for(var s=0;s<t;++s)e[s]=255*Math.random()|0;return e}function a(){var e,t=(e=16,"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):r(new Uint8Array(e),e):r(new Array(e),e));t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var s="",n=0;n<16;++n){var i=t[n];4!==n&&6!==n&&8!==n||(s+="-"),i<16&&(s+="0"),s+=i.toString(16).toLowerCase()}return s}}():WeakMap);function p(e,t,s){var n=m.get(e);if(y(n)){if(!s)return;n=new u,m.set(e,n)}var i=n.get(t);if(y(i)){if(!s)return;i=new u,n.set(t,i)}return i}function f(e,t,s){if(g(e,t,s))return!0;var n=L(t);return!S(n)&&f(e,n,s)}function g(e,t,s){var n=p(t,s,!1);return!y(n)&&!!n.has(e)}function T(e,t,s){if(g(e,t,s))return x(e,t,s);var n=L(t);return S(n)?void 0:T(e,n,s)}function x(e,t,s){var n=p(t,s,!1);if(!y(n))return n.get(e)}function v(e,t,s,n){p(s,n,!0).set(e,t)}function C(e,t){var s=b(e,t),n=L(e);if(null===n)return s;var i=C(n,t);if(i.length<=0)return s;if(s.length<=0)return i;for(var r=new d,a=[],o=0,l=s;o<l.length;o++){var h=l[o];r.has(h)||(r.add(h),a.push(h))}for(var c=0,u=i;c<u.length;c++)h=u[c],r.has(h)||(r.add(h),a.push(h));return a}function b(e,t){var s=[],n=p(e,t,!1);if(y(n))return s;for(var r=function(e){var t=M(e,i);if(!I(t))throw new TypeError;var s=t.call(e);if(!w(s))throw new TypeError;return s}(n.keys()),a=0;;){var o=D(r);if(!o)return s.length=a,s;var l=P(o);try{s[a]=l}catch(e){try{B(r)}finally{throw e}}a++}}function _(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function y(e){return void 0===e}function S(e){return null===e}function w(e){return"object"==typeof e?null!==e:"function"==typeof e}function A(e,t){switch(_(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var s=3===t?"string":5===t?"number":"default",i=M(e,n);if(void 0!==i){var r=i.call(e,s);if(w(r))throw new TypeError;return r}return function(e,t){if("string"===t){var s=e.toString;if(I(s)&&!w(i=s.call(e)))return i;if(I(n=e.valueOf)&&!w(i=n.call(e)))return i}else{var n;if(I(n=e.valueOf)&&!w(i=n.call(e)))return i;var i,r=e.toString;if(I(r)&&!w(i=r.call(e)))return i}throw new TypeError}(e,"default"===s?"number":s)}function E(e){var t=A(e,3);return"symbol"==typeof t?t:function(e){return""+e}(t)}function R(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function I(e){return"function"==typeof e}function k(e){return"function"==typeof e}function M(e,t){var s=e[t];if(null!=s){if(!I(s))throw new TypeError;return s}}function P(e){return e.value}function D(e){var t=e.next();return!t.done&&t}function B(e){var t=e.return;t&&t.call(e)}function L(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===h)return t;if(t!==h)return t;var s=e.prototype,n=s&&Object.getPrototypeOf(s);if(null==n||n===Object.prototype)return t;var i=n.constructor;return"function"!=typeof i||i===e?t:i}function O(e){return e.__=void 0,delete e.__,e}e("decorate",function(e,t,s,n){if(y(s)){if(!R(e))throw new TypeError;if(!k(t))throw new TypeError;return function(e,t){for(var s=e.length-1;s>=0;--s){var n=(0,e[s])(t);if(!y(n)&&!S(n)){if(!k(n))throw new TypeError;t=n}}return t}(e,t)}if(!R(e))throw new TypeError;if(!w(t))throw new TypeError;if(!w(n)&&!y(n)&&!S(n))throw new TypeError;return S(n)&&(n=void 0),function(e,t,s,n){for(var i=e.length-1;i>=0;--i){var r=(0,e[i])(t,s,n);if(!y(r)&&!S(r)){if(!w(r))throw new TypeError;n=r}}return n}(e,t,s=E(s),n)}),e("metadata",function(e,t){return function(s,n){if(!w(s))throw new TypeError;if(!y(n)&&!function(e){switch(_(e)){case 3:case 4:return!0;default:return!1}}(n))throw new TypeError;v(e,t,s,n)}}),e("defineMetadata",function(e,t,s,n){if(!w(s))throw new TypeError;return y(n)||(n=E(n)),v(e,t,s,n)}),e("hasMetadata",function(e,t,s){if(!w(t))throw new TypeError;return y(s)||(s=E(s)),f(e,t,s)}),e("hasOwnMetadata",function(e,t,s){if(!w(t))throw new TypeError;return y(s)||(s=E(s)),g(e,t,s)}),e("getMetadata",function(e,t,s){if(!w(t))throw new TypeError;return y(s)||(s=E(s)),T(e,t,s)}),e("getOwnMetadata",function(e,t,s){if(!w(t))throw new TypeError;return y(s)||(s=E(s)),x(e,t,s)}),e("getMetadataKeys",function(e,t){if(!w(e))throw new TypeError;return y(t)||(t=E(t)),C(e,t)}),e("getOwnMetadataKeys",function(e,t){if(!w(e))throw new TypeError;return y(t)||(t=E(t)),b(e,t)}),e("deleteMetadata",function(e,t,s){if(!w(t))throw new TypeError;y(s)||(s=E(s));var n=p(t,s,!1);if(y(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var i=m.get(t);return i.delete(s),i.size>0||m.delete(t),!0})}(n)}()}(n||(n={}))},305(e,t,s){"use strict";s.d(t,{A:()=>a});var n=s(5974),i=s(8905);const r=ArrayBuffer.prototype.slice;class a{constructor(e,t=0,s=e.byteLength-t){this.arrayBuffer=e,this.byteOffset=t,this.byteLength=s,(0,n.vA)(t>=0&&s>=0&&t+s<=this.arrayBuffer.byteLength)}static fromView(e){return new a(e.buffer,e.byteOffset,e.byteLength)}destroy(){this.arrayBuffer=null}slice(e,t=0,s=!1){const i=this.byteOffset+e,o=this.byteOffset+(0!==t?t:this.byteLength),l=o-i;return(0,n.vA)(l>=0&&l<=this.byteLength),s?new a(r.call(this.arrayBuffer,i,o)):new a(this.arrayBuffer,i,l)}subarray(e,t,s=!1){const i=this.byteOffset+e;return void 0===t&&(t=this.byteLength-e),(0,n.vA)(t>=0&&t<=this.byteLength),s?new a(r.call(this.arrayBuffer,i,i+t)):new a(this.arrayBuffer,i,t)}copyToBuffer(e=0,t){const s=this.byteOffset+e;return void 0===t&&(t=this.byteLength-e),r.call(this.arrayBuffer,s,s+t)}createDataView(e=0,t){return 0===e&&void 0===t?new DataView(this.arrayBuffer,this.byteOffset,this.byteLength):this.subarray(e,t).createDataView()}bswap16(){(0,n.vA)(this.byteLength%2==0);const e=this.createTypedArray(Uint8Array),t=new Uint8Array(this.byteLength);for(let s=0;s<e.byteLength;s+=2)t[s+0]=e[s+1],t[s+1]=e[s+0];return new a(t.buffer)}bswap32(){(0,n.vA)(this.byteLength%4==0);const e=this.createTypedArray(Uint8Array),t=new Uint8Array(e.byteLength);for(let s=0;s<e.byteLength;s+=4)t[s+0]=e[s+3],t[s+1]=e[s+2],t[s+2]=e[s+1],t[s+3]=e[s+0];return new a(t.buffer)}bswap(e){if(2===e)return this.bswap16();if(4===e)return this.bswap32();throw new Error("Invalid componentSize")}convertFromEndianness(e,t){return 1!==t&&e!==(0,i.G)()?this.bswap(t):this}createTypedArray(e,t=0,s,r=i.H.LITTLE_ENDIAN){const a=this.byteOffset+t;let o;void 0!==s?o=e.BYTES_PER_ELEMENT*s:(o=this.byteLength-t,s=o/e.BYTES_PER_ELEMENT,(0,n.vA)((0|s)===s));const l=e.BYTES_PER_ELEMENT;if(l>1&&r!==(0,i.G)()){const s=l;return this.subarray(t,o).bswap(s).createTypedArray(e)}return a&l-1?new e(this.copyToBuffer(t,o),0):new e(this.arrayBuffer,a,s)}}},8834(e,t,s){"use strict";s.d(t,{DS:()=>o,EH:()=>a,Oe:()=>r,g8:()=>i});const n="fe8dd8f74d93579296e7d087147de0b3a1bfcebd",i=n.slice(0,8),r="https://github.com/magcius/noclip.website",a=`${r}/commit/${n}`,o=!1},7639(e,t,s){"use strict";s.d(t,{i7:()=>g,cK:()=>y,X:()=>w,wR:()=>R,w2:()=>k,YF:()=>A,wl:()=>E,sq:()=>T,Bt:()=>P,Wx:()=>_,MS:()=>M,dr:()=>D});var n=s(7684),i=s(329),r=s(4796),a=s(7823);function o(){var e=new a.tb(4);return a.tb!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}r.o8,r.fA,r.C,r.hZ,r.WQ,r.hs,r.Om,r.Cc,r.Bw,r.m3;r.S8;r.t2,i.vt(),i.fA(1,0,0),i.fA(0,1,0),o(),o(),l=new a.tb(9),a.tb!=Float32Array&&(l[1]=0,l[2]=0,l[3]=0,l[5]=0,l[6]=0,l[7]=0),l[0]=1,l[4]=1,l[8]=1;var l,h=s(9450),c=s(5339),u=s(8528),d=s(7020),m=s(7714),p=s(6004),f=s(5098);class g{constructor(){this.viewMatrix=n.vt(),this.worldMatrix=n.vt(),this.projectionMatrix=n.vt(),this.clipFromWorldMatrix=n.vt(),this.linearVelocity=i.vt(),this.frustum=new h.PP,this.isOrthographic=!1,this.forceInfiniteFarPlane=!1}identity(){n.D_(this.worldMatrix),n.D_(this.viewMatrix)}worldMatrixUpdated(){this.updateClipFromWorld()}setPerspective(e,t,s,n=1/0){this.fovY=e,this.aspect=t,this.isOrthographic=!1,this.forceInfiniteFarPlane&&(n=1/0);const i=Math.tan(.5*e)*s,r=i*t;this.setFrustum(-r,r,-i,i,s,n)}setOrthographic(e,t,s,n){this.aspect=t,this.isOrthographic=!0;const i=e,r=e*t;this.setFrustum(-r,r,-i,i,s,n)}setClipPlanes(e,t=1/0){this.isOrthographic||this.setPerspective(this.fovY,this.aspect,e,t)}updateClipFromWorld(){n.lK(this.clipFromWorldMatrix,this.projectionMatrix,this.viewMatrix),this.frustum.updateClipFrustum(this.clipFromWorldMatrix,this.clipSpaceNearZ)}updateProjectionMatrix(){this.isOrthographic?(0,c.Gh)(this.projectionMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far):(0,c.u7)(this.projectionMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far),(0,d.sG)(this.projectionMatrix),(0,u._)(this.projectionMatrix,this.clipSpaceNearZ,m.uA.NegativeOne),this.updateClipFromWorld()}setFrustum(e,t,s,n,i,r){this.left=e,this.right=t,this.bottom=s,this.top=n,this.near=i,this.far=r,this.updateProjectionMatrix()}newFrame(){}}function T(e,t){n.C(e,t.viewMatrix)}const x=i.vt(),v=i.vt(),C=i.vt(),b=i.vt();function _(e,t){e[0]=t[0]/t[3],e[1]=t[1]/t[3],e[2]=t[2]/t[3],e[3]=1}var y;i.vt(),i.vt(),r.vt(),n.vt(),o(),function(e){e[e.Unchanged=0]="Unchanged",e[e.Changed=1]="Changed",e[e.ImportantChange=2]="ImportantChange"}(y||(y={}));const S=1e3/60;class w{constructor(){this.forceUpdate=!1,this.useViewUp=!0,this.onkeymovespeed=()=>{},this.keyMovement=i.vt(),this.mouseMovement=i.vt(),this.keyMoveSpeed=60,this.keyMoveShiftMult=5,this.keyMoveSlashMult=.1,this.keyMoveVelocityMult=.2,this.keyMoveDrag=.8,this.keyAngleChangeVelFast=.1,this.keyAngleChangeVelSlow=.02,this.worldForward=null,this.mouseLookSpeed=500,this.mouseLookDragFast=0,this.mouseLookDragSlow=0,this.sceneMoveSpeedMult=1}cameraUpdateForced(){i.v_(this.keyMovement)}setSceneMoveSpeedMult(e){this.sceneMoveSpeedMult=e}setKeyMoveSpeed(e){this.keyMoveSpeed=e}getKeyMoveSpeed(){return this.keyMoveSpeed}update(e,t){const s=this.camera;let r=!1,a=!1;e.isKeyDown("KeyB")&&(n.D_(s.worldMatrix),this.cameraUpdateForced(),r=!0),this.keyMoveSpeed=Math.max(this.keyMoveSpeed,1);const o=e.isKeyDown("ShiftLeft")||e.isKeyDown("ShiftRight"),l=e.isKeyDown("IntlBackslash")||e.isKeyDown("Backslash");let h=1;o&&(h=this.keyMoveShiftMult),l&&(h=this.keyMoveSlashMult),(e.isKeyDownEventTriggered("Numpad4")||e.isKeyDownEventTriggered("Numpad1"))&&(null===this.worldForward?(this.worldForward=i.vt(),(0,c.Bl)(this.worldForward,s.worldMatrix),e.isKeyDownEventTriggered("Numpad4")&&function(e,t){const s=t[0],n=t[1],r=t[2],a=i.Bw(t);Math.abs(s)>Math.abs(n)&&Math.abs(s)>Math.abs(r)?i.hZ(e,a*Math.sign(s),0,0):Math.abs(n)>Math.abs(s)&&Math.abs(n)>Math.abs(r)?i.hZ(e,0,a*Math.sign(n),0):Math.abs(r)>Math.abs(n)&&Math.abs(r)>Math.abs(s)&&i.hZ(e,0,0,a*Math.sign(r))}(this.worldForward,this.worldForward)):this.worldForward=null);const u=this.keyMoveSpeed*h,d=u*this.keyMoveVelocityMult,m=this.keyMovement,p=.1;!e.isKeyDown("KeyW")&&!e.isKeyDown("ArrowUp")&&3&~e.buttons?e.isKeyDown("KeyS")||e.isKeyDown("ArrowDown")?m[2]=(0,c.BS)(m[2]+d,u):Math.abs(m[2])>=p&&(m[2]*=this.keyMoveDrag,Math.abs(m[2])<p&&(a=!0,m[2]=0)):m[2]=(0,c.BS)(m[2]-d,u),m[2]+=-e.getPinchDeltaDist()*d,e.isKeyDown("KeyA")||e.isKeyDown("ArrowLeft")?m[0]=(0,c.BS)(m[0]-d,u):e.isKeyDown("KeyD")||e.isKeyDown("ArrowRight")?m[0]=(0,c.BS)(m[0]+d,u):Math.abs(m[0])>=p&&(m[0]*=this.keyMoveDrag,Math.abs(m[0])<p&&(a=!0,m[0]=0)),m[0]+=-e.getTouchDeltaX()*d;const g=f._h.loadSetting("SwapQE",!1),T=g?"KeyE":"KeyQ",_=g?"KeyQ":"KeyE";e.isKeyDown(T)||e.isKeyDown("PageDown")||e.isKeyDown("ControlLeft")&&e.isKeyDown("Space")||e.isKeyDown("KeyC")?m[1]=(0,c.BS)(m[1]-d,u):e.isKeyDown(_)||e.isKeyDown("PageUp")||e.isKeyDown("Space")?m[1]=(0,c.BS)(m[1]+d,u):Math.abs(m[1])>=p&&(m[1]*=this.keyMoveDrag,Math.abs(m[1])<p&&(a=!0,m[1]=0)),m[1]+=e.getTouchDeltaY()*d;const w=v;this.useViewUp?(0,c.Io)(w,s.viewMatrix):i.C(w,c.PI);const A=C,E=b;if(null!==this.worldForward?((0,c.bB)(E,s.viewMatrix,this.worldForward),i.$A(A,w,E)):(i.C(A,c.Ip),i.C(E,c.YI)),i.t2(m,c.i0))i.C(s.linearVelocity,c.i0);else{const e=x;i.v_(e),i.Ln(e,e,A,m[0]),i.Ln(e,e,E,m[2]),i.Ln(e,e,w,m[1]),i.hs(e,e,this.sceneMoveSpeedMult*(t/S)),i.C(s.linearVelocity,e),n.Tl(s.worldMatrix,s.worldMatrix,e),r=!0}const R=1e-4,I=e.invertX?-1:1,k=e.invertY?-1:1,M=e.getMouseDeltaX()*(-1/this.mouseLookSpeed)*I,P=e.getMouseDeltaY()*(-1/this.mouseLookSpeed)*k,D=this.mouseMovement;D[0]+=M,D[1]+=P;const B=o?this.keyAngleChangeVelFast:this.keyAngleChangeVelSlow;if(e.isKeyDown("KeyJ")?D[0]+=B*I:e.isKeyDown("KeyL")&&(D[0]-=B*I),e.isKeyDown("KeyI")?D[1]+=B*k:e.isKeyDown("KeyK")&&(D[1]-=B*k),e.isKeyDown("KeyU")?D[2]-=B:e.isKeyDown("KeyO")&&(D[2]+=B),!i.t2(this.mouseMovement,c.i0)){n.e$(s.worldMatrix,s.worldMatrix,this.mouseMovement[0],w),n.e$(s.worldMatrix,s.worldMatrix,this.mouseMovement[1],c.Ip),n.e$(s.worldMatrix,s.worldMatrix,this.mouseMovement[2],c.YI),r=!0;const t=e.isDragging()?this.mouseLookDragFast:this.mouseLookDragSlow;i.hs(this.mouseMovement,this.mouseMovement,t),Math.abs(this.mouseMovement[0])<R&&(this.mouseMovement[0]=0),Math.abs(this.mouseMovement[1])<R&&(this.mouseMovement[1]=0)}return r=r||this.forceUpdate,r&&(this.camera.isOrthographic=!1,n.B8(this.camera.viewMatrix,this.camera.worldMatrix),this.camera.worldMatrixUpdated(),this.forceUpdate=!1),a?y.ImportantChange:r?y.Changed:y.Unchanged}}class A extends w{constructor(e,t){super(),this.animationManager=e,this.studioPanel=t,this.isAnimationPlaying=!1,this.interpStep=new p.rM}update(e,t){let s;return this.isAnimationPlaying?(s=this.updateAnimation(t),s===y.Changed&&(n.B8(this.camera.viewMatrix,this.camera.worldMatrix),this.camera.worldMatrixUpdated()),s=y.Unchanged):(s=super.update(e,t),this.studioPanel.drawWorldHelpers(this.camera.clipFromWorldMatrix)),s}updateAnimation(e){return this.animationManager.isAnimationFinished()?(this.studioPanel.stopAnimation(),y.Unchanged):(this.animationManager.updateElapsedTime(e),this.animationManager.getAnimFrame(this.interpStep),n.xI(this.camera.worldMatrix,this.interpStep.pos,this.interpStep.lookAtPos,c.PI),n.Qr(this.camera.worldMatrix,this.camera.worldMatrix,this.interpStep.bank),this.studioPanel.onAnimationAdvance(this.animationManager.getElapsedTimeSeconds()),y.Changed)}setToPosition(e){n.xI(this.camera.worldMatrix,e.pos,e.lookAtPos,c.PI),n.Qr(this.camera.worldMatrix,this.camera.worldMatrix,e.bank),n.B8(this.camera.viewMatrix,this.camera.worldMatrix),this.camera.worldMatrixUpdated()}}class E{constructor(){this.cameras=[],this.offset=i.vt(),this.worldScale=10,this.rotationOffset=Math.PI,this.aimingTeleport=!1,this.teleportTarget=i.vt(),this.rightStickReleased=!0,this.rightStickXReady=!0,this.showTeleportRing=!1,this.ringPosition=i.vt()}update(e){if(!e.xrSession)return!1;if(e.views.length!==this.cameras.length){for(let t=this.cameras.length;t<e.views.length;t++)this.cameras.push(new g);this.cameras.length=e.views.length;for(let e=0;e<this.cameras.length;e++)this.cameras[e]=new g}for(let t=0;t<this.cameras.length;t++){const s=this.cameras[t],i=e.views[t];n.D_(s.worldMatrix),n.Tl(s.worldMatrix,s.worldMatrix,this.offset),n.Z8(s.worldMatrix,s.worldMatrix,this.rotationOffset),1!==this.worldScale&&n.hs(s.worldMatrix,s.worldMatrix,[this.worldScale,this.worldScale,this.worldScale]),n.lK(s.worldMatrix,s.worldMatrix,i.transform.matrix),s.isOrthographic=!1,n.B8(s.viewMatrix,s.worldMatrix),n.C(s.projectionMatrix,i.projectionMatrix),s.worldMatrixUpdated()}const t=e.xrSession.inputSources,s=this.cameras[0],r=i.fA(s.worldMatrix[0],0,s.worldMatrix[2]),a=i.fA(-s.worldMatrix[8],0,-s.worldMatrix[10]);i.S8(r,r),i.S8(a,a);let o=0,l=0;for(const e of t){const t=e.gamepad;if(t){if(t.buttons.length>=2){const e=t.buttons[0].value-t.buttons[1].value;Math.abs(e)>.01&&(this.offset[1]+=.2*e*this.worldScale)}if(t.axes.length>=4)if("left"===e.handedness)o+=t.axes[2],l+=t.axes[3];else if("right"===e.handedness){const e=t.axes[2],s=t.axes[3];if(Math.abs(e)>.5&&!this.aimingTeleport?this.rightStickXReady&&(this.rotationOffset-=Math.sign(e)*(Math.PI/4),this.rightStickXReady=!1):Math.abs(e)<.2&&(this.rightStickXReady=!0),s<-.5){this.aimingTeleport=!0,this.showTeleportRing=!0,this.rightStickReleased=!1;const e=15*this.worldScale;this.teleportTarget[0]=this.offset[0]+a[0]*e,this.teleportTarget[1]=this.offset[1],this.teleportTarget[2]=this.offset[2]+a[2]*e,i.C(this.ringPosition,this.teleportTarget)}else this.aimingTeleport&&s>-.2&&(i.C(this.offset,this.teleportTarget),this.aimingTeleport=!1,this.showTeleportRing=!1,this.rightStickReleased=!0)}}}if(Math.abs(o)>.1||Math.abs(l)>.1){const e=.5*this.worldScale;this.offset[0]+=r[0]*o*e,this.offset[2]+=r[2]*o*e,this.offset[0]+=a[0]*-l*e,this.offset[2]+=a[2]*-l*e}return!0}}class R{constructor(e=!1){this.shouldOrbit=e,this.forceUpdate=!1,this.onkeymovespeed=()=>{},this.x=-Math.PI/2,this.y=2,this.z=-150,this.zTarget=-150,this.orbitSpeed=-.05,this.orbitXVel=0,this.xVel=0,this.yVel=0,this.translation=i.vt(),this.txVel=0,this.tyVel=0,this.sceneMoveSpeedMult=1}cameraUpdateForced(){}deserialize(e){}setSceneMoveSpeedMult(e){this.sceneMoveSpeedMult=e}setKeyMoveSpeed(e){}getKeyMoveSpeed(){return null}update(e,t,s){e.isKeyDownEventTriggered("KeyR")&&(this.shouldOrbit=!this.shouldOrbit),e.isKeyDownEventTriggered("Numpad5")&&(this.shouldOrbit=!1,this.xVel=this.yVel=0),e.isKeyDownEventTriggered("KeyB")&&(this.shouldOrbit=!1,this.xVel=this.yVel=0,this.txVel=this.tyVel=0,this.xVel=this.yVel=0,i.v_(this.translation));const r=this.shouldOrbit,a=e.invertX?-1:1,o=e.invertY?-1:1;4&e.buttons?(this.txVel+=e.dx*(-10-Math.min(this.z,.01))/-5e3,this.tyVel+=e.dy*(-10-Math.min(this.z,.01))/5e3):e.isDragging()?(this.xVel+=e.dx/-200*a,this.yVel+=e.dy/-200*o):r&&Math.abs(this.xVel)<Math.abs(this.orbitSpeed)&&(this.orbitXVel+=1*this.orbitSpeed/50);let l=0,h=0;e.isKeyDown("KeyA")&&(l+=.02),e.isKeyDown("KeyD")&&(l-=.02),e.isKeyDown("KeyW")&&(h+=.02),e.isKeyDown("KeyS")&&(h-=.02);const u=e.isKeyDown("ShiftLeft")||e.isKeyDown("ShiftRight");u?(this.xVel+=-l,this.yVel+=-h):(this.txVel+=l,this.tyVel+=-h),this.orbitXVel=(0,c.BS)(this.orbitXVel,2),this.xVel=(0,c.BS)(this.xVel,2),this.yVel=(0,c.BS)(this.yVel,2);let d=80*e.dz;e.isKeyDown("KeyQ")&&(d-=80),e.isKeyDown("KeyE")&&(d+=80),this.zTarget+=d*this.sceneMoveSpeedMult,this.zTarget>-10&&(this.zTarget=-10);let m=this.zTarget-this.z;if(this.forceUpdate||0!==this.xVel||0!==this.orbitXVel||0!==this.yVel||0!==m||0!==this.txVel||0!==this.tyVel){const t=e.isDragging()||u?.86:.94;this.x+=-(this.xVel+this.orbitXVel*s)/10,this.xVel*=t,this.orbitXVel*=t,this.y+=-this.yVel/10,this.yVel*=t,this.txVel*=t,this.tyVel*=t;const r=.1;this.z+=m*r,(0,c.BM)(x,this.camera.worldMatrix),i.Ln(this.translation,this.translation,x,this.txVel),(0,c.Io)(x,this.camera.worldMatrix),i.Ln(this.translation,this.translation,x,this.tyVel);const a=x;(0,c.kC)(a,this.x,this.y),i.hs(a,a,this.z),i.WQ(a,a,this.translation),this.camera.isOrthographic=!1,n.t5(this.camera.viewMatrix,a,this.translation,c.PI),n.B8(this.camera.worldMatrix,this.camera.viewMatrix),this.camera.worldMatrixUpdated(),this.forceUpdate=!1}return y.Unchanged}}function I(e,t){return Math.floor(e/t)*t+t}class k{constructor(){this.forceUpdate=!1,this.onkeymovespeed=()=>{},this.x=-Math.PI/2,this.y=2,this.z=-200,this.zTarget=-200,this.orbitSpeed=-.05,this.xTarget=this.x,this.yTarget=this.y,this.translation=i.vt(),this.txVel=0,this.tyVel=0,this.shouldOrbit=!1,this.farPlane=5e5,this.nearPlane=-this.farPlane,this.sceneMoveSpeedMult=1}setSceneMoveSpeedMult(e){this.sceneMoveSpeedMult=e}cameraUpdateForced(){}deserialize(e){}setKeyMoveSpeed(e){}getKeyMoveSpeed(){return null}update(e,t){e.isKeyDownEventTriggered("KeyR")&&(this.shouldOrbit=!this.shouldOrbit),e.isKeyDownEventTriggered("Numpad5")&&(this.shouldOrbit=!1),e.isKeyDownEventTriggered("Numpad8")&&(this.xTarget=.5*-Math.PI,this.yTarget=Math.PI-.001),e.isKeyDownEventTriggered("Numpad4")&&(this.xTarget=0,this.yTarget=.5*Math.PI),e.isKeyDownEventTriggered("Numpad6")&&(this.xTarget=Math.PI,this.yTarget=.5*Math.PI),e.isKeyDownEventTriggered("Numpad2")&&(this.xTarget=.5*-Math.PI,this.yTarget=.5*Math.PI),e.isKeyDownEventTriggered("KeyB")&&(this.txVel=this.tyVel=0,i.v_(this.translation));const s=this.shouldOrbit,r=e.invertX?-1:1,a=e.invertY?-1:1;4&e.buttons?(this.txVel+=e.dx*(-10-Math.min(-this.z,.01))/-5e3,this.tyVel+=e.dy*(-10-Math.min(-this.z,.01))/5e3):e.isDragging()?(this.xTarget+=e.dx/200*r,this.yTarget+=e.dy/200*a):s&&(this.xTarget+=1*this.orbitSpeed/25);let o=80*e.dz;e.isKeyDown("KeyQ")&&(o-=80),e.isKeyDown("KeyE")&&(o+=80),this.zTarget+=o*this.sceneMoveSpeedMult,this.zTarget>-10&&(this.zTarget=-10);let l=this.zTarget-this.z;const h=e.isKeyDown("ShiftLeft")||e.isKeyDown("ShiftRight");h?(e.isKeyDownEventTriggered("KeyA")&&(this.xTarget=I(this.xTarget,+Math.PI/4)),e.isKeyDownEventTriggered("KeyD")&&(this.xTarget=I(this.xTarget,-Math.PI/4)),e.isKeyDownEventTriggered("KeyW")&&(this.yTarget=I(this.yTarget,+Math.PI/8),this.yTarget===Math.PI&&(this.yTarget-=.001)),e.isKeyDownEventTriggered("KeyS")&&(this.yTarget=I(this.yTarget-.001,-Math.PI/8),this.yTarget===Math.PI&&(this.yTarget+=.001))):(e.isKeyDown("KeyA")&&(this.txVel+=.02),e.isKeyDown("KeyD")&&(this.txVel-=.02),e.isKeyDown("KeyW")&&(this.tyVel-=.02),e.isKeyDown("KeyS")&&(this.tyVel+=.02)),this.xTarget=this.xTarget%c.wZ.TAU,this.yTarget=this.yTarget%c.wZ.TAU;const u=this.forceUpdate||this.xTarget!==this.x||this.yTarget!==this.y||0!==l||0!==this.txVel||0!==this.tyVel;if(u){this.x=(0,c.nU)(this.x,this.xTarget,.1),this.y=(0,c.nU)(this.y,this.yTarget,.1);const t=e.isDragging()||h?.92:.96;this.txVel*=t,this.tyVel*=t;const s=.1;this.z+=l*s,(0,c.BM)(x,this.camera.worldMatrix),i.Ln(this.translation,this.translation,x,this.txVel*this.z),(0,c.Io)(x,this.camera.worldMatrix),i.Ln(this.translation,this.translation,x,this.tyVel*this.z),this.forceUpdate=!1}const d=x;return(0,c.kC)(d,this.x,this.y),i.hs(d,d,-this.farPlane/2),i.WQ(d,d,this.translation),n.t5(this.camera.viewMatrix,d,this.translation,c.PI),n.B8(this.camera.worldMatrix,this.camera.viewMatrix),this.camera.setOrthographic(10*-this.z,this.camera.aspect,this.nearPlane,this.farPlane),this.camera.worldMatrixUpdated(),u?y.Changed:y.Unchanged}}function M(e,t,s){return function(e,t,s){return e.setFloat32(t+0,s[0],!0),e.setFloat32(t+4,s[4],!0),e.setFloat32(t+8,s[8],!0),e.setFloat32(t+12,s[12],!0),e.setFloat32(t+16,s[1],!0),e.setFloat32(t+20,s[5],!0),e.setFloat32(t+24,s[9],!0),e.setFloat32(t+28,s[13],!0),e.setFloat32(t+32,s[2],!0),e.setFloat32(t+36,s[6],!0),e.setFloat32(t+40,s[10],!0),e.setFloat32(t+44,s[14],!0),48}(e,t,s.worldMatrix)}function P(e,t,s){const i=e.worldMatrix;return i[0]=t.getFloat32(s+0,!0),i[4]=t.getFloat32(s+4,!0),i[8]=t.getFloat32(s+8,!0),i[12]=t.getFloat32(s+12,!0),i[1]=t.getFloat32(s+16,!0),i[5]=t.getFloat32(s+20,!0),i[9]=t.getFloat32(s+24,!0),i[13]=t.getFloat32(s+28,!0),i[2]=t.getFloat32(s+32,!0),i[6]=t.getFloat32(s+36,!0),i[10]=t.getFloat32(s+40,!0),i[14]=t.getFloat32(s+44,!0),i[3]=0,i[7]=0,i[11]=0,i[15]=1,n.B8(e.viewMatrix,e.worldMatrix),e.worldMatrixUpdated(),48}function D(e,t,s){!function(e,t,s,n){const i=t.projectionMatrix;e[0]=.5*i[0],e[4]=0,e[8]=.5*i[8]+.5*i[11],e[12]=.5*i[12]+.5*i[15],e[1]=0,e[5]=i[5]*n,e[9]=i[9]*n+.5*i[11],e[13]=i[12]*n+.5*i[15],e[2]=0,e[6]=0,e[10]=i[11],e[14]=i[15],e[3]=9999,e[7]=9999,e[11]=9999,e[15]=9999}(e,t,0,-.5*s)}},7459(e,t,s){"use strict";function n(e,t,s,n=1){return{r:e,g:t,b:s,a:n}}function i(e,t,s,n,i=1){e.r=t,e.g=s,e.b=n,e.a=i}function r(e,t,s=t.a){e.r=t.r,e.g=t.g,e.b=t.b,e.a=s}function a(e,t=e.a){return{r:e.r,g:e.g,b:e.b,a:t}}function o(e){const t=n(0,0,0,0);return function(e,t){e.r=(t>>>24&255)/255,e.g=(t>>>16&255)/255,e.b=(t>>>8&255)/255,e.a=(t>>>0&255)/255}(t,e),t}function l(e,t,s){e.r=t.r*s,e.g=t.g*s,e.b=t.b*s,e.a=t.a*s}function h(e){return 255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a}function c(e,t=e.a){return`rgba(${255*e.r}, ${255*e.g}, ${255*e.b}, ${t})`}s.d(t,{$T:()=>v,Jo:()=>o,KK:()=>c,Qo:()=>l,XV:()=>h,Zv:()=>a,aM:()=>f,aw:()=>p,c:()=>m,gM:()=>i,gh:()=>u,gv:()=>n,jR:()=>d,kD:()=>T,o4:()=>x,vl:()=>g,z5:()=>r}),s(5339);const u=n(0,0,0,0),d=n(0,0,0,1),m=(n(1,1,1,0),n(1,1,1,1)),p=n(1,0,0,1),f=n(0,1,0,1),g=n(0,0,1,1),T=n(1,0,1,1),x=(n(1,1,0,1),n(0,1,1,1));function v(e){return"object"==typeof e&&null!==e&&"r"in e&&"g"in e&&"b"in e&&"a"in e}},7165(e,t,s){"use strict";s.d(t,{$w:()=>d,RB:()=>m});var n=s(7459),i=s(8880),r=s(9009),a=s(5974),o=s(5339),l=s(8834);function h(e,t){return{range:Reflect.getMetadata("df:range",e,t),usepercent:Reflect.getMetadata("df:usepercent",e,t),sigfigs:Reflect.getMetadata("df:sigfigs",e,t)}}function c(e,t,s="",n=null){for(const i in t){let r=Reflect.getMetadata("df:label",t,i);void 0===r&&(r=`${s}.${i}`),e(t,i,r,n)&&"object"==typeof t[i]&&t[i]&&c(e,t[i],r,h(t,i))}}s(4741);class u{constructor(e,t,s=null){this.obj=e,this.paramName=t,this.min=0,this.max=1,this.step=.01,this.isMidiListenerBound=!1,this.explicitRange=!1,this.lastValue=null,this.onismidilistenerboundchanged=null,this.onupdate=null;let n=Reflect.getMetadata("df:range",e,t);void 0===n&&null!==s&&(n=s.range),void 0!==n&&(this.min=n.min,this.max=n.max,this.step=n.step,this.explicitRange=!0),this.midiListener={onbind:e=>{this.isMidiListenerBound=!0,null!==this.onismidilistenerboundchanged&&this.onismidilistenerboundchanged()},onunbind:()=>{this.isMidiListenerBound=!1,null!==this.onismidilistenerboundchanged&&this.onismidilistenerboundchanged()},onvalue:e=>{const t=(0,o.Cc)(this.min,this.max,e);this.setValue(t)}},this.updateInterval=setInterval(()=>{this.obj[this.paramName]!==this.lastValue&&this.update()},10)}setValue(e){this.obj[this.paramName]=e,this.update()}update(){const e=this.obj[this.paramName];this.lastValue=e;const t=Math.min(e,this.min),s=Math.max(e,this.max);this.explicitRange||(this.min=t,this.max=s),null!==this.onupdate&&this.onupdate(e,t,s)}}class d{constructor(){this.onclose=null,this.customHeaderBackgroundColor="",this.minimized=!1,this.toplevel=document.createElement("div"),this.toplevel.style.color="white",this.toplevel.style.font="16px monospace",this.toplevel.style.overflow="hidden",this.toplevel.style.display="grid",this.toplevel.style.gridAutoFlow="column",this.toplevel.style.gridGap="20px",this.toplevel.style.alignItems="start",this.toplevel.style.outline="none",this.toplevel.style.minWidth="300px",this.toplevel.style.position="absolute",this.toplevel.style.left="82px",this.toplevel.style.top="32px",this.toplevel.style.pointerEvents="auto",this.toplevel.tabIndex=-1,this.mainPanel=document.createElement("div"),this.mainPanel.style.overflow="hidden",this.mainPanel.style.transition=".25s ease-out",this.mainPanel.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.toplevel.appendChild(this.mainPanel),this.headerContainer=document.createElement("div"),this.mainPanel.appendChild(this.headerContainer),this.header=document.createElement("h1"),this.header.style.lineHeight="28px",this.header.style.margin="0",this.header.style.fontSize="100%",this.header.style.cursor="pointer",this.header.style.userSelect="none",this.header.style.display="grid",this.header.style.gridTemplateColumns="28px 1fr 28px",this.header.style.alignItems="center",this.header.style.justifyItems="center",this.header.style.gridAutoFlow="column",this.header.onmousedown=e=>{r.B.takeGrab(this,e,{takePointerLock:!1,useGrabbingCursor:!0,releaseOnMouseUp:!0})},this.header.ondblclick=e=>{this.close()},this.minimizeButton=document.createElement("div"),this.minimizeButton.textContent="_",this.minimizeButton.title="Minimize",this.minimizeButton.style.gridColumn="3",this.minimizeButton.style.lineHeight="28px",this.minimizeButton.style.margin="0",this.minimizeButton.style.padding="0 4px",this.minimizeButton.style.fontSize="100%",this.minimizeButton.style.cursor="pointer",this.minimizeButton.style.userSelect="none",this.minimizeButton.onclick=e=>{this.setMinimized(!this.minimized)},this.minimizeButton.ondblclick=e=>{e.stopPropagation()},this.closeButton=document.createElement("div"),this.closeButton.textContent="X",this.closeButton.title="Close",this.closeButton.style.gridColumn="4",this.closeButton.style.lineHeight="28px",this.closeButton.style.margin="0",this.closeButton.style.padding="0 4px",this.closeButton.style.fontSize="100%",this.closeButton.style.cursor="pointer",this.closeButton.style.userSelect="none",this.closeButton.onclick=()=>{this.close()},this.headerContainer.appendChild(this.header),this.contents=document.createElement("div"),this.contents.style.maxHeight="50vh",this.contents.style.overflow="auto",this.mainPanel.appendChild(this.contents),this.setWidth("400px"),this.elem=this.toplevel}setWidth(e){this.header.style.width=e,this.contents.style.width=e}close(){null!==this.toplevel.parentElement&&this.toplevel.parentElement.removeChild(this.toplevel),this.onclose&&this.onclose()}onMotion(e,t){this.toplevel.style.left=parseFloat(this.toplevel.style.left)+e+"px",this.toplevel.style.top=parseFloat(this.toplevel.style.top)+t+"px"}onGrabReleased(){}setVisible(e){this.toplevel.style.display=e?"grid":"none"}setMinimized(e){this.minimized!==e&&(this.minimized=e,this.contents.style.height=this.minimized?"0px":"")}setTitle(e,t){this.svgIcon=(0,i.MC)(e).querySelector("svg"),this.svgIcon.style.gridColumn="1",this.header.textContent=t,this.header.appendChild(this.svgIcon),this.header.appendChild(this.minimizeButton),this.header.appendChild(this.closeButton),this.toplevel.dataset.title=t,this.syncHeaderStyle()}syncHeaderStyle(){this.customHeaderBackgroundColor?(this.svgIcon.style.fill="",this.header.style.backgroundColor=this.customHeaderBackgroundColor,this.header.style.color="white"):(this.svgIcon.style.fill="black",(0,i.Y)(this.header,!0,i.t$))}bindCheckbox(e,t,s){let n=t[s];(0,a.vA)("boolean"==typeof n);let r=Reflect.getMetadata("df:label",t,s);void 0!==r&&(e=r);const o=new i.Sc(e,n);function l(){o.setChecked(t[s])}o.onchanged=()=>{t[s]=o.checked,l()},setInterval(()=>{t[s]!==n&&l()},100),this.contents.appendChild(o.elem)}bindButton(e,t,s){let n=t[s];(0,a.vA)("function"==typeof n);let i=Reflect.getMetadata("df:label",t,s);void 0!==i&&(e=i);const r=document.createElement("div");r.style.fontWeight="bold",r.style.textAlign="center",r.style.lineHeight="24px",r.style.cursor="pointer",r.textContent=e,r.onclick=()=>{n.call(t)},this.contents.appendChild(r)}bindSlider(e,t,s,n=null,r=null){let l=t[s];(0,a.vA)("number"==typeof l);const h=new u(t,s,n);h.onupdate=(n,i,r)=>{p.setRange(i,r,h.step),p.setValue(n);const a=Math.max(0,-Math.log10(h.step));let l;l=c?`${(100*(0,o.po)(h.min,h.max,n)).toFixed(0)}%`:n.toFixed(a),p.setLabel(`${e} = ${l}`);let u=Reflect.getMetadata("df:changedcallback",t,s);u&&u.call(t)};let c=Reflect.getMetadata("df:usepercent",t,s);void 0===c&&null!==n&&(c=n.usepercent),c=!!c;let d=Reflect.getMetadata("df:label",t,s);void 0!==d&&(e=d);let m=Reflect.getMetadata("df:sigfigs",t,s);void 0===m&&null!==n&&(m=n.sigfigs),void 0===m&&(m=-Math.log10(h.step));const p=new i.Ap;let f=null;if(null!==r&&r.isInitialized()){const e=p.elem.querySelector("div");e.style.gridTemplateColumns="48px 1fr 1fr";let t="unbound";const s=()=>{"unbound"===t?f.style.color="white":"binding"===t?f.style.color="cyan":"bound"===t&&(f.style.color=i.t$)};h.onismidilistenerboundchanged=()=>{t=h.isMidiListenerBound?"bound":"unbound",s()},f=document.createElement("span"),f.textContent="B",f.style.color="white",f.style.margin="0 1em",f.style.userSelect="none",f.style.cursor="pointer",f.style.fontWeight="bold",f.onclick=()=>{"unbound"===t?(t="binding",s(),r.setNextBindListener(h.midiListener)):"binding"===t?(t="unbound",s(),r.setNextBindListener(null)):"bound"===t&&(t="unbound",s(),h.midiListener.unbind())},e.insertBefore(f,e.firstElementChild)}p.onvalue=e=>{h.setValue(e)},this.contents.appendChild(p.elem)}bindSliderChain(e,t,...s){let n=null;for(let e=0;e<s.length-1;e++)n=h(t,s[e]),t=t[s[e]];this.bindSlider(e,t,s[s.length-1],n)}}class m{constructor(){this.floatingPanels=[],this.debugFloater=null,this.midiControls=new v,this.elem=document.createElement("div"),l.DS&&this.midiControls.init()}makeFloatingPanel(e="Floating Panel",t=i.WY){const s=new d;return s.setWidth("600px"),s.setTitle(t,e),s.onclose=()=>{this.debugFloater===s&&(this.debugFloater=null)},this.elem.appendChild(s.elem),this.floatingPanels.push(s),s}getDebugFloater(){return null===this.debugFloater&&(this.debugFloater=this.makeFloatingPanel("Debug")),this.debugFloater}destroyScene(){for(let e=0;e<this.floatingPanels.length;e++)this.floatingPanels[e].close();this.floatingPanels=[],this.debugFloater=null}bindPanel(e,t=null){let s=t;for(null===s&&(s=this.getDebugFloater());s.contents.firstChild;)s.contents.removeChild(s.contents.firstChild);c((e,t,i,r)=>{if(!((0,n.$T)(e)||e instanceof Array||e instanceof Float32Array||p(e,t)))return!1;const a=e[t];return"number"==typeof a?s.bindSlider(i,e,t,r,this.midiControls):"boolean"==typeof a?s.bindCheckbox(i,e,t):"function"==typeof a&&s.bindButton(i,e,t),!0},e),T((t,n)=>{(p(e,n)||p(t,n))&&s.bindButton(n,e,n)},e)}}function p(e,t){return Reflect.getMetadata("df:visibility",e,t)}class f{constructor(e,t){this.channel=e,this.controlNumber=t,this.value=-1,this.listener=null}bindListener(e){null!==this.listener&&(this.listener.unbind=void 0),null!==this.listener&&void 0!==this.listener.onunbind&&this.listener.onunbind(),this.listener=e,null!==this.listener&&(this.listener.unbind=()=>this.bindListener(null)),null!==this.listener&&void 0!==this.listener.onbind&&this.listener.onbind(this.value)}setValue(e){null!==this.listener&&null!==this.listener.onvalue&&this.listener.onvalue(e)}}class g{constructor(e,t){this.channel=e,this.controlNumber=t,this.value=-1,this.listener=null}bindListener(e){this.listener=e}setValue(e){null!==this.listener&&e>=1?this.listener.ondown():null!==this.listener&&void 0!==this.listener.onup&&this.listener.onup()}}function T(e,t){if(null===t)return;const s=Object.getOwnPropertyNames(t);for(const n of s){const s=Object.getOwnPropertyDescriptor(t,n);void 0!==s&&void 0!==s.value&&"function"==typeof s.value&&e(t,n)}T(e,Object.getPrototypeOf(t))}class x{constructor(e){this.midiInput=e,this.boundControls=[],this.oncontrolmessage=null,this.onMessage=e=>{const t=e,s=t.data[0];if(s>=176&&s<=191&&null!==this.oncontrolmessage){const e=15&t.data[0],s=t.data[1],n=t.data[2];let i=(0,a.g_)(this.boundControls.find(t=>t.channel===e&&t.controlNumber===s));this.oncontrolmessage(this,i,e,s,n),i=(0,a.g_)(this.boundControls.find(t=>t.channel===e&&t.controlNumber===s));const r=null!==n?(0,o.po)(0,127,n):null;null!==i&&null!==r&&i.setValue(r)}},this.midiInput.onmidimessage=this.onMessage}bindValueListener(e,t,s){const n=new f(e,t);return n.bindListener(s),this.boundControls.push(n),n}bindButtonListener(e,t,s){const n=new g(e,t);return n.bindListener(s),this.boundControls.push(n),n}clearBinds(){for(let e=0;e<this.boundControls.length;e++)this.boundControls[e].bindListener(null)}}class v{constructor(){this.midiAccess=null,this.devices=[],this.nextListener=null,this.log=!1,this.onControlMessage=(e,t,s,n,i)=>{this.log&&console.log(s,n,i),null!==this.nextListener&&(null===t?t=e.bindValueListener(s,n,this.nextListener):t instanceof f&&t.bindListener(this.nextListener),this.nextListener=null)}}async init(){void 0!==navigator.requestMIDIAccess&&(this.midiAccess=await navigator.requestMIDIAccess({sysex:!1}),this.midiAccess.onstatechange=()=>{this.scanDevices()},this.scanDevices())}isInitialized(){return null!==this.midiAccess}scanDevices(){this.midiAccess.inputs.forEach((e,t)=>{let s=this.devices.find(t=>t.midiInput===e);void 0===s&&(s=new x(e),s.oncontrolmessage=this.onControlMessage,this.devices.push(s))})}setNextBindListener(e){null!==this.nextListener&&void 0!==this.nextListener.onunbind&&(this.nextListener.onunbind(),this.nextListener=null),this.nextListener=e}getControlNumber(e){if("button"===e.kind)return 32+e.index;if("knob"===e.kind)return 16+e.index;if("slider"===e.kind)return 0+e.index;throw"whoops"}bindObject(e){const t=this.devices[0];void 0!==t&&(c((e,s,n,i)=>{const r=Reflect.getMetadata("df:midi",e,s);if(!r)return!1;const o=this.getControlNumber(r);if("knob"===r.kind||"slider"===r.kind){const n=new u(e,s,i);t.bindValueListener(r.channel,o,n.midiListener)}else if("button"===r.kind){(0,a.vA)(!r.callback);const n={ondown:()=>{e[s]=!0},onup:()=>{e[s]=!1}};t.bindButtonListener(r.channel,o,n)}return!0},e),T((s,n)=>{const i=Reflect.getMetadata("df:midi",s,n);if(!i)return;const r=this.getControlNumber(i);if("knob"===i.kind||"slider"===i.kind){const a={onvalue:t=>{s[n].call(e,t)}};t.bindValueListener(i.channel,r,a)}else if("button"===i.kind){const a={ondown:()=>{s[n].call(e)}};t.bindButtonListener(i.channel,r,a)}},e))}}},353(e,t,s){"use strict";s.d(t,{AN:()=>m,CZ:()=>w,NB:()=>v,RM:()=>b,YA:()=>_,_j:()=>p});var n=s(7684),i=s(329),r=s(4796),a=s(305),o=s(7639),l=s(7459),h=s(393),c=(s(5339),s(8880)),u=s(5974);let d=null;function m(){if(null===d){const e=document.createElement("canvas"),t=(0,u.Z1)(e.getContext("2d"));e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.pointerEvents="none",window.main.toplevel.insertBefore(e,window.main.canvas),d=t,p()}return d}function p(){null!==d&&(d.canvas.style.width=`${window.innerWidth}px`,d.canvas.style.height=`${window.innerHeight}px`,d.canvas.width=window.innerWidth*window.devicePixelRatio,d.canvas.height=window.innerHeight*window.devicePixelRatio)}const f=(0,u.y5)(10,()=>r.vt());function g(e,t,s){for(let n=0;n<s;n++)r.Z0(t[n],t[n],e)}const T=r.fA(0,0,-1,1);function x(e,t,s,n,i){if(!function(e,t,s,n,i){const a=r.Om(s,i),o=r.Om(n,i);if(a<0&&o<0)return!1;const l=a/(a-o);return a<0?r.Cc(e,s,n,l):r.C(e,s),o<0?r.Cc(t,s,n,l):r.C(t,n),!0}(a=n,l=i,t,s,T)||((0,o.Wx)(a,a),(0,o.Wx)(l,l),0))return;var a,l;const h=e.canvas.width,c=e.canvas.height;e.moveTo((n[0]+1)*h/2,(1-n[1])*c/2),e.lineTo((i[0]+1)*h/2,(1-i[1])*c/2)}function v(e,t,s,n,i=l.kD,a=2){r.hZ(f[0],s[0],s[1],s[2],1),r.hZ(f[1],n[0],n[1],n[2],1),g(t,f,2),e.beginPath(),x(e,f[0],f[1],f[8],f[9]),e.closePath(),e.lineWidth=a,e.strokeStyle=(0,l.KK)(i),e.stroke()}function C(e,t=window.main.viewer.gfxDevice.queryVendorInfo().clipSpaceNearZ){return e[0]<-1||e[0]>1||e[1]<-1||e[1]>1||e[2]<t||e[2]>1}function b(e,t,s,n=l.kD,i=4){const a=e.canvas.width,h=e.canvas.height;r.hZ(f[0],s[0],s[1],s[2],1),g(t,f,1),(0,o.Wx)(f[0],f[0]),C(f[0])||function(e,t,s,n=l.kD,i=4){const r=i>>>1;e.fillStyle=(0,l.KK)(n),e.fillRect(t-r,e.canvas.height-s-r,i,i)}(e,(f[0][0]+1)*a/2,(f[0][1]+1)*h/2,n,i)}function _(e,t,s,n,i=0,a=l.kD,h={}){const c=e.canvas.width,u=e.canvas.height;r.hZ(f[0],s[0],s[1],s[2],1),g(t,f,1),(0,o.Wx)(f[0],f[0]),C(f[0])||function(e,t,s,n,i=l.kD,r={}){var a,o,h,c;e.fillStyle=(0,l.KK)(i),e.textBaseline="bottom",e.textAlign=null!==(a=r.align)&&void 0!==a?a:"start";const u=14*window.devicePixelRatio;if(e.font=null!==(o=r.font)&&void 0!==o?o:`${u}pt monospace`,r.outline){const a=e.lineWidth;e.lineWidth=r.outline,e.strokeStyle=(0,l.KK)(l.jR,i.a),e.strokeText(n,t,s),e.lineWidth=a}e.shadowColor=null!==(h=r.shadowColor)&&void 0!==h?h:(0,l.KK)(l.jR,i.a),e.shadowBlur=null!==(c=r.shadowBlur)&&void 0!==c?c:0,e.fillText(n,t,s),e.shadowColor="black",e.shadowBlur=0}(e,(f[0][0]+1)*c/2,(1-f[0][1])*u/2+i,n,a,h)}function y(e,t,s=0){e[t]=s%2==1,s<7&&setTimeout(()=>{y(e,t,s+1)},200)}function S(e,t="visible",s=null){const n=e.filter(e=>e[t]);!function(e,t,s){const n=window.main.ui.debugFloaterHolder.makeFloatingPanel("SliderSelect"),i=new c.Ap;i.elem.querySelector("input").classList.remove("Slider"),n.contents.append(i.elem);const r=document.createElement("div");r.style.padding="1em",n.contents.append(r);const a=document.createElement("div");a.textContent="Select",a.style.background="#333",a.style.cursor="pointer",a.style.padding="1em",n.contents.append(a),i.setRange(-1,e.length-1,1),i.onvalue=s=>{i.setLabel(""+s);for(let n=0;n<e.length;n++){const e=t(n,n<=s);n===s&&(r.textContent=e||"")}s<0&&(r.textContent="")},i.setValue(e.length-1,!0),a.onclick=()=>{const e=i.getValue();n.close(),s(e)},n.onclose=()=>{s(-1)}}(n,(e,s)=>{const i=n[e];return i[t]=s,i.name||i.constructor.name},i=>{if(n.forEach(e=>e[t]=!0),i>=n.length||i<0)return;const r=n[i],a=e.indexOf(r);y(r,t),console.log(`Found item @ ${a}:`,r),null!==s&&s(r,a)})}i.vt(),n.vt(),i.vt(),i.vt();const w={interactiveVizSliderSelect:S,bindSliderSelect:function(e,t="visible",s=null){S(e,t,(e,t)=>{window.main.ui.debugFloaterHolder.bindPanel(e),null!==s&&s(e,t)})},hexdump:function(e,t=0,s=256){let n="";const i=(e instanceof a.A?e:new a.A(e)).createTypedArray(Uint8Array,t);s=Math.min(s,i.byteLength);for(let e=0;e<s;e+=16){let r=Math.min(s-e,16);const a=t+e;n+=`${(0,u.yq)(a,8)}    `;for(let t=0;t<r;t++){const s=i[e+t];n+=` ${(0,u.yq)(s,2)}`}for(let e=r;e<16;e++)n+="   ";n+="  ";for(let t=0;t<r;t++){const s=i[e+t];n+=`${s>=32&&s<127?String.fromCharCode(s):"."}`}for(let e=r;e<16;e++)n+=" ";n+="\n"}console.log(n)},magicstr:function(e){return e&=4294967295,String.fromCharCode(e>>>24&255)+String.fromCharCode(e>>>16&255)+String.fromCharCode(e>>>8&255)+String.fromCharCode(e>>>0&255)},ghidraDecode:function(e,t="sjis"){const s=new Uint8Array([...e.matchAll(/[0-9A-Fa-f]{2}h/g)].map(e=>parseInt(e[0].slice(0,2),16)));return console.log([...s].map(e=>e.toString(16))),new TextDecoder(t).decode(s)},downloadBuffer:function(e,t){e.name&&e.arrayBuffer?(0,h.Nz)(e.name,e):t instanceof a.A?(0,h.Nz)(e,t):e.name&&e.buffer?(0,h.Fv)(e.name,e.buffer):t instanceof ArrayBuffer&&(0,h.Fv)(e,t)}}},393(e,t,s){"use strict";function n(e,t){const s=window.URL.createObjectURL(t);!function(e,t){const s=document.createElement("a");s.setAttribute("href",t),s.setAttribute("download",e),document.body.appendChild(s),s.click(),document.body.removeChild(s)}(e,s),window.URL.revokeObjectURL(s)}function i(e,t,s="application/octet-stream"){n(e,new Blob([t.createTypedArray(Uint8Array)],{type:s}))}function r(e,t,s="application/octet-stream"){n(e,new Blob([t],{type:s}))}s.d(t,{Fv:()=>r,Nz:()=>i,WN:()=>n})},9450(e,t,s){"use strict";s.d(t,{F5:()=>f,PP:()=>T,Zc:()=>c});var n=s(7684),i=s(329),r=s(4796),a=s(7714),o=s(5974);const l=r.vt(),h=n.vt();class c{constructor(e=0,t=0,s=0,n=0){this.d=n,this.n=i.vt(),i.hZ(this.n,e,t,s)}set(e,t){i.C(this.n,e),this.d=t}copy(e){this.set(e.n,e.d)}negate(){i.ze(this.n,this.n),this.d*=-1}distance(e,t,s){return e*this.n[0]+t*this.n[1]+s*this.n[2]+this.d}distanceVec3(e){return i.Om(e,this.n)+this.d}set4Unnormalized(e,t,s,n){const r=Math.hypot(e,t,s);i.hZ(this.n,e/r,t/r,s/r),this.d=n/r}getVec4v(e){r.hZ(e,this.n[0],this.n[1],this.n[2],this.d)}setVec4v(e){i.hZ(this.n,e[0],e[1],e[2]),this.d=e[3]}setTri(e,t,s){const n=c.scratchVec3;i.jb(n[0],t,e),i.jb(n[1],s,e),i.$A(this.n,n[0],n[1]),i.S8(this.n,this.n),this.d=-i.Om(this.n,e)}intersectLine(e,t,s){const n=-(i.Om(this.n,t)+this.d)/i.Om(this.n,s);i.Ln(e,t,s,n)}intersectLineSegment(e,t,s){const n=c.scratchVec3[1];i.jb(n,s,t),this.intersectLine(e,t,n)}transform(e){this.getVec4v(l),n.B8(h,e),n.mg(h,h),r.Z0(l,l,h),this.setVec4v(l)}}c.scratchVec3=(0,o.y5)(2,()=>i.vt());const u=i.vt(),d=i.vt(),m=i.vt(),p=i.vt();class f{constructor(e=1/0,t=1/0,s=1/0,n=-1/0,i=-1/0,r=-1/0){this.minX=e,this.minY=t,this.minZ=s,this.maxX=n,this.maxY=i,this.maxZ=r}transform(e,t){const s=u,n=d;i.hZ(s,e.minX,e.minY,e.minZ),i.hZ(n,e.maxX,e.maxY,e.maxZ);const r=m,a=p;i.hZ(r,t[12],t[13],t[14]),i.hZ(a,t[12],t[13],t[14]);for(let e=0;e<3;e++)for(let i=0;i<3;i++){const o=t[4*e+i]*s[e],l=t[4*e+i]*n[e];r[i]+=Math.min(o,l),a[i]+=Math.max(o,l)}this.minX=r[0],this.minY=r[1],this.minZ=r[2],this.maxX=a[0],this.maxY=a[1],this.maxZ=a[2]}offset(e,t){this.minX=e.minX+t[0],this.minY=e.minY+t[1],this.minZ=e.minZ+t[2],this.maxX=e.maxX+t[0],this.maxY=e.maxY+t[1],this.maxZ=e.maxZ+t[2]}expandByExtent(e,t){this.minX=e.minX-t[0],this.minY=e.minY-t[1],this.minZ=e.minZ-t[2],this.maxX=e.maxX+t[0],this.maxY=e.maxY+t[1],this.maxZ=e.maxZ+t[2]}set(e,t,s,n,i,r){this.minX=e,this.minY=t,this.minZ=s,this.maxX=n,this.maxY=i,this.maxZ=r}reset(){this.set(1/0,1/0,1/0,-1/0,-1/0,-1/0)}copy(e){this.set(e.minX,e.minY,e.minZ,e.maxX,e.maxY,e.maxZ)}clone(){const e=new f;return e.copy(this),e}setFromPoints(e){this.minX=this.minY=this.minZ=1/0,this.maxX=this.maxY=this.maxZ=-1/0;for(let t=0;t<e.length;t++){const s=e[t];this.minX=Math.min(this.minX,s[0]),this.minY=Math.min(this.minY,s[1]),this.minZ=Math.min(this.minZ,s[2]),this.maxX=Math.max(this.maxX,s[0]),this.maxY=Math.max(this.maxY,s[1]),this.maxZ=Math.max(this.maxZ,s[2])}}union(e,t){this.minX=Math.min(e.minX,t.minX),this.minY=Math.min(e.minY,t.minY),this.minZ=Math.min(e.minZ,t.minZ),this.maxX=Math.max(e.maxX,t.maxX),this.maxY=Math.max(e.maxY,t.maxY),this.maxZ=Math.max(e.maxZ,t.maxZ)}unionPoint(e){let t=!1;return e[0]<this.minX&&(this.minX=e[0],t=!0),e[1]<this.minY&&(this.minY=e[1],t=!0),e[2]<this.minZ&&(this.minZ=e[2],t=!0),e[0]>this.maxX&&(this.maxX=e[0],t=!0),e[1]>this.maxY&&(this.maxY=e[1],t=!0),e[2]>this.maxZ&&(this.maxZ=e[2],t=!0),t}static intersect(e,t){return!(e.minX>t.maxX||t.minX>e.maxX||e.minY>t.maxY||t.minY>e.maxY||e.minZ>t.maxZ||t.minZ>e.maxZ)}containsPoint(e){const t=e[0],s=e[1],n=e[2];return!(t<this.minX||t>this.maxX||s<this.minY||s>this.maxY||n<this.minZ||n>this.maxZ)}containsSphere(e,t){const s=e[0],n=e[1],i=e[2];return!(s<this.minX-t||s>this.maxX+t||n<this.minY-t||n>this.maxY+t||i<this.minZ-t||i>this.maxZ+t)}extents(e){e[0]=Math.max((this.maxX-this.minX)/2,0),e[1]=Math.max((this.maxY-this.minY)/2,0),e[2]=Math.max((this.maxZ-this.minZ)/2,0)}diagonalLengthSquared(){const e=this.maxX-this.minX,t=this.maxY-this.minY,s=this.maxZ-this.minZ;return e*e+t*t+s*s}centerPoint(e){e[0]=(this.minX+this.maxX)/2,e[1]=(this.minY+this.maxY)/2,e[2]=(this.minZ+this.maxZ)/2}setFromCenterAndExtents(e,t){this.minX=e[0]-t[0],this.minY=e[1]-t[1],this.minZ=e[2]-t[2],this.maxX=e[0]+t[0],this.maxY=e[1]+t[1],this.maxZ=e[2]+t[2]}cornerPoint(e,t){if(0===t)i.hZ(e,this.minX,this.minY,this.minZ);else if(1===t)i.hZ(e,this.maxX,this.minY,this.minZ);else if(2===t)i.hZ(e,this.minX,this.maxY,this.minZ);else if(3===t)i.hZ(e,this.maxX,this.maxY,this.minZ);else if(4===t)i.hZ(e,this.minX,this.minY,this.maxZ);else if(5===t)i.hZ(e,this.maxX,this.minY,this.maxZ);else if(6===t)i.hZ(e,this.minX,this.maxY,this.maxZ);else{if(7!==t)throw"whoops";i.hZ(e,this.maxX,this.maxY,this.maxZ)}}boundingSphereRadius(){const e=this.maxX-this.minX,t=this.maxY-this.minY,s=this.maxZ-this.minZ;return Math.hypot(e,t,s)/2}maxCornerRadius(){const e=Math.max(this.maxX,-this.minX),t=Math.max(this.maxY,-this.minY),s=Math.max(this.maxZ,-this.minZ);return Math.sqrt(e*e+t*t+s*s)}isEmpty(){return this.extents(u),0===u[0]&&0===u[1]&&0===u[2]}distanceVec3(e){return this.centerPoint(u),i.Io(e,u)}}var g;!function(e){e[e.Inside=0]="Inside",e[e.Outside=1]="Outside",e[e.Intersection=2]="Intersection"}(g||(g={}));class T{constructor(){this.planes=(0,o.y5)(6,()=>new c)}updateClipFrustum(e,t){this.planes[0].set4Unnormalized(-(e[3]+e[0]),-(e[7]+e[4]),-(e[11]+e[8]),-(e[15]+e[12])),this.planes[1].set4Unnormalized(-(e[3]-e[0]),-(e[7]-e[4]),-(e[11]-e[8]),-(e[15]-e[12])),this.planes[2].set4Unnormalized(-(e[3]+e[1]),-(e[7]+e[5]),-(e[11]+e[9]),-(e[15]+e[13])),this.planes[3].set4Unnormalized(-(e[3]-e[1]),-(e[7]-e[5]),-(e[11]-e[9]),-(e[15]-e[13])),t===a.uA.NegativeOne?this.planes[4].set4Unnormalized(-(e[3]+e[2]),-(e[7]+e[6]),-(e[11]+e[10]),-(e[15]+e[14])):t===a.uA.Zero&&this.planes[4].set4Unnormalized(-e[2],-e[6],-e[10],-e[14]),this.planes[5].set4Unnormalized(-(e[3]-e[2]),-(e[7]-e[6]),-(e[11]-e[10]),-(e[15]-e[14]))}intersect(e){let t=g.Inside;for(let s=0;s<6;s++){const n=this.planes[s],i=n.n[0]>=0?e.minX:e.maxX,r=n.n[1]>=0?e.minY:e.maxY,a=n.n[2]>=0?e.minZ:e.maxZ;if(n.distance(i,r,a)>0)return g.Outside;const o=n.n[0]>=0?e.maxX:e.minX,l=n.n[1]>=0?e.maxY:e.minY,h=n.n[2]>=0?e.maxZ:e.minZ;n.distance(o,l,h)>0&&(t=g.Intersection)}return t}contains(e){return this.intersect(e)!==g.Outside}intersectSphere(e,t){let s=g.Inside;for(let n=0;n<6;n++){const i=this.planes[n].distance(e[0],e[1],e[2]);if(i>t)return g.Outside;i>-t&&(s=g.Intersection)}return s}containsSphere(e,t){return this.intersectSphere(e,t)!==g.Outside}containsPoint(e){for(let t=0;t<6;t++)if(this.planes[t].distance(e[0],e[1],e[2])>0)return!1;return!0}transform(e,t){for(let s in this.planes)this.planes[s].copy(e.planes[s]),this.planes[s].transform(t)}}},9009(e,t,s){"use strict";function n(e){document.body.style.cursor!==e&&(document.body.focus(),document.body.style.cursor=e)}s.d(t,{B:()=>i});const i=new class{constructor(){this.grabListener=null,this.grabOptions=null,this.currentGrabTarget=null,this.usingPointerLock=!1,this.lastX=-1,this.lastY=-1,this.grabButton=-1,this._onMouseMove=e=>{if(null===this.grabListener)return;let t,s;void 0!==e.movementX?(t=e.movementX,s=e.movementY):(t=e.pageX-this.lastX,s=e.pageY-this.lastY,this.lastX=e.pageX,this.lastY=e.pageY),this.grabListener.onMotion(t,s)},this._onMouseDown=e=>{const t=this.grabOptions.grabElement;t&&function(e,t){let s=e;for(;null!==s;){if(s===t)return!0;s=s.parentElement}return!1}(e.target,t)||this.releaseGrab()},this._onMouseUp=e=>{e.button===this.grabButton&&this.releaseGrab()},this._onPointerLockChange=e=>{document.pointerLockElement===this.currentGrabTarget?this.usingPointerLock=!0:this.releaseGrab()},this._onPointerLockError=e=>{null!==this.grabOptions&&this.grabOptions.useGrabbingCursor&&n("grabbing")}}getGrabListenerOptions(e){return this.grabListener===e?this.grabOptions:null}isGrabbed(){return null!==this.grabListener}takeGrab(e,t,s){if(t.preventDefault(),null!==this.grabListener)return;this.grabListener=e,this.grabOptions=s,this.lastX=t.pageX,this.lastY=t.pageY,this.grabButton=t.button;const n=t.target;n.focus(),this.usingPointerLock=!1,s.takePointerLock&&void 0!==n.requestPointerLock&&(document.addEventListener("pointerlockchange",this._onPointerLockChange),document.addEventListener("pointerlockerror",this._onPointerLockError),n.requestPointerLock(),this.currentGrabTarget=n),document.addEventListener("mousemove",this._onMouseMove),s.releaseOnMouseUp?document.addEventListener("mouseup",this._onMouseUp):document.addEventListener("mousedown",this._onMouseDown,{capture:!0})}releaseGrab(){document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("mousedown",this._onMouseDown,{capture:!0}),null!==this.currentGrabTarget&&(document.removeEventListener("pointerlockchange",this._onPointerLockChange),void 0!==document.exitPointerLock&&document.exitPointerLock()),this.grabOptions.useGrabbingCursor&&!this.usingPointerLock&&n("");const e=this.grabListener;this.grabListener=null,e.onGrabReleased(),this.grabOptions=null}}},2466(e,t,s){"use strict";function n(e,t){return e+=t,e+=e<<10,(e+=e>>>6)>>>0}function i(e){return e+=e<<3,e^=e>>>11,(e+=e<<15)>>>0}function r(e){return 0}s.d(t,{Bs:()=>o,Kt:()=>r,S5:()=>i,gt:()=>n});class a{constructor(){this.keys=[],this.values=[]}}class o{constructor(e,t){this.keyEqualFunc=e,this.keyHashFunc=t,this.buckets=new Map}findBucketIndex(e,t){for(let s=0;s<e.keys.length;s++)if(this.keyEqualFunc(t,e.keys[s]))return s;return-1}findBucket(e){const t=this.keyHashFunc(e);return this.buckets.get(t)}get(e){const t=this.findBucket(e);if(void 0===t)return null;const s=this.findBucketIndex(t,e);return s<0?null:t.values[s]}add(e,t){const s=this.keyHashFunc(e);void 0===this.buckets.get(s)&&this.buckets.set(s,new a);const n=this.buckets.get(s);n.keys.push(e),n.values.push(t)}delete(e){const t=this.findBucket(e);if(void 0===t)return;const s=this.findBucketIndex(t,e);-1!==s&&(t.keys.splice(s,1),t.values.splice(s,1))}clear(){this.buckets.clear()}size(){let e=0;for(const t of this.buckets.values())e+=t.values.length;return e}*values(){for(const e of this.buckets.values())for(let t=e.values.length-1;t>=0;t--)yield e.values[t]}*items(){for(const e of this.buckets.values())for(let t=e.keys.length-1;t>=0;t--)yield[e.keys[t],e.values[t]]}}},841(e,t,s){"use strict";s.d(t,{A:()=>o,p:()=>i});var n,i,r=s(5098),a=s(9009);!function(e){e[e.None=0]="None",e[e.Scroll=1]="Scroll",e[e.Pinch=2]="Pinch"}(n||(n={})),function(e){e[e.None=0]="None",e[e.Dragging=1]="Dragging",e[e.PointerLocked=2]="PointerLocked"}(i||(i={}));class o{constructor(e){this.invertY=!1,this.invertX=!1,this.mouseX=-1,this.mouseY=-1,this.dx=0,this.dy=0,this.dz=0,this.buttons=0,this.ondraggingmodechanged=null,this.scrollListeners=[],this.usePointerLock=!0,this.isInteractive=!0,this.touchGesture=n.None,this.prevTouchX=0,this.prevTouchY=0,this.prevPinchDist=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this.releaseOnMouseUp=!0,this._onKeyDown=e=>{if(function(e){switch(e){case"ShiftLeft":case"ShiftRight":case"AltLeft":case"AltRight":return!0;default:return!1}}(e.code))e.preventDefault();else if(!this._hasFocus())return;this.keysDown.set(e.code,!e.repeat)},this._onKeyUp=e=>{this.keysDown.delete(e.code)},this._onBlur=()=>{this.keysDown.clear()},this._onWheel=e=>{e.preventDefault(),this.dz+=-4*Math.sign(e.deltaY),this._callScrollListeners()},this._onTouchChange=e=>{if(this.isInteractive)if(e.preventDefault(),1==e.touches.length){const t=this._getScaledTouches(e.touches);this.touchGesture=n.Scroll,this.prevTouchX=t[0].x,this.prevTouchY=t[0].y,this.dTouchX=0,this.dTouchY=0}else if(2==e.touches.length){const t=this._getPinchValues(e.touches);this.touchGesture=n.Pinch,this.prevTouchX=t.x,this.prevTouchY=t.y,this.prevPinchDist=t.dist,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0}else this.touchGesture=n.None},this._onTouchMove=e=>{if(this.isInteractive)if(e.preventDefault(),1==e.touches.length){const t=this._getScaledTouches(e.touches);this.touchGesture=n.Scroll,this.dTouchX=t[0].x-this.prevTouchX,this.dTouchY=t[0].y-this.prevTouchY,this.onMotion(this.dTouchX,this.dTouchY),this.prevTouchX=t[0].x,this.prevTouchY=t[0].y}else if(2==e.touches.length){const t=this._getPinchValues(e.touches);this.touchGesture=n.Pinch,this.dTouchX=t.x-this.prevTouchX,this.dTouchY=t.y-this.prevTouchY,this.dPinchDist=t.dist-this.prevPinchDist,this.prevTouchX=t.x,this.prevTouchY=t.y,this.prevPinchDist=t.dist}else this.touchGesture=n.None},document.body.tabIndex=-1,this.toplevel=e,this.toplevel.tabIndex=-1,this.keysDown=new Map,document.addEventListener("keydown",this._onKeyDown,{capture:!0}),document.addEventListener("keyup",this._onKeyUp,{capture:!0}),window.addEventListener("blur",this._onBlur),window.addEventListener("contextmenu",e=>{e.preventDefault()}),this.toplevel.addEventListener("wheel",this._onWheel,{passive:!1}),this.toplevel.addEventListener("mousedown",e=>{this.isInteractive&&(this.buttons=e.buttons,a.B.takeGrab(this,e,{takePointerLock:this.usePointerLock,useGrabbingCursor:!0,releaseOnMouseUp:this.releaseOnMouseUp}),null!==this.ondraggingmodechanged&&this.ondraggingmodechanged())}),this.toplevel.addEventListener("mousemove",e=>{this.mouseX=e.clientX*window.devicePixelRatio,this.mouseY=e.clientY*window.devicePixelRatio}),this.toplevel.addEventListener("mouseup",e=>{this.buttons=e.buttons}),this.toplevel.addEventListener("touchstart",this._onTouchChange),this.toplevel.addEventListener("touchend",this._onTouchChange),this.toplevel.addEventListener("touchcancel",this._onTouchChange),this.toplevel.addEventListener("touchmove",this._onTouchMove),this.afterFrame(),r._h.addSettingListener("InvertX",(e,t)=>{this.invertX=e.loadSetting(t,!1)}),r._h.addSettingListener("InvertY",(e,t)=>{this.invertY=e.loadSetting(t,!1)})}addScrollListener(e){this.scrollListeners.push(e)}getMouseDeltaX(){return this.dx}getMouseDeltaY(){return this.dy}getTouchDeltaX(){return this.touchGesture===n.Pinch?this.dTouchX:0}getTouchDeltaY(){return this.touchGesture===n.Pinch?this.dTouchY:0}getPinchDeltaDist(){return this.touchGesture===n.Pinch?this.dPinchDist:0}isKeyDownEventTriggered(e){return!!this.keysDown.get(e)}isKeyDown(e){return this.keysDown.has(e)}getDraggingMode(){if(this.touchGesture!==n.None)return i.Dragging;const e=a.B.getGrabListenerOptions(this);return null!==e?e.takePointerLock?i.PointerLocked:i.Dragging:i.None}isDragging(){return this.getDraggingMode()!==i.None}afterFrame(){this.dx=0,this.dy=0,this.dz=0,this.dTouchX=0,this.dTouchY=0,this.dPinchDist=0,this.keysDown.forEach((e,t)=>{this.keysDown.set(t,!1)})}_hasFocus(){return document.activeElement===document.body||document.activeElement===this.toplevel}_callScrollListeners(){for(let e=0;e<this.scrollListeners.length;e++)this.scrollListeners[e](this)}_getScaledTouches(e){const t=[],s=1e3/Math.max(1,Math.min(this.toplevel.clientWidth,this.toplevel.clientHeight));for(let n=0;n<e.length;n++)t.push({x:e[n].clientX*s,y:e[n].clientY*s});return t}_getPinchValues(e){const t=this._getScaledTouches(e);return{x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2,dist:Math.hypot(t[0].x-t[1].x,t[0].y-t[1].y)}}onMotion(e,t){Math.abs(e)>200||Math.abs(t)>200||(this.dx+=e,this.dy+=t)}onGrabReleased(){this.buttons=0,null!==this.ondraggingmodechanged&&this.ondraggingmodechanged()}reset(){this.isInteractive=!0}}},5339(e,t,s){"use strict";s.d(t,{BM:()=>w,BS:()=>g,Bl:()=>E,Cc:()=>T,Gh:()=>_,Ih:()=>f,Io:()=>A,Ip:()=>o,PI:()=>l,TF:()=>v,Xv:()=>R,YI:()=>h,Ye:()=>u,bB:()=>d,eh:()=>y,i0:()=>a,kC:()=>S,nU:()=>C,po:()=>x,qE:()=>p,rr:()=>c,u7:()=>b,wZ:()=>n});var n,i=s(7684),r=s(329);!function(e){e[e.DEG_TO_RAD=.017453292519943295]="DEG_TO_RAD",e[e.RAD_TO_DEG=57.29577951308232]="RAD_TO_DEG",e[e.TAU=6.283185307179586]="TAU",e[e.EPSILON=1e-6]="EPSILON"}(n||(n={}));const a=r.fA(0,0,0),o=(r.fA(1,1,1),r.fA(1,0,0)),l=r.fA(0,1,0),h=r.fA(0,0,1);function c(e,t,s,n,i,r,a,o,l,h){const c=Math.sin(i),u=Math.cos(i),d=Math.sin(r),m=Math.cos(r),p=Math.sin(a),f=Math.cos(a);e[0]=t*(m*f),e[1]=t*(p*m),e[2]=t*-d,e[3]=0,e[4]=s*(c*f*d-u*p),e[5]=s*(c*p*d+u*f),e[6]=s*(c*m),e[7]=0,e[8]=n*(u*f*d+c*p),e[9]=n*(u*p*d-c*f),e[10]=n*(m*u),e[11]=0,e[12]=o,e[13]=l,e[14]=h,e[15]=1}function u(e,t,s){const n=s[0],i=s[1],r=s[2];e[0]=t[0]*n+t[4]*i+t[8]*r+t[12],e[1]=t[1]*n+t[5]*i+t[9]*r+t[13],e[2]=t[2]*n+t[6]*i+t[10]*r+t[14]}function d(e,t,s){const n=s[0],i=s[1],r=s[2];e[0]=t[0]*n+t[4]*i+t[8]*r,e[1]=t[1]*n+t[5]*i+t[9]*r,e[2]=t[2]*n+t[6]*i+t[10]*r}function m(e,t){return Math.abs(e-t)<=n.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}function p(e,t,s){return Math.max(t,Math.min(e,s))}function f(e){return p(e,0,1)}function g(e,t){return p(e,-t,t)}function T(e,t,s){return e+(t-e)*s}function x(e,t,s){return(s-e)/(t-e)}function v(e){return e*e*(3-2*e)}function C(e,t,s,i=n.TAU){const r=(t-e)%i;return e+(2*r%i-r)*s}function b(e,t,s,n,i,r,a){const o=1/(s-t),l=1/(i-n);if(e[0]=2*r*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*r*l,e[6]=0,e[7]=0,e[8]=(s+t)*o,e[9]=(i+n)*l,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,a!==1/0){const t=1/(r-a);e[10]=(a+r)*t,e[14]=a*r*2*t}else e[10]=-1,e[14]=-2*r}function _(e,t,s,n,i,r,a){const o=1/(s-t),l=1/(i-n),h=1/(r-a);e[0]=2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*h,e[11]=0,e[12]=-(s+t)*o,e[13]=-(i+n)*l,e[14]=(a+r)*h,e[15]=1}function y(e,t){m(t[2],1)?(e[0]=Math.atan2(-t[4],-t[8]),e[1]=-Math.PI/2,e[2]=0):m(t[2],-1)?(e[0]=Math.atan2(t[4],t[8]),e[1]=Math.PI/2,e[2]=0):(e[0]=Math.atan2(t[6],t[10]),e[1]=-Math.asin(t[2]),e[2]=Math.atan2(t[1],t[0]))}function S(e,t,s){const n=Math.sin(s);e[0]=n*Math.cos(t),e[1]=Math.cos(s),e[2]=n*Math.sin(t)}function w(e,t){r.hZ(e,t[0],t[1],t[2])}function A(e,t){r.hZ(e,t[4],t[5],t[6])}function E(e,t){r.hZ(e,t[8],t[9],t[10])}function R(e,t){r.hZ(e,t[12],t[13],t[14])}r.fA(-1,0,0),r.fA(0,-1,0),r.fA(0,0,-1),i.fA(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),r.vt(),r.vt(),r.vt();const I=new ArrayBuffer(4);var k;new Float32Array(I),new Uint32Array(I),function(e){e[e.UseRollLocal=0]="UseRollLocal",e[e.UseRollGlobal=1]="UseRollGlobal",e[e.PriorityZ=0]="PriorityZ",e[e.PriorityY=2]="PriorityY",e[e.UseZPlane=0]="UseZPlane",e[e.UseZSphere=4]="UseZSphere"}(k||(k={}))},5093(e,t,s){"use strict";s.d(t,{P:()=>u});const n='"Source Code Pro", "Droid Sans Mono", monospace';function i(e,t,s){console.assert("#"===e[0]&&7===e.length);const n=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);console.assert("#"===t[0]&&7===t.length);const a=parseInt(t.slice(1,3),16),o=i+(parseInt(t.slice(3,5),16)-i)*s,l=r+(parseInt(t.slice(5,7),16)-r)*s;return`#${(0|n+(a-n)*s).toString(16)}${(0|o).toString(16)}${(0|l).toString(16)}`}function r(e){console.assert("#"===e[0]&&7===e.length);const t=(0|.299*parseInt(e.slice(1,3),16)+.587*parseInt(e.slice(3,5),16)+.114*parseInt(e.slice(5,7),16)).toString(16);return`#${t}${t}${t}`}class a{constructor(e){this._document=e,this._styleElem=this._document.createElement("style"),this._document.head.appendChild(this._styleElem),this._style=this._styleElem.sheet,this._owner=null}setCursor(e,t){if(!this._owner||e===this._owner)if(this._style.cssRules.length&&this._style.deleteRule(0),t){const s=`* { cursor: ${t} !important; }`;this._style.insertRule(s,0),this._owner=e}else this._owner=null}}class o{constructor(e,t){this._document=e,this._cursorOverride=t,this.onvalue=null,this.onend=null,this._onMouseMove=e=>{e.stopPropagation();const t=Math.round((e.clientX-this._anchorMouseX)/15),s=this._anchorValue+t*this._currentIncr;this._value!==s&&(this._value=s,this.onvalue(this._value));const n=e.clientY;for(const t of this._segments)if(n<t.getBoundingClientRect().bottom){this._selectSegment(t)&&this._anchorValue!==this._value&&(this._anchorMouseX=e.clientX,this._anchorValue=this._value);break}},this._onMouseUp=e=>{if(this._cursorOverride.setCursor(this,""),this._document.documentElement.removeEventListener("mouseup",this._onMouseUp),this.onend(),this._showTimeout)return clearTimeout(this._showTimeout),void(this._showTimeout=0);this._document.documentElement.removeEventListener("mousemove",this._onMouseMove,{capture:!0}),this._document.body.removeChild(this._toplevel)},this.onvalue=null,this.onend=null,this._toplevel=this._document.createElement("div"),this._toplevel.style.position="absolute",this._toplevel.style.transform="translate(0, 0)",this._toplevel.style.fontFamily=n,this._toplevel.style.backgroundColor="#232323",this._toplevel.style.color="#c93",this._toplevel.style.border="2px solid #c93",this._toplevel.style.lineHeight="2em",this._toplevel.style.marginLeft="1em",this._toplevel.style.borderRadius="6px",this._toplevel.style.boxShadow="rgba(0, 0, 0, .4) 0px 4px 16px",this._toplevel.style.zIndex="9999",this._segments=[];for(let e=2;e>=-2;e--){const t=Math.pow(10,e),s=this._document.createElement("div");s._incr=t,s.style.padding=".5em 1em",s.textContent=""+t,this._toplevel.appendChild(s),this._segments.push(s)}this._anchorMouseX=0,this._anchorValue=void 0,this._value=void 0}_selectSegment(e){const t=e._incr;if(this._currentIncr===t)return!1;this._currentIncr=t;for(const t of this._segments){const s=t===e;t.style.backgroundColor=s?"#c93":"",t.style.color=s?"#222":"",t.style.fontWeight=s?"bold":""}return!0}_show(){this._showTimeout=0,this._document.body.appendChild(this._toplevel),this._document.documentElement.addEventListener("mousemove",this._onMouseMove,{capture:!0})}setPosition(e,t){this._toplevel.style.left=e+"px",this._toplevel.style.top=t+"px"}show(e,t){this._anchorMouseX=t.clientX,this._anchorValue=e;let s=0;for(let t=-2;t<=2;t++){const n=Math.pow(10,t+1);if(e>-n&&e<n){s=t;break}}const n=4-(s+2);this._selectSegment(this._segments[n]),this._toplevel.style.transform=`translate(0, ${["-10.5%","-30%","-50%","-70%","-89.5%"][n]}`,this._document.documentElement.addEventListener("mouseup",this._onMouseUp),this._showTimeout=window.setTimeout(this._show.bind(this),100),this._cursorOverride.setCursor(this,"e-resize")}}class l{constructor(e){this._document=e,this.onvaluechanged=null,this._valueChanged=!1,this._valueChangedImmediate=!1,this._needsRecalculate=!1,this._draggingNumber=null,this._onInput=()=>{this._setValueChanged()},this._onKeyDown=e=>{if("Tab"!==e.key||e.shiftKey){if("Tab"===e.key&&e.shiftKey)e.preventDefault();else if("Home"===e.key){const t=this._getCursorIdx(),{line:s,lineIdx:n}=this._getCharPos(t),i=this._calculateIndentedLineStart(s);if(t!==i){if(e.shiftKey){const[e]=this._getSelection();this._setSelection(this._idxToTextarea(e),this._idxToTextarea(i))}else this._setCursor(this._idxToTextarea(i));e.preventDefault()}}}else this._hasSelection()||this._insertAtCursor("    "),e.preventDefault()},this._onMouseDown=e=>{e.preventDefault();const{row:t,col:s}=this._xyToRowCol(e.offsetX,e.offsetY),{line:n}=this._rowColToLineIdx(t,0,!0);if(this._isLineLocked(n))this._textarea.blur();else if(-1===s)this._setSelection(this._idxToTextarea(n.start),this._idxToTextarea(n.end)),this._textarea.focus();else{const{idx:n}=this._rowColToLineIdx(t,s,!0);this._textarea.focus();const{idx:i}=this._rowColToLineIdx(t,s,!1),r=this._findDraggableNumber(i);if(!e.shiftKey&&r){const t=this._idxToTextarea(r.start),s=this._idxToTextarea(r.end),i=+this.getValue().slice(t,s);this._draggingNumber={start:t,end:s,value:i},this._syncNumberDraggerPosition(),this._setCursor(this._idxToTextarea(n)),this._numberDragger.show(i,e)}else e.shiftKey?(this._hasSelection()||(this._dragStartIdx=this._textarea.selectionStart),this._setSelection(this._dragStartIdx,this._idxToTextarea(n))):(this._dragStartIdx=this._idxToTextarea(n),this._setCursor(this._dragStartIdx)),this._dragging="selection",this._document.documentElement.addEventListener("mousemove",this._onMouseMove,{capture:!0}),this._document.documentElement.addEventListener("mouseup",this._onMouseUp)}},this._onMouseUp=e=>{this._dragging=void 0,this._document.documentElement.removeEventListener("mousemove",this._onMouseMove,{capture:!0}),this._document.documentElement.removeEventListener("mouseup",this._onMouseUp)},this._onMouseMove=e=>{e.stopPropagation(),this._mouseX=e.offsetX,this._mouseY=e.offsetY,this._recalculateMouseIdx();const{row:t,col:s}=this._xyToRowCol(this._mouseX,this._mouseY),{line:n,idx:i}=this._rowColToLineIdx(t,s,!0);"selection"===this._dragging&&(this._setSelection(this._dragStartIdx,this._idxToTextarea(i)),this._textarea.focus());const{line:r,idx:a}=this._rowColToLineIdx(t,s,!1),o=this._isLineLocked(n);let l;l="selection"===this._dragging?"text":-1===s||o?"default":!e.shiftKey&&this._findDraggableNumber(a)?"e-resize":"text",this._canvas.style.cursor=l,this._dragging?this._cursorOverride.setCursor(this,l):this._cursorOverride.setCursor(this,"")},this._onMouseLeave=e=>{this._mouseX=void 0,this._mouseY=void 0,this._mouseIdx=void 0},this._onScroll=()=>{this._setNeedsRecalculate()},this._onNumberDraggerValue=e=>{const{start:t,end:s}=this._draggingNumber,n=function(e,t=2){let s=e.toFixed(t);for(;s.includes(".")&&".0".includes(s.slice(-1));)s=s.slice(0,-1);return s.includes(".")||(s+=".0"),s}(e);this.setValue(this._spliceValue(t,s,n)),this._draggingNumber.end=t+n.length,this._syncNumberDraggerPosition()},this._onNumberDraggerEnd=()=>{this._draggingNumber=null},this._redraw=e=>{const t=this._document.hasFocus();if(!this._needsRecalculate&&!t)return;this._recalculate();const s=this._canvas.getBoundingClientRect(),n=this._document.defaultView,a=n.devicePixelRatio,o=this._width*a,l=this._height*a;let h=!1;this._canvas.width===o&&this._canvas.height===l||(this._canvas.width=o,this._canvas.height=l,h=!0);const c=Math.max(0,s.left),u=Math.max(0,s.top),d=n.innerWidth,m=n.innerHeight,p=Math.min(d,s.right),f=Math.min(m,s.bottom),g=c-s.left,T=u-s.top,x=p-c,v=f-u,C=Math.floor(T/this._rowHeight-this._paddingTop),b=Math.ceil((T+v)/this._rowHeight-this._paddingTop),_=e=>e>=C&&e<=b,y=e=>(this._paddingTop+e)*this._rowHeight,S=this._canvas.getContext("2d");if(S.save(),h||(S.rect(g,T,x,v),S.clip()),S.scale(a,a),S.fillStyle="#232323",S.fillRect(0,0,this._width,this._height),t){const t=this._idxToTextarea(this._getCursorIdx());this._redraw_cursorPosition!==t&&(this._redraw_cursorPosition=t,this._redraw_cursorBlinkStart=e)}else this._redraw_cursorPosition=void 0;const w=this._textareaStyle.fontSize,A=this._textareaStyle.fontFamily;S.font=`${w} ${A}`;const E=(e,t)=>{const s=y(e.startRow),n=this._rowHeight*e.rows;S.fillStyle=t.color,S.fillRect(0,s,this._canvas.width,n)};if(this._redraw_cursorPosition){const{line:e}=this._getCharPos(this._textareaToIdx(this._redraw_cursorPosition));E(e,{color:"#2f2a34",lineno:-1})}if(this._lineFlairs)for(const e of this._lineFlairs){const t=this._lineModel[e.lineno];t&&E(t,e)}S.save(),S.fillStyle="#445",S.fillRect(0,0,this._gutterWidth,this._canvas.height),S.restore();for(let e=0;e<this._lineModel.length;e++){const t=this._lineModel[e];if(!_(t.startRow))continue;const s=t.lineno+1,n=y(t.startRow);S.fillStyle=this._isLineLocked(t)?"#888":"#ccc",S.textBaseline="top",S.textAlign="right";const i=""+s;S.fillText(i,this._gutterWidth-this._gutterMargin,this._charMarginTop+n)}const R=this.getFullText()+"\n";if(S.save(),S.translate(this._gutterWidth+this._textMargin,0),this._hasSelection()){const e=this._getCharPos(this._textareaToIdx(this._textarea.selectionStart)),s=this._getCharPos(this._textareaToIdx(this._textarea.selectionEnd));for(let n=e.row;n<=s.row;n++){let i=n===e.row?e.col:0,r=n===s.row?s.col:this._getRowLength(n);const a=t?"#336":"#333",o=i*this._charWidth,l=r*this._charWidth,h=y(n);S.fillStyle=a,S.fillRect(o,h,l-o,this._rowHeight)}}const I=this._syntaxRuns;let k,M,P=0;if(null!==this._draggingNumber){const{start:e,end:t}=this._draggingNumber;k={start:this._textareaToIdx(e),end:this._textareaToIdx(t)}}else!this._dragging&&this._mouseIdx>-1&&(k=this._findDraggableNumber(this._mouseIdx));for(let t=0;t<this._lineModel.length;t++){const s=this._lineModel[t];let n=s.startRow,a=0;for(let t=s.start;t<s.end;t++){if(a===this._cols&&n-s.startRow<s.rows-1&&(n++,a=0),!_(n))continue;const o=R.charAt(t),l=a*this._charWidth,h=y(n);if(t===this._textareaToIdx(this._redraw_cursorPosition)){S.save(),S.fillStyle="#fff";const t=(e-this._redraw_cursorBlinkStart)/1e3,s=Math.sin(6*t)+1;S.globalAlpha=s,S.fillRect(Math.floor(l),h,2,this._rowHeight),S.restore()}if("\n"===o)break;void 0!==k&&t>=k.start&&t<k.end&&(S.save(),S.beginPath(),S.moveTo(0|l,h+this._rowHeight),S.lineTo(l+this._charWidth|0,h+this._rowHeight),S.setLineDash([1,1]),S.strokeStyle="rgba(255, 255, 255, 0.6)",S.lineWidth=1,S.stroke(),S.restore());let c="#e6e1dc",u="";for(;P<I.length&&t>=I[P].end;)P++;if(P<I.length){const e=I[P];t>=e.start&&t<e.end&&(e.color&&(c=e.color),e.style&&(u=e.style))}this._isLineLocked(s)&&(c=i(c,r(c),.75)),S.textBaseline="top",S.textAlign="left",S.fillStyle=c;const d=`${u} ${w} ${A}`;M!==d&&(S.font=d,M=d),S.fillText(o,l,h+this._charMarginTop),a++}}S.restore(),S.restore()},this.onvaluechanged=null,this._prefix="",this._suffix="",this._paddingTop=.2,this._paddingBottom=1.5,this._toplevel=this._document.createElement("div"),this._toplevel.style.position="relative",this._document.body.appendChild(this._toplevel),this._document.addEventListener("scroll",this._onScroll),this._canvas=this._document.createElement("canvas"),this._toplevel.appendChild(this._canvas),this._textarea=this._document.createElement("textarea"),this._textarea.style.fontFamily=n,this._textarea.oninput=this._onInput,this._textarea.onkeydown=this._onKeyDown,this._toplevel.appendChild(this._textarea),this._canvas.onmousedown=this._onMouseDown,this._canvas.onmouseleave=this._onMouseLeave,this._canvas.onmousemove=this._onMouseMove,this._textarea.style.whiteSpace="pre-wrap",this._textarea.style.wordBreak="break-all",this._textarea.style.position="absolute",this._textarea.style.left="-99999px",this._textarea.style.overflow="hidden",this._canvas.style.position="absolute",this._cursorOverride=new a(this._document),this._numberDragger=new o(this._document,this._cursorOverride),this._numberDragger.onvalue=this._onNumberDraggerValue,this._numberDragger.onend=this._onNumberDraggerEnd,this.elem=this._toplevel,function(e,t){const s=e.ownerDocument.defaultView;let n=!1;function i(e){t(e),n&&s.requestAnimationFrame(i)}new IntersectionObserver(function(e){const{intersectionRatio:t}=e[e.length-1];var r;n!=(r=t>0)&&(n=r,n&&s.requestAnimationFrame(i))}).observe(e)}(this._canvas,this._redraw)}_setNeedsRecalculate(){this._needsRecalculate=!0}_setValueChanged(e=!1){this._valueChanged=!0,this._valueChangedImmediate=e,this._needsRecalculate=!0}setPrefixSuffix(e,t){this._prefix=e,this._suffix=t,this._setNeedsRecalculate()}setFontSize(e){this._textarea.style.fontSize=e,this._setNeedsRecalculate()}setLineFlairs(e){this._lineFlairs=e}setSize(e,t){void 0!==t&&(this._minHeight=t),void 0!==e&&(this._width=e,this._canvas.style.width=`${e}px`,this._toplevel.style.width=`${e}px`,this._cols=this._xyToRowCol(e,0).col,this._textarea.style.width=`${this._cols}ch`),void 0===e&&void 0===t||this._setNeedsRecalculate()}getValue(){return this._textarea.value}setValue(e){this._textarea.value=e,this._setValueChanged(!0)}getFullText(){return this._prefix+this._textarea.value+this._suffix}_isLineLocked(e){return e.lineno<this._prefixLines||e.lineno>=this._suffixLines}_recalculate(){if(!this._needsRecalculate)return;if(!this._toplevel.parentNode)return;const e=this.getFullText()+"\n",t=[];let s=0,n=0,i=0;for(;;){let r=e.indexOf("\n",s);if(r<0)break;const a=s,o=r+1,l=o-a-1,h=n,c=Math.max(Math.ceil(l/this._cols),1);t.push({start:a,end:o,length:l,rows:c,startRow:h,lineno:i}),n+=c,i++,s=o}this._lineModel=t,this._prefixLines=this._prefix.split("\n").length-1,this._suffixLines=this._lineModel.length-(this._suffix.split("\n").length-1);const r=[],a=[];let o;const l=/\b(function|for|while|if|else|break|continue|in|out|attribute|uniform|varying|return|struct|layout|precision|mediump|lowp|highp|discard)\b/g;for(;null!==(o=l.exec(e));)r.push({start:o.index,end:o.index+o[0].length,color:"#c26230"});const h=/\b(void|bool|float|[ui]?vec[234]|mat[234]|mat[234]x[234]|[u]?int|sampler[23]D)\b/g;for(;null!==(o=h.exec(e));)r.push({start:o.index,end:o.index+o[0].length,color:"#6d9cbe"});const c=/\/\/.*$/gm;for(;null!==(o=c.exec(e));)r.push({start:o.index,end:o.index+o[0].length,color:"#bc9458",style:"italic"});const u=/\W-?\d+(\.\d+)?\b/g;for(;null!==(o=u.exec(e));){const e=o.index+1,t=e+o[0].length-1;r.some(s=>e>=s.start&&t<=s.end)||(a.push({start:e,end:t}),r.push({start:e,end:t,color:"#a5c261"}))}r.sort((e,t)=>e.start-t.start),this._syntaxRuns=r,this._draggableNumbers=a;const d=this._document.defaultView.getComputedStyle(this._textarea);this._textareaStyle=d;const m=this._canvas.getContext("2d");m.font=`${d.fontSize} ${d.fontFamily}`,this._charWidth=m.measureText(" ").width;const p=d.lineHeight;let f;if(f="normal"===p?1.15*parseFloat(d.fontSize):parseFloat(p),this._rowHeight=Math.ceil(f),void 0===this._charMarginTop){const e=4;this._charMarginTop=e-function(e,t,s,n){const i=e.createElement("canvas");i.width=t,i.height=s;const r=i.getContext("2d");r.font=n,r.textBaseline="top",r.fillStyle="black",r.fillText("l",0,0);const a=r.getImageData(0,0,t,s);for(let e=0;e<a.height;e++)for(let t=0;t<a.width;t++)if(a.data[4*(e*a.width+t)+3])return e;throw new Error("wtf")}(this._document,this._charWidth,this._rowHeight,m.font)}const g=(""+this._lineModel.length).length;this._gutterMargin=10,this._gutterWidth=this._charWidth*Math.max(g,2)+2*this._gutterMargin,this._textMargin=10;const T=this._lineModel[this._lineModel.length-1],x=T.startRow+T.rows-1,v=Math.ceil(Math.max(this._minHeight,this._rowHeight*(x+this._paddingTop+this._paddingBottom)));v!==this._height&&(this._height=v,this._canvas.style.height=`${this._height}px`,this._toplevel.style.height=`${this._height}px`,this._textarea.style.height=this._height-this._rowHeight+"px"),this._needsRecalculate=!1,this._recalculateMouseIdx(),this._valueChanged&&this.onvaluechanged&&this.onvaluechanged(this._valueChangedImmediate),this._valueChanged=!1,this._valueChangedImmediate=!1}_recalculateMouseIdx(){if(void 0===this._mouseX||void 0===this._mouseY)this._mouseIdx=void 0;else{const{row:e,col:t}=this._xyToRowCol(this._mouseX,this._mouseY),{line:s,idx:n}=this._rowColToLineIdx(e,t,!1),i=this._isLineLocked(s);this._mouseIdx=i?void 0:n}}_calculateIndentedLineStart(e){const t=this.getFullText();let s=e.start;for(;" "===t.charAt(s)&&s<=e.end;)s++;return s}_syncNumberDraggerPosition(){const{end:e}=this._draggingNumber,t=this._getCharPos(this._textareaToIdx(e)),{x:s,y:n}=this._rowColToXY(t.row,t.col),i=this._toplevel.getBoundingClientRect(),r=i.left+s,a=i.top+n+this._rowHeight/2+this._document.defaultView.scrollY;this._numberDragger.setPosition(r,a)}_spliceValue(e,t,s){const n=this.getValue();return n.slice(0,e)+s+n.slice(t)}_findDraggableNumber(e){return this._recalculate(),this._draggableNumbers.find(({start:t,end:s})=>e>=t&&e<=s)}_idxToTextarea(e){return e-this._prefix.length}_textareaToIdx(e){return e+this._prefix.length}_rowColToLineIdx(e,t,s){this._recalculate();let n,i,r=this._lineModel[0];for(r of this._lineModel)if(e>=r.startRow&&e<r.startRow+r.rows)break;return n=1===r.rows?t:(e-r.startRow)*this._cols+t,i=s?r.start+Math.min(Math.max(n,0),r.length):n>r.length?-1:r.start+n,{line:r,idx:i}}_xyToRowCol(e,t){this._recalculate(),t-=this._paddingTop*this._rowHeight;const s=Math.floor(t/this._rowHeight);let n;return e<this._gutterWidth&&(n=-1),e-=this._gutterWidth,void 0===n&&e<this._textMargin&&(n=0),e-=this._textMargin,void 0===n&&(n=Math.round(e/this._charWidth)),{row:s,col:n}}_rowColToXY(e,t){return{x:this._gutterWidth+this._textMargin+t*this._charWidth,y:(this._paddingTop+e)*this._rowHeight}}_getRowLength(e){this._recalculate();let t=this._lineModel[0];for(t of this._lineModel)if(e>=t.startRow&&e<t.startRow+t.rows)break;return 1===t.rows?t.length:e===t.startRow+t.rows-1?t.length%this._cols:this._cols}_getCharPos(e){this._recalculate();let t=this._lineModel[0];for(t of this._lineModel)if(e>=t.start&&e<t.end)break;const s=e-t.start;if(1===t.rows)return{line:t,lineIdx:s,row:t.startRow,col:s};const n=s%this._cols;return{line:t,lineIdx:s,row:t.startRow+Math.min(s/this._cols|0,t.rows),col:n}}_hasSelection(){return this._textarea.selectionStart!==this._textarea.selectionEnd}_getSelection(){const e=this._textareaToIdx(this._textarea.selectionStart),t=this._textareaToIdx(this._textarea.selectionEnd);return"forward"===this._textarea.selectionDirection?[e,t]:[t,e]}_getCursorIdx(){const[e,t]=this._getSelection();return t}_setSelection(e,t){const s=Math.min(e,t),n=Math.max(e,t),i=e<t?"forward":"backward";this._textarea.setSelectionRange(s,n,i)}_setCursor(e){this._textarea.setSelectionRange(e,e)}_insertAtCursor(e){if(this._textarea.focus(),!this._document.execCommand("insertText",!1,e)){const t=this._textarea.value,s=this._textarea.selectionStart,n=this._textarea.selectionEnd;this._textarea.value=t.slice(0,s)+e+t.slice(n),this._textarea.focus()}this._setValueChanged()}}var h=s(5974),c=s(2898);class u{constructor(){this.name="(unnamed)",this.preprocessedVert="",this.preprocessedFrag="",this.both="",this.vert="",this.frag="",this.defines=new Map,this._gfxDevice=null,this._gfxProgram=null}definesChanged(){this.preprocessedVert="",this.preprocessedFrag=""}setDefineString(e,t){if(null!==t){if(this.defines.get(e)===t)return!1;this.defines.set(e,t)}else{if(!this.defines.has(e))return!1;this.defines.delete(e)}return this.definesChanged(),!0}setDefineBool(e,t){return this.setDefineString(e,t?"1":null)}getDefineString(e){return(0,h.g_)(this.defines.get(e))}getDefineBool(e){const t=this.getDefineString(e);return null!==t&&(0,h.vA)("1"===t),null!==t}ensurePreprocessed(e){""===this.preprocessedVert&&(this.preprocessedVert=(0,c.hv)(e,"vert",this.both+this.vert,this.defines),this.preprocessedFrag=(0,c.hv)(e,"frag",this.both+this.frag,this.defines))}associate(e,t){this._gfxDevice=e,this._gfxProgram=t}_editShader(e){const t=(0,h.Z1)(window.open("about:blank",void 0,"location=off, resizable, alwaysRaised, left=20, top=20, width=1200, height=900")),s=()=>{const s=new l(t.document),n=t.document,i="vert"===e?`${this.name} - Vertex Shader`:`${this.name} - Fragment Shader`;n.title=i,n.body.style.margin="0";const r=this[e];s.setValue(r),s.setFontSize("16px");let a=0;const o=()=>{a=0,this[e]=s.getValue(),null!==this._gfxDevice&&null!==this._gfxProgram&&(this.preprocessedVert="",this.ensurePreprocessed(this._gfxDevice.queryVendorInfo()),this._gfxDevice.programPatched(this._gfxProgram,this))};s.onvaluechanged=function(e){a>0&&clearTimeout(a),e?o():a=window.setTimeout(o,500)},(t.onresize=()=>{s.setSize(n.body.offsetWidth,window.innerHeight)})(),t.editor=s,window.editor=s,t.document.body.appendChild(s.elem)};"complete"===t.document.readyState?s():t.onload=s}editb(){this._editShader("both")}editv(){this._editShader("vert")}editf(){this._editShader("frag")}}},5098(e,t,s){"use strict";s.d(t,{_h:()=>a,y7:()=>i});const n=JSON.parse('{"SaveState_sfa/ancient0/1":"ShareData=ACZR^9z*_/UU;3c9WR5G=E64-RDe]AUrHWfT}1lG=FUz|UF09;UHvu&9sT@x+^","SaveState_sfa/ancient1/1":"ShareData=ARt^DT8x0;9e|naUvo:RWDi_v6F*5EUmhRhUQ$tN=M[+29q2n&8v/PXT3)j[=a","SaveState_sfa/ancient10/1":"ShareData=AFgf|Ujy0V8~[|BUL+kEV8WMW6jF_[Uo]{5T*]nHWYF]x9Liz/9Y-7fUuoO1+^","SaveState_sfa/ancient11/1":"ShareData=AY/0h9GkpH9Q{TgUuA!+V2RKKRB4NCUfy+oUIbA/V$tB_9ve*0T_J?!9Xdgd+^","SaveState_sfa/ancient12/1":"ShareData=AW]JS9cp^b9M}&*UYABwWB;q&QW9QoUi:nZUS5Q}=I-k~94I+jT4,wN9G7?L=a","SaveState_sfa/ancient13/1":"ShareData=AXCjJ9iguq8)cAFUF(s~V8lIN54nu[UmuE8T?Y~K=xi9i9L6$5T3DXI90Ic*+^","SaveState_sfa/ancient14/1":"ShareData=AXfg_9zb+Y9T?RVUi8HDWUF{gQ,J}WUhh-9UNnMsWBla(9sty!T[k-C9k&Qa=a","SaveState_sfa/ancient14/2":"ShareData=ALilYUl2|T9Fg9VUo@b=+:mS(Q*mI-Ugj+gT[$bFWD[k$9s]Ed8)nIrUo&Gj=a","SaveState_sfa/ancient15/1":"ShareData=ABXDpUgPWrT~v?m97|cY=A7d^QUq0&UYaURT?aNYV:6CVUpA}_8-PGjUf!:=+^","SaveState_sfa/ancient15/2":"ShareData=AB@[d9wde,T&w1M9YpwX+ncy6RC5AxUp|RbT|4RCVw/J7UOr@GT&vf89z(Kk=a","SaveState_sfa/ancient2/1":"ShareData=ACVwV9fghv9X~E]Um92-WAeD,5{Qo+UeG2&UC)K6=DWb:97a1MT1(kE9VizR=a","SaveState_sfa/ancient3/1":"ShareData=AM?J29ZT]MT!Q9Y9urSO=Nvo(5$r!=Ud;zYT]xi[=Gk6ZUXcAqTa*[w9F1:p=a","SaveState_sfa/ancient4/1":"ShareData=AU(qLUM*Ps8]M|YUb0YvWD43X5e,T&Uq/RPUP32?+^39;9s^yp8-fq[UPI30+^","SaveState_sfa/ancient5/1":"ShareData=AT=y[UAx:$UBSCF9kcvI=0F}bQ+oAcUZ)*vUQ1&FV@7cBUVM0a9D3G]US)50=a","SaveState_sfa/ancient6/1":"ShareData=ACnT692Wqf9Wo|$UafcBV0n|C5929}Ui$taT{x1LVXr,F90Dj/T;_],96^Sh+^","SaveState_sfa/ancient7/1":"ShareData=AWzgK9jF3@T=A]19em^N=m~v~Qr$pWUoMJ!T=1;IV&b{zUTl~oT/0&$90*K7=a","SaveState_sfa/ancient8/1":"ShareData=AGjx)9N3OX9W8uxUb(PAWfsfnRR?q7UvzH;T};P==J+sU9prbOT3d6j9gDh3=a","SaveState_sfa/ancient9/1":"ShareData=AUM-PUdH7+TuIl]8&=4)+:$sKQpk6tUdd9ST)}xCWdujsT!gdi9P|d$UWLVd+^","SaveState_sfa/loc10/1":"ShareData=AUt=e9EtICUU4K}94Khd=Evl2Q^|GoUkP5kUKja*+=*WwUoJ_zTrGq}8^a~Q=a","SaveState_sfa/loc11/1":"ShareData=ASNFY9uRYw8{LGpUk4_fWVT-25}]m!Ul{YFUF}]v+vW_59q1wwT9Lb?9kn+==2","SaveState_sfa/loc11/2":"ShareData=AH8BhUZLG/9I_~CUMa6GWJPMW5zx;zUW$F$Ue5y7WETzF97~Xh9MV^&UdgUx=a","SaveState_sfa/loc11/3":"ShareData=AG{(]UN]M[UP|2~95@jA=uedM5{{YRUiV}-T}]IeWBCa1UwaII8@j=MUJV+J=a","SaveState_sfa/loc11/4":"ShareData=ASoycUj0JWT]_C,93D*R+5ruj6CBfDUm1HTUQmK^V}!nKUlGE(9I:OeUpT4E=a","SaveState_sfa/loc12/1":"ShareData=AN@:oUT!F&9Z/QoUbK]B=L;LT5=YKWUX,KEUJ5qwWJj=i93*UM8(1uhT}9O5=a","SaveState_sfa/loc12/2":"ShareData=ANBAq95K8qT=u,i9PH7F=h{XSQ@LTpUqh(LT{EtHWLD;dUU$aIT;bJ^93zuU=a","SaveState_sfa/loc12/3":"ShareData=AQbmXURc*F9f=B0Uh|;*WGsE25(8u4UchrLUK/3iWjm$n9lgs{8?Q&tUNWBT=a","SaveState_sfa/loc13/1":"ShareData=AL-kcUfJqL8sHOzT;(_7V0R(G6ZLgoUh*YoUI-T+=J(6f9E8zk9LS{2Us2&Y+^","SaveState_sfa/loc13/2":"ShareData=ASE=GUsC5@8r4|(T5akkVwj306ihf~UdQv6UDA(D=NpF-8&Z7l9Tsg$UlnrF+^","SaveState_sfa/loc14/1":"ShareData=AER],URHbdUHcmx9h)3*=M[FmQG4BPUaxf1UQ^U|=V!FCUqF=O8;adcUM0jG=a","SaveState_sfa/loc14/2":"ShareData=AZjNr9zih}T[/BO9Ztq8=Ui:N5=drGUjr,9T-K;^=W?kVUK}i-T6cHG96[NJ=a","SaveState_sfa/loc16/1":"ShareData=ARV1sUF}(c8,7vnUXf@FVtZ^76LQH}Uq_i:T!x5@V&rVi9oPR*8vD:~T}WL3+^","SaveState_sfa/loc18/1":"ShareData=AA5sC90Q,(8vy[N9v7)A=SUR2Q(iB}UYrv]8our~=Jl=KUa^ga8q(f[90j;5=a","SaveState_sfa/loc18/2":"ShareData=Aa]EeUEW8T9d4R_Ufa]xV!FGK5*&;~Uf/6hUO2]K+/k_n90)@$8:oA^UHWuo=a","SaveState_sfa/loc18/3":"ShareData=AC{-D9a/D-UD,z99s!i/=L!jT6D[;AUqb9cUL2iC++xrIUo&XgTg|y$9b+/]=a","SaveState_sfa/loc19/1":"ShareData=AK0*N970Dp84qa&UMU7vWnW9j5DkA!Up7BcT~eRv=UPb89ThP6T,Q*W9xUmc=a","SaveState_sfa/loc19/2":"ShareData=ANUY=Te-F!UN8}J9yB0v=gAy{ROtFXUr/g;UIsl(=E)?SUkLyn8dA0YTt+6&=a","SaveState_sfa/loc2/1":"ShareData=AL9i~9Uw;6ULTn~93MDf=Mxq,578GaUkOa!UNHG3=E!r9UhG}jT,v4E9ZC*!=a","SaveState_sfa/loc21/1":"ShareData=ALJw2UXS0w8]aAwUvrd@VcPsZQ@=U-UW4}kUEPM?=kU_g9v/*O8=0R$UoAvC+5","SaveState_sfa/loc21/2":"ShareData=AR*5FUh+*?822nuT[}$eWH{obRArw6UwfRET,Iks=wgQz9E*Pn8}nKWUsS&!+^","SaveState_sfa/loc23/1":"ShareData=AOYuLT*|s]8!grgUd2VX+=R[zRZ@PkUX(DfT!16qWT0MW9wZ3{8v+46UPH8E=a","SaveState_sfa/loc23/2":"ShareData=ANbS?UhmY[UC,aR9mwW4=Kh7:5!yl0UXfKnUO]sSWTHFTUlc{X9PBYGUsyPB=a","SaveState_sfa/loc26/1":"ShareData=APS+fUCF@59Jc4SUcJ-|WZvIWQ(4?iUm8z{UT|_oV;[F@9o;/o8,o,rUAPv/=a","SaveState_sfa/loc27/1":"ShareData=ATTf19tVA*T2jDk9zmB}=E?CE5=sL$UaVOAUG3b]+^+W^UcV*bUU1=+9xF&p=a","SaveState_sfa/loc27/2":"ShareData=AFQX^9xSP:T@~S,9zI8DV}{F(5?*9[Uj:g-T)@=2=TRQBUjLPIT:Wwn92Mi{=a","SaveState_sfa/loc28/1":"ShareData=AVt|xUgMtgT21)J9nlW_=OPO_5UgQiUoy69T&1qE=hCmHUf6Rf9A+n[UWaZ*+^","SaveState_sfa/loc29/1":"ShareData=AJW3!9fjP&8^=~5UvC3GWg0|/5R{xJUs-D1T)fWp=AFyl96c(*T9zgx9Vm/8=a","SaveState_sfa/loc31/1":"ShareData=AO$:nUl|&v8;BKjUrv}bWJJG-Q29@@Ui)yoT6(d&V?P)$9i_]m9D__~Ucgh-=a","SaveState_sfa/loc31/2":"ShareData=AHRX*9sz298}VnrUtv4=Vw!SGQ65JPUklb)T687PVn3/V9hfy7T~xM&9w6Ge+^","SaveState_sfa/loc32/1":"ShareData=AA*6h9g}BzTi8D+91+f~VvD2i6K37&UcUN)Tbrw}VVWfPUk[ERTkqEO9uAHr=a","SaveState_sfa/loc32/2":"ShareData=AUdS:9kq?s9D;^2UZDk-V;xx95&V!4Ug&b$T6&{gVeDh[9wk^YT71E}9mCg4+^","SaveState_sfa/loc33/1":"ShareData=APu~k9wK=jT7l=(9uwQ=WEyP|5|qO8Upo/uURLhgVxAlQUchUZT58s$94IHT=a","SaveState_sfa/loc33/2":"ShareData=AMpVA9v0lE8*!qBUZakWV?huh5}8*=Uq;!PT5R}DVpav^9oFz^T&qKe9pF0g+^","SaveState_sfa/loc34/1":"ShareData=AaghVUmK6XT@@ze9jcT)Vyt035yV^6UW|=;T-tB0Vj(v[UZziE8~xX}UV9x0=a","SaveState_sfa/loc34/2":"ShareData=APU~69k(elTYk,A9Uog&WBxwM54~p_Uq3z5UNjEgV:x_,UU30+UG^cV9pzK;=a","SaveState_sfa/loc39/1":"ShareData=AHog6Ul@!kT6B2v9nLKg=JPM853xq)UnS,JT2n,NVV[GwUi}Pe8-=:5Uk5S?=a","SaveState_sfa/loc39/2":"ShareData=AL8_Y9pH[Q9CyYOUr/?IV:+$UQ)&=7UnecMT]LO4VwErR9rw^gT5$:k9yud*+^","SaveState_sfa/loc4/1":"ShareData=ABSQ89P28:UCBB39r7;$=Ix-:6FI!QUte5zULT3hV=Id3UbV1uT91qb9WrxZ=a","SaveState_sfa/loc4/2":"ShareData=ARg^j9F/p$9Z4@DUf_i3WKT!75^/+gUjcU@T}_9PVbA_!9m&G)T3sVM9J^=v=a","SaveState_sfa/loc4/3":"ShareData=AKY7892tZc9AImoUKh1mWMJQF6Az^hUn(MET*QV4V1ITS9b*/EUFn-E9yDoB=a","SaveState_sfa/loc4/4":"ShareData=AJf~/T_sigT!wz(9r&y4=E;K!Q~gciUr9ZCT/P/rV1t7&UYO6M8gepET,b@6=a","SaveState_sfa/loc40/1":"ShareData=AS[gW9YV(i9Iqx,Ucpn,WN}+35$|M-Utk4GT^[J:Vv2fg9xinBT9^(v9c8ti+^","SaveState_sfa/loc43/1":"ShareData=AKlrt9b4619JY)[UX2g;Wl3*&Q?o*5Ub?3$UN^GqV}Zra94oyhT$ln_9d(&&=a","SaveState_sfa/loc43/2":"ShareData=AQ~GuUgTj18/jO@UX0!++!~ZtQ|{]{UhzJ-T~tT^V!CQ*9rCQV8|b8VUc3HG=a","SaveState_sfa/loc44/1":"ShareData=AaHliUY+1|8)|e;UYHt:WUI{0Q@&srUd?/zT3f;UV;Ief9j62W8?]i]Uc6pT=2","SaveState_sfa/loc44/2":"ShareData=AEYAVUvpe&8_nj(Ue+eOWH-abQ,6ukUoafAT3@Wf=FM$u94^|)8[mQ2Uj4/+=2","SaveState_sfa/loc45/1":"ShareData=AY${09c5pCT{*T19sg~c=D?LNRBZ=)UjS{!T^mUsVA~?GUtp6)T,ab69JDk*+^","SaveState_sfa/loc48/1":"ShareData=AS-}V9uXLJ9B}_+Uf06,WEgg6Q54J0UoM:NT9vL2Ve]H{93MCsT~D0~9oC/Z+^","SaveState_sfa/loc48/2":"ShareData=APyBHUHnzk9H1VJUs]gbWNr54Q15jMUZwihULe^wVadNc9unB78|ZlxUEfNi+^","SaveState_sfa/loc50/1":"ShareData=AMDj09aqc+8}d@GUk+m|V(jVd5yz0tUp$WoTz4X8=VXcJ9qi_aTmY{M9IPq_=a","SaveState_sfa/loc50/2":"ShareData=AXms=9NjD]9Nbb+Ufn^1WM$ZS54|RZUjKI2UJDR2=Ab4]972mRT]6,N9U64_+^","SaveState_sfa/loc51/1":"ShareData=AB(@197Dew8)++(UrIQ{V5rl86G;_dUjjUWT0P?z=F9E59rQatT0!Sd9zIQy+^","SaveState_sfa/loc54/1":"ShareData=ANoZ5Uug1GT/KKF9G2U$V8pHwQ6Ij|UdkoqUB19+V2(|UUVD,:9ftW_UWQV!+^","SaveState_sfa/loc54/2":"ShareData=ABip:UaJT^8(fNOT)ZSOVjv:z5?PeMUXj^+T|F39Vq$B}9anhS9C~=OUgzrI+d","SaveState_sfa/loc55/1":"ShareData=ASjF~Uff{3T4xbN9L;[C+0TVR6DJZ(Uqb9cT}4VJVnUv7UKBUT9b$h^UwL|c+5","SaveState_sfa/loc56/1":"ShareData=AR+Uz9jYgF8~6XDUBXrcV7;1Y5|q@{Um7,MUS9L[VY}m}9gf6ST{hd~90~^s+^","SaveState_sfa/loc58/1":"ShareData=AZbb|UhSV1T7XOa9MPZ4WUA7dQ)BPSUV5WdUR2I^WNlYxUQA_c9cDE^UVov*+^","SaveState_sfa/loc59/1":"ShareData=AW}JzUQSj2T}krJ92(ps=u?J359fFEUlWf:UDy7LV{[O5Ut(!d8/Eu^UIO-E+^","SaveState_sfa/loc60/1":"ShareData=AGs0qUJhtIT{UFm9n,X0+&3tz6GfO_UWSuOUH)XNV^;(YUb-*y8-J2VUHU4l=a","SaveState_sfa/loc61/1":"ShareData=AOHKTUE&_yT*OYS9j:dn=S,iX5iNCEUl63?UFfoEWIb&xUV![c8_BVHUSE[2=a","SaveState_sfa/loc62/1":"ShareData=ACrZ1UMpb&UC)zn91cbb=nDU*5+mt,Utw3BUSgsaV@j9)UfJNI8}CbZUK7Qw+^","SaveState_sfa/loc63/1":"ShareData=AC$aHUf|Vx8~GqQUBI=$VuFsGQoJ)qUhW7TT1/&TVaKg~9N)~r8[88BUg{f^=a","SaveState_sfa/loc65/1":"ShareData=AC43ZT^yeLT]7E_9u9]IV?cSX6CJc+UWjhhT+AB-VmX4GUv)ZO8m~7QUS61m=a","SaveState_sfa/loc67/1":"ShareData=AOo5991J@89P,&CUlq0sV9S;R5+bpNUYaoJUOlPo=ZE?t9zbJ(T0Y0j978mD+^","SaveState_sfa/loc68/1":"ShareData=AG:1]UlMcj8=o}RUlQW-=HFxfRBakTUhLLwT-kiM=QQ,q9ym*W9Dc,-UkS2b=a","SaveState_sfa/loc69/1":"ShareData=ANzel94cYFTnXtx8?5RWVwT,lQ*q~YUtC9LUO9(W=F~a|T@82!UGyzI9ow2w=a","SaveState_sfa/loc7/1":"ShareData=AN&W}T{Jj/T:ocM9tj5i=Z/kH6CJc+UmI-JT,JC2=M_P!Urwhl8rKuDURz~Z+^","SaveState_sfa/loc70/1":"ShareData=AKn/s9n]1|8]ee(UmqW2V6EBw586?MUV?s9T1=p{+9YEB9oD~BT-k8G9u$9Q=a","SaveState_sfa/loc71/1":"ShareData=AK&kWUWMdXT&Yy]9SG-W+tcT?5-:p[Ua:3&UN6|K=H]QQUAKA/9ceK}UW2)h+^","SaveState_sfa/loc72/1":"ShareData=AJ&v~UhOqjT$V|[9uz,C+8PR=5:}yxUbyAZUFZEG=LSb&Uk(fj8,T9/UV/kw+^","SaveState_sfa/loc72/2":"ShareData=AE-lz91KtY8:AMsT|_/sVtXK{6Gd$iUX$[@UNXQ-=V&i=9LClaUQ33/914oj=a","SaveState_sfa/loc73/1":"ShareData=AEWO=Ul-j089{jUTZO@zU)AlLRcB/:UrYm,T([J(=YkwJ82i429bz7]UXM^4+^","SaveState_sfa/loc74/1":"ShareData=AQO6K9R5;B9c9&4Ufk*3V&w7rQ![C!UldIBUQBIpV(*~H92SUxT?o-x9O~K$=a","SaveState_sfa/loc8/1":"ShareData=AL&C0T5@RyUCxR=9vgUs+?b]=RTjrRUaMH^UITPI=R94GUj+{T88LvZT-7qo+^","SaveState_sfa/loc8/2":"ShareData=AG0fSUX7So7{E[HTR+G]Vwzz}RTsxSUhh$:UP!,/=SWHr8ecUX9c0asUqt0c+^","SaveState_sfa/loc9/1":"ShareData=AB5CkTWNR$9O:3pUbHykWR3WZQ}gfVUaff=UP0kGV8H?$9vb3{7},tPTXJI[=a","Savestate_sfa/demo18/1":"ShareData=ACTYI9u3-,8t8*+9t}V1V7bw56LHaFUV~2T89IxK=AaU}UbD|y8t]CF95/$I=a","SaveState_sfa/demo2/1":"ShareData=AC/uy9N{o2T]Rp;9zV^V=jgC{Rau/vUp=[cT~K9o=GvOqUiTaWT=b6s9TCot=a","SaveState_sfa/demo23/1":"ShareData=AAfZr9pWr@T1M5pUGi@S=Z/eZ6Zg^5UuO*F9WjrrWRl1w9I&WB9F!y_96XQq=a","SaveState_sfa/demo21/1":"ShareData=AEX6J9fj&j9qLTdUQxsIWK6Gw6L@PzT)8UbUi3x+=iYSh90yN?T^{*V9AxYc=a","SaveState_sfa/demo27/1":"ShareData=AA]TaUDAJEUH:,-9zM~nV|~V1Q36)}UuWuPUB}sz=X^O9Unp?59C7WoUVEVo=a","SaveState_sfa/ancient0/4":"ShareData=AUh$t9r-JWUI4cZ9xs,H=I9c3RKJEaUl1ghT}1lG=ZKn_UjW3ZUURtp9sT@x+^","SaveState_sfa/demo50/1":"ShareData=AC-Px9gy[wUZ2}a9jk0u=CpJi560OCUthP4Ucc-|=Xs?,Uu$);T5X809HmY)+^","SaveState_sfa/ancient0/2":"ShareData=AQ0!O90;5nUI3cg9WR5G=IA^rRFxYZUc2b~UY*uH=I[YPUpsD@UHm3z9sT@x+^","SaveState_sfa/demo8/1":"ShareData=AaYvMUmh2!8/Q$7Uumn*WIH$}53-L;UsnHhT:$-p+^$4s9mzu*9FwQ,UmlkU+^","SaveState_sfa/demo10/1":"ShareData=AOkh7UJHtQ8-;i{UWtxU=O!-wQ}|zaUfd?tT_aJzVbyXz9yktO8o&x7UQy]$=a","SaveState_sfa/demo16/1":"ShareData=AP8J,Ur)_78~:dAT69Ku+vIo{Q2357UZrnSUH8,hV)+}:9AiXu9PgJ/UoQ$O+^","SaveState_sfa/demo30/1":"ShareData=AO^E-9o+Q78u?M(UV8NiV!|+KQ|Z,dUf3kaTm5^fVyzJE98OalTbpL^90E0O+^","SaveState_sfa/demo4/1":"ShareData=AUvb792OQM9Fx$?91p@R=b:h}Q6qQSUfI-{8;NslVuc_*UrT_l8_,|,9nw]|=a","SaveState_sfa/demo29/1":"ShareData=AbSWE9jj(59A6bCUXEL)V)6$I6N7w[Uii{bT/ekr=a~PX90$o0T:b=59j;F-=a","SaveState_sfa/ancient0/6":"ShareData=AUh$t9r-JWUI4cZ9xs,H=I9c3RKJEaUl1ghT}1lG=ZKn_UjW3ZUURtp9sT@x+^","SaveState_sfa/demo11/1":"ShareData=AUp@B9w5=C9DQ1UUdB//WVP~r6V;@+Uv4&nT_wcFVvzOo9j(D{T3M059p&FX=2","SaveState_sfa/demo28/1":"ShareData=AI[EVT6Nb/T;;]E9yEFe=ER?WRAm]KUfe1rT:(vP=1_3iUbrX!8zd+aT$pA:+^","SaveState_sfa/demo14/1":"ShareData=AN2KdUYeymThyg}9CBP?=RC*S5k*!IUm(vmT{arH=KiHRT1*bl9GrY1Uq_(f=a","SaveState_sfa/demo12/1":"ShareData=AHI9!9IYe[T^S/=9pU4;=zmSTQ{VafUkX(OT*j&[WBUgzUi+/9T=+H19do&,=a","SaveState_sfa/demo33/1":"ShareData=AapGQ90y3LTr3R{UiA;*V6--OQwh*WUnFhS8;HslVfg+59rjzo8+=HF9nc~b+^","SaveState_sfa/demo7/1":"ShareData=AG(h(ULC)*T(!]x9tQ(:=Xll?Q41CeUsJclUQ~[+=FqtBUs?:V898?@UIy9y+^","SaveState_sfa/demo40/1":"ShareData=AHB)&Ut{G8T]d2Q93?~,WkWW&Q4D{FUgPD;UTZf-V~n{yUYN+!8[|K]UnF$J=a","SaveState_sfa/ancient0/5":"ShareData=AUh$t9r-JWUI4cZ9xs,H=I9c3RKJEaUl1ghT}1lG=ZKn_UjW3ZUURtp9sT@x+^","SaveState_sfa/demo51/1":"ShareData=AHlx89yGxl9b:ngUk(DuVhRbA540;OUh2kqURqQ~VZ=389y)AzUP,@49448]+^","SaveState_sfa/demo43/1":"ShareData=ATZbK94)MsTdZ?f9yXkG=Ts*PRQ-1VUkDAwT7|$wV}_/ZUnSyiTm/]F9ooBU=a","SaveState_sfa/demo19/1":"ShareData=Aa5n}UVz-UT?*@W9x@5n+@;a_Q?/,yUghk)T{g3F=Z!5EUZ6sc8_e?dUaQs4=a","SaveState_sfa/demo64/1":"ShareData=AX$t!Ud-Z~9XCY(UGKp9VphWJQ]B,]UXz4-UfyOnViO-+9OjTL9i6$9Ua_S-+^","SaveState_sfa/ancient0/3":"ShareData=APLs$9kMJvT|34*9xs,H=S(0yRGF[eUZ^{RT}1lG=B8A}UcCk&UMcAI9sT@x+^","SaveState_sfa/demo48/1":"ShareData=ARce-UitUv8)iDKUb?809}!2*RJfZ1UkyViT[yYEVd00E9vb-q8;?L]UfXK@+^"}');var i,r=s.t(n,2);!function(e){e[e.LocalStorage=0]="LocalStorage",e[e.SessionStorage=1]="SessionStorage",e[e.Defaults=2]="Defaults",e[e.None=3]="None"}(i||(i={}));const a=new class{constructor(){this.settingListeners=[],this.cleanOldKeys()}cleanOldKeys(){window.localStorage.removeItem("CameraStates"),window.localStorage.removeItem("SaveStates");for(let e=window.localStorage.length-1;e>=0;e--){const t=window.localStorage.key(e);t.startsWith("SaveState_")&&t.endsWith("/0")&&window.localStorage.removeItem(t)}}getSettingKey(e){return`Setting_${e}`}loadSetting(e,t){const s=window.localStorage.getItem(this.getSettingKey(e));return null!==s?JSON.parse(s):t}saveSetting(e,t,s=!1){if(s||this.loadSetting(e,null)!==t){window.localStorage.setItem(this.getSettingKey(e),JSON.stringify(t));for(let t=0;t<this.settingListeners.length;t++)this.settingListeners[t].key===e&&this.settingListeners[t].callback(this,e)}}addSettingListener(e,t,s=!0){this.settingListeners.push({callback:t,key:e}),s&&t(this,e)}getSaveStateSlotKey(e,t){return`SaveState_${e}/${t}`}getCurrentSceneDescId(){return window.sessionStorage.getItem("CurrentSceneDescId")||null}setCurrentSceneDescId(e){window.sessionStorage.setItem("CurrentSceneDescId",e)}saveTemporaryState(e,t){window.localStorage.removeItem(e),window.sessionStorage.setItem(e,t)}saveState(e,t){window.localStorage.setItem(e,t)}deleteState(e){window.localStorage.removeItem(e)}hasStateInLocation(e,t){return t===i.LocalStorage?e in window.localStorage:t===i.SessionStorage?e in window.sessionStorage:t===i.Defaults&&e in r}loadStateFromLocation(e,t){return t===i.LocalStorage?window.localStorage.getItem(e):t===i.SessionStorage?window.sessionStorage.getItem(e):t===i.Defaults&&e in r&&r[e]||null}loadState(e){let t=null;return t=window.localStorage.getItem(e),t||(t=window.sessionStorage.getItem(e),t||(t=r[e],t||null))}export(){return JSON.stringify(Object.assign({},window.localStorage),null,4)}setUseWebGPU(e){e?this.saveSetting("PlatformBackend","WebGPU"):this.deleteState(this.getSettingKey("PlatformBackend")),window.location.reload()}}},6063(e,t,s){"use strict";s.d(t,{IQ:()=>g,Mb:()=>m,U2:()=>d,gY:()=>p,pD:()=>f,po:()=>x,xF:()=>T});var n=s(7684),i=s(2003),r=s(1659),a=s(8771),o=s(7459),l=s(5974);function h(e){return i.Ei.STAGE0+e}function c(e){return null!==e?i.zH.TEXMAP0+e:i.zH.TEXMAP_NULL}function u(e){return null!==e?i.gw.TEXCOORD0+e:i.gw.TEXCOORD_NULL}function d(e){return i.eV.PTTEXMTX0+3*e}function m(e){return i.fw._0+e}function p(e){return i.fw.S0+e}function f(e){return i.fw.T0+e}function g(e){return i.jl.KCSEL_K0+e}function T(e){return i.u_.KASEL_K0_A+e}class x{constructor(e=null){this.name=e,this.gxMaterial=void 0,this.gxMaterialHelper=void 0,this.reset()}reset(){this.mb=new r.I(this.name),this.tevStageNum=0,this.indTexStageNum=0,this.texCoordNum=0,this.texMaps=[],this.texMtxs=[],this.ambColors=[],this.matColors=[],this.postTexMtxs=[],this.indTexMtxs=[],this.konstColors=[],this.tevRegColors=[],this.texCoordUsesMtxIndex=void 0,this.gxMaterial=void 0,this.gxMaterialHelper=void 0}genTevStage(){const e=this.tevStageNum;if(e>=16)throw Error("Too many TEV stages");return this.tevStageNum++,e}getTevStageCount(){return this.tevStageNum}genIndTexStage(){const e=this.indTexStageNum;if(e>=4)throw Error("Too many indirect texture stages");return this.indTexStageNum++,e}getIndTexStageCount(){return this.indTexStageNum}genTexMap(e){const t=this.texMaps.length;if(t>=8)throw Error("Too many texture maps");return this.texMaps.push(e),t}getTexMapCount(){return this.texMaps.length}genTexCoord(e,t,s=i.b1.IDENTITY,n=!1,r=i.eV.PTIDENTITY){const a=this.texCoordNum;if(a>=8)throw Error("Too many texture coordinates");return this.texCoordNum++,this.mb.setTexCoordGen(u(a),e,t,s,n,r),a}getTexCoordCount(){return this.texCoordNum}genPostTexMtx(e){const t=this.postTexMtxs.length;if(t>=20)throw Error("Too many post-transform texture matrices");return this.postTexMtxs.push(e),t}genIndTexMtx(e){const t=this.indTexMtxs.length;if(t>=3)throw Error("Too many indirect texture matrices");return this.indTexMtxs.push(e),t}genKonstColor(e){const t=this.konstColors.length;if(t>=4)throw Error("Too many konst colors");return this.konstColors.push(e),t}getKonstColorCount(){return this.konstColors.length}setTevDirect(e){this.mb.setTevDirect(e)}setTevOrder(e,t=null,s=null,n=i.Ug.COLOR_ZERO){this.mb.setTevOrder(e,u(t),c(s),n)}setTevColorFormula(e,t,s,n,r,a=i.fQ.ADD,o=i.bt.ZERO,l=i.mX.SCALE_1,h=!0,c=i.UZ.PREV){this.mb.setTevColorIn(e,t,s,n,r),this.mb.setTevColorOp(e,a,o,l,h,c)}setTevAlphaFormula(e,t,s,n,r,a=i.fQ.ADD,o=i.bt.ZERO,l=i.mX.SCALE_1,h=!0,c=i.UZ.PREV){this.mb.setTevAlphaIn(e,t,s,n,r),this.mb.setTevAlphaOp(e,a,o,l,h,c)}setTevSwapMode(e,t,s){this.mb.setTevSwapMode(e,t,s)}setTevIndirect(e,t,s,n,i,r,a,o,l,c){this.mb.setTevIndirect(e,h(t),s,n,i,r,a,o,l,c)}setIndTexOrder(e,t=null,s=null){this.mb.setIndTexOrder(h(e),u(t),c(s))}setIndTexScale(e,t,s){this.mb.setIndTexScale(h(e),t,s)}setTevKColorSel(e,t){this.mb.setTevKColorSel(e,t)}setTevKAlphaSel(e,t){this.mb.setTevKAlphaSel(e,t)}setUsePnMtxIdx(e){this.mb.setUsePnMtxIdx(e)}setChanCtrl(e,t,s,n,i,r,a){this.mb.setChanCtrl(e,t,s,n,i,r,a)}setCullMode(e){this.mb.setCullMode(e)}setBlendMode(e,t,s,n=i.Sn.CLEAR){this.mb.setBlendMode(e,t,s,n)}setZMode(e,t,s){this.mb.setZMode(e,t,s)}setAlphaCompare(e,t,s,n,i){this.mb.setAlphaCompare(e,t,s,n,i)}setTexMtx(e,t){this.texMtxs[e]=t}setAmbColor(e,t){this.ambColors[e]=t}setMatColor(e,t){this.matColors[e]=t}setTevRegColor(e,t){this.tevRegColors[e]=t}rebuildGXMaterial(){this.gxMaterial=this.mb.finish(this.name),void 0!==this.texCoordUsesMtxIndex&&(this.gxMaterial.useTexMtxIdx=(0,l.y5)(8,e=>this.texCoordUsesMtxIndex[e])),this.gxMaterialHelper=new a.kg(this.gxMaterial)}setTexCoordUsesMtxIdx(e,t){void 0===this.texCoordUsesMtxIndex&&(this.texCoordUsesMtxIndex=(0,l.y5)(8,()=>!1)),this.texCoordUsesMtxIndex[e]=t}setOnMaterialParams(e,t){void 0===this.gxMaterial&&this.rebuildGXMaterial();for(let s=0;s<8;s++){const n=this.texMaps[s];e.m_TextureMapping[s].reset(),void 0!==n&&n(e.m_TextureMapping[s],t)}for(let s=0;s<this.texMtxs.length;s++){const i=this.texMtxs[s];void 0!==i?i(e.u_TexMtx[s],t):n.D_(e.u_TexMtx[s])}for(let s=0;s<this.indTexMtxs.length;s++){const i=this.indTexMtxs[s];void 0!==i?i(e.u_IndTexMtx[s],t):n.D_(e.u_IndTexMtx[s])}for(let s=0;s<this.postTexMtxs.length;s++){const i=this.postTexMtxs[s];void 0!==i?i(e.u_PostTexMtx[s],t):n.D_(e.u_PostTexMtx[s])}for(let s=0;s<2;s++){const n=this.ambColors[s];void 0!==n?n(e.u_Color[a.k2.AMB0+s],t):(0,o.z5)(e.u_Color[a.k2.AMB0+s],o.c)}for(let s=0;s<2;s++){const n=this.matColors[s];void 0!==n?n(e.u_Color[a.k2.MAT0+s],t):(0,o.z5)(e.u_Color[a.k2.MAT0+s],o.c)}for(let s=0;s<4;s++){const n=this.konstColors[s];void 0!==n?n(e.u_Color[a.k2.K0+s],t):(0,o.z5)(e.u_Color[a.k2.K0+s],o.c)}for(let s=0;s<3;s++){const n=this.tevRegColors[s];void 0!==n?n(e.u_Color[a.k2.C0+s],t):(0,o.z5)(e.u_Color[a.k2.C0+s],o.gh)}}getGXMaterialHelper(){return void 0===this.gxMaterialHelper&&this.rebuildGXMaterial(),this.gxMaterialHelper}}},5730(e,t,s){"use strict";s.d(t,{Fc:()=>f,Ts:()=>p,o:()=>x,zY:()=>d});var n=s(329),i=s(7459),r=s(9450),a=s(5974),o=s(5339);const l=n.vt(),h=n.vt(),c=n.vt(),u=new r.F5;var d;!function(e){e[e.NONE=0]="NONE",e[e.POINT=2]="POINT",e[e.DIRECTIONAL=4]="DIRECTIONAL",e[e.PROJECTED=8]="PROJECTED"}(d||(d={}));class m{constructor(){this.type=0,this.position=n.vt(),this.direction=n.vt(),this.refDistance=0,this.radius=0,this.color=(0,i.Zv)(i.c),this.distAtten=n.vt(),this.affectsMap=!1,this.probedInfluence=0}getPosition(e){void 0!==this.obj?(0,o.Ye)(e,this.obj.getSRTForChildren(),this.position):n.C(e,this.position)}setPosition(e){n.C(this.position,e)}setDistanceAndRadius(e,t){this.refDistance=e,this.radius=t;n.hZ(this.distAtten,1,.125/(.75*e),.125/(.75*e*e))}}function p(e,t,s,n){const r=new m;return r.type=d.POINT,r.setPosition(e),(0,i.z5)(r.color,t),r.setDistanceAndRadius(s,n),r}function f(e,t){const s=new m;return s.type=d.DIRECTIONAL,n.C(s.direction,e),n.S8(s.direction,s.direction),s.refDistance=1e6,s.radius=1e6,(0,i.z5)(s.color,t),s}function g(e,t){const s=l,i=h,r=c;t.getPosition(s),e.getPosition(r),n.jb(i,s,r);let a=n.Bw(i);if(a-=t.cullRadius*t.scale,a>1e3||a>e.radius)return 0;let o=1;return a>=e.refDistance&&(o=1-(a-e.refDistance)/(e.radius-e.refDistance)),o}function T(e,t){const s=(0,o.qE)(e*t.r,0,1),n=(0,o.qE)(e*t.g,0,1),i=(0,o.qE)(e*t.b,0,1);return Math.max(s,n,i)}class x{constructor(){this.lights=new Set}addLight(e){this.lights.add(e)}removeLight(e){this.lights.delete(e)}probeLightsOnObject(e,t,s,n){const i=[];for(let t of this.lights)if(t.type&s){if(t.type==d.DIRECTIONAL)t.probedInfluence=1e3;else if(t.probedInfluence=g(t,e),t.probedInfluence=T(t.probedInfluence,t.color),t.probedInfluence<=0)continue;(0,a.lL)(i,t,(e,t)=>t.probedInfluence-e.probedInfluence),i.length>=n&&i.pop()}return i}probeLightsOnMapBox(e,t,s){const i=l,o=h,c=u;e.centerPoint(i);const d=[];for(let l of this.lights){if(!(l.type&t))continue;if(!l.affectsMap)continue;if(l.radius<=0)continue;if(l.getPosition(o),c.set(o[0]-l.radius,o[1]-l.radius,o[2]-l.radius,o[0]+l.radius,o[1]+l.radius,o[2]+l.radius),!r.F5.intersect(c,e))continue;const h=n.xg(o,i);l.probedInfluence=1/(l.distAtten[0]+l.distAtten[1]*h+l.distAtten[2]*h*h),l.probedInfluence=T(l.probedInfluence,l.color),l.probedInfluence<=0||((0,a.lL)(d,l,(e,t)=>t.probedInfluence-e.probedInfluence),d.length>=s&&d.pop())}return d}}},6223(e,t,s){"use strict";s.d(t,{E0:()=>x,K4:()=>C,y5:()=>v,X0:()=>h,hF:()=>T});var n=s(7684),i=s(5339);class r{constructor(e=30){this.fps=e,this.timeInFrames=0,this.phaseFrames=0}getTimeInFrames(){return this.timeInFrames+this.phaseFrames}getTimeInSeconds(){return this.getTimeInFrames()/this.fps}setTimeInMilliseconds(e){this.setTimeInFrames(a(e,this.fps))}setTimeInFrames(e){this.timeInFrames=e}setTimeFromViewerInput(e){this.setTimeInMilliseconds(e.time)}quantizeTimeToFPS(){this.timeInFrames=0|this.timeInFrames}setPhaseInMilliseconds(e){this.phaseFrames=a(e,this.fps)}setPhaseToCurrent(){this.phaseFrames=-this.timeInFrames}}function a(e,t){return e*(t/1e3)}var o=s(5974),l=s(2007);class h{constructor(){this.animController=new r(60),this.envAnimValue0=0,this.envAnimValue1=0,this.enableFineSkinAnims=!0}update(e){this.animController.setTimeFromViewerInput(e),this.envAnimValue0=.0084*this.animController.getTimeInFrames()%256,this.envAnimValue1=.003*this.animController.getTimeInFrames()%256}}function c(){return{axes:(0,o.y5)(3,()=>({translation:0,rotation:0,scale:1}))}}function u(e){return{poses:(0,o.y5)(e,()=>c())}}class d{constructor(){}static async create(e,t){const s=new d,[n,i]=await Promise.all([e.fetchData(`${t}.TAB`),e.fetchData(`${t}.BIN`)]);return s.tab=n.createDataView(),s.bin=i.createDataView(),s}hasAnim(e){return!(e<0||4*e>=this.tab.byteLength)&&268435456==(4278190080&(0,l.Wg)(this.tab,0,e))}getAnim(e){const t=268435455&(0,l.Wg)(this.tab,0,e),s=(268435455&(0,l.Wg)(this.tab,0,e+1))-t,n=(0,l.Y)(this.bin,t,s),i={keyframesOffset:n.getUint16(2),timesOffset:n.getUint16(4),numBones:n.getUint8(6),numKeyframes:n.getUint8(7),keyframeStride:n.getUint8(8)};function r(e){let t=10,s=i.keyframesOffset+e*i.keyframeStride;const r=new l.D2(n,s);function a(){const e=n.getUint16(t);return t+=2,e}function o(){const e={translation:0,rotation:0,scale:1};let t=a();e.rotation=(0,l.Bh)(65520&t);const s=15&t;if(0!==s){const t=r.get(s);e.rotation+=4*(0,l.IB)(t,14)}if(e.rotation=(0,l.so)(e.rotation),16&t){t=a();let s=!0;if(16&t){e.scale=65472&t;const n=15&t;if(0!==n){const t=r.get(n);e.scale+=2*(0,l.IB)(t,16)}e.scale=(65535&e.scale)/1024,s=!!(32&t),s&&(t=a())}if(s){e.translation=(0,l.Bh)(65520&t);const s=15&t;0!==s&&(e.translation+=r.get(s)),e.translation=(0,l.Bh)(e.translation)/512}}return e}function h(){const e=c();for(let t=0;t<3;t++)e.axes[t]=o();return e}const d=u(i.numBones);for(let e=0;e<i.numBones;e++)d.poses[e]=h();return d}const a=[];for(let e=0;e<i.numKeyframes;e++){const t=r(e);a.push(t)}let o=1;if(0!==i.timesOffset){let e=i.timesOffset;o=n.getFloat32(e),e+=4;const t=n.getUint16(e);e+=2;for(let s=0;s<t;s++)n.getUint16(e),e+=2}return{keyframes:a,speed:o,times:[]}}}function m(e,t,s,n){const r=void 0!==n?n:{translation:0,rotation:0,scale:1};return r.translation=(0,i.Cc)(e.translation,t.translation,s),r.rotation=(0,i.nU)(e.rotation,t.rotation,s),r.scale=(0,i.Cc)(e.scale,t.scale,s),r}function p(e,t,s,n){const i=void 0!==n?n:c();for(let n=0;n<3;n++)i.axes[n]=m(e.axes[n],t.axes[n],s,i.axes[n]);return i}function f(e,t){(0,i.rr)(e,t.axes[0].scale,t.axes[1].scale,t.axes[2].scale,t.axes[0].rotation,t.axes[1].rotation,t.axes[2].rotation,t.axes[0].translation,t.axes[1].translation,t.axes[2].translation)}const g=n.vt();function T(e,t,s,n){if(!s||!s.keyframes||0===s.keyframes.length||0===t.model.joints.length)return void t.resetPose();const i=s.keyframes.length,r=t.getAmap(n),a=e*i%i,o=Math.floor(a);let l=o+1;l>=i&&(l=0);const h=s.keyframes[o],c=s.keyframes[l],d=a-o;t.poses=function(e,t,s,n){const i=Math.min(e.poses.length,t.poses.length),r=void 0!==n?n:u(i);for(let n=0;n<i;n++)r.poses[n]=p(e.poses[n],t.poses[n],s,r.poses[n]);return r}(h,c,d,t.poses),function(e,t,s){t.resetPose();for(let n=0;n<e.poses.length&&n<t.model.joints.length;n++){let i=n;if(s&&n<s.byteLength){const t=s.getInt8(n);t>=0&&t<e.poses.length&&(i=t)}if(i<0||i>=e.poses.length)continue;const r=e.poses[i];f(g,r),t.setJointPose(n,g)}}(t.poses,t,r)}class x{constructor(){}static async create(e,t){const s=new x,n=e.pathBase,[i,r]=await Promise.all([t.fetchData(`${n}/AMAP.TAB`),t.fetchData(`${n}/AMAP.BIN`)]);return s.amapTab=i.createDataView(),s.amapBin=r.createDataView(),s}getAmap(e){const t=(0,l.Wg)(this.amapTab,0,e),s=(0,l.Wg)(this.amapTab,0,e+1);return(0,l.Y)(this.amapBin,t,s-t)}}class v{constructor(){}static async create(e,t){const s=new v,n=e.pathBase,[i,r]=await Promise.all([t.fetchData(`${n}/MODANIM.TAB`),t.fetchData(`${n}/MODANIM.BIN`)]);return s.modanimTab=i.createDataView(),s.modanimBin=r.createDataView(),s}getModanim(e){const t=(0,l.CV)(this.modanimTab,0,e),s=(0,l.CV)(this.modanimTab,0,e+1);return(0,l.Y)(this.modanimBin,t,s-t)}}class C{constructor(){this.animFiles=[]}static async create(e,t,s){const n=new C,i=e.pathBase;return n.preanimFile=await d.create(t,`${i}/PREANIM`),n.animFiles="string"==typeof s?[await d.create(t,`${i}/${s}/ANIM`)]:await Promise.all(s.map(e=>d.create(t,`${i}/${e}/ANIM`))),n}getAnim(e){if(this.preanimFile.hasAnim(e))return this.preanimFile.getAnim(e);for(const t of this.animFiles)if(t.hasAnim(e))return t.getAnim(e);return{keyframes:[],speed:1,times:[]}}}},8645(e,t,s){"use strict";s.d(t,{H3:()=>p,IJ:()=>f,VE:()=>u,Wz:()=>m,Zx:()=>v,ax:()=>g,pO:()=>x,tJ:()=>l,uj:()=>c,uv:()=>h,xT:()=>d});var n=s(9702),i=s(3793),r=s(2007);class a{constructor(e,t,s,n){this.materialFactory=e,this.texFetcher=t,this.modelVersion=s,this.isCompressed=n,this.blockModels=[]}static async create(e,t,s,n,i,r,o,l=!0){const h=new a(i,r,o,l),c=e.pathBase,[u,d]=await Promise.all([t.fetchData(`${c}/${s}`,{allow404:!0}),t.fetchData(`${c}/${n}`,{allow404:!0})]);return h.tab=u.createDataView(),h.bin=d,h}getBlockModel(e){var t,s,a,o,l;if(void 0===this.blockModels[e]){const h=(0,r.Wg)(this.tab,0,e);if(!(268435456&h))return null;const c=16777215&h,u=this.bin.subarray(c),d=this.isCompressed?(0,n.vR)(u):u;if(null===d)return null;this.blockModels[e]=(0,i.c)(d.createDataView(),this.texFetcher,this.materialFactory,this.modelVersion);const m=this.blockModels[e].sharedModelShapes;m&&(null===(t=m.shapes[0])||void 0===t?void 0:t.length,null===(s=m.shapes[1])||void 0===s?void 0:s.length,null===(a=m.shapes[2])||void 0===a?void 0:a.length,null===(o=m.waters)||void 0===o?void 0:o.length,null===(l=m.furs)||void 0===l?void 0:l.length)}return this.blockModels[e]}destroy(e){for(let t of this.blockModels)void 0!==t&&t.destroy(e)}}function o(e){return e<5?e:e+1}class l{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new l(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/mod${r}.tab`,h=`${s}/mod${r}.zlb.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.FinalMap),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class h{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new h(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/fear_mod${r}.tab`,h=`${s}/fear_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.fear),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class c{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new c(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/dfpt_mod${r}.tab`,h=`${s}/dfpt_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.dfpt),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class u{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new u(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/dup_mod${r}.tab`,h=`${s}/dup_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.dup),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class d{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new d(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/root_mod${r}.tab`,h=`${s}/root_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.Early1),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class m{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new m(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/dir_mod${r}.tab`,h=`${s}/dir_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.Early2),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class p{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new p(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/1_mod${r}.tab`,h=`${s}/1_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.Early3),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class f{constructor(e,t,s,n){this.gameInfo=e,this.device=t,this.materialFactory=s,this.animController=n,this.blockColls=[]}async init(e,t){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([e.fetchData(`${s}/TRKBLK.tab`),t]);this.trkblkTab=n.createDataView(),this.texFetcher=i}static async create(e,t,s,n,i,r){const a=new f(e,s,n,i);return await a.init(t,r),a}async fetchBlock(e,t,s){if(e<0||2*e>=this.trkblkTab.byteLength)return null;const n=await this.fetchBlockCollection(e,s),i=this.trkblkTab.getUint16(2*e)+t;return n.getBlockModel(i)}async fetchBlockCollection(e,t){if(void 0===this.blockColls[e]){const s=(0,n.sY)(e,this.gameInfo),r=o(e),l=`${s}/lzo_mod${r}.tab`,h=`${s}/lzo_mod${r}.bin`,[c,u]=await Promise.all([a.create(this.gameInfo,t,l,h,this.materialFactory,this.texFetcher,i.o.Early4),this.texFetcher.loadSubdirs([s],t)]);this.blockColls[e]=c}return this.blockColls[e]}destroy(e){for(let t of this.blockColls)void 0!==t&&t.destroy(e)}}class g{constructor(e,t,s){this.gameInfo=e,this.materialFactory=t,this.texFetcher=s}static async create(e,t,s,n){const r=new g(e,s,n),o="swapcircle",l=`${o}/mod22.tab`,h=`${o}/mod22.bin`;return r.blockColl=await a.create(r.gameInfo,t,l,h,r.materialFactory,r.texFetcher,i.o.BetaMap),r}async fetchBlock(e,t,s){return console.log(`fetching swapcircle block ${e}.${t}`),this.blockColl.getBlockModel(540+t)}destroy(e){this.blockColl.destroy(e)}}const T={1:22,2:35,3:57,4:87,5:0,6:142,7:164,8:186,9:208,10:230,11:252,12:275,13:297,14:323,15:345,16:384,17:448,18:453,19:475,20:510,21:532,22:554,23:576,24:598,25:620,26:642,27:664,28:708,29:730,30:752,31:774,32:788,33:805,34:821,35:843,36:867,37:872,38:894,39:916,40:938,41:960,42:982,43:1004,44:1026,45:1048,46:1070,47:1071,48:1093,49:1115,50:1137,51:1159,52:1183,53:1205,54:1227,55:1243};class x{constructor(e,t,s){this.materialFactory=e,this.texFetcher=t,this.pathBase=s}static async create(e,t,s,n){const i=await n,r=e.pathBase,a=await t.fetchData(`${r}/TRKBLK.bin`),o=new x(s,i,r);return o.trkblkTab=a.createDataView(),o}async fetchBlock(e,t,s){if(2*e>=this.trkblkTab.byteLength)return null;const n=this.trkblkTab.getUint16(2*e,!1)+t,r=`${this.pathBase}/uncompressed_blocks/${n}.bin`;try{const e=await s.fetchData(r);return(0,i.c)(e.createDataView(),this.texFetcher,this.materialFactory,i.o.DinosaurPlanet)}catch(e){return null}}}class v{constructor(e,t){this.materialFactory=e,this.texFetcher=t}static async create(e,t,s,n){const i=await n,r=e.pathBase,[a,o]=await Promise.all([t.fetchData(`${r}/BLOCKS.tab`),t.fetchData(`${r}/BLOCKS.bin`)]),l=new v(s,i);return l.blocksTab=a.createDataView(),l.blocksBin=o,l}async fetchBlock(e,t){const s=T[e];if(void 0===s)return null;const n=s+t;if(n<0||4*n>=this.blocksTab.byteLength)return null;const a=(0,r.Wg)(this.blocksTab,0,n),o=this.blocksBin.slice(a).createDataView();return(0,i.c)(o,this.texFetcher,this.materialFactory,i.o.AncientMap)}}},3292(e,t,s){"use strict";s.d(t,{DPFullWorldSceneDesc:()=>F,DPMapSceneDesc:()=>L,LF:()=>b,N:()=>P,NQ:()=>I,O7:()=>C,Qv:()=>E,UB:()=>M,UO:()=>k,bg:()=>w,ld:()=>B,t0:()=>R,yC:()=>S,yD:()=>D});var n=s(8880),i=s(8771),r=s(7684),a=s(5974),o=s(7459),l=s(3793),h=s(8874),c=s(8645),u=s(3209),d=s(6610),m=s(6223),p=s(7635),f=s(2141);const g={2:"dragrock.mp3",4:"volcano.mp3",7:"swaphol.mp3",8:"swapholbot.mp3",10:"snowhorn.mp3",11:"kp.mp3",12:"crf.mp3",14:"lightfoot.mp3",16:"dungeon.mp3",18:"mmpass.mp3",19:"darkicemines.mp3",21:"ofp.mp3",27:"darkicemines2.mp3",29:"capeclaw.mp3",28:"bossgaldon.mp3",31:"kraztest.mp3",32:"kraztest.mp3",33:"kraztest.mp3",34:"kraztest.mp3",39:"kraztest.mp3",40:"kraztest.mp3",50:"ofp.mp3",51:"shop.mp3",54:"magcave.mp3",Early_kraz_test:"oldfear.mp3",ancient_5:"warlock.mp3",[-997]:"oldfear.mp3",[-998]:"dfpt.mp3",[-999]:"swapcircle.mp3"};function T(e,t,s,n){const i=n*t.blockCols+s,r=e.getUint32(t.blockTableOffset+4*i),a=r>>>23;return 255==a?null:{mod:a,sub:r>>>17&63}}window.musicState||(window.musicState={muted:!1,audio:null});const x=(e,t)=>({mod:e,sub:t}),v=r.vt();class C{setBlockFetcher(e){this.blockFetcher=e}constructor(e,t,s){this.info=e,this.blockFetcher=t,this.world=s,this.matrix=r.vt(),this.invMatrix=r.vt(),this.blockInfoTable=[],this.blocks=[],this.numRows=e.getNumRows(),this.numCols=e.getNumCols();for(let t=0;t<this.numRows;t++){const s=[];this.blockInfoTable.push(s);for(let n=0;n<this.numCols;n++){const i=e.getBlockInfoAt(n,t);s.push(i)}}}clearBlocks(){this.blocks=[]}setMatrix(e){r.C(this.matrix,e),r.B8(this.invMatrix,e)}getNumDrawSteps(){return 3}*iterateBlocks(){for(let e=0;e<this.blocks.length;e++){const t=this.blocks[e];for(let s=0;s<t.length;s++)null!==t[s]&&(yield{x:s,z:e,block:t[s]})}}getBlockAtPosition(e,t){const s=Math.floor(e/640),n=Math.floor(t/640),i=this.blocks[n][s];return void 0===i?null:i}addRenderInsts(e,t,s,n,i=1){const a=n.cullByAabb;void 0===a&&(n.cullByAabb=!1);for(let a of this.iterateBlocks())i>1&&(a.x%i!==0||a.z%i!==0)||(r.kN(v,[640*a.x,0,640*a.z]),r.lK(v,this.matrix,v),a.block.addRenderInsts(e,t,n,s,v));n.cullByAabb=a}async reloadBlocks(e){this.clearBlocks();const t=document.createElement("div");t.style.cssText="\n        position: fixed; bottom: 20px; right: 20px; \n        padding: 15px 25px; background: rgba(0, 40, 80, 0.9); \n        color: #00d0ff; font-family: 'Segoe UI', Tahoma, sans-serif; \n        border: 2px solid #00d0ff; border-radius: 5px; \n        z-index: 10000; box-shadow: 0 0 15px rgba(0, 200, 255, 0.5);\n        font-weight: bold; text-transform: uppercase; letter-spacing: 1px;\n    ",t.innerText="Initializing...",document.body.appendChild(t);const s=[];for(let t=0;t<this.numRows;t++){this.blocks[t]=new Array(this.numCols).fill(null);for(let n=0;n<this.numCols;n++){const i=this.blockInfoTable[t][n];if(null==i)continue;const r=this.blockFetcher.fetchBlock(i.mod,i.sub,e).then(e=>({x:n,z:t,model:e})).catch(()=>({x:n,z:t,model:null}));s.push(r)}}const n=await Promise.all(s),i=n.length;for(let e=0;e<n.length;e++){const s=n[e];this.blocks[s.z][s.x]=s.model?new f.B_(s.model):null,e%5!=0&&e!==i-1||(t.innerText=`Synchronizing Map Data: ${Math.round((e+1)/i*100)}%`,await new Promise(e=>setTimeout(e,0)))}document.body.removeChild(t)}destroy(e){for(let t of this.blocks)for(let s of t)null==s||s.destroy(e)}}async function b(e,t,s){const n=e.pathBase,[i,r]=await Promise.all([t.fetchData(`${n}/MAPS.tab`),t.fetchData(`${n}/MAPS.bin`)]),a=function(e,t,s){const n=28*s,i=e.getUint32(n+0),r=e.getUint32(n+4),a=t.getUint16(i+0),o=t.getUint16(i+2);return{mapsBin:t,locationNum:s,infoOffset:i,blockTableOffset:r,blockCols:a,blockRows:o,originX:t.getInt16(i+4),originZ:t.getInt16(i+6)}}(i.createDataView(),r.createDataView(),s),o=function(e){const t=[];for(let s=0;s<e.blockRows;s++){const n=[];t.push(n);for(let t=0;t<e.blockCols;t++){const i=T(e.mapsBin,e,t,s);n.push(i)}}return t}(a);return{getNumCols:()=>a.blockCols,getNumRows:()=>a.blockRows,getBlockInfoAt:(e,t)=>o[t][e],getOrigin:()=>[a.originX,a.originZ]}}class _ extends h.G{playMusic(e){const t=window.musicState;t.audio&&(t.audio.pause(),t.audio.currentTime=0,t.audio=null);const s=function(e){const t=String(e);if(t.startsWith("early1_")||t.startsWith("dup_")){const e=Number(t.split("_")[1]);return[31,32,33,34,39,40].includes(e)?"Early_kraz_test":String(e)}return t}(e),n=g[s],i=1e3;function r(e,t){const s=e.volume/(t/50),n=setInterval(()=>{e.volume=Math.max(0,e.volume-s),e.volume<=0&&(clearInterval(n),e.pause(),e.currentTime=0)},50)}if(!n)return void(t.audio&&r(t.audio,i));const a=`data/audio/${n}`;if(!t.audio||!t.audio.src.includes(n)){t.audio&&r(t.audio,i);const e=new Audio(a);e.loop=!0,t.audio=e,t.muted||e.play().then(()=>{!function(e){e.volume=0;const t=setInterval(()=>{e.volume=Math.min(.2,e.volume+.01),e.volume>=.2&&clearInterval(t)},50)}(e)}).catch(()=>{})}}setBlockFetcherFactory(e){this.blockFetcherFactory=e}constructor(e,t,s){super(e,t,s),this.context=e,this.mapNum=-1}async reloadForTextureToggle(){if(this.dataFetcher){if(this.blockFetcherFactory){const e=await this.blockFetcherFactory();this.map.setBlockFetcher(e)}await this.map.reloadBlocks(this.dataFetcher)}}async create(e,t,s,n){this.dataFetcher=s,this.map=new C(e,n),await this.map.reloadBlocks(s);const i=n.texFetcher;return(null==i?void 0:i.textureHolder)&&(this.textureHolder=i.textureHolder),void 0!==this.mapNum&&this.playMusic(this.mapNum),this}createPanels(){if(!this.textureHolder)return[];const e=new n.Zk;e.setTitle(n.VT,"Textures");const t=new n.oA;return t.setTextureHolder(this.textureHolder),e.contents.appendChild(t.elem),[e]}setMatrix(e){this.map.setMatrix(e)}update(e){super.update(e),this.materialFactory.update(this.animController)}addWorldRenderInsts(e,t,s,n){const r=t.pushTemplateRenderInst();(0,i.$7)(r,n.viewerInput);const a={sceneCtx:n,showDevGeometry:!1,ambienceIdx:0,showMeshes:!0,outdoorAmbientColor:o.c,setupLights:()=>{}};this.map.addRenderInsts(e,t,s,a),t.popTemplateRenderInst()}}function y(e,t){var s;let n=window.__sfaTextureToggle;if(!n){const e=document.createElement("div");e.style.position="fixed",e.style.top="2px",e.style.right="2px",e.style.zIndex="10000",e.style.padding="2px 4px",e.style.background="rgba(0,0,0,0.5)",e.style.color="#fff",e.style.font="12px sans-serif",e.style.borderRadius="2px";const t=document.createElement("label");t.style.cursor="pointer";const s=document.createElement("input");s.type="checkbox",s.style.marginRight="2px",t.appendChild(s),t.appendChild(document.createTextNode("Textures")),e.appendChild(t),document.body.appendChild(e),n={wrap:e,cb:s,handler:null,last:!0},window.__sfaTextureToggle=n}n.handler&&n.cb.removeEventListener("change",n.handler);const i="boolean"==typeof t?t:null===(s=n.last)||void 0===s||s;n.cb.checked=i,n.handler=async()=>{try{n.last=n.cb.checked,await e(n.cb.checked)}catch(e){console.error("Texture toggle handler error:",e)}},n.cb.addEventListener("change",n.handler)}class S{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){const s=window.musicState;s.audio&&(s.audio.pause(),s.audio.currentTime=0,s.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const n=new m.X0,i=new d.YS(e),a=await b(this.gameInfo,t.dataFetcher,this.mapNum),o=new _(t,n,i),l=await p.JU.create(this.gameInfo,t.dataFetcher,!1),h=await c.tJ.create(this.gameInfo,t.dataFetcher,e,i,n,Promise.resolve(l));await o.create(a,this.gameInfo,t.dataFetcher,h);const u=r.vt();return r.Z8(u,u,3*Math.PI/4),o.setMatrix(u),o}}class w{constructor(e,t,s,n=u.Ij){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){const s=window.musicState;s.audio&&(s.audio.pause(),s.audio.currentTime=0,s.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const n=new m.X0,i=new d.YS(e),r=[19,7,8,20,0,12,13,0,0,17,18,0],a={getNumCols:()=>4,getNumRows:()=>3,getBlockInfoAt(e,t){const s=r[(4*t+e)%r.length];return 0===s?null:{mod:22,sub:s}},getOrigin:()=>[0,0]},o=new _(t,n,i);o.mapNum=-999;const l=await p.JU.create(this.gameInfo,t.dataFetcher,!0);await l.loadSubdirs(["swapcircle"],t.dataFetcher),l.logAllTex1TextureIDs();const h=await c.ax.create(this.gameInfo,t.dataFetcher,i,l);return await o.create(a,this.gameInfo,t.dataFetcher,h),o}}const A={0:["warlock"],2:["icemountain"],3:["swaphol","crfort"],5:["warlock","shop"],6:["shop"],7:["crfort","swaphol"],8:["icemountain"],9:["capeclaw"],10:["icemountain"],11:["icemountain"],4:["nwastes"],14:["cloudrace"]};class E{constructor(e,t,s,n){this.id=e,this.name=t,this.gameInfo=s,this.mapKey=n}async createScene(e,t){var s,n,i,o,h,u;const f=window.musicState;console.log("Ancient mapKey:",this.mapKey),f.audio&&(f.audio.pause(),f.audio.currentTime=0,f.audio=null),console.log(`Creating scene for ${this.name} ...`);const g=this.gameInfo.pathBase,T=t.dataFetcher,x=await T.fetchData(`${g}/AncientMaps.json`),v=new m.X0,C=new d.YS(e),b=new TextDecoder("utf-8").decode(x.arrayBuffer),S=JSON.parse(b)[this.mapKey],w=S.blocks.length,E=S.blocks[0].length,R=(0,a.y5)(w,()=>(0,a.y5)(E,()=>null));for(let e=0;e<w;e++)for(let t=0;t<E;t++){const s=S.blocks[e][t];if(null==s)R[e][t]=null;else{const n=s.split(".",2),i=Number.parseInt(n[0]),r=Number.parseInt(n[1]);R[e][t]={mod:i,sub:r}}}const I={getNumCols:()=>E,getNumRows:()=>w,getBlockInfoAt:(e,t)=>R[t][e],getOrigin:()=>[0,0]},k=new _(t,v,C);k.mapNum=`ancient_${this.mapKey}`;const M=await p.JU.create(this.gameInfo,T,!1);M.setModelVersion(l.o.AncientMap);const P=null!==(s=A[String(this.mapKey)])&&void 0!==s?s:[];await M.loadSubdirs(P,T),M.logAllTex1TextureIDs(),M.setPngOverride(4100,"textures/ribbon.png"),M.setPngOverride(618,"textures/walls.png"),M.setPngOverride(617,"textures/floor1.png"),M.setPngOverride(616,"textures/pillar.png"),M.setPngOverride(615,"textures/transwall.png"),M.setPngOverride(614,"textures/support.png"),M.setPngOverride(613,"textures/chain.png"),M.setPngOverride(612,"textures/head.png"),M.setPngOverride(611,"textures/krazfloor.png"),M.setPngOverride(610,"textures/decor1.png"),M.setPngOverride(609,"textures/floor2.png"),M.setPngOverride(608,"textures/ceiling1.png"),M.setPngOverride(607,"textures/walls2.png"),M.setPngOverride(606,"textures/pillar2.png"),M.setPngOverride(605,"textures/wood.png"),M.setPngOverride(604,"textures/button.png"),M.setPngOverride(603,"textures/sash.png"),M.setPngOverride(602,"textures/floor3.png"),M.setPngOverride(601,"textures/vines.png"),M.setPngOverride(600,"textures/walls3.png"),M.setPngOverride(599,"textures/block.png"),M.setPngOverride(598,"textures/innerdoor.png"),M.setPngOverride(597,"textures/stained.png"),M.setPngOverride(596,"textures/spire.png"),M.setPngOverride(595,"textures/crates.png"),M.setPngOverride(591,"textures/sabrestart.png"),M.setPngOverride(590,"textures/walls4.png"),M.setPngOverride(589,"textures/floor4.png"),M.setPngOverride(588,"textures/floor5.png"),M.setPngOverride(587,"textures/walls5.png"),M.setPngOverride(586,"textures/kraz.png"),M.setPngOverride(585,"textures/black.png"),M.setPngOverride(584,"textures/transring.png"),M.setPngOverride(583,"textures/spire2.png"),M.setPngOverride(582,"textures/kraz2.png"),M.setPngOverride(581,"textures/kraz3.png"),M.setPngOverride(580,"textures/port.png"),M.setPngOverride(579,"textures/floor6.png"),M.setPngOverride(3001,"textures/shoppurple.png"),M.setPngOverride(3002,"textures/shopwood.png"),M.setPngOverride(3003,"textures/shoppurple2.png"),M.setPngOverride(3004,"textures/shoppurple3.png"),M.setPngOverride(3005,"textures/shoppurple4.png"),M.setPngOverride(3006,"textures/shoppurple5.png"),M.setPngOverride(2037,"textures/wgfloor1.png"),M.setPngOverride(2036,"textures/wgfloor2.png"),M.setPngOverride(2035,"textures/wgfloor3.png"),M.setPngOverride(2034,"textures/wgwall1.png"),M.setPngOverride(2033,"textures/wgwall2.png"),M.setPngOverride(2032,"textures/wgwall3.png"),M.setPngOverride(2031,"textures/wgwall4.png"),M.setPngOverride(2030,"textures/wgfloor4.png"),M.setPngOverride(2029,"textures/wgwall5.png"),M.setPngOverride(2028,"textures/wgfloor5.png"),M.setPngOverride(2027,"textures/wgdirt.png"),M.setPngOverride(2026,"textures/wgfloor6.png"),M.setPngOverride(2025,"textures/wgwall6.png"),M.setPngOverride(2024,"textures/wgwall7.png"),M.setPngOverride(2023,"textures/wgwall8.png"),M.setPngOverride(2022,"textures/wgwall9.png"),M.setPngOverride(2021,"textures/wgrock.png"),M.setPngOverride(2020,"textures/wgwall10.png"),M.setPngOverride(2019,"textures/wgwall11.png"),M.setPngOverride(2018,"textures/wgfloor7.png"),M.setPngOverride(2017,"textures/wgwall12.png"),M.setPngOverride(2016,"textures/wgwall13.png"),M.setPngOverride(2015,"textures/wgvines.png"),M.setPngOverride(2014,"textures/wgwall14.png"),M.setPngOverride(2013,"textures/wgwall15.png"),M.setPngOverride(2012,"textures/wgwall16.png"),M.setPngOverride(2011,"textures/wgwall17.png"),M.setPngOverride(2010,"textures/wgwall18.png"),M.setPngOverride(2009,"textures/wgwall19.png"),M.setPngOverride(2008,"textures/wgwall20.png"),M.setPngOverride(2007,"textures/wgwall21.png"),M.setPngOverride(2006,"textures/wgwall22.png"),M.setPngOverride(2005,"textures/wgwall23.png"),M.setPngOverride(2004,"textures/wgrim.png"),M.setPngOverride(2003,"textures/wghead.png"),M.setPngOverride(2002,"textures/wghead2.png"),M.setPngOverride(2001,"textures/wghead3.png"),M.setPngOverride(2e3,"textures/wghead4.png"),await M.preloadPngOverrides(null!==(n=C.cache)&&void 0!==n?n:null===(o=(i=C).getCache)||void 0===o?void 0:o.call(i),T);const D=await c.Zx.create(this.gameInfo,T,C,Promise.resolve(M));k.setBlockFetcherFactory(()=>c.Zx.create(this.gameInfo,T,C,Promise.resolve(M))),await k.create(I,this.gameInfo,T,D),y(async e=>{M.setTexturesEnabled(e),C.texturesEnabled=e,await k.reloadForTextureToggle()},null===(u=null===(h=M.getTexturesEnabled)||void 0===h?void 0:h.call(M))||void 0===u||u);const B=r.vt();return r.Z8(B,B,3*Math.PI/4),k.setMatrix(B),k}}class R{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){const s=window.musicState;s.audio&&(s.audio.pause(),s.audio.currentTime=0,s.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const n=new m.X0,i=new d.YS(e),a=await b(this.gameInfo,t.dataFetcher,this.mapNum),o=new _(t,n,i);o.mapNum=-997;const h=await p.JU.create(this.gameInfo,t.dataFetcher,!1);h.setModelVersion(l.o.fear),await h.loadSubdirs(["mmshrine"],t.dataFetcher),h.logAllTex1TextureIDs();const u=await c.uv.create(this.gameInfo,t.dataFetcher,e,i,n,Promise.resolve(h));await o.create(a,this.gameInfo,t.dataFetcher,u);const f=r.vt();return r.Z8(f,f,3*Math.PI/4),o.setMatrix(f),o}}class I{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s,n,i;const a=window.musicState;a.audio&&(a.audio.pause(),a.audio.currentTime=0,a.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const o=new m.X0,h=new d.YS(e),u=await b(this.gameInfo,t.dataFetcher,this.mapNum),f=new _(t,o,h);f.mapNum=-998;const g=await p.JU.create(this.gameInfo,t.dataFetcher,!1);g.setModelVersion(l.o.dfpt),await g.loadSubdirs([""],t.dataFetcher),g.logAllTex1TextureIDs(),g.setPngOverride(4e3,"textures/dfprim.png"),g.setPngOverride(4001,"textures/dfpwall.png"),g.setPngOverride(4002,"textures/dfpwall2.png"),g.setPngOverride(4003,"textures/dfpfloor.png"),g.setPngOverride(4004,"textures/dfpwall3.png"),g.setPngOverride(4005,"textures/dfpdecor.png"),g.setPngOverride(4006,"textures/dfpwall4.png"),g.setPngOverride(4007,"textures/dfppillar.png"),g.setPngOverride(4008,"textures/dfpkraz.png"),g.setPngOverride(4009,"textures/dfpkraz2.png"),g.setPngOverride(4010,"textures/dfppost.png"),g.setPngOverride(4011,"textures/dfpstatue.png"),g.setPngOverride(4012,"textures/dfpstatue2.png"),g.setPngOverride(4013,"textures/dfpbuttons.png"),await g.preloadPngOverrides(null!==(s=h.cache)&&void 0!==s?s:null===(i=(n=h).getCache)||void 0===i?void 0:i.call(n),t.dataFetcher);const T=await c.uj.create(this.gameInfo,t.dataFetcher,e,h,o,Promise.resolve(g));await f.create(u,this.gameInfo,t.dataFetcher,T);const x=r.vt();return r.Z8(x,x,3*Math.PI/4),f.setMatrix(x),f}}class k{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s,n,i,a,o;const h=window.musicState;h.audio&&(h.audio.pause(),h.audio.currentTime=0,h.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const u=new m.X0,f=new d.YS(e);let g;switch(this.mapNum){case 32:g={getNumCols:()=>2,getNumRows:()=>4,getBlockInfoAt:(e,t)=>[[x(40,0),x(40,1)],[x(40,2),x(40,3)],[x(40,4),x(40,5)],[x(40,6),x(40,7)]][t][e],getOrigin:()=>[0,0]};break;case 34:g={getNumCols:()=>2,getNumRows:()=>4,getBlockInfoAt:(e,t)=>[[x(42,0),x(42,1)],[x(42,2),x(42,3)],[x(42,4),x(42,5)],[x(42,6),x(42,7)]][t][e],getOrigin:()=>[0,0]};break;case 39:g={getNumCols:()=>2,getNumRows:()=>4,getBlockInfoAt:(e,t)=>[[x(43,0),x(43,1)],[x(43,2),x(43,3)],[x(43,4),x(43,5)],[x(43,6),x(43,7)]][t][e],getOrigin:()=>[0,0]};break;default:g=await b(this.gameInfo,t.dataFetcher,this.mapNum)}const T=new _(t,u,f);T.mapNum=`dup_${this.mapNum}`;const v=await p.JU.create(this.gameInfo,t.dataFetcher,!1);v.setModelVersion(l.o.dup),v.setCurrentModelID(this.mapNum),await v.loadSubdirs([""],t.dataFetcher),v.logAllTex1TextureIDs(),v.setPngOverride(3614,"textures/MMSHfloor.png"),await v.preloadPngOverrides(null!==(s=f.cache)&&void 0!==s?s:null===(i=(n=f).getCache)||void 0===i?void 0:i.call(n),t.dataFetcher);const C=await c.VE.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v));T.setBlockFetcherFactory(()=>c.VE.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v))),await T.create(g,this.gameInfo,t.dataFetcher,C),y(async e=>{v.setTexturesEnabled(e),f.texturesEnabled=e,await T.reloadForTextureToggle()},null===(o=null===(a=v.getTexturesEnabled)||void 0===a?void 0:a.call(v))||void 0===o||o);const S=r.vt();return r.Z8(S,S,3*Math.PI/4),T.setMatrix(S),T}}class M{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s,n,i,a,o;const h=window.musicState;h.audio&&(h.audio.pause(),h.audio.currentTime=0,h.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const u=new m.X0,f=new d.YS(e);let g;switch(this.mapNum){case 13:g={getNumCols:()=>9,getNumRows:()=>9,getBlockInfoAt:(e,t)=>[[x(20,1),x(20,4),null,null,x(20,19),null,null,null,null],[x(20,0),x(20,3),null,x(20,12),x(20,18),x(20,25),null,null,null],[x(20,32),x(20,2),x(20,5),x(20,11),x(20,17),x(20,24),x(20,26),x(20,29),x(20,33)],[null,null,null,x(20,10),x(20,16),x(20,23),null,x(20,28),x(20,31)],[null,null,null,x(20,9),x(20,15),x(20,22),null,x(20,27),x(20,30)],[null,null,null,x(20,8),x(20,14),x(20,21),null,null,null],[null,null,null,x(20,7),x(20,13),x(20,20),null,null,null],[null,null,null,x(20,6),null,null,null,null,null],[null,null,null,null,null,null,null,null,null]][t][e],getOrigin:()=>[0,0]};break;case 31:g={getNumCols:()=>2,getNumRows:()=>4,getBlockInfoAt:(e,t)=>[[x(39,0),x(39,1)],[x(39,2),x(39,3)],[x(39,4),x(39,5)],[x(39,6),x(39,7)]][t][e],getOrigin:()=>[0,0]};break;default:g=await b(this.gameInfo,t.dataFetcher,this.mapNum)}const T=new _(t,u,f);T.mapNum=`early1_${this.mapNum}`;const v=await p.JU.create(this.gameInfo,t.dataFetcher,!1);v.setModelVersion(l.o.Early1),v.setCurrentModelID(this.mapNum),await v.loadSubdirs([""],t.dataFetcher),v.logAllTex1TextureIDs(),7===this.mapNum&&(await v.loadSubdirs(["swaphol"],t.dataFetcher),v.preferCopyOfSwapholForModelIDs([7])),v.setPngOverride(3e3,"textures/wcblue.png"),v.setPngOverride(3500,"textures/wcfloor.png"),v.setPngOverride(3501,"textures/wcredrims.png"),v.setPngOverride(3611,"textures/wcrims.png"),v.setPngOverride(3612,"textures/DIMladder.png"),v.setPngOverride(3613,"textures/DIMwall.png"),v.setPngOverride(3614,"textures/MMSHfloor.png"),await v.preloadPngOverrides(null!==(s=f.cache)&&void 0!==s?s:null===(i=(n=f).getCache)||void 0===i?void 0:i.call(n),t.dataFetcher);const C=await c.xT.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v));T.setBlockFetcherFactory(()=>c.xT.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v))),await T.create(g,this.gameInfo,t.dataFetcher,C),y(async e=>{v.setTexturesEnabled(e),f.texturesEnabled=e,await T.reloadForTextureToggle()},null===(o=null===(a=v.getTexturesEnabled)||void 0===a?void 0:a.call(v))||void 0===o||o);const S=r.vt();return r.Z8(S,S,3*Math.PI/4),T.setMatrix(S),T}}class P{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){const s=window.musicState;s.audio&&(s.audio.pause(),s.audio.currentTime=0,s.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const n=new m.X0,i=new d.YS(e);let a;a=52===this.mapNum?{getNumCols:()=>5,getNumRows:()=>5,getBlockInfoAt:(e,t)=>[[null,x(10,0),x(10,1),null],[x(10,14),x(10,2),x(10,3),x(10,15)],[x(10,4),x(10,5),x(10,6),x(10,12)],[x(10,10),x(10,7),x(10,8),x(10,13)],[null,x(10,9),x(10,11),null]][t][e],getOrigin:()=>[0,0]}:await b(this.gameInfo,t.dataFetcher,this.mapNum);const o=new _(t,n,i);o.mapNum=this.mapNum;const h=await p.JU.create(this.gameInfo,t.dataFetcher,!1);h.setModelVersion(l.o.Early2),await h.loadSubdirs([""],t.dataFetcher),h.logAllTex1TextureIDs();const u=await c.Wz.create(this.gameInfo,t.dataFetcher,e,i,n,Promise.resolve(h));await o.create(a,this.gameInfo,t.dataFetcher,u);const f=r.vt();return r.Z8(f,f,3*Math.PI/4),o.setMatrix(f),o}}class D{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s,n,i,a,o;const h=window.musicState;h.audio&&(h.audio.pause(),h.audio.currentTime=0,h.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const u=new m.X0,f=new d.YS(e);let g;g=67===this.mapNum?{getNumCols:()=>1,getNumRows:()=>3,getBlockInfoAt:(e,t)=>[[x(65,0)],[x(65,1)],[x(65,2)]][t][e],getOrigin:()=>[0,0]}:await b(this.gameInfo,t.dataFetcher,this.mapNum);const T=new _(t,u,f);T.mapNum=this.mapNum;const v=await p.JU.create(this.gameInfo,t.dataFetcher,!1);v.setModelVersion(l.o.Early3),await v.loadSubdirs([""],t.dataFetcher),v.logAllTex1TextureIDs(),v.setPngOverride(3600,"textures/dim2wall.png"),v.setPngOverride(3500,"textures/wcfloor.png"),await v.preloadPngOverrides(null!==(s=f.cache)&&void 0!==s?s:null===(i=(n=f).getCache)||void 0===i?void 0:i.call(n),t.dataFetcher);const C=await c.H3.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v));T.setBlockFetcherFactory(()=>c.H3.create(this.gameInfo,t.dataFetcher,e,f,u,Promise.resolve(v))),await T.create(g,this.gameInfo,t.dataFetcher,C),y(async e=>{v.setTexturesEnabled(e),f.texturesEnabled=e,await T.reloadForTextureToggle()},null===(o=null===(a=v.getTexturesEnabled)||void 0===a?void 0:a.call(v))||void 0===o||o);const S=r.vt();return r.Z8(S,S,3*Math.PI/4),T.setMatrix(S),T}}class B{constructor(e,t,s,n=u.$Q){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s,n,i;const a=window.musicState;a.audio&&(a.audio.pause(),a.audio.currentTime=0,a.audio=null),console.log(`Creating scene for ${this.name} (map #${this.mapNum}) ...`);const o=new m.X0,h=new d.YS(e),u=await b(this.gameInfo,t.dataFetcher,this.mapNum),f=new _(t,o,h);f.mapNum=this.mapNum;const g=await p.JU.create(this.gameInfo,t.dataFetcher,!1);g.setModelVersion(l.o.Early4),await g.loadSubdirs([""],t.dataFetcher),g.logAllTex1TextureIDs(),g.setCurrentModelID(this.mapNum),g.setPngOverride(3610,"textures/wcbluehead.png"),g.setPngOverride(3611,"textures/wcrims.png"),g.setPngOverride(3612,"textures/wcmoon1.png"),g.setPngOverride(3613,"textures/wcmoon2.png"),g.setPngOverride(3614,"textures/wcmoon3.png"),await g.preloadPngOverrides(null!==(s=h.cache)&&void 0!==s?s:null===(i=(n=h).getCache)||void 0===i?void 0:i.call(n),t.dataFetcher);const T=await c.IJ.create(this.gameInfo,t.dataFetcher,e,h,o,Promise.resolve(g));await f.create(u,this.gameInfo,t.dataFetcher,T);const x=r.vt();return r.Z8(x,x,3*Math.PI/4),f.setMatrix(x),f}}class L{constructor(e,t,s,n){this.mapNum=e,this.id=t,this.name=s,this.gameInfo=n}async createScene(e,t){var s;const n=null!==(s=this.gameInfo)&&void 0!==s?s:u.Dx,i=new m.X0,r=new d.YS(e),a=await b(n,t.dataFetcher,this.mapNum),o=new _(t,i,r),l=new p.EK,h=await c.pO.create(n,t.dataFetcher,r,Promise.resolve(l));return await o.create(a,n,t.dataFetcher,h),o}}class O extends h.G{constructor(e,t,s,n,i,r,a,o){super(t,s,n),this.device=e,this.gameInfo=i,this.dataFetcher=r,this.blockFetcher=a,this.placed=[],this.loaded=new Map,this.loading=new Map,this.placedByKey=new Map,this.camGX=0,this.camGZ=0,this.placed=o;for(const e of o)this.placedByKey.set(e.key,e)}ensureLoaded(e){if(this.loaded.has(e.key))return Promise.resolve();const t=this.loading.get(e.key);if(t)return t;const s=(async()=>{try{const t=await b(this.gameInfo,this.dataFetcher,e.mapIndex),s=new C(t,this.blockFetcher),[n,i]=t.getOrigin(),a=e.wx-640*n,o=e.wz-640*i,l=r.vt();r.kN(l,[a,0,o]),s.setMatrix(l),await s.reloadBlocks(this.dataFetcher),this.loaded.set(e.key,s)}catch(t){console.warn(`DPFullWorld: failed to load map ${e.mapIndex} @ (${e.gx},${e.gz})`,t)}finally{this.loading.delete(e.key)}})();return this.loading.set(e.key,s),s}async loadAllMaps(e=12){const t=this.placed.slice();let s=0;const n=async()=>{for(;;){const e=s++;if(e>=t.length)return;await this.ensureLoaded(t[e])}},i=[];for(let t=0;t<e;t++)i.push(n());await Promise.all(i)}unload(e){const t=this.loaded.get(e);t&&(t.destroy(this.device),this.loaded.delete(e))}update(e){super.update(e);const t=e.camera.worldMatrix,s=t[12],n=t[14],i=O.STEP;this.camGX=Math.round(s/i),this.camGZ=Math.round(n/i)}addWorldRenderInsts(e,t,s,n){const r=t.pushTemplateRenderInst();(0,i.$7)(r,n.viewerInput);const a={sceneCtx:n,showDevGeometry:!1,ambienceIdx:0,showMeshes:!0,outdoorAmbientColor:o.c,setupLights:()=>{},cullByAabb:!1};for(const[n,i]of this.loaded){const r=this.placedByKey.get(n);if(!r)continue;const o=Math.abs(r.gx-this.camGX),l=Math.abs(r.gz-this.camGZ),h=Math.max(o,l),c=h<=2||h<=8||h<=20?1:6;i.addRenderInsts(e,t,s,a,c)}t.popTemplateRenderInst()}destroy(e){for(const t of this.loaded.values())t.destroy(e);this.loaded.clear(),super.destroy(e)}}O.STEP=640;class F{constructor(e,t,s=u.Dx){this.id=e,this.name=t,this.gameInfo=s}async createScene(e,t){var s;const n=this.gameInfo,i=t.dataFetcher,r=await i.fetchData(`${n.pathBase}/globalmap.json`),a=new TextDecoder("utf-8").decode(r.arrayBuffer),o=JSON.parse(a),l=null!==(s=O.STEP)&&void 0!==s?s:10240,h=o.filter(e=>-1!==e.MapIndex);let u=1/0,f=1/0,g=-1/0,T=-1/0;for(const e of h)u=Math.min(u,e.CoordX),g=Math.max(g,e.CoordX),f=Math.min(f,e.CoordZ),T=Math.max(T,e.CoordZ);console.log("DP globalmap bounds:",{minX:u,maxX:g,minZ:f,maxZ:T,count:h.length});const x=h.map(e=>{const t=e.CoordX-u,s=e.CoordZ-f;return{key:e.MapIndex<<16^(255&t)<<8^255&s,mapIndex:e.MapIndex,gx:t,gz:s,wx:t*l,wz:s*l}}),v=new m.X0,C=new d.YS(e),b=new p.EK,_=await c.pO.create(n,i,C,Promise.resolve(b)),y=new O(e,t,v,C,n,i,_,x);return await y.loadAllMaps(8),y}}},6610(e,t,s){"use strict";s.d(t,{JT:()=>R,YS:()=>I,H5:()=>p,Y2:()=>m,JL:()=>g,RT:()=>S,FU:()=>y,Tn:()=>C});var n=s(7714),i=s(2003),r=s(7639),a=s(7635),o=s(2007),l=s(7684),h=s(5339);function c(e,t,s,n){let i=0,r=0;for(let a=0;a<n.length;a++){const o=n[a];if(s<o.layerCount){const n=o.x-e,a=o.y-t,l=Math.sqrt(Math.min(1,.25+(o.layerCount-s)/o.layerCount)),c=Math.min(Math.abs(n),Math.abs(n+1),Math.abs(n-1));let u=Math.max(0,-a),d=Math.abs(a+1),m=Math.abs(a);d<m&&(m=d,u=0);let p=Math.abs(a-1);p<m&&(m=p,a<1&&(u=1-a));const f=Math.hypot(c,m),g=(0,h.Cc)(o.baseRadius,o.tipRadius,Math.sqrt(s/o.layerCount));if(f<=g){let e=1-f/g;e>0&&(e=Math.sqrt(e)),i+=l*e,r+=.5*-(s/16-1)+u/g}}}return i>1&&(i=1),r>1&&(r=1),[r/8+7/16,i]}function u(e,t){return(0,h.Cc)(e,t,Math.random())}class d{constructor(e){this.cache=e,this.layers=[],this.hairs=[];const t=1e4;let s=0;for(let e=0;e<50&&s<t;e++){const n={layerCount:u(8,16),x:0,y:0,baseRadius:.01*u(5,10),tipRadius:0};n.tipRadius=.01*n.baseRadius*u(20,50);let i=!1;do{n.x=.001*u(0,999),n.y=.001*u(0,999),i=!1;for(let t=0;t<e;t++){const e=this.hairs[t],s=n.x-e.x,r=n.y-e.y,a=Math.min(Math.abs(s),Math.abs(s+1),Math.abs(s-1)),o=Math.min(Math.abs(r),Math.abs(r+1),Math.abs(r-1));if(Math.hypot(a,o)<n.tipRadius+e.baseRadius){i=!0;break}}s++}while(i&&s<t);s>=t&&console.warn(`Reached ${s} tries when placing hairs`),this.hairs.push(n)}}getLayer(e){return void 0===this.layers[e]&&(this.layers[e]=this.makeFurMap(e)),this.layers[e]}makeFurMap(e){const t=this.cache,s=this.cache.device,i=s.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,64,64,1)),r=t.createSampler({wrapS:n.Vf.Repeat,wrapT:n.Vf.Repeat,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),o=new Uint8Array(16384);function l(e,t,s,n,i,r){const a=4*(64*t+e);o[a]=s,o[a+1]=n,o[a+2]=i,o[a+3]=r}for(let t=0;t<64;t++)for(let s=0;s<64;s++){const[n,i]=c(s/64,t/64,e,this.hairs),r=255*n;l(s,t,r,r,r,255*i)}return s.uploadTextureData(i,0,[o]),new a.G7(i,r,64,64)}destroy(e){for(let t of this.layers)t.destroy(e)}}var m,p,f,g,T=s(7459),x=s(6063),v=s(9918);function C(e){return null!==e?t=>e.setOnTextureMapping(t):e=>e.reset()}!function(e){e[e.NRM=1]="NRM",e[e.CLR=2]="CLR"}(m||(m={})),function(e){e[e.HasVertexColor=2]="HasVertexColor",e[e.NBT=8]="NBT",e[e.HasVertexAlpha=16]="HasVertexAlpha"}(p||(p={})),function(e){e[e.OverrideLighting=2]="OverrideLighting"}(f||(f={})),function(e){e[e.DevGeometry=2]="DevGeometry",e[e.Fog=4]="Fog",e[e.CullBackface=8]="CullBackface",e[e.ReflectSkyscape=32]="ReflectSkyscape",e[e.Caustic=64]="Caustic",e[e.Lava=128]="Lava",e[e.Reflective=256]="Reflective",e[e.AlphaCompare=1024]="AlphaCompare",e[e.ShortFur=16384]="ShortFur",e[e.MediumFur=32768]="MediumFur",e[e.LongFur=65536]="LongFur",e[e.StreamingVideo=131072]="StreamingVideo",e[e.IndoorOutdoorBlend=262144]="IndoorOutdoorBlend",e[e.Water=2147483648]="Water"}(g||(g={}));const b=1048576;class _{constructor(e,t=null){this.factory=e,this.name=t,this.built=!1,this.mb=new x.po(t)}rebuild(){this.built=!1,this.mb.reset(),this.rebuildInternal(),this.built=!0}setOnMaterialParams(e,t){this.built||this.rebuild(),this.mb.setOnMaterialParams(e,t)}getGXMaterialHelper(){return this.mb.getGXMaterialHelper()}rebindTextures(e){this.rebuild()}}class y extends _{constructor(e,t,s,n){super(t),this.cache=e,this.shader=s,this.texFetcher=n,this.blendOverride=void 0,this.cprevIsValid=!1,this.aprevIsValid=!1,this.enableHemisphericProbe=!1,this.enableReflectiveProbe=!1,this.hasSkeleton=!1}addMistStages(){const e=this.mb.genPostTexMtx((e,t)=>{if(void 0===t.sceneCtx.world||!t.sceneCtx.world.envfxMan.mistEnable)return;const s=[5e-4,.1,1e3,t.sceneCtx.world.envfxMan.mistBottom,t.sceneCtx.world.envfxMan.mistTop],n=-1/(s[4]-s[3]);(0,o.wX)(e,0,0,-1/s[2],s[1],n*t.sceneCtx.viewToWorldMtx[1],n*t.sceneCtx.viewToWorldMtx[5],n*t.sceneCtx.viewToWorldMtx[9],n*t.sceneCtx.viewToWorldMtx[13]-s[4]*n,0,0,0,1,0,0,0,1)}),t=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(e)),s=this.mb.genKonstColor((e,t)=>{var s;(null===(s=t.sceneCtx.world)||void 0===s?void 0:s.envfxMan.mistEnable)&&t.sceneCtx.world.envfxMan.getFogColor(e,t.ambienceIdx)}),n=this.mb.genTexMap((e,t)=>{var s,n;(null===(s=t.sceneCtx.world)||void 0===s?void 0:s.envfxMan.enableFog)&&(null===(n=t.sceneCtx.world)||void 0===n?void 0:n.envfxMan.mistEnable)?t.sceneCtx.world.envfxMan.getMistTexture().setOnTextureMapping(e):this.factory.getTransparentBlackTexture().setOnTextureMapping(e)});{const e=this.mb.genTevStage();this.mb.setTevDirect(e),this.mb.setTevOrder(e,t,n,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(e,i.CC.CPREV,i.CC.KONST,i.CC.TEXA,i.CC.ZERO),this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV),this.mb.setTevKColorSel(e,(0,x.IQ)(s))}}rebuildInternal(){this.cprevIsValid=!1,this.aprevIsValid=!1,this.ambProbeTexCoord=void 0,this.enableHemisphericProbe=this.shader.hasHemisphericProbe,this.enableReflectiveProbe=this.shader.hasReflectiveProbe,this.rebuildSpecialized();const e=!!(1073741824&this.shader.flags)||!!(536870912&this.shader.flags),t=!!(this.shader.flags&g.AlphaCompare)||0===this.shader.flags,s=t&&!e,n=this.shader.flags&g.CullBackface&&!s;if(this.mb.setCullMode(n?i.Ac.BACK:i.Ac.NONE),e)this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA,i.Sn.NOOP),this.mb.setZMode(!0,i.oH.LEQUAL,!1),this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0);else if(this.mb.setBlendMode(i.Nx.NONE,i.dn.ONE,i.dn.ZERO,i.Sn.NOOP),this.mb.setZMode(!0,i.oH.LEQUAL,!0),t){const e=8;this.mb.setAlphaCompare(i.oH.GREATER,e,i.O2.AND,i.oH.ALWAYS,0)}else this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0);(this.shader.flags&g.AlphaCompare||0===this.shader.flags)&&this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA,i.Sn.NOOP)}setBlendOverride(e){this.blendOverride=e}}class S extends y{genScrollableTexCoord(e,t,s){if(void 0!==s){const e=this.factory.scrollSlots[s],n=this.mb.genPostTexMtx(t=>{l.kN(t,[e.x/b,e.y/b,0])});return this.mb.genTexCoord(i.s3.MTX2x4,t,void 0,void 0,(0,x.U2)(n))}return this.mb.genTexCoord(i.s3.MTX2x4,t)}addTevStagesForIndoorOutdoorBlend(e,t){const s=this.mb.genTevStage(),n=this.mb.genKonstColor((e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor)});this.mb.setTevKColorSel(s,(0,x.IQ)(n)),this.mb.setTevDirect(s),this.mb.setTevOrder(s,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.KONST,i.CC.RASC,i.CC.ZERO),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO);const r=this.mb.genTevStage();this.mb.setTevDirect(r),this.mb.setTevOrder(r,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(r,i.CC.CPREV,i.CC.RASC,i.CC.RASA,i.CC.ZERO),this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO);const a=this.mb.genTevStage();this.mb.setTevDirect(a),this.mb.setTevOrder(a,t,e),this.mb.setTevColorFormula(a,i.CC.ZERO,i.CC.CPREV,i.CC.TEXC,i.CC.ZERO),this.mb.setTevAlphaFormula(a,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.TEXA)}addTevStagesForTextureWithMode(e,t,s){const n=this.mb.genTevStage();let r,a;switch(this.mb.setTevDirect(n),this.mb.setTevOrder(n,s,t,i.Ug.COLOR0A0),e){case 0:r=[i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO];break;case 1:case 9:r=[i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO];break;default:console.warn(`Unhandled tev color-in mode ${e}`),r=[i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO]}this.aprevIsValid?a=[i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO]:(a=[i.CA.ZERO,i.CA.TEXA,i.CA.RASA,i.CA.ZERO],this.aprevIsValid=!0),this.mb.setTevColorFormula(n,r[0],r[1],r[2],r[3]),this.mb.setTevAlphaFormula(n,a[0],a[1],a[2],a[3]),this.cprevIsValid=!0}addTevStageForTexture(e,t,s,n=!1){const r=this.mb.genTevStage();if(n){const e=this.mb.genKonstColor((e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor)});this.mb.setTevKColorSel(r,(0,x.IQ)(e))}let a,o;this.mb.setTevDirect(r),this.mb.setTevOrder(r,s,t,i.Ug.COLOR0A0),0===e||console.warn(`Unhandled colorInMode ${e}`),a=[i.CC.ZERO,i.CC.TEXC,n?i.CC.KONST:i.CC.ONE,i.CC.ZERO],this.aprevIsValid?o=[i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO]:(o=[i.CA.ZERO,i.CA.TEXA,i.CA.RASA,i.CA.ZERO],this.aprevIsValid=!0),this.mb.setTevColorFormula(r,a[0],a[1],a[2],a[3]),this.mb.setTevAlphaFormula(r,o[0],o[1],o[2],o[3]),this.cprevIsValid=!0}addTevStageForMultColor0A0(){const e=this.mb.genTevStage();let t,s;this.mb.setTevDirect(e),this.mb.setTevOrder(e,null,null,i.Ug.COLOR0A0),this.mb.setTevKAlphaSel(e,i.u_.KASEL_1),0!==e&&this.cprevIsValid?(t=[i.CC.ZERO,i.CC.CPREV,i.CC.RASC,i.CC.ZERO],s=[i.CA.ZERO,i.CA.APREV,i.CA.KONST,i.CA.ZERO]):(t=[i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.RASC],s=[i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.KONST]),this.mb.setTevColorFormula(e,t[0],t[1],t[2],t[3]),this.mb.setTevAlphaFormula(e,s[0],s[1],s[2],s[3]),this.cprevIsValid=!0}addTevStagesForLava(){const e=this.mb.genIndTexMtx((e,t)=>{const s=1*(.125*Math.sin(3.142*t.sceneCtx.animController.envAnimValue1)+.75),n=s*Math.cos(3.142*t.sceneCtx.animController.envAnimValue0),i=s*Math.sin(3.142*t.sceneCtx.animController.envAnimValue0);(0,o.wX)(e,n,i,0,0,-i,n,0,0,0,0,0,0,0,0,0,1),l.Ny(e,e,1/4)}),t=this.mb.genIndTexMtx((e,t)=>{const s=1*(.125*Math.sin(3.142*t.sceneCtx.animController.envAnimValue0)+.75),n=s*Math.cos(3.142*-t.sceneCtx.animController.envAnimValue1),i=s*Math.sin(3.142*-t.sceneCtx.animController.envAnimValue1);(0,o.wX)(e,n,i,0,0,-i,n,0,0,0,0,0,0,0,0,0,1),l.Ny(e,e,1/4)}),s=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,1536,!1))),n=this.mb.genTexMap(this.factory.getWavyTexture()),r=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,this.shader.layers[0].texId,!0))),a=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0),h=l.vt();l.CV(h,[.9,.9,1]);const c=this.mb.genPostTexMtx((e,t)=>{l.C(e,h),(0,o.ix)(e,1,3,.125*t.sceneCtx.animController.envAnimValue1)}),u=l.vt();l.CV(u,[1.2,1.2,1]);const d=l.vt();l.N9(d,Math.PI/4),l.lK(u,d,u);const m=this.mb.genPostTexMtx((e,t)=>{l.C(e,u);const s=.0625*t.sceneCtx.animController.envAnimValue0;(0,o.ix)(e,0,3,s),(0,o.ix)(e,1,3,s)}),p=this.mb.genPostTexMtx(e=>{l.D_(e)}),f=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.TEX0,void 0,void 0,(0,x.U2)(p)),g=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.TEX0,void 0,void 0,(0,x.U2)(c)),v=this.mb.genIndTexStage();this.mb.setIndTexOrder(v,g,n),this.mb.setIndTexScale(v,i.ru._1,i.ru._1);const b=this.mb.genTevStage(),_=this.mb.genTevStage(),y=this.mb.genTevStage();this.mb.setTevIndirect(_,v,i.yU._8,i.QE.STU,(0,x.Mb)(e),i.D_._0,i.D_._0,!1,!1,i.zi.OFF);const S=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.TEX0,void 0,void 0,(0,x.U2)(m)),w=this.mb.genIndTexStage();this.mb.setIndTexOrder(w,S,n),this.mb.setIndTexScale(w,i.ru._1,i.ru._1),this.mb.setTevIndirect(y,w,i.yU._8,i.QE.STU,(0,x.Mb)(t),i.D_.OFF,i.D_.OFF,!0,!1,i.zi.OFF);const A=this.mb.genKonstColor((e,t)=>{const s=.5*Math.sin(3.142*t.sceneCtx.animController.envAnimValue0)+.5;(0,T.gM)(e,64*s/255,0,0,192/255)});this.mb.setTevKAlphaSel(b,(0,x.xF)(A)),this.mb.setTevKColorSel(_,(0,x.IQ)(A)),this.mb.setTevDirect(b),this.mb.setTevOrder(b,f,r,i.Ug.COLOR0A0);const E=[i.R7.R,i.R7.G,i.R7.B,i.R7.R];this.mb.setTevSwapMode(b,void 0,E),this.mb.setTevColorFormula(b,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO),this.mb.setTevAlphaFormula(b,i.CA.KONST,i.CA.ZERO,i.CA.ZERO,i.CA.TEXA,i.fQ.SUB,i.bt.ZERO,i.mX.SCALE_4),this.cprevIsValid=!0,this.mb.setTevOrder(_),this.mb.setTevColorFormula(_,i.CC.KONST,i.CC.ZERO,i.CC.ZERO,i.CC.CPREV),this.mb.setTevAlphaFormula(_,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV),this.mb.setTevOrder(y,a,s),this.mb.setTevColorFormula(y,i.CC.CPREV,i.CC.TEXC,i.CC.APREV,i.CC.ZERO),this.mb.setTevAlphaFormula(y,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO)}addTevStagesForCaustic(){const e=l.vt();l.CV(e,[.008,.008,.008]),(0,o.Ir)(e,.008,0,.008);const t=l.vt();l.$0(t,1,[3,-1,1]);const s=this.mb.genPostTexMtx((s,n)=>{l.lK(s,e,n.sceneCtx.viewToWorldMtx),l.lK(s,t,s),(0,o.vi)(s,2,0,0,0,1)}),n=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(s)),r=l.vt();l.CV(r,[.005,.005,.005]),(0,o.Ir)(r,.005,0,.005);const a=l.vt();l.$0(a,1,[1,-1,3]);const h=this.mb.genPostTexMtx((e,t)=>{l.lK(e,r,t.sceneCtx.viewToWorldMtx),l.lK(e,a,e),(0,o.vi)(e,2,0,0,0,1)}),c=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(h)),u=this.mb.genTexMap(this.factory.getCausticTexture()),d=this.mb.genTexMap(this.factory.getWavyTexture()),m=l.vt();l.N9(m,Math.PI/4);const p=l.vt();l.$0(p,1,[1,-2,1]);const f=l.vt(),g=this.mb.genPostTexMtx((e,t)=>{l.CV(f,[.01,.01,.01]),(0,o.Ir)(f,.01+t.sceneCtx.animController.envAnimValue0,0,.01),l.lK(f,m,f),l.lK(e,f,t.sceneCtx.viewToWorldMtx),l.lK(e,p,e),(0,o.vi)(e,2,0,0,0,1)}),T=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(g)),v=this.mb.genIndTexMtx(e=>{l.CV(e,[.5,.5,0]),l.Ny(e,e,.5)}),C=this.mb.genIndTexStage();this.mb.setIndTexOrder(C,T,d),this.mb.setIndTexScale(C,i.ru._1,i.ru._1);const b=l.vt();l.$0(b,1,[-2,-1,1]);const _=l.vt(),y=this.mb.genPostTexMtx((e,t)=>{l.CV(_,[.01,.01,.01]),(0,o.Ir)(_,.01,0,.01+t.sceneCtx.animController.envAnimValue1),l.lK(e,_,t.sceneCtx.viewToWorldMtx),l.lK(e,b,e),(0,o.vi)(e,2,0,0,0,1)}),S=(this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(y)),this.mb.genTevStage());this.mb.setTevIndirect(S,C,i.yU._8,i.QE.T,(0,x.Mb)(v),i.D_._0,i.D_._0,!1,!1,i.zi.OFF),this.mb.setTevOrder(S,n,u,i.Ug.COLOR0A0),this.mb.setTevColorFormula(S,i.CC.ZERO,i.CC.RASA,i.CC.TEXA,i.CC.CPREV),this.mb.setTevAlphaFormula(S,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV),this.cprevIsValid=!0;const w=this.mb.genTevStage();this.mb.setTevOrder(w,c,u,i.Ug.COLOR0A0),this.mb.setTevColorFormula(w,i.CC.ZERO,i.CC.RASA,i.CC.TEXA,i.CC.CPREV),this.mb.setTevAlphaFormula(w,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV)}addTevStagesForReflectiveFloor(){const e=this.mb.genTexMap(e=>{e.reset(),e.lateBinding="temporal-texture-downscale-8x",e.width=80,e.height=60}),t=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.TEXMTX2),s=this.mb.genTevStage();this.mb.setTevDirect(s),this.mb.setTevKColorSel(s,i.jl.KCSEL_2_8),this.mb.setTevOrder(s,t,e,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.TEXC,i.CC.KONST,i.CC.CPREV),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV),this.cprevIsValid=!0}addTevStagesForNonLava(){if(2===this.shader.layers.length&&9==(127&this.shader.layers[1].tevMode)){const e=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,this.shader.layers[0].texId,!0))),t=this.genScrollableTexCoord(e,i.Kx.TEX0,this.shader.layers[0].scrollSlot),s=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,this.shader.layers[1].texId,!0))),n=this.genScrollableTexCoord(s,i.Kx.TEX1,this.shader.layers[1].scrollSlot);this.addTevStageForTexture(0,e,t),this.shader.flags&g.Reflective&&this.addTevStagesForReflectiveFloor(),this.addTevStagesForTextureWithMode(9,s,n),this.addTevStageForMultColor0A0()}else{for(let e=0;e<this.shader.layers.length;e++){const t=this.shader.layers[e],s=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,this.shader.layers[e].texId,!0))),n=this.genScrollableTexCoord(s,i.Kx.TEX0+e,t.scrollSlot);this.shader.flags&g.IndoorOutdoorBlend?this.addTevStagesForIndoorOutdoorBlend(s,n):this.addTevStagesForTextureWithMode(127&t.tevMode,s,n)}this.shader.flags&g.Reflective&&this.addTevStagesForReflectiveFloor()}}addLightStage(e,t){const s=this.mb.genPostTexMtx((t,s)=>{if(void 0!==s.mapLights&&e<s.mapLights.length){const n=s.mapLights[e],i=.5/Math.max(.1,n.radius);(0,o.wX)(t,i,0,0,-n.viewPosition[0]*i+.5,0,0,i,-n.viewPosition[2]*i+.5,0,0,0,1,0,0,0,1)}else l.D_(t)}),n=this.mb.genPostTexMtx((t,s)=>{if(void 0!==s.mapLights&&e<s.mapLights.length){const n=s.mapLights[e],i=.5/Math.max(.1,n.radius);(0,o.wX)(t,0,i,0,-n.viewPosition[1]*i+.5,0,0,0,.5,0,0,0,1,0,0,0,1)}else l.D_(t)}),r=this.mb.genTexMap(this.factory.getMapLightTexture()),a=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(s)),h=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.PNMTX0,!1,(0,x.U2)(n)),c=this.mb.genTevStage();this.mb.setTevDirect(c),this.mb.setTevOrder(c,a,r,i.Ug.COLOR_ZERO);const u=this.mb.genKonstColor((t,s)=>{void 0!==s.mapLights&&e<s.mapLights.length?(0,T.z5)(t,s.mapLights[e].color):(0,T.z5)(t,T.gh)});this.mb.setTevKColorSel(c,(0,x.IQ)(u)),this.mb.setTevColorFormula(c,i.CC.ZERO,i.CC.KONST,i.CC.TEXC,i.CC.ZERO,void 0,void 0,void 0,void 0,i.UZ.REG0),this.mb.setTevAlphaFormula(c,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV);const d=this.mb.genTevStage();this.mb.setTevDirect(d),this.mb.setTevOrder(d,h,r,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(d,i.CC.ZERO,i.CC.C0,i.CC.TEXC,t?i.CC.C1:i.CC.CPREV,void 0,void 0,void 0,void 0,t?i.UZ.REG1:i.UZ.PREV),this.mb.setTevAlphaFormula(d,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV)}addLightStages(){let e=16,t=!1;(2048&this.shader.flags||4096&this.shader.flags)&&(e=12,t=!0);let s=0;for(;this.mb.getTevStageCount()<e&&this.mb.getTexCoordCount()<7&&this.mb.getKonstColorCount()<4;)this.addLightStage(s,t),s++;if(2048&this.shader.flags){const e=this.mb.genTevStage();this.mb.setTevDirect(e),this.mb.setTevOrder(e,null,null,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.CPREV,i.CC.C1,i.CC.ZERO),this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV)}else if(4096&this.shader.flags){const e=this.mb.genTevStage();this.mb.setTevDirect(e),this.mb.setTevOrder(e,null,null,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.CPREV,i.CC.C1,i.CC.ZERO,void 0,void 0,void 0,void 0,i.UZ.REG2),this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV);const t=this.mb.genTevStage();this.mb.setTevDirect(t),this.mb.setTevOrder(t,null,null,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(t,i.CC.C1,i.CC.ZERO,i.CC.ZERO,i.CC.CPREV),this.mb.setTevAlphaFormula(t,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV);const s=this.mb.genTevStage();this.mb.setTevDirect(s),this.mb.setTevOrder(s,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(s,i.CC.CPREV,i.CC.C2,i.CC.RASA,i.CC.ZERO),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV)}}rebuildSpecialized(){this.cprevIsValid=!1,this.aprevIsValid=!1,this.mb.setTexMtx(2,(e,t)=>((0,r.dr)(e,t.sceneCtx.viewerInput.camera,-t.sceneCtx.flipYScale),l.lK(e,e,t.modelToViewMtx),e)),this.shader.flags&g.Lava?this.addTevStagesForLava():this.addTevStagesForNonLava(),this.shader.flags&g.ReflectSkyscape?console.log("TODO: skyscape reflection?"):this.shader.flags&g.Caustic?this.addTevStagesForCaustic():this.addMistStages(),this.addLightStages(),1&this.shader.flags||this.shader.flags&g.IndoorOutdoorBlend||2048&this.shader.flags||4096&this.shader.flags?(this.mb.setAmbColor(0,void 0),this.shader.flags&g.IndoorOutdoorBlend?this.mb.setChanCtrl(i.UQ.COLOR0,!0,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE):this.mb.setChanCtrl(i.UQ.COLOR0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)):(this.mb.setAmbColor(0,(e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor)}),this.mb.setChanCtrl(i.UQ.COLOR0,!0,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)),this.mb.setChanCtrl(i.UQ.ALPHA0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE),this.mb.setChanCtrl(i.UQ.COLOR1A1,!1,i.uj.REG,i.uj.REG,0,i.jN.NONE,i.bg.NONE)}}class w extends y{constructor(e,t,s,n,i){super(e,t,s,n),this.hasSkeleton=i}addNBTTextureStage(){const e=this.mb.genIndTexStage(),t=this.mb.genIndTexMtx((e,t)=>{l.CV(e,[.5,.5,0]),(0,o.ix)(e,0,3,.125)}),s=this.texFetcher.getTexture(this.cache,this.shader.nbtTexId,!0),n=this.mb.genTexMap(C(s));let r=1;if(null!==this.shader.layers[0].texId){const e=this.texFetcher.getTexture(this.cache,this.shader.layers[0].texId,!0);null!==e&&(r=4*(15&this.shader.nbtParams)+1,e.width/(s.width*r)|0&&(console.warn("TODO: GXSetIndTexCoordScale in addNBTTextureStage"),r=0))}let a=1;this.enableHemisphericProbe&&(a=2),this.enableReflectiveProbe&&(a+=1),this.mb.setIndTexOrder(e,a,n);const h=this.mb.genPostTexMtx((e,t)=>{const s=1.5*((this.shader.nbtParams>>4)/7-1);l.CV(e,[s,s,0]),(0,o.Ir)(e,0,0,1)}),c=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.BINRM,i.b1.TEXMTX0,!1,(0,x.U2)(h));this.mb.setTexCoordUsesMtxIdx(c,this.hasSkeleton);const u=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TANGENT,i.b1.TEXMTX0,!1,(0,x.U2)(h));this.mb.setTexCoordUsesMtxIdx(u,this.hasSkeleton);const d=this.mb.genTevStage();this.mb.setTevIndirect(d,e,i.yU._8,i.QE.ST,(0,x.gY)(t),i.D_._0,i.D_._0,!1,!1,i.zi.OFF),this.mb.setTevOrder(d,c,n+1,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(d,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,0!==d?i.CC.CPREV:i.CC.RASC),this.mb.setTevAlphaFormula(d,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,0!==d?i.CA.APREV:i.CA.RASA);const m=this.mb.genTevStage();return this.mb.setTevIndirect(m,e,i.yU._8,i.QE.ST,(0,x.pD)(t),i.D_._0,i.D_._0,!0,!1,i.zi.OFF),this.mb.setTevOrder(m,u,n+1,i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(m,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,0!==m?i.CC.CPREV:i.CC.RASC),this.mb.setTevAlphaFormula(m,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,0!==m?i.CA.APREV:i.CA.RASA),this.mb.setTevIndirect(m+1,e,i.yU._8,i.QE.NONE,i.fw.OFF,i.D_.OFF,i.D_.OFF,!0,!1,i.zi.OFF),r}getAmbientProbeTexCoord(){if(void 0===this.ambProbeTexCoord){const e=this.mb.genPostTexMtx((e,t)=>{l.kN(e,[.5,.5,1]),l.hs(e,e,[-.5,-.5*t.sceneCtx.flipYScale,0])});this.ambProbeTexCoord=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.NRM,i.b1.TEXMTX0,!1,(0,x.U2)(e)),this.mb.setTexCoordUsesMtxIdx(this.ambProbeTexCoord,this.hasSkeleton)}return this.ambProbeTexCoord}setupHemisphericProbe(){if(!this.enableHemisphericProbe)return;const e=this.mb.genKonstColor(e=>{(0,T.z5)(e,T.c),e.a=0}),t=this.mb.genTexMap((e,t)=>{e.reset(),e.lateBinding="sphere-map-"+(5-t.ambienceIdx),e.width=32,e.height=32}),s=this.mb.genTevStage();0===this.mb.getIndTexStageCount()&&this.mb.setTevDirect(s),this.mb.setTevKColorSel(s,(0,x.IQ)(e)),this.mb.setTevOrder(s,this.getAmbientProbeTexCoord(),t,i.Ug.COLOR0A0),this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.TEXC,i.CC.KONST,i.CC.RASC,void 0,void 0,void 0,void 0,i.UZ.REG1),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO)}setupReflectiveProbe(){if(!this.enableReflectiveProbe)return void this.mb.setTevRegColor(2,e=>(0,T.z5)(e,T.jR));const e=this.mb.genTexMap((t=this.shader.reflectiveProbeIdx>>1,e=>{e.reset(),e.lateBinding=`sphere-map-${t}`,e.width=32,e.height=32}));var t;this.mb.setTevRegColor(2,e=>(0,T.gM)(e,1,1,1,this.shader.reflectiveAmbFactor));const s=this.mb.genTevStage();if(0===this.mb.getIndTexStageCount()&&this.mb.setTevDirect(s),void 0===this.ambProbeTexCoord?this.mb.setTevOrder(s,this.getAmbientProbeTexCoord(),e,i.Ug.COLOR0A0):(this.mb.setTevIndirect(s,0,i.yU._8,i.QE.NONE,i.fw.OFF,i.D_._0,i.D_._0,!0,!1,i.zi.OFF),this.mb.setTevOrder(s,this.getAmbientProbeTexCoord(),e)),this.enableHemisphericProbe?this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.TEXC,i.CC.C1,i.CC.ZERO,void 0,void 0,void 0,void 0,i.UZ.REG2):this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO,void 0,void 0,void 0,void 0,i.UZ.REG2),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.TEXA,i.CA.A2,i.CA.ZERO),1&this.shader.reflectiveProbeIdx?this.mb.setTevSwapMode(s,void 0,[i.R7.B,i.R7.B,i.R7.B,i.R7.G]):this.mb.setTevSwapMode(s,void 0,[i.R7.R,i.R7.R,i.R7.R,i.R7.G]),0!==this.shader.reflectiveAmbFactor){const e=this.mb.genTevStage();this.mb.setTevOrder(e,null,null,i.Ug.COLOR0A0),this.enableHemisphericProbe?this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.APREV,i.CC.C1,i.CC.C2,void 0,void 0,void 0,void 0,i.UZ.REG2):this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.APREV,i.CC.RASC,i.CC.C2,void 0,void 0,void 0,void 0,i.UZ.REG2),this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO)}}addColoredTextureLayerStageWithoutAmbience(e,t,s,n){const r=this.mb.genTevStage();if(this.mb.setTevDirect(r),this.mb.setTevOrder(r,e,t),void 0!==n){const e=this.mb.genKonstColor(n);this.mb.setTevKColorSel(r,(0,x.IQ)(e)),this.mb.setTevKAlphaSel(r,(0,x.xF)(e))}else this.mb.setTevKColorSel(r,i.jl.KCSEL_1),this.mb.setTevKAlphaSel(r,i.u_.KASEL_1);switch(s){case 0:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.KONST,i.CC.ZERO);break;case 8:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.KONST,i.CC.C2);break;default:this.mb.setTevColorFormula(r,i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO)}this.aprevIsValid?this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO):this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.KONST,i.CA.ZERO),this.cprevIsValid=!0,this.aprevIsValid=!0}addColoredTextureLayerStageWithAmbience(e,t,s,n){const r=this.mb.genTevStage();if(this.mb.setTevDirect(r),this.mb.setTevOrder(r,e,t),void 0!==n){const e=this.mb.genKonstColor(n);this.mb.setTevKColorSel(r,(0,x.IQ)(e)),this.mb.setTevKAlphaSel(r,(0,x.xF)(e))}else this.mb.setTevKColorSel(r,i.jl.KCSEL_1),this.mb.setTevKAlphaSel(r,i.u_.KASEL_1);switch(s){case 0:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.KONST,i.CC.ZERO);break;case 8:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.C1,i.CC.C2);break;default:this.mb.setTevColorFormula(r,i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO)}this.aprevIsValid?this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO):this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.KONST,i.CA.ZERO),this.cprevIsValid=!0,this.aprevIsValid=!0}addPlainTextureLayerStage(e,t,s){const n=this.mb.genTevStage();this.mb.setTevDirect(n),this.mb.setTevOrder(n,e,t,i.Ug.COLOR0A0),0===s?this.mb.setTevColorFormula(n,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO):(console.warn(`Unhandled colorInMode ${s} in addPlainTextureLayerStage`),this.mb.setTevColorFormula(n,i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO)),this.aprevIsValid?this.mb.setTevAlphaFormula(n,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO):this.mb.setTevAlphaFormula(n,i.CA.ZERO,i.CA.TEXA,i.CA.RASA,i.CA.ZERO);const r=this.mb.genTevStage();this.mb.setTevDirect(r),this.mb.setTevOrder(r,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.CPREV,i.CC.APREV,i.CC.ZERO),this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.APREV,i.CA.ZERO,i.CA.ZERO),this.cprevIsValid=!0,this.aprevIsValid=!0}addAlphaedTextureLayerStage(e,t,s,n){const r=this.mb.genTevStage();if(this.mb.setTevDirect(r),this.mb.setTevOrder(r,e,t,i.Ug.COLOR0A0),void 0!==n){const e=this.mb.genKonstColor(n);this.mb.setTevKAlphaSel(r,(0,x.xF)(e))}else this.mb.setTevKAlphaSel(r,i.u_.KASEL_1);switch(s){case 0:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO);break;case 8:this.mb.setTevColorFormula(r,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.C2);break;default:this.mb.setTevColorFormula(r,i.CC.TEXC,i.CC.CPREV,i.CC.APREV,i.CC.ZERO)}this.aprevIsValid?this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO):this.mb.setTevAlphaFormula(r,i.CA.ZERO,i.CA.TEXA,i.CA.KONST,i.CA.ZERO),this.cprevIsValid=!0,this.aprevIsValid=!0}addMultByKonstAlphaStage(e){const t=this.mb.genTevStage();if(this.mb.setTevDirect(t),this.mb.setTevOrder(t,null,null,i.Ug.COLOR0A0),void 0!==e){const s=this.mb.genKonstColor(e);this.mb.setTevKAlphaSel(t,(0,x.xF)(s))}else this.mb.setTevKAlphaSel(t,i.u_.KASEL_1);this.cprevIsValid?(this.mb.setTevColorFormula(t,i.CC.ZERO,i.CC.CPREV,i.CC.RASC,i.CC.ZERO),this.mb.setTevAlphaFormula(t,i.CA.ZERO,i.CA.APREV,i.CA.KONST,i.CA.ZERO)):(this.mb.setTevColorFormula(t,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.RASC),this.mb.setTevAlphaFormula(t,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.KONST)),this.cprevIsValid=!0}setupShaderLayers(e,t){for(let s=0;s<this.shader.layers.length;s++){const n=this.shader.layers[s];if(!!(128&n.tevMode)==e)if(null!==n.texId){const e=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,n.texId,!0))),r=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0+s);let a;a=s>0?127&this.shader.layers[s-1].tevMode:this.enableHemisphericProbe?8:0,this.enableHemisphericProbe?this.addColoredTextureLayerStageWithAmbience(r,e,a):t?16&this.shader.attrFlags?this.addColoredTextureLayerStageWithoutAmbience(r,e,a,(e,t)=>(0,T.z5)(e,t.outdoorAmbientColor)):this.addColoredTextureLayerStageWithAmbience(r,e,a,(e,t)=>(0,T.z5)(e,t.outdoorAmbientColor)):16&this.shader.attrFlags?this.addPlainTextureLayerStage(r,e,a):this.addAlphaedTextureLayerStage(r,e,a)}else t?16&this.shader.attrFlags?console.log("textureless fooFlag attr0x10"):console.log("textureless fooFlag !attr0x10"):16&this.shader.attrFlags?console.log("textureless !fooFlag attr0x10"):this.addMultByKonstAlphaStage()}}addRedOrBlueStage(e){const t=!(!(this.shader.lightFlags&f.OverrideLighting)||this.shader.normalFlags&p.HasVertexColor);this.setupShaderLayers(!0,t);const s=this.mb.genTevStage(),n=e?T.aw:T.vl,r=this.mb.genKonstColor(e=>{(0,T.z5)(e,n)});this.mb.setTevDirect(s),this.mb.setTevKColorSel(s,(0,x.IQ)(r)),this.mb.setTevKAlphaSel(s,(0,x.xF)(r)),this.mb.setTevOrder(s,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.KONST),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV)}rebuildSpecialized(){this.cprevIsValid=!1,this.aprevIsValid=!1,this.ambProbeTexCoord=void 0,this.enableHemisphericProbe=this.shader.hasHemisphericProbe,this.enableReflectiveProbe=this.shader.hasReflectiveProbe,this.mb.setUsePnMtxIdx(this.hasSkeleton);let e=0;if((this.enableHemisphericProbe||this.enableReflectiveProbe)&&this.shader.hasNBTTexture&&(e=this.addNBTTextureStage()),this.setupHemisphericProbe(),this.setupReflectiveProbe(),0!==e){const t=this.mb.genPostTexMtx(t=>{l.CV(t,[e,e,0])});this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0,i.b1.IDENTITY,!1,(0,x.U2)(t))}if(null!==this.shader.reflectiveProbeMaskTexId){this.texFetcher.getTexture(this.cache,this.shader.reflectiveProbeMaskTexId,!0);const e=this.mb.genTevStage();this.mb.setTevDirect(e),this.mb.setTevOrder(e,this.mb.getTexCoordCount(),this.mb.getTexMapCount(),i.Ug.COLOR_ZERO),this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.C2,i.CC.TEXC,i.CC.ZERO,void 0,void 0,void 0,void 0,i.UZ.REG2),this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO)}{const e=!(!(this.shader.lightFlags&f.OverrideLighting)||this.shader.normalFlags&p.HasVertexColor);this.setupShaderLayers(!0,e);const t=this.mb.genTevStage();this.mb.setTevDirect(t),this.mb.setTevOrder(t,null,null,i.Ug.COLOR0A0),this.enableHemisphericProbe?this.mb.setTevColorFormula(t,i.CC.ZERO,i.CC.CPREV,i.CC.C1,i.CC.C2):this.mb.setTevColorFormula(t,i.CC.ZERO,i.CC.CPREV,i.CC.RASC,i.CC.C2),this.mb.setTevAlphaFormula(t,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV),this.setupShaderLayers(!1,e),this.mb.getTevStageCount()<8&&this.addMistStages()}this.shader.lightFlags&f.OverrideLighting?(this.shader.normalFlags&p.HasVertexColor||this.shader.normalFlags&p.HasVertexAlpha?(this.mb.setAmbColor(0,(e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor),e.a=0}),this.mb.setChanCtrl(i.UQ.COLOR0,!0,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE),this.mb.setChanCtrl(i.UQ.ALPHA0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)):this.mb.setChanCtrl(i.UQ.COLOR0A0,!1,i.uj.REG,i.uj.REG,0,i.jN.NONE,i.bg.NONE),this.mb.setChanCtrl(i.UQ.COLOR1A1,!1,i.uj.REG,i.uj.REG,0,i.jN.NONE,i.bg.NONE)):(9&this.shader.lightFlags?1&this.shader.lightFlags?this.mb.setMatColor(0,e=>{(0,T.z5)(e,T.c)}):this.mb.setMatColor(0,e=>{(0,T.z5)(e,T.jR)}):(12&this.shader.lightFlags?this.mb.setAmbColor(0,e=>{(0,T.z5)(e,T.jR)}):this.mb.setAmbColor(0,(e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor),e.a=0}),this.mb.setMatColor(0,e=>{(0,T.z5)(e,T.c)})),this.mb.setChanCtrl(this.shader.normalFlags&p.HasVertexAlpha?i.UQ.COLOR0A0:i.UQ.COLOR0,!0,i.uj.REG,this.shader.normalFlags&p.HasVertexColor?i.uj.VTX:i.uj.REG,255,i.jN.CLAMP,i.bg.SPOT),this.mb.setChanCtrl(i.UQ.COLOR1A1,!1,i.uj.REG,i.uj.REG,0,i.jN.NONE,i.bg.NONE))}}class A extends _{rebuildInternal(){if(!this.factory.texturesEnabled){this.mb.setCullMode(i.Ac.NONE),this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA,i.Sn.NOOP),this.mb.setZMode(!0,i.oH.LEQUAL,!1),this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0);const e=this.mb.genTevStage();return this.mb.setTevDirect(e),this.mb.setTevOrder(e),this.mb.setTevColorFormula(e,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO),void this.mb.setTevAlphaFormula(e,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO)}this.mb.setTexMtx(0,(e,t)=>{(0,r.dr)(e,t.sceneCtx.viewerInput.camera,-t.sceneCtx.flipYScale),l.lK(e,e,t.modelToViewMtx)}),this.mb.setTexMtx(0,(e,t)=>{(0,r.dr)(e,t.sceneCtx.viewerInput.camera,-t.sceneCtx.flipYScale),l.lK(e,e,t.modelToViewMtx)}),this.mb.setTexMtx(1,(e,t)=>{(0,r.dr)(e,t.sceneCtx.viewerInput.camera,t.sceneCtx.flipYScale),l.lK(e,e,t.modelToViewMtx)}),this.mb.setTexMtx(3,(e,t)=>{l.D_(e),(0,o.ix)(e,1,3,t.sceneCtx.animController.envAnimValue0)});const e=this.mb.genTexMap(e=>{e.reset(),e.lateBinding="opaque-color-texture-downscale-2x",e.width=320,e.height=240}),t=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.TEXMTX0),s=this.mb.genTexMap(this.factory.getWavyTexture()),n=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0,i.b1.TEXMTX3),a=this.mb.genIndTexStage(),h=this.mb.genIndTexMtx(e=>{l.CV(e,[.5,.5,0]),l.Ny(e,e,1/4),(0,o.vi)(e,3,0,0,0,1)});this.mb.setIndTexOrder(a,n,s),this.mb.setIndTexScale(a,i.ru._1,i.ru._1);const c=l.vt();l.CV(c,[.83,.83,.83]);const u=l.vt();l.N9(u,Math.PI/4),l.lK(c,u,c),this.mb.setTexMtx(4,(e,t)=>{l.C(e,c),(0,o.ix)(e,0,3,t.sceneCtx.animController.envAnimValue1),(0,o.ix)(e,1,3,t.sceneCtx.animController.envAnimValue1)});const d=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0,i.b1.TEXMTX4),m=(0,o.Ac)(.3,.3,0,0,-.3,.3,0,0,0,0,0,0,0,0,0,1);l.Ny(m,m,1/16),(0,o.vi)(m,3,0,0,0,1);const p=this.mb.genIndTexMtx(e=>{l.C(e,m)}),f=this.mb.genIndTexStage();this.mb.setIndTexOrder(f,d,s),this.mb.setIndTexScale(f,i.ru._1,i.ru._1);const g=this.mb.genTevStage();this.mb.setTevIndirect(g,a,i.yU._8,i.QE.STU,(0,x.Mb)(h),i.D_._0,i.D_._0,!1,!1,i.zi.OFF),this.mb.setTevOrder(g),this.mb.setTevColorFormula(g,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO),this.mb.setTevAlphaFormula(g,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO);const v=this.mb.genKonstColor((e,t)=>{(0,T.gM)(e,1,1,1,96/255)}),C=this.mb.genTevStage();this.mb.setTevIndirect(C,f,i.yU._8,i.QE.STU,(0,x.Mb)(p),i.D_.OFF,i.D_.OFF,!0,!1,i.zi.OFF),this.mb.setTevKColorSel(C,(0,x.IQ)(v)),this.mb.setTevKAlphaSel(C,(0,x.xF)(v)),this.mb.setTevOrder(C,t,e),this.mb.setTevColorFormula(C,i.CC.KONST,i.CC.ZERO,i.CC.ZERO,i.CC.TEXC,i.fQ.ADD,i.bt.ZERO,i.mX.DIVIDE_2,!0,i.UZ.REG0),this.mb.setTevAlphaFormula(C,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.KONST,i.fQ.ADD,i.bt.ZERO,i.mX.SCALE_1,!0,i.UZ.REG0);const b=(0,o.Ac)(0,.5,0,0,-.5,0,0,0,0,0,0,0,0,0,0,1);l.Ny(b,b,1/32),(0,o.vi)(b,3,0,0,0,1);const _=this.mb.genIndTexMtx(e=>{l.C(e,b)}),y=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.POS,i.b1.TEXMTX1),S=this.mb.genTevStage();this.mb.setTevIndirect(S,a,i.yU._8,i.QE.STU,(0,x.Mb)(p),i.D_._0,i.D_._0,!1,!1,i.zi.OFF),this.mb.setTevOrder(S,null,null,i.Ug.COLOR0A0),this.mb.setTevColorFormula(S,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO),this.mb.setTevAlphaFormula(S,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO);const w=this.mb.genTevStage();this.mb.setTevIndirect(w,f,i.yU._8,i.QE.STU,(0,x.Mb)(_),i.D_.OFF,i.D_.OFF,!0,!1,i.zi.OFF),this.mb.setTevOrder(w,y,e,i.Ug.COLOR0A0),this.mb.setTevColorFormula(w,i.CC.TEXC,i.CC.C0,i.CC.A0,i.CC.ZERO),this.mb.setTevAlphaFormula(w,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.RASA),this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA,i.Sn.NOOP),this.mb.setCullMode(i.Ac.NONE),this.mb.setZMode(!0,i.oH.LEQUAL,!1),this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0),this.mb.setChanCtrl(i.UQ.COLOR0A0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)}}class E extends _{constructor(e,t,s,n,i){super(t),this.cache=e,this.shader=s,this.texFetcher=n,this.isMapBlock=i}rebuildInternal(){const e=this.mb.genTexMap(C(this.texFetcher.getTexture(this.cache,this.shader.layers[0].texId,!0))),t=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0),s=this.mb.genTevStage();this.mb.setTevDirect(s),this.mb.setTevOrder(s,t,e,i.Ug.COLOR0A0),this.mb.setTevColorFormula(s,i.CC.ZERO,i.CC.TEXC,i.CC.RASC,i.CC.ZERO),this.mb.setTevAlphaFormula(s,i.CA.ZERO,i.CA.TEXA,i.CA.RASA,i.CA.ZERO);const n=this.mb.genTexMap(this.factory.getWavyTexture());this.mb.setTexMtx(1,(e,t)=>{l.kN(e,[.25*t.sceneCtx.animController.envAnimValue0,.25*t.sceneCtx.animController.envAnimValue1,0]),(0,o.ix)(e,0,0,.0125),(0,o.ix)(e,1,1,.0125)});const r=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.POS,i.b1.TEXMTX1),a=this.mb.genIndTexStage();this.mb.setIndTexOrder(a,r,n),this.mb.setIndTexScale(a,i.ru._1,i.ru._1);const h=this.mb.genTexMap((c=this.factory,(e,t)=>{e.reset();const s=c.getFurFactory().getLayer(t.furLayer);e.gfxTexture=s.gfxTexture,e.gfxSampler=s.gfxSampler,e.width=s.width,e.height=s.height,e.lodBias=0}));var c;const u=(0,o.Ac)(.1,0,0,0,0,0,.1,0,0,0,0,0,0,0,0,1);this.mb.setTexMtx(0,e=>{l.C(e,u)});const d=this.mb.genTevStage(),m=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.POS,i.b1.TEXMTX0),p=this.mb.genIndTexMtx((e,t)=>{const s=(t.furLayer+1)/16*.5,n=s;(0,o.wX)(e,s,0,0,0,0,n,0,0,0,0,0,0,0,0,0,1),l.Ny(e,e,1/4)});this.mb.setTevIndirect(d,a,i.yU._8,i.QE.STU,(0,x.Mb)(p),i.D_.OFF,i.D_.OFF,!1,!1,i.zi.OFF),this.mb.setTevOrder(d,m,h),this.mb.setTevKColorSel(d,i.jl.KCSEL_4_8),this.mb.setTevColorFormula(d,i.CC.TEXC,i.CC.KONST,i.CC.CPREV,i.CC.CPREV,i.fQ.SUB,i.bt.ADDHALF),this.mb.setTevAlphaFormula(d,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO);const f=this.mb.genTexMap(this.factory.getRampTexture());this.mb.setTexMtx(2,(e,t)=>{(0,o.wX)(e,0,0,1/30,25/3,0,0,0,0,0,0,0,0,0,0,0,0),l.lK(e,e,t.modelToViewMtx)});const v=this.mb.genTevStage(),b=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.POS,i.b1.TEXMTX2);this.mb.setTevDirect(v),this.mb.setTevOrder(v,b,f),this.mb.setTevColorFormula(v,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.CPREV),this.mb.setTevAlphaFormula(v,i.CA.ZERO,i.CA.TEXA,i.CA.APREV,i.CA.ZERO),1&this.shader.flags||this.shader.flags&g.IndoorOutdoorBlend||2048&this.shader.flags||4096&this.shader.flags?(this.mb.setAmbColor(0,void 0),this.shader.flags&g.IndoorOutdoorBlend?this.mb.setChanCtrl(i.UQ.COLOR0,!0,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE):this.mb.setChanCtrl(i.UQ.COLOR0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)):(this.mb.setAmbColor(0,(e,t)=>{(0,T.z5)(e,t.outdoorAmbientColor)}),this.mb.setChanCtrl(i.UQ.COLOR0,!0,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE)),this.isMapBlock&&this.mb.setChanCtrl(i.UQ.ALPHA0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE),this.mb.setChanCtrl(i.UQ.COLOR1A1,!1,i.uj.REG,i.uj.REG,0,i.jN.NONE,i.bg.NONE),this.mb.setCullMode(i.Ac.BACK),this.mb.setZMode(!0,i.oH.LEQUAL,!1),this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA,i.Sn.NOOP),this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0)}}class R extends _{rebuildInternal(){const e=this.mb.genTexMap(e=>{e.reset(),e.lateBinding="opaque-color-texture-downscale-2x",e.width=320,e.height=240}),t=this.mb.genTexMap(e=>{e.reset(),e.lateBinding="opaque-depth-texture-downscale-2x",e.width=320,e.height=240}),s=this.mb.genTexMap(this.factory.getWavyTexture()),n=this.mb.genTexCoord(i.s3.MTX2x4,i.Kx.TEX0),r=this.mb.genPostTexMtx((e,t)=>{l.CV(e,[7,7,1]),(0,o.ix)(e,0,3,10*t.sceneCtx.animController.envAnimValue0),(0,o.ix)(e,1,3,10*-t.sceneCtx.animController.envAnimValue1)}),a=this.mb.genTexCoord(i.s3.MTX3x4,i.Kx.TEX0,void 0,void 0,(0,x.U2)(r)),h=this.mb.genKonstColor(e=>{(0,T.gM)(e,1,1,1,252/255)}),c=this.mb.genTevStage();this.mb.setTevDirect(c),this.mb.setTevOrder(c,n,t);const u=[i.R7.R,i.R7.R,i.R7.R,i.R7.R];this.mb.setTevSwapMode(c,void 0,u),this.mb.setTevKAlphaSel(c,(0,x.xF)(h)),this.mb.setTevColorFormula(c,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO),this.mb.setTevAlphaFormula(c,i.CA.KONST,i.CA.ZERO,i.CA.ZERO,i.CA.TEXA,i.fQ.SUB,void 0,i.mX.SCALE_4);const d=this.mb.genIndTexMtx((e,t)=>{let s=.5*Math.sin(3.142*t.sceneCtx.animController.envAnimValue0*10),n=.5*Math.cos(3.142*t.sceneCtx.animController.envAnimValue0*10);(0,o.wX)(e,n,s,0,0,-s,n,0,0,0,0,0,0,0,0,0,1),l.Ny(e,e,1/64)}),m=this.mb.genIndTexStage();this.mb.setIndTexOrder(m,a,s),this.mb.setIndTexScale(m,i.ru._1,i.ru._1);const p=this.mb.genTevStage();this.mb.setTevIndirect(p,m,i.yU._8,i.QE.STU,(0,x.Mb)(d),i.D_.OFF,i.D_.OFF,!1,!1,i.zi.OFF),this.mb.setTevOrder(p,n,e),this.mb.setTevColorFormula(p,i.CC.TEXC,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO),this.mb.setTevAlphaFormula(p,i.CA.ZERO,i.CA.ZERO,i.CA.ZERO,i.CA.APREV,void 0,void 0,i.mX.SCALE_4);const f=this.mb.genTevStage();this.mb.setTevDirect(f),this.mb.setTevOrder(f,void 0,void 0,i.Ug.COLOR0A0),this.mb.setTevColorFormula(f,i.CC.ZERO,i.CC.ZERO,i.CC.ZERO,i.CC.CPREV),this.mb.setTevAlphaFormula(f,i.CA.ZERO,i.CA.APREV,i.CA.RASA,i.CA.ZERO,void 0,void 0,i.mX.SCALE_4),this.mb.setChanCtrl(i.UQ.COLOR0A0,!1,i.uj.REG,i.uj.VTX,0,i.jN.NONE,i.bg.NONE),this.mb.setBlendMode(i.Nx.BLEND,i.dn.SRCALPHA,i.dn.INVSRCALPHA),this.mb.setZMode(!0,i.oH.LESS,!1),this.mb.setAlphaCompare(i.oH.ALWAYS,0,i.O2.AND,i.oH.ALWAYS,0)}}class I{initialize(){this.rampTexture=this.getRampTexture(),this.mapLightTexture=this.getMapLightTexture(),this.causticTexture=this.getCausticTexture(),this.wavyTexture=this.getWavyTexture(),this.halfGrayTexture=this.getHalfGrayTexture(),this.opaqueWhiteTexture=this.getOpaqueWhiteTexture(),this.transparentBlackTexture=this.getTransparentBlackTexture(),this.greenSphereMapTestTexture=this.getGreenSphereMapTestTexture(),this.sphereMapTestTexture=this.getSphereMapTestTexture(),this.furFactory=this.getFurFactory()}constructor(e){this.device=e,this.texturesEnabled=!0,this.rampGfxTexture=null,this.mapLightGfxTexture=null,this.causticGfxTexture=null,this.wavyGfxTexture=null,this.halfGrayGfxTexture=null,this.furFactory=null,this.scrollSlots=[],this.cache=new v.g(this.device)}update(e){for(let t=0;t<this.scrollSlots.length;t++){const s=this.scrollSlots[t];s.x=e.animController.getTimeInFrames()*s.dxPerFrame%b,s.y=e.animController.getTimeInFrames()*s.dyPerFrame%b}}addScrollSlot(e,t){return this.scrollSlots.push({x:0,y:0,dxPerFrame:e,dyPerFrame:t}),this.scrollSlots.length-1}buildObjectMaterial(e,t,s){return new w(this.cache,this,e,t,s)}buildMapMaterial(e,t){return new S(this.cache,this,e,t)}buildWaterMaterial(e){return new A(this)}buildFurMaterial(e,t,s,n){return new E(this.cache,this,e,t,n)}getFurFactory(){return null!==this.furFactory||(this.furFactory=new d(this.cache)),this.furFactory}genColorTexture(e,t,s,i){const r=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,1,1,1)),o=this.cache.createSampler({wrapS:n.Vf.Clamp,wrapT:n.Vf.Clamp,minFilter:n.gD.Point,magFilter:n.gD.Point,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),l=new Uint8Array(4);return function(e,t,s,n,i,r){l[0]=s,l[1]=n,l[2]=i,l[3]=r}(0,0,e,t,s,i),this.cache.device.uploadTextureData(r,0,[l]),new a.G7(r,o,1,1)}getHalfGrayTexture(){return void 0!==this.halfGrayTexture&&null!==this.halfGrayGfxTexture||(this.halfGrayTexture=C(this.genColorTexture(127,127,127,255))),this.halfGrayTexture}getOpaqueWhiteTexture(){return void 0===this.opaqueWhiteTexture&&(this.opaqueWhiteTexture=C(this.genColorTexture(255,255,255,255))),this.opaqueWhiteTexture}getTransparentBlackTexture(){return void 0===this.transparentBlackTexture&&(this.transparentBlackTexture=this.genColorTexture(0,0,0,0)),this.transparentBlackTexture}getGreenSphereMapTestTexture(){if(void 0===this.greenSphereMapTestTexture){const e=1024,t=1024,s=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,e,t,1)),i=this.cache.createSampler({wrapS:n.Vf.Clamp,wrapT:n.Vf.Clamp,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),r=new Uint8Array(4*e*t);function o(t,s,n){const i=4*(s*e+t);r[i]=255*n.r,r[i+1]=255*n.g,r[i+2]=255*n.b,r[i+3]=255*n.a}const l=(0,T.Zv)(T.gh);for(let c=0;c<t;c++){const u=2*c/(t-1)-1;for(let d=0;d<e;d++){const m=2*d/(e-1)-1,p=(0,h.qE)(m*m+u*u,0,1),f=1-Math.sqrt(1-p);(0,T.gM)(l,0,f,0,1),o(d,c,l)}}this.cache.device.uploadTextureData(s,0,[r]),this.greenSphereMapTestTexture=C(new a.G7(s,i,e,t))}return this.greenSphereMapTestTexture}getSphereMapTestTexture(){if(void 0===this.sphereMapTestTexture){const e=1024,t=1024,s=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,e,t,1)),i=this.cache.createSampler({wrapS:n.Vf.Clamp,wrapT:n.Vf.Clamp,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),r=new Uint8Array(4*e*t);function o(t,s,n){const i=4*(s*e+t);r[i]=255*n.r,r[i+1]=255*n.g,r[i+2]=255*n.b,r[i+3]=255*n.a}const l=(0,T.Zv)(T.gh);for(let c=0;c<t;c++){const u=2*c/(t-1)-1;for(let d=0;d<e;d++){const m=2*d/(e-1)-1,p=(0,h.qE)(m*m+u*u,0,1),f=1-Math.sqrt(1-p);(0,T.gM)(l,f,f,f,1),o(d,c,l)}}this.cache.device.uploadTextureData(s,0,[r]),this.sphereMapTestTexture=C(new a.G7(s,i,e,t))}return this.sphereMapTestTexture}getRampTexture(){if(void 0!==this.rampTexture&&null!==this.rampGfxTexture)return this.rampTexture;const e=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,256,4,1)),t=this.cache.createSampler({wrapS:n.Vf.Clamp,wrapT:n.Vf.Clamp,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),s=new Uint8Array(4096);function i(e,t,n,i,r,a){const o=4*(256*t+e);s[o]=n,s[o+1]=i,s[o+2]=r,s[o+3]=a}for(let e=0;e<256;e++){const t=e;for(let s=0;s<4;s++)i(e,s,t,t,t,t)}return this.cache.device.uploadTextureData(e,0,[s]),this.rampGfxTexture=new a.G7(e,t,256,4),this.rampTexture=C(this.rampGfxTexture),this.rampTexture}getCausticTexture(){if(void 0!==this.causticTexture&&null!==this.causticGfxTexture)return this.causticTexture;const e=128,t=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,e,128,1)),s=this.cache.createSampler({wrapS:n.Vf.Repeat,wrapT:n.Vf.Repeat,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),i=new Uint8Array(65536);function r(t,s,n,r,a,o){const l=4*(s*e+t);i[l]=n,i[l+1]=r,i[l+2]=a,i[l+3]=o}for(let t=0;t<128;t++){const s=(t-64)/64;for(let n=0;n<e;n++){const e=(n-64)/64;let i=Math.hypot(e,s);if(i<.25||.75<i)i=0;else{let e=2*(i-.25);e<=.5?e=.5-e:e-=.5,i=-(2*e-1),0<i&&(i=Math.sqrt(i))}const a=16*i;r(t,n,a,a,a,a)}}return this.cache.device.uploadTextureData(t,0,[i]),this.causticGfxTexture=new a.G7(t,s,e,128),this.causticTexture=C(this.causticGfxTexture),this.causticTexture}getMapLightTexture(){if(void 0!==this.mapLightTexture&&null!==this.mapLightGfxTexture)return this.mapLightTexture;const e=128,t=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,e,128,1)),s=this.cache.createSampler({wrapS:n.Vf.Clamp,wrapT:n.Vf.Clamp,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),i=new Uint8Array(65536);function r(t,s,n){const r=4*(s*e+t);i[r]=255*n.r,i[r+1]=255*n.g,i[r+2]=255*n.b,i[r+3]=255*n.a}const o=(0,T.Zv)(T.gh);for(let t=0;t<128;t++){const s=(t-64)/64;for(let n=0;n<e;n++){const e=(n-64)/64;let i=1-Math.hypot(e,s);i<0&&(i=0);const a=i;(0,T.gM)(o,a,a,a,a),r(n,t,o)}}return this.cache.device.uploadTextureData(t,0,[i]),this.mapLightGfxTexture=new a.G7(t,s,e,128),this.mapLightTexture=C(this.mapLightGfxTexture),this.mapLightTexture}getWavyTexture(){if(void 0!==this.wavyTexture&&null!==this.wavyGfxTexture)return this.wavyTexture;const e=this.cache.device.createTexture((0,n.xm)(n.$Y.U8_RGBA_NORM,64,64,1)),t=this.cache.createSampler({wrapS:n.Vf.Repeat,wrapT:n.Vf.Repeat,minFilter:n.gD.Bilinear,magFilter:n.gD.Bilinear,mipFilter:n.P.Nearest,minLOD:0,maxLOD:100}),s=new Uint8Array(16384);function i(e,t,n,i,r,a){const o=4*(64*t+e);s[o]=n,s[o+1]=i,s[o+2]=r,s[o+3]=a}for(let e=0;e<64;e++){let t=.0981875*e;for(let s=0;s<64;s++){const n=.39275*s,r=Math.cos(.5*Math.sin(n)+t),a=127*r+127;i(e,s,a,a,a,127*r*Math.cos(n)+127)}}return this.cache.device.uploadTextureData(e,0,[s]),this.wavyGfxTexture=new a.G7(e,t,64,64),this.wavyTexture=C(this.wavyGfxTexture),this.wavyTexture}destroy(e){var t;null!==this.halfGrayGfxTexture&&this.halfGrayGfxTexture.destroy(e),null!==this.rampGfxTexture&&this.rampGfxTexture.destroy(e),null!==this.causticGfxTexture&&this.causticGfxTexture.destroy(e),null!==this.mapLightGfxTexture&&this.mapLightGfxTexture.destroy(e),null!==this.wavyGfxTexture&&this.wavyGfxTexture.destroy(e),null===(t=this.furFactory)||void 0===t||t.destroy(e),this.cache.destroy()}}},3673(e,t,s){"use strict";s.d(t,{DPModelExhibitSceneDesc:()=>y,W:()=>b});var n=s(7684),i=s(329),r=s(8880),a=s(7459),o=s(353),l=s(8771),h=s(9667),c=s(3209),u=s(6223),d=s(8874),m=s(2141),p=s(6610),f=s(2007),g=s(7635),T=s(3793),x=s(393),v=s(305);class C extends d.G{constructor(e,t,s,n,i,r,a,o,l,h){super(e,t,s),this.context=e,this.materialFactory=s,this.texFetcher=n,this.modelFetcher=i,this.animColl=r,this.amapColl=a,this.modanimColl=o,this.gameInfo=l,this.modelVersion=h,this.turntableEnabled=!1,this.turntableAngle=0,this.turntableSpeed=Math.PI/8,this.modelInst=void 0,this.modelNum=1,this.modanim=null,this.amap=null,this.generatedAmap=null,this.anim=null,this.modelAnimNum=0,this.displayBones=!1,this.useGlobalAnimNum=!1,this.autogenAmap=!1,this.hasInitializedCamera=!1,this.animController.animController.playbackEnabled=!0,this.animController.animController.playbackEnabled=!0}createPanels(){const e=new r.Zk;e.setTitle(r.Kf,"Model Viewer"),e.elem.style.maxWidth="300px",e.elem.style.width="300px",this.modelSelect=new r.SX,this.modelSelect.ontext=e=>{const t=Number.parseInt(e);Number.isNaN(t)||(this.destroyCurrentModelResources(this.context.device),this.modelNum=t,console.log(`Requested model change to: ${this.modelNum}`))};const t=document.createElement("div");t.innerHTML="<label>Model Number:</label>",t.appendChild(this.modelSelect.elem),e.contents.append(t),this.animSelect=new r.SX,this.animSelect.ontext=e=>{const t=Number.parseInt(e);Number.isNaN(t)||(this.modelAnimNum=t,this.anim=null,this.generatedAmap=null)};const s=document.createElement("div");s.innerHTML="<label>Animation Number:</label>",s.appendChild(this.animSelect.elem),e.contents.append(s);const n=document.createElement("div");n.style.display="flex",n.style.gap="8px";const i=document.createElement("button");i.textContent="Previous Valid Model",i.onclick=async()=>{i.disabled=!0,await this.destroyCurrentModelResources(this.context.device),await this.loadPreviousValidModel(),i.disabled=!1};const a=document.createElement("button");a.textContent="Next Valid Model",a.onclick=async()=>{a.disabled=!0,await this.destroyCurrentModelResources(this.context.device),await this.loadNextValidModel(),a.disabled=!1},n.appendChild(i),n.appendChild(a),e.contents.append(n);const o=document.createElement("button");o.textContent="Enable Turntable",o.onclick=()=>{this.turntableEnabled=!this.turntableEnabled,o.textContent=this.turntableEnabled?"Disable Turntable":"Enable Turntable"},e.contents.append(o);const l=document.createElement("div"),h=document.createElement("input");h.type="number",h.step="0.1",h.value=this.turntableSpeed.toString(),h.style.width="100px",l.innerHTML="<label>Spin Speed (rad/s): </label>",l.appendChild(h),h.onchange=()=>{const e=Number.parseFloat(h.value);Number.isNaN(e)||(this.turntableSpeed=e)},e.contents.append(l);const c=document.createElement("div");c.style.display="flex",c.style.gap="8px";const u=document.createElement("button");u.textContent="Previous Animation",u.onclick=async()=>{u.disabled=!0,await this.loadPreviousValidAnim(),u.disabled=!1};const d=document.createElement("button");d.textContent="Next Animation",d.onclick=async()=>{d.disabled=!0,await this.loadNextValidAnim(),d.disabled=!1},c.appendChild(u),c.appendChild(d),e.contents.append(c);const m=new r.Sc("Display bones",!1);m.onchanged=()=>{this.displayBones=m.checked},e.contents.append(m.elem);const p=new r.Sc("Force T-Pose (Stop Animation)",!1);p.onchanged=()=>{var e;const t=this.animController.animController;p.checked?(t.playbackEnabled=!1,t.currentTimeInFrames=0,this.modelInst&&this.modelInst.resetPose(),this.anim=null,this.modelAnimNum=0,(null===(e=this.animSelect)||void 0===e?void 0:e.elem)instanceof HTMLInputElement&&(this.animSelect.elem.value=this.modelAnimNum.toString()),console.log("Animation stopped and model reset to T-pose.")):(t.playbackEnabled=!0,console.log("Animation playback re-enabled."))},e.contents.insertBefore(p.elem,m.elem);const f=new r.Sc("Use global animation number",!1);f.onchanged=()=>{this.useGlobalAnimNum=f.checked},e.contents.append(f.elem);const g=new r.Sc("Autogenerate AMAP",!1);return g.onchanged=()=>{this.autogenAmap=g.checked,this.generatedAmap=null},e.contents.append(g.elem),[e]}async destroyCurrentModelResources(e){console.log("Destroying and re-initializing resources..."),this.materialFactory&&this.materialFactory.destroy(e),this.materialFactory=new p.YS(e),this.materialFactory.initialize(),this.modelInst=void 0,this.anim=null,this.modanim=null,this.amap=null,this.generatedAmap=null,this.hasInitializedCamera=!1}downloadModel(){null!==this.modelInst&&void 0!==this.modelInst&&(0,x.Nz)(`model_${this.modelNum}${this.modelInst.model.version===T.o.Beta?"_beta":""}.bin`,v.A.fromView(this.modelInst.model.modelData))}setAmapNum(e){null===e?this.amap=null:(this.amap=this.amapColl.getAmap(e),this.amap?console.log(`Amap ${e} has ${this.amap.byteLength} entries`):console.warn(`Amap ${e} not found in collection.`))}getGlobalAnimNum(e){if(this.modanim){if(!(2*e>=this.modanim.byteLength))return(0,f.CV)(this.modanim,0,e);console.warn(`modelAnimNum ${e} is out of bounds for modanim (byteLength: ${this.modanim.byteLength}). Returning undefined.`)}}getAmapForModelAnim(e){const t=e=>{let t="";for(let s=0;s<e.byteLength;s++)t+=`${e.getInt8(s)},`;console.log(`Amap: ${t}`)};if(this.autogenAmap){if(null===this.generatedAmap){let e=[0],s=[0];for(;s.length>0;){const t=s;if(s=[],!this.modelInst||!this.modelInst.model||!this.modelInst.model.joints)return console.error("Cannot autogenAmap: modelInst or its joints are not available. Returning null."),null;for(let e=0;e<t.length;e++)for(let n=0;n<this.modelInst.model.joints.length;n++)this.modelInst.model.joints[n].parent===t[e]&&s.push(n);for(let t=0;t<s.length;t++)e.push(s[t])}this.generatedAmap=new DataView(new Int8Array(e).buffer),t(this.generatedAmap)}return this.generatedAmap}{if(!(this.amap&&this.modelInst&&this.modelInst.model&&this.modelInst.model.joints))return console.warn("Amap data or model joints not available for getAmapForModelAnim (autogenAmap is false). Returning null."),null;const s=8*((this.modelInst.model.joints.length+8)/8|0);if(e*s>=this.amap.byteLength)return console.warn(`modelAnimNum ${e} * stride ${s} is out of bounds for amap (byteLength: ${this.amap.byteLength}). Returning null.`),null;const n=(0,f.Y)(this.amap,e*s,s);return null===this.generatedAmap&&(this.generatedAmap=new DataView(new Int8Array(1).buffer),t(n)),n}}update(e){super.update(e),this.materialFactory.update(this.animController),this.turntableEnabled&&(this.turntableAngle+=e.deltaTime*this.turntableSpeed,this.turntableAngle>2*Math.PI&&(this.turntableAngle-=2*Math.PI))}addWorldRenderInsts(e,t,s,r){var c,d,m,p,f,g,T;if(void 0===this.modelInst){try{this.modelAnimNum=0,this.modanim=this.modanimColl.getModanim(this.modelNum),this.amap=this.amapColl.getAmap(this.modelNum);const e=this.modelFetcher.createModelInstance(this.modelNum);if(e instanceof Promise)return void e.then(e=>{this.modelInst=e,this.modelInst&&(this.modelInst.modanim=this.modanim,this.modelInst.amap=this.amap)}).catch(e=>{console.error(`Asynchronous model loading failed for ${this.modelNum}:`,e),this.modelInst=null});this.modelInst=e,this.modelInst&&(this.modelInst.modanim=this.modanim,this.modelInst.amap=this.amap)}catch(e){console.error(`Failed to load model ${this.modelNum} due to synchronous exception:`,e),this.modelInst=null}return}if(null===this.modelInst||void 0===this.modelInst)return;if(!this.hasInitializedCamera){const e=this.modelInst.model.bbox;if(e){const t=i.fA(.5*(e.minX+e.maxX),.5*(e.minY+e.maxY),.5*(e.minZ+e.maxZ));let s=Math.max(e.maxX-e.minX,e.maxY-e.minY,e.maxZ-e.minZ)*(1/Math.tan(r.viewerInput.camera.fovY/2)*.5);(0===s||Number.isNaN(s))&&(s=1e3);const n=r.viewerInput.camera;n.pitch=Math.PI/8,n.yaw=.25*Math.PI,n.target=t,n.zoom=1.5*s,this.hasInitializedCamera=!0}}if(this.animController.animController.playbackEnabled&&(null===(d=null===(c=this.modelInst)||void 0===c?void 0:c.model)||void 0===d?void 0:d.joints)&&this.modelInst.model.joints.length>0){if(null===this.anim)try{let e;e=this.useGlobalAnimNum?this.modelAnimNum:this.getGlobalAnimNum(this.modelAnimNum),void 0!==e?(this.anim=this.animColl.getAnim(e),(null===(f=null===(p=null===(m=this.anim)||void 0===m?void 0:m.keyframes)||void 0===p?void 0:p[0])||void 0===f?void 0:f.poses)||(this.anim=null)):this.anim=null}catch(e){this.anim=null}if(null!==this.anim)try{(0,u.hF)(.6*this.animController.animController.getTimeInSeconds(),this.modelInst,this.anim,this.modelAnimNum)}catch(e){this.anim=null,this.modelInst&&this.modelInst.resetPose()}}else null!==this.anim&&this.modelInst&&this.modelInst.resetPose(),this.anim=null;const x=t.pushTemplateRenderInst();(0,l.$7)(x,r.viewerInput);const v={sceneCtx:r,showDevGeometry:this.displayBones,ambienceIdx:0,showMeshes:!0,outdoorAmbientColor:a.c,setupLights:(e,t)=>{for(let t=0;t<8;t++){e[t]||(e[t]=new h.ve);const s=e[t];s.Position||(s.Position=i.vt()),s.Direction||(s.Direction=i.vt()),s.Color=(0,a.Zv)(a.c),i.hZ(s.Position,0,0,0),i.hZ(s.Direction,0,0,0),(0,h.eV)(s,0,0,0),(0,h.T3)(s,0,0)}const s=e[0];s.Color.r*=.5,s.Color.g*=.5,s.Color.b*=.5,s.Color.a=1;const n=e[1];n.Color.r=1,n.Color.g=1,n.Color.b=1,n.Color.a=1,i.hZ(n.Direction,.5,-1,.5),i.S8(n.Direction,n.Direction);for(let t=2;t<8;t++)e[t].Color.a=0},mapLights:void 0,cullByAabb:!1},C=n.vt();if(this.turntableEnabled){const e=i.vt(),t=null===(T=null===(g=this.modelInst)||void 0===g?void 0:g.model)||void 0===T?void 0:T.bbox;t&&(e[0]=.5*(t.minX+t.maxX),e[1]=.5*(t.minY+t.maxY),e[2]=.5*(t.minZ+t.maxZ));const s=n.vt(),r=n.vt(),a=n.vt(),o=i.fA(-e[0],-e[1],-e[2]);n.kN(s,o),n.kN(r,e),n.i1(a,this.turntableAngle),n.lK(C,a,s),n.lK(C,r,C)}const b=this.modelInst.modelShapes;if(b&&"function"==typeof b.fillMaterialParams&&b.fillMaterialParams(),null==b?void 0:b.shapes)for(const e of b.shapes)for(const t of e)t.visible=!0;if(this.modelInst&&this.modelInst.addRenderInsts(e,t,v,s,C),t.popTemplateRenderInst(),this.displayBones&&this.modelInst&&this.modelInst.model&&this.modelInst.skeletonInst){const e=(0,o.AN)();for(let t=1;t<this.modelInst.model.joints.length;t++){const s=this.modelInst.model.joints[t],a=n.o8(this.modelInst.skeletonInst.getJointMatrix(t));n.lK(a,a,C);const l=i.vt();if(n.sC(l,a),255!=s.parent){const t=n.o8(this.modelInst.skeletonInst.getJointMatrix(s.parent));n.lK(t,t,C);const a=i.vt();n.sC(a,t),(0,o.NB)(e,r.viewerInput.camera.clipFromWorldMatrix,a,l)}else(0,o.RM)(e,r.viewerInput.camera.clipFromWorldMatrix,l)}}}destroy(e){super.destroy(e),this.materialFactory&&this.materialFactory.destroy(e)}async loadNextValidModel(){var e,t,s,n;const i=this.modelNum;let r=this.modelNum;for(let a=1;a<=500&&(r++,r>65535&&(r=1),r!==i);a++)try{const i=this.modelFetcher.createModelInstance(r),a=i instanceof Promise?await i:i;if(!a||!(null===(t=null===(e=a.modelShapes)||void 0===e?void 0:e.shapes)||void 0===t?void 0:t.length)){this.modelInst=null;continue}this.modelNum=r,this.modelAnimNum=0,this.anim=null,this.generatedAmap=null,this.modanim=this.modanimColl.getModanim(this.modelNum),this.amap=this.amapColl.getAmap(this.modelNum),this.modelInst=a,this.modelInst.modanim=this.modanim,this.modelInst.amap=this.amap,(null===(s=this.modelSelect)||void 0===s?void 0:s.elem)instanceof HTMLInputElement&&(this.modelSelect.elem.value=this.modelNum.toString()),(null===(n=this.animSelect)||void 0===n?void 0:n.elem)instanceof HTMLInputElement&&(this.animSelect.elem.value=this.modelAnimNum.toString());const o=document.querySelector('input[type="checkbox"][title="Force T-Pose (Stop Animation)"]');return o&&o.checked?(this.animController.animController.playbackEnabled=!1,this.animController.animController.currentTimeInFrames=0,this.modelInst&&this.modelInst.resetPose(),this.anim=null):this.animController.animController.playbackEnabled=!0,void console.log(`Successfully loaded model: ${this.modelNum}`)}catch(e){console.warn(`Model ${r} threw error during validation:`,e),this.modelInst=null}console.warn("No valid models found after 500 tries.")}async loadPreviousValidModel(){var e,t,s,n;const i=this.modelNum;let r=this.modelNum;for(let a=1;a<=500;a++){if(r--,r<=0&&(r=65535),r===i){console.warn(`Wrapped back to starting model ${i}. No valid models found.`);break}try{const i=this.modelFetcher.createModelInstance(r),a=i instanceof Promise?await i:i;if(!a||!(null===(t=null===(e=a.modelShapes)||void 0===e?void 0:e.shapes)||void 0===t?void 0:t.length)){this.modelInst=null;continue}this.modelNum=r,this.modelAnimNum=0,this.anim=null,this.generatedAmap=null,this.modanim=this.modanimColl.getModanim(this.modelNum),this.amap=this.amapColl.getAmap(this.modelNum),this.modelInst=a,this.modelInst.modanim=this.modanim,this.modelInst.amap=this.amap,(null===(s=this.modelSelect)||void 0===s?void 0:s.elem)instanceof HTMLInputElement&&(this.modelSelect.elem.value=this.modelNum.toString()),(null===(n=this.animSelect)||void 0===n?void 0:n.elem)instanceof HTMLInputElement&&(this.animSelect.elem.value=this.modelAnimNum.toString());const o=document.querySelector('input[type="checkbox"][title="Force T-Pose (Stop Animation)"]');return o&&o.checked?(this.animController.animController.playbackEnabled=!1,this.animController.animController.currentTimeInFrames=0,this.modelInst&&this.modelInst.resetPose(),this.anim=null):this.animController.animController.playbackEnabled=!0,void console.log(`Successfully loaded model: ${this.modelNum}`)}catch(e){console.warn(`Model ${r} threw error during validation:`,e)}}console.warn("No valid models found after 500 tries.")}async loadNextValidAnim(){var e;const t=this.modelAnimNum;let s=this.modelAnimNum;console.log(`Searching for next valid animation starting from: ${t}`);for(let n=1;n<=500;n++){if(s++,s>1e3&&(s=0),s===t&&n>1){console.warn(`Wrapped back to starting animation ${t}. No other valid animations found.`);break}try{let t=s;if(this.useGlobalAnimNum||(t=this.getGlobalAnimNum(s)),void 0!==t){const n=this.animColl.getAnim(t);if(n&&n.keyframes&&n.keyframes.length>0&&n.keyframes[0]&&n.keyframes[0].poses){this.modelAnimNum=s,this.anim=n,this.generatedAmap=null,(null===(e=this.animSelect)||void 0===e?void 0:e.elem)instanceof HTMLInputElement&&(this.animSelect.elem.value=this.modelAnimNum.toString());const i=document.querySelector('input[type="checkbox"][title="Force T-Pose (Stop Animation)"]');return i&&i.checked?(this.animController.animController.playbackEnabled=!1,this.animController.animController.currentTimeInFrames=0,this.modelInst&&this.modelInst.resetPose()):this.animController.animController.playbackEnabled=!0,void console.log(`Successfully loaded animation: ${this.modelAnimNum} (Global: ${t})`)}}}catch(e){console.warn(`Animation ${s} threw error during validation:`,e)}}console.warn("No valid animations found after 500 tries.")}async loadPreviousValidAnim(){var e;const t=this.modelAnimNum;let s=this.modelAnimNum;console.log(`Searching for previous valid animation starting from: ${t}`);for(let n=1;n<=500;n++){if(s--,s<0&&(s=1e3),s===t&&n>1){console.warn(`Wrapped back to starting animation ${t}. No other valid animations found.`);break}try{let t=s;if(this.useGlobalAnimNum||(t=this.getGlobalAnimNum(s)),void 0!==t){const n=this.animColl.getAnim(t);if(n&&n.keyframes&&n.keyframes.length>0&&n.keyframes[0]&&n.keyframes[0].poses){this.modelAnimNum=s,this.anim=n,this.generatedAmap=null,(null===(e=this.animSelect)||void 0===e?void 0:e.elem)instanceof HTMLInputElement&&(this.animSelect.elem.value=this.modelAnimNum.toString());const i=document.querySelector('input[type="checkbox"][title="Force T-Pose (Stop Animation)"]');return i&&i.checked?(this.animController.animController.playbackEnabled=!1,this.animController.animController.currentTimeInFrames=0,this.modelInst&&this.modelInst.resetPose()):this.animController.animController.playbackEnabled=!0,void console.log(`Successfully loaded animation: ${this.modelAnimNum} (Global: ${t})`)}}}catch(e){console.warn(`Animation ${s} threw error during validation:`,e)}}console.warn("No valid animations found after 500 tries.")}}class b{constructor(e,t,s,n=c.$Q){this.id=e,this.name=t,this.modelVersion=s,this.gameInfo=n}async createScene(e,t){const s=new p.YS(e);s.initialize();const n=new u.X0,i=await u.y5.create(this.gameInfo,t.dataFetcher),r=await u.E0.create(this.gameInfo,t.dataFetcher),a=this.modelVersion===T.o.Beta,o=this.modelVersion===T.o.Demo,l=a?["swapcircle"]:o?["Copy of swaphol","insidegal","linklevel"]:["animtest","arwing","arwingcity","arwingcloud","arwingdarkice","arwingdragon","arwingtoplanet","bossdrakor","bossgaldon","bosstrex","capeclaw","clouddungeon","cloudrace","crfort","darkicemines","darkicemines2","dbshrine","desert","dfptop","dfshrine","dragrock","dragrockbot","ecshrine","gamefront","gpshrine","greatfox","icemountain","lightfoot","linka","linkb","linkc","linkd","linke","linkf","linkg","linkh","linki","linkj","magiccave","mazecave","mmpass","mmshrine","nwastes","nwshrine","shipbattle","shop","swaphol","swapholbot","volcano","wallcity","warlock","worldmap"],h=await g.JU.create(this.gameInfo,t.dataFetcher,this.modelVersion===T.o.Beta);await h.loadSubdirs(l,t.dataFetcher);const c=await m.Ju.create(this.gameInfo,Promise.resolve(h),s,n,this.modelVersion);await c.loadSubdirs(l,t.dataFetcher);const d=await u.K4.create(this.gameInfo,t.dataFetcher,l);return new C(t,n,s,h,c,d,r,i,this.gameInfo,this.modelVersion)}}class _{constructor(e,t,s,n){this.gameInfo=e,this.dataFetcher=t,this.texFetcher=s,this.materialFactory=n}static async create(e,t,s,n){return new _(e,t,s,n)}async createModelInstance(e){const t=`${this.gameInfo.pathBase}/uncompressed_models/${e}.bin`;try{const e=await this.dataFetcher.fetchData(t,{allow404:!0});if(0===e.byteLength)return null;const s=e.createDataView(),n=(0,T.c)(s,this.texFetcher,this.materialFactory,T.o.DinosaurPlanet);return new m.B_(n)}catch(t){return console.error(`[DPModelFetcher] Failed to parse model ${e}:`,t),null}}}class y{constructor(e,t,s=c.Dx){this.id=e,this.name=t,this.gameInfo=s}async createScene(e,t){const s=new p.YS(e);s.initialize();const n=new u.X0,i=await g.JU.create(this.gameInfo,t.dataFetcher,!0);await i.loadSubdirs([""],t.dataFetcher),i.setModelVersion(T.o.DinosaurPlanet);const r=await _.create(this.gameInfo,t.dataFetcher,i,s);return new C(t,n,s,i,r,{getAnim:()=>null},{getAmap:()=>null},{getModanim:()=>null},this.gameInfo,T.o.DinosaurPlanet)}}},3793(e,t,s){"use strict";s.d(t,{o:()=>z,c:()=>le});var n,i,r,a=s(329),o=s(305),l=s(9450),h=s(2003),c=s(5974),u=s(7459),d=s(6610),m=s(2007);const p=null!==(n=d.Y2.CLR)&&void 0!==n?n:1,f=null!==(i=d.Y2.TEX0)&&void 0!==i?i:4,g=null!==(r=d.Y2.TEX1)&&void 0!==r?r:8,T=new Set([899,2871]),x=(new Set([]),new Set([2373,2794,24,2871,713,611,2793])),v=new Set([3254,3272,3270,3246,3252,202,189,3248,3273]),C=new Set([630,646,672,1094,1098,1103,1107,1110,1111,1112]),b=new Set([1692,1135,1695,1131,176,783,785]),_=(new Set([678,675]),new Set([584,585,1061,1062,32728,682]),{size:68,numLayers:65,layers:36}),y={isBeta:!0,isEarly1:!0,size:64,numLayers:59,layers:36},S={isBeta:!0,isold:!0,size:64,numLayers:59,layers:36};function w(e,t,s){const n=e.getUint32(t);return 4294967295!==n?s[n]:null}function A(e,t){const s=e.getUint8(6);return{texId:w(e,0,t),tevMode:e.getUint8(4),enableScroll:e.getUint8(5),scrollSlot:s||void 0}}var E,R;function I(e,t,s,n,i,r){var a,o,l,h,c,_,y,S,I,k,M,P,D,B,L,O,F,U,N,X;const V={layers:[],flags:0,attrFlags:0,hasHemisphericProbe:!1,hasReflectiveProbe:!1,reflectiveProbeMaskTexId:null,reflectiveProbeIdx:0,reflectiveAmbFactor:0,hasNBTTexture:!1,nbtTexId:null,nbtParams:0,furRegionsTexId:null,color:(0,u.Zv)(u.c),normalFlags:n,lightFlags:i,texMtxCount:r};let G=e.getUint8(t.numLayers);G>2&&(console.warn(`Number of shader layers greater than maximum (${G} / 2)`),G=2);for(let n=0;n<G;n++){const i=A((0,m.Y)(e,t.layers+8*n),s);V.layers.push(i)}if(t.isAncient){V.isAncient=!0;const t=e.getUint8(56);let s=e.getUint8(57);V.flags=d.JL.CullBackface,V.attrFlags=s,null!=(null===(a=V.layers[0])||void 0===a?void 0:a.texId)&&(V.attrFlags|=f),null!=(null===(o=V.layers[1])||void 0===o?void 0:o.texId)&&(V.attrFlags|=g),0===V.attrFlags&&(V.attrFlags|=p);const n=V.layers[0],i=15&t,r=(13===i||12===i)&&null!=(null==n?void 0:n.texId)||1392===(null==n?void 0:n.texId)||24===(null==n?void 0:n.texId)||1234===(null==n?void 0:n.texId)||5678===(null==n?void 0:n.texId)||1391===(null==n?void 0:n.texId)||null!=(null==n?void 0:n.texId)&&x.has(n.texId);r&&(V.flags|=d.JL.Water);const l=1===V.layers.length,h=null!=(null==n?void 0:n.texId),c=n&&(0===n.tevMode||1===n.tevMode||2===n.tevMode),u=928===(null==n?void 0:n.texId)||791===(null==n?void 0:n.texId)||430===(null==n?void 0:n.texId)||573===(null==n?void 0:n.texId)||575===(null==n?void 0:n.texId)||576===(null==n?void 0:n.texId)||577===(null==n?void 0:n.texId)||2882===(null==n?void 0:n.texId)||44===(null==n?void 0:n.texId)||2046===(null==n?void 0:n.texId)||2228===(null==n?void 0:n.texId)||2467===(null==n?void 0:n.texId)||2538===(null==n?void 0:n.texId)||1798===(null==n?void 0:n.texId)||2791===(null==n?void 0:n.texId)||574===(null==n?void 0:n.texId)||684===(null==n?void 0:n.texId)||96===(null==n?void 0:n.texId)||740===(null==n?void 0:n.texId)||0===(null==n?void 0:n.texId)||595===(null==n?void 0:n.texId)||596===(null==n?void 0:n.texId)||593===(null==n?void 0:n.texId)||594===(null==n?void 0:n.texId)||592===(null==n?void 0:n.texId)||589===(null==n?void 0:n.texId)||null!=(null==n?void 0:n.texId)&&C.has(n.texId);return l&&h&&!r&&c&&u&&(V.flags|=d.JL.AlphaCompare),V}if(t.isSwapcircle){const t=e.getUint8(52),s=e.getUint8(53);V.isBeta=!0,V.flags=d.JL.CullBackface,V.attrFlags=s,null!=(null===(l=V.layers[0])||void 0===l?void 0:l.texId)&&(V.attrFlags|=f),null!=(null===(h=V.layers[1])||void 0===h?void 0:h.texId)&&(V.attrFlags|=g),0===(V.attrFlags&(p|f|g))&&(V.attrFlags|=p);const n=V.layers[0],i=V.layers[1],r=null!==(c=null==n?void 0:n.texId)&&void 0!==c?c:null,a=null!==(_=null==i?void 0:i.texId)&&void 0!==_?_:null,o=127&(null!==(y=null==n?void 0:n.tevMode)&&void 0!==y?y:0),u=127&(null!==(S=null==i?void 0:i.tevMode)&&void 0!==S?S:0),m=15&t,x=1===V.layers.length||V.layers.length>=2&&null==(null===(I=V.layers[1])||void 0===I?void 0:I.texId),w=null!=r,A=0===o||1===o||2===o||3===o,E=2===o||3===o||2===u||3===u,R=null!=r&&(v.has(r)||C.has(r)||void 0!==b&&b.has(r));return x&&w&&A&&R&&(V.flags|=d.JL.AlphaCompare),(null!=r&&T.has(r)||null!=a&&T.has(a)||w&&(E||13===m||12===m))&&(V.flags|=d.JL.Water),[r,a].some(e=>32928===e||584===e||1061===e||1062===e||585===e)&&(V.flags|=d.JL.Lava,V.flags&=~d.JL.Water),V.hasHemisphericProbe=1===e.getUint32(8),V.hasReflectiveProbe=1===e.getUint32(20),V.hasNBTTexture=!!(128&e.getUint8(55)),V}if(t.isBeta){if(V.isBeta=!0,V.attrFlags=d.Y2.CLR,V.flags=d.JL.CullBackface,t.isold){const t=e.getUint16(56),s=e.getUint8(58);V.attrFlags=s;let n=0;t&d.JL.CullBackface&&(n|=d.JL.CullBackface),2048&t&&(n|=2048),4096&t&&(n|=4096),V.flags=n;const i=V.layers[0],r=null!==(k=null==i?void 0:i.texId)&&void 0!==k?k:null,a=127&(null!==(M=null==i?void 0:i.tevMode)&&void 0!==M?M:0),o=2===a||3===a,l=15&t,h=1===V.layers.length||V.layers.length>=2&&null==(null===(P=V.layers[1])||void 0===P?void 0:P.texId),c=null!=r,u=0===a||1===a||2===a,m=177===r||526===r||525===r||982===r||536===r||1294===r||1295===r||418===r||88===r||571===r||44===r||668===r||417===r||2090===r||568===r||567===r||638===r||810===r||2094===r||691===r||944===r||7===r||769===r||767===r||1156===r||996===r||811===r||2056===r||189===r||176===r||null!=r&&C.has(r)||void 0!==b&&null!=r&&b.has(r);if(h&&c&&u&&m&&(V.flags|=d.JL.AlphaCompare),c&&!m){const e=T.has(r);(899===r||e||e&&o&&(13===l||12===l))&&(V.flags|=d.JL.Water),(457===r||584===r||1061===r||1062===r||585===r)&&(V.flags|=d.JL.Lava,V.flags&=~d.JL.Water)}return V}if(t.isEarly1){const t=e.getUint16(56);V.isBeta=!0,V.flags=function(e){let t=0;return e&E.CullBackface&&(t|=d.JL.CullBackface),e&E.ReflectSkyscape&&(t|=d.JL.ReflectSkyscape),e&E.AlphaCompareLo&&(t|=d.JL.AlphaCompare),e&E.AlphaCompareHi&&(t|=d.JL.AlphaCompare),e&E.ShortFur&&(t|=d.JL.ShortFur),e&E.MediumFur&&(t|=d.JL.MediumFur),t}(t),V.flags&=~d.JL.DevGeometry,V.attrFlags=e.getUint8(58),null!=(null===(D=V.layers[0])||void 0===D?void 0:D.texId)&&(V.attrFlags|=f),null!=(null===(B=V.layers[1])||void 0===B?void 0:B.texId)&&(V.attrFlags|=g),0===(V.attrFlags&(p|f|g))&&(V.attrFlags|=p);const s=127&(null!==(O=null===(L=V.layers[0])||void 0===L?void 0:L.tevMode)&&void 0!==O?O:0),n=127&(null!==(U=null===(F=V.layers[1])||void 0===F?void 0:F.tevMode)&&void 0!==U?U:0),i=15&t;return 12!==i&&13!==i||!(2===s||3===s||2===n||3===n)||(V.flags|=d.JL.Water),(0,u.gM)(V.color,e.getUint8(4)/255,e.getUint8(5)/255,e.getUint8(6)/255,1),V}if(t.isEarly3){const t=e.getUint16(60);return V.isBeta=!0,V.flags=function(e){let t=0;return e&R.DevGeometry&&(t|=d.JL.DevGeometry),e&R.Fog&&(t|=d.JL.Fog),e&R.CullBackface&&(t|=d.JL.CullBackface),e&R.ReflectSkyscape&&(t|=d.JL.ReflectSkyscape),e&R.Caustic&&(t|=d.JL.Caustic),e&R.Reflective&&(t|=d.JL.Reflective),e&R.AlphaCompareLo&&(t|=d.JL.AlphaCompare),e&R.AlphaCompareHi&&(t|=d.JL.AlphaCompare),t}(t),V.attrFlags=e.getUint8(62),null!=(null===(N=V.layers[0])||void 0===N?void 0:N.texId)&&(V.attrFlags|=f),null!=(null===(X=V.layers[1])||void 0===X?void 0:X.texId)&&(V.attrFlags|=g),0===(V.attrFlags&(p|f|g))&&(V.attrFlags|=p),V.hasHemisphericProbe=0!==e.getUint32(8),V.hasReflectiveProbe=0!==e.getUint32(20),V.reflectiveProbeMaskTexId=w(e,24,s),V.reflectiveProbeIdx=e.getUint8(32),V.reflectiveAmbFactor=e.getUint8(34)/255,V.nbtTexId=w(e,52,s),V.hasNBTTexture=null!==V.nbtTexId,V.nbtParams=e.getUint8(66),V.furRegionsTexId=w(e,56,s),(0,u.gM)(V.color,e.getUint8(4)/255,e.getUint8(5)/255,e.getUint8(6)/255,1),V}}else V.flags=e.getUint32(60),V.attrFlags=e.getUint8(64),V.hasHemisphericProbe=0!==e.getUint32(8),V.hasReflectiveProbe=0!==e.getUint32(20),V.reflectiveProbeMaskTexId=w(e,24,s),V.reflectiveProbeIdx=e.getUint8(32),V.reflectiveAmbFactor=e.getUint8(34)/255,V.nbtTexId=w(e,52,s),V.hasNBTTexture=null!==V.nbtTexId,V.nbtParams=e.getUint8(66),V.furRegionsTexId=w(e,56,s),(0,u.gM)(V.color,e.getUint8(4)/255,e.getUint8(5)/255,e.getUint8(6)/255,1);return V}!function(e){e[e.CullBackface=8]="CullBackface",e[e.ReflectSkyscape=32]="ReflectSkyscape",e[e.AlphaCompareLo=64]="AlphaCompareLo",e[e.AlphaCompareHi=256]="AlphaCompareHi",e[e.ShortFur=16384]="ShortFur",e[e.MediumFur=32768]="MediumFur"}(E||(E={})),function(e){e[e.DevGeometry=2]="DevGeometry",e[e.Fog=4]="Fog",e[e.CullBackface=8]="CullBackface",e[e.ReflectSkyscape=32]="ReflectSkyscape",e[e.Caustic=64]="Caustic",e[e.Reflective=256]="Reflective",e[e.AlphaCompareLo=1024]="AlphaCompareLo",e[e.AlphaCompareHi=16384]="AlphaCompareHi"}(R||(R={}));var k=s(2141),M=s(7684),P=s(7639),D=s(7714),B=s(7911),L=s(930),O=s(8771),F=s(5339),U=s(8874),N=s(5730);class X{constructor(e,t,s,n,i,r){this.loadedVertexLayout=s,this.loadedVertexData=n,this.vertexBufferDescriptors=[],this.vertexBuffers=[];for(let t=0;t<n.vertexBuffers.length;t++){const s=e.createBuffer((n.vertexBuffers[t].byteLength+3)/4,D.B6.Vertex,i?D.R6.Dynamic:D.R6.Static);this.vertexBuffers.push(s),this.vertexBufferDescriptors.push({buffer:s,byteOffset:0})}this.inputLayout=(0,O.D9)(t,s),this.indexBuffer=e.createBuffer((n.indexData.byteLength+3)/4,D.B6.Index,r?D.R6.Dynamic:D.R6.Static),this.indexBufferDescriptor={buffer:this.indexBuffer,byteOffset:0},this.uploadData(e,!0,!0)}uploadData(e,t,s){if(t)for(let t=0;t<this.loadedVertexData.vertexBuffers.length;t++)e.uploadBufferData(this.vertexBuffers[t],0,new Uint8Array(this.loadedVertexData.vertexBuffers[t]));s&&e.uploadBufferData(this.indexBuffer,0,new Uint8Array(this.loadedVertexData.indexData))}setOnRenderInst(e,t=null){e.setVertexInput(this.inputLayout,this.vertexBufferDescriptors,this.indexBufferDescriptor),null!==t?e.setDrawCount(t.indexCount,t.indexOffset):e.setDrawCount(this.loadedVertexData.totalIndexCount)}destroy(e){for(let t of this.vertexBuffers)e.destroyBuffer(t);e.destroyBuffer(this.indexBuffer)}}const V=M.vt(),G=M.vt(),K=a.vt();class ${constructor(e,t,s,n,i){this.vtxArrays=e,this.isDynamic=i,this.shapeHelper=null,this.drawParams=new O.$r,this.verticesDirty=!0,this.pnMatrixMap=(0,c.y5)(10,()=>0),this.normalMatrixInTexMatrixCount=0,this.hasSkinning=!1,this.hasFineSkinning=!1,this.vtxLoader=(0,L.hj)(s,t),this.loadedVertexData=this.vtxLoader.parseDisplayList(o.A.fromView(n)),this.vtxLoader=(0,L.Cy)(this.vtxLoader,this.loadedVertexData),this.reloadVertices()}reloadVertices(){this.vtxLoader.loadVertexData(this.loadedVertexData,this.vtxArrays),this.verticesDirty=!0}setBoundingBox(e){this.aabb=e.clone()}setSortLayer(e){this.sortLayer=e}setPnMatrixMap(e,t,s){for(let t=0;t<e.length;t++)this.pnMatrixMap[t]=e[t];this.normalMatrixInTexMatrixCount=e.length,this.hasSkinning=t,this.hasFineSkinning=s}setOnRenderInst(e,t,s,n,i,r,a,o){null===this.shapeHelper&&(this.shapeHelper=new X(e,t.gfxRenderCache,this.vtxLoader.loadedVertexLayout,this.loadedVertexData,this.isDynamic,!1),this.verticesDirty=!1),this.verticesDirty&&(this.shapeHelper.uploadData(e,!0,!1),this.verticesDirty=!1),this.shapeHelper.setOnRenderInst(s),this.drawParams.clear();const l=V;(0,P.sq)(l,r);const h=G;if(M.lK(h,l,n),void 0!==o?s.sortKey=(0,B.Nj)(s.sortKey,B.EZ.TRANSLUCENT+o):void 0!==this.sortLayer?s.sortKey=(0,B.Nj)(s.sortKey,B.EZ.TRANSLUCENT+this.sortLayer):s.sortKey=(0,B.Nj)(s.sortKey,B.EZ.TRANSLUCENT),void 0!==a)s.sortKey=(0,B.ze)(s.sortKey,a);else if(void 0!==this.aabb){this.aabb.centerPoint(K),(0,F.Ye)(K,h,K);const e=-K[2];s.sortKey=(0,B.ze)(s.sortKey,e)}for(let e=0;e<this.drawParams.u_PosMtx.length;e++)this.hasFineSkinning&&9===e?M.C(this.drawParams.u_PosMtx[e],h):M.lK(this.drawParams.u_PosMtx[e],h,i[this.pnMatrixMap[e]])}getDrawParams(){return this.drawParams}destroy(e){null!==this.shapeHelper&&(this.shapeHelper.destroy(e),this.shapeHelper=null)}}const W=new l.F5;class H{constructor(e){this.material=e}setMaterial(e){this.material=e}setOnMaterialParams(e,t,s,n,i){var r,o;if(void 0===this.matCtx&&(this.matCtx={sceneCtx:n.modelCtx.sceneCtx,modelToViewMtx:M.vt(),viewToModelMtx:M.vt(),ambienceIdx:n.modelCtx.ambienceIdx,outdoorAmbientColor:(0,u.gv)(1,1,1,1),furLayer:null!==(r=i.furLayer)&&void 0!==r?r:0}),this.matCtx.sceneCtx=n.modelCtx.sceneCtx,this.matCtx.ambienceIdx=n.modelCtx.ambienceIdx,(0,u.z5)(this.matCtx.outdoorAmbientColor,n.modelCtx.outdoorAmbientColor),this.matCtx.furLayer=null!==(o=i.furLayer)&&void 0!==o?o:0,M.lK(this.matCtx.modelToViewMtx,this.matCtx.sceneCtx.worldToViewMtx,s),M.B8(this.matCtx.viewToModelMtx,this.matCtx.modelToViewMtx),n.setupLights(e.u_Lights),n.modelCtx.mapLights=[],void 0!==n.modelCtx.sceneCtx.world&&void 0!==t.aabb&&this.material instanceof d.RT){W.copy(t.aabb),W.transform(W,s);const e=2,i=n.modelCtx.sceneCtx.world.worldLights.probeLightsOnMapBox(W,N.zY.POINT,e);for(let t=0;t<i.length&&t<e;t++){const e=K;i[t].getPosition(e),(0,F.Ye)(e,this.matCtx.sceneCtx.worldToViewMtx,e),n.modelCtx.mapLights.push({radius:i[t].radius,color:i[t].color,viewPosition:a.o8(e)})}}this.matCtx.mapLights=n.modelCtx.mapLights,this.material.setOnMaterialParams(e,this.matCtx)}getGXMaterialHelper(){return this.material.getGXMaterialHelper()}}const Y=new O.gA;class Z{constructor(e,t,s){this.geom=e,this.material=t,this.isDevGeometry=s}reloadVertices(){this.geom.reloadVertices()}setOnRenderInst(e,t,s,n,i,r,a,o,l){this.geom.setOnRenderInst(e,t,s,n,a,i.modelCtx.sceneCtx.viewerInput.camera,o,l),this.material.setOnMaterialParams(Y,this.geom,n,i,r);const h=this.geom.getDrawParams();if(this.geom.hasSkinning&&void 0!==i.modelCtx.object){const e=M.vt(),t=1/i.modelCtx.object.scale;M.CV(e,[t,t,t]);for(let t=0;t<h.u_PosMtx.length;t++)M.C(Y.u_TexMtx[t],h.u_PosMtx[t]),(0,m.Ir)(Y.u_TexMtx[t],0,0,0),M.lK(Y.u_TexMtx[t],Y.u_TexMtx[t],e)}const c=this.material.getGXMaterialHelper();(0,U.g)(t,s,c,Y,h)}addRenderInsts(e,t,s,n,i,r,a,o){const l=t.newRenderInst();this.setOnRenderInst(e,t,l,s,n,i,r,a,o),t.submitRenderInst(l)}destroy(e){this.geom.destroy(e)}}var z,j=s(8192);function q(e){return{offset:e.getUint32(0),size:e.getUint16(4),aabb:new l.F5(e.getInt16(6)/8,e.getInt16(8)/8,e.getInt16(10)/8,e.getInt16(12)/8,e.getInt16(14)/8,e.getInt16(16)/8),specialBitAddress:e.getUint16(20),sortLayer:e.getUint8(24)}}!function(e){e[e.AncientMap=0]="AncientMap",e[e.Beta=1]="Beta",e[e.BetaMap=2]="BetaMap",e[e.Demo=3]="Demo",e[e.cloudtreasure=4]="cloudtreasure",e[e.DemoMap=5]="DemoMap",e[e.Final=6]="Final",e[e.FinalMap=7]="FinalMap",e[e.fear=8]="fear",e[e.dfpt=9]="dfpt",e[e.dup=10]="dup",e[e.Early1=11]="Early1",e[e.Early2=12]="Early2",e[e.Early3=13]="Early3",e[e.Early4=14]="Early4",e[e.DinosaurPlanet=15]="DinosaurPlanet"}(z||(z={}));const Q=116;function J(e){return{numPieces:e.getUint16(2),quantizeScale:e.getUint8(6)}}function ee(e){return{skinDataSrcOffs:e.getUint32(96),weightsSrc:e.getUint32(100),bone0:e.getUint8(108),bone1:e.getUint8(109),weightsBlockCount:e.getUint8(111),numVertices:e.getUint16(112),skinMeOffset:e.getUint8(114),skinSrcBlockCount:e.getUint8(115)}}function te(e,t){const s=(0,c.y5)(8,()=>[]);for(let e=0;e<=h.cg.MAX;e++)for(let t=0;t<8;t++)s[t][e]={compType:h.aL.U8,compShift:0,compCnt:0};return s[0][h.cg.POS]={compType:h.aL.S16,compShift:0,compCnt:h.xA.POS_XYZ},s[0][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},s[0][h.cg.TEX0]={compType:h.aL.S16,compShift:7,compCnt:h.xA.TEX_ST},s[1][h.cg.POS]={compType:h.aL.S16,compShift:2,compCnt:h.xA.POS_XYZ},s[1][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},s[1][h.cg.TEX0]={compType:h.aL.F32,compShift:0,compCnt:h.xA.TEX_ST},s[2][h.cg.POS]={compType:h.aL.F32,compShift:0,compCnt:h.xA.POS_XYZ},s[2][h.cg.NRM]={compType:h.aL.F32,compShift:0,compCnt:h.xA.NRM_XYZ},s[2][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},s[2][h.cg.TEX0]={compType:h.aL.F32,compShift:0,compCnt:h.xA.TEX_ST},s[2][h.cg.TEX1]={compType:h.aL.F32,compShift:0,compCnt:h.xA.TEX_ST},s[3][h.cg.POS]={compType:h.aL.S16,compShift:8,compCnt:h.xA.POS_XYZ},s[3][h.cg.NRM]={compType:h.aL.S8,compShift:0,compCnt:t?h.xA.NRM_NBT:h.xA.NRM_XYZ},s[3][h.cg.CLR0]={compType:h.aL.RGBA4,compShift:0,compCnt:h.xA.CLR_RGBA},s[3][h.cg.TEX0]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[3][h.cg.TEX1]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[3][h.cg.TEX2]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[3][h.cg.TEX3]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[4][h.cg.POS]={compType:h.aL.F32,compShift:0,compCnt:h.xA.POS_XYZ},s[4][h.cg.NRM]={compType:h.aL.F32,compShift:0,compCnt:h.xA.NRM_XYZ},s[4][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},s[4][h.cg.TEX0]={compType:h.aL.S16,compShift:7,compCnt:h.xA.TEX_ST},s[5][h.cg.POS]={compType:h.aL.S16,compShift:e?0:3,compCnt:h.xA.POS_XYZ},s[5][h.cg.NRM]={compType:h.aL.S8,compShift:0,compCnt:t?h.xA.NRM_NBT:h.xA.NRM_XYZ},s[5][h.cg.CLR0]={compType:h.aL.RGBA4,compShift:0,compCnt:h.xA.CLR_RGBA},s[5][h.cg.TEX0]={compType:h.aL.S16,compShift:8,compCnt:h.xA.TEX_ST},s[5][h.cg.TEX1]={compType:h.aL.S16,compShift:8,compCnt:h.xA.TEX_ST},s[5][h.cg.TEX2]={compType:h.aL.S16,compShift:8,compCnt:h.xA.TEX_ST},s[5][h.cg.TEX3]={compType:h.aL.S16,compShift:8,compCnt:h.xA.TEX_ST},s[6][h.cg.POS]={compType:h.aL.S16,compShift:8,compCnt:h.xA.POS_XYZ},s[6][h.cg.NRM]={compType:h.aL.S8,compShift:0,compCnt:t?h.xA.NRM_NBT:h.xA.NRM_XYZ},s[6][h.cg.CLR0]={compType:h.aL.RGBA4,compShift:0,compCnt:h.xA.CLR_RGBA},s[6][h.cg.TEX0]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[6][h.cg.TEX1]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[6][h.cg.TEX2]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[6][h.cg.TEX3]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[7][h.cg.POS]={compType:h.aL.S16,compShift:0,compCnt:h.xA.POS_XYZ},s[7][h.cg.NRM]={compType:h.aL.S8,compShift:0,compCnt:t?h.xA.NRM_NBT:h.xA.NRM_XYZ},s[7][h.cg.CLR0]={compType:h.aL.RGBA4,compShift:0,compCnt:h.xA.CLR_RGBA},s[7][h.cg.TEX0]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[7][h.cg.TEX1]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[7][h.cg.TEX2]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s[7][h.cg.TEX3]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST},s}const se=te(!1,!1),ne=te(!1,!0),ie=te(!0,!1),re=te(!0,!0),ae={[z.AncientMap]:{isBeta:!0,isMapBlock:!0,shaderFields:{isAncient:!0,size:60,numLayers:58,layers:36},hasNormals:!1,hasBones:!1,texOffset:88,posOffset:92,clrOffset:96,texcoordOffset:100,shaderOffset:104,listOffsets:108,listSizes:112,posCount:144,clrCount:148,texcoordCount:152,texCount:153,shaderCount:154,dlOffsets:108,dlSizes:112,dlInfoCount:153,numListBits:6,bitsOffsets:[124],bitsByteCounts:[134],oldVat:!0,hasYTranslate:!1},[z.Beta]:{isBeta:!0,isMapBlock:!1,shaderFields:{isBeta:!0,size:56,numLayers:54,layers:32},hasNormals:!0,hasBones:!0,texOffset:28,posOffset:36,nrmOffset:40,clrOffset:44,texcoordOffset:48,shaderOffset:52,jointOffset:56,listOffsets:108,listSizes:112,posCount:158,nrmCount:160,clrCount:162,texcoordCount:164,texCount:170,jointCount:171,posFineSkinningConfig:100,posFineSkinningPieces:128,posFineSkinningWeights:132,weightCount:173,shaderCount:174,texMtxCount:175,dlOffsets:136,dlSizes:140,dlInfoCount:172,numListBits:6,bitsOffsets:[144],bitsByteCounts:[148],oldVat:!0,hasYTranslate:!1},[z.BetaMap]:{isBeta:!0,isMapBlock:!0,shaderFields:{isBeta:!0,isSwapcircle:!0,size:56,numLayers:54,layers:32},hasNormals:!1,hasBones:!1,texOffset:88,posOffset:92,clrOffset:96,texcoordOffset:100,shaderOffset:104,listOffsets:108,listSizes:112,posCount:158,clrCount:162,texcoordCount:164,texCount:152,shaderCount:153,texMtxCount:175,dlOffsets:108,dlSizes:112,dlInfoCount:153,numListBits:6,bitsOffsets:[124],bitsByteCounts:[148],oldVat:!0,hasYTranslate:!1},[z.Demo]:{isMapBlock:!1,texOffset:32,texCount:218,posOffset:40,posCount:204,hasNormals:!0,nrmOffset:44,nrmCount:206,clrOffset:48,clrCount:208,texcoordOffset:52,texcoordCount:210,hasBones:!0,jointOffset:60,jointCount:219,weightOffset:84,weightCount:220,posFineSkinningConfig:136,posFineSkinningPieces:164,posFineSkinningWeights:168,nrmFineSkinningConfig:172,shaderOffset:56,shaderCount:222,shaderFields:{isBeta:!0,isEarly1:!0,size:64,numLayers:59,layers:36},dlInfoOffset:184,dlInfoCount:201,dlInfoSize:52,numListBits:8,bitsOffsets:[188],bitsByteCounts:[192],oldVat:!0,hasYTranslate:!1},[z.DemoMap]:{isMapBlock:!0,texOffset:84,texCount:160,posOffset:88,posCount:144,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:148,texcoordOffset:96,texcoordCount:150,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:y,dlInfoOffset:104,dlInfoCount:159,dlInfoSize:52,numListBits:8,bitsOffsets:[116],bitsByteCounts:[132],oldVat:!0,hasYTranslate:!1},[z.Final]:{isFinal:!0,isMapBlock:!1,texOffset:32,texCount:242,posOffset:40,posCount:228,hasNormals:!0,nrmOffset:44,nrmCount:230,clrOffset:48,clrCount:232,texcoordOffset:52,texcoordCount:234,hasBones:!0,jointOffset:60,jointCount:243,weightOffset:84,weightCount:244,posFineSkinningConfig:136,posFineSkinningPieces:164,posFineSkinningWeights:168,nrmFineSkinningConfig:172,nrmFineSkinningPieces:200,nrmFineSkinningWeights:204,shaderOffset:56,shaderCount:248,shaderFields:_,texMtxCount:250,dlInfoOffset:208,dlInfoCount:245,dlInfoSize:28,numListBits:8,bitsOffsets:[212],bitsByteCounts:[216],oldVat:!1,hasYTranslate:!1},[z.FinalMap]:{isFinal:!0,isMapBlock:!0,texOffset:84,texCount:160,posOffset:88,posCount:144,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:148,texcoordOffset:96,texcoordCount:150,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:162,shaderFields:_,dlInfoOffset:104,dlInfoCount:161,dlInfoSize:28,numListBits:8,bitsOffsets:[120,124,128],bitsByteCounts:[132,134,136],oldVat:!1,hasYTranslate:!0},[z.fear]:{isBeta:!1,isMapBlock:!0,texOffset:88,texCount:164,posOffset:92,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:96,clrCount:146,texcoordOffset:100,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:104,shaderCount:166,shaderFields:S,dlInfoOffset:108,dlInfoCount:165,dlInfoSize:52,numListBits:6,bitsOffsets:[120,128,136],bitsByteCounts:[124,132,140],oldVat:!0,hasYTranslate:!1},[z.dfpt]:{isBeta:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:S,dlInfoOffset:104,dlInfoCount:159,dlInfoSize:52,numListBits:6,bitsOffsets:[116,124,132],bitsByteCounts:[134,136,138],oldVat:!0,hasYTranslate:!1},[z.dup]:{isBeta:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:y,dlInfoOffset:104,dlInfoCount:159,dlInfoSize:52,numListBits:8,bitsOffsets:[116,124,132],bitsByteCounts:[134,136,138],oldVat:!0,hasYTranslate:!1},[z.Early1]:{isBeta:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:y,dlInfoOffset:104,dlInfoCount:159,dlInfoSize:52,numListBits:8,bitsOffsets:[116,124,132],bitsByteCounts:[134,136,138],oldVat:!0,hasYTranslate:!1},[z.Early2]:{isfinal:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:{isBeta:!0,isEarly3:!0,size:68,numLayers:63,layers:36},dlInfoOffset:104,dlInfoCount:159,dlInfoSize:56,numListBits:8,bitsOffsets:[116,124,132],bitsByteCounts:[132,134,136],oldVat:!0,hasYTranslate:!1},[z.Early3]:{isFinal:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:{isBeta:!0,isEarly3:!0,size:68,numLayers:63,layers:36},dlInfoOffset:104,dlInfoCount:159,dlInfoSize:56,numListBits:8,bitsOffsets:[120,124,128],bitsByteCounts:[132,134,136],oldVat:!0,hasYTranslate:!1},[z.Early4]:{isFinal:!1,isMapBlock:!0,texOffset:84,texCount:158,posOffset:88,posCount:142,hasNormals:!1,nrmOffset:0,nrmCount:0,clrOffset:92,clrCount:146,texcoordOffset:96,texcoordCount:148,hasBones:!1,jointOffset:0,jointCount:0,shaderOffset:100,shaderCount:160,shaderFields:_,dlInfoOffset:104,dlInfoCount:159,dlInfoSize:56,numListBits:8,bitsOffsets:[120,124,128],bitsByteCounts:[132,134,136],oldVat:!0,hasYTranslate:!1}};var oe;async function le(e,t,s,n){var i,r,u;if(function(e,t=256){for(let s=0;s<t;s+=16){const t=[];for(let n=0;n<16;n++)s+n<e.byteLength?t.push(e.getUint8(s+n).toString(16).padStart(2,"0")):t.push(" ")}}(e,256),n===z.DinosaurPlanet)return function(e,t,s){const n=new k.Kx(z.DinosaurPlanet),i=e.getUint32(0);if(e.getUint32(12)>i){n.isMapBlock=!1;const i=e.getUint32(4),r=e.getUint32(8),u=e.getUint32(12),m=e.getUint32(32),p=Math.min(e.getUint16(100),2e3),f=Math.min(e.getUint8(111),200),g=[];for(let t=0;t<f;t++){const s=m+16*t;if(s+16>e.byteLength){g.push(a.vt());continue}const n=e.getUint8(s+0),i=e.getFloat32(s+4,!1),r=e.getFloat32(s+8,!1),o=e.getFloat32(s+12,!1),l=a.fA(i,r,o);255!==n&&n<t&&n<g.length&&a.WQ(l,l,g[n]),g.push(l)}const T=[];for(let t=0;t<p;t++){const s=r+16*t;if(s+16>e.byteLength)break;T.push({materialID:e.getUint8(s+0),jointA:e.getInt8(s+1),dlStartCmd:e.getInt16(s+8,!1)})}T.sort((e,t)=>e.dlStartCmd-t.dlStartCmd);const x=[],v=[],C=[],b=[],_=[],y=new Int32Array(64).fill(0);let S=0,w=0,A=-1,E=0,R=1/0,I=1/0,M=1/0,P=-1/0,D=-1/0,B=-1/0,L=u,O=0;for(;L+8<=e.byteLength;){for(;S<T.length&&O>=T[S].dlStartCmd;){const e=T[S];w=e.jointA,e.materialID!==A&&(b.length>E&&_.push({flags:0,materialId:A,vStart:0,vEnd:0,tStart:E,tEnd:b.length}),A=e.materialID,E=b.length),S++}const t=e.getUint32(L),s=e.getUint32(L+4),n=t>>>24;if(223===n)break;if(1===n){const n=t>>>12&255,r=t>>>1&127,a=16777215&s;let o=Math.floor((a-i)/16);o<0&&(o=0);for(let t=0;t<n;t++){const s=i+16*(o+t);if(s+16>e.byteLength)continue;let n=e.getInt16(s+0,!1),a=e.getInt16(s+2,!1),l=e.getInt16(s+4,!1);w>=0&&w<g.length&&(n+=g[w][0],a+=g[w][1],l+=g[w][2]),R=Math.min(R,n),I=Math.min(I,a),M=Math.min(M,l),P=Math.max(P,n),D=Math.max(D,a),B=Math.max(B,l);const h=x.length/3;x.push(n,a,l),C.push(e.getInt16(s+8,!1),e.getInt16(s+10,!1)),v.push(255,255,255,255),r+t<64&&(y[r+t]=h)}}else if(5===n){const e=t>>>16&63,s=t>>>8&63,n=63&t;b.push({flip:!1,i0:y[e],i1:y[s],i2:y[n]})}else if(6===n){const e=t>>>16&63,n=t>>>8&63,i=63&t;b.push({flip:!1,i0:y[e],i1:y[n],i2:y[i]});const r=s>>>16&63,a=s>>>8&63,o=63&s;b.push({flip:!1,i0:y[r],i1:y[a],i2:y[o]})}L+=8,O++}b.length>E&&_.push({flags:0,materialId:-1===A?0:A,vStart:0,vEnd:0,tStart:E,tEnd:b.length});const F=x.length/3,U=new ArrayBuffer(6*F),N=new ArrayBuffer(4*F),X=new ArrayBuffer(4*F),V=new DataView(U),G=new DataView(N),K=new DataView(X);for(let e=0;e<F;e++)V.setInt16(6*e+0,x[3*e+0],!1),V.setInt16(6*e+2,x[3*e+1],!1),V.setInt16(6*e+4,x[3*e+2],!1),K.setInt16(4*e+0,C[2*e+0],!1),K.setInt16(4*e+2,C[2*e+1],!1),G.setUint8(4*e+0,v[4*e+0]),G.setUint8(4*e+1,v[4*e+1]),G.setUint8(4*e+2,v[4*e+2]),G.setUint8(4*e+3,v[4*e+3]);n.bbox=new l.F5(R,I,M,P,D,B);const W=(0,c.y5)(h.cg.MAX+1,()=>({type:h.WP.NONE}));W[h.cg.POS].type=h.WP.INDEX16,W[h.cg.CLR0].type=h.WP.INDEX16,W[h.cg.TEX0].type=h.WP.INDEX16;const Y=(0,c.y5)(8,()=>(0,c.y5)(h.cg.MAX+1,()=>({compType:h.aL.U8,compShift:0,compCnt:0})));Y[0][h.cg.POS]={compType:h.aL.S16,compShift:0,compCnt:h.xA.POS_XYZ},Y[0][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},Y[0][h.cg.TEX0]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST};const z=[];return z[h.cg.POS]={buffer:o.A.fromView(new DataView(U)),offs:0,stride:6},z[h.cg.CLR0]={buffer:o.A.fromView(new DataView(N)),offs:0,stride:4},z[h.cg.TEX0]={buffer:o.A.fromView(new DataView(X)),offs:0,stride:4},n.createModelShapes=()=>{const e=new k.Cu(n,new DataView(U),void 0);e.shapes[0]=[],e.shapes[1]=[],e.shapes[2]=[];for(const n of _){const i={layers:[{texId:n.materialId,tevMode:0,enableScroll:0}],flags:0,attrFlags:d.Y2.CLR|d.Y2.TEX0,hasHemisphericProbe:!1,hasReflectiveProbe:!1,reflectiveProbeMaskTexId:null,reflectiveProbeIdx:0,reflectiveAmbFactor:0,hasNBTTexture:!1,nbtTexId:null,nbtParams:0,furRegionsTexId:null,color:{r:1,g:1,b:1,a:1},normalFlags:0,lightFlags:0,texMtxCount:0},r=s.buildMapMaterial(i,t),a=3*(n.tEnd-n.tStart),o=new Uint8Array(3+6*a);let l=0;o[l++]=144,o[l++]=a>>>8&255,o[l++]=a>>>0&255;for(let e=n.tStart;e<n.tEnd;e++){let{flip:t,i0:s,i1:n,i2:i}=b[e];if(t){const e=n;n=i,i=e}for(const e of[s,n,i]){const t=Math.min(Math.max(0,e),F-1);o[l++]=t>>>8&255,o[l++]=255&t,o[l++]=t>>>8&255,o[l++]=255&t,o[l++]=t>>>8&255,o[l++]=255&t}}const h=new $(z,W,Y,new DataView(o.buffer),!1);e.shapes[0].push(new Z(h,new H(r),!1))}return e},n.sharedModelShapes=n.createModelShapes(),n}{n.isMapBlock=!0;const i=e.getUint32(0),r=e.getUint32(4),a=e.getUint32(8),l=e.getUint32(12),u=(i-l)/24|0;if(u<=0)throw new Error(`DP Map: bad batchCount=${u}`);const m=l+24*(u-1),p=e.getUint16(m+4),f=e.getUint16(m+6),g=new ArrayBuffer(6*p),T=new DataView(g),x=new ArrayBuffer(4*p),v=new DataView(x),C=new ArrayBuffer(4*p),b=new DataView(C);for(let t=0;t<p;t++){const s=r+16*t;T.setInt16(6*t+0,e.getInt16(s+0,!1),!1),T.setInt16(6*t+2,e.getInt16(s+2,!1),!1),T.setInt16(6*t+4,e.getInt16(s+4,!1),!1),b.setInt16(4*t+0,e.getInt16(s+8,!1),!1),b.setInt16(4*t+2,e.getInt16(s+10,!1),!1),v.setUint8(4*t+0,e.getUint8(s+12)),v.setUint8(4*t+1,e.getUint8(s+13)),v.setUint8(4*t+2,e.getUint8(s+14)),v.setUint8(4*t+3,e.getUint8(s+15))}const _=[];for(let t=0;t<f;t++){const s=a+8*t,n=e.getUint8(s+0);_.push({flip:!!(128&n),i0:e.getUint8(s+1),i1:e.getUint8(s+2),i2:e.getUint8(s+3)})}const y=[];let S=0,w=0;for(let t=0;t<u;t++){const s=l+24*t,n=e.getUint16(s+0,!1),i=e.getUint16(s+2,!1),r=e.getUint16(s+4,!1),a=e.getUint16(s+6,!1);r===S&&a===w||y.push({flags:n,materialId:i,vStart:S,vEnd:r,tStart:w,tEnd:a}),S=r,w=a}const A=(0,c.y5)(h.cg.MAX+1,()=>({type:h.WP.NONE}));A[h.cg.POS].type=h.WP.INDEX16,A[h.cg.CLR0].type=h.WP.INDEX16,A[h.cg.TEX0].type=h.WP.INDEX16;const E=(0,c.y5)(8,()=>(0,c.y5)(h.cg.MAX+1,()=>({compType:h.aL.U8,compShift:0,compCnt:0})));E[0][h.cg.POS]={compType:h.aL.S16,compShift:0,compCnt:h.xA.POS_XYZ},E[0][h.cg.CLR0]={compType:h.aL.RGBA8,compShift:0,compCnt:h.xA.CLR_RGBA},E[0][h.cg.TEX0]={compType:h.aL.S16,compShift:10,compCnt:h.xA.TEX_ST};const R=[];return R[h.cg.POS]={buffer:o.A.fromView(new DataView(g)),offs:0,stride:6},R[h.cg.CLR0]={buffer:o.A.fromView(new DataView(x)),offs:0,stride:4},R[h.cg.TEX0]={buffer:o.A.fromView(new DataView(C)),offs:0,stride:4},n.createModelShapes=()=>{const e=new k.Cu(n,new DataView(g),void 0);e.shapes[0]=[],e.shapes[1]=[],e.shapes[2]=[];for(const n of y){const i={layers:[{texId:n.materialId,tevMode:0,enableScroll:0}],flags:d.JL.Water,attrFlags:d.Y2.CLR|d.Y2.TEX0,hasHemisphericProbe:!1,hasReflectiveProbe:!1,reflectiveProbeMaskTexId:null,reflectiveProbeIdx:0,reflectiveAmbFactor:0,hasNBTTexture:!1,nbtTexId:null,nbtParams:0,furRegionsTexId:null,color:{r:1,g:1,b:1,a:1},normalFlags:0,lightFlags:0,texMtxCount:0},r=s.buildMapMaterial(i,t),a=3*(n.tEnd-n.tStart),o=new Uint8Array(3+6*a);let l=0;o[l++]=144,o[l++]=a>>>8&255,o[l++]=a>>>0&255;for(let e=n.tStart;e<n.tEnd;e++){let{flip:t,i0:s,i1:i,i2:r}=_[e];if(t){const e=i;i=r,r=e}const a=n.vStart+s,h=n.vStart+i,c=n.vStart+r;for(const e of[a,h,c])o[l++]=e>>>8&255,o[l++]=255&e,o[l++]=e>>>8&255,o[l++]=255&e,o[l++]=e>>>8&255,o[l++]=255&e}const h=new $(R,A,E,new DataView(o.buffer),!1);e.shapes[0].push(new Z(h,new H(r),!1))}return e},n.sharedModelShapes=n.createModelShapes(),n}}(e,t,s);const p=new k.Kx(n);let f=ae[n];const g=e.buffer.byteLength;n===z.Early1&&144448===g&&(f=Object.assign({},f),f.numListBits=6),function(e,t){const s=new Set(["numListBits","dlInfoSize","isMapBlock","isFinal","isBeta","oldVat","hasNormals","hasBones","hasYTranslate","isfinal","shaderFields"]);for(const n in t){if(s.has(n))continue;const i=t[n];if("number"==typeof i&&i>=0&&i<e.byteLength)try{let t,s;"jointCount"===n||"weightCount"===n||"shaderCount"===n||"dlInfoCount"===n?(t=1,s=e.getUint8(i)):/Count$|Size$/i.test(n)?(t=2,s=i+1<e.byteLength?e.getUint16(i,!1):0):/Offset$|posFineSkinning|nrmFineSkinning|shaderOffset|dlInfoOffset|bitsOffsets/i.test(n)?(t=4,s=i+3<e.byteLength?e.getUint32(i,!1):0):(t=1,s=e.getUint8(i));const r=[];for(let s=0;s<t;s++)i+s<e.byteLength?r.push(e.getUint8(i+s).toString(16).padStart(2,"0")):r.push("??")}catch(e){}}}(e,f);const T=e.byteLength,x=e.getUint32(f.shaderOffset),v=e.getUint8(f.shaderCount),C=e.getUint32(f.dlInfoOffset);(null!==(r=null===(i=f.bitsOffsets)||void 0===i?void 0:i.length)&&void 0!==r?r:0)>0&&e.getUint32(f.bitsOffsets[0]);let b=C>x&&v?C-x:0,_=v?Math.floor(b/v):0;for(let t=0;t<Math.min(v,2);t++){const s=x+t*_,n=[];for(let t=0;t<16&&s+t<T;t++)n.push(e.getUint8(s+t).toString(16).padStart(2,"0"))}const y=e.getUint8(f.dlInfoCount),S=C,w=[28,32,36,40,48,52,56,60,64];function A(t,s){return{o:e.getUint32(t,!1),s:e.getUint16(t+4,!1)}}for(const e of w){if(!S||S+e*y>T)continue;let t=0,s=0;const n=[],i=Math.min(3,y);for(let r=0;r<y;r++){const a=A(S+r*e),o=a.o>0&&a.s>0&&a.o+a.s<=T;r<i&&n.push(`#${r}:off=0x${a.o.toString(16)},size=0x${a.s.toString(16)}`),o?t++:s++}}if(S&&S<T){const t=Math.min(128,T-S);let s="";for(let n=0;n<t;n++)s+=e.getUint8(S+n).toString(16).padStart(2,"0")+(n%16==15?` @+0x${(n-15).toString(16)}\n`:" ")}const E=f.hasNormals?e.getUint8(36):0;p.isMapBlock=!!f.isMapBlock;const R=e.getUint32(f.posOffset);if(e.getUint16(f.posCount),p.originalPosBuffer=(0,m.Y)(e,R),f.hasNormals){const t=e.getUint32(f.nrmOffset),s=e.getUint16(f.nrmCount);p.originalNrmBuffer=(0,m.Y)(e,t,s*(E&d.H5.NBT?9:3))}if(f.hasNormals&&p.originalNrmBuffer.byteLength>0){const t=E&d.H5.NBT?9:3,s=(e.getUint16(f.posCount)>>>0)*t;if(p.originalNrmBuffer.byteLength<s){const e=new Uint8Array(p.originalNrmBuffer.buffer,p.originalNrmBuffer.byteOffset,p.originalNrmBuffer.byteLength),n=new Uint8Array(s);n.set(e);const i=Math.max(0,e.byteLength-t);for(let r=e.byteLength;r<s;r+=t)for(let s=0;s<t;s++)n[r+s]=null!==(u=e[i+s])&&void 0!==u?u:0;p.originalNrmBuffer=new DataView(n.buffer)}}if(void 0!==f.posFineSkinningConfig){const t=J((0,m.Y)(e,f.posFineSkinningConfig));if(0!==t.numPieces){p.hasFineSkinning=!0,p.fineSkinPositionQuantizeScale=t.quantizeScale;const s=e.getUint32(f.posFineSkinningWeights),n=(0,m.Y)(e,s),i=e.getUint32(f.posFineSkinningPieces);for(let s=0;s<t.numPieces;s++){const t=ee((0,m.Y)(e,i+s*Q,Q));p.posFineSkins.push({vertexCount:t.numVertices,bufferOffset:t.skinDataSrcOffs+t.skinMeOffset,bone0:t.bone0,bone1:t.bone1,weights:(0,m.Y)(n,t.weightsSrc,32*t.weightsBlockCount)})}}const s=J((0,m.Y)(e,f.nrmFineSkinningConfig));if(0!==s.numPieces&&void 0!==f.nrmFineSkinningPieces&&void 0!==f.nrmFineSkinningWeights){p.hasFineSkinning=!0,p.fineSkinNormalQuantizeScale=s.quantizeScale,p.fineSkinNBTNormals=!!(E&d.H5.NBT),p.fineSkinNBTNormals&&console.warn("Fine-skinned NBT normals detected; not implemented yet");const t=e.getUint32(f.nrmFineSkinningWeights),n=e.getUint32(f.nrmFineSkinningPieces),i=t>0&&t<e.byteLength,r=n>0&&n+s.numPieces*Q<=e.byteLength;if(i&&r){const i=(0,m.Y)(e,t);for(let t=0;t<s.numPieces;t++){const s=ee((0,m.Y)(e,n+t*Q,Q));p.nrmFineSkins.push({vertexCount:s.numVertices,bufferOffset:s.skinDataSrcOffs+s.skinMeOffset,bone0:s.bone0,bone1:s.bone1,weights:(0,m.Y)(i,s.weightsSrc,32*s.weightsBlockCount)})}}}else s.numPieces;p.hasBetaFineSkinning=p.hasFineSkinning&&n===z.Beta}const M=(E&d.H5.NBT?f.oldVat?re:ne:f.oldVat?ie:se).map(e=>e.map(e=>({compType:e.compType,compShift:e.compShift,compCnt:e.compCnt})));if(f.oldVat&&!f.isMapBlock&&E&d.H5.NBT)for(const e of[5,6,7])M[e][h.cg.POS].compShift=3;const P=!!f.isMapBlock&&(n===z.Early3||n===z.Early4);if(P)for(let e=0;e<8;e++)M[e][h.cg.CLR0].compType=h.aL.RGBA4,M[e][h.cg.CLR0].compCnt=h.xA.CLR_RGBA,M[e][h.cg.CLR0].compShift=0;const D=e.getUint32(f.texOffset),B=e.getUint8(f.texCount),L=[];for(let t=0;t<B;t++){const s=(0,m.Wg)(e,D,t);L.push(s)}const O=e.getUint32(f.clrOffset),F=e.getUint16(f.clrCount);let U;if(n===z.AncientMap)U=o.A.fromView((0,m.Y)(e,O)).createTypedArray(Uint8Array);else{const t=Math.max(0,e.byteLength-O),s=Math.min(F,t>>>1);U=o.A.fromView((0,m.Y)(e,O,2*s)).createTypedArray(Uint8Array)}let N=U;if(P){const e=U,t=e.byteLength>>>1,s=new Uint8Array(131072),n=t<=256?255:t<=4096?4095:-1;for(let i=0;i<65536;i++){let r=32767&i;-1!==n?r&=n:t&&(r%=t);const a=r<<1,o=i<<1;s[o]=e[a],s[o+1]=e[a+1]}N=s}let X=!1;if(f.isMapBlock&&0===N.byteLength){const e=new Uint8Array(131072);e.fill(255),N=e,X=!0}const V=N.byteLength>0,G=e.getUint32(f.texcoordOffset),K=(e.getUint16(f.texcoordCount),(0,m.Y)(e,G));let W=!1,Y=0;if(f.hasBones){const t=e.getUint32(f.jointOffset);if(Y=e.getUint8(f.jointCount),W=Y>0,p.joints=[],Y>0){let s=t;for(let t=0;t<Y;t++)p.joints.push({parent:e.getUint8(s),boneNum:127&e.getUint8(s+1),translation:(0,m._t)(e,s+4),bindTranslation:(0,m._t)(e,s+16)}),s+=28;if(void 0!==f.weightOffset){const t=e.getUint32(f.weightOffset),s=e.getUint8(f.weightCount),n=t>0&&t+4*s<=e.byteLength;if(s>0&&n){p.coarseBlends=[];let n=t;for(let t=0;t<s;t++){const t=.25*e.getUint8(n+2);p.coarseBlends.push({joint0:e.getUint8(n),joint1:e.getUint8(n+1),influence0:t,influence1:1-t}),n+=4}}}p.skeleton=new j.E,p.invBindTranslations=(0,c.y5)(p.joints.length,()=>a.vt());for(let e=0;e<p.joints.length;e++){const t=p.joints[e];if(t.boneNum!==e)throw Error("wtf? joint's bone number doesn't match its index!");p.skeleton.addJoint(255!=t.parent?t.parent:void 0,t.translation),a.ze(p.invBindTranslations[e],t.bindTranslation)}}}!f.isMapBlock&&f.isFinal&&(p.cullRadius=e.getUint16(224),p.lightFlags=e.getUint16(226));let te=0;f.hasBones&&void 0!==f.texMtxCount&&(te=e.getUint8(f.texMtxCount));for(let e=0;e<336;e++);const le=e.getUint32(f.shaderOffset),he=e.getUint8(f.shaderCount),ce=[];let ue=le;for(let t=0;t<he;t++){const t=(0,m.Y)(e,ue,f.shaderFields.size);ce.push(I(t,f.shaderFields,L,E,p.lightFlags,te)),ue+=f.shaderFields.size}p.materials=[];const de=[],me=e.getUint8(f.dlInfoCount);if(f.isBeta)for(let t=0;t<me;t++){const s=e.getUint32(f.dlOffsets),n=e.getUint32(f.dlSizes);de.push({offset:(0,m.Wg)(e,s,t),size:(0,m.CV)(e,n,t)})}else{const t=e.getUint32(f.dlInfoOffset);if(0===t||t>=e.byteLength);else{const s=e.byteLength>>>0,n=f.dlInfoSize>>>0,i=s-t,r=Math.floor(i/n),a=Math.max(0,Math.min(me,r));for(let e=0;e<me;e++)de[e]={offset:0,size:0};let o=0;const l=8;for(let i=0;i<a;i++){const r=t+i*n;if(r+n>s){o++;continue}const a=q((0,m.Y)(e,r,n));if(a.offset>0&&a.size>0&&a.offset+a.size<=s?(de[i]=a,o=0):o++,o>=l)break}}}for(let t=0;t<de.length;t++){const{offset:s,size:n}=de[t];s<0||e.byteLength}const pe=[],fe=[];for(let t=0;t<f.bitsOffsets.length;t++)pe.push(e.getUint32(f.bitsOffsets[t])),fe.push(e.getUint16(f.bitsByteCounts[t]));f.hasYTranslate&&(p.modelTranslate[1]=e.getInt16(142));const ge=(0,c.y5)(10,()=>0),Te=(e,t)=>{const s=[];s[h.cg.POS]={buffer:o.A.fromView(e),offs:0,stride:6},f.hasNormals&&(s[h.cg.NRM]={buffer:o.A.fromView(t),offs:0,stride:E&d.H5.NBT?9:3}),s[h.cg.CLR0]={buffer:o.A.fromView(N),offs:0,stride:2};for(let e=0;e<8;e++)s[h.cg.TEX0+e]={buffer:o.A.fromView(K),offs:0,stride:4};return s},xe=(e,t)=>{const s=[];for(let e=0;e<=h.cg.MAX;e++)s[e]={type:h.WP.NONE};if(f.hasBones&&Y>=2){s[h.cg.PNMTXIDX].type=h.WP.DIRECT;let e=0;(t.hasHemisphericProbe||t.hasReflectiveProbe)&&(t.hasNBTTexture&&(s[h.cg.TEX0MTXIDX+e].type=h.WP.DIRECT,e++,s[h.cg.TEX0MTXIDX+e].type=h.WP.DIRECT,e++),s[h.cg.TEX0MTXIDX+e].type=h.WP.DIRECT,e++),e=7;for(let t=0;t<te;t++)s[h.cg.TEX0MTXIDX+e].type=h.WP.DIRECT,e--}if(s[h.cg.POS].type=e.get(1)?h.WP.INDEX16:h.WP.INDEX8,f.hasNormals&&t.attrFlags&d.Y2.NRM?s[h.cg.NRM].type=e.get(1)?h.WP.INDEX16:h.WP.INDEX8:s[h.cg.NRM].type=h.WP.NONE,V&&f.isMapBlock||t.attrFlags&d.Y2.CLR?P?(e.get(1),s[h.cg.CLR0].type=h.WP.INDEX16):s[h.cg.CLR0].type=e.get(1)?h.WP.INDEX16:h.WP.INDEX8:s[h.cg.CLR0].type=h.WP.NONE,t.layers.length>0){const n=e.get(1);for(let e=0;e<8;e++)e<t.layers.length?s[h.cg.TEX0+e].type=n?h.WP.INDEX16:h.WP.INDEX8:s[h.cg.TEX0+e].type=h.WP.NONE}else for(let e=0;e<8;e++)s[h.cg.TEX0+e].type=h.WP.NONE;if(f.oldVat){const t=7&e.bitIndex;t&&e.drop(8-t)}return s},ve=(s,n,i,r,a,o,l)=>{const h=[],c=new m.X_(e,s);c.seekBit(n);let u=ce[0],d=i(u,t,L,f.isMapBlock),g=o.slice(),T=!1;for(;!T;)switch(c.get(4)){case oe.SetShader:{const e=c.get(6);u=ce[e],d=i(u,t,L,f.isMapBlock);break}case oe.SetVCD:g=xe(c,u);break;case oe.SetMatrices:{const e=c.get(4);for(let t=0;t<e;t++)c.get(8);break}case oe.CallDL:{const t=c.get(f.numListBits);if(t>=de.length)break;if(!l(u))break;const s=de[t],n=(0,m.Y)(e,s.offset,s.size),i=Te(r,a),o=new $(i,g,M,n,p.hasFineSkinning);o.setPnMatrixMap(ge,W,p.hasFineSkinning),void 0!==s.aabb&&o.setBoundingBox(s.aabb),void 0!==s.sortLayer&&o.setSortLayer(s.sortLayer),h.push(new Z(o,new H(d),!1));break}case oe.End:default:T=!0}return h};function Ce(e){return 97===e||8===e||16===e||32===e||64===e||e>=128&&e<=159}function be(e){const t=t=>{var s,n;return(null===(s=e[t])||void 0===s?void 0:s.type)===h.WP.INDEX16?2:(null===(n=e[t])||void 0===n?void 0:n.type)===h.WP.INDEX8?1:0};return t(h.cg.POS)+t(h.cg.NRM)+t(h.cg.CLR0)+t(h.cg.TEX0)+t(h.cg.TEX1)+t(h.cg.TEX2)+t(h.cg.TEX3)}function _e(e){var t,s;let n=0;(null===(t=e[h.cg.PNMTXIDX])||void 0===t?void 0:t.type)===h.WP.DIRECT&&n++;for(let t=0;t<8;t++)(null===(s=e[h.cg.TEX0MTXIDX+t])||void 0===s?void 0:s.type)===h.WP.DIRECT&&n++;return n}function ye(e,t,s){if(s<4)return[];const n=e.getUint8(t);if(!(n>=128&&n<=159))return[];const i=e.getUint16(t+1,!1);if(0===i||i>16384)return[];const r=t+s,a=[],o=[],l=[];for(let s=2;s<=24;s++){const h=t+3+i*s;if(h>=r)break;const c=e.getUint8(h);c===n?a.push(s):c>=128&&c<=159?o.push(s):97!==c&&8!==c&&16!==c&&32!==c&&64!==c||l.push(s)}return[...a,...o,...l]}function Se(e,t){var s,n,i,r,a;const o=e.map(e=>{var t;return{type:null!==(t=null==e?void 0:e.type)&&void 0!==t?t:h.WP.NONE}});let l=be(o)+_e(o);if(l===t)return o;if(l<t){let e=t-l;e>0&&(null===(s=o[h.cg.PNMTXIDX])||void 0===s?void 0:s.type)!==h.WP.DIRECT&&(o[h.cg.PNMTXIDX]={type:h.WP.DIRECT},e--);for(let t=0;t<8&&e>0;t++){const s=h.cg.TEX0MTXIDX+t;(null!==(i=null===(n=o[s])||void 0===n?void 0:n.type)&&void 0!==i?i:h.WP.NONE)!==h.WP.DIRECT&&(o[s]={type:h.WP.DIRECT},e--)}return o}{let e=l-t;for(let t=7;t>=0&&e>0;t--){const s=h.cg.TEX0MTXIDX+t;(null===(r=o[s])||void 0===r?void 0:r.type)===h.WP.DIRECT&&(o[s]={type:h.WP.NONE},e--)}return e>0&&(null===(a=o[h.cg.PNMTXIDX])||void 0===a?void 0:a.type)===h.WP.DIRECT&&(o[h.cg.PNMTXIDX]={type:h.WP.NONE},e--),o}}function we(e,t,s,n,i,r){if(!i.oldVat||s<4)return n;const a=function(e,t,s){if(s<4)return null;const n=e.getUint8(t);if(!(n>=128&&n<=159))return null;const i=e.getUint16(t+1,!1);if(0===i||i>16384)return null;const r=t+s,a=[],o=[],l=[];for(let s=2;s<=24;s++){const h=t+3+i*s;if(h>=r)break;const c=e.getUint8(h);c===n?a.push(s):c>=128&&c<=159?o.push(s):97!==c&&8!==c&&16!==c&&32!==c&&64!==c||l.push(s)}return a.length?a[0]:o.length?o[0]:l.length?l[0]:null}(e,t,s);if(null==a)return n;if(be(n)+_e(n)===a)return n;const o=Se(n,a);return be(o)+_e(o)===a?o:n}const Ae=async(i,r,a,o,l)=>{var c,u,g,T,x,v,C,b,_,y;i.shapes[a]=[];const S=i.shapes[a];if(0===r)return;let w,A=ce[0];function E(e){const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0;e+4<t.length;e++)if(97===t[e]&&243===t[e+1])return!0;return!1}const R=e=>{if(A=ce[e],void 0===p.materials[e])if(f.isMapBlock)if(X){const n=Object.assign(Object.assign({},A),{attrFlags:A.attrFlags&~d.Y2.CLR});p.materials[e]=s.buildMapMaterial(n,t)}else p.materials[e]=s.buildMapMaterial(A,t);else p.materials[e]=s.buildObjectMaterial(A,t,W);w=p.materials[e]};R(0);const I=new m.X_(e,r);let k=[],P=!1;for(;!P;)switch(I.bitIndex%800==0&&await new Promise(e=>setTimeout(e,0)),I.get(4)){case oe.SetShader:R(I.get(6));break;case oe.CallDL:{const _=I.get(f.numListBits);if(_>=de.length)continue;const y=de[_];if(!y||0===y.offset||0===y.size||y.offset+y.size>e.byteLength)break;const R=(0,m.Y)(e,y.offset,y.size);if(_<10){try{const t=y.offset>>>0,s=e.getUint8(t),n=e.getUint16(t+1,!1);if(s>=128&&s<=159&&n>0){const s=[];for(const i of[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]){const r=t+3+n*i;if(r<e.byteLength){const n=e.getUint8(r);Ce(n)&&s.push(`s=${i}->0x${n.toString(16)} @+0x${(r-t).toString(16)}`)}}}}catch(e){}{const t=y.offset>>>0,s=Math.min(t+16,e.byteLength);let n="";for(let i=t;i<s;i++)n+=e.getUint8(i).toString(16).padStart(2,"0")+" "}{const t=y.offset>>>0,s=Math.min(64,Math.max(0,e.byteLength-t));let n=-1;for(let i=0;i<s;i++)if(Ce(e.getUint8(t+i))){n=t+i;break}if(n>=0){const t=Math.min(n+16,e.byteLength);let s="";for(let i=n;i<t;i++)s+=e.getUint8(i).toString(16).padStart(2,"0")+" "}}}R.byteLength,(f.shaderFields.isEarly1||f.shaderFields.isEarly3)&&(A.flags&d.JL.AlphaCompare||!E(R)||(A.flags|=d.JL.AlphaCompare));const P=void 0!==y.specialBitAddress&&0!==y.specialBitAddress,D=!!(A.flags&d.JL.Water),B=!!(A.flags&d.JL.Lava),L=n===z.Early1||!!(null===(c=f.shaderFields)||void 0===c?void 0:c.isEarly1),O=n===z.Early3||!!(null===(u=f.shaderFields)||void 0===u?void 0:u.isEarly3),U=n===z.Early1||!!(null===(g=f.shaderFields)||void 0===g?void 0:g.isold);let N=-1;L&&pe.length>0?N=pe.length>=3&&0!==pe[2]?2:pe.length-1:O&&pe.length>0?N=pe.length-1:U&&pe.length>0&&(N=pe.length>=3&&0!==pe[2]?2:pe.length-1);const X=!!f.isMapBlock&&N>=0&&a===N,V=()=>{if(!P)return!1;const e=ve(r,y.specialBitAddress,s.buildWaterMaterial.bind(s),o,l,k,e=>!(!(e.flags&d.JL.Water)||e.flags&d.JL.Lava));if(e.length>0){for(const t of e)i.waters.push(t);return!0}return!1};if((null===(T=k[h.cg.CLR0])||void 0===T?void 0:T.type)!==h.WP.NONE&&0===F&&console.error("[ATTR] CLR0 requested but clrCount==0"),(null===(x=k[h.cg.NRM])||void 0===x?void 0:x.type)===h.WP.NONE||f.hasNormals||console.error("[ATTR] NRM requested but hasNormals==false"),!B&&(D||X)){if(V())break;const t=Te(o,l),n=s.buildWaterMaterial(A),r=we(e,y.offset,y.size,k,f),a=new $(t,r,M,R,p.hasFineSkinning);a.setPnMatrixMap(ge,W,p.hasFineSkinning),void 0!==y.aabb&&a.setBoundingBox(y.aabb),void 0!==y.sortLayer&&a.setSortLayer(y.sortLayer);const h=new Z(a,new H(n),!1);i.waters.push(h);break}const G=Te(o,l);let K=w;if(f.shaderFields.isEarly3&&!(A.flags&d.JL.AlphaCompare)&&E(R)){const e=Object.assign(Object.assign({},A),{flags:A.flags|d.JL.AlphaCompare});K=f.isMapBlock?s.buildMapMaterial(e,t):s.buildObjectMaterial(e,t,f.hasBones&&Y>=2)}const j=we(e,y.offset,y.size,k,f);try{const t=y.offset>>>0,s=e.getUint8(t),n=e.getUint16(t+1,!1);if(s>=128&&s<=159&&n>0){const e=e=>{var t,s;return(null===(t=j[e])||void 0===t?void 0:t.type)===h.WP.INDEX16?2:(null===(s=j[e])||void 0===s?void 0:s.type)===h.WP.INDEX8?1:0};let t=0;(null===(v=j[h.cg.PNMTXIDX])||void 0===v?void 0:v.type)===h.WP.DIRECT&&t++;for(let e=0;e<8;e++)(null===(C=j[h.cg.TEX0MTXIDX+e])||void 0===C?void 0:C.type)===h.WP.DIRECT&&t++;if(3+n*(e(h.cg.POS)+e(h.cg.NRM)+e(h.cg.CLR0)+e(h.cg.TEX0)+e(h.cg.TEX1)+e(h.cg.TEX2)+e(h.cg.TEX3)+t)>y.size)break}}catch(e){}const q=(e,t)=>{var s;d.H5.NBT,null!==(s=null==e?void 0:e.message)&&void 0!==s||String(e)};try{const e=new $(G,j,M,R,p.hasFineSkinning);e.setPnMatrixMap(ge,W,p.hasFineSkinning),void 0!==y.aabb&&e.setBoundingBox(y.aabb),void 0!==y.sortLayer&&e.setSortLayer(y.sortLayer);const t=new Z(e,new H(K),!!(A.flags&d.JL.DevGeometry));S.push(t)}catch(t){q(t,"PRIMARY");{const t=ye(e,y.offset,y.size);let s=!1;for(const e of t){const t=Se(k,e);if(be(t)+_e(t)===e)try{const e=new $(G,t,M,R,p.hasFineSkinning);e.setPnMatrixMap(ge,W,p.hasFineSkinning),void 0!==y.aabb&&e.setBoundingBox(y.aabb),void 0!==y.sortLayer&&e.setSortLayer(y.sortLayer);const n=new Z(e,new H(K),!!(A.flags&d.JL.DevGeometry));S.push(n),s=!0;break}catch(t){q(t,`RETRY+ALTSTRIDE(${e})`)}}if(s)break}if(y.size>32)try{const t=(0,m.Y)(e,y.offset+32,y.size-32),s=new $(G,j,M,t,p.hasFineSkinning);s.setPnMatrixMap(ge,W,p.hasFineSkinning),void 0!==y.aabb&&s.setBoundingBox(y.aabb),void 0!==y.sortLayer&&s.setSortLayer(y.sortLayer);const n=new Z(s,new H(K),!!(A.flags&d.JL.DevGeometry));S.push(n);break}catch(e){q(e,"RETRY+SKIP20")}if((null===(b=j[h.cg.PNMTXIDX])||void 0===b?void 0:b.type)===h.WP.DIRECT){const t=j.slice();t[h.cg.PNMTXIDX]={type:h.WP.NONE};try{const e=new $(G,t,M,R,p.hasFineSkinning);e.setPnMatrixMap(ge,!1,p.hasFineSkinning),void 0!==y.aabb&&e.setBoundingBox(y.aabb),void 0!==y.sortLayer&&e.setSortLayer(y.sortLayer);const s=new Z(e,new H(K),!!(A.flags&d.JL.DevGeometry));S.push(s);break}catch(e){q(e,"RETRY")}if(y.size>32)try{const s=(0,m.Y)(e,y.offset+32,y.size-32),n=new $(G,t,M,s,p.hasFineSkinning);n.setPnMatrixMap(ge,!1,p.hasFineSkinning),void 0!==y.aabb&&n.setBoundingBox(y.aabb),void 0!==y.sortLayer&&n.setSortLayer(y.sortLayer);const i=new Z(n,new H(K),!!(A.flags&d.JL.DevGeometry));S.push(i);break}catch(e){q(e,"RETRY+PNOFF+SKIP20")}}}if(0===a&&A.flags&(d.JL.ShortFur|d.JL.MediumFur|d.JL.LongFur)&&void 0!==y.specialBitAddress&&0!==y.specialBitAddress){const e=ve(r,y.specialBitAddress,s.buildFurMaterial.bind(s),o,l,k,e=>!!(e.flags&(d.JL.ShortFur|d.JL.MediumFur|d.JL.LongFur)))[0];if(e){const t=A.flags&d.JL.LongFur?16:A.flags&d.JL.MediumFur?8:4;i.furs.push({shape:e,numLayers:t})}}break}case oe.SetVCD:{k=xe(I,A);const e=e=>{var t,s;return(null===(t=k[e])||void 0===t?void 0:t.type)===h.WP.INDEX16?2:(null===(s=k[e])||void 0===s?void 0:s.type)===h.WP.INDEX8?1:0};e(h.cg.POS),e(h.cg.NRM),e(h.cg.CLR0),e(h.cg.TEX0),e(h.cg.TEX1),e(h.cg.TEX2),e(h.cg.TEX3);let t=0;(null===(_=k[h.cg.PNMTXIDX])||void 0===_?void 0:_.type)===h.WP.DIRECT&&(t+=1);for(let e=0;e<8;e++)(null===(y=k[h.cg.TEX0MTXIDX+e])||void 0===y?void 0:y.type)===h.WP.DIRECT&&(t+=1);break}case oe.SetMatrices:{const e=I.get(4);if(e>10)throw Error("Too many PN matrices");for(let t=0;t<e;t++)ge[t]=I.get(8);break}case oe.End:P=!0}};if(p.createModelShapes=()=>{let e,t;p.hasFineSkinning?(e=(0,m.Mb)(p.originalPosBuffer),t=(0,m.Mb)(p.originalNrmBuffer)):(e=p.originalPosBuffer,t=p.originalNrmBuffer);const s=new k.Cu(p,e,t);for(let e=0;e<pe.length;e++)try{Ae(s,pe[e],e,s.posBuffer,s.nrmBuffer)}catch(e){console.error(e)}return s},p.hasFineSkinning||(p.sharedModelShapes=p.createModelShapes()),p.sharedModelShapes){const e=e=>e?e.length:0;e(p.sharedModelShapes.shapes[0]),e(p.sharedModelShapes.shapes[1]),e(p.sharedModelShapes.shapes[2]),p.sharedModelShapes.waters.length,p.sharedModelShapes.furs.length}return p}!function(e){e[e.SetShader=1]="SetShader",e[e.CallDL=2]="CallDL",e[e.SetVCD=3]="SetVCD",e[e.SetMatrices=4]="SetMatrices",e[e.End=5]="End"}(oe||(oe={}))},2141(e,t,s){"use strict";s.d(t,{B_:()=>_,Cu:()=>C,Ju:()=>S,Kx:()=>b});var n=s(5974),i=s(7684),r=s(329),a=s(9667),o=s(2007),l=s(9702),h=s(8192),c=s(3793),u=s(5339),d=s(5730),m=s(9450);const p=i.vt(),f=i.vt(),g=i.vt(),T=i.vt(),x=r.vt(),v=new m.F5;class C{constructor(e,t,s){this.model=e,this.posBuffer=t,this.nrmBuffer=s,this.shapes=[],this.furs=[],this.waters=[]}reloadVertices(){for(let e=0;e<this.shapes.length;e++){const t=this.shapes[e];for(let e=0;e<t.length;e++)t[e].reloadVertices()}for(let e=0;e<this.furs.length;e++)this.furs[e].shape.reloadVertices();for(let e=0;e<this.waters.length;e++)this.waters[e].reloadVertices()}forceMaterialUpdates(e){console.log("[DEBUG_MODELS] Calling forceMaterialUpdates for ModelShapes.");for(let t=0;t<this.shapes.length;t++){const s=this.shapes[t];if(s)for(let t=0;t<s.length;t++){const n=s[t].material;n&&"function"==typeof n.rebindTextures?(console.log("[DEBUG_MODELS] Rebinding textures for main shape material."),n.rebindTextures(e)):n&&console.warn("[DEBUG_MODELS] Material for main shape found, but rebindTextures method is missing.")}}for(let t=0;t<this.furs.length;t++){const s=this.furs[t].shape.material;s&&"function"==typeof s.rebindTextures?(console.log("[DEBUG_MODELS] Rebinding textures for fur shape material."),s.rebindTextures(e)):s&&console.warn("[DEBUG_MODELS] Material for fur shape found, but rebindTextures method is missing.")}for(let t=0;t<this.waters.length;t++){const s=this.waters[t].material;s&&"function"==typeof s.rebindTextures?(console.log("[DEBUG_MODELS] Rebinding textures for water shape material."),s.rebindTextures(e)):s&&console.warn("[DEBUG_MODELS] Material for water shape found, but rebindTextures method is missing.")}}addRenderInsts(e,t,s,r,l,h,c,u){const m=(0,n.y5)(8,()=>new a.ve);this.model.isMapBlock||12&this.model.lightFlags?s.setupLights(m,d.zY.POINT):s.setupLights(m,d.zY.POINT|d.zY.DIRECTIONAL);const f={modelCtx:s,setupLights:e=>{for(let t=0;t<e.length;t++)e[t].copy(m[t])}};if(s.showMeshes)for(let n=0;n<3;n++)if(void 0!==this.shapes[n]){null!==r&&t.setCurrentRenderInstList(r.world[n]);for(let r=0;r<this.shapes[n].length;r++){const a=this.shapes[n][r];if(a.isDevGeometry&&!s.showDevGeometry)continue;i.C(p,l),(0,o.nF)(p,this.model.modelTranslate);let d=!0;s.cullByAabb&&void 0!==a.geom.aabb&&(v.transform(a.geom.aabb,p),d=s.sceneCtx.viewerInput.camera.frustum.contains(v)),d&&a.addRenderInsts(e,t,p,f,{},h,c,u)}}if(null!==r&&t.setCurrentRenderInstList(r.waters),s.showMeshes)for(let s=0;s<this.waters.length;s++)i.C(p,l),(0,o.nF)(p,this.model.modelTranslate),this.waters[s].addRenderInsts(e,t,p,f,{},h);if(null!==r&&t.setCurrentRenderInstList(r.furs),s.showMeshes)for(let s=0;s<this.furs.length;s++){const n=this.furs[s];for(let s=0;s<n.numLayers;s++)i.C(p,l),(0,o.nF)(p,[this.model.modelTranslate[0],this.model.modelTranslate[1]+.4*(s+1),this.model.modelTranslate[2]]),n.shape.addRenderInsts(e,t,p,f,{furLayer:s},h,void 0,23)}}destroy(e){for(let t=0;t<this.shapes.length;t++){const s=this.shapes[t];for(let t=0;t<s.length;t++)s[t].destroy(e)}this.shapes=[];for(let t=0;t<this.furs.length;t++)this.furs[t].shape.destroy(e);this.furs=[];for(let t=0;t<this.waters.length;t++)this.waters[t].destroy(e);this.waters=[]}}class b{constructor(e){this.version=e,this.sharedModelShapes=null,this.joints=[],this.coarseBlends=[],this.invBindTranslations=[],this.modelTranslate=r.vt(),this.cullRadius=10,this.lightFlags=0,this.materials=[],this.hasFineSkinning=!1,this.hasBetaFineSkinning=!1,this.fineSkinPositionQuantizeScale=0,this.fineSkinNormalQuantizeScale=0,this.fineSkinNBTNormals=!1,this.posFineSkins=[],this.nrmFineSkins=[]}createInstanceShapes(){return this.hasFineSkinning?this.createModelShapes():this.sharedModelShapes}getMaterials(){return this.materials}destroy(e){null!==this.sharedModelShapes&&(this.sharedModelShapes.destroy(e),this.sharedModelShapes=null)}}class _{getBoundingBox(){throw new Error("Method not implemented.")}constructor(e){this.model=e,this.matrixPalette=[],this.skinningDirty=!0;const t=this.model.joints.length+this.model.coarseBlends.length;0!==t?(this.skeletonInst=new h.l(this.model.skeleton),this.matrixPalette=(0,n.y5)(t,()=>i.vt())):this.matrixPalette=[i.vt()],this.skinningDirty=!0,this.modelShapes=e.createInstanceShapes()}getAmap(e){const t=8*((this.model.joints.length+8)/8|0);return(0,o.Y)(this.amap,e*t,t)}setAmap(e){this.amap=e}getMaterials(){return this.model.getMaterials()}resetPose(){i.D_(p);for(let e=0;e<this.model.joints.length;e++)this.skeletonInst.setPoseMatrix(e,p);this.skinningDirty=!0}setJointPose(e,t){e<0||e>=this.model.joints.length||(this.skeletonInst.setPoseMatrix(e,t),this.skinningDirty=!0)}addRenderInsts(e,t,s,n,i,r,a){this.updateSkinning(),s.showMeshes&&this.modelShapes.addRenderInsts(e,t,s,n,i,this.matrixPalette,r,a)}updateSkinning(){if(this.skinningDirty){for(let e=0;e<this.model.joints.length;e++){const t=this.model.joints[e];i.C(this.matrixPalette[t.boneNum],this.skeletonInst.getJointMatrix(t.boneNum))}for(let e=0;e<this.model.coarseBlends.length;e++){const t=this.model.coarseBlends[e];i.Tl(p,this.matrixPalette[t.joint0],this.model.invBindTranslations[t.joint0]),i.Ny(p,p,t.influence0),i.Tl(f,this.matrixPalette[t.joint1],this.model.invBindTranslations[t.joint1]),i.TV(this.matrixPalette[this.model.joints.length+e],p,f,t.influence1)}this.performFineSkinning(),this.skinningDirty=!1}}performFineSkinning(){if(!this.model.hasFineSkinning)return;const e=g,t=T,s=x;let n=1<<this.model.fineSkinPositionQuantizeScale,r=1/n;for(let a=0;a<this.model.posFineSkins.length;a++){const l=this.model.posFineSkins[a];i.C(e,this.matrixPalette[l.bone0]),i.C(t,this.matrixPalette[l.bone1]),this.model.hasBetaFineSkinning||(i.Tl(e,e,this.model.invBindTranslations[l.bone0]),i.Tl(t,t,this.model.invBindTranslations[l.bone1]));const h=this.model.originalPosBuffer,c=this.modelShapes.posBuffer;let d=l.bufferOffset,m=0;for(let a=0;a<l.vertexCount;a++){s[0]=h.getInt16(d)*r,s[1]=h.getInt16(d+2)*r,s[2]=h.getInt16(d+4)*r;const a=l.weights.getUint8(m)/128,f=l.weights.getUint8(m+1)/128;i.Ny(p,e,a),i.TV(p,p,t,f),(0,u.Ye)(s,p,s),(0,o.Tk)(c,d+0,s[0]*n),(0,o.Tk)(c,d+2,s[1]*n),(0,o.Tk)(c,d+4,s[2]*n),d+=6,m+=2}}n=1<<this.model.fineSkinNormalQuantizeScale,r=1/n;for(let a=0;a<this.model.nrmFineSkins.length;a++){const l=this.model.nrmFineSkins[a];i.C(e,this.matrixPalette[l.bone0]),i.C(t,this.matrixPalette[l.bone1]),this.model.hasBetaFineSkinning||(i.Tl(e,e,this.model.invBindTranslations[l.bone0]),i.Tl(t,t,this.model.invBindTranslations[l.bone1]));const h=this.model.originalNrmBuffer,c=this.modelShapes.nrmBuffer;let d=l.bufferOffset,m=0;for(let a=0;a<l.vertexCount;a++){s[0]=h.getInt8(d+0)*r,s[1]=h.getInt8(d+1)*r,s[2]=h.getInt8(d+2)*r;const a=l.weights.getUint8(m)/128,f=l.weights.getUint8(m+1)/128;i.Ny(p,e,a),i.TV(p,p,t,f),(0,u.bB)(s,p,s),(0,o.Gr)(c,d+0,s[0]*n),(0,o.Gr)(c,d+1,s[1]*n),(0,o.Gr)(c,d+2,s[2]*n),d+=3,m+=2}}this.modelShapes.reloadVertices()}destroy(e){null===this.model.sharedModelShapes&&this.modelShapes.destroy(e)}}class y{constructor(e,t,s,n){this.materialFactory=e,this.texFetcher=t,this.animController=s,this.modelVersion=n,this.models=[]}async init(e,t,s){const n=e.pathBase,[i,r]=await Promise.all([t.fetchData(`${n}/${s}/MODELS.tab`),t.fetchData(`${n}/${s}/MODELS.bin`)]);this.tab=i.createDataView(),this.bin=r}static async create(e,t,s,n,i,r,a){const o=new y(n,i,r,a);return await o.init(e,t,s),o}hasModel(e){return!(e<0||4*e>=this.tab.byteLength)&&0!==(0,o.Wg)(this.tab,0,e)}getNumModels(){return this.tab.byteLength/4|0}getModel(e){if(void 0===this.models[e]){console.log(`Loading model #${e} ...`);const t=(0,o.Wg)(this.tab,0,e);if(0===t)throw Error(`Model #${e} not found`);const s=16777215&t,n=this.bin.subarray(s+36),i=n.createDataView(),r=[i.getUint8(0),i.getUint8(1),i.getUint8(2),i.getUint8(3)],a=String.fromCharCode(...r);console.log(`Model #${e} raw data magic: '${a}'`);const h=(0,l.vR)(n);console.log(`Model #${e} raw data length: ${n.byteLength}, decompressed length: ${h.byteLength}`),this.models[e]=(0,c.c)(h.createDataView(),this.texFetcher,this.materialFactory,this.modelVersion)}return this.models[e]}destroy(e){for(let t of this.models)void 0!==t&&t.destroy(e)}}class S{constructor(e,t,s,n,i){this.gameInfo=e,this.texFetcher=t,this.materialFactory=s,this.animController=n,this.modelVersion=i,this.files={}}static async create(e,t,s,n,i=c.o.Demo){return new S(e,await t,s,n,i)}async loadSubdir(e,t){void 0===this.files[e]&&(this.files[e]=await y.create(this.gameInfo,t,e,this.materialFactory,this.texFetcher,this.animController,this.modelVersion),"shipbattle"===e?await this.loadSubdir("",t):"shop"===e&&await this.loadSubdir("swaphol",t))}async loadSubdirs(e,t){const s=[];for(let n of e)s.push(this.loadSubdir(n,t));await Promise.all(s)}getNumModels(){let e=0;for(let t in this.files){const s=this.files[t];e=Math.max(e,s.getNumModels())}return e}getModelsFileWithModel(e){for(let t in this.files)if(this.files[t].hasModel(e))return this.files[t];return null}getModel(e){const t=this.getModelsFileWithModel(e);if(null===t)throw Error(`Model ${e} not found`);return t.getModel(e)}createModelInstance(e){const t=this.getModel(e);if(null===t)throw Error(`Model ${e} not found`);return new _(t)}destroy(e){for(let t in this.files)this.files[t].destroy(e);this.files={}}}},8874(e,t,s){"use strict";s.d(t,{G:()=>X,g:()=>N});var n=s(7684),i=s(329),r=s(2003),a=s(9667),o=s(8771),l=s(7714),h=s(7911),c=s(7639),u=s(6253),d=s(5144),m=s(7459),p=s(3489),f=s(5974),g=s(738),T=s(6610),x=s(2007),v=s(6726),C=s(373),b=s(5093);class _ extends b.P{constructor(){super(...arguments),this.frag="\nuniform sampler2D u_DepthTexture;\n\nin vec2 v_TexCoord;\n\n// TODO: implement near-far scaling\n\nvoid main() {\n    float d = 1.0 - texture(SAMPLER_2D(u_DepthTexture), v_TexCoord).r;\n    gl_FragColor = vec4(d);\n}\n",this.vert=C.i.fullscreenVS}}const y=[{numUniformBuffers:0,numSamplers:1}];class S{constructor(e,t){this.textureMapping=new p.C$,this.targetDesc=new d.tR(l.$Y.U8_RGBA_RT),this.program=t.createProgram(new _),this.textureMapping.gfxSampler=t.createSampler({wrapS:l.Vf.Clamp,wrapT:l.Vf.Clamp,minFilter:l.gD.Point,magFilter:l.gD.Point,mipFilter:l.P.Nearest,minLOD:0,maxLOD:100})}render(e,t,s,n){const i=t.getRenderTargetDescription(n);this.targetDesc.setDimensions(i.width,i.height,1);const r=t.createRenderTargetID(this.targetDesc,"Depth Resampler Output"),a=s.newRenderInst();return a.setAllowSkippingIfPipelineNotReady(!1),a.setGfxProgram(this.program),a.setMegaStateFlags(v.BT),a.setBindingLayouts(y),a.setDrawCount(3),t.pushPass(e=>{e.setDebugName("Resample Depth"),e.attachRenderTargetID(d.jY.Color0,r);const i=t.resolveRenderTarget(n);e.attachResolveTexture(i),e.exec((e,t)=>{this.textureMapping.gfxTexture=t.getResolveTextureForID(i),a.setSamplerBindingsFromTextureMappings([this.textureMapping]),a.drawOnPass(s.gfxRenderCache,e)})}),r}}var w=s(4439);const A="\nuniform sampler2D u_Texture;\n\nlayout(std140) uniform ub_Params {\n    vec4 u_Misc[1];\n};\n#define u_HalfTexel (u_Misc[0].xy)\n";class E extends b.P{constructor(){super(...arguments),this.vert=C.i.fullscreenVS,this.frag=`\n${A}\n\nin vec2 v_TexCoord;\n\nvoid main() {\n    vec3 sum = texture(SAMPLER_2D(u_Texture), v_TexCoord).rgb * 4.0;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord - u_HalfTexel).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + u_HalfTexel).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(u_HalfTexel.x, -u_HalfTexel.y)).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(-u_HalfTexel.x, u_HalfTexel.y)).rgb;\n    sum /= 8.0;\n\n    gl_FragColor = vec4(sum, 1.0);\n}\n`}}class R extends b.P{constructor(){super(...arguments),this.vert=C.i.fullscreenVS,this.frag=`\n${A}\n\nin vec2 v_TexCoord;\n\nvoid main() {\n    vec3 sum = vec3(0.0);\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord - vec2(u_HalfTexel.x, u_HalfTexel.y)).rgb * 2.0;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(-u_HalfTexel.x, u_HalfTexel.y)).rgb * 2.0;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(u_HalfTexel.x, -u_HalfTexel.y)).rgb * 2.0;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(-u_HalfTexel.x, -u_HalfTexel.y)).rgb * 2.0;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(-u_HalfTexel.x * 2.0, 0.0)).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(0.0, u_HalfTexel.y * 2.0)).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(u_HalfTexel.x * 2.0, 0.0)).rgb;\n    sum += texture(SAMPLER_2D(u_Texture), v_TexCoord + vec2(0.0, -u_HalfTexel.y * 2.0)).rgb;\n    sum /= 12.0;\n\n    gl_FragColor = vec4(sum, 1.0);\n}\n`}}const I=[{numUniformBuffers:1,numSamplers:1}];class k{constructor(e){this.targetDesc=new d.tR(l.$Y.U8_RGBA_RT),this.target2Desc=new d.tR(l.$Y.U8_RGBA_RT),this.target4Desc=new d.tR(l.$Y.U8_RGBA_RT),this.target8Desc=new d.tR(l.$Y.U8_RGBA_RT),this.textureMapping=(0,f.y5)(1,()=>new p.C$),this.blurDownProgram=e.createProgram(new E),this.blurUpProgram=e.createProgram(new R);const t=e.createSampler({wrapS:l.Vf.Clamp,wrapT:l.Vf.Clamp,minFilter:l.gD.Bilinear,magFilter:l.gD.Bilinear,mipFilter:l.P.Nearest,minLOD:0,maxLOD:100});this.textureMapping[0].gfxSampler=t}allocateParameterBuffer(e,t){let s=e.allocateUniformBuffer(0,4);const n=e.mapUniformBufferF32(0);s+=(0,w.up)(n,s,.5/t.width,.5/t.height,0,0)}renderBlurPass(e,t,s,n,i,r,a,o){const l=t.newRenderInst();l.setAllowSkippingIfPipelineNotReady(!1),l.setMegaStateFlags(v.BT),l.setBindingLayouts(I),this.allocateParameterBuffer(l,i),l.setDrawCount(3),e.pushPass(i=>{let h;i.setDebugName(s),i.attachRenderTargetID(d.jY.Color0,a),void 0===o&&(h=e.resolveRenderTarget(r),i.attachResolveTexture(h)),i.exec((e,s)=>{l.setGfxProgram(n),l.setMegaStateFlags(v.BT),this.textureMapping[0].gfxTexture=void 0===o?s.getResolveTextureForID(h):o,l.setSamplerBindingsFromTextureMappings(this.textureMapping),l.drawOnPass(t.gfxRenderCache,e)})})}render(e,t,s,n,i){this.targetDesc.setDimensions(s,n,1),this.target2Desc.setDimensions(s>>>1,n>>>1,1),this.target4Desc.setDimensions(this.target2Desc.width>>>1,this.target2Desc.height>>>1,1),this.target8Desc.setDimensions(this.target4Desc.width>>>1,this.target4Desc.height>>>1,1);const r=e.createRenderTargetID(this.target2Desc,"Blur 1/2"),a=e.createRenderTargetID(this.target4Desc,"Blur 1/4"),o=e.createRenderTargetID(this.target8Desc,"Blur 1/8"),l=e.createRenderTargetID(this.targetDesc,"Blur Output");return this.renderBlurPass(e,t,"Blur Down To 1/2",this.blurDownProgram,this.targetDesc,null,r,i),this.renderBlurPass(e,t,"Blur Down To 1/4",this.blurDownProgram,this.target2Desc,r,a),this.renderBlurPass(e,t,"Blur Down To 1/8",this.blurDownProgram,this.target4Desc,a,o),this.renderBlurPass(e,t,"Blur Up To 1/4",this.blurUpProgram,this.target8Desc,o,a),this.renderBlurPass(e,t,"Blur Up To 1/2",this.blurUpProgram,this.target4Desc,a,r),this.renderBlurPass(e,t,"Blur Up To Output",this.blurUpProgram,this.target2Desc,r,l),l}}var M=s(5339),P=s(1158);const D=(0,m.Jo)(35795763),B=n.vt();n.v3(B,0,640,0,480,1,100);const L=i.vt(),O=new o.TD,F=new o.$r,U=new o.gA;function N(e,t,s,n,i){s.setOnRenderInst(e.gfxRenderCache,t),t.setSamplerBindingsFromTextureMappings(n.m_TextureMapping),s.allocateMaterialParamsDataOnInst(t,n),s.allocateDrawParamsDataOnInst(t,i)}class X{constructor(e,t,s){this.animController=t,this.materialFactory=s,this.opaqueColorTextureMapping=new p.C$,this.opaqueDepthTextureMapping=new p.C$,this.temporalTextureMapping=new p.C$,this.temporalTexture=new d.xH,this.mainColorDesc=new d.tR(l.$Y.U8_RGBA_RT),this.mainDepthDesc=new d.tR(l.$Y.D24_S8),this.shimmerddraw=new g.l,this.enableHeatShimmer=!1,this.heatShimmerMaterial=void 0,this.renderHelper=new o.BC(e.device,e,this.materialFactory.cache),this.depthResampler=new S(e.device,this.renderHelper.renderInstManager.gfxRenderCache),this.shimmerddraw.setVtxDesc(r.cg.POS,!0),this.shimmerddraw.setVtxDesc(r.cg.CLR0,!1),this.shimmerddraw.setVtxDesc(r.cg.TEX0,!0),this.renderLists={skyscape:new h.Qz,world:(0,f.y5)(3,()=>new h.Qz),waters:new h.Qz,furs:new h.Qz};const n=this.renderHelper.renderCache;this.opaqueColorTextureMapping.gfxSampler=n.createSampler({wrapS:l.Vf.Clamp,wrapT:l.Vf.Clamp,minFilter:l.gD.Bilinear,magFilter:l.gD.Bilinear,mipFilter:l.P.Nearest,minLOD:0,maxLOD:100}),this.opaqueDepthTextureMapping.gfxSampler=n.createSampler({wrapS:l.Vf.Clamp,wrapT:l.Vf.Clamp,minFilter:l.gD.Point,magFilter:l.gD.Point,mipFilter:l.P.Nearest,minLOD:0,maxLOD:100})}adjustCameraController(e){e.setSceneMoveSpeedMult(1/3)}getDefaultWorldMatrix(e){n.i1(e,3*-Math.PI/4)}update(e){this.animController.update(e)}addSkyRenderInsts(e,t,s,n){}addSkyRenderPasses(e,t,s,n,i,r){}addWorldRenderInsts(e,t,s,n){}addWorldRenderPassesInner(e,t,s,n){}renderHeatShimmer(e,t,s,l,h,c,u){const p=this.renderHelper.pushTemplateRenderInst();(0,o.gI)(O,B,u.viewerInput.backbufferWidth,u.viewerInput.backbufferHeight);let f=p.getUniformBufferOffset(a.vn.ub_SceneParams);const g=p.mapUniformBufferF32(a.vn.ub_SceneParams);(0,o.E_)(g,f,O);const v=L;(0,M.Bl)(v,u.viewerInput.camera.worldMatrix),i.ze(v,v);const C=(0,x.M3)((0,x.vT)(v));let b;b=C<0?4*(((65535&C)>>8)-192)&252:255;const _=255*b>>8;this.shimmerddraw.beginDraw(s.gfxRenderCache),this.shimmerddraw.begin(r.uB.DRAW_QUADS),this.shimmerddraw.position3f32(0,0,-8),this.shimmerddraw.color4rgba8(r.cg.CLR0,0,0,0,_),this.shimmerddraw.texCoord2f32(r.cg.TEX0,0,0),this.shimmerddraw.position3f32(640,0,-8),this.shimmerddraw.color4rgba8(r.cg.CLR0,0,0,0,_),this.shimmerddraw.texCoord2f32(r.cg.TEX0,1,0),this.shimmerddraw.position3f32(640,480,-8),this.shimmerddraw.color4rgba8(r.cg.CLR0,0,0,0,254),this.shimmerddraw.texCoord2f32(r.cg.TEX0,1,1),this.shimmerddraw.position3f32(0,480,-8),this.shimmerddraw.color4rgba8(r.cg.CLR0,0,0,0,254),this.shimmerddraw.texCoord2f32(r.cg.TEX0,0,1),this.shimmerddraw.end();const y=this.shimmerddraw.endDrawAndMakeRenderInst(s);void 0===this.heatShimmerMaterial&&(this.heatShimmerMaterial=new T.JT(this.materialFactory));const S={sceneCtx:u,modelToViewMtx:n.vt(),viewToModelMtx:n.vt(),ambienceIdx:0,outdoorAmbientColor:m.c,furLayer:0};this.heatShimmerMaterial.setOnMaterialParams(U,S),F.clear(),N(s,y,this.heatShimmerMaterial.getGXMaterialHelper(),U,F),s.popTemplateRenderInst();const w=this.depthResampler.render(e,t,s,c);t.pushPass(e=>{e.setDebugName("Heat Shimmer"),e.attachRenderTargetID(d.jY.Color0,l);const n=t.resolveRenderTarget(w);e.attachResolveTexture(h),e.attachResolveTexture(n),e.exec((e,t)=>{this.opaqueColorTextureMapping.gfxTexture=t.getResolveTextureForID(h),y.resolveLateSamplerBinding("opaque-color-texture-downscale-2x",this.opaqueColorTextureMapping),this.opaqueDepthTextureMapping.gfxTexture=t.getResolveTextureForID(n),y.resolveLateSamplerBinding("opaque-depth-texture-downscale-2x",this.opaqueDepthTextureMapping),y.drawOnPass(s.gfxRenderCache,e)})})}blurTemporalTexture(e,t){return void 0===this.blurFilter&&(this.blurFilter=new k(this.renderHelper.renderCache)),this.blurFilter.render(e,t,this.mainColorDesc.width,this.mainColorDesc.height,this.temporalTexture.getTextureForSampling())}attachResolveTexturesForWorldOpaques(e,t){}resolveLateSamplerBindingsForWorldOpaques(e,t){}addWorldRenderPasses(e,t,s,n,i,r,a){let o;this.addWorldRenderPassesInner(e,t,s,a),n.world[0].hasLateSamplerBinding("temporal-texture-downscale-8x")&&(o=this.blurTemporalTexture(t,s)),t.pushPass(e=>{let a;e.setDebugName("World Opaques"),e.attachRenderTargetID(d.jY.Color0,i),e.attachRenderTargetID(d.jY.DepthStencil,r),void 0!==o&&(a=t.resolveRenderTarget(o),e.attachResolveTexture(a)),this.attachResolveTexturesForWorldOpaques(t,e),e.exec((e,t)=>{void 0!==o&&(this.temporalTextureMapping.gfxTexture=t.getResolveTextureForID(a),n.world[0].resolveLateSamplerBinding("temporal-texture-downscale-8x",this.temporalTextureMapping)),this.resolveLateSamplerBindingsForWorldOpaques(n.world[0],t),n.world[0].drawOnPassRenderer(s.gfxRenderCache,e),n.furs.drawOnPassRenderer(s.gfxRenderCache,e)})});const l=t.resolveRenderTarget(i);this.enableHeatShimmer&&this.renderHeatShimmer(e,t,s,i,l,r,a),t.pushPass(e=>{e.setDebugName("World Translucents"),e.attachRenderTargetID(d.jY.Color0,i),e.attachRenderTargetID(d.jY.DepthStencil,r),e.attachResolveTexture(l),e.exec((e,t)=>{this.opaqueColorTextureMapping.gfxTexture=t.getResolveTextureForID(l),n.waters.resolveLateSamplerBinding("opaque-color-texture-downscale-2x",this.opaqueColorTextureMapping),n.waters.drawOnPassRenderer(s.gfxRenderCache,e),n.world[1].drawOnPassRenderer(s.gfxRenderCache,e),n.world[2].drawOnPassRenderer(s.gfxRenderCache,e)})})}addHeatShimmerRenderInsts(e,t,s,n){}render(e,t){this.update(t),t.camera.setClipPlanes(2.5,2e7),this.renderHelper.pushTemplateRenderInst();const s=this.renderHelper.renderInstManager,i={viewerInput:t,worldToViewMtx:n.vt(),viewToWorldMtx:n.vt(),animController:this.animController,flipYScale:(0,P.H)(e)?-1:1,world:this.world};(0,c.sq)(i.worldToViewMtx,t.camera),n.B8(i.viewToWorldMtx,i.worldToViewMtx),this.addSkyRenderInsts(e,s,this.renderLists,i),this.addWorldRenderInsts(e,s,this.renderLists,i);const r=this.renderHelper.renderGraph.newGraphBuilder();(0,u.Rs)(this.mainColorDesc,t),this.mainColorDesc.clearColor=D,this.mainDepthDesc.copyDimensions(this.mainColorDesc),this.mainDepthDesc.clearDepth=u.Od.clearDepth,this.temporalTexture.setDescription(e,this.mainColorDesc);const a=r.createRenderTargetID(this.mainColorDesc,"Main Color"),o=r.createRenderTargetID(this.mainDepthDesc,"Main Depth");this.addSkyRenderPasses(e,r,s,this.renderLists,a,i),this.addWorldRenderPasses(e,r,s,this.renderLists,a,o,i),this.enableHeatShimmer&&this.addHeatShimmerRenderInsts(e,s,this.renderLists,i),this.renderHelper.debugThumbnails.pushPasses(r,s,a,t.mouseLocation),this.renderHelper.antialiasingSupport.pushPasses(r,t,a),r.resolveRenderTargetToExternalTexture(a,t.onscreenTexture),r.pushPass(e=>{e.setDebugName("Copy to Temporal Texture"),e.attachRenderTargetID(d.jY.Color0,a)}),r.resolveRenderTargetToExternalTexture(a,this.temporalTexture.getTextureForResolving()),s.popTemplateRenderInst(),this.renderHelper.prepareToRender(),this.renderHelper.renderGraph.execute(r)}destroy(e){this.materialFactory.destroy(e),this.renderHelper.destroy(),this.temporalTexture.destroy(e)}}},9702(e,t,s){"use strict";s.d(t,{JW:()=>p,sY:()=>m,vR:()=>d});var n,i=s(305),r=s(1413);!function(e){e[e.M1=0]="M1",e[e.M2=64]="M2",e[e.M3=32]="M3",e[e.M4=16]="M4"}(n||(n={}));var a=s(6223),o=s(2141),l=s(3793),h=s(7635);class c{constructor(e){this.magic=e.getUint32(0),this.unk4=e.getUint32(4),this.unk8=e.getUint32(8),this.size=e.getUint32(12)}}function u(e){return e.charCodeAt(0)<<24|e.charCodeAt(1)<<16|e.charCodeAt(2)<<8|e.charCodeAt(3)}function d(e){switch(e.createDataView().getUint32(0)){case u("ZLB\0"):return new i.A(function(e){const t=e.createDataView(),s=new c(t);return s.magic,u("ZLB\0"),function(e){const t=r.T.deflate_decompress(e.createTypedArray(Uint8Array));return i.A.fromView(t)}(e.subarray(c.SIZE,s.size)).arrayBuffer}(e));case u("DIRn"):return new i.A(function(e){const t=e.createDataView().getUint32(8);return e.copyToBuffer(32,t)}(e));case u("LZOn"):return new i.A(function(e,t){const s=e.createDataView().getUint32(t+8);return t+=16,function(e,t){const s=e.createDataView();if(s.byteLength<3)throw"Input Overrun";let r=0,a=0,o=0,l=0,h=0,c=0;const u=new Uint8Array(t);function d(e){if(r+e>s.byteLength)throw"Input overrun"}function m(e){if(a+e>t)throw"Output overrun"}function p(){const e=r;for(;0===s.getUint8(r);)++r;return r-e}if(s.getUint8(r)>=22){const e=s.getUint8(r++)-17;d(e),m(e);for(let t=0;t<e;++t)u[a++]=s.getUint8(r++);h=4}else if(s.getUint8(r)>=18){c=s.getUint8(r++)-17,h=c,d(c),m(c);for(let e=0;e<c;++e)u[a++]=s.getUint8(r++)}for(;;){d(1);const e=s.getUint8(r++);if(192&e)d(1),o=a-((s.getUint8(r++)<<3)+(e>>>2&7)+1),l=(e>>>5)+1,c=3&e;else if(e&n.M3){if(l=2+(31&e),2===l){const e=p();d(1),l+=255*e+31+s.getUint8(r++)}d(2),c=s.getUint16(r,!0),r+=2,o=a-((c>>>2)+1),c&=3}else if(e&n.M4){if(l=2+(7&e),2===l){const e=p();d(1),l+=255*e+7+s.getUint8(r++)}if(d(2),c=s.getUint16(r,!0),r+=2,o=a-(((8&e)<<11)+(c>>>2)),c&=3,o===a)break;o-=16384}else{if(0===h){let t=e+3;if(3===t){const e=p();d(1),t+=255*e+15+s.getUint8(r++)}d(t),m(t);for(let e=0;e<t;++e)u[a++]=s.getUint8(r++);h=4;continue}4!==h?(d(1),c=3&e,o=a-((e>>>2)+(s.getUint8(r++)<<2)+1),l=2):(d(1),c=3&e,o=a-((e>>>2)+(s.getUint8(r++)<<2)+2049),l=3)}if(o<0)throw"Lookbehind overrun";d(c),m(l+c);for(let e=0;e<l;++e)u[a++]=u[o++];h=c;for(let e=0;e<c;++e)u[a++]=s.getUint8(r++)}if(3!==l)throw"LZO terminator not reached";return new i.A(u.buffer,0,a)}(e.slice(t),s).arrayBuffer}(e,0));default:return e}}function m(e,t){if(void 0===t.subdirs[e])throw Error(`Subdirectory for location ${e} unknown`);return t.subdirs[e]}c.SIZE=16;class p{constructor(e,t,s,n,i){this.device=e,this.gameInfo=t,this.subdirs=s,this.materialFactory=n,this.animController=i}async init(e){const t=h.JU.create(this.gameInfo,e,!1),s=this.gameInfo.pathBase,[n,i,r,c,u,d,m]=await Promise.all([t,o.Ju.create(this.gameInfo,t,this.materialFactory,this.animController,l.o.Final),a.K4.create(this.gameInfo,e,this.subdirs[0]),a.E0.create(this.gameInfo,e),a.y5.create(this.gameInfo,e),e.fetchData(`${s}/TABLES.tab`),e.fetchData(`${s}/TABLES.bin`)]);this.texFetcher=n,this.modelFetcher=i,this.animColl=r,this.amapColl=c,this.modanimColl=u,this.tablesTab=d.createDataView(),this.tablesBin=m.createDataView(),await Promise.all([this.texFetcher.loadSubdirs(this.subdirs,e),this.modelFetcher.loadSubdirs(this.subdirs,e)])}static async create(e,t,s,n,i,r){const a=new p(e,t,n,i,r);return await a.init(s),a}destroy(e){this.texFetcher.destroy(e),this.modelFetcher.destroy(e)}}},3209(e,t,s){"use strict";s.d(t,{Dx:()=>Be,Ij:()=>Oe,$Q:()=>Le,aL:()=>Ue});var n=s(3292),i=s(329),r=s(7684),a=s(8880),o=s(8645),l=s(9667),h=s(8771),c=(s(353),s(7459)),u=s(9702),d=s(7639);class m{constructor(e,t){}mount(e,t){}unmount(e,t){}update(e,t){}}var p=s(2007);function f(e,t,s,n,i,r){void 0!==s&&(e.yaw=(0,p.so)(t.getInt8(s)<<8)),void 0!==n&&(e.pitch=(0,p.so)(t.getInt8(n)<<8)),void 0!==i&&(e.roll=(0,p.so)(t.getInt8(i)<<8)),void 0!==r&&(e.animSpeed=r)}function g(e,t,s,n){return class extends m{constructor(i,r){super(i,r),f(i,r,e,t,s,n)}}}function T(e=1){return class extends m{constructor(t,s){super(t,s),f(t,s,26,25,24),t.animSpeed=e;const n=s.getUint8(27);0!==n&&(t.scale*=n/255)}}}function x(){return class extends m{constructor(e,t){super(e,t),f(e,t,24),e.setModelNum(t.getInt8(25))}}}var v=s(9450);function C(e){return{flags:e.getUint8(0),type:e.getUint8(1),param:e.getUint16(2)}}const b=i.vt(),_=i.vt(),y=r.vt(),S=r.vt();var w=s(5730);const A=i.vt(),E=[(0,c.Jo)(4290773247),(0,c.Jo)(4286513407),(0,c.Jo)(4290773247),(0,c.Jo)(4290773247),(0,c.Jo)(16777215),(0,c.Jo)(4278190335),(0,c.Jo)(16711935),(0,c.Jo)(4294902015),(0,c.Jo)(4282384639),(0,c.Jo)(4290773247),(0,c.Jo)(8388607),(0,c.Jo)(4294902015),(0,c.Jo)(4294967295),(0,c.Jo)(4294967295),(0,c.Jo)(4294967295)],R=[[(0,c.Jo)(4290773247),(0,c.Jo)(4286513407),(0,c.Jo)(4290773247),(0,c.Jo)(4290773247),(0,c.Jo)(16777215),(0,c.Jo)(4278190335),(0,c.Jo)(16711935),(0,c.Jo)(4294902015),(0,c.Jo)(4282384639),(0,c.Jo)(4290773247),(0,c.Jo)(8388607),(0,c.Jo)(4294902015),(0,c.Jo)(4294967295),(0,c.Jo)(4294967295),(0,c.Jo)(4294967295),(0,c.Jo)(4278190335)],[(0,c.Jo)(4290773247),(0,c.Jo)(4290789631),(0,c.Jo)(3229614079),(0,c.Jo)(4290773247),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255),(0,c.Jo)(255)]];var I=s(6610),k=s(2003);function M(e,t){return Math.random()*(t-e+1)+e|0}const P={77:g(61,62),198:g(),201:g(42),204:g(42),207:g(40),209:class extends m{constructor(e,t){super(e,t),f(e,t,26),e.roll=(0,p.so)(128*(t.getUint8(24)-127)),e.pitch=(0,p.so)(128*(t.getUint8(25)-127)),e.scale=t.getFloat32(28)}},213:class extends m{constructor(e,t){super(e,t),e.scale=.5+t.getInt8(40)/15}},214:g(26,25,24),222:g(),227:g(),231:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.scale=5*t.getInt16(26)/32767,e.scale<.05&&(e.scale=.05)}},232:class extends m{constructor(e,t){super(e,t),f(e,t,41),e.scale=Math.max(t.getUint8(42),5)/128}},233:g(),234:g(),235:g(),237:g(27,34,35),238:g(),239:class extends m{constructor(e,t){super(e,t),f(e,t,34),e.position[1]+=.5}},240:g(24),244:g(24),248:g(),249:class extends m{constructor(e,t){super(e,t),f(e,t,31,28);const s=t.getUint8(29);0!==s&&(e.scale*=s/64)}},250:class extends m{constructor(e,t){super(e,t);const s=t.getUint8(29);0!==s&&(e.scale*=s/64)}},251:g(24),254:g(29,void 0,void 0,.005),255:class extends m{constructor(e,t){super(e,t),e.setModelNum(t.getInt8(38))}},256:g(26),258:g(),259:class extends m{constructor(e,t){super(e,t),e.scale*=t.getUint8(24)/100}},260:g(24),261:g(24),266:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.position[1]+=t.getInt16(26),e.setModelNum(t.getInt8(25))}},269:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.pitch=(0,p.so)(t.getInt16(28)<<8),e.scale=3.15}},272:class extends m{constructor(e,t){super(e,t),f(e,t,31);const s=t.getUint8(33)/64;0===s?e.scale=1:e.scale*=s}},273:g(26,25,24),274:g(28),275:g(28),280:g(),282:T(),283:g(),284:g(24),285:g(24),287:g(35),289:g(24),288:g(25),291:g(),293:class extends m{constructor(e,t){super(e,t),f(e,t,44,45)}},294:class extends m{performActions(e,t){for(let e of this.actions)e.flags}constructor(e,t){super(e,t),f(e,t,61,62),this.actions=[];for(let e=0;e<8;e++){const s=C((0,p.Y)(t,X,4,e));this.actions.push(s)}if(76===e.commonObjectParams.objType){(0,p.YY)(y,1,1,1,e.yaw,e.pitch,e.roll,e.position[0],e.position[1],e.position[2]),i.hZ(b,1,0,0),i.Z0(b,b,y),i.hZ(_,0,1,0),i.Z0(_,_,y),r.B8(S,y);const t=new v.Zc;t.setTri(e.position,b,_);const s=r.o8(S),n=100*e.scale;this.triggerData={plane:t,worldToPlaneSpaceMatrix:s,radius:n}}}update(e,t){if(76===e.commonObjectParams.objType){const s=b;if((0,p.YV)(s,t.viewerInput.camera),void 0===this.prevPoint)this.prevPoint=i.o8(s);else{const t=this.triggerData.plane.distance(this.prevPoint[0],this.prevPoint[1],this.prevPoint[2])>=0,n=this.triggerData.plane.distance(s[0],s[1],s[2])>=0;if(n!==t){const t=_;this.triggerData.plane.intersectLineSegment(t,this.prevPoint,s),i.Z0(t,t,this.triggerData.worldToPlaneSpaceMatrix),-this.triggerData.radius<=t[0]&&t[0]<=this.triggerData.radius&&-this.triggerData.radius<=t[1]&&t[1]<=this.triggerData.radius&&this.performActions(e,!n)}i.C(this.prevPoint,s)}}}},296:class extends m{constructor(e,t){super(e,t);let s=t.getUint8(28);s<10&&(s=10),s/=64,e.scale*=s,e.yaw=(0,p.so)((63&t.getUint8(29))<<10)}},297:class extends m{constructor(e,t){super(e,t);const s=t.getUint8(26);0!==s&&(e.scale=.01*s)}},298:class extends m{constructor(e,t){super(e,t),482===e.objType.typeNum||888!==e.objType.typeNum&&889!==e.objType.typeNum||f(e,t,24)}},299:class extends m{constructor(e,t){super(e,t),f(e,t,36,35,34),e.scale=.1}},300:g(24),302:T(),303:T(),304:g(),306:g(28,27,26),307:g(),308:class extends(g()){mount(e,t){if(null===t.mapInstance)throw Error("No map available when spawning texscroll");const s=t.mapInstance.getBlockAtPosition(e.posInMap[0],e.posInMap[2]);if(null===s)console.warn("Couldn't find block for texscroll object");else{const t=e.objParams.getInt16(24),n=e.objParams.getInt8(30),i=e.objParams.getInt8(31),r=(0,p.Wg)(e.world.resColl.tablesTab,0,14),a=32767&(0,p.Wg)(e.world.resColl.tablesBin,0,r+t);let o=!0;const l=s.getMaterials();for(let t=0;t<l.length;t++)if(void 0!==l[t]){const s=l[t];for(let t=0;t<s.shader.layers.length;t++){const r=s.shader.layers[t];if(r.texId===a){o=!1;const t=e.world.resColl.texFetcher.getTexture(e.world.renderCache,a,!0),l=(n<<16)/t.width,h=(i<<16)/t.height;r.scrollSlot=s.factory.addScrollSlot(l,h),s.rebuild()}}}o&&console.warn("Couldn't find material texture for scrolling")}}},309:g(),312:g(),313:g(),316:g(),317:g(),318:class extends m{constructor(e,t){super(e,t);const s=t.getInt8(24);e.setModelNum(s)}},319:g(),320:g(),321:g(),329:class extends m{constructor(e,t){super(e,t);const s=t.getInt8(25);let n;n=0===s?90:4*s,e.scale*=n/90}},330:class extends m{constructor(e,t){super(e,t),f(e,t,24);const s=t.getInt16(30);85===s?e.setModelNum(2):86===s&&e.setModelNum(1)}},332:g(),343:g(),344:g(),346:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)(t.getInt16(26)),e.pitch=(0,p.so)(t.getInt16(28)),e.roll=(0,p.so)(t.getInt16(30));let s=t.getInt8(61);0===s&&(s=20),e.scale*=s/20}},347:g(24),356:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(86),e.world.envfxMan.loadEnvfx(13),e.world.envfxMan.loadEnvfx(17),e.world.envfxMan.loadEnvfx(14)}},359:class extends m{constructor(e,t){super(e,t),f(e,t,24);let s=t.getInt8(25)/64;0===s&&(s=1),e.scale*=s}},363:g(24),372:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.scale+=t.getUint8(25)/512}},373:g(),382:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(314),e.world.envfxMan.loadEnvfx(312),e.world.envfxMan.loadEnvfx(313)}},383:class extends m{constructor(e,t){super(e,t),f(e,t,31);const s=t.getUint8(33);0!==s&&(e.scale*=s/64)}},385:class extends m{constructor(e,t){super(e,t),f(e,t,27,26,25),e.scale=.1}},387:g(),389:g(),390:g(26),391:g(26),392:g(26),393:g(24),394:g(26),395:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(575),e.world.envfxMan.loadEnvfx(576),e.world.envfxMan.loadEnvfx(577)}},415:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.pitch=(0,p.so)(t.getInt16(26)),e.roll=(0,p.so)(t.getInt16(28))}},416:g(),417:g(28),418:g(),419:g(),420:g(),421:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(180),e.world.envfxMan.loadEnvfx(181),e.world.envfxMan.loadEnvfx(182),e.world.envfxMan.loadEnvfx(183)}},423:g(),424:g(void 0,void 0,void 0,.008),425:g(31),427:g(24),429:class extends m{constructor(e,t){super(e,t),f(e,t,25,void 0,void 0,.006),e.scale*=t.getUint16(28)/1e3}},430:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(434),e.world.envfxMan.loadEnvfx(435),e.world.envfxMan.loadEnvfx(436)}mount(){}},437:g(),438:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(79),e.world.envfxMan.loadEnvfx(80),e.world.envfxMan.loadEnvfx(581)}mount(e,t){t.envfxMan.mistEnable=!0,t.envfxMan.mistBottom=-1e3,t.envfxMan.mistTop=t.envfxMan.mistBottom+50}unmount(e,t){t.envfxMan.mistEnable=!1}},439:class extends m{constructor(e,t){super(e,t),f(e,t,26),e.roll=(0,p.so)(128*(t.getUint8(24)-127)),e.pitch=(0,p.so)(128*(t.getUint8(25)-127)),e.scale=3.6*t.getFloat32(28)}},440:g(26),442:g(),445:g(24),447:g(28),448:g(),451:g(24),452:g(24),453:g(24),454:class extends m{constructor(e,t){super(e,t),470!==e.objType.typeNum&&f(e,t,40)}},455:g(24),456:g(28),457:g(24),459:g(24),461:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(352),e.world.envfxMan.loadEnvfx(346),e.world.envfxMan.loadEnvfx(348),e.world.envfxMan.loadEnvfx(351)}},465:g(),469:g(24),472:g(28),473:g(24),477:g(24),487:g(),488:g(),489:class extends m{constructor(e,t){super(e,t);const s=t.getInt8(26);e.setModelNum(s)}},490:g(),491:g(),492:g(),496:g(24),497:class extends m{constructor(e,t){super(e,t),f(e,t,24);const s=0!=t.getInt8(25)?1:0;e.setModelNum(s)}},500:class extends m{constructor(e,t){super(e,t),996===e.objType.typeNum?f(e,t,26):f(e,t,24),e.pitch=0,e.roll=0}},502:class extends m{constructor(e,t){super(e,t),2051!==e.objType.typeNum&&f(e,t,24)}},509:g(),510:g(24),513:g(24),518:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)((63&t.getUint8(24))<<10);const s=t.getInt16(26);e.scale=s<1?.1:s/8192;let n=1;if(!t.getUint8(25)){const e=t.getUint16(28);4&e?n=4:8&e?n=8:16&e&&(n=6)}const r=E[n];1797===e.commonObjectParams.objType||1810===e.commonObjectParams.objType?i.v_(A):i.hZ(A,0,7,0),this.light=(0,w.Ts)(A,r,40,65),this.light.obj=e}mount(e,t){t.worldLights.addLight(this.light)}unmount(e,t){t.worldLights.removeLight(this.light)}},521:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(60)}},523:g(),524:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.pitch=(0,p.so)(t.getInt16(26)<<8)}},525:g(24),533:g(),535:g(30),538:class extends m{constructor(e,t){super(e,t);const s=t.getInt16(28);s>1&&(e.scale*=s)}},541:g(24),542:g(24),543:g(24),544:class extends m{constructor(e,t){super(e,t),f(e,t,24,25),e.roll=(0,p.so)(t.getInt16(28))}},549:g(),550:class extends m{constructor(e,t){super(e,t);let s=t.getInt16(26);0===s&&(s=500),e.scale=1/(s/M(600,1e3))}},551:class extends m{constructor(e,t){super(e,t),e.position[1]+=t.getInt16(26)}},552:g(24),576:g(),579:g(24),597:g(24),598:g(24),599:g(24),602:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)(-t.getInt16(28)),e.pitch=(0,p.so)(-t.getInt16(30)),e.roll=(0,p.so)(-t.getInt16(32))}},603:g(31),609:g(24),613:g(30),614:g(24),616:g(),617:g(24),619:g(24),620:class extends m{constructor(e,t){super(e,t),2154!==e.objType.typeNum&&2155!==e.objType.typeNum&&f(e,t,24)}},622:g(),623:g(24),627:class extends m{constructor(e,t){super(e,t),f(e,t,24,25),e.roll=0;const s=t.getInt16(28);0!=s&&(e.scale*=.1*s)}},641:g(24),642:g(),643:g(24),644:class extends m{constructor(e,t){super(e,t),f(e,t,26,27),e.setModelNum(t.getInt8(24))}},645:g(),646:g(),648:class extends m{constructor(e,t){super(e,t),f(e,t,24);const s=t.getInt16(26);0!==s&&(e.scale=10*s/32767)}},650:g(24),653:class extends m{constructor(e,t){super(e,t),e.world.envfxMan.loadEnvfx(507),e.world.envfxMan.loadEnvfx(511),e.world.envfxMan.loadEnvfx(508),e.world.envfxMan.loadEnvfx(509)}},654:x(),656:class extends m{constructor(e,t){super(e,t),e.setModelNum(t.getInt8(25))}},657:class extends m{constructor(e,t){super(e,t),e.position[1]+=25,e.setModelNum(t.getInt8(25))}},658:x(),659:class extends m{constructor(e,t){super(e,t),f(e,t,24,25,26),e.setModelNum(t.getInt8(33))}},660:g(24),661:x(),662:x(),663:class extends m{constructor(e,t){super(e,t),f(e,t,24),e.setModelNum(t.getInt8(25));const s=e.modelInst.getMaterials();for(let e=0;e<s.length;e++){const t=s[e];void 0!==t&&t instanceof I.FU&&(t.setBlendOverride(e=>{e.setBlendMode(k.Nx.BLEND,k.dn.SRCALPHA,k.dn.ONE),e.setZMode(!0,k.oH.LEQUAL,!1)}),t.rebuild())}}},664:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)(-16384)}},666:g(),671:g(24),672:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)(-32768)}},674:g(),678:g(24,25,26),679:class extends m{constructor(e,t){super(e,t),e.yaw=(0,p.so)(M(0,65535)),e.pitch=(0,p.so)(M(0,65535)),e.roll=(0,p.so)(M(0,65535))}},681:class extends m{constructor(e,t){super(e,t),f(e,t,24,25),0===t.getUint8(33)?e.setModelNum(0):e.setModelNum(1);const s=t.getUint16(34),n=t.getUint16(36),r=(0,c.gv)(t.getUint8(26)/255,t.getUint8(27)/255,t.getUint8(28)/255,1);i.v_(A),this.light=(0,w.Ts)(A,r,s,n),this.light.obj=e,this.light.affectsMap=!!t.getUint8(63)}mount(e,t){t.worldLights.addLight(this.light)}unmount(e,t){t.worldLights.removeLight(this.light)}},682:g(24,25),683:class extends m{constructor(e,t){var s,n;super(e,t),f(e,t,24,25,52);const r=t.getUint16(26),a=t.getUint16(28),o=(0,c.gv)(t.getUint8(45)/255,t.getUint8(46)/255,t.getUint8(47)/255,t.getUint8(55)/255),l=t.getUint16(36);this.texture=0===l?e.world.resColl.texFetcher.getTexture(e.world.renderCache,1500,!1):e.world.resColl.texFetcher.getTexture(e.world.renderCache,l,!1),console.log(`loaded projected light texture ${null===(n=null===(s=this.texture)||void 0===s?void 0:s.viewerTexture)||void 0===n?void 0:n.name}`),i.v_(A),this.light=(0,w.Ts)(A,o,r,a),this.light.obj=e}mount(e,t){t.worldLights.addLight(this.light)}unmount(e,t){t.worldLights.removeLight(this.light)}},685:T(.005),686:T(),687:T(.0025),688:T(),689:class extends m{constructor(e,t){super(e,t),f(e,t,26,25,24);const s=t.getUint8(27),n=R[1880===e.commonObjectParams.objType?1:0][s],r=(8&t.getUint8(42)?520:130)*e.scale,a=r+40;1880===e.commonObjectParams.objType?i.v_(A):i.hZ(A,0,7,0),this.light=(0,w.Ts)(A,n,r,a),this.light.obj=e,this.light.affectsMap=!!(32&t.getUint8(41))}mount(e,t){t.worldLights.addLight(this.light)}unmount(e,t){t.worldLights.removeLight(this.light)}},690:g(26,25,24),691:class extends m{constructor(e,t){super(e,t),f(e,t);const s=e.modelInst.getMaterials();for(let e=0;e<s.length;e++){const t=s[e];void 0!==t&&t instanceof I.FU&&(t.setBlendOverride(e=>{e.setBlendMode(k.Nx.BLEND,k.dn.SRCALPHA,k.dn.ONE),e.setZMode(!0,k.oH.LEQUAL,!1)}),t.rebuild())}}},693:g(),694:class extends m{constructor(e,t){super(e,t),2===t.getInt8(25)&&(e.yaw=(0,p.so)(t.getInt16(28)))}}};var D=s(6223),B=s(5339);const L=(0,c.gv)(1,1,1,1),O=i.vt(),F=i.vt(),U=r.vt(),N=r.vt(),X=20;class V{constructor(e,t,s){this.typeNum=e,this.data=t,this.isEarlyObject=s,this.scale=1,this.modelNums=[],this.isDevObject=!1,this.adjustCullRadius=0,this.ambienceNum=0,this.scale=this.data.getFloat32(4),this.objClass=this.data.getInt16(80),this.name="";let n,i=s?88:145;for(;0!=(n=this.data.getUint8(i));)this.name+=String.fromCharCode(n),i++;const r=t.getUint8(85),a=t.getUint32(8);for(let e=0;e<r;e++){const s=(0,p.Wg)(t,a,e);this.modelNums.push(s)}const o=t.getUint32(68);this.isDevObject=!!(1&o),293===this.objClass&&(this.isDevObject=!0),this.adjustCullRadius=t.getUint8(115),this.ambienceNum=t.getUint8(142)}}class G{constructor(e,t,s,n){this.world=e,this.objType=t,this.objParams=s,this.posInMap=n,this.modelInst=null,this.parent=null,this.position=i.vt(),this.yaw=0,this.pitch=0,this.roll=0,this.scale=1,this.srtMatrix=r.vt(),this.srtMatrixChild=r.vt(),this.srtDirty=!0,this.cullRadius=10,this.modelAnimNum=null,this.anim=null,this.ambienceIdx=0,this.animSpeed=.01,this.curKeyframe=void 0,this.scale=t.scale,this.commonObjectParams=function(e){return{objType:e.getUint16(0),ambienceValue:e.getUint8(5)>>>3&3,layerValues:[e.getUint8(3),e.getUint8(5)],position:(0,p._t)(e,8),id:e.getUint32(20)}}(s),0!==this.commonObjectParams.ambienceValue?this.ambienceIdx=this.commonObjectParams.ambienceValue-1:this.ambienceIdx=t.ambienceNum,(this.ambienceIdx<0||this.ambienceIdx>=3)&&(this.ambienceIdx=0),i.C(this.position,this.commonObjectParams.position);const a=this.objType.objClass,o=this.objType.typeNum;if(this.setModelNum(0),a in P)try{this.internalClass=new P[a](this,s)}catch(e){console.warn(`Failed to setup object class ${a} type ${o} due to exception:`),console.error(e)}else console.log(`Don't know how to setup object class ${a} objType ${o}`)}mount(){void 0!==this.internalClass&&this.internalClass.mount(this,this.world)}unmount(){void 0!==this.internalClass&&this.internalClass.unmount(this,this.world)}setParent(e){this.parent=e,null!==e&&console.log(`attaching this object (${this.objType.name}) to parent ${null==e?void 0:e.objType.name}`)}updateSRT(){return this.srtDirty&&((0,p.YY)(this.srtMatrix,this.scale,this.scale,this.scale,this.yaw,this.pitch,this.roll,this.position[0],this.position[1],this.position[2]),(0,p.YY)(this.srtMatrixChild,1,1,1,this.yaw,this.pitch,this.roll,this.position[0],this.position[1],this.position[2]),this.srtDirty=!1),this.srtMatrix}getLocalSRT(){return this.updateSRT(),this.srtMatrix}getSRTForChildren(){return this.updateSRT(),this.srtMatrixChild}getWorldSRT(e){const t=this.getLocalSRT();null!==this.parent?r.lK(e,this.parent.getSRTForChildren(),t):r.C(e,t)}getType(){return this.objType}getClass(){return this.objType.objClass}getName(){return this.objType.name}getPosition(e){null!==this.parent?(this.parent.getPosition(e),i.WQ(e,e,this.position)):i.C(e,this.position)}setPosition(e){i.C(this.position,e),this.srtDirty=!0}setModelNum(e){try{const t=this.objType.modelNums[e],s=this.world.resColl.modelFetcher.createModelInstance(t),n=this.world.resColl.amapColl.getAmap(t);s.setAmap(n),this.modanim=this.world.resColl.modanimColl.getModanim(t),this.modelInst=s,this.cullRadius=10,this.modelInst.model.cullRadius>this.cullRadius&&(this.cullRadius=this.modelInst.model.cullRadius),0!==this.objType.adjustCullRadius&&(this.cullRadius*=10*this.objType.adjustCullRadius/255),this.modanim.byteLength>0&&n.byteLength>0&&this.setModelAnimNum(0)}catch(t){console.warn(`Failed to load model ${e} due to exception:`),console.error(t),this.modelInst=null}}setModelAnimNum(e){this.modelAnimNum=e;const t=(0,p.CV)(this.modanim,0,e);this.setAnim(this.world.resColl.animColl.getAnim(t))}setAnim(e){this.anim=e}isInLayer(e){return!(0!==e&&(e<9?this.commonObjectParams.layerValues[0]>>>e-1&1:this.commonObjectParams.layerValues[1]>>>16-e&1))}update(e){void 0!==this.internalClass&&this.internalClass.update(this,e)}isFrustumCulled(e){const t=U;this.getWorldSRT(t);const s=O;return(0,B.Xv)(s,t),!e.camera.frustum.containsSphere(s,this.cullRadius*this.scale)}addRenderInsts(e,t,s,n){if(null!==this.modelInst&&void 0!==this.modelInst&&!this.isFrustumCulled(n.sceneCtx.viewerInput)){null===this.anim||this.modelInst.model.hasFineSkinning&&!this.world.animController.enableFineSkinAnims||(0,D.hF)(this.world.animController.animController.getTimeInFrames()*this.animSpeed,this.modelInst,this.anim,this.modelAnimNum);const r=U;this.getWorldSRT(r);const a=N;(0,d.sq)(a,n.sceneCtx.viewerInput.camera);const o=O;(0,B.Xv)(o,r);const l=F;i.Z0(l,o,a),this.world.envfxMan.getAmbientColor(L,this.ambienceIdx),this.modelInst.addRenderInsts(e,t,Object.assign(Object.assign({},n),{showMeshes:!0,ambienceIdx:this.ambienceIdx,outdoorAmbientColor:L,object:this}),s,r,-l[2],31)}}destroy(e){var t;null===(t=this.modelInst)||void 0===t||t.destroy(e),this.modelInst=null}}class K{constructor(e,t){this.world=e,this.useEarlyObjects=t,this.objectTypes=[]}async init(e){const t=this.world.gameInfo.pathBase,[s,n,i]=await Promise.all([e.fetchData(`${t}/OBJECTS.tab`),e.fetchData(`${t}/OBJECTS.bin`),this.useEarlyObjects?null:e.fetchData(`${t}/OBJINDEX.bin`)]);this.objectsTab=s.createDataView(),this.objectsBin=n.createDataView(),this.objindexBin=this.useEarlyObjects?null:i.createDataView()}static async create(e,t,s){const n=new K(e,s);return await n.init(t),n}getObjectType(e,t=!1){if(this.useEarlyObjects||t||(e=(0,p.CV)(this.objindexBin,0,e)),void 0===this.objectTypes[e]){const t=(0,p.Wg)(this.objectsTab,0,e),s=new V(e,(0,p.Y)(this.objectsBin,t),this.useEarlyObjects);this.objectTypes[e]=s}return this.objectTypes[e]}createObjectInstance(e,t,s,n=!1){const i=this.getObjectType(e,n);return new G(this.world,i,t,s)}}var $,W=s(5974),H=s(7635);!function(e){e[e.Atmosphere=5]="Atmosphere",e[e.Skyscape=4]="Skyscape"}($||($={}));class Y{constructor(){this.textures=(0,W.y5)(8,()=>null),this.outdoorAmbientColors=(0,W.y5)(8,()=>(0,c.gv)(1,1,1,1))}}class Z{constructor(){this.objects=[]}destroy(e){for(let t of this.objects)t.destroy(e)}}const z=r.vt();class j{constructor(e){this.world=e,this.atmosphere=new Y,this.skyscape=new Z,this.timeOfDay=4,this.ambienceIdx=0,this.enableAmbientLighting=!0,this.enableFog=!0,this.skyLight=(0,w.Fc)(i.fA(-1,-1,-1),c.c),this.groundLight=(0,w.Fc)(i.fA(1,1,1),c.c),this.groundLightFactor=1,this.ENVFX_SIZE=96,this.mistEnable=!0,this.mistTop=0,this.mistBottom=0,this.mistTexture=H.G7.create(this.world.renderCache,64,64)}static async create(e,t){const s=new j(e),n=e.gameInfo.pathBase;return s.envfxactBin=(await t.fetchData(`${n}/ENVFXACT.bin`)).createDataView(),s}update(e,t){this.updateAmbience();const s=z;(0,d.sq)(s,t.viewerInput.camera),r.B8(s,s),s[13],this.updateMistTexture(e,0)}getMistTexture(){return this.mistTexture}updateAmbience(){this.getAmbientColor(this.skyLight.color,this.ambienceIdx),this.enableAmbientLighting?((0,c.Qo)(this.groundLight.color,this.skyLight.color,this.groundLightFactor),this.groundLight.color.a=1):(0,c.z5)(this.groundLight.color,this.skyLight.color),this.world.worldLights.addLight(this.skyLight),this.world.worldLights.addLight(this.groundLight)}setTimeOfDay(e){this.timeOfDay=e,this.updateAmbience()}setAmbience(e){this.ambienceIdx=e,this.updateAmbience()}updateMistTexture(e,t){if(!this.enableFog||!this.mistEnable||this.mistParam===t)return;const s=new Uint8Array(16384);function n(e,t,n,i,r,a){const o=4*(64*t+e);s[o]=n,s[o+1]=i,s[o+2]=r,s[o+3]=a}for(let e=0;e<64;e++){const s=Math.min(255*(e+t),16320);for(let t=0;t<64;t++){let i=s*t>>12;n(t,e,i,i,i,i)}}e.uploadTextureData(this.mistTexture.gfxTexture,0,[s])}getAmbientColor(e,t){this.enableAmbientLighting&&0===t?(0,c.z5)(e,this.atmosphere.outdoorAmbientColors[this.timeOfDay]):(0,c.z5)(e,c.c)}getFogColor(e,t){this.getAmbientColor(e,t)}getAtmosphereTexture(){return this.atmosphere.textures[this.timeOfDay]}loadEnvfx(e){const t=(0,p.Y)(this.envfxactBin,e*this.ENVFX_SIZE,this.ENVFX_SIZE),s={index:e,type:t.getUint8(92)};if(s.type===$.Atmosphere){const e=3128,s=[];for(let e=0;e<4;e++)s.push((0,p.CV)(t,46,e));for(let e=0;e<4;e++)s.push((0,p.CV)(t,62,e));this.atmosphere.textures=[];for(let t=0;t<8;t++){const n=e+s[t];console.log(`loading atmosphere texture ${t}: 0x${n.toString(16)}`),this.atmosphere.textures[t]=this.world.resColl.texFetcher.getTexture(this.world.renderCache,n,!1)}const n=[];for(let e=0;e<4;e++)n[e]=(0,c.gv)(t.getUint8(12+e)/255,t.getUint8(20+e)/255,t.getUint8(28+e)/255,1);this.atmosphere.outdoorAmbientColors[0]=n[0],this.atmosphere.outdoorAmbientColors[1]=n[1],this.atmosphere.outdoorAmbientColors[2]=n[1],this.atmosphere.outdoorAmbientColors[3]=n[2],this.atmosphere.outdoorAmbientColors[4]=n[2],this.atmosphere.outdoorAmbientColors[5]=n[3],this.atmosphere.outdoorAmbientColors[6]=n[3],this.atmosphere.outdoorAmbientColors[7]=n[0]}else if(s.type===$.Skyscape){this.skyscape.objects=[];const e=[0,1576,1890,2147],s=[0,1578,2140,2145,2147],n=[0,1575,1577,1886,1525],r=t.getUint8(93);if(0!==r){const e=n[r];console.log(`loading skyscape object id 0x${e.toString(16)}`);const t=new DataView(new ArrayBuffer(128)),s=this.world.objectMan.createObjectInstance(e,t,i.vt());this.skyscape.objects.push(s)}const a=t.getUint8(91);if(0!==a){const t=e[a];console.log(`loading skyring object id 0x${t.toString(16)}`);const s=new DataView(new ArrayBuffer(128)),n=this.world.objectMan.createObjectInstance(t,s,i.vt());this.skyscape.objects.push(n)}const o=t.getUint8(90);if(0!==o){const e=s[o];console.log(`loading mountain object id 0x${e.toString(16)}`);const t=new DataView(new ArrayBuffer(128)),n=this.world.objectMan.createObjectInstance(e,t,i.vt());this.skyscape.objects.push(n)}}else console.warn(`Don't know how to load envfx type ${s.type}`);return s}destroy(e){this.skyscape.destroy(e)}}var q=s(8874),Q=s(7714),J=s(5144),ee=s(738),te=s(1659),se=s(8528);const ne=new h.gA,ie=new h.$r,re=i.vt(),ae=new h.TD;class oe{constructor(e){this.world=e,this.skyddraw=new ee.l,this.skyddraw.setVtxDesc(k.cg.POS,!0),this.skyddraw.setVtxDesc(k.cg.TEX0,!0);const t=new te.I;t.setTexCoordGen(k.gw.TEXCOORD0,k.s3.MTX2x4,k.Kx.TEX0,k.b1.IDENTITY),t.setTevDirect(0),t.setTevOrder(0,k.gw.TEXCOORD0,k.zH.TEXMAP0,k.Ug.COLOR_ZERO),t.setTevColorIn(0,k.CC.ZERO,k.CC.ZERO,k.CC.ZERO,k.CC.TEXC),t.setTevColorOp(0,k.fQ.ADD,k.bt.ZERO,k.mX.SCALE_1,!0,k.UZ.PREV),t.setTevAlphaIn(0,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO,k.CA.TEXA),t.setTevAlphaOp(0,k.fQ.ADD,k.bt.ZERO,k.mX.SCALE_1,!0,k.UZ.PREV),t.setBlendMode(k.Nx.NONE,k.dn.ONE,k.dn.ZERO),t.setZMode(!1,k.oH.ALWAYS,!1),t.setCullMode(k.Ac.NONE),t.setUsePnMtxIdx(!1),this.materialHelperSky=new h.kg(t.finish("atmosphere"))}renderAtmosphere(e,t,s,n,a,o){const c=this.world.envfxMan.getAtmosphereTexture();if(null==c)return;const u=t.pushTemplateRenderInst();(0,h.gI)(ae,r.vt(),o.viewerInput.backbufferWidth,o.viewerInput.backbufferHeight),(0,se._)(ae.u_Projection,e.queryVendorInfo().clipSpaceNearZ,Q.uA.NegativeOne);let d=u.getUniformBufferOffset(l.vn.ub_SceneParams);const m=u.mapUniformBufferF32(l.vn.ub_SceneParams);(0,h.E_)(m,d,ae),ne.m_TextureMapping[0].gfxTexture=c.gfxTexture,ne.m_TextureMapping[0].gfxSampler=c.gfxSampler,ne.m_TextureMapping[0].width=c.width,ne.m_TextureMapping[0].height=c.height,ne.m_TextureMapping[0].lodBias=0,r.D_(ne.u_TexMtx[0]);const f=re;(0,B.Bl)(f,o.viewerInput.camera.worldMatrix),i.ze(f,f);const g=(0,p.vT)(f),T=Math.PI/2,x=.5*c.height*o.viewerInput.camera.fovY/Math.PI*3*Math.sin(-T),v=(.5*c.height-6-3*c.height*-g/Math.PI+x)/c.height,C=v-2*x/c.height;this.skyddraw.beginDraw(n.gfxRenderCache),this.skyddraw.begin(k.uB.DRAW_QUADS),this.skyddraw.position3f32(-1,-1,-1),this.skyddraw.texCoord2f32(k.cg.TEX0,1,v),this.skyddraw.position3f32(-1,1,-1),this.skyddraw.texCoord2f32(k.cg.TEX0,1,C),this.skyddraw.position3f32(1,1,-1),this.skyddraw.texCoord2f32(k.cg.TEX0,1,C),this.skyddraw.position3f32(1,-1,-1),this.skyddraw.texCoord2f32(k.cg.TEX0,1,v),this.skyddraw.end();const b=this.skyddraw.endDrawAndMakeRenderInst(n);ie.clear(),(0,q.g)(n,b,this.materialHelperSky,ne,ie),n.popTemplateRenderInst(),s.pushPass(e=>{e.setDebugName("Atmosphere"),e.attachRenderTargetID(J.jY.Color0,a),e.exec(e=>{b.drawOnPass(n.gfxRenderCache,e)})})}addSkyRenderInsts(e,t,s,n){if(0!==this.world.envfxMan.skyscape.objects.length){t.setCurrentRenderInstList(s.skyscape);const i=t.pushTemplateRenderInst();(0,h.$7)(i,n.viewerInput);const r={sceneCtx:n,showDevGeometry:!1,setupLights:()=>{}},a=re;(0,p.YV)(a,n.viewerInput.camera);for(let s=0;s<this.world.envfxMan.skyscape.objects.length;s++){const n=this.world.envfxMan.skyscape.objects[s];n.setPosition(a),n.addRenderInsts(e,t,null,r)}t.popTemplateRenderInst()}}addSkyRenderPasses(e,t,s,n,i,r,a,o){this.renderAtmosphere(e,t,s,n,r,o),s.pushPass(e=>{e.setDebugName("Skyscape"),e.attachRenderTargetID(J.jY.Color0,r);const t=s.createRenderTargetID(a,"Skyscape Depth");e.attachRenderTargetID(J.jY.DepthStencil,t),e.exec(e=>{i.skyscape.drawOnPassRenderer(n.gfxRenderCache,e)})})}destroy(e){this.skyddraw.destroy(e)}}var le=s(3489),he=s(6063);const ce=new h.gA,ue=new h.$r,de=new h.TD,me=r.vt(),pe=r.vt(),fe=i.vt(),ge=i.vt(),Te=[[.5,1],[.5,.5],[.4,1],[.3,.8],[.2,1],[.4,.5]];var xe;function ve(e,t){const s=.5*t;i.hZ(e.DistAtten,s,0,1-s),i.hZ(e.CosAtten,0,0,1)}!function(e){e[e.HemisphericProbe=0]="HemisphericProbe",e[e.ReflectiveProbe=1]="ReflectiveProbe"}(xe||(xe={}));const Ce=32,be=r.vt();(0,B.Gh)(be,1,-1,-1,1,1,15);class _e{constructor(e,t){this.world=e,this.materialFactory=t,this.targetDesc=new J.tR(Q.$Y.U8_RGBA_RT),this.params=(0,W.y5)(6,()=>({type:xe.HemisphericProbe,attenFactors:[0,0],matColorFactors:[0,0]})),this.ddraw=new ee.M,this.sphereMaps=(0,W.y5)(6,()=>({textureMapping:new le.C$,targetID:0,resolveID:0})),this.targetDesc.setDimensions(Ce,Ce,1);let s=0;for(let e=0;e<6;e++){const t=Te[e];this.params[s].attenFactors[1&e]=2.146452/Math.pow(t[0],2.520326),this.params[s].matColorFactors[1&e]=255*t[1],this.params[s].type=xe.ReflectiveProbe,1&e&&s++}this.params[s].type=xe.HemisphericProbe,s++,this.params[s].type=xe.HemisphericProbe,s++,this.params[s].type=xe.HemisphericProbe,s++,this.ddraw.setVtxDesc(k.cg.POS,!0),this.ddraw.setVtxDesc(k.cg.NRM,!0),this.ddraw.beginDraw(e.renderCache);for(let e=0;e<16;e++){this.ddraw.begin(k.uB.DRAW_TRIANGLE_STRIP,34);const t=2*e/15-1,s=2*(e+1)/15-1;for(let e=0;e<17;e++){const n=2*e/15-1;this.ddraw.position3f32(t,n,-2);let i=t*t+n*n;i=i>=1?0:Math.sqrt(1-i),this.ddraw.normal3f32(t,n,i),this.ddraw.position3f32(s,n,-2);let r=s*s+n*n;r=r>=1?0:Math.sqrt(1-r),this.ddraw.normal3f32(s,n,r)}this.ddraw.end()}this.ddraw.endDraw(e.renderCache),this.hemisphericMaterial=function(){const e=new he.po("Ambient Hemispheric Probe Material"),t=e.genTevStage();return e.setTevDirect(t),e.setTevOrder(t,null,null,k.Ug.COLOR0A0),e.setTevKColorSel(t,k.jl.KCSEL_1),e.setTevKAlphaSel(t,k.u_.KASEL_1),e.setTevColorFormula(t,k.CC.ZERO,k.CC.ZERO,k.CC.ZERO,k.CC.RASC),e.setTevAlphaFormula(t,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO,k.CA.KONST),e.setChanCtrl(k.UQ.COLOR0,!0,k.uj.REG,k.uj.REG,255,k.jN.CLAMP,k.bg.SPOT),e.setMatColor(0,e=>(0,c.z5)(e,c.c)),e.setAmbColor(0,(e,t)=>t.envfxMan.getAmbientColor(e,t.envfxMan.ambienceIdx)),e}(this.materialFactory),this.reflectiveMaterial=function(e,t){const s=new he.po("Ambient Reflective Probe Material"),n=s.genTevStage();s.setTevDirect(n),s.setTexMtx(0,e=>{r.CV(e,[.5,-.5,.5]),(0,p.Ir)(e,.5,.5,0)});const i=s.genTexCoord(k.s3.MTX2x4,k.Kx.NRM,k.b1.TEXMTX0),a=s.genTexMap((0,I.Tn)(t.getTexture(e.cache,1500,!1)));s.setTevOrder(n,i,a,k.Ug.COLOR0A0),s.setTevColorFormula(n,k.CC.ZERO,k.CC.RASC,k.CC.RASA,k.CC.TEXC),s.setTevAlphaFormula(n,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO);const o=s.genTevStage();return s.setTevDirect(o),s.setTevOrder(o,null,null,k.Ug.COLOR1A1),s.setTevColorFormula(o,k.CC.ZERO,k.CC.RASC,k.CC.RASA,k.CC.CPREV),s.setTevAlphaFormula(o,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO,k.CA.ZERO),s.setChanCtrl(k.UQ.COLOR0,!0,k.uj.REG,k.uj.REG,3,k.jN.NONE,k.bg.SPEC),s.setChanCtrl(k.UQ.ALPHA0,!0,k.uj.REG,k.uj.REG,4,k.jN.CLAMP,k.bg.SPOT),s.setChanCtrl(k.UQ.COLOR1,!0,k.uj.REG,k.uj.REG,24,k.jN.NONE,k.bg.SPEC),s.setChanCtrl(k.UQ.ALPHA1,!0,k.uj.REG,k.uj.REG,32,k.jN.CLAMP,k.bg.SPOT),s.setBlendMode(k.Nx.NONE,k.dn.ONE,k.dn.ZERO),s.setAlphaCompare(k.oH.ALWAYS,0,k.O2.AND,k.oH.ALWAYS,0),s.setCullMode(k.Ac.NONE),s.setZMode(!1,k.oH.EQUAL,!1),s.setAmbColor(0,e=>(0,c.z5)(e,c.gh)),s.setAmbColor(1,e=>(0,c.z5)(e,c.gh)),s}(this.materialFactory,this.world.resColl.texFetcher)}setupToRenderHemisphericProbe(e,t,s){return this.params[e],this.world.envfxMan.setAmbience(5-e),this.hemisphericMaterial.setOnMaterialParams(t,this.world),this.world.setupLightsForObject(t.u_Lights,void 0,s,w.zY.DIRECTIONAL),this.hemisphericMaterial}setupToRenderReflectiveProbe(e,t,s){const n=this.params[e];this.world.envfxMan.setAmbience(e),this.reflectiveMaterial.setOnMaterialParams(t,void 0);const a=(0,c.gv)(1*n.matColorFactors[0]/255,0,1*n.matColorFactors[1]/255,1);(0,c.z5)(t.u_Color[h.k2.MAT0],a),(0,c.z5)(t.u_Color[h.k2.MAT1],a);const o=this.world.envfxMan.skyLight,l=this.world.envfxMan.groundLight,u=me;(0,d.sq)(u,s.viewerInput.camera);const m=pe;r.C(m,u),(0,p.Ir)(m,0,0,0);const f=fe;i.Z0(f,o.direction,m);const g=ge;return i.Z0(g,l.direction,m),t.u_Lights[0].reset(),i.C(t.u_Lights[0].Direction,f),ve(t.u_Lights[0],n.attenFactors[0]),(0,c.z5)(t.u_Lights[0].Color,c.aw),t.u_Lights[1].reset(),i.C(t.u_Lights[1].Direction,f),ve(t.u_Lights[1],n.attenFactors[1]),(0,c.z5)(t.u_Lights[1].Color,c.vl),t.u_Lights[2].reset(),i.hs(t.u_Lights[2].Position,f,1e5),(0,c.z5)(t.u_Lights[2].Color,c.vl),i.hZ(t.u_Lights[2].CosAtten,1.5,0,0),t.u_Lights[3].reset(),i.C(t.u_Lights[3].Direction,g),ve(t.u_Lights[3],n.attenFactors[0]),(0,c.z5)(t.u_Lights[3].Color,c.aw),t.u_Lights[4].reset(),i.C(t.u_Lights[4].Direction,g),ve(t.u_Lights[4],n.attenFactors[1]),(0,c.z5)(t.u_Lights[4].Color,c.vl),t.u_Lights[5].reset(),i.hs(t.u_Lights[5].Position,g,1e5),(0,c.z5)(t.u_Lights[5].Color,c.vl),i.hZ(t.u_Lights[5].CosAtten,.5,0,0),this.reflectiveMaterial}renderMap(e,t,s,n,i,r){const a=n.renderInstManager.newRenderInst();a.setBindingLayouts(h.md),(0,h.gI)(de,be,Ce,Ce),(0,se._)(de.u_Projection,e.queryVendorInfo().clipSpaceNearZ,Q.uA.NegativeOne);let o=a.allocateUniformBuffer(l.vn.ub_SceneParams,h.sl);const c=a.mapUniformBufferF32(l.vn.ub_SceneParams);let u;(0,h.E_)(c,o,de),ue.clear(),ce.clear(),u=this.params[t].type===xe.HemisphericProbe?this.setupToRenderHemisphericProbe(t,ce,r):this.setupToRenderReflectiveProbe(t,ce,r),this.ddraw.setOnRenderInst(a),(0,q.g)(i,a,u.getGXMaterialHelper(),ce,ue);const d=s.createRenderTargetID(this.targetDesc,`Sphere Map ${t} Target`);return s.pushPass(e=>{e.setDebugName("Sphere Map"),e.attachRenderTargetID(J.jY.Color0,d),e.exec((e,t)=>{a.drawOnPass(i.gfxRenderCache,e)})}),s.pushDebugThumbnail(d),d}renderMaps(e,t,s,n,i){for(let r=0;r<6;r++)this.sphereMaps[r].targetID=this.renderMap(e,r,t,s,n,i)}attachResolveTextures(e,t){for(let s=0;s<6;s++)this.sphereMaps[s].resolveID=e.resolveRenderTarget(this.sphereMaps[s].targetID),t.attachResolveTexture(this.sphereMaps[s].resolveID)}resolveLateSamplerBindings(e,t,s){void 0===this.sphereMapSampler&&(this.sphereMapSampler=s.createSampler({wrapS:Q.Vf.Clamp,wrapT:Q.Vf.Clamp,minFilter:Q.gD.Bilinear,magFilter:Q.gD.Bilinear,mipFilter:Q.P.Nearest,minLOD:0,maxLOD:100}));for(let s=0;s<6;s++)this.sphereMaps[s].textureMapping.gfxTexture=t.getResolveTextureForID(this.sphereMaps[s].resolveID),this.sphereMaps[s].textureMapping.gfxSampler=this.sphereMapSampler,this.sphereMaps[s].textureMapping.width=Ce,this.sphereMaps[s].textureMapping.height=Ce,e.resolveLateSamplerBinding(`sphere-map-${s}`,this.sphereMaps[s].textureMapping)}destroy(e){this.ddraw.destroy(e)}}window.musicState||(window.musicState={muted:!1,audio:null});const ye={2:"dragrock.mp3",4:"volcano.mp3",7:"swaphol.mp3",8:"swapholbot.mp3",10:"snowhorn.mp3",11:"kp.mp3",12:"crf.mp3",14:"lightfoot.mp3",16:"dungeon.mp3",18:"mmpass.mp3",19:"darkicemines.mp3",21:"ofp.mp3",27:"darkicemines2.mp3",29:"capeclaw.mp3",28:"bossgaldon.mp3",31:"kraztest.mp3",32:"kraztest.mp3",33:"kraztest.mp3",34:"kraztest.mp3",39:"kraztest.mp3",40:"kraztest.mp3",50:"ofp.mp3",51:"shop.mp3",54:"magcave.mp3"},Se=i.vt(),we=r.vt(),Ae=r.vt(),Ee=(0,c.gv)(1,1,1,1);class Re{handleMusic(){const e=window.musicState;if(null===this.mapNum)return;const t=ye[this.mapNum],s=1e3;function n(e,t){const s=e.volume/(t/50),n=setInterval(()=>{e.volume=Math.max(0,e.volume-s),e.volume<=0&&(clearInterval(n),e.pause(),e.currentTime=0)},50)}if(t){const i=`data/audio/${t}`;if(!e.audio||!e.audio.src.includes(t)){e.audio&&n(e.audio,s);const t=new Audio(i);t.loop=!0,e.audio=t,e.muted||t.play().then(()=>{!function(e){e.volume=0;const t=setInterval(()=>{e.volume=Math.min(.2,e.volume+.01),e.volume>=.2&&clearInterval(t)},50)}(t)}).catch(()=>{})}}else e.audio&&n(e.audio,s)}constructor(e,t,s,n){this.context=e,this.gameInfo=t,this.subdirs=s,this.materialFactory=n,this.mapNum=null,this.backgroundMusic=null,this.mapInstance=null,this.objectInstances=[],this.worldLights=new w.o,this.renderCache=this.materialFactory.cache}async init(e){this.animController=new D.X0,this.envfxMan=await j.create(this,e);const t=u.JW.create(this.context.device,this.gameInfo,e,this.subdirs,this.materialFactory,this.animController),[s,n,i]=await Promise.all([t,o.tJ.create(this.gameInfo,e,this.context.device,this.materialFactory,this.animController,(async()=>(await t).texFetcher)()),K.create(this,e,!1)]);this.resColl=s,this.blockFetcher=n,this.objectMan=i}static async create(e,t,s,n,i){const r=new Re(e,t,n,i);return await r.init(s),r}setMapInstance(e){this.mapInstance=e}spawnObject(e,t=null,s){const n=e.getUint16(0),r=(0,p._t)(e,8),a=i.o8(r);i.WQ(a,a,s);const o=this.objectMan.createObjectInstance(n,e,a);o.setParent(t),this.objectInstances.push(o);try{o.mount()}catch(e){return console.warn("Mounting object failed with exception:"),console.error(e),this.objectInstances.pop(),null}return o}spawnObjectsFromRomlist(e,t=null){const s=i.vt();null!==this.mapInstance&&i.hZ(s,640*this.mapInstance.info.getOrigin()[0],0,640*this.mapInstance.info.getOrigin()[1]);let n=0,r=0;for(;n<e.byteLength;){const i=4*e.getUint8(n+2),a=(0,p.Y)(e,n,i),o=this.spawnObject(a,t,s);null!==o&&console.log(`Object #${r}: ${o.getName()} (type ${o.getType().typeNum} romlist-type 0x${o.commonObjectParams.objType.toString(16)} class ${o.getType().objClass} id 0x${o.commonObjectParams.id.toString(16)})`),n+=i,r++}}setupLightsForObject(e,t,s,n){const a=void 0!==t?this.worldLights.probeLightsOnObject(t,s,n,8):this.worldLights.lights;let o=0;const l=we;(0,d.sq)(l,s.viewerInput.camera);const h=Ae;r.C(h,l),(0,p.Ir)(h,0,0,0);for(let t of a)if(t.type&n&&(e[o].reset(),t.type===w.zY.DIRECTIONAL?(i.hs(e[o].Position,t.direction,-1e5),(0,B.bB)(e[o].Position,h,e[o].Position),(0,c.z5)(e[o].Color,t.color),i.hZ(e[o].CosAtten,1,0,0),i.hZ(e[o].DistAtten,1,0,0)):(t.getPosition(Se),(0,B.Ye)(e[o].Position,l,Se),(0,c.z5)(e[o].Color,t.color),i.hZ(e[o].CosAtten,1,0,0),i.C(e[o].DistAtten,t.distAtten)),o++,o>=8))break;for(;o<8;o++)e[o].reset()}destroy(e){var t;this.backgroundMusic&&(this.backgroundMusic.pause(),this.backgroundMusic.currentTime=0,this.backgroundMusic=null);for(let t of this.objectInstances)t.destroy(e);this.envfxMan.destroy(e),null===(t=this.mapInstance)||void 0===t||t.destroy(e),this.resColl.destroy(e),this.blockFetcher.destroy(e)}}class Ie extends q.G{constructor(e,t){super(e.context,e.animController,t),this.world=e,this.enableAmbient=!0,this.enableFog=!0,this.showObjects=!0,this.showDevGeometry=!1,this.showDevObjects=!1,this.enableLights=!0,this.world.resColl.texFetcher instanceof H.JU&&(this.textureHolder=this.world.resColl.texFetcher.textureHolder),this.sky=new oe(this.world),this.sphereMapMan=new _e(this.world,t)}createPanels(){const e=new a.Zk;e.setTitle(a.NH,"Time"),this.timeSelect=new a.Ap,this.timeSelect.setLabel("Time"),this.timeSelect.setRange(0,7,1),this.timeSelect.setValue(4),e.contents.append(this.timeSelect.elem);const t=new a.Sc("Disable ambient lighting",!1);t.onchanged=()=>{this.enableAmbient=!t.checked},e.contents.append(t.elem);const s=new a.Sc("Disable fog",!1);s.onchanged=()=>{this.enableFog=!s.checked},e.contents.append(s.elem);const n=new a.Zk;n.setTitle(a.QU,"Layers");const i=new a.Sc("Hide objects",!1);i.onchanged=()=>{this.showObjects=!i.checked},n.contents.append(i.elem),this.layerSelect=new a.Ap,this.layerSelect.setLabel("Layer"),this.layerSelect.setRange(0,16,1),this.layerSelect.setValue(1),n.contents.append(this.layerSelect.elem);const r=new a.Sc("Show developer objects",!1);r.onchanged=()=>{this.showDevObjects=r.checked},n.contents.append(r.elem);const o=new a.Sc("Show developer map shapes",!1);o.onchanged=()=>{this.showDevGeometry=o.checked},n.contents.append(o.elem);const l=new a.Sc("Disable lights",!1);l.onchanged=()=>{this.enableLights=!l.checked},n.contents.append(l.elem);const h=new a.Zk;h.customHeaderBackgroundColor=a.pW,h.setTitle(a.WY,"Render Hacks");const c=new a.Sc("Show Debug Thumbnails",!1);return c.onchanged=()=>{const e=c.checked;this.renderHelper.debugThumbnails.enabled=e},h.contents.appendChild(c.elem),[e,n,h]}setEnvfx(e){this.world.envfxMan.loadEnvfx(e)}enableFineAnims(e=!0){this.animController.enableFineSkinAnims=e}loadTexture(e,t=!1){const s=this.world.resColl.texFetcher.getTexture(this.world.renderCache,e,t);null!==s&&void 0!==s.viewerTexture?console.log(`Loaded texture "${s.viewerTexture.name}"`):console.log("Failed to load texture")}update(e){super.update(e),this.materialFactory.update(this.animController),this.world.envfxMan.setTimeOfDay(0|this.timeSelect.getValue()),this.world.envfxMan.enableAmbientLighting=this.enableAmbient,this.world.envfxMan.enableFog=this.enableFog,this.world.envfxMan.update(this.world.context.device,{viewerInput:e});const t={viewerInput:e};for(let e=0;e<this.world.objectInstances.length;e++)this.world.objectInstances[e].update(t)}addSkyRenderInsts(e,t,s,n){this.sky.addSkyRenderInsts(e,t,s,n)}addSkyRenderPasses(e,t,s,n,i,r){this.sky.addSkyRenderPasses(e,this.renderHelper,t,s,n,i,this.mainDepthDesc,r)}setupLightsForObject(e,t,s,n){if(this.enableLights)this.world.setupLightsForObject(e,t,s,n);else for(let t=0;t<8;t++)e[t].reset()}addWorldRenderInsts(e,t,s,n){const i=t.pushTemplateRenderInst();(0,h.$7)(i,n.viewerInput),this.world.envfxMan.getAmbientColor(Ee,0);const r={sceneCtx:n,showDevGeometry:this.showDevGeometry,showMeshes:!0,ambienceIdx:0,outdoorAmbientColor:Ee,setupLights:void 0};if((0,W.y5)(8,()=>new l.ve),this.showObjects)for(let i=0;i<this.world.objectInstances.length;i++){const a=this.world.objectInstances[i];a.getType().isDevObject&&!this.showDevObjects||!a.isInLayer(this.layerSelect.getValue())||(r.setupLights=(e,t)=>{this.setupLightsForObject(e,a,n,t)},a.addRenderInsts(e,t,s,r))}r.setupLights=()=>{},null!==this.world.mapInstance&&this.world.mapInstance.addRenderInsts(e,t,s,r),t.popTemplateRenderInst()}addWorldRenderPassesInner(e,t,s,n){this.sphereMapMan.renderMaps(e,t,this.renderHelper,s,n)}attachResolveTexturesForWorldOpaques(e,t){this.sphereMapMan.attachResolveTextures(e,t)}resolveLateSamplerBindingsForWorldOpaques(e,t){this.sphereMapMan.resolveLateSamplerBindings(e,t,this.renderHelper.renderCache)}destroy(e){super.destroy(e),this.world.destroy(e),this.sky.destroy(e),this.sphereMapMan.destroy(e)}}class ke{constructor(e,t,s,n,i=Le){this.id_=e,this.mapNum=s,this.name=n,this.gameInfo=i,Array.isArray(e)?this.id=e[0]:this.id=e,Array.isArray(t)?this.subdirs=t:this.subdirs=[t]}async createScene(e,t){console.log(`Creating scene for world ${this.name} (ID ${this.id}) ...`);const s=this.gameInfo.pathBase,a=t.dataFetcher,o=new I.YS(e),l=await Re.create(t,this.gameInfo,a,this.subdirs,o);let h=null;if(null!==this.mapNum){const e=await(0,n.LF)(this.gameInfo,a,this.mapNum);h=new n.O7(e,l.blockFetcher,l),await h.reloadBlocks(a);const t=i.fA(640*e.getOrigin()[0],0,640*e.getOrigin()[1]),s=r.vt(),o=i.o8(t);i.ze(o,o),r.kN(s,o),h.setMatrix(s),l.setMapInstance(h),l.mapNum=this.mapNum,l.handleMusic()}const c=Array.isArray(this.id_)?this.id_:[this.id_];let d=null;for(let e of c){console.log(`Loading romlist ${e}.romlist.zlb...`);const[t]=await Promise.all([a.fetchData(`${s}/${e}.romlist.zlb`)]),n=(0,u.vR)(t).createDataView();l.spawnObjectsFromRomlist(n,d),"frontend"===e&&(d=l.objectInstances[2],console.log(`parentObj is ${d.objType.name}`))}return window.main.lookupObject=(e,t=!1)=>{const s=l.objectMan.getObjectType(e,t);console.log(`Object ${e}: ${s.name} (type ${s.typeNum} class ${s.objClass})`)},window.main.showAllTextures=(e=!1)=>{const t=l.resColl.texFetcher,{attempted:s,shown:n}=t.loadAllFromTables(o.cache,e)},window.main.showAllTextures=(e=!1)=>{const t=l.resColl.texFetcher,{attempted:s,shown:n}=t.loadAllFromTables(o.cache,e);console.log(`[ShowAllTextures] Bank=${e?"TEX1":"TEX0/TEXPRE"} attempted=${s} registered=${n}`)},new Ie(l,o)}}class Me{constructor(e,t=Le){this.name=e,this.gameInfo=t,this.id="fullglobalworld"}async createScene(e,t){const s=t.dataFetcher,a=new I.YS(e),o=await Re.create(t,this.gameInfo,s,["swaphol"],a),l=(await s.fetchData(`${this.gameInfo.pathBase}/globalma.bin`)).createDataView(),c=[];let u=0;for(;u+12<=l.byteLength;){const e=l.getInt16(u+0),t=l.getInt16(u+2),a=(l.getInt16(u+4),l.getInt16(u+6));if(u+=12,a<0)break;if(this.gameInfo.subdirs[a],new Set([3,57,58,59,60,61,62]).has(a))continue;const h=await(0,n.LF)(this.gameInfo,s,a),d=new n.O7(h,o.blockFetcher,o);await d.reloadBlocks(s);const m=r.vt(),p=h.getOrigin();r.kN(m,i.fA(640*(e-p[0]),0,640*(t-p[1]))),d.setMatrix(m),c.push(d)}return new class extends Ie{addWorldRenderInsts(e,t,s,n){const i=t.pushTemplateRenderInst();(0,h.$7)(i,n.viewerInput);const r={sceneCtx:n,showDevGeometry:!1,showMeshes:!0,ambienceIdx:0,outdoorAmbientColor:Ee,setupLights:()=>{}};for(const n of c)n.addRenderInsts(e,t,s,r);t.popTemplateRenderInst()}}(o,a)}}var Pe=s(3673),De=s(3793);const Be={pathBase:"dinosaurplanet",subdirs:{}},Le={pathBase:"StarFoxAdventures",subdirs:{0:"animtest",1:"animtest",2:"animtest",3:"arwing",4:"dragrock",5:"animtest",6:"dfptop",7:"volcano",8:"animtest",9:"mazecave",10:"dragrockbot",11:"dfalls",12:"swaphol",13:"shipbattle",14:"nwastes",15:"warlock",16:"shop",17:"animtest",18:"crfort",19:"swapholbot",20:"wallcity",21:"lightfoot",22:"cloudtreasure",23:"animtest",24:"clouddungeon",25:"mmpass",26:"darkicemines",27:"animtest",28:"desert",29:"animtest",30:"icemountain",31:"animtest",32:"animtest",33:"animtest",34:"darkicemines2",35:"bossgaldon",36:"animtest",37:"insidegal",38:"magiccave",39:"dfshrine",40:"mmshrine",41:"ecshrine",42:"gpshrine",43:"dbshrine",44:"nwshrine",45:"worldmap",46:"animtest",47:"capeclaw",48:"dbay",49:"animtest",50:"cloudrace",51:"bossdrakor",52:"animtest",53:"bosstrex",54:"linkb",55:"cloudjoin",56:"arwingtoplanet",57:"arwingdarkice",58:"arwingcloud",59:"arwingcity",60:"arwingdragon",61:"gamefront",62:"linklevel",63:"greatfox",64:"linka",65:"linkc",66:"linkd",67:"linke",68:"linkf",69:"linkg",70:"linkh",71:"linkj",72:"linki"}},Oe={pathBase:"StarFoxAdventuresDemo",subdirs:{0:"animtest",1:"animtest",2:"animtest",3:"arwing",4:"dragrock",5:"animtest",6:"dfptop",7:"volcano",8:"animtest",9:"mazecave",10:"dragrockbot",11:"dfalls",12:"swaphol",13:"shipbattle",14:"nwastes",15:"warlock",16:"shop",17:"animtest",18:"crfort",19:"swapholbot",20:"wallcity",21:"lightfoot",22:"cloudtreasure",23:"animtest",24:"clouddungeon",25:"mmpass",26:"darkicemines",27:"dfptop",28:"desert",29:"frontend",30:"icemountain",31:"mmshrine",32:"animtest",33:"animtest",34:"darkicemines2",35:"bossgaldon",36:"animtest",37:"insidegal",38:"magiccave",39:"dfshrine",40:"mmshrine",41:"ecshrine",42:"gpshrine",43:"dbshrine",44:"nwshrine",45:"worldmap",46:"animtest",47:"capeclaw",48:"dbay",49:"animtest",50:"cloudrace",51:"bossdrakor",52:"animtest",53:"bosstrex",54:"linkb",57:"arwingdarkice",58:"arwingcloud",59:"arwingcity",60:"arwingdragon",61:"gamefront",62:"linklevel",63:"greatfox",64:"linka",65:"linkc",66:"linkd",67:"linke",68:"linkf",69:"linkg",70:"linkh",71:"linkj",72:"linki",73:"swapcircle",74:"Copy of swaphol"}},Fe={pathBase:"StarFoxAdventuresDemo",subdirs:[]},Ue={id:"sfa",name:"Star Fox Adventures",sceneDescs:["StarFox Adventures Maps - Oldest to Newest","Model Viewer",new Pe.W("modelexhibit","Model + Animation Viewer (Final)",De.o.Final),new Pe.W("modelexhibit","Model + Animation Viewer (Kiosk)",De.o.Final,Oe),new Pe.W("betamodelexhibit","Early 2001 Model Viewer (in progress)",De.o.Beta,Oe),new Pe.W("demomodelexhibit","Mid 2001 Viewer (in progress)",De.o.Demo,Oe),"Full World Maps (experimental)",new Me("Full Final World"),new Me("Full Kiosk World",Oe),"Very Early 2001 Maps",new n.bg(22,"betaswapcircle","Very Early 2001: Swapstone Circle (T)",Oe),new n.NQ(50,"demo50","Very Early 2001: Desert Force Point - Top (T)",Oe),new n.t0(33,"demo33","Very Early 2001: Test of Fear (T)",Oe),new n.NQ(23,"demo23","Very Early 2001: Ice Mountain 2",Oe),"Early 2001 Maps",new n.Qv("ancient0","Ancient Willow Grove (T)",Fe,0),new n.Qv("ancient1","Ancient Dragon Rock",Fe,1),new n.Qv("ancient2","Ancient Dragon Rock Bottom",Fe,2),new n.Qv("ancient3","Ancient ThornTail Hollow (T)",Fe,3),new n.Qv("ancient4","Ancient Northern Wastes (T)",Fe,4),new n.Qv("ancient5","Ancient Warlock Mountain (T)",Fe,5),new n.Qv("ancient6","Ancient Shop (T)",Fe,6),new n.Qv("ancient7","Ancient CloudRunner Fortress (T)",Fe,7),new n.Qv("ancient9","Ancient Ice Mountain Track 1",Fe,9),new n.Qv("ancient10","Ancient Ice Mountain Track 2",Fe,10),new n.Qv("ancient11","Ancient Ice Mountain Track 3",Fe,11),new n.Qv("ancient8","Ancient DarkIce Mines",Fe,8),new n.Qv("ancient12","Ancient DarkIce Mines 2",Fe,12),new n.Qv("ancient13","Ancient DarkIce Mines Boss Room",Fe,13),new n.Qv("ancient14","Ancient CloudRunner Fortress Race (T)",Fe,14),new n.Qv("ancient15","Ancient Boss T-rex",Fe,15),"Early/Mid 2001 Maps",new n.UB(26,"demo26","Mid 2001: Animtest",Oe),new n.UB(18,"demo18","Mid 2001: Moon Mountain Pass (T)",Oe),new n.UB(7,"demo7","Mid 2001: ThornTail Hollow (T)",Oe),new n.UO(7,"demo7","Mid 2001: ThornTail Hollow (Copy of Swaphol map) (T)",Oe),new n.UB(8,"demo8","Mid 2001: ThornTail Hollow Underground (T)",Oe),new n.UB(64,"demo64","Mid 2001: LinkLevel (Thorntail to Lightfoot) (T)",Oe),new n.UB(51,"demo51","Mid 2001: Shop (T)",Oe),new n.UB(54,"demo54","Mid 2001: Magic Cave (T)",Oe),new n.UB(29,"demo29","Mid 2001: Cape Claw (T)",Oe),new n.UB(14,"demo14","Mid 2001: LightFoot Village (T)",Oe),new n.UB(2,"demo2","Mid 2001: Dragon Rock (T)",Oe),new n.UB(52,"demo52","Mid 2001: Dragon Rock Bottom",Oe),new n.UB(48,"demo48","Mid 2001: Boss T-rex",Oe),new n.UB(16,"demo16","Mid 2001: CloudRunner Dungeon (T)",Oe),new n.UB(43,"demo43","Mid 2001: CloudRunner Race (T)",Oe),new n.UB(12,"demo12","Mid 2001: CloudRunner Fortress",Oe),new n.UB(30,"demo30","Mid 2001: Inside CRF Galleon (T)",Oe),new n.UB(15,"demo15","Mid 2001: CloudRunner Treasure Vault (T)",Oe),new n.UB(4,"demo4","Mid 2001: Volcano Force Point Temple (T)",Oe),new n.UB(50,"demo50","Mid 2001: Ocean Force Point - Top (T)",Oe),new n.UB(21,"demo21","Mid 2001: Ocean Force Point Temple Bottom (T)",Oe),new n.UB(23,"demo23","Mid 2001: Ice Mountain",Oe),new n.UB(10,"demo10","Mid 2001: Snowhorn Wastes (T)",Oe),new n.UB(11,"demo11","Mid 2001: Krazoa Palace (T)",Oe),new n.UB(13,"demo13","Mid 2001: Walled City (T)",Oe),new n.UB(19,"demo19","Mid 2001: DarkIce Mines (T)",Oe),new n.UB(27,"demo27","Mid 2001: DarkIce Mines 2",Oe),new n.UB(28,"demo28","Mid 2001: BOSS Galdon (T)",Oe),new n.UB(31,"demo31","Mid 2001: Test of Combat",Oe),new n.UO(32,"demo32","Mid 2001: Test of Fear (T)",Oe),new n.UB(33,"demo33","Mid 2001: Test of Observation (T)",Oe),new n.UO(34,"demo34","Mid 2001: Test of Knowledge (T)",Oe),new n.UO(39,"demo31","Mid 2001: Test of Strength (T)",Oe),new n.UB(40,"demo41","Mid 2001: Test of Sacrifice (T)",Oe),new n.UB(58,"demo58","Mid 2001: Arwing to Planet",Oe),new n.UB(59,"demo59","Mid 2001: Arwing to Darkice",Oe),new n.N(60,"demo60","Mid 2001: Arwing to Cloudrunner Fortress",Oe),new n.UB(61,"demo61","Mid 2001: Arwing to Walled City",Oe),new n.N(62,"demo62","Mid 2001: Arwing to Dragon Rock",Oe),new n.UB(44,"demo62","Mid 2001: Boss Drakor",Oe),new n.UB(38,"demo62","Mid 2001: Andross",Oe),"Mid-late 2001 Maps",new n.N(29,"demo29","Mid-Late 2001: Cape Claw",Oe),new n.N(14,"demo14","Mid-Late 2001: LightFoot Village",Oe),new n.N(2,"demo2","Mid-Late 2001: Dragon Rock (T)",Oe),new n.N(52,"demo52","Mid-Late 2001: Dragon Rock Bottom",Oe),new n.N(48,"demo48","Mid-Late 2001 Boss T-rex (T)",Oe),new n.N(16,"demo16","Mid-Late 2001: CloudRunner Dungeon (T)",Oe),new n.N(43,"demo43","Mid-Late 2001: CloudRunner Race",Oe),new n.N(12,"demo12","Mid-Late 2001: CloudRunner Fortress (T)",Oe),new n.N(4,"demo4","Mid-Late 2001: Volcano Force Point Temple (T)",Oe),"Late 2001 Maps",new n.yD(0,"demo8","Late 2001: Ship Battle",Oe),new n.yD(65,"demo63","Late 2001: Great Fox (T)",Oe),new n.yD(51,"demo51","Late 2001: Shop (T)",Oe),new n.yD(33,"demo33","Late 2001: Test of Observation (T)",Oe),new n.yD(11,"demo11","Late 2001: Krazoa Palace (T)",Oe),new n.yD(19,"demo19","Late 2001: DarkIce Mines (T)",Oe),new n.yD(27,"demo27","Late 2001: DarkIce Mines 2 (T)",Oe),new n.yD(28,"demo28","Late 2001: BOSS Galdon (T)",Oe),new n.yD(23,"demo23","Late 2001: Ice Mountain (T)",Oe),new n.yD(66,"demo67","Late 2001: LinkA (Warpstone Warp) (T)",Oe),new n.yD(56,"demo56","Late 2001: LinkB (Ice2Wastes) (T)",Oe),new n.yD(67,"demo68","Late 2001: LinkC (Wastes2Hollow) (T)",Oe),new n.yD(68,"demo69","Late 2001: LinkD (DIM top 2 Bottom) (T)",Oe),new n.yD(54,"demo54","Late 2001: Magic Cave (T)",Oe),new n.yD(10,"demo10","Late 2001: Snowhorn Wastes (T)",Oe),new n.yD(7,"demo7","Late 2001: ThornTail Hollow (T)",Oe),new n.yD(8,"demo8","Late 2001: ThornTail Hollow Underground (T)",Oe),"Early 2002 (Lzo Maps)",new n.ld(51,"demo51","Early 2002: Shop (T)",Oe),new n.ld(13,"demo13","Early 2002: Walled City (T)",Oe),new n.ld(10,"demo10","Early 2002: Snowhorn Wastes (T)",Oe),new n.ld(7,"demo7","Early 2002: ThornTail Hollow (T)",Oe),new n.ld(8,"demo8","Early 2002: ThornTail Well (T)",Oe),new n.ld(11,"demo11","Early 2002: Krazoa Palace (T)",Oe),new n.ld(54,"demo54","Early 2002: Magic Cave (T)",Oe),new n.ld(2,"demo2","Early 2002: Dragon Rock",Oe),new n.ld(56,"demo56","Early 2002: LinkB (Ice2Wastes) (T)",Oe),new n.ld(67,"demo68","Early 2002: LinkC (Wastes2Hollow) (T)",Oe),new n.ld(68,"demo69","Early 2002: LinkD (DIM top 2 Bottom) (T)",Oe),new n.ld(48,"demo48","Early 2002: Boss T-rex (T)",Oe),new n.ld(33,"demo33","Early 2002: Test of Observation (T)",Oe),new n.ld(19,"demo19","Early 2002: DarkIce Mines (T)",Oe),new n.ld(27,"demo27","Early 2002: DarkIce Mines 2 (T)",Oe),new n.ld(28,"demo28","Early 2002: BOSS Galdon (T)",Oe),new n.ld(23,"demo23","Early 2002: Ice Mountain (T)",Oe),new n.ld(14,"demo14","Early 2002: LightFoot Village (T)",Oe),new n.ld(12,"demo12","Early 2002: CloudRunner Fortress (T)",Oe),new n.ld(63,"demo63","Early 2002: Title Screen (T)",Oe),new n.ld(59,"demo59","Early 2002: Arwing to Darkice",Oe),"Kiosk Maps",new ke("animtest","animtest",26,"Kiosk: Animtest",Oe),new n.yC(63,"demo63","Kiosk: Great Fox",Oe),new ke("clouddungeon","clouddungeon",16,"Kiosk: Cloudrunner Dungeon",Oe),new ke("snowmines","darkicemines",19,"Kiosk: DarkIce Mines ",Oe),new ke("snowmines2","darkicemines2",27,"Kiosk: DarkIce Mines 2 ",Oe),new ke("newicemount","icemountain",23,"Kiosk: Ice Mountain Race",Oe),new ke("snowmines3","bossgaldon",28,"Kiosk: BOSS Galdon",Oe),new n.yC(31,"demo31","Kiosk: Test of Combat",Oe),new ke("mmshrine","mmshrine",32,"Kiosk: Test of Fear",Oe),new ke("ecshrine","ecshrine",33,"Kiosk: Test of Observation",Oe),new ke("gpshrine","gpshrine",34,"Kiosk: Test of Knowledge",Oe),new ke("dbshrine","dbshrine",39,"Kiosk: Test of Strength",Oe),new ke("nwshrine","nwshrine",40,"Kiosk: NWshrine - Boss Scales",Oe),new n.yC(38,"demo38","Kiosk: Arwing Arena",Oe),new ke("cloudrace","cloudrace",43,"Kiosk: Cloudrunner Race",Oe),new ke("trexboss","bosstrex",48,"Kiosk: Boss T-rex",Oe),new ke("finalboss","bossdrakor",44,"Kiosk: Boss Drakor",Oe),new ke("swapcircle","lightfoot",14,"Kiosk: LightFoot Village",Oe),new ke("mazecave","mazecave",9,"Kiosk: Maze Cave",Oe),new ke("hollow","swaphol",7,"Kiosk: ThornTail Hollow",Oe),new ke("hollow2","swapholbot",8,"Kiosk: ThornTail Hollow Well",Oe),new ke("moonpass","mmpass",18,"Kiosk: Moon Mountain Pass",Oe),new ke("wastes","nwastes",10,"Kiosk: Snowhorn Wastes",Oe),new ke("temple","volcano",4,"Kiosk: Volcano Force Point Temple",Oe),new ke("capeclaw","capeclaw",29,"Kiosk: Cape Claw",Oe),new ke("warlock","warlock",11,"Kiosk: Krazoa Palace",Oe),new ke("wallcity","wallcity",13,"Kiosk: Walled City",Oe),new ke("dfptop","dfptop",50,"Kiosk: Ocean Force Point Temple Exterior",Oe),new ke("kraztest","desert",21,"Kiosk: Ocean Force Point Temple Interior",Oe),new ke("swapstore","shop",51,"kiosk: Shop",Oe),new ke("dragrock","dragrock",2,"Kiosk: Dragon Rock",Oe),new ke("dragbot","dragrockbot",52,"Kiosk: Dragon Rock Bot",Oe),new ke("fortress","crfort",12,"Kiosk: CloudRunner Fortress",Oe),new ke("magicave","magiccave",54,"Kiosk: Magic Cave",Oe),new n.yC(55,"demo55","Kiosk: Ice Mountain Link",Oe),new n.yC(58,"demo58","Kiosk: Arwing to Planet",Oe),new n.yC(59,"demo59","Kiosk: Arwing to Darkice",Oe),new n.yC(60,"demo60","Kiosk: Arwing to CRF",Oe),new n.yC(61,"demo61","Kisok: Arwing to Walled City",Oe),new ke("arwingdragon","arwingdragon",62,"Kiosk: Arwing to Dragon Rock",Oe),new n.yC(63,"demo64","Kiosk: Title Screen",Oe),new n.yC(65,"demo65","Kiosk Great Fox 2",Oe),new ke("linka","linka",66,"Kiosk: LinkA - Warpstone to others",Oe),new ke("linkb","linkb",56,"Kiosk: LinkB - Ice 2 Wastes",Oe),new ke("linkc","linkc",67,"Kiosk: LinkC - Wastes to Hollow",Oe),new ke("linkd","linkd",68,"Kiosk: LinkD - DIM to DIM 2",Oe),new n.yC(69,"demo69","Kiosk: LinkE - hollow to moon pass",Oe),new n.yC(70,"demo70","Kiosk: LinkF - moonpass to volcano",Oe),new n.yC(71,"demo71","Kiosk: LinkG - hollow to lightfoot",Oe),new n.yC(72,"demo72","Kiosk: LinkH - lightfoot to capecl",Oe),new ke("linkj","linkj",73,"Kiosk: LinkJ - Cape Claw 2 Ocean",Oe),new ke("linki","linki",74,"Kiosk: Linki -  CloudRunner2Race",Oe),"Final Maps","Final Maps",new ke("gamefront","gamefront",63,"Great Fox"),new ke(["frontend","galleonship"],["shipbattle","warlock"],null,"Galleon"),new ke("warlock","warlock",11,"Krazoa Palace"),new ke("arwingtoplanet","arwingdarkice",59,"Arwing Flight (Main Planet)"),new ke("hollow","swaphol",7,"ThornTail Hollow"),new ke("swapstore","shop",51,"ThornTail Shop"),new ke("hollow2",["swapholbot","swaphol"],8,"ThornTail Hollow Well"),new ke("magicave","magiccave",54,"Magic Cave"),new ke("mazecave","mazecave",9,"Cheat Token Maze"),new ke("moonpass","mmpass",18,"Moon Mountain Pass"),new ke("wastes","nwastes",10,"SnowHorn Wastes"),new ke("newicemount","icemountain",23,"Ice Mountain"),new ke("snowmines","darkicemines",19,"DarkIce Mines Exterior"),new ke("snowmines2","darkicemines2",27,"DarkIce Mines Interior"),new ke("capeclaw","capeclaw",29,"Cape Claw"),new ke("dfptop","dfptop",50,"Ocean Force Point Temple Exterior"),new ke("kraztest","dragrockbot",21,"Ocean Force Point Temple Interior"),new ke("swapcircle","lightfoot",14,"LightFoot Village"),new ke("fortress","crfort",12,"CloudRunner Fortress"),new ke("clouddungeon","clouddungeon",16,"CloudRunner Fortress Dungeon"),new ke("cloudrace","cloudrace",43,"CloudRunner Fortress Race"),new ke("wallcity","wallcity",13,"Walled City"),new ke("trexboss",["bosstrex","wallcity"],48,"Walled City Boss (RedEye King)"),new ke("dragrock","dragrock",2,"Dragon Rock"),new ke("dragbot","dragrockbot",52,"Dragon Rock Bottom"),new ke("temple","volcano",4,"Volcano Force Point Temple"),new ke("bossdrakorflatr","bossdrakor",44,"Boss Drakor"),new ke("dfshrine",["dfshrine","warlock"],31,"Krazoa Shrine (Test of Combat)"),new ke("mmshrine","mmshrine",32,"Krazoa Shrine (Test of Fear)"),new ke("ecshrine","ecshrine",33,"Krazoa Shrine (Test of Observation)"),new ke("gpshrine","gpshrine",34,"Krazoa Shrine (Test of Knowledge)"),new ke("dbshrine","dbshrine",39,"Krazoa Shrine (Test of Strength)"),new ke("nwshrine","nwshrine",40,"Krazoa Shrine (Scales Encounter)"),new ke("linkb","linkb",56,"Ice Mountain Link 2"),new ke("linkc","linkc",67,"SnowHorn Wastes Link"),new ke("linkd","linkd",68,"DarkIce Mines Mineshaft"),new ke("linke","linke",69,"Moon Mountain Pass Link"),new ke("linkf","linkf",70,"Volcano Force Point Link"),new ke("linkg","linkg",71,"LightFoot Village Link"),new ke("linkh","linkh",72,"Cape Claw Link"),new ke("linkj","linkj",73,"Ocean Force Point Link"),new ke("linki","linki",74,"CloudRunner Fortress Link?"),new ke("animtest","animtest",26,"Test Map (animtest)"),new ke("animtest","bossgaldon",28,"Boss Galdon"),new ke("arwingdragon","arwingdragon",62,"Arwing to Dragon Rock"),"MAPS BY DATE ORDER - Thorntail Hollow",new n.Qv("ancient3","Ancient ThornTail Hollow (Textured)",Fe,3),new n.UB(7,"demo7","Mid 2001: ThornTail Hollow",Oe),new n.UO(7,"demo7","Mid 2001: ThornTail Hollow (Copy of Swaphol map)",Oe),new n.yD(7,"demo7","Late 2001: ThornTail Hollow",Oe),new n.ld(7,"demo7","Very Early 2002: ThornTail Hollow",Oe),new n.yC(7,"demo7","Kiosk: ThornTail Hollow",Oe),new ke("hollow","swaphol",7,"Final: ThornTail Hollow"),"Shop/Thorntail Store",new n.Qv("ancient6","Ancient Shop (Textured)",Fe,6),new n.UB(51,"demo51","Mid 2001: Shop",Oe),new n.yD(51,"demo51","Late 2001: Shop",Oe),new n.ld(51,"demo51","Early 2002: Shop",Oe),new ke("swapstore","shop",51,"kiosk: Shop",Oe),new ke("swapstore","shop",51,"ThornTail Shop")]}},8192(e,t,s){"use strict";s.d(t,{E:()=>o,l:()=>l});var n=s(7684),i=s(329),r=s(5974),a=s(2007);class o{constructor(){this.joints=[]}addJoint(e,t){if(void 0===e&&this.joints.length>0||void 0!==e&&e>this.joints.length)throw Error("Invalid joint hierarchy in skeleton");this.joints.push({parent:e,translation:i.o8(t)})}}class l{constructor(e){this.skeleton=e,this.poseMatrices=[],this.jointMatrices=[],this.dirty=!0,this.poseMatrices=(0,r.y5)(this.skeleton.joints.length,()=>n.vt()),this.jointMatrices=(0,r.y5)(this.skeleton.joints.length,()=>n.vt()),this.dirty=!0}setPoseMatrix(e,t){n.C(this.poseMatrices[e],t),this.dirty=!0}getJointMatrix(e){return this.updateJointMatrices(),this.jointMatrices[e]}updateJointMatrices(){if(this.dirty){for(let e=0;e<this.skeleton.joints.length;e++){const t=this.skeleton.joints[e],s=this.jointMatrices[e];n.C(s,this.poseMatrices[e]),(0,a.nF)(s,t.translation),void 0!==t.parent&&n.lK(s,this.jointMatrices[t.parent],s)}this.dirty=!1}}}},7635(e,t,s){"use strict";s.d(t,{EK:()=>T,G7:()=>h,JU:()=>C});var n=s(4107),i=s(8771),r=s(7714),a=s(3793),o=s(9702),l=s(2007);class h{constructor(e,t,s,n){this.gfxTexture=e,this.gfxSampler=t,this.width=s,this.height=n}static create(e,t,s){const n=e.device.createTexture((0,r.xm)(r.$Y.U8_RGBA_NORM,t,s,1)),i=e.createSampler({wrapS:r.Vf.Clamp,wrapT:r.Vf.Clamp,minFilter:r.gD.Bilinear,magFilter:r.gD.Bilinear,mipFilter:r.P.Nearest,minLOD:0,maxLOD:100});return new h(n,i,t,s)}destroy(e){e.destroyTexture(this.gfxTexture)}setOnTextureMapping(e){e.reset(),e.gfxTexture=this.gfxTexture,e.gfxSampler=this.gfxSampler,e.width=this.width,e.height=this.height,e.lodBias=0}}class c{constructor(e){this.textures=e}destroy(e){for(let t of this.textures)t.destroy(e)}}class u{getTexture(e,t,s){const n=this.getTextureArray(e,t,s);return n?n.textures[0]:null}}function d(e,t,s){const r=t.createDataView(),a={name:"Texture",width:r.getUint16(10),height:r.getUint16(12),format:r.getUint8(22),mipCount:r.getUint16(28)+1,data:t.slice(s?32:96)},o={wrapS:r.getUint8(23),wrapT:r.getUint8(24),minFilt:r.getUint8(25),magFilt:r.getUint8(26)},l=n.HY(a,a.mipCount),c=(0,i.ln)(e.device,l),[u,d]=(0,i.nw)(o.minFilt),m=e.createSampler({wrapS:(0,i.Hp)(o.wrapS),wrapT:(0,i.Hp)(o.wrapT),minFilter:u,magFilter:(0,i.nw)(o.magFilt)[0],mipFilter:d,minLOD:0,maxLOD:100}),p=new h(c.gfxTexture,m,a.width,a.height);return p.viewerTexture=c.viewerTexture,p}function m(e){return 4294967295!=e&&!!(2147483648&e)}function p(e,t){const s=128,n=e.device,i=n.createTexture((0,r.xm)(r.$Y.U8_RGBA_NORM,s,s,1)),a=e.createSampler({wrapS:r.Vf.Repeat,wrapT:r.Vf.Repeat,minFilter:r.gD.Bilinear,magFilter:r.gD.Bilinear,mipFilter:r.P.Nearest,minLOD:0,maxLOD:100}),o=[255,255,255],l=[.9*o[0],.9*o[1],.9*o[2]],u=[o[0],o[1],o[2],255],d=[l[0],l[1],l[2],255],m=new Uint8Array(65536);for(let e=0;e<s;e++)for(let t=0;t<s;t++){let n=!!(1&t/32);1&e/32&&(n=!n);const i=n?u:d;m.set(i,4*(e*s+t))}return n.uploadTextureData(i,0,[m]),new c([new h(i,a,2,2)])}class f{listAllValidIds(){const e=[],t=this.tab.byteLength/4|0;for(let s=0;s<t;s++)m(this.tab.getUint32(4*s))&&e.push(s);return e}constructor(e,t,s,n){this.tab=e,this.bin=t,this.name=s,this.isBeta=n,this.textures=[]}hasTexture(e){return!(e<0||4*e>=this.tab.byteLength)&&m((0,l.Wg)(this.tab,0,e))}isTextureLoaded(e){return void 0!==this.textures[e]}getTextureArray(e,t){if(void 0===this.textures[t])try{const s=function(e,t,s,n,i){const r=(0,l.Wg)(t,0,n);if(m(r)){const t=r>>24&63,n=2*(16777215&r);if(1===t){const t=s.slice(n),r=(0,o.vR)(t);return new c([d(e,r,i)])}{const r=[],a=s.createDataView();for(let h=0;h<t;h++){const t=(0,l.Wg)(a,n,h),c=s.slice(n+t),u=(0,o.vR)(c);r.push(d(e,u,i))}return new c(r)}}return null}(e,this.tab,this.bin,t,this.isBeta);if(null!==s)for(let e=0;e<s.textures.length;e++){const n=s.textures[e].viewerTexture;void 0!==n&&(n.name=`${this.name} #${t}`),s.textures.length>1&&(n.name+=`.${e}`)}this.textures[t]=s}catch(s){console.error(s),this.textures[t]=p(e)}return this.textures[t]}destroy(e){for(let t of this.textures)null==t||t.destroy(e)}}async function g(e,t,s,n){try{const[i,r]=await Promise.all([e.fetchData(t),e.fetchData(s)]);return new f(i.createDataView(),r,s,n)}catch(e){return console.warn("Failed to fetch texture file due to exception:"),console.error(e),null}}class T extends u{constructor(){super(...arguments),this.textures=[]}getTextureArray(e,t,s){return void 0===this.textures[t]&&(this.textures[t]=p(e)),this.textures[t]}async loadSubdirs(e,t){}destroy(e){for(const t of this.textures)null==t||t.destroy(e);this.textures=[]}}class x{constructor(e,t){this.tex0=e,this.tex1=t}destroy(e){var t,s;null===(t=this.tex0)||void 0===t||t.destroy(e),this.tex0=null,null===(s=this.tex1)||void 0===s||s.destroy(e),this.tex1=null}}async function v(e,t,s){var n,i,a,o;const l=e.device,{width:c,height:u,pixels:d}=await async function(e){const t=e instanceof Uint8Array?e.slice():new Uint8Array(e).slice(),s=new Blob([t],{type:"image/png"}),n=await createImageBitmap(s);try{const e=n.width,t=n.height;let s,i;if("undefined"!=typeof OffscreenCanvas)s=new OffscreenCanvas(e,t),i=s.getContext("2d");else{const n=document.createElement("canvas");n.width=e,n.height=t,s=n,i=n.getContext("2d")}if(!i)throw new Error("2D canvas context unavailable for PNG decode");return i.drawImage(n,0,0),{width:e,height:t,pixels:i.getImageData(0,0,e,t).data}}finally{n.close()}}(t),m=l.createTexture((0,r.xm)(r.$Y.U8_RGBA_NORM,c,u,1)),p=new Uint8Array(d.buffer,d.byteOffset,d.byteLength);l.uploadTextureData(m,0,[p]);const f=function(e,t=r.Vf.Clamp,s=r.gD.Bilinear,n=r.gD.Bilinear,i=r.P.Nearest){return e.createSampler({wrapS:t,wrapT:t,minFilter:s,magFilter:n,mipFilter:i,minLOD:0,maxLOD:100})}(e,null!==(n=null==s?void 0:s.wrap)&&void 0!==n?n:r.Vf.Repeat,null!==(i=null==s?void 0:s.minFilter)&&void 0!==i?i:r.gD.Bilinear,null!==(a=null==s?void 0:s.magFilter)&&void 0!==a?a:r.gD.Bilinear,null!==(o=null==s?void 0:s.mipFilter)&&void 0!==o?o:r.P.Nearest);return new h(m,f,c,u)}class C extends u{listAllTextureIDs(e=!1){const t=new Set;for(const s in this.subdirTextureFiles){const n=this.subdirTextureFiles[s],i=e?n.tex1:n.tex0;if(i)for(const e of i.listAllValidIds())t.add(e)}if(!e&&this.texpre)for(const e of this.texpre.listAllValidIds())t.add(e);return[...t].sort((e,t)=>e-t)}loadAllFromTables(e,t=!1){let s=0,n=0;const i=(e,t,i,r)=>{if(e){s++;for(let s=0;s<e.textures.length;s++){const a=e.textures[s].viewerTexture;a&&(a.name&&"Texture"!==a.name||(a.name=`${t}:${i} #${r}${e.textures.length>1?`.${s}`:""}`),-1===this.textureHolder.viewerTextures.indexOf(a)&&(this.textureHolder.viewerTextures.push(a),n++))}}};for(const s in this.subdirTextureFiles){const n=this.subdirTextureFiles[s],r=t?n.tex1:n.tex0;if(!r)continue;const a=r.listAllValidIds();for(const n of a)i(r.getTextureArray(e,n),t?"TEX1":"TEX0",s||"(root)",n)}if(!t&&this.texpre){const t=this.texpre.listAllValidIds();for(const s of t)i(this.texpre.getTextureArray(e,s),"TEXPRE","(global)",s)}return this.textureHolder.onnewtextures&&this.textureHolder.onnewtextures(),{attempted:s,shown:n}}setTexturesEnabled(e){this.texturesEnabled=e}getTexturesEnabled(){return this.texturesEnabled}setCurrentModelID(e){this.currentModelID=0|e}preferCopyOfSwapholForModelIDs(e){for(const t of e)this.preferCOSModelIDs.add(0|t)}setPngOverride(e,t,s){this.pngOverrides.set(e,{path:t,opts:s})}async preloadPngOverrides(e,t){const s=this.gameInfo.pathBase;for(const[n,{path:i,opts:r}]of this.pngOverrides){if(this.preloadedPngTextures.has(n))continue;const a=(await t.fetchData(`${s}/${i}`)).createTypedArray(Uint8Array),o=await v(e,a,r);this.preloadedPngTextures.set(n,new c([o]))}}loadAll(){throw new Error("Method not implemented.")}constructor(e,t){super(),this.gameInfo=e,this.isBeta=t,this.texturesEnabled=!0,this.currentModelID=0,this.preferCOSModelIDs=new Set,this.pngOverrides=new Map,this.preloadedPngTextures=new Map,this.subdirTextureFiles={},this.fakes=new T,this.loadedTextureIDs=[],this.loadedTextures=new Map,this.textureHolder={viewerTextures:[],onnewtextures:null},this.modelVersion=a.o.Final}static async create(e,t,s){const n=new C(e,s),i=n.gameInfo.pathBase,[r,a]=await Promise.all([t.fetchData(`${i}/TEXTABLE.bin`),g(t,`${i}/TEXPRE.tab`,`${i}/TEXPRE.bin`,!1)]);return n.textableBin=r.createDataView(),n.texpre=a,n}async loadSubdir(e,t){if(void 0===this.subdirTextureFiles[e]){const s=this.gameInfo.pathBase,[n,i]=await Promise.all([g(t,`${s}/${e}/TEX0.tab`,`${s}/${e}/TEX0.bin`,this.isBeta),g(t,`${s}/${e}/TEX1.tab`,`${s}/${e}/TEX1.bin`,this.isBeta)]);this.subdirTextureFiles[e]=new x(n,i),"clouddungeon"===e||"cloudrace"===e?await this.loadSubdir("crfort",t):"icemountain"===e?await this.loadSubdir("nwastes",t):"desert"===e?(await this.loadSubdir("dfptop",t),await this.loadSubdir("volcano",t)):"crfort"===e?await this.loadSubdir("gpshrine",t):"linkb"===e||"linkf"===e?await this.loadSubdir("volcano",t):"shipbattle"===e?await this.loadSubdir("",t):"linkc"===e?await this.loadSubdir("nwastes",t):"mmpass"===e?(await this.loadSubdir("shop",t),await this.loadSubdir("warlock",t)):"swaphol"===e?(await this.loadSubdir("Copy of swaphol",t),await this.loadSubdir("nwastes",t),await this.loadSubdir("mmpass",t)):"swapholbot"===e||"shop"===e?(await this.loadSubdir("Copy of swaphol",t),await this.loadSubdir("swaphol",t),await this.loadSubdir("ecshrine",t)):"wallcity"===e?await this.loadSubdir("gpshrine",t):"darkicemines"===e?await this.loadSubdir("shop",t):"bossgaldon"===e||"gpshrine"===e?await this.loadSubdir("dragrock",t):"mmshrine"===e&&await this.loadSubdir("gpshrine",t)}else"nwastes"===e&&await this.loadSubdir("icemountain",t)}async loadSubdirs(e,t){const s=[];for(let n of e)s.push(this.loadSubdir(n,t));await Promise.all(s)}setModelVersion(e){this.modelVersion=e}logAllTex1TextureIDs(){for(const e in this.subdirTextureFiles){const t=this.subdirTextureFiles[e];if(t.tex1)for(let e=0;e<5e3;e++)t.tex1.hasTexture(e)}}getTextureArray(e,t,s){if(!this.texturesEnabled)return this.fakes.getTextureArray(e,t,s);const n={5:5555,24:24,57:60,58:61,146:980,154:980,157:130,162:146,177:157,176:999,268:398,427:179,428:186,457:563,310:256,311:257,312:253,313:258,332:483,349:486,358:1014,361:491,362:491,487:483,488:486,489:485,490:486,491:487,492:487,493:490,494:491,495:492,496:492,497:5555,499:501,500:489,502:515,503:490,504:486,505:251,515:486,547:770,634:1984,639:488,898:977,901:993,912:1005,417:178,425:181,530:522,532:592,533:593,534:594,536:532,541:533,542:533,546:534,549:568,553:1006,555:412,556:532,559:532,560:535,561:559,562:1123,563:561,564:562,565:561,566:561,567:564,568:564,569:565,570:565,571:566,572:567,573:567,574:565,576:534,638:926,640:183,654:654,657:642,674:1012,675:666,691:549,705:674,706:565,707:559,708:674,709:565,710:654,711:674,767:766,856:943,860:948,862:949,871:786,896:980,897:991,900:975,902:1004,903:1005,904:1005,905:975,906:976,907:977,908:978,909:977,910:980,913:1007,916:1006,917:982,918:1009,933:951,943:951,946:1042,947:948,948:942,949:951,951:537,952:553,954:951,974:980,975:974,977:980,978:978,980:1083,981:1084,982:1086,983:1085,984:1086,985:1087,986:1087,987:1088,989:1090,990:1091,991:1092,992:1090,993:1090,994:1096,995:1097,997:1093,1e3:1102,1001:1103,1002:1104,1003:1106,1007:1112,1008:1113,1009:1114,1090:979,1100:398,2024:2373,2141:187,2206:2205,2435:2001,2635:2222,535:897,651:897,660:898,719:880,720:881,721:879,722:879,807:899,810:908,812:900,813:910,814:909,815:910,816:530,1812:1761,1814:406,1815:879,2094:903,155:977,605:398,606:301,607:323,608:398,609:398,611:398,610:398,612:592,613:593,614:594,615:595,616:398,617:1101,618:398,619:398,620:1337,621:398,622:595,623:398,624:1337,666:1337,668:1294,899:2373,976:1346,998:1348,1006:1010,1010:1115,1245:1306,1246:1307,1252:1314,1253:1315,1254:1315,1255:1317,1258:1320,1261:1321,1269:1330,1270:1331,1271:1332,1272:1333,1275:1336,1276:1337,1277:1338,1282:1344,1283:1347,1287:1349,1288:1353,1289:1345,1307:1337,1345:1337,21:64,27:44,30:45,31:45,32:45,33:45,34:45,36:47,37:65,45:64,46:51,49:45,59:62,61:63,62:66,67:72,68:73,69:62,70:1472,71:74,136:61,811:71,914:65,915:67,1294:35,1295:35,2056:54,2640:54,473:957,508:722,509:723,510:724,517:725,522:724,665:726,859:726,861:726,920:726,1101:726,1105:5555,1109:1088,1906:726,2139:726,73:402,80:85,82:84,83:85,84:86,85:87,86:88,87:89,88:90,89:91,90:92,91:93,92:94,93:1038,94:97,95:98,96:99,97:100,98:1071,99:101,100:103,101:104,103:105,414:2761,415:396,416:396,418:397,419:109,422:2761,424:415,911:978,1491:400,1492:2761,2018:2761,2020:2761,2595:2761,2761:93,1466:1528,1467:1529,1468:1530,1469:1531,1470:1532,1471:1533,1472:1533,1473:1535,1474:1536,1475:1537,1524:177,1922:406,9:405,147:5555,577:571,579:1170,580:574,581:5555,582:589,583:590,584:1163,585:1163,586:577,587:578,588:590,589:582,590:584,591:585,592:586,593:591,595:576,596:589,597:590,598:993,599:588,600:580,601:579,602:575,603:5555,988:570,999:1100,604:571,1035:5555,1036:5555,1051:571,1054:503,1057:5555,1058:5555,1061:1163,1062:1163,1063:579,1066:1146,1068:572,1073:5555,1074:580,1075:5555,1076:5555,1080:5555,1532:5555,523:523,524:522,525:524,526:524,527:525,528:522,529:526,531:1649,539:952,944:543,199:15,200:19,391:8,392:9,757:12,550:10,554:13,717:17,809:14,968:6,1018:7,1019:20,2163:16,1013:1083,1014:1084,1016:1085,1017:1086,1020:1089,1021:1090,1026:1096,1027:1097,1028:1100,1030:1102,1031:1103,1032:1104,1033:1106,1034:1108,1038:1114,1039:1115,2090:5555,2727:5555,384:437,385:438,386:439,545:614,551:620,552:621,557:627,558:628,637:713,690:765,718:799,723:5555,770:5555,942:1026,956:1040,1042:5,7:755,543:769,544:779,763:759,764:760,766:765,768:755,769:767,771:770,772:771,773:772,775:777,776:778,777:1956,778:779,779:781,781:782,782:784,783:784,784:785,785:787,787:780,1156:755,1811:769,1011:5,1005:1108,996:1035,137:1221,197:1645,387:1094,388:1247,389:5555,390:1115,1106:1093,1107:1094,1108:1188,1110:1088,1111:1094,1112:1180,1113:1248,1114:1197,1115:2358,1116:1648,1117:1196,1118:1197,1119:1214,1120:1648,1121:1198,1122:1188,1123:1227,1124:553,1125:1227,1126:1093,1127:1227,1128:1241,1129:1088,1130:1088,1131:2358,1133:1089,1134:1089,1135:1211,1136:1105,1138:1180,1139:1198,1141:1180,1143:1240,1145:1082,1146:1094,1147:1213,1148:3500,1149:5555,1150:1868,1151:1220,1152:1090,1153:1206,1154:1091,1155:1091,1161:3501,1157:1092,1158:3611,1159:1093,1160:3e3,1168:1248,1187:1096,1188:1094,1189:1095,1190:1248,1191:1095,1192:1221,1193:1096,1194:5555,1196:5555,1197:5555,1198:5555,1206:5555,1211:5555,1213:5555,1214:5555,1449:5555,1489:5555,1685:5555,1692:1866,1695:539,1696:2358,1988:1130,1989:1130,1990:1130,1991:1130,2621:1128,2624:1115,2625:1115,56:59,220:5555,221:465,437:3612,438:206,439:468,440:3612,442:219,443:219,449:205,450:206,451:461,454:461,455:216,458:214,461:457,462:457,463:206,465:216,466:461,468:3613,469:222,470:221,471:220,472:233,475:466,476:467,477:219,478:224,480:197,484:197,485:238,486:206,703:219,704:206,2047:5555},i={303:5555,340:497,341:497,342:497,349:5555,353:5555,354:5555,357:5555,358:5555,361:5555,362:5555,370:5555,374:483,375:483,379:5503,380:5503,382:5503,446:482,514:495,497:55555,903:5503,976:5503,2068:5502,2069:5503,2718:760,2849:5555,2866:499,2867:500,2868:498,2869:505,2870:241,2871:494,2872:496,2873:505,2874:479,2876:482,2877:506,2880:506,2879:481,3228:5503,323:256,325:256,326:258,371:256,503:483,505:484,506:487,507:487,508:490,509:490,510:491,511:492,512:492,516:256,517:489,520:490,648:487,653:488,2717:5555,2864:486,2865:485,3202:253,3364:251,3365:256,3366:252,3367:257,3368:5555,3369:251,3370:255,3371:255,3372:257,3373:257,3374:490,3375:258,3376:487,5:5555,71:76,78:85,80:84,81:85,82:86,83:87,84:88,85:89,86:90,87:91,88:92,89:93,91:95,92:97,93:98,94:99,95:100,96:1071,97:101,98:103,99:104,101:105,103:107,104:108,432:109,440:113,441:411,443:415,573:412,756:5555,1542:1552,1543:1553,1544:1513,1996:90,2078:96,2080:99,2110:1513,2465:398,2674:413,2723:5555,793:1138,795:1139,1057:1131,1058:1133,1059:1134,1060:1135,1061:1136,1062:1137,1064:1140,1086:1132,595:574,596:575,599:1163,603:583,604:582,605:584,606:585,607:586,608:587,610:589,611:590,612:591,618:682,1094:1934,1095:1934,1108:5555,1109:5555,2826:578,2827:579,2828:580,2829:576,2830:577,2831:591,2832:682,2833:683,2834:685,2835:575,2836:575,2967:573,2968:581,2969:581,2970:581,3218:1170,3219:1170,3221:1146,3225:570,3226:588,3227:5555,3388:1171,3389:1111,90:5555,412:5555,415:5555,433:396,434:396,436:397,437:398},r={176:1099,553:1090,984:1086,988:1089,989:1090,994:1096,995:1097,1009:1114,2640:1096,87:1068,88:1069,90:5555,93:1070,96:1071,117:1072,177:1073,447:1072,503:483,507:258,508:490,512:257,571:1075,650:257,783:1076,785:1077,790:1078,791:1079,792:1080,793:1081,794:1082,795:1083,846:1084,847:1085,848:1086,1011:1103,1013:1098,1014:1099,1016:1105,1017:1101,1021:1105,1024:1109,1025:1110,1028:1115,1030:1117,1031:1118,1032:1119,1033:1121,1034:1123,1037:1128,1039:1130,1163:1088,1168:1089,1185:1090,1188:1091,1190:1092,1192:1093,1221:1094,1224:1095,1226:1096,2727:5555,980:1083,981:1084,982:1099,983:1085,985:1086,986:1087,990:1091,991:1092,998:1100,1e3:1102,1001:1103,1002:1104,1003:1106,1005:1108,1007:1112,1010:1115,2460:5555,40:40,118:118,437:437,438:438,439:439,614:614,616:616,617:617,618:618,620:620,621:621,626:626,627:627,628:628,629:629,713:713,765:765,766:766,799:799,908:908,918:918,1026:1026,1036:1036,1040:1040,2760:2760},o={189:1099,1065:1083,1066:1084,1067:1085,1068:1086,1069:1087,1070:1090,1071:1091,1072:1092,1075:1100,1076:1102,1077:1103,1078:1104,1079:1106,1080:1108,1082:1112,1084:1115,2900:1112},l={2282:5555,44:558,430:1680,431:2060,432:2060,565:1978,567:2121,568:2365,569:2365,570:537,571:1042,572:542,573:539,575:541,576:539,577:539,578:542,579:548,580:553,581:552,582:553,583:553,584:1042,585:1042,586:553,680:548,707:548,708:555,790:548,791:1073,917:1041,918:544,920:1042,921:1041,924:537,927:537,928:1701,930:542,933:951,2794:2373,2881:545,2882:546,0:130,7:97,43:97,79:97,87:85,90:103,91:84,92:85,93:86,94:87,95:88,96:90,97:91,98:92,99:93,100:95,101:97,102:99,105:97,106:98,107:99,108:1071,109:103,111:111,112:111,113:111,114:104,115:104,116:107,117:108,151:109,255:5555,456:89,457:5555,458:98,459:103,460:2080,740:130,1352:412,1383:98,1389:104,1392:24,1402:412,1415:1564,1416:5555,1926:99,1943:98,1988:5555,1989:1161,1990:1162,587:559,588:561,589:560,590:562,591:561,592:564,593:564,594:564,595:567,596:567,597:565,598:3002,687:565,688:565,689:568,690:559,691:561,692:562,693:565,694:561,695:674,696:561,697:674,698:565,699:3001,700:3003,701:3004,702:3005,703:3006,704:565,705:565,706:674,956:559,957:565,958:562,959:562,960:674,998:563,213:210,298:948,558:2353,564:952,574:531,599:948,600:948,601:948,603:532,604:949,681:1803,683:2353,684:531,800:957,811:957,813:5555,818:5555,836:957,840:919,851:919,856:532,1198:5555,1317:572,1347:2122,1662:2122,1797:948,1798:1803,1799:948,1805:130,1806:130,1927:130,1928:130,1935:50,1951:950,1952:950,2046:917,2216:948,2225:775,2228:2248,2231:2353,2465:2122,2467:2248,2538:2248,2541:919,2747:533,2791:1802,554:5555,555:5555,556:5555,559:5555,561:5555,605:5555,670:5555,677:5555,678:5555,709:5555,710:580,711:5555,712:584,857:5555,858:5555,1649:5555,1729:5555,1831:5555,1832:5555,1833:5555,1834:5555,1835:5555,1836:5555,1837:5555,1838:5555,2166:5555,2748:5555,3:405,103:1537,104:1537,118:402,120:1537,320:1537,845:404,1365:1528,1366:1529,1367:1531,1368:1533,1369:1537,1370:1534,1371:1535,1372:1536,1373:551,1374:407,1375:1537,1376:407,1391:24,1727:402,1730:403,1728:1761,1839:406,2390:1537,2862:404,2863:1532,2870:401,2883:402,606:596,607:595,608:591,609:613,610:590,611:558,612:611,613:616,614:617,615:617,616:610,617:609,618:612,619:608,620:606,621:607,622:605,623:592,624:593,625:594,626:5555,627:563,628:604,629:615,630:603,631:589,632:588,633:579,634:602,635:618,636:587,637:4100,638:586,639:614,640:5555,641:583,642:582,643:581,644:602,645:611,646:601,647:600,648:5555,649:599,651:5555,671:598,672:1294,713:760,714:5555,1146:585,1175:597,1176:602,2793:760,794:2003,795:2002,796:2001,797:2e3,931:5555,1084:2037,1085:2036,1086:2035,1087:2034,1088:2033,1089:2032,1090:2031,1091:2030,1092:2029,1093:2028,1094:2027,1095:2026,1097:2025,1098:2024,1099:2023,1100:2022,1101:2021,1102:2020,1103:2019,1104:2018,1106:2017,1107:2016,1109:2015,1110:2014,1111:2013,1112:2012,1113:2011,1115:2010,1116:2009,1117:2008,1118:2007,1119:2006,1120:2005,1936:2004,1953:5555,1954:5555,1955:5555,2784:5555,231:5555,340:5555,341:5555,342:5555,343:5555,344:5555,348:5555,349:5555,351:5555,350:5555,352:5555,371:5555,389:5555,398:5555,401:5555,403:5555,404:5555,410:5555,412:5555,414:5555,415:5555,416:5555,418:5555,2798:5555},h={173:4013,185:4012,186:4011,189:999,198:4010,203:4001,2954:4e3,2960:4001,3050:4002,3051:4003,3052:4004,3053:4005,3054:4001,3055:4006,3056:4007,3057:4008,3058:4009},c={651:537,656:542,660:544,668:552,670:553,674:556,675:557,677:559,678:560,679:561,680:562,681:562,682:563,683:564,684:565,685:567,686:568,688:5555,689:5555,690:5555,691:5555,692:5555,693:569,803:674,1183:1083,1184:1084,1185:1085,1186:1086,1188:1088,1189:1093,1191:1090,1200:1108,1202:1035,1203:1100,1205:1102,1206:1103,1207:1104,1208:1090,1210:1108,1211:1110,1214:1113,1216:1115,1219:5555,2795:1105,1011:1602,1012:951,1013:917,1014:919,1021:926,1022:943,1032:5555,1033:937,1037:5555,1038:949,1039:942,1040:943,1041:944,1044:947,1045:948,1047:949,1048:950,1051:952,1056:957,1058:960,1062:964,1067:968,1068:969,629:522,630:5555,631:524,632:524,633:525,634:526,635:5555,636:526,723:592,724:593,725:594,726:595,727:1330,1449:1331,1450:1303,1451:1330,1453:1306,1454:1307,1455:1307,1457:1330,1458:1309,1463:1314,1464:1315,1466:5555,1468:1319,1469:1321,1470:1294,1477:1330,1478:1331,1480:1333,1484:1337,1485:1338,1486:1337,1492:1345,1493:1346,1494:1347,1495:1348,1496:1349,1500:1353,1501:1330,1506:5555,647:552,648:917,652:538,653:539,655:541,657:542,661:545,662:546,664:548,665:549,669:553,671:554,672:908,673:555,676:558,1131:1038,1135:1042,649:534,650:535,658:543,659:1042,627:519,843:720,844:716,845:717,846:718,847:719,848:722,849:723,850:724,851:721,852:721,853:728,854:725,855:726,856:727,857:728,227:205,228:206,247:213,248:214,257:216,258:217,261:219,262:220,263:221,264:222,265:224,266:225,279:233,280:234,281:235,296:238,565:455,566:456,567:457,568:458,570:460,571:461,573:463,574:464,575:465,576:468,579:467,580:466,581:198,582:5555,1395:199,1396:200,916:789,917:791,918:792,919:793,920:794,963:873,921:797,922:917,923:798,924:797,925:5555,926:801,927:802,928:804,509:178,523:179,527:181,528:179,532:186,738:1984,741:180,742:183,768:182,1753:5555,1752:177,2334:187,617:508,618:509,815:686,816:687,817:689,818:690,819:691,820:692,821:693,822:695,823:696,824:699,825:700,828:703,829:704,830:671,831:706,832:509,833:707,834:708,534:445,535:430,536:1429,537:432,538:432,539:432,540:193,541:449,542:433,543:444,544:433,545:434,546:435,547:436,548:437,549:439,550:440,551:441,552:441,553:442,554:446,555:444,556:447,557:448,558:450,559:435,560:451,561:455,562:453,563:454,564:455},u={651:537,656:542,660:544,668:552,670:553,674:556,675:557,677:559,678:560,679:561,680:562,681:562,682:563,683:564,684:565,685:567,686:568,688:5555,689:5555,690:5555,691:5555,692:5555,693:569,803:674,2881:566,1183:1083,1184:1084,1185:1085,1186:1086,1188:1088,1189:1093,1191:1090,1200:1108,1202:1035,1203:1100,1205:1102,1206:1103,1207:1104,1208:1090,1210:1108,1211:1110,1214:1113,1216:1115,1219:5555,2795:1105,929:951,930:917,931:919,937:943,938:926,939:943,942:5555,943:5555,944:5555,947:5555,948:943,949:5555,950:937,951:5555,952:5555,954:5555,955:949,956:942,957:943,958:944,960:947,961:947,962:948,964:949,965:950,966:950,967:952,972:957,975:960,979:964,983:968,984:968,985:969,2486:531,629:522,630:5555,631:524,632:524,633:525,634:526,635:5555,636:526,646:592,647:593,648:594,649:595,650:1330,1336:1303,1339:1306,1340:1307,1352:5555,1354:1320,1355:1321,1356:1294,1364:1330,1365:1331,1371:1337,1373:1337,1379:1345,1380:1346,1381:1347,1383:1349,1388:1330,1393:5555,2497:1338,2498:1315,2499:1333,2500:2298,2501:1348,2502:1314,2503:1330,2504:1309,2505:1353,572:917,575:537,576:538,577:539,579:541,581:542,582:543,583:544,584:545,585:546,587:548,588:549,591:552,592:553,594:554,595:908,596:555,597:556,598:557,599:558,1054:1038,1058:1042,658:543,665:549,669:553,673:555,1131:1038,1135:1042,551:519,764:720,765:716,766:717,767:718,768:719,769:722,770:723,771:724,772:721,773:721,774:728,775:725,776:726,777:727,778:728,214:205,215:206,222:213,223:214,225:216,226:217,227:219,228:220,229:221,230:222,231:224,232:225,239:233,240:234,241:235,243:238,489:456,490:457,491:458,493:460,494:461,496:463,497:465,498:466,499:467,500:468,504:198,505:5555,2574:199,2575:200,2576:5555,836:789,837:791,838:792,839:793,840:794,2572:790,963:873,841:797,842:917,843:798,844:797,845:797,846:5555,926:801,927:802,928:804,2871:1984,2885:179,2886:183,2887:186,2888:187,2889:182,2890:180,2891:178,2892:181,2893:177,2894:5555,541:508,542:509,736:686,737:687,738:689,739:690,740:691,741:692,742:693,743:695,744:696,745:699,746:700,749:703,750:704,751:2013,752:706,753:509,754:707,755:708,756:5555,535:430,536:1429,537:432,538:432,539:432,540:193,544:433,545:434,546:435,547:436,548:437,549:439,550:440,552:441,553:442,554:446,555:444,556:447,557:448,558:450,560:451,561:455,562:453,563:454,564:455,2800:436,2801:433,2802:1429,2873:445,2884:444,253:5555,254:5555,256:5555,258:5555,259:5555,260:5555,510:5555,512:5555,514:5555,515:5555,517:5555,518:5555,519:5555,2507:5555,2508:5555,2509:5555,2510:5555,2511:5555,2512:5555,2513:5555,2514:5555,2515:5555,2516:5555,80:76,88:84,89:85,90:86,91:87,92:88,93:89,94:90,95:91,96:92,97:93,99:95,100:96,101:97,102:98,103:99,104:100,105:102,106:101,107:103,109:105,111:107,112:108,113:109,513:410,516:411,520:414,521:415,1716:1552,1717:1553,884:768,885:757,886:757,887:759,888:760,889:761,890:762,891:764,892:765,893:766,894:755,895:767,897:769,898:770,899:772,900:773,901:774,903:777,904:778,905:779,906:780,907:755,908:781,909:782,910:783,911:784,912:785,913:786,914:787,915:788,1301:1187,1302:1187,1305:1242,1306:1188,1308:1191,1309:1192,1310:1191,1311:1192,1312:1194,1313:1193,1314:1194,1315:1228,1322:5555,1330:1236,1332:1211,1333:1241,1335:3610,1338:1209,1341:1216,1342:1217,1343:1218,1344:1215,1345:1221,1346:1198,1349:1226,1350:1227,1353:1197,1357:1236,1358:1239,1359:1240,1360:1241,1361:1243,1362:1244,1370:1246,1390:5555,1391:1248,1395:1249,1396:1249,1397:2341,2825:1219,2826:1219,2833:1213,2834:1214,2835:1215,2836:3612,2837:3613,2838:3614,2839:1223,2840:1224,2841:1225,2842:1201,1153:1131,1154:1132,1155:1133,1156:1134,1157:1135,1158:1136,1159:1137,1160:1138,1161:1139,1163:1140,1164:1141},d={15:{100:100,114:114,124:124,489:489,630:630,1619:1619,1620:1620,1621:1621,1954:1954,2175:2175,2176:2176,2574:2574,2849:2849},64:{91:91,565:565,705:705,736:736},30:{57:61,58:62,86:85,87:86,93:92,666:657,530:522,533:525,532:524,531:523,528:520,675:666,529:521,523:515,524:516},7:{559:629,568:5,556:626,553:621,549:618,547:616,532:450,946:1030,952:1036}},m={11:{649:595,650:1330,1335:1337},8:{649:534,650:535},63:{541:508,542:509},27:{551:441},23:{541:519},12:{518:412,519:413},2:{518:491,443:486,573:491},13:{1352:3611,1354:1230,1355:1229,1356:1232},48:{2718:5555}},p={7:{1030:1030,1031:1031,1032:1032}};if(this.modelVersion===a.o.Early1){const i=d[this.currentModelID];if(i&&void 0!==i[t])t=i[t];else{if(void 0===n[t])return this.fakes.getTextureArray(e,t,s);t=n[t]}}else if(this.modelVersion===a.o.AncientMap){if(!(t in l))return this.fakes.getTextureArray(e,t,s);t=l[t]}else if(this.modelVersion===a.o.dup){const n=p[this.currentModelID];if(n&&void 0!==n[t])t=n[t];else{if(void 0===r[t])return this.fakes.getTextureArray(e,t,s);t=r[t]}}else if(this.modelVersion===a.o.fear){if(!(t in o))return this.fakes.getTextureArray(e,t,s);t=o[t]}else if(this.modelVersion===a.o.dfpt){if(!(t in h))return this.fakes.getTextureArray(e,t,s);t=h[t]}else if(this.modelVersion===a.o.Early2){if(!(t in i))return this.fakes.getTextureArray(e,t,s);t=i[t]}else if(this.modelVersion===a.o.Early4){const n=m[this.currentModelID];if(n&&void 0!==n[t])t=n[t];else{if(void 0===u[t])return this.fakes.getTextureArray(e,t,s);t=u[t]}}else if(this.modelVersion===a.o.Early3){if(!(t in c))return this.fakes.getTextureArray(e,t,s);t=c[t]}const f=this.preloadedPngTextures.get(t);if(f)return f;let g=this.getTextureFile(t,s);if(null===g.file)return this.fakes.getTextureArray(e,t,s);const T=!g.file.isTextureLoaded(g.texNum),x=g.file.getTextureArray(e,g.texNum);if(null===x)return this.fakes.getTextureArray(e,t,s);if(T&&null!==x)for(let e=0;e<x.textures.length;e++){const t=x.textures[e].viewerTexture;void 0!==t&&(this.textureHolder.viewerTextures.push(t),null!==this.textureHolder.onnewtextures&&this.textureHolder.onnewtextures())}return x}getTextureFile(e,t){let s=e;if(!t){const t=this.textableBin.getUint16(2*e);if(!(e<3e3||0===t))return s=t+1,{texNum:s,file:this.texpre};s=t}const n=this.modelVersion===a.o.dup||this.modelVersion===a.o.Demo||this.modelVersion===a.o.Early1&&this.preferCOSModelIDs.has(this.currentModelID),i=()=>{const e=this.subdirTextureFiles["Copy of swaphol"],n=t?null==e?void 0:e.tex1:null==e?void 0:e.tex0;return n&&n.hasTexture(s)?n:null};if(n){const e=i();if(e)return{texNum:s,file:e}}for(const e in this.subdirTextureFiles){if("Copy of swaphol"===e)continue;const n=this.subdirTextureFiles[e],i=t?n.tex1:n.tex0;if(i&&i.hasTexture(s))return{texNum:s,file:i}}if(!n){const e=i();if(e)return{texNum:s,file:e}}return{texNum:s,file:null}}destroy(e){var t;null===(t=this.texpre)||void 0===t||t.destroy(e);for(let t in this.subdirTextureFiles)this.subdirTextureFiles[t].destroy(e);this.subdirTextureFiles={},this.fakes.destroy(e)}}},2007(e,t,s){"use strict";s.d(t,{Ac:()=>g,Bh:()=>c,CV:()=>b,D2:()=>S,Gr:()=>E,IB:()=>h,Ir:()=>x,M3:()=>d,Mb:()=>l,Tk:()=>R,Wg:()=>_,X_:()=>w,Y:()=>o,YV:()=>A,YY:()=>v,_t:()=>y,ix:()=>T,nF:()=>C,so:()=>u,vT:()=>m,vi:()=>p,wX:()=>f});var n=s(305),i=s(7684),r=s(329),a=s(5339);function o(e,t,s,n=0,i=(null!=s?s:0)){return new DataView(e.buffer,e.byteOffset+t+n*i,s)}function l(e,t=0,s){const i=e.byteOffset+t,r=new n.A(e.buffer,i,s).copyToBuffer();return new DataView(r)}function h(e,t){const s=32-t;return e<<s>>s}function c(e){return h(e,16)}function u(e){return c(e)*Math.PI/32768}function d(e){return c(32768*e/Math.PI&65535)}function m(e){return Math.atan2(e[1],Math.hypot(e[2],e[0]))}function p(e,t,s,n,i,r){e[t+0]=s,e[t+4]=n,e[t+8]=i,e[t+12]=r}function f(e,t,s,n,r,a,o,l,h,c,u,d,m,p,f,g,T){return i.hZ(e,t,a,c,p,s,o,u,f,n,l,d,g,r,h,m,T)}function g(e,t,s,n,r,a,o,l,h,c,u,d,m,p,g,T){return f(i.vt(),e,t,s,n,r,a,o,l,h,c,u,d,m,p,g,T)}function T(e,t,s,n){e[4*s+t]=n}function x(e,t,s,n){T(e,0,3,t),T(e,1,3,s),T(e,2,3,n)}function v(e,t,s,n,i,r,a,o,l,h){const c=Math.sin(r),u=Math.cos(r),d=Math.sin(i),m=Math.cos(i),p=Math.sin(a),f=Math.cos(a);e[0]=t*(d*c*p+m*f),e[1]=t*(u*p),e[2]=t*(m*c*p-d*f),e[3]=0,e[4]=s*(d*c*f-m*p),e[5]=s*(u*f),e[6]=s*(m*c*f+d*p),e[7]=0,e[8]=n*(d*u),e[9]=n*-c,e[10]=n*(m*u),e[11]=0,e[12]=o,e[13]=l,e[14]=h,e[15]=1}function C(e,t){e[12]+=t[0],e[13]+=t[1],e[14]+=t[2]}function b(e,t,s,n=2){return e.getUint16(t+s*n)}function _(e,t,s,n=4){return e.getUint32(t+s*n)}function y(e,t=0){return r.fA(e.getFloat32(t+0),e.getFloat32(t+4),e.getFloat32(t+8))}class S{constructor(e,t=0){this.dv=e,this.baseOffs=t,this.offs=t,this.num=0,this.buf=0}peek(e){if(e>24)throw Error("Cannot read more than 24 bits");for(;this.num<e;)this.buf|=this.dv.getUint8(this.offs)<<24-this.num,this.offs++,this.num+=8;return this.buf>>>32-e&(1<<e)-1}drop(e){this.peek(e),this.buf<<=e,this.num-=e}get(e){const t=this.peek(e);return this.drop(e),t}}class w{peekBit(){throw new Error("Method not implemented.")}offset(e,t,s,n){throw new Error("Method not implemented.")}readByte(){throw new Error("Method not implemented.")}constructor(e,t=0){this.dv=e,this.baseOffs=t,this.offs=t,this.num=0,this.buf=0}peek(e){if(e>32)throw Error("Cannot read more than 32 bits");for(;this.num<e;)this.buf|=this.dv.getUint8(this.offs)<<this.num,this.offs++,this.num+=8;return this.buf&(1<<e)-1}drop(e){this.peek(e),this.buf>>>=e,this.num-=e}get(e){const t=this.peek(e);return this.drop(e),t}seekBit(e){this.offs=this.baseOffs+(e>>>3),this.num=0,this.buf=0,this.drop(7&e)}}function A(e,t){(0,a.Xv)(e,t.worldMatrix)}function E(e,t,s){s<-128?s=-128:s>127&&(s=127),e.setInt8(t,s)}function R(e,t,s,n){s<-32768?s=-32768:s>32767&&(s=32767),e.setInt16(t,s,n)}},6004(e,t,s){"use strict";s.d(t,{BZ:()=>Kt,rM:()=>Yt,JT:()=>ss});var n=s(8880),i=s(7165),r=s(353),a=s(7459),o=s(7639),l=s(5339),h=s(329),c=s(7823);function u(){var e=new c.tb(2);return c.tb!=Float32Array&&(e[0]=0,e[1]=0),e}u();var d=s(7684),m=s(5098);const p=s(4796).vt();function f(e,t,s,n,i){return function(e,t,s,n,i){e[0]=2*t+-2*s+1*n+1*i,e[1]=-3*t+3*s+-2*n+-1*i,e[2]=0*t+0*s+1*n+0*i,e[3]=1*t+0*s+0*n+0*i}(p,e,t,s,n),function(e,t){return((e[0]*t+e[1])*t+e[2])*t+e[3]}(p,i)}var g,T,x,v,C,b,_,y,S,w,A,E,R,I,k,M,P,D=Object.defineProperty,B=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable,F=Math.pow,U=(e,t,s)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,N=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},X=(e,t,s)=>(N(e,t,"read from private field"),s?s.call(e):t.get(e)),V=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},G=(e,t,s,n)=>(N(e,t,"write to private field"),n?n.call(e,s):t.set(e,s),s),K=(e,t,s)=>(N(e,t,"access private method"),s),$=class{constructor(e){this.value=e}},W=class{constructor(e){this.value=e}},H=e=>e<256?1:e<65536?2:e<1<<24?3:e<F(2,32)?4:e<F(2,40)?5:6,Y=(e,t,s)=>{let n=0;for(let i=t;i<s;i++){let t=7-(7&i);n<<=1,n|=(e[Math.floor(i/8)]&1<<t)>>t}return n},Z=class{constructor(){this.buffer=null}},z=class{constructor(e,t,s){this.onData=e,this.onDone=t,this.options=s}},j=class{constructor(e,t){this.stream=e,this.options=t}},q=class{constructor(){V(this,x),V(this,C),V(this,_),V(this,S),V(this,A),this.pos=0,V(this,g,new Uint8Array(8)),V(this,T,new DataView(X(this,g).buffer)),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}seek(e){this.pos=e}writeEBMLVarInt(e,t=(e=>{if(e<127)return 1;if(e<16383)return 2;if(e<2097151)return 3;if(e<268435455)return 4;if(e<F(2,35)-1)return 5;if(e<F(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+e)})(e)){let s=0;switch(t){case 1:X(this,T).setUint8(s++,128|e);break;case 2:X(this,T).setUint8(s++,64|e>>8),X(this,T).setUint8(s++,e);break;case 3:X(this,T).setUint8(s++,32|e>>16),X(this,T).setUint8(s++,e>>8),X(this,T).setUint8(s++,e);break;case 4:X(this,T).setUint8(s++,16|e>>24),X(this,T).setUint8(s++,e>>16),X(this,T).setUint8(s++,e>>8),X(this,T).setUint8(s++,e);break;case 5:X(this,T).setUint8(s++,8|e/F(2,32)&7),X(this,T).setUint8(s++,e>>24),X(this,T).setUint8(s++,e>>16),X(this,T).setUint8(s++,e>>8),X(this,T).setUint8(s++,e);break;case 6:X(this,T).setUint8(s++,4|e/F(2,40)&3),X(this,T).setUint8(s++,e/F(2,32)|0),X(this,T).setUint8(s++,e>>24),X(this,T).setUint8(s++,e>>16),X(this,T).setUint8(s++,e>>8),X(this,T).setUint8(s++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(X(this,g).subarray(0,s))}writeEBML(e){var t,s;if(null!==e)if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.pos),K(this,S,w).call(this,e.id),Array.isArray(e.data)){let s=this.pos,n=-1===e.size?1:null!=(t=e.size)?t:4;-1===e.size?K(this,x,v).call(this,255):this.seek(this.pos+n);let i=this.pos;if(this.dataOffsets.set(e,i),this.writeEBML(e.data),-1!==e.size){let e=this.pos-i,t=this.pos;this.seek(s),this.writeEBMLVarInt(e,n),this.seek(t)}}else if("number"==typeof e.data){let t=null!=(s=e.size)?s:H(e.data);this.writeEBMLVarInt(t),K(this,S,w).call(this,e.data,t)}else"string"==typeof e.data?(this.writeEBMLVarInt(e.data.length),K(this,A,E).call(this,e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof $?(this.writeEBMLVarInt(4),K(this,C,b).call(this,e.data.value)):e.data instanceof W&&(this.writeEBMLVarInt(8),K(this,_,y).call(this,e.data.value))}};g=new WeakMap,T=new WeakMap,x=new WeakSet,v=function(e){X(this,T).setUint8(0,e),this.write(X(this,g).subarray(0,1))},C=new WeakSet,b=function(e){X(this,T).setFloat32(0,e,!1),this.write(X(this,g).subarray(0,4))},_=new WeakSet,y=function(e){X(this,T).setFloat64(0,e,!1),this.write(X(this,g))},S=new WeakSet,w=function(e,t=H(e)){let s=0;switch(t){case 6:X(this,T).setUint8(s++,e/F(2,40)|0);case 5:X(this,T).setUint8(s++,e/F(2,32)|0);case 4:X(this,T).setUint8(s++,e>>24);case 3:X(this,T).setUint8(s++,e>>16);case 2:X(this,T).setUint8(s++,e>>8);case 1:X(this,T).setUint8(s++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(X(this,g).subarray(0,s))},A=new WeakSet,E=function(e){this.write(new Uint8Array(e.split("").map(e=>e.charCodeAt(0))))};var Q,J,ee,te,se=class extends q{constructor(e){super(),V(this,M),V(this,R,void 0),V(this,I,new ArrayBuffer(F(2,16))),V(this,k,new Uint8Array(X(this,I))),G(this,R,e)}write(e){K(this,M,P).call(this,this.pos+e.byteLength),X(this,k).set(e,this.pos),this.pos+=e.byteLength}finalize(){K(this,M,P).call(this,this.pos),X(this,R).buffer=X(this,I).slice(0,this.pos)}};R=new WeakMap,I=new WeakMap,k=new WeakMap,M=new WeakSet,P=function(e){let t=X(this,I).byteLength;for(;t<e;)t*=2;if(t===X(this,I).byteLength)return;let s=new ArrayBuffer(t),n=new Uint8Array(s);n.set(X(this,k),0),G(this,I,s),G(this,k,n)};var ne=class extends q{constructor(e,t){super(),V(this,Q,void 0),V(this,J,[]),V(this,ee,0),V(this,te,void 0),G(this,Q,e),G(this,te,t)}write(e){X(this,J).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(0===X(this,J).length)return;let e=[],t=[...X(this,J)].sort((e,t)=>e.start-t.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let s=1;s<t.length;s++){let n=e[e.length-1],i=t[s];i.start<=n.start+n.size?n.size=Math.max(n.size,i.start+i.data.byteLength-n.start):e.push({start:i.start,size:i.data.byteLength})}for(let t of e){t.data=new Uint8Array(t.size);for(let e of X(this,J))t.start<=e.start&&e.start<t.start+t.size&&t.data.set(e.data,e.start-t.start);if(X(this,te)&&t.start<X(this,ee))throw new Error("Internal error: Monotonicity violation.");X(this,Q).onData(t.data,t.start),G(this,ee,t.start+t.data.byteLength)}X(this,J).length=0}finalize(){var e,t;null==(t=(e=X(this,Q)).onDone)||t.call(e)}};Q=new WeakMap,J=new WeakMap,ee=new WeakMap,te=new WeakMap;var ie,re,ae,oe,le,he,ce,ue,de,me,pe,fe,ge,Te=F(2,24),xe=class extends q{constructor(e,t){var s,n;if(super(),V(this,he),V(this,ue),V(this,me),V(this,fe),V(this,ie,void 0),V(this,re,void 0),V(this,ae,[]),V(this,oe,0),V(this,le,void 0),G(this,ie,e),G(this,re,null!=(n=null==(s=e.options)?void 0:s.chunkSize)?n:Te),G(this,le,t),!Number.isInteger(X(this,re))||X(this,re)<F(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){K(this,he,ce).call(this,e,this.pos),K(this,fe,ge).call(this),this.pos+=e.byteLength}finalize(){var e,t;K(this,fe,ge).call(this,!0),null==(t=(e=X(this,ie)).onDone)||t.call(e)}};ie=new WeakMap,re=new WeakMap,ae=new WeakMap,oe=new WeakMap,le=new WeakMap,he=new WeakSet,ce=function(e,t){let s=X(this,ae).findIndex(e=>e.start<=t&&t<e.start+X(this,re));-1===s&&(s=K(this,me,pe).call(this,t));let n=X(this,ae)[s],i=t-n.start,r=e.subarray(0,Math.min(X(this,re)-i,e.byteLength));n.data.set(r,i);let a={start:i,end:i+r.byteLength};if(K(this,ue,de).call(this,n,a),0===n.written[0].start&&n.written[0].end===X(this,re)&&(n.shouldFlush=!0),X(this,ae).length>2){for(let e=0;e<X(this,ae).length-1;e++)X(this,ae)[e].shouldFlush=!0;K(this,fe,ge).call(this)}r.byteLength<e.byteLength&&K(this,he,ce).call(this,e.subarray(r.byteLength),t+r.byteLength)},ue=new WeakSet,de=function(e,t){let s=0,n=e.written.length-1,i=-1;for(;s<=n;){let r=Math.floor(s+(n-s+1)/2);e.written[r].start<=t.start?(s=r+1,i=r):n=r-1}for(e.written.splice(i+1,0,t),(-1===i||e.written[i].end<t.start)&&i++;i<e.written.length-1&&e.written[i].end>=e.written[i+1].start;)e.written[i].end=Math.max(e.written[i].end,e.written[i+1].end),e.written.splice(i+1,1)},me=new WeakSet,pe=function(e){let t={start:Math.floor(e/X(this,re))*X(this,re),data:new Uint8Array(X(this,re)),written:[],shouldFlush:!1};return X(this,ae).push(t),X(this,ae).sort((e,t)=>e.start-t.start),X(this,ae).indexOf(t)},fe=new WeakSet,ge=function(e=!1){for(let t=0;t<X(this,ae).length;t++){let s=X(this,ae)[t];if(s.shouldFlush||e){for(let e of s.written){if(X(this,le)&&s.start+e.start<X(this,oe))throw new Error("Internal error: Monotonicity violation.");X(this,ie).onData(s.data.subarray(e.start,e.end),s.start+e.start),G(this,oe,s.start+e.end)}X(this,ae).splice(t--,1)}}};var ve,Ce,be,_e,ye,Se,we,Ae,Ee,Re,Ie,ke,Me,Pe,De,Be,Le,Oe,Fe,Ue,Ne,Xe,Ve,Ge,Ke,$e,We,He,Ye,Ze,ze,je,qe,Qe,Je,et,tt,st,nt,it,rt,at,ot,lt,ht,ct,ut,dt,mt,pt,ft,gt,Tt,xt,vt,Ct,bt,_t,yt,St,wt,At,Et,Rt,It,kt,Mt,Pt,Dt,Bt,Lt,Ot=class extends xe{constructor(e,t){var s;super(new z((t,s)=>e.stream.write({type:"write",data:t,position:s}),void 0,{chunkSize:null==(s=e.options)?void 0:s.chunkSize}),t)}},Ft=F(2,15),Ut=F(2,12),Nt="https://github.com/Vanilagy/webm-muxer",Xt=["strict","offset","permissive"],Vt=class{constructor(e){var t;V(this,$e),V(this,He),V(this,Ze),V(this,je),V(this,Qe),V(this,et),V(this,st),V(this,it),V(this,at),V(this,lt),V(this,ct),V(this,dt),V(this,pt),V(this,gt),V(this,xt),V(this,Ct),V(this,_t),V(this,St),V(this,At),V(this,Rt),V(this,kt),V(this,Pt),V(this,Bt),V(this,ve,void 0),V(this,Ce,void 0),V(this,be,void 0),V(this,_e,void 0),V(this,ye,void 0),V(this,Se,void 0),V(this,we,void 0),V(this,Ae,void 0),V(this,Ee,void 0),V(this,Re,void 0),V(this,Ie,void 0),V(this,ke,void 0),V(this,Me,void 0),V(this,Pe,void 0),V(this,De,0),V(this,Be,[]),V(this,Le,[]),V(this,Oe,[]),V(this,Fe,void 0),V(this,Ue,void 0),V(this,Ne,-1),V(this,Xe,-1),V(this,Ve,-1),V(this,Ge,void 0),V(this,Ke,!1),K(this,$e,We).call(this,e),G(this,ve,((e,t)=>{for(var s in t||={})L.call(t,s)&&U(e,s,t[s]);if(B)for(var s of B(t))O.call(t,s)&&U(e,s,t[s]);return e})({type:"webm",firstTimestampBehavior:"strict"},e)),this.target=e.target;let s=!!X(this,ve).streaming;if(e.target instanceof Z)G(this,Ce,new se(e.target));else if(e.target instanceof z)G(this,Ce,(null==(t=e.target.options)?void 0:t.chunked)?new xe(e.target,s):new ne(e.target,s));else{if(!(e.target instanceof j))throw new Error(`Invalid target: ${e.target}`);G(this,Ce,new Ot(e.target,s))}K(this,He,Ye).call(this)}addVideoChunk(e,t,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,null!=s?s:e.timestamp,t)}addVideoChunkRaw(e,t,s,n){if(K(this,Bt,Lt).call(this),!X(this,ve).video)throw new Error("No video track declared.");void 0===X(this,Fe)&&G(this,Fe,s),n&&K(this,pt,ft).call(this,n);let i=K(this,Ct,bt).call(this,e,t,s,1);for("V_VP9"===X(this,ve).video.codec&&K(this,gt,Tt).call(this,i),G(this,Ne,i.timestamp);X(this,Le).length>0&&X(this,Le)[0].timestamp<=i.timestamp;){let e=X(this,Le).shift();K(this,St,wt).call(this,e,!1)}!X(this,ve).audio||i.timestamp<=X(this,Xe)?K(this,St,wt).call(this,i,!0):X(this,Be).push(i),K(this,xt,vt).call(this),K(this,ct,ut).call(this)}addAudioChunk(e,t,s){let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addAudioChunkRaw(n,e.type,null!=s?s:e.timestamp,t)}addAudioChunkRaw(e,t,s,n){if(K(this,Bt,Lt).call(this),!X(this,ve).audio)throw new Error("No audio track declared.");void 0===X(this,Ue)&&G(this,Ue,s),(null==n?void 0:n.decoderConfig)&&(X(this,ve).streaming?G(this,Re,K(this,At,Et).call(this,n.decoderConfig.description)):K(this,Rt,It).call(this,X(this,Re),n.decoderConfig.description));let i=K(this,Ct,bt).call(this,e,t,s,2);for(G(this,Xe,i.timestamp);X(this,Be).length>0&&X(this,Be)[0].timestamp<=i.timestamp;){let e=X(this,Be).shift();K(this,St,wt).call(this,e,!0)}!X(this,ve).video||i.timestamp<=X(this,Ne)?K(this,St,wt).call(this,i,!X(this,ve).video):X(this,Le).push(i),K(this,xt,vt).call(this),K(this,ct,ut).call(this)}addSubtitleChunk(e,t,s){if(K(this,Bt,Lt).call(this),!X(this,ve).subtitles)throw new Error("No subtitle track declared.");(null==t?void 0:t.decoderConfig)&&(X(this,ve).streaming?G(this,Ie,K(this,At,Et).call(this,t.decoderConfig.description)):K(this,Rt,It).call(this,X(this,Ie),t.decoderConfig.description));let n=K(this,Ct,bt).call(this,e.body,"key",null!=s?s:e.timestamp,3,e.duration,e.additions);G(this,Ve,n.timestamp),X(this,Oe).push(n),K(this,xt,vt).call(this),K(this,ct,ut).call(this)}finalize(){for(;X(this,Be).length>0;)K(this,St,wt).call(this,X(this,Be).shift(),!0);for(;X(this,Le).length>0;)K(this,St,wt).call(this,X(this,Le).shift(),!0);for(;X(this,Oe).length>0&&X(this,Oe)[0].timestamp<=X(this,De);)K(this,St,wt).call(this,X(this,Oe).shift(),!1);if(X(this,ve).streaming||K(this,Pt,Dt).call(this),X(this,Ce).writeEBML(X(this,ke)),!X(this,ve).streaming){let e=X(this,Ce).pos,t=X(this,Ce).pos-X(this,dt,mt);X(this,Ce).seek(X(this,Ce).offsets.get(X(this,be))+4),X(this,Ce).writeEBMLVarInt(t,6),X(this,we).data=new W(X(this,De)),X(this,Ce).seek(X(this,Ce).offsets.get(X(this,we))),X(this,Ce).writeEBML(X(this,we)),X(this,ye).data[0].data[1].data=X(this,Ce).offsets.get(X(this,ke))-X(this,dt,mt),X(this,ye).data[1].data[1].data=X(this,Ce).offsets.get(X(this,_e))-X(this,dt,mt),X(this,ye).data[2].data[1].data=X(this,Ce).offsets.get(X(this,Se))-X(this,dt,mt),X(this,Ce).seek(X(this,Ce).offsets.get(X(this,ye))),X(this,Ce).writeEBML(X(this,ye)),X(this,Ce).seek(e)}K(this,ct,ut).call(this),X(this,Ce).finalize(),G(this,Ke,!0)}};ve=new WeakMap,Ce=new WeakMap,be=new WeakMap,_e=new WeakMap,ye=new WeakMap,Se=new WeakMap,we=new WeakMap,Ae=new WeakMap,Ee=new WeakMap,Re=new WeakMap,Ie=new WeakMap,ke=new WeakMap,Me=new WeakMap,Pe=new WeakMap,De=new WeakMap,Be=new WeakMap,Le=new WeakMap,Oe=new WeakMap,Fe=new WeakMap,Ue=new WeakMap,Ne=new WeakMap,Xe=new WeakMap,Ve=new WeakMap,Ge=new WeakMap,Ke=new WeakMap,$e=new WeakSet,We=function(e){if(e.type&&"webm"!==e.type&&"matroska"!==e.type)throw new Error(`Invalid type: ${e.type}`);if(e.firstTimestampBehavior&&!Xt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},He=new WeakSet,Ye=function(){K(this,Ze,ze).call(this),X(this,ve).streaming||K(this,et,tt).call(this),K(this,st,nt).call(this),K(this,je,qe).call(this),K(this,Qe,Je).call(this),X(this,ve).streaming||(K(this,it,rt).call(this),K(this,at,ot).call(this)),K(this,lt,ht).call(this),K(this,ct,ut).call(this)},Ze=new WeakSet,ze=function(){var e;let t={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:null!=(e=X(this,ve).type)?e:"webm"},{id:17031,data:2},{id:17029,data:2}]};X(this,Ce).writeEBML(t)},je=new WeakSet,qe=function(){G(this,Ee,{id:236,size:4,data:new Uint8Array(Ut)}),G(this,Re,{id:236,size:4,data:new Uint8Array(Ut)}),G(this,Ie,{id:236,size:4,data:new Uint8Array(Ut)})},Qe=new WeakSet,Je=function(){G(this,Ae,{id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]})},et=new WeakSet,tt=function(){const e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]);G(this,ye,{id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]})},st=new WeakSet,nt=function(){let e={id:17545,data:new W(0)};G(this,we,e);let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Nt},{id:22337,data:Nt},X(this,ve).streaming?null:e]};G(this,_e,t)},it=new WeakSet,rt=function(){let e={id:374648427,data:[]};G(this,Se,e),X(this,ve).video&&e.data.push({id:174,data:[{id:215,data:1},{id:29637,data:1},{id:131,data:1},{id:134,data:X(this,ve).video.codec},X(this,Ee),X(this,ve).video.frameRate?{id:2352003,data:1e9/X(this,ve).video.frameRate}:null,{id:224,data:[{id:176,data:X(this,ve).video.width},{id:186,data:X(this,ve).video.height},X(this,ve).video.alpha?{id:21440,data:1}:null,X(this,Ae)]}]}),X(this,ve).audio&&(G(this,Re,X(this,ve).streaming?X(this,Re)||null:{id:236,size:4,data:new Uint8Array(Ut)}),e.data.push({id:174,data:[{id:215,data:2},{id:29637,data:2},{id:131,data:2},{id:134,data:X(this,ve).audio.codec},X(this,Re),{id:225,data:[{id:181,data:new $(X(this,ve).audio.sampleRate)},{id:159,data:X(this,ve).audio.numberOfChannels},X(this,ve).audio.bitDepth?{id:25188,data:X(this,ve).audio.bitDepth}:null]}]})),X(this,ve).subtitles&&e.data.push({id:174,data:[{id:215,data:3},{id:29637,data:3},{id:131,data:17},{id:134,data:X(this,ve).subtitles.codec},X(this,Ie)]})},at=new WeakSet,ot=function(){let e={id:408125543,size:X(this,ve).streaming?-1:6,data:[X(this,ve).streaming?null:X(this,ye),X(this,_e),X(this,Se)]};G(this,be,e),X(this,Ce).writeEBML(e)},lt=new WeakSet,ht=function(){G(this,ke,{id:475249515,data:[]})},ct=new WeakSet,ut=function(){X(this,Ce)instanceof ne&&X(this,Ce).flush()},dt=new WeakSet,mt=function(){return X(this,Ce).dataOffsets.get(X(this,be))},pt=new WeakSet,ft=function(e){if(e.decoderConfig){if(e.decoderConfig.colorSpace){let t=e.decoderConfig.colorSpace;if(G(this,Ge,t),X(this,Ae).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[t.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[t.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[t.primaries]},{id:21945,data:[1,2][Number(t.fullRange)]}],!X(this,ve).streaming){let e=X(this,Ce).pos;X(this,Ce).seek(X(this,Ce).offsets.get(X(this,Ae))),X(this,Ce).writeEBML(X(this,Ae)),X(this,Ce).seek(e)}}e.decoderConfig.description&&(X(this,ve).streaming?G(this,Ee,K(this,At,Et).call(this,e.decoderConfig.description)):K(this,Rt,It).call(this,X(this,Ee),e.decoderConfig.description))}},gt=new WeakSet,Tt=function(e){if("key"!==e.type)return;if(!X(this,Ge))return;let t=0;if(2!==Y(e.data,0,2))return;t+=2;let s=(Y(e.data,t+1,t+2)<<1)+Y(e.data,t+0,t+1);t+=2,3===s&&t++;let n=Y(e.data,t+0,t+1);if(t++,n)return;let i=Y(e.data,t+0,t+1);if(t++,0!==i)return;t+=2;let r=Y(e.data,t+0,t+24);if(t+=24,4817730!==r)return;s>=2&&t++;let a={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[X(this,Ge).matrix];((e,t,s,n)=>{for(let i=t;i<s;i++){let t=Math.floor(i/8),r=e[t],a=7-(7&i);r&=~(1<<a),r|=(n&1<<s-i-1)>>s-i-1<<a,e[t]=r}})(e.data,t+0,t+3,a)},xt=new WeakSet,vt=function(){let e=Math.min(X(this,ve).video?X(this,Ne):1/0,X(this,ve).audio?X(this,Xe):1/0),t=X(this,Oe);for(;t.length>0&&t[0].timestamp<=e;)K(this,St,wt).call(this,t.shift(),!X(this,ve).video&&!X(this,ve).audio)},Ct=new WeakSet,bt=function(e,t,s,n,i,r){return{data:e,additions:r,type:t,timestamp:K(this,_t,yt).call(this,s,n),duration:i,trackNumber:n}},_t=new WeakSet,yt=function(e,t){let s=X(this,1===t?Ne:2===t?Xe:Ve);if(3!==t){let n=X(this,1===t?Fe:Ue);if("strict"===X(this,ve).firstTimestampBehavior&&-1===s&&0!==e)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\nIf you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.\n`);"offset"===X(this,ve).firstTimestampBehavior&&(e-=n)}if(e<s)throw new Error(`Timestamps must be monotonically increasing (went from ${s} to ${e}).`);if(e<0)throw new Error(`Timestamps must be non-negative (received ${e}).`);return e},St=new WeakSet,wt=function(e,t){X(this,ve).streaming&&!X(this,Se)&&(K(this,it,rt).call(this),K(this,at,ot).call(this));let s=Math.floor(e.timestamp/1e3),n=t&&"key"===e.type&&s-X(this,Pe)>=1e3;X(this,Me)&&!n||K(this,kt,Mt).call(this,s);let i=s-X(this,Pe);if(i<0)return;if(i>=Ft)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${Ft} milliseconds. In order to produce a correct WebM file, you must pass in a key frame at least every ${Ft} milliseconds.`);let r=new Uint8Array(4),a=new DataView(r.buffer);if(a.setUint8(0,128|e.trackNumber),a.setInt16(1,i,!1),void 0!==e.duration||e.additions){let t=Math.floor(e.duration/1e3),s={id:160,data:[{id:161,data:[r,e.data]},void 0!==e.duration?{id:155,data:t}:null,e.additions?{id:30113,data:e.additions}:null]};X(this,Ce).writeEBML(s)}else{a.setUint8(3,Number("key"===e.type)<<7);let t={id:163,data:[r,e.data]};X(this,Ce).writeEBML(t)}G(this,De,Math.max(X(this,De),s))},At=new WeakSet,Et=function(e){return{id:25506,size:4,data:new Uint8Array(e)}},Rt=new WeakSet,It=function(e,t){let s=X(this,Ce).pos;X(this,Ce).seek(X(this,Ce).offsets.get(e));let n=6+t.byteLength,i=Ut-n;if(i<0){let e=t.byteLength+i;t=t instanceof ArrayBuffer?t.slice(0,e):t.buffer.slice(0,e),i=0}e=[K(this,At,Et).call(this,t),{id:236,size:4,data:new Uint8Array(i)}],X(this,Ce).writeEBML(e),X(this,Ce).seek(s)},kt=new WeakSet,Mt=function(e){X(this,Me)&&!X(this,ve).streaming&&K(this,Pt,Dt).call(this),G(this,Me,{id:524531317,size:X(this,ve).streaming?-1:5,data:[{id:231,data:e}]}),X(this,Ce).writeEBML(X(this,Me)),G(this,Pe,e);let t=X(this,Ce).offsets.get(X(this,Me))-X(this,dt,mt);X(this,ke).data.push({id:187,data:[{id:179,data:e},X(this,ve).video?{id:183,data:[{id:247,data:1},{id:241,data:t}]}:null,X(this,ve).audio?{id:183,data:[{id:247,data:2},{id:241,data:t}]}:null]})},Pt=new WeakSet,Dt=function(){let e=X(this,Ce).pos-X(this,Ce).dataOffsets.get(X(this,Me)),t=X(this,Ce).pos;X(this,Ce).seek(X(this,Ce).offsets.get(X(this,Me))+4),X(this,Ce).writeEBMLVarInt(e,5),X(this,Ce).seek(t)},Bt=new WeakSet,Lt=function(){if(X(this,Ke))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};new TextEncoder,new WeakMap,new WeakMap,new WeakMap,new WeakMap,new WeakMap,new WeakSet,new WeakSet;var Gt=s(393);const Kt='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" height="20" fill="white"><path d="M61,22H14.51l3.41-.72h0l7.74-1.64,2-.43h0l6.85-1.46h0l1.17-.25,8.61-1.83h0l.78-.17,9-1.91h0l.4-.08L60,12.33a1,1,0,0,0,.77-1.19L59.3,4.3a1,1,0,0,0-1.19-.77l-19,4-1.56.33h0L28.91,9.74,27.79,10h0l-9.11,1.94-.67.14h0L3.34,15.17a1,1,0,0,0-.77,1.19L4,23.11V60a1,1,0,0,0,1,1H61a1,1,0,0,0,1-1V23A1,1,0,0,0,61,22ZM57,5.8l.65.6.89,4.19-1.45.31L52.6,6.75ZM47.27,7.88,51.8,12,47.36,13,42.82,8.83ZM37.48,10,42,14.11l-4.44.94L33,10.91ZM27.7,12l4.53,4.15-4.44.94L23.26,13Zm-9.78,2.08,4.53,4.15L18,19.21l-4.53-4.15ZM19.49,29H14.94l3.57-5h4.54Zm9-5h4.54l-3.57,5H24.94ZM39,45.88l-11,6A1,1,0,0,1,26.5,51V39A1,1,0,0,1,28,38.12l11,6a1,1,0,0,1,0,1.76ZM39.49,29H34.94l3.57-5h4.54Zm10,0H44.94l3.57-5h4.54ZM60,29H54.94l3.57-5H60Z"/></svg>',$t=1e3;var Wt;!function(e){e[e.Ease=0]="Ease",e[e.Linear=1]="Linear",e[e.Hold=2]="Hold"}(Wt||(Wt={}));const Ht=(e,t)=>e.time===t.time&&e.interpInType===t.interpInType&&e.interpOutType===t.interpOutType&&e.easeInCoeff===t.easeInCoeff&&e.easeOutCoeff===t.easeOutCoeff;class Yt{constructor(){this.pos=h.vt(),this.lookAtPos=h.vt(),this.bank=0}}var Zt,zt,jt;!function(e){e[e.Consolidated=0]="Consolidated",e[e.Position_LookAt_Bank=1]="Position_LookAt_Bank",e[e.Full=2]="Full"}(Zt||(Zt={})),function(e){e[e.posXTrack=1]="posXTrack",e[e.posYTrack=2]="posYTrack",e[e.posZTrack=4]="posZTrack",e[e.lookAtXTrack=8]="lookAtXTrack",e[e.lookAtYTrack=16]="lookAtYTrack",e[e.lookAtZTrack=32]="lookAtZTrack",e[e.bankTrack=64]="bankTrack",e[e.allTracks=127]="allTracks"}(zt||(zt={}));class qt{constructor(){this.keyframes=[]}addKeyframe(e){const t=this.getNextKeyframeIndexAtTime(e.time);-1===t?this.keyframes.push(e):this.keyframes[t].time===e.time?this.keyframes.splice(t,1,e):this.keyframes.splice(t,0,e)}getNextKeyframeIndexAtTime(e){let t=-1;for(let s=0;s<this.keyframes.length;s++)if(e<=this.keyframes[s].time){t=s;break}return t}setAllCatmullRomTangents(e){if(this.keyframes.length<3||e&&3===this.keyframes.length)for(const e of this.keyframes)e.tangentIn=0,e.tangentOut=0;else{if(e){const e=this.keyframes[1].time;this.keyframes[0].time+=this.keyframes[this.keyframes.length-1].time,this.keyframes[1].time+=this.keyframes[this.keyframes.length-1].time,this.setCatmullRomTangent(this.keyframes[this.keyframes.length-2],this.keyframes[0],this.keyframes[1]),this.setCatmullRomTangent(this.keyframes[this.keyframes.length-2],this.keyframes[this.keyframes.length-1],this.keyframes[1]),this.keyframes[0].time=0,this.keyframes[1].time=e}else this.setCatmullRomTangent(this.keyframes[0],this.keyframes[0],this.keyframes[1]),this.setCatmullRomTangent(this.keyframes[this.keyframes.length-2],this.keyframes[this.keyframes.length-1],this.keyframes[this.keyframes.length-1]),this.keyframes[this.keyframes.length-1].tangentOut=0,this.keyframes[0].tangentIn=0;for(let e=1;e<this.keyframes.length-1;e++)this.setCatmullRomTangent(this.keyframes[e-1],this.keyframes[e],this.keyframes[e+1])}}setCatmullRomTangent(e,t,s){const n=.5*(s.value-e.value),i=t.time-e.time,r=s.time-t.time;t.tangentIn=t.easeInCoeff*n*(2*i)/(i+r),t.tangentOut=t.easeOutCoeff*n*(2*r)/(i+r)}setValue(e,t){const s=this.keyframes.indexOf(e);s>-1&&(this.keyframes[s].value=t)}reSort(){this.keyframes.sort((e,t)=>e.time-t.time)}}!function(e){e[e.Default=0]="Default",e[e.Start=1]="Start",e[e.Loop_End=2]="Loop_End"}(jt||(jt={}));class Qt{constructor(){this.x=0,this.t=0,this.updatePath()}updatePath(){this.playheadPath=new Path2D,this.playheadPath.moveTo(this.x,Qt.HEIGHT+Qt.POINTER_HEIGHT),this.playheadPath.lineTo(this.x-Qt.HALF_WIDTH,Qt.HEIGHT),this.playheadPath.lineTo(this.x-Qt.HALF_WIDTH,0),this.playheadPath.lineTo(this.x+Qt.HALF_WIDTH,0),this.playheadPath.lineTo(this.x+Qt.HALF_WIDTH,Qt.HEIGHT),this.playheadPath.moveTo(this.x,Qt.HEIGHT+Qt.POINTER_HEIGHT)}draw(e){e.fillStyle=Qt.COLOR,e.fill(this.playheadPath)}drawLine(e){e.beginPath(),e.strokeStyle=Qt.COLOR,e.lineWidth=1.5,e.moveTo(this.x,Qt.HEIGHT+Qt.POINTER_HEIGHT-1),e.lineTo(this.x,e.canvas.height),e.stroke()}updatePosition(e,t){this.x=e,this.t=t,this.updatePath()}getX(){return this.x}getT(){return this.t}}Qt.WIDTH=15,Qt.HALF_WIDTH=Qt.WIDTH/2,Qt.HEIGHT=15,Qt.POINTER_HEIGHT=10,Qt.COLOR="#FF0000";class Jt{constructor(e,t,s,n,i){this.keyframesMap=e,this.x=t,this.y=s,this.t=n,this.type=i,this.displayPath=new Path2D,this.selectionPath=new Path2D,this.selected=!1,this.updatePaths()}draw(e){this.selected?e.fillStyle=Jt.SELECTED_COLOR:this.type===jt.Loop_End||this.type===jt.Start?e.fillStyle=Jt.ENDFRAME_COLOR:e.fillStyle=Jt.COLOR,e.fill(this.displayPath)}updatePosition(e,t){this.x=e,this.t=t,this.updatePaths(),this.keyframesMap.forEach(e=>{e.time=t})}getX(){return this.x}getY(){return this.y}getT(){return this.t}updatePaths(){this.displayPath=new Path2D,this.selectionPath=new Path2D;const e=this.keyframesMap.values().next().value,t=e.interpInType,s=e.interpOutType;t===Wt.Ease?(this.displayPath.moveTo(this.x,this.y),this.displayPath.lineTo(this.x-Jt.XY_DIST,this.y+Jt.XY_DIST),this.displayPath.lineTo(this.x,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x,this.y)):t===Wt.Hold?(this.displayPath.moveTo(this.x-2,this.y),this.displayPath.lineTo(this.x-6,this.y),this.displayPath.lineTo(this.x-6,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x-2,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x-2,this.y)):t===Wt.Linear&&(this.displayPath.moveTo(this.x,this.y+Jt.MIDLINE_Y),this.displayPath.lineTo(this.x-Jt.XY_DIST,this.y+Jt.MIDLINE_Y),this.displayPath.lineTo(this.x-Jt.XY_DIST,this.y+Jt.MIDLINE_Y+Jt.MIDLINE_HEIGHT),this.displayPath.lineTo(this.x,this.y+Jt.MIDLINE_Y+Jt.MIDLINE_HEIGHT),this.displayPath.lineTo(this.x,this.y+3)),s===Wt.Ease?(this.displayPath.moveTo(this.x,this.y),this.displayPath.lineTo(this.x,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x+Jt.XY_DIST,this.y+Jt.XY_DIST),this.displayPath.lineTo(this.x,this.y)):s===Wt.Hold?(this.displayPath.moveTo(this.x+2,this.y),this.displayPath.lineTo(this.x+6,this.y),this.displayPath.lineTo(this.x+6,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x+2,this.y+Jt.HEIGHT),this.displayPath.lineTo(this.x+2,this.y)):s===Wt.Linear&&(this.displayPath.moveTo(this.x,this.y+Jt.MIDLINE_Y),this.displayPath.lineTo(this.x+Jt.XY_DIST,this.y+Jt.MIDLINE_Y),this.displayPath.lineTo(this.x+Jt.XY_DIST,this.y+Jt.MIDLINE_Y+Jt.MIDLINE_HEIGHT),this.displayPath.lineTo(this.x,this.y+Jt.MIDLINE_Y+Jt.MIDLINE_HEIGHT),this.displayPath.lineTo(this.x,this.y+3)),this.selectionPath.moveTo(this.x-Jt.XY_DIST,this.y),this.selectionPath.lineTo(this.x-Jt.XY_DIST,this.y+Jt.HEIGHT),this.selectionPath.lineTo(this.x+Jt.XY_DIST,this.y+Jt.HEIGHT),this.selectionPath.lineTo(this.x+Jt.XY_DIST,this.y),this.selectionPath.lineTo(this.x-Jt.XY_DIST,this.y)}}Jt.SIDE_LENGTH=10,Jt.HEIGHT=Math.sqrt(Jt.SIDE_LENGTH*Jt.SIDE_LENGTH*2),Jt.MIDLINE_HEIGHT=Jt.HEIGHT/3,Jt.MIDLINE_Y=Jt.HEIGHT/2-Jt.MIDLINE_HEIGHT/2,Jt.XY_DIST=Math.sqrt(Jt.SIDE_LENGTH*Jt.SIDE_LENGTH/2),Jt.COLOR="#FFFFFF",Jt.SELECTED_COLOR="#FF500B",Jt.ENDFRAME_COLOR="#4EB0FF";class es{constructor(e,t,s){this.markersCtx=e,this.elementsCtx=t,this.timelineScaleFactor=1,this.selectionBoxPath=new Path2D,this.selectionBoxIcons=[],this.disabledTrackOverlayPaths=[],this.grabbedIcon=void 0,this.grabbedIconInitialXPos=-1,this.selectionBoxStartVertex=u(),this.selectionBoxEndVertex=u(),this.selectionBoxActive=!1,this.keyframeIcons=[],this.selectedKeyframeIcons=[],this.playheadGrabbed=!1,this.snappingEnabled=!1,this.playhead=new Qt,this.elementsCtx.restore(),this.markersCtx.restore(),this.elementsCtx.save(),this.markersCtx.save(),this.setupContexts(),this.setScaleAndDrawMarkers(s)}setupContexts(){this.elementsCtx.translate(Qt.HALF_WIDTH,0),this.markersCtx.translate(Qt.HALF_WIDTH,0),this.markersCtx.strokeStyle=es.MARKER_COLOR,this.markersCtx.fillStyle=es.MARKER_COLOR}setScaleAndDrawMarkers(e){this.width=this.elementsCtx.canvas.width,this.height=this.elementsCtx.canvas.height,e&&(this.lengthMs=e),this.timelineHeaderPath=new Path2D,this.timelineHeaderPath.lineTo(this.width,0),this.timelineHeaderPath.lineTo(this.width,es.HEADER_HEIGHT),this.timelineHeaderPath.lineTo(0,es.HEADER_HEIGHT),this.timelineHeaderPath.lineTo(0,0),this.markersCtx.clearRect(-Qt.HALF_WIDTH,0,this.width,es.HEADER_HEIGHT);let t=es.DEFAULT_SECONDS_PER_MARKER,s=this.lengthMs/$t/t;this.pixelsPerSecond=(this.width-Qt.WIDTH)/s/t,this.width/s<es.MIN_MARKER_WIDTH_PX?(s=this.width/es.MIN_MARKER_WIDTH_PX,t=this.lengthMs/$t/s,this.timelineScaleFactor=t/es.DEFAULT_SECONDS_PER_MARKER,this.pixelsPerSecond*=this.timelineScaleFactor):this.timelineScaleFactor=1;const n=5*s+1;this.markersCtx.beginPath();let i=0,r=null;const a=es.HEADER_HEIGHT/1.5,o=es.HEADER_HEIGHT/2,l=o-3;for(let e=0;e<n&&(i=Math.trunc(e*this.pixelsPerSecond),!(i>this.width-Qt.WIDTH));e++)if(this.markersCtx.moveTo(i,es.HEADER_HEIGHT),e%5==0){this.markersCtx.lineTo(i,o);const s=Math.trunc(e/5*t).toString();r=this.markersCtx.measureText(s),this.markersCtx.fillText(s,i-r.width/2,l)}else this.markersCtx.lineTo(i,a);this.markersCtx.stroke();for(const e of this.keyframeIcons){const t=e.keyframesMap.values().next().value.time;e.updatePosition(t/$t*(this.pixelsPerSecond/this.timelineScaleFactor),t)}this.markersCtx.save()}setTimelineMode(e,t){e===Zt.Consolidated?this.elementsCtx.canvas.height=es.HEADER_HEIGHT+es.TRACK_HEIGHT:e===Zt.Position_LookAt_Bank?this.elementsCtx.canvas.height=es.HEADER_HEIGHT+3*es.TRACK_HEIGHT:e===Zt.Full&&(this.elementsCtx.canvas.height=es.HEADER_HEIGHT+7*es.TRACK_HEIGHT),this.setScaleAndDrawMarkers(),this.updateTrackSelection(e,t),this.draw()}getTimelineLengthMs(){return this.lengthMs}getTimelineLengthSeconds(){return(this.lengthMs/$t).toFixed(2)}draw(){this.elementsCtx.restore(),this.elementsCtx.clearRect(-Qt.WIDTH,0,this.width+Qt.WIDTH,this.height),this.playhead.draw(this.elementsCtx);for(const e of this.keyframeIcons)e.draw(this.elementsCtx);this.selectionBoxActive&&(this.elementsCtx.fillStyle=es.SELECTION_BOX_FILL_COLOR,this.elementsCtx.strokeStyle=es.SELECTION_BOX_STROKE_COLOR,this.elementsCtx.beginPath(),this.elementsCtx.fill(this.selectionBoxPath),this.elementsCtx.stroke(this.selectionBoxPath)),this.playhead.drawLine(this.elementsCtx),this.elementsCtx.fillStyle=es.DISABLED_TRACK_OVERLAY_COLOR,this.elementsCtx.strokeStyle=es.DISABLED_TRACK_LINES_COLOR;for(let e=0;e<this.disabledTrackOverlayPaths.length;e++)this.elementsCtx.beginPath(),this.elementsCtx.fill(this.disabledTrackOverlayPaths[e]),this.elementsCtx.stroke(this.disabledTrackOverlayPaths[e]);this.elementsCtx.save()}addKeyframeIcon(e,t,s,n){const i=t/$t*(this.pixelsPerSecond/this.timelineScaleFactor),r=new Jt(e,i,s,t,n);this.keyframeIcons.push(r),this.keyframeIcons.sort((e,t)=>e.getX()-t.getX())}deleteSelectedKeyframeIcons(){if(this.selectedKeyframeIcons.length){for(let e=0;e<this.selectedKeyframeIcons.length;e++){const t=this.keyframeIcons.indexOf(this.selectedKeyframeIcons[e]);-1!==t&&this.keyframeIcons[t].type===jt.Default&&this.keyframeIcons.splice(t,1)}this.deselectAllKeyframeIcons()}}deleteEndframeIcons(){for(;this.keyframeIcons[this.keyframeIcons.length-1].type===jt.Loop_End;)this.keyframeIcons.pop()}moveLoopEndframeIcons(e){let t=e/$t*this.pixelsPerSecond/this.timelineScaleFactor;for(const s of this.keyframeIcons)s.type===jt.Loop_End&&s.updatePosition(t,e)}onMouseDown(e){if(e.stopPropagation(),this.elementsCtx.isPointInPath(this.playhead.playheadPath,e.offsetX,e.offsetY)||this.elementsCtx.isPointInPath(this.timelineHeaderPath,e.offsetX,e.offsetY))return this.playheadGrabbed=!0,void this.onMouseMove(e);let t=!1;for(const s of this.selectedKeyframeIcons)if(s.type!==jt.Start&&this.elementsCtx.isPointInPath(s.selectionPath,e.offsetX,e.offsetY)){t=!0,e.ctrlKey?this.deselectKeyframeIcon(s):(this.grabbedIcon=s,this.grabbedIconInitialXPos=s.getX());break}if(!t){for(const t of this.keyframeIcons)if(this.elementsCtx.isPointInPath(t.selectionPath,e.offsetX,e.offsetY)){e.ctrlKey||this.deselectAllKeyframeIcons(),this.selectKeyframeIcon(t),this.grabbedIcon=t,this.grabbedIconInitialXPos=t.getX();break}this.grabbedIcon||(e.ctrlKey||this.deselectAllKeyframeIcons(),this.selectionBoxActive=!0,this.selectionBoxStartVertex[0]=e.offsetX-Qt.HALF_WIDTH,this.selectionBoxStartVertex[1]=e.offsetY,this.selectionBoxPath=new Path2D)}this.draw()}onMouseUp(){this.playheadGrabbed=!1,this.selectionBoxActive=!1,this.selectionBoxIcons=[],this.grabbedIcon=void 0,this.grabbedIconInitialXPos=-1,this.draw()}onMouseMove(e){if(!this.playheadGrabbed&&!this.grabbedIcon&&!this.selectionBoxActive||this.grabbedIcon&&this.selectedKeyframeIcons.some(e=>e.type===jt.Start))return;let t=e.offsetX;e.target!==this.elementsCtx.canvas&&(t=e.clientX-this.elementsCtx.canvas.getBoundingClientRect().x),t=(0,l.qE)(t,Qt.HALF_WIDTH,this.width-Qt.HALF_WIDTH),t-=Qt.HALF_WIDTH;const s=this.snappingEnabled;if(this.snappingEnabled=this.snappingEnabled||e.shiftKey,this.playheadGrabbed){const e=this.getClosestSnappingIconIndex(t);e>-1&&(this.snappingEnabled&&(t=this.keyframeIcons[e].getX()),t===this.keyframeIcons[e].getX()&&(this.deselectAllKeyframeIcons(),this.selectKeyframeIconsAtTime(this.keyframeIcons[e].getT())));const s=t/this.pixelsPerSecond*$t*this.timelineScaleFactor;this.playhead.updatePosition(t,s)}else if(this.grabbedIcon&&this.selectedKeyframeIcons.length){if(1===this.selectedKeyframeIcons.length){if(this.selectedKeyframeIcons[0].type===jt.Loop_End){let e=0;for(const t of this.keyframeIcons)t.type!==jt.Loop_End&&t.getX()>e&&(e=t.getX());t=(0,l.qE)(t,e+es.SNAP_DISTANCE_PX,this.width-Qt.HALF_WIDTH)}else this.keyframeIcons[this.keyframeIcons.length-1].type===jt.Loop_End&&(t=(0,l.qE)(t,this.keyframeIcons[0].getX()+es.SNAP_DISTANCE_PX,this.keyframeIcons[this.keyframeIcons.length-1].getX()-es.SNAP_DISTANCE_PX));this.snappingEnabled&&Math.abs(t-this.playhead.getX())<es.SNAP_DISTANCE_PX?this.updateKeyframeIconPosition(this.selectedKeyframeIcons[0],this.playhead.getX()):this.updateKeyframeIconPosition(this.selectedKeyframeIcons[0],t)}else if(this.snappingEnabled&&Math.abs(t-this.playhead.getX())<es.SNAP_DISTANCE_PX&&(t=this.playhead.getX()),this.canMoveGroupTo(t)){const e=this.grabbedIcon.getX();let s=!1;for(const n of this.selectedKeyframeIcons)n.type===jt.Loop_End&&s||(this.updateKeyframeIconPosition(n,t+(n.getX()-e)),n.type===jt.Loop_End&&(s=!0))}}else if(this.selectionBoxActive){this.selectionBoxEndVertex[0]=e.offsetX-Qt.HALF_WIDTH,this.selectionBoxEndVertex[1]=e.offsetY,e.target!==this.elementsCtx.canvas&&(this.selectionBoxEndVertex[0]=e.clientX-this.elementsCtx.canvas.getBoundingClientRect().x-Qt.HALF_WIDTH,this.selectionBoxEndVertex[1]=e.clientY-this.elementsCtx.canvas.getBoundingClientRect().y),this.selectionBoxPath=new Path2D,this.selectionBoxPath.moveTo(this.selectionBoxStartVertex[0],this.selectionBoxStartVertex[1]),this.selectionBoxPath.lineTo(this.selectionBoxEndVertex[0],this.selectionBoxStartVertex[1]),this.selectionBoxPath.lineTo(this.selectionBoxEndVertex[0],this.selectionBoxEndVertex[1]),this.selectionBoxPath.lineTo(this.selectionBoxStartVertex[0],this.selectionBoxEndVertex[1]),this.selectionBoxPath.closePath();for(const t of this.keyframeIcons){const s=this.elementsCtx.isPointInPath(this.selectionBoxPath,t.getX()+Jt.XY_DIST,t.getY()+Jt.XY_DIST)||this.elementsCtx.isPointInPath(this.selectionBoxPath,t.getX()+Jt.XY_DIST/2,t.getY()+Jt.XY_DIST/2)||this.elementsCtx.isPointInPath(this.selectionBoxPath,t.getX()+Jt.XY_DIST/2,t.getY()+3*Jt.XY_DIST/2)||this.elementsCtx.isPointInPath(this.selectionBoxPath,t.getX()+3*Jt.XY_DIST/2,t.getY()+Jt.XY_DIST/2)||this.elementsCtx.isPointInPath(this.selectionBoxPath,t.getX()+3*Jt.XY_DIST/2,t.getY()+3*Jt.XY_DIST/2);e.ctrlKey?s?this.selectionBoxIcons.includes(t)||(this.selectionBoxIcons.push(t),t.selected?this.deselectKeyframeIcon(t):this.selectKeyframeIcon(t)):this.selectionBoxIcons.includes(t)&&(this.selectionBoxIcons.splice(this.selectionBoxIcons.indexOf(t),1),t.selected?this.deselectKeyframeIcon(t):this.selectKeyframeIcon(t)):s?this.selectionBoxIcons.includes(t)||(this.selectionBoxIcons.push(t),this.selectKeyframeIcon(t)):this.selectionBoxIcons.includes(t)&&(this.selectionBoxIcons.splice(this.selectionBoxIcons.indexOf(t),1),this.deselectKeyframeIcon(t))}}this.snappingEnabled=s,this.draw()}canMoveGroupTo(e){const t=this.grabbedIcon.getX();for(const s of this.selectedKeyframeIcons){if(s.type===jt.Start)return!1;const n=e+(s.getX()-t);for(const e of this.keyframeIcons){if(s.type===jt.Loop_End&&!e.selected&&e.type!==jt.Loop_End&&n<e.getX()+es.SNAP_DISTANCE_PX)return!1;if(!e.selected&&e.getY()===s.getY()&&(n<es.SNAP_DISTANCE_PX||n>e.getX()-es.SNAP_DISTANCE_PX&&n<e.getX()+es.SNAP_DISTANCE_PX||e.type===jt.Loop_End&&n>e.getX()-es.SNAP_DISTANCE_PX||n>this.width-Qt.HALF_WIDTH))return!1}}return!0}hasGrabbedIconMoved(){return void 0!==this.grabbedIcon&&-1!==this.grabbedIconInitialXPos&&this.grabbedIconInitialXPos!==this.grabbedIcon.getX()}selectKeyframeIcon(e){this.selectedKeyframeIcons.includes(e)||(e.selected=!0,this.selectedKeyframeIcons.push(e),this.elementsCtx.canvas.dispatchEvent(new Event("keyframeSelected",{bubbles:!1})))}selectKeyframeIconsAtTime(e){for(const t of this.keyframeIcons)t.getT()!==e||this.selectedKeyframeIcons.includes(t)||(t.selected=!0,this.selectedKeyframeIcons.push(t));this.elementsCtx.canvas.dispatchEvent(new Event("keyframeSelected",{bubbles:!1}))}reselectKeyframes(e){this.selectedKeyframeIcons=[];for(const t of e)this.selectedKeyframeIcons.push(this.keyframeIcons[t]),this.keyframeIcons[t].selected=!0}deselectKeyframeIcon(e){const t=this.selectedKeyframeIcons.indexOf(e);if(-1!==t){if(this.selectedKeyframeIcons.splice(t,1),e.selected=!1,e.type===jt.Start||e.type===jt.Loop_End)for(const t of this.keyframeIcons)if(t.type===e.type){const e=this.selectedKeyframeIcons.indexOf(t);-1!==e&&(this.selectedKeyframeIcons.splice(e,1),t.selected=!1)}this.elementsCtx.canvas.dispatchEvent(new Event("keyframeDeselected",{bubbles:!1}))}}deselectAllKeyframeIcons(){let e=!1;for(const t of this.selectedKeyframeIcons)t.selected=!1,e=!0;this.selectedKeyframeIcons=[],e&&this.elementsCtx.canvas.dispatchEvent(new Event("keyframeDeselected",{bubbles:!1}))}getSelectedKeyframeIndices(){const e=[];for(let t=0;t<this.keyframeIcons.length;t++)this.keyframeIcons[t].selected&&e.push(t);return e}ensureIconDistance(e,t,s){return e<=es.SNAP_DISTANCE_PX?es.SNAP_DISTANCE_PX:e<t||t+s>this.width-Qt.WIDTH?Math.min(e,t-s):Math.max(e,t+s)}updateKeyframeIconPosition(e,t){let s=t/this.pixelsPerSecond*$t*this.timelineScaleFactor;const n=this.getClosestSnappingIconIndex(t,e);if(n>-1&&(e&&this.keyframeIcons[n].getY()===e.getY()?s=(t=this.ensureIconDistance(t,this.keyframeIcons[n].getX(),es.SNAP_DISTANCE_PX))/this.pixelsPerSecond*$t*this.timelineScaleFactor:this.snappingEnabled&&(t=this.keyframeIcons[n].getX(),s=this.keyframeIcons[n].getT())),e.type===jt.Loop_End)for(const e of this.keyframeIcons)e.type===jt.Loop_End&&e.updatePosition(t,s);else e.updatePosition(t,s);this.elementsCtx.canvas.dispatchEvent(new Event("keyframeIconMovedEvent",{bubbles:!1}))}getClosestSnappingIconIndex(e,t){let s=es.SNAP_DISTANCE_PX,n=-1;for(let i=0;i<this.keyframeIcons.length&&s>0;i++){if(t&&this.keyframeIcons[i].selected)continue;const r=Math.abs(e-this.keyframeIcons[i].getX());r<=s&&(t&&-1!==n&&t.getY()!==this.keyframeIcons[i].getY()||(n=i,s=r))}return n}setPlayheadTimeSeconds(e,t){const s=e*this.pixelsPerSecond/this.timelineScaleFactor;if(this.playhead.updatePosition(s,e*$t),t){const e=this.getClosestSnappingIconIndex(s);e>-1&&s===this.keyframeIcons[e].getX()&&(this.deselectAllKeyframeIcons(),this.selectKeyframeIconsAtTime(this.playhead.getT()))}this.draw()}jumpToNextKeyframe(){const e=this.playhead.getT();for(let t=1;t<this.keyframeIcons.length;t++)if(e<this.keyframeIcons[t].getT()){const e=this.keyframeIcons[t];this.deselectAllKeyframeIcons(),this.playhead.updatePosition(e.getX(),e.getT()),this.selectKeyframeIconsAtTime(e.getT());break}this.draw()}jumpToPreviousKeyframe(){const e=this.playhead.getT();for(let t=this.keyframeIcons.length-1;t>-1;t--)if(e>this.keyframeIcons[t].getT()){const e=this.keyframeIcons[t];this.deselectAllKeyframeIcons(),this.playhead.updatePosition(e.getX(),e.getT()),this.selectKeyframeIconsAtTime(e.getT());break}this.draw()}updateTrackSelection(e,t){if(this.disabledTrackOverlayPaths=[],e===Zt.Consolidated||t===zt.allTracks)return void this.draw();const s=e=>{const t=new Path2D;t.moveTo(-Qt.WIDTH,es.HEADER_HEIGHT+es.TRACK_HEIGHT*(e+1));const s=Math.ceil((this.elementsCtx.canvas.width+Qt.WIDTH)/Qt.WIDTH);for(let n=0;n<s;n++)t.lineTo(n*Qt.WIDTH,es.HEADER_HEIGHT+es.TRACK_HEIGHT*e),t.moveTo(n*Qt.WIDTH,es.HEADER_HEIGHT+es.TRACK_HEIGHT*(e+1));const n=new Path2D;return n.rect(-Qt.WIDTH,es.HEADER_HEIGHT+es.TRACK_HEIGHT*e,this.elementsCtx.canvas.width+Qt.WIDTH,es.TRACK_HEIGHT),t.addPath(n),t};e===Zt.Position_LookAt_Bank?(0===(t&zt.posXTrack)&&this.disabledTrackOverlayPaths.push(s(0)),0===(t&zt.lookAtXTrack)&&this.disabledTrackOverlayPaths.push(s(1)),0===(t&zt.bankTrack)&&this.disabledTrackOverlayPaths.push(s(2))):(0===(t&zt.posXTrack)&&this.disabledTrackOverlayPaths.push(s(0)),0===(t&zt.posYTrack)&&this.disabledTrackOverlayPaths.push(s(1)),0===(t&zt.posZTrack)&&this.disabledTrackOverlayPaths.push(s(2)),0===(t&zt.lookAtXTrack)&&this.disabledTrackOverlayPaths.push(s(3)),0===(t&zt.lookAtYTrack)&&this.disabledTrackOverlayPaths.push(s(4)),0===(t&zt.lookAtZTrack)&&this.disabledTrackOverlayPaths.push(s(5)),0===(t&zt.bankTrack)&&this.disabledTrackOverlayPaths.push(s(6))),this.draw()}getPlayheadTimeMs(){return this.playhead.getT()}getPlayheadTimeSeconds(){return(this.playhead.getT()/$t).toFixed(2)}getPlayheadX(){return this.playhead.getX()}getLastKeyframeTimeMs(){return Math.max(...this.keyframeIcons.map(e=>e.keyframesMap.values().next().value.time))}playheadIsOnIcon(){for(const e of this.keyframeIcons)if(this.playhead.getT()===e.getT())return!0;return!1}getSelectedKeyframesForTrack(e){const t=[];for(const s of this.selectedKeyframeIcons){let n;s.keyframesMap.has(e)&&t.push(s.keyframesMap.get(e)),s.type===jt.Loop_End?n=this.keyframeIcons.find(t=>t.type===jt.Start&&t.keyframesMap.has(e)):s.type===jt.Start&&(n=this.keyframeIcons.find(t=>t.type===jt.Loop_End&&t.keyframesMap.has(e))),n&&!t.includes(n.keyframesMap.get(e))&&t.push(n.keyframesMap.get(e))}return t}getLoopEndKeyframeForTrack(e){for(const t of this.keyframeIcons)if(t.type===jt.Loop_End){const s=t.keyframesMap.get(e);if(void 0!==s)return s}throw"No end loop keyframe icon exists for track."}getStartKeyframeForTrack(e){for(const t of this.keyframeIcons)if(t.type===jt.Start){const s=t.keyframesMap.get(e);if(void 0!==s)return s}throw"No start keyframe icon exists for track."}}es.DEFAULT_LENGTH_MS=3e4,es.MIN_MARKER_WIDTH_PX=50,es.MARKER_COLOR="#f3f3f3",es.SELECTION_BOX_STROKE_COLOR="#63BBFF",es.SELECTION_BOX_FILL_COLOR="rgba(53, 77, 255, 0.4)",es.DISABLED_TRACK_OVERLAY_COLOR="rgba(0, 0, 0, 0.6)",es.DISABLED_TRACK_LINES_COLOR="#646464",es.DEFAULT_SECONDS_PER_MARKER=5,es.SNAP_DISTANCE_PX=10,es.HEADER_HEIGHT=25,es.TRACK_HEIGHT=20,es.KEYFRAME_ICONS_BASE_Y_POS=es.HEADER_HEIGHT+.5*(es.TRACK_HEIGHT-Jt.HEIGHT);class ts{findKeyframe(e,t){for(let s=0;s<e.length;s++)if(t<e[s].time)return s;return-1}calcTrackDuration(e){return e.keyframes.length>0?e.keyframes[e.keyframes.length-1].time:0}calcAnimationDuration(e){let t=0;return t=Math.max(t,this.calcTrackDuration(e.posXTrack)),t=Math.max(t,this.calcTrackDuration(e.posYTrack)),t=Math.max(t,this.calcTrackDuration(e.posZTrack)),t=Math.max(t,this.calcTrackDuration(e.lookAtXTrack)),t=Math.max(t,this.calcTrackDuration(e.lookAtYTrack)),t=Math.max(t,this.calcTrackDuration(e.lookAtZTrack)),t=Math.max(t,this.calcTrackDuration(e.bankTrack)),t}getCurrentTrackValue(e,t,s){const n=this.findKeyframe(e.keyframes,t);if(0===n)return e.keyframes[0].value;if(n<0)return e.keyframes[e.keyframes.length-1].value;const i=n-1,r=e.keyframes[i],a=e.keyframes[n];let o=(0,l.po)(r.time,a.time,t),h=r.value,c=a.value;s&&n===e.keyframes.length-1&&(h%=l.wZ.TAU);let u=r.tangentOut,d=a.tangentIn,m=r.interpOutType;if(r.interpOutType!==a.interpInType&&(o>.5?(m=a.interpInType,m===Wt.Linear&&(o-=.5,o/=.5,h=f(h,c,u,d,.5))):m===Wt.Linear&&(o/=.5,c=f(h,c,u,d,.5))),m===Wt.Ease)return f(h,c,u,d,o);if(m===Wt.Linear)return(0,l.Cc)(h,c,o);if(m===Wt.Hold)return h;throw"whoops"}calcAnimationPose(e,t,s){const n=this.getCurrentTrackValue(t.posXTrack,s),i=this.getCurrentTrackValue(t.posYTrack,s),r=this.getCurrentTrackValue(t.posZTrack,s),a=this.getCurrentTrackValue(t.lookAtXTrack,s),o=this.getCurrentTrackValue(t.lookAtYTrack,s),l=this.getCurrentTrackValue(t.lookAtZTrack,s);h.hZ(e.pos,n,i,r),h.hZ(e.lookAtPos,a,o,l),e.bank=this.getCurrentTrackValue(t.bankTrack,s,t.loop)}initAnimationPlayback(e,t){this.animation=e,this.elapsedTimeMs=t,this.durationMs=this.calcAnimationDuration(e)}setElapsedTime(e){this.elapsedTimeMs=e,this.animation.loop&&(this.elapsedTimeMs=this.elapsedTimeMs%this.durationMs)}updateElapsedTime(e){this.setElapsedTime(this.elapsedTimeMs+e)}getAnimFrame(e,t=this.elapsedTimeMs){this.calcAnimationPose(e,this.animation,t)}isAnimationFinished(){return!this.animation.loop&&this.elapsedTimeMs>=this.durationMs}getElapsedTimeSeconds(){return this.elapsedTimeMs/$t}}class ss extends i.$w{constructor(e,t){super(),this.ui=e,this.viewer=t,this.studioStates=[],this.currentStateIndex=-1,this.animationPreviewSteps=[],this.zoomLevel=1,this.lockPerspective=!0,this.persistHelpText=!1,this.timelineMode=Zt.Consolidated,this.selectedTracks=zt.allTracks,this.scratchVec3a=h.vt(),this.scratchVec3b=h.vt(),this.scratchVec3c=h.vt(),this.scratchMat=d.vt(),this.previewLineColor=a.kD,this.previewLineLookAtColor=a.vl,this.previewLineYAxisColor=a.aM,this.previewLineKfDotColor=a.o4,this.previewLineKfDotSelectedColor=a.aw,this.videoRecorder=null,this.scratchVecPos=h.vt(),this.scratchVecLook=h.vt(),this.scratchVecZAxis=h.vt(),this.onTabBtnClick=function(e){var t;const s=document.querySelector("#studioPanel"),i=this.dataset.target,r=this.dataset.tabGroup;if(s&&i&&r){const e=s.querySelector(i);(null===(t=this.parentElement)||void 0===t?void 0:t.querySelectorAll("button.TabBtn")).forEach(e=>(0,n.Y)(e,!1));const a=!(null==e?void 0:e.hasAttribute("hidden"));s.querySelectorAll("."+r).forEach(e=>e.setAttribute("hidden","")),a||(null==e||e.removeAttribute("hidden"),(0,n.Y)(this,!0))}},this.handleGlobalInput=e=>{const t=document.activeElement===document.querySelector("canvas");"Delete"===e.key&&this.timeline.selectedKeyframeIcons.length&&!e.repeat?this.deleteSelectedKeyframeIcons():"j"!==e.key||t?"k"!==e.key||t?","===e.key?this.movePlayhead(-1/60):"."===e.key?this.movePlayhead(1/60):" "!==e.key||t?"Enter"!==e.key||e.target instanceof HTMLInputElement?"Escape"===e.key?this.stopAnimation():e.ctrlKey&&e.shiftKey&&"Z"===e.key?this.redo():e.ctrlKey&&"z"===e.key?this.undo():e.ctrlKey&&"s"===e.key&&(e.preventDefault(),this.saveAnimation(),this.displayMessage("Saved animation to local storage.")):this.addKeyframesFromMat4(d.o8(this.studioCameraController.camera.worldMatrix)):this.studioCameraController.isAnimationPlaying?this.stopAnimation():this.playAnimation():this.nextKeyframe():this.prevKeyframe()},this.mainPanel.parentElement.style.minWidth="100%",this.mainPanel.parentElement.style.height="300px",this.mainPanel.parentElement.style.left="0px",this.mainPanel.parentElement.style.bottom="0px",this.mainPanel.parentElement.style.top="",this.mainPanel.style.backgroundColor="rgba(0, 0, 0, 1)",this.mainPanel.style.height="100%",this.closeButton.style.display="none";const s=()=>{const e=document.querySelector("#BottomBar");"-270px"===this.mainPanel.parentElement.style.bottom?(this.mainPanel.parentElement.style.bottom="0px",e&&(e.style.bottom=this.elem.getBoundingClientRect().height+24+"px")):(this.mainPanel.parentElement.style.bottom="-270px",e&&e.dataset.ob&&(e.style.bottom=e.dataset.ob))};this.header.ondblclick=s,this.minimizeButton.onclick=s,this.header.onmousedown=null,this.elem.onmouseover=()=>{this.elem.style.opacity="1"},this.elem.onmouseout=()=>{this.elem.style.opacity="0.8"},this.elem.id="studioPanel",this.elem.style.display="none",this.elem.style.zIndex="1",this.elem.style.opacity="0.8",this.elem.style.userSelect="none",this.contents.style.maxHeight="",this.contents.style.overflow="",this.contents.style.height="100%",this.setTitle(Kt,"Studio"),this.contents.insertAdjacentHTML("beforeend",'\n        <div id="studioPanelContents" hidden></div>\n        '),this.contents.style.lineHeight="36px",this.studioPanelContents=this.contents.querySelector("#studioPanelContents"),this.setWidth("100%")}show(){this.elem.style.display="";const e=document.querySelector("#BottomBar");e&&(e.dataset.ob=e.style.bottom,e.style.bottom=this.elem.getBoundingClientRect().height+24+"px"),document.addEventListener("keydown",this.handleGlobalInput)}hide(){this.elem.style.display="none";const e=document.querySelector("#BottomBar");e&&e.dataset.ob&&(e.style.bottom=e.dataset.ob),document.removeEventListener("keydown",this.handleGlobalInput)}initStudio(){if(this.studioPanelContents.children.length)return;this.animationManager=new ts,this.studioCameraController=new o.YF(this.animationManager,this),this.studioPanelContents.insertAdjacentHTML("afterbegin",`\n        <style>\n            #studioPanel {\n                font: 16px monospace;\n                color: #fefefe;\n            }\n            #studioPanel a:visited {\n                color: #eee;\n            }\n            #studioPanel .disabled,\n            .SettingsButton.disabled {\n                cursor: not-allowed!important;\n                opacity: 0.5;\n            }\n            #studioPanelContents {\n                height: 100%;\n                display: grid;\n                grid-auto-flow: column;\n                grid-template-columns: 1fr 4fr 1fr;\n            }\n            #studioPanel select {\n                background: #000;\n                border-radius: 5px;\n                padding: 3px 0;\n                font: 16px monospace;\n                color: #fefefe;\n            }\n            #undoRedoBtnContainer .SettingsButton,\n            #saveAnimationBtn {\n                width: 5rem;\n            }\n            #studioSaveLoadControls {\n                width: 85%;\n                margin: auto;\n            }\n            #recordPlaybackBtn {\n                width: 10rem;\n                margin: auto;\n                height: 3rem;\n            }\n            #studioHelpText {\n                line-height: 1.5;\n                min-height: 1rem;\n                text-align: center;\n            }\n            #trackLabels {\n                line-height: 1.7;\n                font-size: 12px;\n                margin: 25px 0 0 10px;\n            }\n            #trackLabels .TrackSelectBox {\n                cursor: pointer;\n                width: 10px;\n                height: 10px;\n                justify-self: center;\n                margin: 0 5px 0 10px;\n                border-radius: 4px;\n                border: 2px solid #aaa;\n                background-color: transparent;\n            }\n            #trackLabels .TrackSelectBox.Selected {\n                border: 2px solid white;\n                background-color: rgb(210, 30, 30);\n            }\n            .label-container {\n                display: flex;\n                align-items: center;\n                justify-content: flex-end;\n            }\n            .label-col {\n                display: flex;\n                flex-direction: column;\n                margin-left: 0.5rem;\n                align-content: flex-end;\n                text-align: right;\n            }\n            .label-col > div {\n                height: 20px;\n            }\n            .label-col > div, .label-container > div {\n                display: flex;\n                align-items: center;\n                justify-content: end;\n            }\n            #timelineContainer {\n                padding: 0 15px;\n                margin-bottom: 10px;\n                overflow: auto hidden;\n                position: relative;\n                height: 225px;\n                flex: 1;\n            }\n            #timelineContainer > canvas {\n                position: absolute;\n            }\n            #timelineContainer > div {\n                position: absolute;\n                left: 5px;\n                right: 15px;\n            }\n            #timelineHeaderBg {\n                height: ${es.HEADER_HEIGHT}px;\n                background: linear-gradient(#494949, #2f2f2f);\n                z-index: 2;\n            }\n            #timelineTracksBg {\n                position: absolute;\n                height: ${es.TRACK_HEIGHT}px;\n                top: ${es.HEADER_HEIGHT}px;\n                background: ${ss.DEFAULT_TIMELINE_BG};\n                z-index: 1;\n            }\n            #timelineMarkersCanvas {\n                z-index: 3;\n            }\n            #timelineElementsCanvas {\n                z-index: 4;\n            }\n            #timelineControlsContainer {\n                display: grid;\n                grid-gap: 12px;\n                grid-auto-flow: column;\n                justify-content: space-between;\n                margin: 5px 32px;\n            }\n            #zoomControls {\n                display: grid;\n                grid-gap: 10px;\n                grid-template-columns: 3rem 3rem;\n            }\n            #keyframeControlsDock {\n                min-width: 360px;\n                line-height: 1.2;\n                border-left: 2px dotted #696969;\n                padding: 0 0.5rem;\n            }\n            #keyframeControls input {\n                background: #000;\n                font-weight: bold;\n                border: 1px solid #444444;\n                font: 16px monospace;\n                color: #fefefe;\n            }\n            .KeyframeSettingsName {\n                margin-top: 0.5rem;\n                margin-bottom: 0.25rem;\n            }\n            .StudioNumericInput {\n                width: 4rem;\n                background: #000;\n                height: 1.5rem;\n                border-radius: 5px;\n                font: 16px monospace;\n                color: #fefefe;\n                cursor: grab;\n                user-select: none;\n            }\n            .StudioNumericInput.manual-entry {\n                cursor: text;\n                user-select: text;\n            }\n            #customValuesContainer {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n                text-align: center;\n                margin-top: 0.5rem;\n            }\n            #customValuesContainer .StudioNumericInput {\n                width: 5rem;\n            }\n            #lockPerspective {\n                grid-column-start: 1;\n                grid-column-end: 3;\n                position: relative;\n            }\n            #lockPerspectiveBracket {\n                grid-column-start: 1;\n                grid-column-end: 3;\n                margin: -10px 16px 0 16px;\n                height: 20px;\n                border-bottom: 1px solid #ffffff;\n                border-radius: 20px;\n                margin-bottom: 0.7rem;\n                position: relative;\n            }\n            #lockPerspectiveBracket::after {\n                content: '\\25BC';\n                position: absolute;\n                left: 50%;\n                transform: translate(-50%, 15px);\n                margin: auto;\n            }\n            #interpolationTab {\n                margin: 0.5rem;\n            }\n            #interpolationTab > div {\n                margin: 0 0.75rem 0.5rem;\n            }\n            .SettingsButton.IconButton {\n                width: 36px;\n                height: 36px;\n                padding: 0 0 0 0.05rem;\n                line-height: 2.4;\n            }\n            #playbackControls {\n                display: grid;\n                grid-gap: 1rem;\n                grid-template-columns: 3rem 10rem 3rem;\n            }\n        </style>\n        <div style="padding: 0.5rem; border-right: 2px dotted #696969; position: relative;">\n            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">\n                <div id="undoRedoBtnContainer" hidden>\n                    <button type="button" id="undoBtn" class="SettingsButton disabled" disabled></button>\n                    <button type="button" id="redoBtn" class="SettingsButton disabled" disabled></button>\n                </div>\n                <button type="button" id="saveAnimationBtn" class="SettingsButton" hidden>Save</button>\n            </div>\n            <div style="display: flex;">\n                <button id="studioDataTabBtn" class="SettingsButton TabBtn" data-tab-group="StudioPanelTab" data-target="#studioSaveLoadControls"></button>\n                <button id="settingsTabBtn" class="SettingsButton TabBtn" data-tab-group="StudioPanelTab" data-target="#settingsTab"></button>\n            </div>\n            <div>\n                <div id="studioSaveLoadControls" class="StudioPanelTab" hidden>\n                    <div style="display: grid;grid-template-columns: 1fr 1fr; gap: 0.25rem 1rem; margin-top: 0.5rem;">\n                        <button type="button" id="newAnimationBtn" class="SettingsButton">New</button>\n                        <button type="button" id="loadAnimationBtn" class="SettingsButton">Load</button>\n                        <button type="button" id="importAnimationBtn" class="SettingsButton">Import</button>\n                        <button type="button" id="exportAnimationBtn" class="SettingsButton">Export</button>\n                        <button type="button" id="helpBtn" class="SettingsButton">Help</button>\n                    </div>\n                    <div style="position: absolute; bottom: 3rem; height: 3rem; left: 50%; transform: translate(-50%, 0);">\n                        <button type="button" id="recordPlaybackBtn" class="SettingsButton"></button>\n                    </div>\n                </div>\n                <div id="settingsTab" class="StudioPanelTab" hidden>\n                    <div id="studioSettingsContainer">\n                        <div style="text-align: center;">Studio Settings</div>\n                        <div>\n                            <span>Timeline Mode:</span>\n                            <select id="timelineModeSelect">\n                                <option value="${Zt.Consolidated}">Consolidated</option>\n                                <option value="${Zt.Position_LookAt_Bank}">Pos/LookAt/Bank</option>\n                                <option value="${Zt.Full}">Full</option>\n                            </select>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div>\n            <div id="studioHelpText"></div>\n            <div id="studioControlsContainer" hidden>\n                <div id="timelineControlsContainer">\n                    <div id="zoomControls">\n                        <button type="button" id="zoomOutBtn" class="SettingsButton disabled" disabled></button>\n                        <button type="button" id="zoomInBtn" class="SettingsButton"></button>\n                    </div>\n                    <div id="playbackControls">\n                        <button type="button" id="prevKeyframeBtn" class="SettingsButton"></button>\n                        <button type="button" id="playAnimationBtn" class="SettingsButton"></button>\n                        <button type="button" id="stopAnimationBtn" class="SettingsButton" hidden></button>\n                        <button type="button" id="nextKeyframeBtn" class="SettingsButton"></button>\n                    </div>\n                    <div>\n                        <input id="playheadTimePositionInput" class="StudioNumericInput" type="number" min="0" max="300" step="0.1" value="0"><span>/</span>\n                        <input id="timelineLengthInput" class="StudioNumericInput" type="number" min="1" max="300" step="0.1" value="${es.DEFAULT_LENGTH_MS/$t}"><span>s</span>\n                        <button type="button" id="loopAnimationBtn" title="Loop" class="SettingsButton IconButton"></button>\n                        <button type="button" id="snapBtn" title="Snap" class="SettingsButton IconButton"></button>\n                    </div>\n                </div>\n                <div style="display: flex;">\n                    <div id="trackLabels">\n                        <div id="positionLookAtBankLabels" hidden>\n                            <div class="label-col">\n                                <div>Position <div class="TrackSelectBox Selected" data-tracks="${zt.posXTrack},${zt.posYTrack},${zt.posZTrack}"></div></div>\n                                <div>LookAt <div class="TrackSelectBox Selected" data-tracks="${zt.lookAtXTrack},${zt.lookAtYTrack},${zt.lookAtZTrack}"></div></div>\n                                <div>Bank <div class="TrackSelectBox Selected" data-tracks="${zt.bankTrack}"></div></div>\n                            </div>\n                        </div>\n                        <div id="fullLabels" hidden>\n                            <div class="label-container" style="border-bottom: 1px solid white;">\n                                <span>Position</span>\n                                <div class="label-col">\n                                    <div>X <div class="TrackSelectBox Selected" data-tracks="${zt.posXTrack}"></div></div>\n                                    <div>Y <div class="TrackSelectBox Selected" data-tracks="${zt.posYTrack}"></div></div>\n                                    <div>Z <div class="TrackSelectBox Selected" data-tracks="${zt.posZTrack}"></div></div>\n                                </div>\n                            </div>\n                            <div class="label-container" style="margin-top: -1px; border-bottom: 1px solid white;">\n                                <span>LookAt</span>\n                                <div class="label-col">\n                                    <div>X <div class="TrackSelectBox Selected" data-tracks="${zt.lookAtXTrack}"></div></div>\n                                    <div>Y <div class="TrackSelectBox Selected" data-tracks="${zt.lookAtYTrack}"></div></div>\n                                    <div>Z <div class="TrackSelectBox Selected" data-tracks="${zt.lookAtZTrack}"></div></div>\n                                </div>\n                            </div>\n                            <div class="label-container">\n                                <div>Bank <div class="TrackSelectBox Selected" data-tracks="${zt.bankTrack}"></div></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="timelineContainer">\n                        <div id="timelineHeaderBg"></div>\n                        <div id="timelineTracksBg"></div>\n                        <canvas id="timelineMarkersCanvas" width="1000" height="${es.HEADER_HEIGHT}"></canvas>\n                        <canvas id="timelineElementsCanvas" width="1000" height="${es.HEADER_HEIGHT+es.TRACK_HEIGHT}" tabindex="-1"></canvas>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div id="keyframeControlsDock" hidden>\n            <div style="text-align: center; border-bottom: 1px solid #696969;">Keyframe Settings</div>\n            <div id="selectKeyframeMsg" style="text-align: center;">Select a keyframe.</div>\n            <div id="keyframeControlsContents" hidden>\n                <div style="display: flex;">\n                    <button id="valuesTabBtn" class="SettingsButton TabBtn" data-tab-group="KeyframeControlsTab" data-target="#valuesTab">Values</button>\n                    <button id="interpTabBtn" class="SettingsButton TabBtn" data-tab-group="KeyframeControlsTab" data-target="#interpolationTab">Interpolation</button>\n                </div>\n                <div>\n                    <div id="valuesTab" class="KeyframeControlsTab">\n                        <div id="customValuesContainer">\n                            <div>\n                                <div id="posXValueInputContainer"><span>X Position:</span> <input id="posXValueInput" class="StudioNumericInput" data-track="${zt.posXTrack}" type="number" step="1.0" value="0"></div>\n                                <div id="posYValueInputContainer"><span>Y Position:</span> <input id="posYValueInput" class="StudioNumericInput" data-track="${zt.posYTrack}" type="number" step="1.0" value="0"></div>\n                                <div id="posZValueInputContainer"><span>Z Position:</span> <input id="posZValueInput" class="StudioNumericInput" data-track="${zt.posZTrack}" type="number" step="1.0" value="0"></div>\n                            </div>\n                            <div>\n                                <div id="lookAtXValueInputContainer"><span>LookAt X:</span> <input id="lookAtXValueInput" class="StudioNumericInput" data-track="${zt.lookAtXTrack}" type="number" step="1.0" value="0"></div>\n                                <div id="lookAtYValueInputContainer"><span>LookAt Y:</span> <input id="lookAtYValueInput" class="StudioNumericInput" data-track="${zt.lookAtYTrack}" type="number" step="1.0" value="0"></div>\n                                <div id="lookAtZValueInputContainer"><span>LookAt Z:</span> <input id="lookAtZValueInput" class="StudioNumericInput" data-track="${zt.lookAtZTrack}" type="number" step="1.0" value="0"></div>\n                            </div>\n                            <div id="bankValueInputContainer">\n                                <span>Bank rotation:</span>\n                                <canvas id="bankRotationValCanvas" width="80" height="80"></canvas>\n                                <input id="bankValueInput" class="StudioNumericInput" data-track="${zt.bankTrack}" type="number" step="1" value="0">\n                            </div>\n                            <div id="lockPerspectiveBracket"></div>\n                            <div id="lockPerspective">\n                                <button id="lockPerspectiveBtn" class="SettingsButton IconButton"></button>\n                                <span style="position: absolute; white-space: nowrap; top: 9px; margin-left: 0.2rem;">Lock Perspective</span>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="interpolationTab" class="KeyframeControlsTab" hidden>\n                    </div>\n                </div>\n            </div>\n        </div>`),this.studioHelpText=this.contents.querySelector("#studioHelpText"),this.studioHelpText.dataset.startPosHelpText="Move the camera to the desired starting position and press Enter.",this.studioHelpText.dataset.editPosHelpText="Move the camera to the desired position and press Enter. Press Escape to cancel.",this.studioHelpText.dataset.default="Move the camera to the desired starting position and press Enter.",this.studioHelpText.innerText=this.studioHelpText.dataset.startPosHelpText,this.undoRedoBtnContainer=this.contents.querySelector("#undoRedoBtnContainer"),this.undoBtn=this.contents.querySelector("#undoBtn"),this.undoBtn.onclick=()=>this.undo(),this.undoBtn.insertAdjacentElement("afterbegin",(0,n.MC)('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="16"><g transform="translate(0,-952.36218)"><path overflow="visible" style="" d="m 39.999997,975.36218 -31.9999995,25.00002 31.9999995,25 0,-14 c 1.7024,-0.08 31.3771,-0.033 52.000005,18 -8.252999,-25.4273 -34.173805,-35.48722 -52.000005,-40.00002 z" fill="#ffffff" stroke="none"/></g></svg>').querySelector("svg")),this.redoBtn=this.contents.querySelector("#redoBtn"),this.redoBtn.onclick=()=>this.redo(),this.redoBtn.insertAdjacentElement("afterbegin",(0,n.MC)('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="16"><g transform="translate(0,-952.36218)"><path d="m 60,975.36216 32,24.99994 -32,25.0001 0,-12.0001 c -1.7024,-0.08 -31.3771,-2.0334 -52,16.0001 8.253,-25.4274 34.1738,-37.48724 52,-42.00004 z" style="" overflow="visible" fill="#ffffff" stroke="none"/></g></svg>').querySelector("svg")),this.studioDataTabBtn=this.contents.querySelector("#studioDataTabBtn"),this.studioDataTabBtn.title="Save the current animation, or load a previously-saved animation.",this.settingsTabBtn=this.contents.querySelector("#settingsTabBtn"),this.settingsTabBtn.title="Settings",this.newAnimationBtn=this.contents.querySelector("#newAnimationBtn"),this.newAnimationBtn.title="Clear the current keyframes and create a new animation.",this.loadAnimationBtn=this.contents.querySelector("#loadAnimationBtn"),this.loadAnimationBtn.title="Load the previously-saved animation for this map. Overwrites the current keyframes!",this.saveAnimationBtn=this.contents.querySelector("#saveAnimationBtn"),this.saveAnimationBtn.title="Save the current animation for this map to your browser's local storage.",this.importAnimationBtn=this.contents.querySelector("#importAnimationBtn"),this.importAnimationBtn.title="Load an animation from a JSON file.",this.exportAnimationBtn=this.contents.querySelector("#exportAnimationBtn"),this.exportAnimationBtn.title="Save the current animation as a JSON file.",this.helpBtn=this.contents.querySelector("#helpBtn"),this.helpBtn.onclick=()=>{const e=document.createElement("a");e.rel="noopener noreferrer",e.target="_blank",e.href="https://github.com/magcius/noclip.website/wiki/Studio",e.click()},this.studioControlsContainer=this.contents.querySelector("#studioControlsContainer"),this.studioDataTabBtn.addEventListener("click",this.onTabBtnClick),(0,n.Y)(this.studioDataTabBtn,!1),this.newAnimationBtn.onclick=()=>{this.newAnimation(),this.saveState()},this.loadAnimationBtn.onclick=()=>this.loadAnimation(),this.saveAnimationBtn.onclick=()=>{this.saveAnimation(),this.displayMessage("Saved animation to local storage.")},this.exportAnimationBtn.onclick=()=>this.exportAnimation(),this.importAnimationBtn.onclick=()=>this.importAnimation(),this.settingsTabBtn.addEventListener("click",this.onTabBtnClick),(0,n.Y)(this.settingsTabBtn,!1);const e=e=>{if(this.timelineMode===Zt.Consolidated||this.timelineMode===Zt.Position_LookAt_Bank&&e===Zt.Full)return!0;if(e===Zt.Consolidated){if(this.animation.posXTrack.keyframes.length!==this.animation.posYTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.posZTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.lookAtXTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.lookAtYTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.lookAtZTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.bankTrack.keyframes.length)return!1;for(let e=0;e<this.animation.posXTrack.keyframes.length;e++)if(!(Ht(this.animation.posXTrack.keyframes[e],this.animation.posYTrack.keyframes[e])&&Ht(this.animation.posXTrack.keyframes[e],this.animation.posZTrack.keyframes[e])&&Ht(this.animation.posXTrack.keyframes[e],this.animation.lookAtXTrack.keyframes[e])&&Ht(this.animation.posXTrack.keyframes[e],this.animation.lookAtYTrack.keyframes[e])&&Ht(this.animation.posXTrack.keyframes[e],this.animation.lookAtZTrack.keyframes[e])&&Ht(this.animation.posXTrack.keyframes[e],this.animation.bankTrack.keyframes[e])))return!1}else if(e===Zt.Position_LookAt_Bank){if(this.animation.posXTrack.keyframes.length!==this.animation.posYTrack.keyframes.length||this.animation.posXTrack.keyframes.length!==this.animation.posZTrack.keyframes.length||this.animation.lookAtXTrack.keyframes.length!==this.animation.lookAtYTrack.keyframes.length||this.animation.lookAtXTrack.keyframes.length!==this.animation.lookAtZTrack.keyframes.length)return!1;for(let e=0;e<this.animation.posXTrack.keyframes.length;e++)if(!Ht(this.animation.posXTrack.keyframes[e],this.animation.posYTrack.keyframes[e])||!Ht(this.animation.posXTrack.keyframes[e],this.animation.posZTrack.keyframes[e]))return!1;for(let e=0;e<this.animation.lookAtXTrack.keyframes.length;e++)if(!Ht(this.animation.lookAtXTrack.keyframes[e],this.animation.lookAtYTrack.keyframes[e])||!Ht(this.animation.lookAtXTrack.keyframes[e],this.animation.lookAtZTrack.keyframes[e]))return!1}return!0};this.timelineModeSelect=this.contents.querySelector("#timelineModeSelect"),this.timelineModeSelect.onchange=()=>{const t=parseInt(this.timelineModeSelect.value);if(!e(t))return this.displayError("Cannot flatten timeline unless keyframes are aligned. ","See Help for details.","https://github.com/magcius/noclip.website/wiki/Studio#consolidating-timeline"),void(this.timelineModeSelect.selectedIndex=this.timelineMode);this.trackSelectBoxes.forEach(e=>e.classList.add("Selected")),this.timelineTracksBg.style.background=ss.DEFAULT_TIMELINE_BG,t===Zt.Consolidated?(this.positionLookAtBankLabels.setAttribute("hidden",""),this.fullLabels.setAttribute("hidden",""),this.selectedTracks=zt.allTracks):(this.trackSelectBoxes.forEach(e=>{const t=e.dataset.tracks.split(",").map(e=>parseInt(e));t.every(e=>0===(this.selectedTracks&e))?e.classList.remove("Selected"):t.forEach(e=>this.selectedTracks|=e)}),t===Zt.Position_LookAt_Bank?(this.positionLookAtBankLabels.removeAttribute("hidden"),this.fullLabels.setAttribute("hidden","")):t===Zt.Full&&(this.timelineTracksBg.style.background=ss.FULL_TIMELINE_BG,this.positionLookAtBankLabels.setAttribute("hidden",""),this.fullLabels.removeAttribute("hidden"))),this.timelineMode=t,this.reAddAllKeyframeIcons(),this.timeline.setTimelineMode(this.timelineMode,this.selectedTracks),this.timelineTracksBg.style.height=this.timelineElementsCanvas.height-es.HEADER_HEIGHT+"px",this.rescaleTimelineContainer()},this.showPreviewLineCheckbox=new n.Sc("Show Animation Preview Line",!0),this.showPreviewLineCheckbox.elem.title="Show/Hide the line indicating the path of the animation.",this.showPreviewLineCheckbox.onchanged=()=>{this.showPreviewLineCheckbox.checked&&this.updatePreviewSteps(),this.saveStudioSettings()},this.livePreviewCheckbox=new n.Sc("Live Preview"),this.livePreviewCheckbox.elem.title="Preview the animation when moving the playhead or keyframes.",this.livePreviewCheckbox.onchanged=()=>{this.livePreviewCheckbox.checked&&this.updatePreviewSteps(),this.saveStudioSettings()},this.autoSaveCheckbox=new n.Sc("Auto-Save"),this.autoSaveCheckbox.elem.title="Auto-save the current animation on every modification.",this.autoSaveCheckbox.checked=!0,this.autoSaveCheckbox.onchanged=()=>this.saveStudioSettings(),this.studioSettingsContainer=this.contents.querySelector("#studioSettingsContainer"),this.studioSettingsContainer.insertAdjacentElement("beforeend",this.showPreviewLineCheckbox.elem),this.studioSettingsContainer.insertAdjacentElement("beforeend",this.livePreviewCheckbox.elem),this.studioSettingsContainer.insertAdjacentElement("beforeend",this.autoSaveCheckbox.elem),this.recordPlaybackBtn=this.contents.querySelector("#recordPlaybackBtn");const t=(0,n.MC)(Kt).querySelector("svg");t.setAttribute("height","30"),this.recordPlaybackBtn.appendChild(t),this.recordPlaybackBtn.onclick=()=>this.record(),this.timeLineContainerElement=this.contents.querySelector("#timelineContainer"),this.positionLookAtBankLabels=this.contents.querySelector("#positionLookAtBankLabels"),this.fullLabels=this.contents.querySelector("#fullLabels"),this.trackSelectBoxes=this.contents.querySelectorAll(".TrackSelectBox"),this.trackSelectBoxes.forEach(e=>{e.addEventListener("click",()=>{e.classList.toggle("Selected");const t=e.dataset.tracks.split(",").map(e=>parseInt(e));e.classList.contains("Selected")?t.forEach(e=>this.selectedTracks|=e):t.forEach(e=>this.selectedTracks^=e),this.timeline.updateTrackSelection(this.timelineMode,this.selectedTracks)})}),this.timelineMarkersCanvas=this.contents.querySelector("#timelineMarkersCanvas"),this.timelineElementsCanvas=this.contents.querySelector("#timelineElementsCanvas"),this.timelineHeaderBg=this.contents.querySelector("#timelineHeaderBg"),this.timelineTracksBg=this.contents.querySelector("#timelineTracksBg");const s=this.timelineMarkersCanvas.getContext("2d"),i=this.timelineElementsCanvas.getContext("2d");this.timeline=new es(s,i,es.DEFAULT_LENGTH_MS),this.snapBtn=this.contents.querySelector("#snapBtn"),this.snapBtn.onclick=()=>{this.timeline.snappingEnabled=!this.timeline.snappingEnabled,(0,n.Y)(this.snapBtn,this.timeline.snappingEnabled)},this.snapBtn.title="Snap keyframes to the playhead, and vice-versa.",(0,n.Y)(this.snapBtn,this.timeline.snappingEnabled),this.playheadTimePositionInput=this.contents.querySelector("#playheadTimePositionInput"),this.playheadTimePositionInput.dataset.prevValue=this.playheadTimePositionInput.value,this.playheadTimePositionInput.onfocus=()=>{this.playheadTimePositionInput.dataset.prevValue=this.playheadTimePositionInput.value},this.playheadTimePositionInput.onchange=()=>{let e=parseFloat(this.playheadTimePositionInput.value);Number.isNaN(e)?this.playheadTimePositionInput.value=this.playheadTimePositionInput.dataset.prevValue.toString():this.playheadTimePositionInput.value!==this.playheadTimePositionInput.dataset.prevValue.toString()&&(e=(0,l.qE)(e,0,this.timeline.getTimelineLengthMs()/$t),this.playheadTimePositionInput.value=e.toString(),this.timeline.setPlayheadTimeSeconds(e,!this.studioCameraController.isAnimationPlaying),this.playheadTimePositionInput.dataset.prevValue=e.toString(),!this.studioCameraController.isAnimationPlaying&&this.livePreviewCheckbox.checked&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs()))},this.timelineLengthInput=this.contents.querySelector("#timelineLengthInput"),this.timelineLengthInput.dataset.prevValue=this.timelineLengthInput.value,this.timelineLengthInput.onfocus=()=>{this.timelineLengthInput.dataset.prevValue=this.timelineLengthInput.value},this.timelineLengthInput.onchange=()=>{let e=parseFloat(this.timelineLengthInput.value);Number.isNaN(e)?this.timelineLengthInput.value=this.timelineLengthInput.dataset.prevValue.toString():(e=(0,l.qE)(e,Math.max(1,this.timeline.getLastKeyframeTimeMs()/$t),300),this.timelineLengthInput.value=e.toString(),this.timeline.setScaleAndDrawMarkers(e*$t),this.timelineLengthInput.dataset.prevValue=this.timelineLengthInput.value,this.onTimelineScaleChanged(e))},this.loopAnimationBtn=this.contents.querySelector("#loopAnimationBtn"),this.loopAnimationBtn.title="Loop the animation until manually stopped.",this.loopAnimationBtn.onclick=()=>{this.animation.loop=!this.animation.loop,(0,n.Y)(this.loopAnimationBtn,this.animation.loop),this.animation.loop?this.addLoopEndFrames():this.deleteLoopEndFrames(),this.updatePreviewSteps(),this.timeline.draw()},(0,n.Y)(this.loopAnimationBtn,!1),this.keyframeControlsDock=this.contents.querySelector("#keyframeControlsDock"),this.keyframeControlsContents=this.contents.querySelector("#keyframeControlsContents"),this.valuesTabBtn=this.contents.querySelector("#valuesTabBtn"),this.interpTabBtn=this.contents.querySelector("#interpTabBtn"),this.valuesTabBtn.addEventListener("click",this.onTabBtnClick),this.interpTabBtn.addEventListener("click",this.onTabBtnClick),(0,n.Y)(this.valuesTabBtn,!0),(0,n.Y)(this.interpTabBtn,!1),this.selectKeyframeMsg=this.contents.querySelector("#selectKeyframeMsg"),this.interpolationTab=this.contents.querySelector("#interpolationTab"),this.posXValueInputContainer=this.contents.querySelector("#posXValueInputContainer"),this.posYValueInputContainer=this.contents.querySelector("#posYValueInputContainer"),this.posZValueInputContainer=this.contents.querySelector("#posZValueInputContainer"),this.lookAtXValueInputContainer=this.contents.querySelector("#lookAtXValueInputContainer"),this.lookAtYValueInputContainer=this.contents.querySelector("#lookAtYValueInputContainer"),this.lookAtZValueInputContainer=this.contents.querySelector("#lookAtZValueInputContainer"),this.bankValueInputContainer=this.contents.querySelector("#bankValueInputContainer"),this.posXValueInput=this.contents.querySelector("#posXValueInput"),this.posYValueInput=this.contents.querySelector("#posYValueInput"),this.posZValueInput=this.contents.querySelector("#posZValueInput"),this.lookAtXValueInput=this.contents.querySelector("#lookAtXValueInput"),this.lookAtYValueInput=this.contents.querySelector("#lookAtYValueInput"),this.lookAtZValueInput=this.contents.querySelector("#lookAtZValueInput"),this.bankValueInput=this.contents.querySelector("#bankValueInput"),this.bankRotationValCanvas=this.contents.querySelector("#bankRotationValCanvas"),this.bankRotationValCanvasCtx=this.bankRotationValCanvas.getContext("2d");const r=this.bankRotationValCanvasCtx.createLinearGradient(20,20,20,60);r.addColorStop(0,"#494949"),r.addColorStop(1,"#2f2f2f"),this.bankRotationValCanvasCtx.fillStyle=r,this.bankRotationValCanvasCtx.save(),this.lockPerspectiveDiv=this.contents.querySelector("#lockPerspective"),this.lockPerspectiveBracket=this.contents.querySelector("#lockPerspectiveBracket"),this.lockPerspectiveBtn=this.contents.querySelector("#lockPerspectiveBtn"),this.lockPerspectiveBtn.title="Maintain this keyframe's rotation when modifying its position.",this.lockPerspectiveBtn.onclick=()=>{this.lockPerspective=!this.lockPerspective,(0,n.Y)(this.lockPerspectiveBtn,this.lockPerspective)},(0,n.Y)(this.lockPerspectiveBtn,this.lockPerspective),this.interpInTypeBtns=new n.h2("Interpolation In",["Ease","Linear","Hold"]),this.interpInTypeBtns.onselectedchange=()=>{if(this.interpInTypeBtns.selectedIndex!==Wt.Ease?this.easeInSlider.elem.style.display="none":this.easeInSlider.elem.style.display="grid",-1!==this.interpInTypeBtns.selectedIndex&&this.timeline.selectedKeyframeIcons.length){let e=!1;for(const t of this.timeline.selectedKeyframeIcons)t.keyframesMap.forEach((s,n)=>{let i;s.interpInType=this.interpInTypeBtns.selectedIndex,this.animation.loop&&(t.type===jt.Loop_End?i=this.timeline.getStartKeyframeForTrack(n):t.type===jt.Start&&(i=this.timeline.getLoopEndKeyframeForTrack(n))),i&&(e=!0,i.interpInType=this.interpInTypeBtns.selectedIndex)}),t.updatePaths();if(e)for(const e of this.timeline.keyframeIcons)e.updatePaths();this.timeline.draw(),this.updatePreviewSteps()}},this.interpInTypeBtns.options.forEach(e=>{e.addEventListener("click",()=>this.saveState())}),this.interpOutTypeBtns=new n.h2("Interpolation Out",["Ease","Linear","Hold"]),this.interpOutTypeBtns.onselectedchange=()=>{if(this.interpOutTypeBtns.selectedIndex!==Wt.Ease?this.easeOutSlider.elem.style.display="none":this.easeOutSlider.elem.style.display="grid",-1!==this.interpOutTypeBtns.selectedIndex&&this.timeline.selectedKeyframeIcons.length){let e=!1;for(const t of this.timeline.selectedKeyframeIcons)t.keyframesMap.forEach((s,n)=>{let i;s.interpOutType=this.interpOutTypeBtns.selectedIndex,this.animation.loop&&(t.type===jt.Loop_End?i=this.timeline.getStartKeyframeForTrack(n):t.type===jt.Start&&(i=this.timeline.getLoopEndKeyframeForTrack(n))),i&&(e=!0,i.interpOutType=this.interpOutTypeBtns.selectedIndex)}),t.updatePaths();if(e)for(const e of this.timeline.keyframeIcons)e.updatePaths();this.timeline.draw(),this.updatePreviewSteps()}},this.interpOutTypeBtns.options.forEach(e=>{e.addEventListener("click",()=>this.saveState())}),this.interpolationTab.appendChild(this.interpInTypeBtns.elem),this.interpolationTab.appendChild(this.interpOutTypeBtns.elem),this.easeInSlider=new n.Ap,this.easeInSlider.setLabel("Ease In Amount"),this.easeInSlider.setRange(0,1),this.easeInSlider.setValue(1),this.easeInSlider.onvalue=e=>{if(this.timeline.selectedKeyframeIcons.length){for(const t of this.timeline.selectedKeyframeIcons)t.keyframesMap.forEach((s,n)=>{let i;s.easeInCoeff=e,this.animation.loop&&(t.type===jt.Loop_End?i=this.timeline.getStartKeyframeForTrack(n):t.type===jt.Start&&(i=this.timeline.getLoopEndKeyframeForTrack(n))),i&&(i.easeInCoeff=e)});this.updatePreviewSteps()}},this.easeInSlider.elem.addEventListener("mousedown",()=>{this.easeInSlider.elem.dataset.prevValue=this.easeInSlider.getValue().toFixed(2)}),this.easeInSlider.elem.addEventListener("mouseup",()=>{this.easeInSlider.elem.dataset.prevValue&&this.easeInSlider.elem.dataset.prevValue!==this.easeInSlider.getValue().toFixed(2)&&this.saveState()}),this.interpolationTab.appendChild(this.easeInSlider.elem),this.easeOutSlider=new n.Ap,this.easeOutSlider.setLabel("Ease Out Amount"),this.easeOutSlider.setRange(0,1),this.easeOutSlider.setValue(1),this.easeOutSlider.onvalue=e=>{if(this.timeline.selectedKeyframeIcons.length){for(const t of this.timeline.selectedKeyframeIcons)t.keyframesMap.forEach((s,n)=>{let i;s.easeOutCoeff=e,this.animation.loop&&(t.type===jt.Loop_End?i=this.timeline.getStartKeyframeForTrack(n):t.type===jt.Start&&(i=this.timeline.getLoopEndKeyframeForTrack(n))),i&&(i.easeOutCoeff=e)});this.updatePreviewSteps()}},this.easeOutSlider.elem.addEventListener("mousedown",()=>{this.easeOutSlider.elem.dataset.prevValue=this.easeOutSlider.getValue().toFixed(2)}),this.easeOutSlider.elem.addEventListener("mouseup",()=>{this.easeOutSlider.elem.dataset.prevValue&&this.easeOutSlider.elem.dataset.prevValue!==this.easeOutSlider.getValue().toFixed(2)&&this.saveState()}),this.interpolationTab.appendChild(this.easeOutSlider.elem),this.posXValueInput.onchange=()=>this.onChangeValueInput(this.posXValueInput),this.posYValueInput.onchange=()=>this.onChangeValueInput(this.posYValueInput),this.posZValueInput.onchange=()=>this.onChangeValueInput(this.posZValueInput),this.lookAtXValueInput.onchange=()=>this.onChangeValueInput(this.lookAtXValueInput),this.lookAtYValueInput.onchange=()=>this.onChangeValueInput(this.lookAtYValueInput),this.lookAtZValueInput.onchange=()=>this.onChangeValueInput(this.lookAtZValueInput),this.bankValueInput.onchange=()=>this.onChangeValueInput(this.bankValueInput),this.zoomOutBtn=this.contents.querySelector("#zoomOutBtn"),this.zoomOutBtn.insertAdjacentElement("afterbegin",(0,n.MC)('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 -110 700 700"><g><path d="m579.16 503.12-112.61-144.38c35.895-37.285 56.285-86.812 57.051-138.56 0.76172-51.75-18.156-101.86-52.934-140.18-34.777-38.332-82.812-62.02-134.39-66.277-51.578-4.2578-102.85 11.238-143.44 43.348-40.59 32.109-67.469 78.438-75.199 129.61-7.7305 51.172 4.2695 103.37 33.562 146.04 29.297 42.664 73.707 72.609 124.24 83.777 50.535 11.164 103.43 2.7188 147.97-23.629l112.44 144.11c4.5156 5.7656 11.145 9.4922 18.418 10.363 7.2734 0.87109 14.594-1.1914 20.344-5.7266 5.6758-4.5234 9.3359-11.105 10.188-18.316 0.85156-7.207-1.1758-14.461-5.6367-20.184zm-243.52-129.59c-43.453 4.6094-86.871-9.0391-119.87-37.688-33-28.645-52.613-69.715-54.152-113.39-1.543-43.668 15.133-86.02 46.031-116.92 30.898-30.898 73.246-47.57 116.92-46.031s84.742 21.152 113.39 54.152c28.648 33 42.297 76.414 37.684 119.87-3.8008 35.828-19.773 69.27-45.25 94.746-25.477 25.477-58.918 41.449-94.75 45.254z"/><path d="m226.19 194.43h186.64c12.469 0 22.574 12.445 22.574 22.531 0 12.445-10.105 22.531-22.574 22.531h-186.64c-12.469 0-22.574-12.445-22.574-22.531 0-12.445 10.105-22.531 22.574-22.531z"/></g></svg>').querySelector("svg")),this.zoomOutBtn.onclick=()=>this.zoomOut(),this.zoomInBtn=this.contents.querySelector("#zoomInBtn"),this.zoomInBtn.insertAdjacentElement("afterbegin",(0,n.MC)('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 -110 700 700"><g><path d="m579.16 503.12-112.61-144.38c35.895-37.285 56.285-86.812 57.051-138.56 0.76172-51.75-18.156-101.86-52.934-140.18-34.777-38.332-82.812-62.02-134.39-66.277-51.578-4.2578-102.85 11.238-143.44 43.348-40.59 32.109-67.469 78.438-75.199 129.61-7.7305 51.172 4.2695 103.37 33.562 146.04 29.297 42.664 73.707 72.609 124.24 83.777 50.535 11.164 103.43 2.7188 147.97-23.629l112.44 144.11c4.5156 5.7656 11.145 9.4922 18.418 10.363 7.2734 0.87109 14.594-1.1914 20.344-5.7266 5.6758-4.5234 9.3359-11.105 10.188-18.316 0.85156-7.207-1.1758-14.461-5.6367-20.184zm-243.52-129.59c-43.453 4.6094-86.871-9.0391-119.87-37.688-33-28.645-52.613-69.715-54.152-113.39-1.543-43.668 15.133-86.02 46.031-116.92 30.898-30.898 73.246-47.57 116.92-46.031s84.742 21.152 113.39 54.152c28.648 33 42.297 76.414 37.684 119.87-3.8008 35.828-19.773 69.27-45.25 94.746-25.477 25.477-58.918 41.449-94.75 45.254z"/><path d="m401.45 202.91h-67.375v-69.215c0.3125-3.9648-1.0469-7.8789-3.7461-10.797-2.6992-2.9219-6.4961-4.582-10.473-4.582-3.9766 0-7.7734 1.6602-10.473 4.582-2.6992 2.918-4.0547 6.832-3.7461 10.797v69.211h-67.375v0.003906c-5.1562 0-9.9219 2.75-12.504 7.2188-2.5781 4.4648-2.5781 9.9688 0 14.438 2.582 4.4648 7.3477 7.2188 12.504 7.2188h67.375v69.211c0.58203 7.4219 6.7773 13.145 14.219 13.145 7.4453 0 13.637-5.7227 14.219-13.145v-69.211h67.375c5.1602 0 9.9258-2.7539 12.504-7.2188 2.5781-4.4688 2.5781-9.9727 0-14.438-2.5781-4.4688-7.3438-7.2188-12.504-7.2188z"/></g></svg>').querySelector("svg")),this.zoomInBtn.onclick=()=>this.zoomIn(),this.playAnimationBtn=this.contents.querySelector("#playAnimationBtn"),this.stopAnimationBtn=this.contents.querySelector("#stopAnimationBtn"),this.prevKeyframeBtn=this.contents.querySelector("#prevKeyframeBtn"),this.prevKeyframeBtn.title="Jump to the previous keyframe on the timeline. Hotkey: J",this.nextKeyframeBtn=this.contents.querySelector("#nextKeyframeBtn"),this.nextKeyframeBtn.title="Jump to the next keyframe on the timeline. Hotkey: K",this.playAnimationBtn.onclick=e=>{e.stopPropagation(),this.playAnimation(),this.stopAnimationBtn.focus()},this.stopAnimationBtn.onclick=e=>{e.stopPropagation(),this.stopAnimation(),this.playAnimationBtn.focus()},this.prevKeyframeBtn.onclick=e=>{e.stopPropagation(),this.prevKeyframe()},this.nextKeyframeBtn.onclick=e=>{e.stopPropagation(),this.nextKeyframe()},this.timelineElementsCanvas.addEventListener("mousedown",e=>{const t=this.timeline.selectedKeyframeIcons.length;this.timeline.onMouseDown(e),this.timeline.playheadGrabbed?(this.playheadTimePositionInput.value=this.timeline.getPlayheadTimeSeconds(),this.livePreviewCheckbox.checked&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs())):t<this.timeline.selectedKeyframeIcons.length&&this.saveState()});const a=document.querySelectorAll("#studioPanelContents .StudioNumericInput");for(let e=0;e<a.length;e++){const t=a[e];t.addEventListener("mousedown",e=>{t.hasAttribute("disabled")||(this.selectedNumericInput=t)})}document.addEventListener("mousemove",e=>{if(1===e.buttons&&this.timeline&&this.playheadTimePositionInput&&!this.studioCameraController.isAnimationPlaying)if(this.selectedNumericInput&&!this.selectedNumericInput.classList.contains("manual-entry")){if(parseFloat(this.selectedNumericInput.step)<1){const t=(e.movementX-e.movementY)*parseFloat(this.selectedNumericInput.step);this.selectedNumericInput.value=(parseFloat(this.selectedNumericInput.value)+t).toFixed(2)}else{let t=(e.movementX-e.movementY)*parseInt(this.selectedNumericInput.step);e.ctrlKey?t*=.1:e.shiftKey&&(t*=10),this.selectedNumericInput.value=(parseInt(this.selectedNumericInput.value)+t).toString()}this.selectedNumericInput.dispatchEvent(new Event("change",{bubbles:!0}))}else this.timeline.onMouseMove(e),this.timeline.playheadGrabbed&&(this.playheadTimePositionInput.value=this.timeline.getPlayheadTimeSeconds()),this.timeline.grabbedIcon&&this.updatePreviewSteps(),this.livePreviewCheckbox.checked&&(this.timeline.grabbedIcon||this.timeline.playheadGrabbed)&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs())}),document.addEventListener("mouseup",e=>{(this.timeline.hasGrabbedIconMoved()||this.timeline.selectedKeyframeIcons.length)&&this.saveState();for(let e=0;e<a.length;e++)a[e].classList.remove("manual-entry");this.timeline.onMouseUp(),this.selectedNumericInput&&(e.target===this.selectedNumericInput&&this.selectedNumericInput.classList.add("manual-entry"),this.selectedNumericInput!==this.playheadTimePositionInput&&this.saveState(),this.selectedNumericInput=void 0)}),this.mainPanel.addEventListener("wheel",e=>{e.preventDefault(),e.ctrlKey?e.deltaY<0?this.zoomIn():e.deltaY>0&&this.zoomOut():this.timeLineContainerElement.scrollBy(e.deltaY,0)}),this.timelineElementsCanvas.addEventListener("keyframeSelected",e=>this.onKeyframeIconSelected()),this.timelineElementsCanvas.addEventListener("keyframeDeselected",e=>this.onKeyframeIconDeselected()),this.timelineElementsCanvas.addEventListener("keyframeIconMovedEvent",e=>{for(const e of this.timeline.selectedKeyframeIcons)e.keyframesMap.forEach((e,t)=>{this.getTrackByType(this.animation,t).reSort()})}),this.newAnimation(),this.studioPanelContents.removeAttribute("hidden"),window.addEventListener("resize",()=>{this.rescaleTimelineContainer()}),this.loadStudioSettings()}record(){ns.isSupported()?this.recordVideo():this.playAnimation(!0)}async recordVideo(){this.disableControls(),this.animationManager.initAnimationPlayback(this.animation,0),this.studioCameraController.isAnimationPlaying=!0,this.viewer.externalControl=!0,this.videoRecorder=new ns(this.viewer,this.animationManager),await this.videoRecorder.render(),null===this.videoRecorder||this.videoRecorder.aborted||this.stopAnimation()}playAnimation(e){if(this.timeline.keyframeIcons.length>1)if(this.disableControls(),this.playAnimationBtn.setAttribute("hidden",""),this.stopAnimationBtn.removeAttribute("disabled"),this.stopAnimationBtn.classList.remove("disabled"),this.stopAnimationBtn.removeAttribute("hidden"),e){const e=document.createElement("canvas");e.width=window.innerWidth,e.height=window.innerHeight,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.zIndex="1024";const t=e.getContext("2d");t.font="72px monospace",t.textAlign="center",t.textBaseline="middle",t.lineWidth=5;const s="#ffffff",n="#121212";this.ui.elem.appendChild(e),this.elem.style.display="none",this.ui.toggleUI(!1);let i=2e3;const r=e.width/2,a=e.height/2,o=setInterval(()=>{i-=10;const l=i/1e3;t.save(),t.clearRect(0,0,e.width,e.height),t.fillStyle=n,t.strokeStyle=n,t.beginPath(),t.save(),t.translate(r+3,a+3),t.rotate(-Math.PI/2),t.translate(-(r+3),-(a+3)),t.arc(r+3,a+3,100,0,i%1e3/1e3*(2*Math.PI)),t.stroke(),t.restore(),t.fillText(Math.ceil(l).toFixed(0),r+3,a+3),t.fillStyle=s,t.strokeStyle=s,t.beginPath(),t.save(),t.translate(r,a),t.rotate(-Math.PI/2),t.translate(-r,-a),t.arc(r,a,100,0,i%1e3/1e3*(2*Math.PI)),t.stroke(),t.restore(),t.fillText(Math.ceil(l).toFixed(0),r,a),t.restore(),i<=0&&(this.ui.elem.removeChild(e),this.animationManager.initAnimationPlayback(this.animation,0),this.studioCameraController.isAnimationPlaying=!0,clearInterval(o))},10)}else{let e=this.timeline.getPlayheadTimeMs();!this.animation.loop&&e>=this.timeline.getLastKeyframeTimeMs()&&(e=0),this.animationManager.initAnimationPlayback(this.animation,e),this.studioCameraController.isAnimationPlaying=!0}}stopAnimation(){this.studioCameraController.isAnimationPlaying&&(this.studioCameraController.isAnimationPlaying=!1,this.enableControls(),this.playAnimationBtn.removeAttribute("hidden"),this.stopAnimationBtn.setAttribute("hidden",""),this.ui.toggleUI(!0),this.elem.style.display="",this.viewer.externalControl=!1,null!==this.videoRecorder&&(this.videoRecorder.aborted=!0,this.videoRecorder=null))}drawWorldHelpers(e){if("none"!==this.elem.style.display&&this.showPreviewLineCheckbox.checked&&this.animationPreviewSteps.length>1){for(let t=0;t<=this.animationPreviewSteps.length-2;t++)(0,r.NB)((0,r.AN)(),e,this.animationPreviewSteps[t].pos,this.animationPreviewSteps[t+1].pos,this.previewLineColor),t%30==0&&(h.jb(this.scratchVec3a,this.animationPreviewSteps[t].lookAtPos,this.animationPreviewSteps[t].pos),h.S8(this.scratchVec3a,this.scratchVec3a),h.hs(this.scratchVec3a,this.scratchVec3a,100),h.WQ(this.scratchVec3b,this.scratchVec3a,this.animationPreviewSteps[t].pos),(0,r.NB)((0,r.AN)(),e,this.animationPreviewSteps[t].pos,this.scratchVec3b,this.previewLineLookAtColor),d.xI(this.scratchMat,this.animationPreviewSteps[t].pos,this.animationPreviewSteps[t].lookAtPos,l.PI),this.animationPreviewSteps[t].lookAtPos[0]<0?d.Qr(this.scratchMat,this.scratchMat,-this.animationPreviewSteps[t].bank):d.Qr(this.scratchMat,this.scratchMat,this.animationPreviewSteps[t].bank),(0,l.eh)(this.scratchVec3a,this.scratchMat),h.C(this.scratchVec3c,l.PI),h.x6(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[2]),h.Z8(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[1]),h.eL(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[0]),this.scratchVec3c[2]=0,h.S8(this.scratchVec3c,this.scratchVec3c),h.Ln(this.scratchVec3c,this.animationPreviewSteps[t].pos,this.scratchVec3c,100),(0,r.NB)((0,r.AN)(),e,this.animationPreviewSteps[t].pos,this.scratchVec3c,this.previewLineYAxisColor));for(const t of this.timeline.keyframeIcons){const s=Math.floor(t.getT()/ss.PREVIEW_STEP_TIME_MS),n=t.selected?this.previewLineKfDotSelectedColor:this.previewLineKfDotColor;this.timelineMode===Zt.Consolidated||t.keyframesMap.has(zt.posXTrack)||t.keyframesMap.has(zt.posYTrack)||t.keyframesMap.has(zt.posZTrack)?(0,r.RM)((0,r.AN)(),e,this.animationPreviewSteps[s].pos,n,16):t.keyframesMap.has(zt.lookAtXTrack)||t.keyframesMap.has(zt.lookAtYTrack)||t.keyframesMap.has(zt.lookAtZTrack)?(0,r.RM)((0,r.AN)(),e,this.animationPreviewSteps[s].lookAtPos,n,16):(d.xI(this.scratchMat,this.animationPreviewSteps[s].pos,this.animationPreviewSteps[s].lookAtPos,l.PI),this.animationPreviewSteps[s].lookAtPos[0]<0?d.Qr(this.scratchMat,this.scratchMat,-this.animationPreviewSteps[s].bank):d.Qr(this.scratchMat,this.scratchMat,this.animationPreviewSteps[s].bank),(0,l.eh)(this.scratchVec3a,this.scratchMat),h.C(this.scratchVec3c,l.PI),h.x6(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[2]),h.Z8(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[1]),h.eL(this.scratchVec3c,this.scratchVec3c,l.i0,-this.scratchVec3a[0]),this.scratchVec3c[2]=0,h.S8(this.scratchVec3c,this.scratchVec3c),h.Ln(this.scratchVec3c,this.animationPreviewSteps[s].pos,this.scratchVec3c,100),(0,r.RM)((0,r.AN)(),e,this.scratchVec3c,n,16))}}}movePlayhead(e){const t=parseFloat(this.timeline.getPlayheadTimeSeconds())+e;t*$t>this.timeline.getTimelineLengthMs()&&(this.timelineLengthInput.value=t.toFixed(2),this.timelineLengthInput.dispatchEvent(new Event("change",{bubbles:!0}))),this.playheadTimePositionInput.value=t.toFixed(2),this.playheadTimePositionInput.dispatchEvent(new Event("change",{bubbles:!0}))}prevKeyframe(){this.timeline.jumpToPreviousKeyframe(),this.playheadTimePositionInput.value=this.timeline.getPlayheadTimeSeconds(),this.livePreviewCheckbox.checked&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs())}nextKeyframe(){this.timeline.jumpToNextKeyframe(),this.playheadTimePositionInput.value=this.timeline.getPlayheadTimeSeconds(),this.livePreviewCheckbox.checked&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs())}redo(){this.currentStateIndex<this.studioStates.length-1&&(this.currentStateIndex++,this.loadState(this.studioStates[this.currentStateIndex]),this.undoBtn.removeAttribute("disabled"),this.undoBtn.classList.remove("disabled"),this.currentStateIndex===this.studioStates.length-1&&(this.redoBtn.setAttribute("disabled",""),this.redoBtn.classList.add("disabled")))}undo(){this.currentStateIndex>0&&(this.currentStateIndex--,this.loadState(this.studioStates[this.currentStateIndex]),this.redoBtn.removeAttribute("disabled"),this.redoBtn.classList.remove("disabled"),0===this.currentStateIndex&&(this.undoBtn.setAttribute("disabled",""),this.undoBtn.classList.add("disabled")))}saveState(){if(!this.animation||!this.timeline)return;const e=JSON.stringify(this.animation);if(this.studioStates.length){const t=this.studioStates[this.currentStateIndex],s=this.timeline.getSelectedKeyframeIndices();if(JSON.stringify(t.animation)===e&&t.timelineLengthMs===this.timeline.getTimelineLengthMs()&&s.every(e=>t.selectedKeyframeIndices.includes(e))&&t.selectedKeyframeIndices.every(e=>s.includes(e)))return}this.currentStateIndex>-1&&this.currentStateIndex<this.studioStates.length-1&&(this.studioStates.length=this.currentStateIndex+1,this.redoBtn.setAttribute("disabled",""),this.redoBtn.classList.add("disabled"));const t={animation:JSON.parse(e),timelineLengthMs:this.timeline.getTimelineLengthMs(),timelineMode:this.timelineMode,selectedKeyframeIndices:this.timeline.getSelectedKeyframeIndices()};this.studioStates.push(t),this.currentStateIndex++,this.currentStateIndex>0&&(this.undoBtn.removeAttribute("disabled"),this.undoBtn.classList.remove("disabled")),this.autoSaveCheckbox.checked&&this.saveAnimation()}loadState(e){const t=JSON.parse(JSON.stringify(e.animation));if(void 0===t.loop&&(t.loop=!1),0===t.posXTrack.keyframes.length)return void this.newAnimation();const s=e=>{void 0===e.easeInCoeff&&(e.easeInCoeff=1,e.easeOutCoeff=1),void 0===e.interpInType&&(e.interpInType=Wt.Ease),void 0===e.interpOutType&&(e.interpOutType=Wt.Ease)};t.posXTrack.keyframes.forEach(e=>s(e)),t.posYTrack.keyframes.forEach(e=>s(e)),t.posZTrack.keyframes.forEach(e=>s(e)),t.lookAtXTrack.keyframes.forEach(e=>s(e)),t.lookAtYTrack.keyframes.forEach(e=>s(e)),t.lookAtZTrack.keyframes.forEach(e=>s(e)),t.bankTrack.keyframes.forEach(e=>s(e)),this.timelineMode=e.timelineMode,this.timelineModeSelect.selectedIndex=e.timelineMode,this.timelineModeSelect.dispatchEvent(new Event("change",{bubbles:!0})),this.showEditingUI(),this.rescaleTimelineContainer(),this.studioHelpText.dataset.default="Move the playhead to the desired time, then move the camera and press Enter to place a keyframe.",this.animation.posXTrack.keyframes=t.posXTrack.keyframes,this.animation.posYTrack.keyframes=t.posYTrack.keyframes,this.animation.posZTrack.keyframes=t.posZTrack.keyframes,this.animation.lookAtXTrack.keyframes=t.lookAtXTrack.keyframes,this.animation.lookAtYTrack.keyframes=t.lookAtYTrack.keyframes,this.animation.lookAtZTrack.keyframes=t.lookAtZTrack.keyframes,this.animation.bankTrack.keyframes=t.bankTrack.keyframes,this.animation.loop=t.loop,this.reAddAllKeyframeIcons(),this.timeline.setScaleAndDrawMarkers(e.timelineLengthMs),this.timelineLengthInput.value=this.timeline.getTimelineLengthSeconds(),this.timelineLengthInput.dispatchEvent(new Event("change",{bubbles:!0})),(0,n.Y)(this.loopAnimationBtn,this.animation.loop),this.timeline.reselectKeyframes(e.selectedKeyframeIndices),0===this.timeline.selectedKeyframeIcons.length?this.hideKeyframeControls():this.onKeyframeIconSelected(),this.timeline.draw(),this.updatePreviewSteps()}reAddAllKeyframeIcons(){this.timeline.selectedKeyframeIcons=[],this.timeline.keyframeIcons=[];const e=(e,t)=>0===e?jt.Start:this.animation.loop&&e===t.keyframes.length-1?jt.Loop_End:jt.Default,t=(e,t,s,n,i)=>{if(s.length!==n.length)throw"Mismatched track/kf array length";const r=new Map;for(let e=0;e<s.length;e++)r.set(s[e],n[e]);this.timeline.addKeyframeIcon(r,e,i,t)};if(this.timelineMode===Zt.Consolidated)for(let s=0;s<this.animation.posXTrack.keyframes.length;s++)t(this.animation.posXTrack.keyframes[s].time,e(s,this.animation.posXTrack),[zt.posXTrack,zt.posYTrack,zt.posZTrack,zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack,zt.bankTrack],[this.animation.posXTrack.keyframes[s],this.animation.posYTrack.keyframes[s],this.animation.posZTrack.keyframes[s],this.animation.lookAtXTrack.keyframes[s],this.animation.lookAtYTrack.keyframes[s],this.animation.lookAtZTrack.keyframes[s],this.animation.bankTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS);else if(this.timelineMode===Zt.Position_LookAt_Bank){for(let s=0;s<this.animation.posXTrack.keyframes.length;s++)t(this.animation.posXTrack.keyframes[s].time,e(s,this.animation.posXTrack),[zt.posXTrack,zt.posYTrack,zt.posZTrack],[this.animation.posXTrack.keyframes[s],this.animation.posYTrack.keyframes[s],this.animation.posZTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS);for(let s=0;s<this.animation.lookAtXTrack.keyframes.length;s++)t(this.animation.lookAtXTrack.keyframes[s].time,e(s,this.animation.lookAtXTrack),[zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack],[this.animation.lookAtXTrack.keyframes[s],this.animation.lookAtYTrack.keyframes[s],this.animation.lookAtZTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT);for(let s=0;s<this.animation.bankTrack.keyframes.length;s++)t(this.animation.bankTrack.keyframes[s].time,e(s,this.animation.bankTrack),[zt.bankTrack],[this.animation.bankTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT)}else{if(this.timelineMode!==Zt.Full)throw"Bad timelineMode";for(let s=0;s<this.animation.posXTrack.keyframes.length;s++)t(this.animation.posXTrack.keyframes[s].time,e(s,this.animation.posXTrack),[zt.posXTrack],[this.animation.posXTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS);for(let s=0;s<this.animation.posYTrack.keyframes.length;s++)t(this.animation.posYTrack.keyframes[s].time,e(s,this.animation.posYTrack),[zt.posYTrack],[this.animation.posYTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT);for(let s=0;s<this.animation.posZTrack.keyframes.length;s++)t(this.animation.posZTrack.keyframes[s].time,e(s,this.animation.posZTrack),[zt.posZTrack],[this.animation.posZTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT);for(let s=0;s<this.animation.lookAtXTrack.keyframes.length;s++)t(this.animation.lookAtXTrack.keyframes[s].time,e(s,this.animation.lookAtXTrack),[zt.lookAtXTrack],[this.animation.lookAtXTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+3*es.TRACK_HEIGHT);for(let s=0;s<this.animation.lookAtYTrack.keyframes.length;s++)t(this.animation.lookAtYTrack.keyframes[s].time,e(s,this.animation.lookAtYTrack),[zt.lookAtYTrack],[this.animation.lookAtYTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+4*es.TRACK_HEIGHT);for(let s=0;s<this.animation.lookAtZTrack.keyframes.length;s++)t(this.animation.lookAtZTrack.keyframes[s].time,e(s,this.animation.lookAtZTrack),[zt.lookAtZTrack],[this.animation.lookAtZTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+5*es.TRACK_HEIGHT);for(let s=0;s<this.animation.bankTrack.keyframes.length;s++)t(this.animation.bankTrack.keyframes[s].time,e(s,this.animation.bankTrack),[zt.bankTrack],[this.animation.bankTrack.keyframes[s]],es.KEYFRAME_ICONS_BASE_Y_POS+6*es.TRACK_HEIGHT)}}getTrackByType(e,t){if(t===zt.posXTrack)return e.posXTrack;if(t===zt.posYTrack)return e.posYTrack;if(t===zt.posZTrack)return e.posZTrack;if(t===zt.lookAtXTrack)return e.lookAtXTrack;if(t===zt.lookAtYTrack)return e.lookAtYTrack;if(t===zt.lookAtZTrack)return e.lookAtZTrack;if(t===zt.bankTrack)return e.bankTrack;throw"whoops"}onChangeValueInput(e){if(this.timeline.selectedKeyframeIcons.length>0&&e.value){let t=parseInt(e.value);if(!Number.isNaN(t)){const s=parseInt(e.dataset.track,10),n=this.timeline.getSelectedKeyframesForTrack(s);if(e.dataset.aggregateOpMode&&(t-=parseInt(e.dataset.prevValue)),s===zt.bankTrack)t*=l.wZ.DEG_TO_RAD;else if(this.lockPerspective){let n=t;if(e.dataset.aggregateOpMode||(n-=parseInt(e.dataset.prevValue)),s===zt.posXTrack&&"hidden"!==this.lookAtXValueInputContainer.style.visibility){const e=parseInt(this.lookAtXValueInput.value)+n;this.lookAtXValueInput.value=e.toString(),this.lookAtXValueInput.dispatchEvent(new Event("change",{bubbles:!0}))}else if(s===zt.posYTrack&&"hidden"!==this.lookAtYValueInputContainer.style.visibility){const e=parseInt(this.lookAtYValueInput.value)+n;this.lookAtYValueInput.value=e.toString(),this.lookAtYValueInput.dispatchEvent(new Event("change",{bubbles:!0}))}else if(s===zt.posZTrack&&"hidden"!==this.lookAtZValueInputContainer.style.visibility){const e=parseInt(this.lookAtZValueInput.value)+n;this.lookAtZValueInput.value=e.toString(),this.lookAtZValueInput.dispatchEvent(new Event("change",{bubbles:!0}))}}for(const i of n)if(e.dataset.aggregateOpMode?this.getTrackByType(this.animation,s).setValue(i,i.value+t):this.getTrackByType(this.animation,s).setValue(i,t),s===zt.bankTrack){const e=this.animation.bankTrack.keyframes.indexOf(i)-1;let s;e>-1&&(s=this.animation.bankTrack.keyframes[e].value),this.drawBankRotationWheel(-t,s)}this.updatePreviewSteps(),this.livePreviewCheckbox.checked&&this.goToPreviewStepAtTime(this.timeline.getPlayheadTimeMs()),e.dataset.prevValue=e.value.toString()}}}getValueInput(e){if(e===zt.posXTrack)return this.posXValueInput;if(e===zt.posYTrack)return this.posYValueInput;if(e===zt.posZTrack)return this.posZValueInput;if(e===zt.lookAtXTrack)return this.lookAtXValueInput;if(e===zt.lookAtYTrack)return this.lookAtYValueInput;if(e===zt.lookAtZTrack)return this.lookAtZValueInput;if(e===zt.bankTrack)return this.bankValueInput;throw"whoops"}drawBankRotationWheel(e,t){this.bankRotationValCanvasCtx.clearRect(0,0,this.bankRotationValCanvas.width,this.bankRotationValCanvas.height);const s=this.bankRotationValCanvas.width,i=this.bankRotationValCanvas.height;this.bankRotationValCanvasCtx.beginPath(),this.bankRotationValCanvasCtx.arc(s/2,i/2,30,0,l.wZ.TAU),this.bankRotationValCanvasCtx.fill(),this.bankRotationValCanvasCtx.strokeStyle="#a9a9a9",this.bankRotationValCanvasCtx.beginPath(),this.bankRotationValCanvasCtx.arc(s/2,i/2,23,0,l.wZ.TAU),this.bankRotationValCanvasCtx.stroke(),this.bankRotationValCanvasCtx.save(),this.bankRotationValCanvasCtx.translate(s/2,i/2),this.bankRotationValCanvasCtx.rotate(e),this.bankRotationValCanvasCtx.translate(-s/2,-i/2),this.bankRotationValCanvasCtx.strokeStyle=n.t$,this.bankRotationValCanvasCtx.lineWidth=3,this.bankRotationValCanvasCtx.beginPath(),this.bankRotationValCanvasCtx.moveTo(s/2,i/2-23),this.bankRotationValCanvasCtx.lineTo(s/2,i/2-23+15),this.bankRotationValCanvasCtx.stroke(),this.bankRotationValCanvasCtx.restore(),void 0!==t&&e!==t&&(t*=-1,this.bankRotationValCanvasCtx.save(),this.bankRotationValCanvasCtx.strokeStyle="#ebb23c",this.bankRotationValCanvasCtx.lineWidth=2,this.bankRotationValCanvasCtx.beginPath(),this.bankRotationValCanvasCtx.translate(s/2,i/2),this.bankRotationValCanvasCtx.rotate(-Math.PI/2),this.bankRotationValCanvasCtx.rotate(t),this.bankRotationValCanvasCtx.translate(-s/2,-i/2),this.bankRotationValCanvasCtx.arc(s/2,i/2,26.5,0,(e-t)%l.wZ.TAU,e<t),this.bankRotationValCanvasCtx.stroke(),this.bankRotationValCanvasCtx.restore())}onKeyframeIconSelected(){const e=this.timeline.selectedKeyframeIcons[0];let t,s=0,n=1,i=1,r=0,a=0;const o=(e,n)=>{const i=this.getValueInput(n);if(i.dataset.aggregateOpMode=s&n?"true":"",s|=n,i.dataset.aggregateOpMode)return i.value="0",void(i.dataset.prevValue="0");if(n===zt.bankTrack){i.value=(e.value*l.wZ.RAD_TO_DEG).toFixed(0).toString();const s=this.animation.bankTrack.keyframes.indexOf(e)-1;s>-1&&(t=this.animation.bankTrack.keyframes[s].value)}else i.value=e.value.toFixed(0).toString();i.dataset.prevValue=i.value};e.keyframesMap.forEach((e,t)=>{o(e,t),n=e.easeInCoeff,i=e.easeOutCoeff,r=e.interpInType,a=e.interpOutType});for(let e=1;e<this.timeline.selectedKeyframeIcons.length;e++)this.timeline.selectedKeyframeIcons[e].keyframesMap.forEach((e,t)=>{o(e,t),-1!==n&&e.easeInCoeff!==n&&(n=-1),-1!==i&&e.easeOutCoeff!==i&&(i=-1),-1!==r&&e.interpInType!==r&&(r=-1),-1!==a&&e.interpOutType!==a&&(a=-1)});this.selectKeyframeMsg.setAttribute("hidden",""),this.keyframeControlsContents.removeAttribute("hidden"),this.posXValueInputContainer.style.visibility="hidden",this.posYValueInputContainer.style.visibility="hidden",this.posZValueInputContainer.style.visibility="hidden",this.lookAtXValueInputContainer.style.visibility="hidden",this.lookAtYValueInputContainer.style.visibility="hidden",this.lookAtZValueInputContainer.style.visibility="hidden",this.bankValueInputContainer.style.visibility="hidden",this.lockPerspectiveBracket.style.visibility="hidden",this.lockPerspectiveDiv.style.visibility="hidden",s&zt.posXTrack&&(this.posXValueInputContainer.style.visibility=""),s&zt.posYTrack&&(this.posYValueInputContainer.style.visibility=""),s&zt.posZTrack&&(this.posZValueInputContainer.style.visibility=""),s&zt.lookAtXTrack&&(this.lookAtXValueInputContainer.style.visibility=""),s&zt.lookAtYTrack&&(this.lookAtYValueInputContainer.style.visibility=""),s&zt.lookAtZTrack&&(this.lookAtZValueInputContainer.style.visibility=""),s&zt.bankTrack&&(this.drawBankRotationWheel(-parseInt(this.bankValueInput.value)*l.wZ.DEG_TO_RAD,t),this.bankValueInputContainer.style.visibility=""),(s&zt.posXTrack&&s&zt.lookAtXTrack||s&zt.posYTrack&&s&zt.lookAtYTrack||s&zt.posZTrack&&s&zt.lookAtZTrack)&&(this.lockPerspectiveBracket.style.visibility="",this.lockPerspectiveDiv.style.visibility=""),-1!==n?this.easeInSlider.setValue(n):this.easeInSlider.elem.querySelector(".Slider").value="1",-1!==i?this.easeOutSlider.setValue(i):this.easeOutSlider.elem.querySelector(".Slider").value="1",this.interpInTypeBtns.setSelectedIndex(r),this.interpOutTypeBtns.setSelectedIndex(a)}onKeyframeIconDeselected(){0===this.timeline.selectedKeyframeIcons.length?this.hideKeyframeControls():this.onKeyframeIconSelected(),this.saveState()}hideKeyframeControls(){this.posXValueInput.value="",this.posYValueInput.value="",this.posZValueInput.value="",this.lookAtXValueInput.value="",this.lookAtYValueInput.value="",this.lookAtZValueInput.value="",this.bankValueInput.value="",this.keyframeControlsContents.setAttribute("hidden",""),this.lockPerspectiveBracket.style.visibility="hidden",this.lockPerspectiveDiv.style.visibility="hidden",this.selectKeyframeMsg.removeAttribute("hidden")}initTimeline(){this.studioHelpText.dataset.default="Move the playhead to the desired time, then move the camera and press Enter to place a keyframe.",this.studioHelpText.innerText=this.studioHelpText.dataset.default,this.showEditingUI(),this.rescaleTimelineContainer(),this.timeline.draw()}updatePreviewSteps(){this.animationManager.initAnimationPlayback(this.animation,0),this.animation.posXTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.posYTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.posZTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.lookAtXTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.lookAtYTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.lookAtZTrack.setAllCatmullRomTangents(this.animation.loop),this.animation.bankTrack.setAllCatmullRomTangents(this.animation.loop);const e=[];if(this.timeline.keyframeIcons.length>1)for(let t=0;t<=this.animationManager.durationMs;t+=ss.PREVIEW_STEP_TIME_MS){const s=new Yt;this.animationManager.getAnimFrame(s,t),e.push(s)}this.animationPreviewSteps=e}goToPreviewStepAtTime(e){this.animationManager.setElapsedTime(e);const t=new Yt;this.animationManager.getAnimFrame(t),this.studioCameraController.setToPosition(t)}onAnimationAdvance(e){this.playheadTimePositionInput.value=e.toFixed(2),this.playheadTimePositionInput.dispatchEvent(new Event("change",{bubbles:!0}))}deleteSelectedKeyframeIcons(){for(const e of this.timeline.selectedKeyframeIcons)if(e.type===jt.Default){const t=e.keyframesMap.get(zt.posXTrack),s=e.keyframesMap.get(zt.posYTrack),n=e.keyframesMap.get(zt.posZTrack),i=e.keyframesMap.get(zt.lookAtXTrack),r=e.keyframesMap.get(zt.lookAtYTrack),a=e.keyframesMap.get(zt.lookAtZTrack),o=e.keyframesMap.get(zt.bankTrack);if(t){const e=this.animation.posXTrack.keyframes.indexOf(t);e>0&&this.animation.posXTrack.keyframes.splice(e,1)}if(s){const e=this.animation.posYTrack.keyframes.indexOf(s);e>0&&this.animation.posYTrack.keyframes.splice(e,1)}if(n){const e=this.animation.posZTrack.keyframes.indexOf(n);e>0&&this.animation.posZTrack.keyframes.splice(e,1)}if(i){const e=this.animation.lookAtXTrack.keyframes.indexOf(i);e>0&&this.animation.lookAtXTrack.keyframes.splice(e,1)}if(r){const e=this.animation.lookAtYTrack.keyframes.indexOf(r);e>0&&this.animation.lookAtYTrack.keyframes.splice(e,1)}if(a){const e=this.animation.lookAtZTrack.keyframes.indexOf(a);e>0&&this.animation.lookAtZTrack.keyframes.splice(e,1)}if(o){const e=this.animation.bankTrack.keyframes.indexOf(o);e>0&&this.animation.bankTrack.keyframes.splice(e,1)}}this.timeline.deleteSelectedKeyframeIcons(),this.timeline.draw(),this.updatePreviewSteps(),this.saveState()}addKeyframesFromMat4(e){0===this.timeline.keyframeIcons.length&&this.initTimeline();let t=this.selectedTracks;if(0===t)return;const s=this.timeline.selectedKeyframeIcons.length&&this.timeline.playheadIsOnIcon(),n=this.timeline.getPlayheadTimeMs();let i=this.getkeyFrameSetFromMat4(e,n,Wt.Ease,this.animation.bankTrack);if(s){for(const e of this.timeline.selectedKeyframeIcons)if(e.getT()===n){if(e.type===jt.Start||e.type===jt.Loop_End){this.animation.posXTrack.keyframes[0].value=i.posXKf.value,this.animation.posYTrack.keyframes[0].value=i.posYKf.value,this.animation.posZTrack.keyframes[0].value=i.posZKf.value,this.animation.lookAtXTrack.keyframes[0].value=i.lookAtXKf.value,this.animation.lookAtYTrack.keyframes[0].value=i.lookAtYKf.value,this.animation.lookAtZTrack.keyframes[0].value=i.lookAtZKf.value,this.animation.bankTrack.keyframes[0].value=i.bankKf.value,this.animation.loop&&(this.animation.posXTrack.keyframes[this.animation.posXTrack.keyframes.length-1].value=i.posXKf.value,this.animation.posYTrack.keyframes[this.animation.posYTrack.keyframes.length-1].value=i.posYKf.value,this.animation.posZTrack.keyframes[this.animation.posZTrack.keyframes.length-1].value=i.posZKf.value,this.animation.lookAtXTrack.keyframes[this.animation.lookAtXTrack.keyframes.length-1].value=i.lookAtXKf.value,this.animation.lookAtYTrack.keyframes[this.animation.lookAtYTrack.keyframes.length-1].value=i.lookAtYKf.value,this.animation.lookAtZTrack.keyframes[this.animation.lookAtZTrack.keyframes.length-1].value=i.lookAtZKf.value,this.animation.bankTrack.keyframes[this.animation.bankTrack.keyframes.length-1].value=i.bankKf.value),t=0;break}e.keyframesMap.forEach((e,s)=>{0!==(t&s)&&(t^=s,s===zt.posXTrack?e.value=i.posXKf.value:s===zt.posYTrack?e.value=i.posYKf.value:s===zt.posZTrack?e.value=i.posZKf.value:s===zt.lookAtXTrack?e.value=i.lookAtXKf.value:s===zt.lookAtYTrack?e.value=i.lookAtYKf.value:s===zt.lookAtZTrack?e.value=i.lookAtZKf.value:s===zt.bankTrack&&(e.value=i.bankKf.value))})}if(0===t)return void this.updatePreviewSteps()}this.animation.loop&&n>this.timeline.getLastKeyframeTimeMs()&&(this.ensureTimelineLength(n+5e3),this.timeline.moveLoopEndframeIcons(n+5e3)),t&zt.posXTrack&&this.animation.posXTrack.addKeyframe(i.posXKf),t&zt.posYTrack&&this.animation.posYTrack.addKeyframe(i.posYKf),t&zt.posZTrack&&this.animation.posZTrack.addKeyframe(i.posZKf),t&zt.lookAtXTrack&&this.animation.lookAtXTrack.addKeyframe(i.lookAtXKf),t&zt.lookAtYTrack&&this.animation.lookAtYTrack.addKeyframe(i.lookAtYKf),t&zt.lookAtZTrack&&this.animation.lookAtZTrack.addKeyframe(i.lookAtZKf),t&zt.bankTrack&&this.animation.bankTrack.addKeyframe(i.bankKf);const r=n>this.timeline.getLastKeyframeTimeMs(),a=0===this.timeline.keyframeIcons.length?jt.Start:jt.Default,o=(e,t,s)=>{if(e.length!==t.length)throw"Mismatched track/kf array length";const i=new Map;for(let s=0;s<e.length;s++)i.set(e[s],t[s]);this.timeline.addKeyframeIcon(i,n,s,a)};if(this.timelineMode===Zt.Consolidated)o([zt.posXTrack,zt.posYTrack,zt.posZTrack,zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack,zt.bankTrack],[i.posXKf,i.posYKf,i.posZKf,i.lookAtXKf,i.lookAtYKf,i.lookAtZKf,i.bankKf],es.KEYFRAME_ICONS_BASE_Y_POS);else if(this.timelineMode===Zt.Position_LookAt_Bank)t&zt.posXTrack&&o([zt.posXTrack,zt.posYTrack,zt.posZTrack],[i.posXKf,i.posYKf,i.posZKf],es.KEYFRAME_ICONS_BASE_Y_POS),t&zt.lookAtXTrack&&o([zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack],[i.lookAtXKf,i.lookAtYKf,i.lookAtZKf],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT),t&zt.bankTrack&&o([zt.bankTrack],[i.bankKf],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT);else{if(this.timelineMode!==Zt.Full)throw"Bad timelineMode";t&zt.posXTrack&&o([zt.posXTrack],[i.posXKf],es.KEYFRAME_ICONS_BASE_Y_POS),t&zt.posYTrack&&o([zt.posYTrack],[i.posYKf],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT),t&zt.posZTrack&&o([zt.posZTrack],[i.posZKf],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT),t&zt.lookAtXTrack&&o([zt.lookAtXTrack],[i.lookAtXKf],es.KEYFRAME_ICONS_BASE_Y_POS+3*es.TRACK_HEIGHT),t&zt.lookAtYTrack&&o([zt.lookAtYTrack],[i.lookAtYKf],es.KEYFRAME_ICONS_BASE_Y_POS+4*es.TRACK_HEIGHT),t&zt.lookAtZTrack&&o([zt.lookAtZTrack],[i.lookAtZKf],es.KEYFRAME_ICONS_BASE_Y_POS+5*es.TRACK_HEIGHT),t&zt.bankTrack&&o([zt.bankTrack],[i.bankKf],es.KEYFRAME_ICONS_BASE_Y_POS+6*es.TRACK_HEIGHT)}this.updatePreviewSteps(),r?this.movePlayhead(3):this.timeline.selectKeyframeIconsAtTime(this.timeline.getPlayheadTimeMs()),this.timeline.draw(),this.saveState()}addLoopEndFrames(){const e=this.timeline.getLastKeyframeTimeMs()+5e3;function t(t){const{value:s,tangentIn:n,tangentOut:i,interpInType:r,interpOutType:a,easeInCoeff:o,easeOutCoeff:l}=t.keyframes[0];return{time:e,value:s,tangentIn:n,tangentOut:i,interpInType:r,interpOutType:a,easeInCoeff:o,easeOutCoeff:l}}const s=(s,n)=>{const i=new Map;for(let e=0;e<s.length;e++){const n=this.getTrackByType(this.animation,s[e]),r=t(n);i.set(s[e],r),n.addKeyframe(r)}this.timeline.addKeyframeIcon(i,e,n,jt.Loop_End)};if(this.timelineMode===Zt.Consolidated)s([zt.posXTrack,zt.posYTrack,zt.posZTrack,zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack,zt.bankTrack],es.KEYFRAME_ICONS_BASE_Y_POS);else if(this.timelineMode===Zt.Position_LookAt_Bank)s([zt.posXTrack,zt.posYTrack,zt.posZTrack],es.KEYFRAME_ICONS_BASE_Y_POS),s([zt.lookAtXTrack,zt.lookAtYTrack,zt.lookAtZTrack],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT),s([zt.bankTrack],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT);else{if(this.timelineMode!==Zt.Full)throw"Bad timelineMode";s([zt.posXTrack],es.KEYFRAME_ICONS_BASE_Y_POS),s([zt.posYTrack],es.KEYFRAME_ICONS_BASE_Y_POS+es.TRACK_HEIGHT),s([zt.posZTrack],es.KEYFRAME_ICONS_BASE_Y_POS+2*es.TRACK_HEIGHT),s([zt.lookAtXTrack],es.KEYFRAME_ICONS_BASE_Y_POS+3*es.TRACK_HEIGHT),s([zt.lookAtYTrack],es.KEYFRAME_ICONS_BASE_Y_POS+4*es.TRACK_HEIGHT),s([zt.lookAtZTrack],es.KEYFRAME_ICONS_BASE_Y_POS+5*es.TRACK_HEIGHT),s([zt.bankTrack],es.KEYFRAME_ICONS_BASE_Y_POS+6*es.TRACK_HEIGHT)}this.ensureTimelineLength(e)}ensureTimelineLength(e){e>this.timeline.getTimelineLengthMs()&&(this.timelineLengthInput.value=(e/$t).toFixed(2),this.timelineLengthInput.dispatchEvent(new Event("change",{bubbles:!0})))}deleteLoopEndFrames(){this.animation.posXTrack.keyframes.pop(),this.animation.posYTrack.keyframes.pop(),this.animation.posZTrack.keyframes.pop(),this.animation.lookAtXTrack.keyframes.pop(),this.animation.lookAtYTrack.keyframes.pop(),this.animation.lookAtZTrack.keyframes.pop(),this.animation.bankTrack.keyframes.pop(),this.timeline.deleteEndframeIcons()}newAnimation(){this.animation={posXTrack:new qt,posYTrack:new qt,posZTrack:new qt,lookAtXTrack:new qt,lookAtYTrack:new qt,lookAtZTrack:new qt,bankTrack:new qt,loop:!1},this.timeline.deselectAllKeyframeIcons(),this.timeline.keyframeIcons=[],this.playheadTimePositionInput.value="0",this.timelineLengthInput.value=(es.DEFAULT_LENGTH_MS/$t).toFixed(2),this.timelineLengthInput.dispatchEvent(new Event("change",{bubbles:!0})),this.selectedTracks|=zt.allTracks,this.hideEditingUI(),this.studioHelpText.dataset.default="Move the camera to the desired starting position and press Enter.",this.resetHelpText(),this.updatePreviewSteps()}resetHelpText(){this.persistHelpText||(this.studioHelpText.innerText=this.studioHelpText.dataset.default)}displayMessage(e){this.studioHelpText.innerText=e,this.persistHelpText=!0,window.setTimeout(()=>{this.persistHelpText=!1,this.resetHelpText()},3e3)}displayError(e,t,s){if(this.studioHelpText.innerText=e,this.studioHelpText.style.color="#ff4141",this.studioHelpText.style.fontWeight="700",this.persistHelpText=!0,t&&s){const e=document.createElement("a");e.rel="noopener noreferrer",e.target="_blank",e.href=s,e.innerText=t,this.studioHelpText.appendChild(e)}window.setTimeout(()=>{this.studioHelpText.style.color="",this.studioHelpText.style.fontWeight="",this.persistHelpText=!1,this.resetHelpText()},5e3)}loadAnimation(){const e=window.localStorage.getItem("studio-animation-"+m._h.getCurrentSceneDescId());if(e){const t=JSON.parse(e);this.isValidAnimationObj(t)?(this.loadState(this.createInitStudioState(t.animation)),this.displayMessage("Loaded animation from local storage."),this.saveState()):(console.error("Animation saved in localStorage is invalid and will be deleted. Existing animation JSON: ",e),window.localStorage.removeItem("studio-animation-"+m._h.getCurrentSceneDescId()),this.displayError("Saved animation invalid. See console for details."))}}serializeAnimation(){const e={version:3,animation:this.animation};return JSON.stringify(e)}saveAnimation(){const e=this.serializeAnimation();window.localStorage.setItem("studio-animation-"+m._h.getCurrentSceneDescId(),e)}exportAnimation(){if(!this.animation||!this.timeline)return void this.displayError("Export failed - No animation is currently loaded.");const e=document.createElement("a"),t=new Blob([this.serializeAnimation()],{type:"application/json"});e.href=URL.createObjectURL(t),e.download="studio-animation-"+m._h.getCurrentSceneDescId()+".json",e.click()}importAnimation(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async()=>{if(e.files&&e.files.item(0))try{const t=await this.loadFile(e.files.item(0)),s=JSON.parse(t);let n;if(this.isValidAnimationObj(s))n=s.animation;else{if(!this.isBlenderCameraData(s))throw new Error("File is not a valid animation.");n=this.parseBlenderCameraData(s)}this.loadState(this.createInitStudioState(n)),this.displayMessage("Successfully loaded animation from file."),this.saveState()}catch(e){console.error("Failed to load animation from JSON file.",e),this.displayError("Failed to load file. See console for details.")}},e.click()}isValidAnimationObj(e){if(!e||!e.version)return!1;const t=e=>e&&Array.isArray(e.keyframes)&&e.keyframes.length>=1,s=e=>e&&t(e.posXTrack)&&t(e.posYTrack)&&t(e.posZTrack)&&t(e.lookAtXTrack)&&t(e.lookAtYTrack)&&t(e.lookAtZTrack)&&t(e.bankTrack);return 2===e.version&&e.studioState&&s(e.studioState.animation)?(e.animation=e.studioState.animation,!0):!(3!==e.version||!s(e.animation))}isBlenderCameraData(e){if(!(e&&Array.isArray(e.layers)&&e.comp&&e.comp.frameRate))return!1;const t=e.layers.find(e=>"camera"===e.type);return!!(t&&t.transform&&t.transform.keyframes&&Array.isArray(t.transform.keyframes))}parseBlenderCameraData(e){const t=e.comp.frameRate,s=$t*(1/t),n=e.layers.find(e=>"camera"===e.type).transform.keyframes,i=new qt,r=new qt,a=new qt,o=new qt,l=new qt,h=new qt,c=new qt;let u=0;for(let e=0;e<n.length;e++){const t=n[e],m=t[0],p=t[1],f=t[2],g=t[3],T=t[4],x=t[5],v=t[6],C=t[7],b=t[8],_=t[9],y=t[10],S=t[11];d.hZ(this.scratchMat,m,T,b,0,p,x,_,0,f,v,y,0,g,C,S,1);const w=this.getkeyFrameSetFromMat4(this.scratchMat,u,Wt.Linear,c);i.addKeyframe(w.posXKf),r.addKeyframe(w.posYKf),a.addKeyframe(w.posZKf),o.addKeyframe(w.lookAtXKf),l.addKeyframe(w.lookAtYKf),h.addKeyframe(w.lookAtZKf),c.addKeyframe(w.bankKf),u+=s}return{posXTrack:i,posYTrack:r,posZTrack:a,lookAtXTrack:o,lookAtYTrack:l,lookAtZTrack:h,bankTrack:c,loop:!1}}getkeyFrameSetFromMat4(e,t,s,n){d.sC(this.scratchVecPos,e),(0,l.Bl)(this.scratchVecZAxis,e),h.S8(this.scratchVecZAxis,this.scratchVecZAxis),h.Ln(this.scratchVecLook,this.scratchVecPos,this.scratchVecZAxis,-100);const i={time:t,value:this.scratchVecPos[0],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1},r={time:t,value:this.scratchVecPos[1],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1},a={time:t,value:this.scratchVecPos[2],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1},o={time:t,value:this.scratchVecLook[0],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1},c={time:t,value:this.scratchVecLook[1],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1},u={time:t,value:this.scratchVecLook[2],tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1};(0,l.eh)(this.scratchVecPos,e),h.C(this.scratchVecLook,l.PI),h.x6(this.scratchVecLook,this.scratchVecLook,l.i0,-this.scratchVecPos[2]),h.Z8(this.scratchVecLook,this.scratchVecLook,l.i0,-this.scratchVecPos[1]),h.eL(this.scratchVecLook,this.scratchVecLook,l.i0,-this.scratchVecPos[0]),this.scratchVecLook[2]=0,h.S8(this.scratchVecLook,this.scratchVecLook);let m=h.g7(this.scratchVecLook,l.PI);this.scratchVecLook[0]<0&&(m*=-1);let p=0,f=0,g=0;if(n.keyframes.length>0){let e=n.getNextKeyframeIndexAtTime(t);-1===e?e=n.keyframes.length-1:e-=1,p=n.keyframes[e].value,g=p/Math.PI|0,f=p%l.wZ.TAU,p>0&&m<f-Math.PI?m+=l.wZ.TAU:p<=0&&m>f+Math.PI&&(m-=l.wZ.TAU),m+=(g/2|0)*l.wZ.TAU}return{posXKf:i,posYKf:r,posZKf:a,lookAtXKf:o,lookAtYKf:c,lookAtZKf:u,bankKf:{time:t,value:m,tangentIn:0,tangentOut:0,interpInType:s,interpOutType:s,easeInCoeff:1,easeOutCoeff:1}}}createInitStudioState(e){return{animation:e,timelineLengthMs:Math.max(e.posXTrack.keyframes[e.posXTrack.keyframes.length-1].time,e.posYTrack.keyframes[e.posYTrack.keyframes.length-1].time,e.posZTrack.keyframes[e.posZTrack.keyframes.length-1].time,e.lookAtXTrack.keyframes[e.lookAtXTrack.keyframes.length-1].time,e.lookAtYTrack.keyframes[e.lookAtYTrack.keyframes.length-1].time,e.lookAtZTrack.keyframes[e.lookAtZTrack.keyframes.length-1].time,e.bankTrack.keyframes[e.bankTrack.keyframes.length-1].time),timelineMode:this.inferTimelineMode(e),selectedKeyframeIndices:[]}}inferTimelineMode(e){let t=Zt.Consolidated;if(e.posXTrack.keyframes.length!==e.posYTrack.keyframes.length||e.posXTrack.keyframes.length!==e.posZTrack.keyframes.length||e.lookAtXTrack.keyframes.length!==e.lookAtYTrack.keyframes.length||e.lookAtXTrack.keyframes.length!==e.lookAtZTrack.keyframes.length)return Zt.Full;e.posXTrack.keyframes.length===e.lookAtXTrack.keyframes.length&&e.posXTrack.keyframes.length===e.lookAtYTrack.keyframes.length&&e.posXTrack.keyframes.length===e.lookAtZTrack.keyframes.length&&e.posXTrack.keyframes.length===e.bankTrack.keyframes.length||(t=Zt.Position_LookAt_Bank);for(let s=0;s<e.posXTrack.keyframes.length;s++){if(!Ht(e.posXTrack.keyframes[s],e.posYTrack.keyframes[s])||!Ht(e.posXTrack.keyframes[s],e.posZTrack.keyframes[s]))return Zt.Full;void 0!==e.lookAtXTrack.keyframes[s]&&Ht(e.posXTrack.keyframes[s],e.lookAtXTrack.keyframes[s])&&void 0!==e.lookAtYTrack.keyframes[s]&&Ht(e.posXTrack.keyframes[s],e.lookAtYTrack.keyframes[s])&&void 0!==e.lookAtZTrack.keyframes[s]&&Ht(e.posXTrack.keyframes[s],e.lookAtZTrack.keyframes[s])&&void 0!==e.bankTrack.keyframes[s]&&Ht(e.posXTrack.keyframes[s],e.bankTrack.keyframes[s])||(t=Zt.Position_LookAt_Bank)}for(let s=0;s<e.lookAtXTrack.keyframes.length;s++){if(!Ht(e.lookAtXTrack.keyframes[s],e.lookAtYTrack.keyframes[s])||!Ht(e.lookAtXTrack.keyframes[s],e.lookAtZTrack.keyframes[s]))return Zt.Full;void 0!==e.bankTrack.keyframes[s]&&Ht(e.lookAtXTrack.keyframes[s],e.bankTrack.keyframes[s])||(t=Zt.Position_LookAt_Bank)}return t}loadFile(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=()=>{t(n.result)},n.onerror=e=>s(e),n.readAsText(e)})}onSceneChange(){this.newAnimation(),this.loadAnimation(),this.viewer.setCameraController(this.studioCameraController)}disableControls(){this.studioControlsContainer.querySelectorAll("button, input").forEach(e=>{e.setAttribute("disabled",""),e.classList.add("disabled")}),this.keyframeControlsDock.querySelectorAll("button, input").forEach(e=>{e.setAttribute("disabled",""),e.classList.add("disabled")})}enableControls(){this.studioControlsContainer.querySelectorAll("button, input").forEach(e=>{e.classList.contains("keep-disabled")||(e.removeAttribute("disabled"),e.classList.remove("disabled"))}),this.keyframeControlsDock.querySelectorAll("button, input").forEach(e=>{e.removeAttribute("disabled"),e.classList.remove("disabled")})}zoomIn(){this.zoomLevel<5&&(this.zoomLevel+=.25,this.rescaleTimelineContainer(),5===this.zoomLevel&&(this.zoomInBtn.setAttribute("disabled",""),this.zoomInBtn.classList.add("disabled","keep-disabled")),this.zoomOutBtn.removeAttribute("disabled"),this.zoomOutBtn.classList.remove("disabled","keep-disabled"))}zoomOut(){this.zoomLevel>1&&(this.zoomLevel-=.25,this.rescaleTimelineContainer(),1===this.zoomLevel&&(this.zoomOutBtn.setAttribute("disabled",""),this.zoomOutBtn.classList.add("disabled","keep-disabled")),this.zoomInBtn.removeAttribute("disabled"),this.zoomInBtn.classList.remove("disabled","keep-disabled"))}rescaleTimelineContainer(){const e=parseInt(getComputedStyle(this.timeLineContainerElement).width),t=e*this.zoomLevel;this.timelineMarkersCanvas.width=t,this.timelineElementsCanvas.width=t,this.timelineHeaderBg.style.width=t+Qt.WIDTH+"px",this.timelineTracksBg.style.width=t+Qt.WIDTH+"px",this.timeline.setupContexts(),this.timeline.setScaleAndDrawMarkers(),this.onTimelineScaleChanged(parseFloat(this.timelineLengthInput.value)),this.timeLineContainerElement.scroll(this.timeline.getPlayheadX()-e/2,0),this.timeline.draw()}onTimelineScaleChanged(e){let t=parseFloat(this.playheadTimePositionInput.value);t>e&&(t=e,this.playheadTimePositionInput.value=e.toString(),this.playheadTimePositionInput.dataset.prevValue=e.toString()),this.timeline.setPlayheadTimeSeconds(t,!1)}hideEditingUI(){this.saveAnimationBtn.setAttribute("hidden",""),this.keyframeControlsContents.setAttribute("hidden",""),this.studioControlsContainer.setAttribute("hidden",""),this.keyframeControlsDock.setAttribute("hidden",""),this.recordPlaybackBtn.setAttribute("hidden","")}showEditingUI(){this.studioControlsContainer.removeAttribute("hidden"),this.undoRedoBtnContainer.removeAttribute("hidden"),this.saveAnimationBtn.removeAttribute("hidden"),this.keyframeControlsDock.removeAttribute("hidden"),this.recordPlaybackBtn.removeAttribute("hidden")}saveStudioSettings(){const e={drawPreviewLine:this.showPreviewLineCheckbox.checked,livePreview:this.livePreviewCheckbox.checked,autoSave:this.autoSaveCheckbox.checked};window.localStorage.setItem("studio-settings",JSON.stringify(e))}loadStudioSettings(){const e=window.localStorage.getItem("studio-settings");if(e){const t=JSON.parse(e);void 0!==t.drawPreviewLine&&this.showPreviewLineCheckbox.setChecked(t.drawPreviewLine),void 0!==t.livePreview&&this.livePreviewCheckbox.setChecked(t.livePreview),void 0!==t.autoSave&&this.autoSaveCheckbox.setChecked(t.autoSave)}}}ss.FULL_TIMELINE_BG="repeating-linear-gradient(#494949, #494949 20px, #2f2f2f 20px, #2f2f2f 40px, #494949 40px, #494949 59px, #a5a5a5 59px, #a5a5a5 61px, #2f2f2f 61px, #2f2f2f 80px, #494949 80px, #494949 100px, #2f2f2f 100px, #2f2f2f 119px, #a5a5a5 119px, #a5a5a5 121px)",ss.DEFAULT_TIMELINE_BG="repeating-linear-gradient(#494949, #494949 20px, #2f2f2f 20px, #2f2f2f 40px)",ss.PREVIEW_STEP_TIME_MS=16;class ns{constructor(e,t){this.viewer=e,this.cameraController=t,this.framerate=60,this.bitrate=4e7,this.aborted=!1;const s=e.canvas.width,n=e.canvas.height;this.target=new Z,this.muxer=new Vt({target:this.target,video:{codec:"V_VP9",width:s,height:n}}),this.encoder=new VideoEncoder({output:(e,t)=>{this.muxer.addVideoChunk(e,t)},error:e=>{console.error(e)}}),this.encoder.configure({codec:"vp09.00.10.08",width:s,height:n,bitrate:this.bitrate,framerate:this.framerate})}async render(){var e;const t=1e3/this.framerate,s=Math.ceil(this.cameraController.durationMs/t),n={time:this.viewer.rafTime,webXRContext:null};let i=0,r=-1;for(let e=0;e<s&&!this.aborted;e++){const s=e*t;this.cameraController.setElapsedTime(s),this.viewer.update(n),n.time+=t;const a=new VideoFrame(this.viewer.canvas,{timestamp:i});i+=1e3*t;const o=r<0||i-r>=1e6;for(o&&(r=i),this.encoder.encode(a,{keyFrame:o}),a.close();this.encoder.encodeQueueSize>2&&!this.aborted;)await this.waitPromise(16)}if(this.aborted)return void this.encoder.close();await this.encoder.flush(),this.muxer.finalize();const a=`Studio_${null===(e=m._h.getCurrentSceneDescId())||void 0===e?void 0:e.replace("/","_")}.webm`;(0,Gt.Fv)(a,this.target.buffer,"video/webm")}waitPromise(e){return new Promise((t,s)=>{setTimeout(()=>t(),e)})}static isSupported(){return"undefined"!=typeof VideoEncoder}}},738(e,t,s){"use strict";s.d(t,{l:()=>f,M:()=>g});var n,i=s(2003),r=s(930),a=s(5974),o=s(7714),l=s(8771),h=s(1110);function c(e,t){return 3*function(e,t){switch(e){case n.Triangles:return t/3;case n.TriStrips:case n.TriFans:return t-2;case n.Quads:return t/4*2;case n.QuadStrips:return t-2}}(e,t)}!function(e){e[e.Triangles=0]="Triangles",e[e.TriStrips=1]="TriStrips",e[e.TriFans=2]="TriFans",e[e.Quads=3]="Quads",e[e.QuadStrips=4]="QuadStrips"}(n||(n={}));var u=s(8905),d=s(7459);function m(e){if(e===i.uB.DRAW_QUADS)return n.Quads;if(e===i.uB.DRAW_TRIANGLE_STRIP)return n.TriStrips;if(e===i.uB.DRAW_TRIANGLES)return n.Triangles;if(e===i.uB.DRAW_TRIANGLE_FAN)return n.TriFans;throw"whoops"}class p{constructor(){this.vcd=[],this.useNBT=!1,this.loadedVertexLayout=null,this.inputLayout=null,this.vertexBuffer=null,this.indexBuffer=null;for(let e=i.cg.POS;e<=i.cg.TEX7;e++)this.vcd[e]={type:i.WP.NONE};this.vertexBufferDescriptors=[{buffer:null,byteOffset:0}],this.indexBufferDescriptor={buffer:null,byteOffset:0}}setVtxDesc(e,t){(0,a.vA)(null===this.loadedVertexLayout),e===i.cg._NBT&&(e=i.cg.NRM,this.useNBT=t),(0,a.Z1)(this.vcd[e]).type=t?i.WP.DIRECT:i.WP.NONE}allocVertices(e){const t=this.currentVertex+1+e,s=this.loadedVertexLayout.vertexBufferStrides[0];this.ensureVertexBufferData(t*s)}allocPrimitives(e,t){const s=this.currentVertex+1+t,n=m(e),i=this.loadedVertexLayout.vertexBufferStrides[0];this.ensureVertexBufferData(s*i),this.ensureIndexBufferData(c(n,s))}getOffs(e,t){return e*this.loadedVertexLayout.vertexBufferStrides[0]+this.loadedVertexLayout.vertexAttributeOffsets[t]}writeFloat32(e,t){const s=(0,u.G)()===u.H.LITTLE_ENDIAN;this.vertexData.setFloat32(e,t,s)}position3f32(e,t,s){++this.currentVertex,++this.currentPrimVertex,this.allocVertices(0);const n=this.getOffs(this.currentVertex,i.cg.POS);this.writeFloat32(n+0,e),this.writeFloat32(n+4,t),this.writeFloat32(n+8,s)}position3vec3(e){this.position3f32(e[0],e[1],e[2])}normal3f32(e,t,s){const n=this.getOffs(this.currentVertex,i.cg.NRM);this.writeFloat32(n+0,e),this.writeFloat32(n+4,t),this.writeFloat32(n+8,s)}normal3vec3(e){this.normal3f32(e[0],e[1],e[2])}texCoord2f32(e,t,s){const n=this.getOffs(this.currentVertex,e);this.writeFloat32(n+0,t),this.writeFloat32(n+4,s)}texCoord2vec2(e,t){this.texCoord2f32(e,t[0],t[1])}color4rgba8(e,t,s,n,i){const r=this.getOffs(this.currentVertex,e);this.vertexData.setUint32(r+0,t<<24|s<<16|n<<8|i,!1)}color4color(e,t){const s=this.getOffs(this.currentVertex,e);this.vertexData.setUint32(s+0,(0,d.XV)(t),!1)}begin(e,t=null){this.currentPrim=e,this.currentPrimVertex=-1,null!==t&&this.allocPrimitives(e,t)}end(){const e=m(this.currentPrim),t=c(e,this.currentPrimVertex+1);this.ensureIndexBufferData(this.currentIndex+t);const s=this.currentVertex-this.currentPrimVertex,i=this.currentPrimVertex+1;(function(e,t,s,i,r){(0,h.vA)(t+c(s,r)<=e.length);let a=t;if(s===n.Quads)for(let t=0;t<r;t+=4)e[a++]=i+t+0,e[a++]=i+t+1,e[a++]=i+t+2,e[a++]=i+t+2,e[a++]=i+t+3,e[a++]=i+t+0;else if(s===n.TriStrips)for(let t=0;t<r-2;t++)t%2==0?(e[a++]=i+t+0,e[a++]=i+t+1,e[a++]=i+t+2):(e[a++]=i+t+1,e[a++]=i+t+0,e[a++]=i+t+2);else if(s===n.TriFans)for(let t=0;t<r-2;t++)e[a++]=i+0,e[a++]=i+t+1,e[a++]=i+t+2;else if(s===n.QuadStrips)for(let t=0;t<r-2;t+=2)e[a++]=i+t+0,e[a++]=i+t+1,e[a++]=i+t+2,e[a++]=i+t+2,e[a++]=i+t+1,e[a++]=i+t+3;else if(s===n.Triangles)for(let t=0;t<r;t++)e[a++]=i+t})(this.indexData,this.currentIndex,e,s,i),this.currentIndex+=t}}class f extends p{constructor(){super(),this.recreateVertexBuffer=!0,this.recreateIndexBuffer=!0,this.vertexData=new DataView(new ArrayBuffer(1024)),this.indexData=new Uint16Array(256)}ensureVertexBufferData(e){if(e>this.vertexData.byteLength){(0,a.vA)(0===this.startIndex);const t=(0,a.MM)(e,this.vertexData.byteLength),s=new Uint8Array(t);s.set(new Uint8Array(this.vertexData.buffer)),this.vertexData=new DataView(s.buffer),this.recreateVertexBuffer=!0}}ensureIndexBufferData(e){if(e>this.indexData.length){(0,a.vA)(0===this.startIndex);const t=(0,a.MM)(e,this.indexData.byteLength),s=new Uint16Array(t);s.set(this.indexData),this.indexData=s,this.recreateIndexBuffer=!0}}beginDraw(e){null===this.loadedVertexLayout&&(this.loadedVertexLayout=(0,r.Vt)(this.vcd,this.useNBT)),null===this.inputLayout&&(this.inputLayout=(0,l.D9)(e,this.loadedVertexLayout)),this.currentVertex=-1,this.currentIndex=0,this.startIndex=0}flushDeviceObjects(e){this.recreateVertexBuffer&&(null!==this.vertexBuffer&&e.destroyBuffer(this.vertexBuffer),this.vertexBuffer=e.createBuffer(this.vertexData.byteLength+3>>>2,o.B6.Vertex,o.R6.Dynamic),this.vertexBufferDescriptors[0].buffer=this.vertexBuffer,this.recreateVertexBuffer=!1),this.recreateIndexBuffer&&(null!==this.indexBuffer&&e.destroyBuffer(this.indexBuffer),this.indexBuffer=e.createBuffer(this.indexData.byteLength+3>>>2,o.B6.Index,o.R6.Dynamic),this.indexBufferDescriptor.buffer=this.indexBuffer,this.recreateIndexBuffer=!1)}setOnRenderInst(e){e.setVertexInput(this.inputLayout,this.vertexBufferDescriptors,this.indexBufferDescriptor),e.setDrawCount(this.currentIndex-this.startIndex,this.startIndex)}hasIndicesToDraw(){return this.currentIndex>this.startIndex}makeRenderInst(e){this.flushDeviceObjects(e.gfxRenderCache.device);const t=e.newRenderInst();return this.setOnRenderInst(t),this.startIndex=this.currentIndex,t}endDraw(e){const t=e.gfxRenderCache.device;this.flushDeviceObjects(t),t.uploadBufferData(this.vertexBuffer,0,new Uint8Array(this.vertexData.buffer)),t.uploadBufferData(this.indexBuffer,0,new Uint8Array(this.indexData.buffer))}endDrawAndMakeRenderInst(e){return this.endDraw(e),this.makeRenderInst(e)}destroy(e){null!==this.indexBuffer&&(e.destroyBuffer(this.indexBuffer),this.indexBuffer=null,this.recreateIndexBuffer=!0),null!==this.vertexBuffer&&(e.destroyBuffer(this.vertexBuffer),this.vertexBuffer=null,this.recreateVertexBuffer=!0)}}class g extends p{constructor(){super(),this.vertexData=new DataView(new ArrayBuffer(1024)),this.indexData=new Uint16Array(256)}ensureVertexBufferData(e){if(e>this.vertexData.byteLength){const t=(0,a.MM)(e,this.vertexData.byteLength),s=new Uint8Array(t);s.set(new Uint8Array(this.vertexData.buffer)),this.vertexData=new DataView(s.buffer)}}ensureIndexBufferData(e){if(e>this.indexData.length){const t=(0,a.MM)(e,this.indexData.byteLength),s=new Uint16Array(t);s.set(this.indexData),this.indexData=s}}beginDraw(e){(0,a.vA)(null===this.vertexBuffer),(0,a.vA)(null===this.indexBuffer),(0,a.vA)(null===this.loadedVertexLayout),this.loadedVertexLayout=(0,r.Vt)(this.vcd,this.useNBT),this.inputLayout=(0,l.D9)(e,this.loadedVertexLayout),this.currentVertex=-1,this.currentIndex=0}flushDeviceObjects(e){const t=e.device;this.vertexBuffer=t.createBuffer(this.vertexData.byteLength+3>>>2,o.B6.Vertex,o.R6.Static),this.vertexBufferDescriptors[0].buffer=this.vertexBuffer,this.indexBuffer=t.createBuffer(this.indexData.byteLength+3>>>2,o.B6.Index,o.R6.Static),this.indexBufferDescriptor.buffer=this.indexBuffer}setOnRenderInst(e){e.setVertexInput(this.inputLayout,this.vertexBufferDescriptors,this.indexBufferDescriptor),e.setDrawCount(this.currentIndex)}endDraw(e){const t=e.device;this.flushDeviceObjects(e),t.uploadBufferData(this.vertexBuffer,0,new Uint8Array(this.vertexData.buffer)),t.uploadBufferData(this.indexBuffer,0,new Uint8Array(this.indexData.buffer))}destroy(e){null!==this.indexBuffer&&e.destroyBuffer(this.indexBuffer),null!==this.vertexBuffer&&e.destroyBuffer(this.vertexBuffer)}}},3489(e,t,s){"use strict";s.d(t,{C$:()=>n});class n{constructor(){this.gfxTexture=null,this.gfxSampler=null,this.lateBinding=null,this.width=0,this.height=0,this.lodBias=0,this.flipY=!1}reset(){this.gfxTexture=null,this.gfxSampler=null,this.lateBinding=null,this.width=0,this.height=0,this.lodBias=0,this.flipY=!1}fillFromTextureOverride(e){return this.gfxTexture=e.gfxTexture,e.gfxSampler&&(this.gfxSampler=e.gfxSampler),this.width=e.width,this.height=e.height,this.flipY=e.flipY,e.lateBinding&&(this.lateBinding=e.lateBinding),!0}copy(e){this.gfxTexture=e.gfxTexture,this.gfxSampler=e.gfxSampler,this.lateBinding=e.lateBinding,this.width=e.width,this.height=e.height,this.lodBias=e.lodBias,this.flipY=e.flipY}}},8905(e,t,s){"use strict";var n;s.d(t,{G:()=>a,H:()=>n}),function(e){e[e.LITTLE_ENDIAN=0]="LITTLE_ENDIAN",e[e.BIG_ENDIAN=1]="BIG_ENDIAN"}(n||(n={}));const i=new Uint16Array([65279]),r=255==new DataView(i.buffer).getUint8(0)?n.LITTLE_ENDIAN:n.BIG_ENDIAN;function a(){return r}},1158(e,t,s){"use strict";s.d(t,{H:()=>i});var n=s(7714);function i(e){return e.queryVendorInfo().viewportOrigin===n.S0.LowerLeft}},6726(e,t,s){"use strict";s.d(t,{$b:()=>h,BT:()=>p,Ly:()=>c,bP:()=>m,bd:()=>u,w:()=>o});var n=s(7714),i=s(7020),r=s(1110);function a(e,t){e.blendDstFactor=t.blendDstFactor,e.blendSrcFactor=t.blendSrcFactor,e.blendMode=t.blendMode}function o(e,t){return void 0===e&&(e={rgbBlendState:{},alphaBlendState:{},channelWriteMask:0}),a(e.rgbBlendState,t.rgbBlendState),a(e.alphaBlendState,t.alphaBlendState),e.channelWriteMask=t.channelWriteMask,e}function l(e,t){e.length!==t.length&&(e.length=t.length);for(let s=0;s<t.length;s++)e[s]=o(e[s],t[s])}function h(e,t){void 0!==t.attachmentsState&&l(e.attachmentsState,t.attachmentsState),void 0!==t.blendConstant&&(0,r.EQ)(e.blendConstant,t.blendConstant),e.depthCompare=(0,r.rB)(t.depthCompare,e.depthCompare),e.depthWrite=(0,r.rB)(t.depthWrite,e.depthWrite),e.stencilCompare=(0,r.rB)(t.stencilCompare,e.stencilCompare),e.stencilWrite=(0,r.rB)(t.stencilWrite,e.stencilWrite),e.stencilPassOp=(0,r.rB)(t.stencilPassOp,e.stencilPassOp),e.cullMode=(0,r.rB)(t.cullMode,e.cullMode),e.frontFace=(0,r.rB)(t.frontFace,e.frontFace),e.polygonOffset=(0,r.rB)(t.polygonOffset,e.polygonOffset),e.wireframe=(0,r.rB)(t.wireframe,e.wireframe)}function c(e){const t=Object.assign({},e);return t.attachmentsState=[],l(t.attachmentsState,e.attachmentsState),t.blendConstant=(0,r.wg)(t.blendConstant),t}function u(e,t){return void 0===e.attachmentsState&&(e.attachmentsState=[],l(e.attachmentsState,m.attachmentsState)),function(e,t){void 0!==t.channelWriteMask&&(e.channelWriteMask=t.channelWriteMask),void 0!==t.blendMode&&(e.rgbBlendState.blendMode=t.blendMode,e.alphaBlendState.blendMode=t.blendMode),void 0!==t.blendSrcFactor&&(e.rgbBlendState.blendSrcFactor=t.blendSrcFactor,e.alphaBlendState.blendSrcFactor=t.blendSrcFactor),void 0!==t.blendDstFactor&&(e.rgbBlendState.blendDstFactor=t.blendDstFactor,e.alphaBlendState.blendDstFactor=t.blendDstFactor)}(e.attachmentsState[0],t),e}const d={blendMode:n.Id.Add,blendSrcFactor:n.MT.One,blendDstFactor:n.MT.Zero},m={attachmentsState:[{channelWriteMask:n.Mk.RGB,rgbBlendState:d,alphaBlendState:d}],blendConstant:{r:0,g:0,b:0,a:0},depthWrite:!0,depthCompare:(0,i.z8)(n.Ar.LessEqual),stencilCompare:n.Ar.Always,stencilWrite:!1,stencilPassOp:n.j4.Keep,cullMode:n.js.None,frontFace:n.$Z.CCW,polygonOffset:!1,wireframe:!1},p=function(e=null,t=m){const s=c(t);return null!==e&&h(s,e),s}({depthCompare:n.Ar.Always,depthWrite:!1},m)},373(e,t,s){"use strict";var n;function i(e){let t=e.toString();return t.includes(".")||(t+=".0"),t.includes("e")&&(t=e.toFixed(5)),t}s.d(t,{c:()=>i,i:()=>n}),function(e){function t(e="1.0",t="1.0"){return`\nout vec2 v_TexCoord;\n\nvoid main() {\n    v_TexCoord.x = (gl_VertexID == 1) ? 2.0 : 0.0;\n    v_TexCoord.y = (gl_VertexID == 2) ? 2.0 : 0.0;\n    gl_Position.xy = v_TexCoord * vec2(2) - vec2(1);\n    gl_Position.zw = vec2(${e}, ${t});\n\n#if defined GFX_CLIPSPACE_NEAR_ZERO\n    gl_Position.z = (gl_Position.z + gl_Position.w) * 0.5;\n#endif\n\n#if defined GFX_VIEWPORT_ORIGIN_TL\n    v_TexCoord.y = 1.0 - v_TexCoord.y;\n#endif\n}\n`}e.mat4="\nstruct Mat4x4 { vec4 mx; vec4 my; vec4 mz; vec4 mw; };\nstruct Mat4x3 { vec4 mx; vec4 my; vec4 mz; };\nstruct Mat4x2 { vec4 mx; vec4 my; };\n\nvec3 Mat4x3GetCol0(Mat4x3 m) { return vec3(m.mx.x, m.my.x, m.mz.x); }\nvec3 Mat4x3GetCol1(Mat4x3 m) { return vec3(m.mx.y, m.my.y, m.mz.y); }\nvec3 Mat4x3GetCol2(Mat4x3 m) { return vec3(m.mx.z, m.my.z, m.mz.z); }\nvec3 Mat4x3GetCol3(Mat4x3 m) { return vec3(m.mx.w, m.my.w, m.mz.w); }\n\nvec4 Mul(Mat4x4 m, vec4 v) { return vec4(dot(m.mx, v), dot(m.my, v), dot(m.mz, v), dot(m.mw, v)); }\nvec3 Mul(Mat4x3 m, vec4 v) { return vec3(dot(m.mx, v), dot(m.my, v), dot(m.mz, v)); }\nvec2 Mul(Mat4x2 m, vec4 v) { return vec2(dot(m.mx, v), dot(m.my, v)); }\n\nvec4 Mul(vec3 v, Mat4x3 m) {\nreturn vec4(\n    dot(Mat4x3GetCol0(m), v),\n    dot(Mat4x3GetCol1(m), v),\n    dot(Mat4x3GetCol2(m), v),\n    dot(Mat4x3GetCol3(m), v)\n);\n}\n\nvoid Fma(inout Mat4x3 d, Mat4x3 m, float s) { d.mx += m.mx * s; d.my += m.my * s; d.mz += m.mz * s; }\n\nMat4x4 _Mat4x4(float n) { Mat4x4 o; o.mx = vec4(n, 0.0, 0.0, 0.0); o.my = vec4(0.0, n, 0.0, 0.0); o.mz = vec4(0.0, 0.0, n, 0.0); o.mw = vec4(0.0, 0.0, 0.0, n); return o; }\nMat4x4 _Mat4x4(Mat4x3 m) { Mat4x4 o = _Mat4x4(1.0); o.mx = m.mx; o.my = m.my; o.mz = m.mz; return o; }\nMat4x4 _Mat4x4(Mat4x2 m) { Mat4x4 o = _Mat4x4(1.0); o.mx = m.mx; o.my = m.my; return o; }\n\nMat4x3 _Mat4x3(float n) { Mat4x3 o; o.mx = vec4(n, 0.0, 0.0, 0.0); o.my = vec4(0.0, n, 0.0, 0.0); o.mz = vec4(0.0, 0.0, n, 0.0); return o; }\nMat4x3 _Mat4x3(Mat4x4 m) { Mat4x3 o; o.mx = m.mx; o.my = m.my; o.mz = m.mz; return o; }\n",e.saturate="\nfloat saturate(float v) { return clamp(v, 0.0, 1.0); }\nvec2 saturate(vec2 v) { return clamp(v, vec2(0.0), vec2(1.0)); }\nvec3 saturate(vec3 v) { return clamp(v, vec3(0.0), vec3(1.0)); }\nvec4 saturate(vec4 v) { return clamp(v, vec4(0.0), vec4(1.0)); }\n",e.invlerp="\nfloat invlerp(float a, float b, float v) { return (v - a) / (b - a); }\n",e.MulNormalMatrix="\nvec3 MulNormalMatrix(Mat4x3 t_Matrix, vec3 t_Value) {\n    // Pull out the squared scaling.\n    vec3 t_Col0 = Mat4x3GetCol0(t_Matrix);\n    vec3 t_Col1 = Mat4x3GetCol1(t_Matrix);\n    vec3 t_Col2 = Mat4x3GetCol2(t_Matrix);\n    vec3 t_SqScale = vec3(dot(t_Col0, t_Col0), dot(t_Col1, t_Col1), dot(t_Col2, t_Col2));\n    return normalize(Mul(t_Matrix, vec4(t_Value / t_SqScale, 0.0)));\n}\n",e.CalcScaleBias="\nvec2 CalcScaleBias(in vec2 t_Pos, in vec4 t_SB) {\n    return t_Pos.xy * t_SB.xy + t_SB.zw;\n}\n",e.makeFullscreenVS=t,e.fullscreenVS=t(),e.fullscreenBlitOneTexPS="\nuniform sampler2D u_Texture;\nin vec2 v_TexCoord;\n\nvoid main() {\n    gl_FragColor = texture(SAMPLER_2D(u_Texture), v_TexCoord);\n}\n",e.MonochromeNTSC="\nfloat MonochromeNTSC(vec3 t_Color) {\n    // NTSC primaries. Note that this is designed for gamma-space values.\n    return dot(t_Color.rgb, vec3(0.299, 0.587, 0.114));\n}\n",e.MonochromeNTSCLinear="\nfloat MonochromeNTSCLinear(vec3 t_Color) {\n    // NTSC primaries. Note that this is designed for linear-space values.\n    return dot(t_Color.rgb, vec3(0.2125, 0.7154, 0.0721));\n}\n",e.FXAA="\nvec4 FXAA(PD_SAMPLER_2D(t_Texture), in vec2 t_PixelCenter, in vec2 t_InvResolution) {\n    // FXAA v2, based on implementations:\n    // http://www.geeks3d.com/20110405/fxaa-fast-approximate-anti-aliasing-demo-glsl-opengl-test-radeon-geforce/\n    // https://github.com/mitsuhiko/webgl-meincraft\n\n    float lumaMM = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy).rgb);\n\n#if 1\n    vec2 t_PixelTopLeft = t_PixelCenter.xy - t_InvResolution.xy * 0.5;\n    float lumaNW = MonochromeNTSC(texture      (PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy)             .rgb);\n    float lumaNE = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(1, 0)).rgb);\n    float lumaSW = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(0, 1)).rgb);\n    float lumaSE = MonochromeNTSC(textureOffset(PU_SAMPLER_2D(t_Texture), t_PixelTopLeft.xy, ivec2(1, 1)).rgb);\n#else\n    // We're at the pixel center -- pixel edges are 0.5 units away.\n    // NOTE(jstpierre): mitsuhiko's port seems to get this wrong?\n    vec2 t_PixelSize = t_InvResolution.xy * 0.5;\n\n    float lumaNW = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2(-1.0, -1.0)).rgb);\n    float lumaNE = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2( 1.0, -1.0)).rgb);\n    float lumaSW = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2(-1.0,  1.0)).rgb);\n    float lumaSE = MonochromeNTSC(texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + t_PixelSize * vec2( 1.0,  1.0)).rgb);\n#endif\n\n    vec2 dir; \n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    const float FXAA_REDUCE_MIN = 1.0/128.0;\n    const float FXAA_REDUCE_MUL = 1.0/8.0;\n    const float FXAA_SPAN_MAX = 8.0;\n\n    float dirReduce = max(\n        (lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),\n        FXAA_REDUCE_MIN);\n\n    float rcpDirMin = 1.0/(min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * t_InvResolution.xy;\n\n    float lumaMin = min(lumaMM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaMM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    vec4 rgbA = (1.0/2.0) * (\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (1.0/3.0 - 0.5)) +\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (2.0/3.0 - 0.5)));\n    vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (0.0/3.0 - 0.5)) +\n        texture(PU_SAMPLER_2D(t_Texture), t_PixelCenter.xy + dir * (3.0/3.0 - 0.5)));\n    float lumaB = MonochromeNTSC(rgbB.rgb);\n\n    vec4 rgbOutput = ((lumaB < lumaMin) || (lumaB > lumaMax)) ? rgbA : rgbB;\n    return rgbOutput;\n}\n"}(n||(n={}))},8528(e,t,s){"use strict";s.d(t,{_:()=>o});var n=s(7684),i=s(7714);const r=n.fA(1,0,0,0,0,1,0,0,0,0,2,0,0,0,-1,1),a=n.fA(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function o(e,t,s){t!==s&&(t===i.uA.NegativeOne?function(e){n.lK(e,r,e)}(e):t===i.uA.Zero&&function(e){n.lK(e,a,e)}(e))}},6253(e,t,s){"use strict";s.d(t,{Iq:()=>f,MD:()=>T,Rs:()=>g,Od:()=>p}),s(7714);var n=s(7459),i=s(7020),r=s(5144),a=s(5093),o=s(3489),l=s(5974),h=s(6726),c=s(373);class u extends a.P{constructor(){super(...arguments),this.vert=c.i.fullscreenVS,this.frag=`\nuniform sampler2D u_Texture;\nin vec2 v_TexCoord;\n\n${c.i.MonochromeNTSC}\n${c.i.FXAA}\n\nvoid main() {\n    vec2 t_InvResolution = 1.0 / vec2(textureSize(TEXTURE(u_Texture), 0));\n    gl_FragColor.rgba = FXAA(PP_SAMPLER_2D(u_Texture), v_TexCoord.xy, t_InvResolution);\n}\n`}}class d{constructor(e){this.textureMapping=(0,l.y5)(1,()=>new o.C$);const t=new u;this.gfxProgram=e.createProgram(t)}pushPasses(e,t,s){e.pushPass(n=>{n.setDebugName("FXAA"),n.attachRenderTargetID(r.jY.Color0,s);const i=e.resolveRenderTarget(s);n.attachResolveTexture(i);const a=t.renderInstManager.newRenderInst();a.setUniformBuffer(t.uniformBuffer),a.setAllowSkippingIfPipelineNotReady(!1),a.setMegaStateFlags(h.BT),a.setBindingLayouts([{numUniformBuffers:0,numSamplers:1}]),a.setDrawCount(3),a.setGfxProgram(this.gfxProgram),n.exec((e,s)=>{this.textureMapping[0].gfxTexture=s.getResolveTextureForID(i),a.setSamplerBindingsFromTextureMappings(this.textureMapping),a.drawOnPass(t.renderCache,e)})})}}function m(e){return{clearColor:e,clearDepth:(0,i.Hs)(1),clearStencil:0}}const p=m((0,n.gv)(.88,.88,.88,1));var f;function g(e,t){const s=function(e){return e.antialiasingMode===f.MSAAx4?4:1}(t);e.setDimensions(t.backbufferWidth,t.backbufferHeight,s)}m(n.jR),function(e){e[e.None=0]="None",e[e.FXAA=1]="FXAA",e[e.MSAAx4=2]="MSAAx4"}(f||(f={}));class T{constructor(e){this.renderHelper=e,this.fxaa=null}pushPasses(e,t,s){t.antialiasingMode===f.FXAA&&(null===this.fxaa&&(this.fxaa=new d(this.renderHelper.renderCache)),this.fxaa.pushPasses(e,this.renderHelper,s))}}},7020(e,t,s){"use strict";s.d(t,{Hs:()=>h,KX:()=>r,sG:()=>o,z8:()=>l});var n=s(7684),i=s(7714);const r=!0,a=n.fA(1,0,0,0,0,1,0,0,0,0,-1,0,0,0,0,1);function o(e,t=r){t&&n.lK(e,a,e)}function l(e,t=r){if(!t)return e;switch(e){case i.Ar.Less:return i.Ar.Greater;case i.Ar.LessEqual:return i.Ar.GreaterEqual;case i.Ar.GreaterEqual:return i.Ar.LessEqual;case i.Ar.Greater:return i.Ar.Less;default:return e}}function h(e,t=r){return t?1-e:e}},4439(e,t,s){"use strict";function n(e,t,s,n=0){return e[t+0]=s[0],e[t+1]=s[1],e[t+2]=s[2],e[t+3]=n,4}function i(e,t,s,n=0,i=0,r=0){return e[t+0]=s,e[t+1]=n,e[t+2]=i,e[t+3]=r,4}function r(e,t,s,n=s.a){return e[t+0]=s.r,e[t+1]=s.g,e[t+2]=s.b,e[t+3]=n,4}function a(e,t,s){return e[t+0]=s[0],e[t+1]=s[4],e[t+2]=s[8],e[t+3]=s[12],e[t+4]=s[1],e[t+5]=s[5],e[t+6]=s[9],e[t+7]=s[13],e[t+8]=s[2],e[t+9]=s[6],e[t+10]=s[10],e[t+11]=s[14],e[t+12]=s[3],e[t+13]=s[7],e[t+14]=s[11],e[t+15]=s[15],16}function o(e,t,s){return e[t+0]=s[0],e[t+1]=s[4],e[t+2]=s[8],e[t+3]=s[12],e[t+4]=s[1],e[t+5]=s[5],e[t+6]=s[9],e[t+7]=s[13],e[t+8]=s[2],e[t+9]=s[6],e[t+10]=s[10],e[t+11]=s[14],12}function l(e,t,s){return e[t+0]=s[0],e[t+1]=s[4],e[t+2]=s[8],e[t+3]=s[12],e[t+4]=s[1],e[t+5]=s[5],e[t+6]=s[9],e[t+7]=s[13],8}s.d(t,{fW:()=>n,lD:()=>a,lo:()=>l,pf:()=>r,s2:()=>o,up:()=>i})},7714(e,t,s){"use strict";s.d(t,{$Y:()=>w.$Y,$Z:()=>i,Ar:()=>n,B6:()=>d,Id:()=>o,MN:()=>b,MT:()=>a,Mk:()=>T,P:()=>c,R6:()=>m,S0:()=>_,Vf:()=>l,Yw:()=>g,bn:()=>f,dG:()=>v,er:()=>p,gD:()=>h,j4:()=>x,js:()=>r,o8:()=>S,sP:()=>u,uA:()=>y,xm:()=>A});var n,i,r,a,o,l,h,c,u,d,m,p,f,g,T,x,v,C,b,_,y,S,w=s(7653);function A(e,t,s,n){return{dimension:f.n2D,pixelFormat:e,width:t,height:s,depthOrArrayLayers:1,numLevels:n,usage:g.Sampled}}!function(e){e[e.Never=WebGLRenderingContext.NEVER]="Never",e[e.Less=WebGLRenderingContext.LESS]="Less",e[e.Equal=WebGLRenderingContext.EQUAL]="Equal",e[e.LessEqual=WebGLRenderingContext.LEQUAL]="LessEqual",e[e.Greater=WebGLRenderingContext.GREATER]="Greater",e[e.NotEqual=WebGLRenderingContext.NOTEQUAL]="NotEqual",e[e.GreaterEqual=WebGLRenderingContext.GEQUAL]="GreaterEqual",e[e.Always=WebGLRenderingContext.ALWAYS]="Always"}(n||(n={})),function(e){e[e.CCW=WebGLRenderingContext.CCW]="CCW",e[e.CW=WebGLRenderingContext.CW]="CW"}(i||(i={})),function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.FrontAndBack=3]="FrontAndBack"}(r||(r={})),function(e){e[e.Zero=WebGLRenderingContext.ZERO]="Zero",e[e.One=WebGLRenderingContext.ONE]="One",e[e.Src=WebGLRenderingContext.SRC_COLOR]="Src",e[e.OneMinusSrc=WebGLRenderingContext.ONE_MINUS_SRC_COLOR]="OneMinusSrc",e[e.Dst=WebGLRenderingContext.DST_COLOR]="Dst",e[e.OneMinusDst=WebGLRenderingContext.ONE_MINUS_DST_COLOR]="OneMinusDst",e[e.SrcAlpha=WebGLRenderingContext.SRC_ALPHA]="SrcAlpha",e[e.OneMinusSrcAlpha=WebGLRenderingContext.ONE_MINUS_SRC_ALPHA]="OneMinusSrcAlpha",e[e.DstAlpha=WebGLRenderingContext.DST_ALPHA]="DstAlpha",e[e.OneMinusDstAlpha=WebGLRenderingContext.ONE_MINUS_DST_ALPHA]="OneMinusDstAlpha"}(a||(a={})),function(e){e[e.Add=WebGLRenderingContext.FUNC_ADD]="Add",e[e.Subtract=WebGLRenderingContext.FUNC_SUBTRACT]="Subtract",e[e.ReverseSubtract=WebGLRenderingContext.FUNC_REVERSE_SUBTRACT]="ReverseSubtract"}(o||(o={})),function(e){e[e.Clamp=0]="Clamp",e[e.Repeat=1]="Repeat",e[e.Mirror=2]="Mirror"}(l||(l={})),function(e){e[e.Point=0]="Point",e[e.Bilinear=1]="Bilinear"}(h||(h={})),function(e){e[e.NoMip=0]="NoMip",e[e.Nearest=1]="Nearest",e[e.Linear=2]="Linear"}(c||(c={})),function(e){e[e.Triangles=0]="Triangles"}(u||(u={})),function(e){e[e.Index=1]="Index",e[e.Vertex=2]="Vertex",e[e.Uniform=4]="Uniform",e[e.Storage=8]="Storage",e[e.CopySrc=16]="CopySrc"}(d||(d={})),function(e){e[e.Static=1]="Static",e[e.Dynamic=2]="Dynamic"}(m||(m={})),function(e){e[e.PerVertex=1]="PerVertex",e[e.PerInstance=2]="PerInstance"}(p||(p={})),function(e){e[e.n2D=0]="n2D",e[e.n2DArray=1]="n2DArray",e[e.n3D=2]="n3D",e[e.Cube=3]="Cube"}(f||(f={})),function(e){e[e.Sampled=1]="Sampled",e[e.RenderTarget=2]="RenderTarget"}(g||(g={})),function(e){e[e.None=0]="None",e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.RGB=7]="RGB",e[e.AllChannels=15]="AllChannels"}(T||(T={})),function(e){e[e.Keep=WebGLRenderingContext.KEEP]="Keep",e[e.Zero=WebGLRenderingContext.ZERO]="Zero",e[e.Replace=WebGLRenderingContext.REPLACE]="Replace",e[e.Invert=WebGLRenderingContext.INVERT]="Invert",e[e.IncrementClamp=WebGLRenderingContext.INCR]="IncrementClamp",e[e.DecrementClamp=WebGLRenderingContext.DECR]="DecrementClamp",e[e.IncrementWrap=WebGLRenderingContext.INCR_WRAP]="IncrementWrap",e[e.DecrementWrap=WebGLRenderingContext.DECR_WRAP]="DecrementWrap"}(x||(x={})),function(e){e[e.Float=0]="Float",e[e.Uint=1]="Uint",e[e.Sint=2]="Sint",e[e.Depth=3]="Depth"}(v||(v={})),function(e){e[e.UniformBuffer=0]="UniformBuffer",e[e.Sampler=1]="Sampler",e[e.StorageBuffer=2]="StorageBuffer",e[e.StorageTexture=3]="StorageTexture"}(C||(C={})),function(e){e[e.WGSL=0]="WGSL",e[e.GLSL=1]="GLSL"}(b||(b={})),function(e){e[e.LowerLeft=0]="LowerLeft",e[e.UpperLeft=1]="UpperLeft"}(_||(_={})),function(e){e[e.NegativeOne=-1]="NegativeOne",e[e.Zero=0]="Zero"}(y||(y={})),function(e){e[e.OcclusionConservative=0]="OcclusionConservative"}(S||(S={}))},7653(e,t,s){"use strict";s.d(t,{$U:()=>g,$Y:()=>a,Eo:()=>f,Su:()=>p,UX:()=>l,_z:()=>c,kk:()=>T,lk:()=>r,np:()=>n,pZ:()=>u,vg:()=>d,wd:()=>i});var n,i,r,a,o=s(7714);function l(e){return e}function h(e,t,s){return e<<16|t<<8|s}function c(e){return e>>>8&255}function u(e){return e>>>16&255}function d(e){return 255&e}function m(e){switch(e){case n.F32:case n.U32:case n.S32:return 4;case n.U16:case n.S16:case n.F16:return 2;case n.U8:case n.S8:return 1;default:throw"whoops"}}function p(e){return m(u(e))}function f(e){return c(e)}function g(e){const t=u(e);switch(t){case n.U16_PACKED_5551:case n.U16_PACKED_565:return 2;case n.BC1:case n.BC2:case n.BC3:case n.BC4_UNORM:case n.BC4_SNORM:case n.BC5_UNORM:case n.BC5_SNORM:throw"whoops";default:return m(t)*c(e)}}function T(e){const t=d(e);if(t&r.Depth)return o.dG.Depth;if(t&r.Normalized)return o.dG.Float;const s=u(e);if(s===n.F16||s===n.F32)return o.dG.Float;if(s===n.U8||s===n.U16||s===n.U32)return o.dG.Uint;if(s===n.S8||s===n.S16||s===n.S32)return o.dG.Sint;throw"whoops"}!function(e){e[e.U8=1]="U8",e[e.U16=2]="U16",e[e.U32=3]="U32",e[e.S8=4]="S8",e[e.S16=5]="S16",e[e.S32=6]="S32",e[e.F16=7]="F16",e[e.F32=8]="F32",e[e.BC1=65]="BC1",e[e.BC2=66]="BC2",e[e.BC3=67]="BC3",e[e.BC4_UNORM=68]="BC4_UNORM",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5_UNORM=70]="BC5_UNORM",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.U16_PACKED_5551=97]="U16_PACKED_5551",e[e.U16_PACKED_565=98]="U16_PACKED_565",e[e.D24=129]="D24",e[e.D32F=130]="D32F",e[e.D24S8=131]="D24S8",e[e.D32FS8=132]="D32FS8"}(n||(n={})),function(e){e[e.R=1]="R",e[e.RG=2]="RG",e[e.RGB=3]="RGB",e[e.RGBA=4]="RGBA"}(i||(i={})),function(e){e[e.None=0]="None",e[e.Normalized=1]="Normalized",e[e.sRGB=2]="sRGB",e[e.Depth=4]="Depth",e[e.Stencil=8]="Stencil",e[e.RenderTarget=16]="RenderTarget"}(r||(r={})),function(e){e[e.F16_R=h(n.F16,i.R,r.None)]="F16_R",e[e.F16_RG=h(n.F16,i.RG,r.None)]="F16_RG",e[e.F16_RGB=h(n.F16,i.RGB,r.None)]="F16_RGB",e[e.F16_RGBA=h(n.F16,i.RGBA,r.None)]="F16_RGBA",e[e.F32_R=h(n.F32,i.R,r.None)]="F32_R",e[e.F32_RG=h(n.F32,i.RG,r.None)]="F32_RG",e[e.F32_RGB=h(n.F32,i.RGB,r.None)]="F32_RGB",e[e.F32_RGBA=h(n.F32,i.RGBA,r.None)]="F32_RGBA",e[e.U8_R=h(n.U8,i.R,r.None)]="U8_R",e[e.U8_R_NORM=h(n.U8,i.R,r.Normalized)]="U8_R_NORM",e[e.U8_RG=h(n.U8,i.RG,r.None)]="U8_RG",e[e.U8_RG_NORM=h(n.U8,i.RG,r.Normalized)]="U8_RG_NORM",e[e.U8_RGB=h(n.U8,i.RGB,r.None)]="U8_RGB",e[e.U8_RGB_NORM=h(n.U8,i.RGB,r.Normalized)]="U8_RGB_NORM",e[e.U8_RGB_SRGB=h(n.U8,i.RGB,r.sRGB|r.Normalized)]="U8_RGB_SRGB",e[e.U8_RGBA=h(n.U8,i.RGBA,r.None)]="U8_RGBA",e[e.U8_RGBA_NORM=h(n.U8,i.RGBA,r.Normalized)]="U8_RGBA_NORM",e[e.U8_RGBA_SRGB=h(n.U8,i.RGBA,r.sRGB|r.Normalized)]="U8_RGBA_SRGB",e[e.U16_R=h(n.U16,i.R,r.None)]="U16_R",e[e.U16_R_NORM=h(n.U16,i.R,r.Normalized)]="U16_R_NORM",e[e.U16_RG_NORM=h(n.U16,i.RG,r.Normalized)]="U16_RG_NORM",e[e.U16_RGBA_NORM=h(n.U16,i.RGBA,r.Normalized)]="U16_RGBA_NORM",e[e.U16_RGB=h(n.U16,i.RGB,r.None)]="U16_RGB",e[e.U32_R=h(n.U32,i.R,r.None)]="U32_R",e[e.U32_RG=h(n.U32,i.RG,r.None)]="U32_RG",e[e.S8_R=h(n.S8,i.R,r.None)]="S8_R",e[e.S8_R_NORM=h(n.S8,i.R,r.Normalized)]="S8_R_NORM",e[e.S8_RG_NORM=h(n.S8,i.RG,r.Normalized)]="S8_RG_NORM",e[e.S8_RGB_NORM=h(n.S8,i.RGB,r.Normalized)]="S8_RGB_NORM",e[e.S8_RGBA_NORM=h(n.S8,i.RGBA,r.Normalized)]="S8_RGBA_NORM",e[e.S16_R=h(n.S16,i.R,r.None)]="S16_R",e[e.S16_RG=h(n.S16,i.RG,r.None)]="S16_RG",e[e.S16_RG_NORM=h(n.S16,i.RG,r.Normalized)]="S16_RG_NORM",e[e.S16_RGB_NORM=h(n.S16,i.RGB,r.Normalized)]="S16_RGB_NORM",e[e.S16_RGBA=h(n.S16,i.RGBA,r.None)]="S16_RGBA",e[e.S16_RGBA_NORM=h(n.S16,i.RGBA,r.Normalized)]="S16_RGBA_NORM",e[e.S32_R=h(n.S32,i.R,r.None)]="S32_R",e[e.U16_RGBA_5551=h(n.U16_PACKED_5551,i.RGBA,r.Normalized)]="U16_RGBA_5551",e[e.U16_RGB_565=h(n.U16_PACKED_565,i.RGB,r.Normalized)]="U16_RGB_565",e[e.BC1=h(n.BC1,i.RGBA,r.Normalized)]="BC1",e[e.BC1_SRGB=h(n.BC1,i.RGBA,r.Normalized|r.sRGB)]="BC1_SRGB",e[e.BC2=h(n.BC2,i.RGBA,r.Normalized)]="BC2",e[e.BC2_SRGB=h(n.BC2,i.RGBA,r.Normalized|r.sRGB)]="BC2_SRGB",e[e.BC3=h(n.BC3,i.RGBA,r.Normalized)]="BC3",e[e.BC3_SRGB=h(n.BC3,i.RGBA,r.Normalized|r.sRGB)]="BC3_SRGB",e[e.BC4_UNORM=h(n.BC4_UNORM,i.R,r.Normalized)]="BC4_UNORM",e[e.BC4_SNORM=h(n.BC4_SNORM,i.R,r.Normalized)]="BC4_SNORM",e[e.BC5_UNORM=h(n.BC5_UNORM,i.RG,r.Normalized)]="BC5_UNORM",e[e.BC5_SNORM=h(n.BC5_SNORM,i.RG,r.Normalized)]="BC5_SNORM",e[e.D24=h(n.D24,i.R,r.Depth)]="D24",e[e.D24_S8=h(n.D24S8,i.RG,r.Depth|r.Stencil)]="D24_S8",e[e.D32F=h(n.D32F,i.R,r.Depth)]="D32F",e[e.D32F_S8=h(n.D32FS8,i.RG,r.Depth|r.Stencil)]="D32F_S8",e[e.U8_RGB_RT=h(n.U8,i.RGB,r.RenderTarget|r.Normalized)]="U8_RGB_RT",e[e.U8_RGBA_RT=h(n.U8,i.RGBA,r.RenderTarget|r.Normalized)]="U8_RGBA_RT",e[e.U8_RGBA_RT_SRGB=h(n.U8,i.RGBA,r.RenderTarget|r.Normalized|r.sRGB)]="U8_RGBA_RT_SRGB"}(a||(a={}))},1110(e,t,s){"use strict";s.d(t,{EQ:()=>P,GP:()=>d,I:()=>w,KA:()=>I,MM:()=>X,PB:()=>k,PX:()=>F,Z1:()=>L,af:()=>r,cK:()=>C,ds:()=>o,eT:()=>f,f$:()=>M,g_:()=>N,nc:()=>V,o:()=>R,rB:()=>G,rG:()=>i,vA:()=>B,wg:()=>D,y1:()=>O,y5:()=>U,yH:()=>h,yN:()=>v});var n=s(6726);function i(e,t){const s=Array(e.length);for(let n=0;n<e.length;n++)s[n]=t(e[n]);return s}function r(e,t,s){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!s(e[n],t[n]))return!1;return!0}function a(e){return{gfxSampler:e.gfxSampler,gfxTexture:e.gfxTexture,lateBinding:e.lateBinding}}function o(){return{gfxSampler:null,gfxTexture:null,lateBinding:null}}function l(e){return{buffer:e.buffer,wordCount:e.wordCount}}function h(e){return{bindingLayout:e.bindingLayout,samplerBindings:i(e.samplerBindings,a),uniformBufferBindings:i(e.uniformBufferBindings,l)}}function c(e){return{dimension:e.dimension,formatKind:e.formatKind,comparison:!0===e.comparison}}function u(e){return{numSamplers:e.numSamplers,numUniformBuffers:e.numUniformBuffers,samplerEntries:void 0!==e.samplerEntries?i(e.samplerEntries,c):void 0}}function d(e){const t=i(e.bindingLayouts,u),s=e.inputLayout,r=e.program,a=e.topology;return{bindingLayouts:t,inputLayout:s,megaStateDescriptor:(0,n.Ly)(e.megaStateDescriptor),program:r,topology:a,colorAttachmentFormats:e.colorAttachmentFormats.slice(),depthStencilAttachmentFormat:e.depthStencilAttachmentFormat,sampleCount:e.sampleCount}}function m(e){return{location:e.location,format:e.format,bufferIndex:e.bufferIndex,bufferByteOffset:e.bufferByteOffset}}function p(e){return null!==e?{byteStride:e.byteStride,frequency:e.frequency}:null}function f(e){return{vertexAttributeDescriptors:i(e.vertexAttributeDescriptors,m),vertexBufferDescriptors:i(e.vertexBufferDescriptors,p),indexBufferFormat:e.indexBufferFormat}}function g(e,t){return e.buffer===t.buffer&&e.wordCount===t.wordCount}function T(e,t){return null===e?null===t:null!==t&&e.gfxSampler===t.gfxSampler&&e.gfxTexture===t.gfxTexture}function x(e,t){return e.dimension===t.dimension&&e.formatKind===t.formatKind}function v(e,t){return e.numSamplers===t.numSamplers&&e.numUniformBuffers===t.numUniformBuffers&&void 0===e.samplerEntries==(void 0===t.samplerEntries)&&!(void 0!==e.samplerEntries&&!r(e.samplerEntries,t.samplerEntries,x))}function C(e,t){return e.samplerBindings.length===t.samplerBindings.length&&!!r(e.samplerBindings,t.samplerBindings,T)&&!!r(e.uniformBufferBindings,t.uniformBufferBindings,g)&&!!y(e.bindingLayout,t.bindingLayout)}function b(e,t){return e.blendMode==t.blendMode&&e.blendSrcFactor===t.blendSrcFactor&&e.blendDstFactor===t.blendDstFactor}function _(e,t){return!!b(e.rgbBlendState,t.rgbBlendState)&&!!b(e.alphaBlendState,t.alphaBlendState)&&e.channelWriteMask===t.channelWriteMask}function y(e,t){return e.numSamplers===t.numSamplers&&e.numUniformBuffers===t.numUniformBuffers}function S(e,t){return e===t}function w(e,t){return!!(e.topology===t.topology&&e.inputLayout===t.inputLayout&&e.sampleCount===t.sampleCount&&function(e,t){return!!r(e.attachmentsState,t.attachmentsState,_)&&!!M(e.blendConstant,t.blendConstant)&&e.depthCompare===t.depthCompare&&e.depthWrite===t.depthWrite&&e.stencilCompare===t.stencilCompare&&e.stencilWrite===t.stencilWrite&&e.stencilPassOp===t.stencilPassOp&&e.cullMode===t.cullMode&&e.frontFace===t.frontFace&&e.polygonOffset===t.polygonOffset}(e.megaStateDescriptor,t.megaStateDescriptor)&&function(e,t){return e.ResourceUniqueId===t.ResourceUniqueId}(e.program,t.program)&&r(e.bindingLayouts,t.bindingLayouts,y)&&r(e.colorAttachmentFormats,t.colorAttachmentFormats,S)&&e.depthStencilAttachmentFormat===t.depthStencilAttachmentFormat)}function A(e,t){return e.bufferIndex===t.bufferIndex&&e.bufferByteOffset===t.bufferByteOffset&&e.location===t.location&&e.format===t.format}function E(e,t){return null===e?null===t:null!==t&&e.byteStride===t.byteStride&&e.frequency===t.frequency}function R(e,t){return e.indexBufferFormat===t.indexBufferFormat&&!!r(e.vertexBufferDescriptors,t.vertexBufferDescriptors,E)&&!!r(e.vertexAttributeDescriptors,t.vertexAttributeDescriptors,A)}function I(e,t){return e.wrapS===t.wrapS&&e.wrapT===t.wrapT&&e.wrapQ===t.wrapQ&&e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.mipFilter===t.mipFilter&&e.minLOD===t.minLOD&&e.maxLOD===t.maxLOD&&e.maxAnisotropy===t.maxAnisotropy&&e.compareMode===t.compareMode}function k(e,t){return e===t||null!==e&&null!==t&&e.level===t.level&&e.z===t.z}function M(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}function P(e,t){e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a}function D(e){const{r:t,g:s,b:n,a:i}=e;return{r:t,g:s,b:n,a:i}}function B(e,t=""){if(!e)throw console.error((new Error).stack),new Error(`Assert fail: ${t}`)}function L(e){if(null!=e)return e;throw new Error("Missing object")}function O(e,t){const s=[];for(let n=e;n<e+t;n++)s.push(n);return s}function F(e,t,s="0"){for(;e.length<t;)e=`${s}${e}`;return e}function U(e,t){const s=new Array(e);for(let n=0;n<e;n++)s[n]=t();return s}function N(e){return void 0===e?null:e}function X(e,t){const s=t-1;return e+s&~s}function V(e,t){return((e+t-1)/t|0)*t}function G(e,t){return null!=e?e:t}},9918(e,t,s){"use strict";s.d(t,{g:()=>u});var n=s(1110),i=s(2466);function r(e,t){return(0,n.vA)(""!==e.preprocessedVert&&""!==t.preprocessedVert),(0,n.vA)(""!==e.preprocessedFrag&&""!==t.preprocessedFrag),e.preprocessedVert===t.preprocessedVert&&e.preprocessedFrag===t.preprocessedFrag}function a(e,t){return e=(0,i.gt)(e,t.numUniformBuffers),(0,i.gt)(e,t.numSamplers)}function o(e,t){return e=(0,i.gt)(e,t.blendMode),e=(0,i.gt)(e,t.blendSrcFactor),(0,i.gt)(e,t.blendDstFactor)}function l(e,t){return e=o(e,t.rgbBlendState),e=o(e,t.alphaBlendState),(0,i.gt)(e,t.channelWriteMask)}function h(e){let t=0;t=(0,i.gt)(t,e.program.ResourceUniqueId),null!==e.inputLayout&&(t=(0,i.gt)(t,e.inputLayout.ResourceUniqueId));for(let s=0;s<e.bindingLayouts.length;s++)t=a(t,e.bindingLayouts[s]);t=function(e,t){for(let s=0;s<t.attachmentsState.length;s++)e=l(e,t.attachmentsState[s]);return e=function(e,t){return(0,i.gt)(e,t.r<<24|t.g<<16|t.b<<8|t.a)}(e,t.blendConstant),e=(0,i.gt)(e,t.depthCompare),e=(0,i.gt)(e,t.depthWrite?1:0),e=(0,i.gt)(e,t.stencilCompare),e=(0,i.gt)(e,t.stencilPassOp),e=(0,i.gt)(e,t.stencilWrite?1:0),e=(0,i.gt)(e,t.cullMode),e=(0,i.gt)(e,t.frontFace?1:0),e=(0,i.gt)(e,t.polygonOffset?1:0),(0,i.gt)(e,t.wireframe?1:0)}(t,e.megaStateDescriptor);for(let s=0;s<e.colorAttachmentFormats.length;s++)t=(0,i.gt)(t,e.colorAttachmentFormats[s]||0);return t=(0,i.gt)(t,e.depthStencilAttachmentFormat||0),(0,i.S5)(t)}function c(e){let t=0;for(let s=0;s<e.samplerBindings.length;s++){const n=e.samplerBindings[s];null!==n&&null!==n.gfxTexture&&(t=(0,i.gt)(t,n.gfxTexture.ResourceUniqueId))}for(let s=0;s<e.uniformBufferBindings.length;s++){const n=e.uniformBufferBindings[s];null!==n&&null!==n.buffer&&(t=(0,i.gt)(t,n.buffer.ResourceUniqueId),t=(0,i.gt)(t,n.wordCount))}return(0,i.S5)(t)}class u{constructor(e){this.device=e,this.gfxBindingsCache=new i.Bs(n.cK,c),this.gfxRenderPipelinesCache=new i.Bs(n.I,h),this.gfxInputLayoutsCache=new i.Bs(n.o,i.Kt),this.gfxProgramCache=new i.Bs(r,i.Kt),this.gfxSamplerCache=new i.Bs(n.KA,i.Kt)}createBindings(e){let t=this.gfxBindingsCache.get(e);if(null===t){const s=(0,n.yH)(e);t=this.device.createBindings(s),this.gfxBindingsCache.add(s,t)}return t.expireFrameNum=4,t}createRenderPipeline(e){let t=this.gfxRenderPipelinesCache.get(e);if(null===t){const s=(0,n.GP)(e);t=this.device.createRenderPipeline(s),this.gfxRenderPipelinesCache.add(s,t)}return t}createInputLayout(e){let t=this.gfxInputLayoutsCache.get(e);if(null===t){const s=(0,n.eT)(e);t=this.device.createInputLayout(s),this.gfxInputLayoutsCache.add(s,t)}return t}createProgramSimple(e){let t=this.gfxProgramCache.get(e);if(null===t){const n={preprocessedVert:(s=e).preprocessedVert,preprocessedFrag:s.preprocessedFrag};if(t=this.device.createProgramSimple(n),this.gfxProgramCache.add(n,t),"associate"in e){const s=e;s.associate(this.device,t),n.orig=s}}var s;return t}createProgram(e){return e.ensurePreprocessed(this.device.queryVendorInfo()),this.createProgramSimple(e)}createSampler(e){let t=this.gfxSamplerCache.get(e);return null===t&&(t=this.device.createSampler(e),this.gfxSamplerCache.add(e,t)),t}numBindings(){return this.gfxBindingsCache.size()}prepareToRender(){for(const[e,t]of this.gfxBindingsCache.items())--t.expireFrameNum<=0&&(this.gfxBindingsCache.delete(e),this.device.destroyBindings(t))}destroy(){for(const e of this.gfxBindingsCache.values())this.device.destroyBindings(e);for(const e of this.gfxRenderPipelinesCache.values())this.device.destroyRenderPipeline(e);for(const e of this.gfxInputLayoutsCache.values())this.device.destroyInputLayout(e);for(const e of this.gfxProgramCache.values())this.device.destroyProgram(e);for(const e of this.gfxSamplerCache.values())this.device.destroySampler(e);this.gfxBindingsCache.clear(),this.gfxRenderPipelinesCache.clear(),this.gfxInputLayoutsCache.clear(),this.gfxProgramCache.clear(),this.gfxSamplerCache.clear()}}},5144(e,t,s){"use strict";s.d(t,{EV:()=>f,jY:()=>n,tR:()=>a,xH:()=>d});var n,i=s(7714),r=s(1110);class a{constructor(e){this.pixelFormat=e,this.width=0,this.height=0,this.numLevels=1,this.sampleCount=0,this.clearColor="load",this.clearDepth="load",this.clearStencil="load"}setDimensions(e,t,s){this.width=e,this.height=t,this.sampleCount=s}copyDimensions(e){this.width=e.width,this.height=e.height,this.sampleCount=e.sampleCount}}!function(e){e[e.Color0=0]="Color0",e[e.Color1=1]="Color1",e[e.Color2=2]="Color2",e[e.Color3=3]="Color3",e[e.ColorMax=3]="ColorMax",e[e.DepthStencil=4]="DepthStencil"}(n||(n={}));const o={clearColor:"load",clearDepth:"load",clearStencil:"load"};class l{constructor(e){this.passType=e,this.debugName="",this.attachmentRenderTargetID=[],this.attachmentTexture=[],this.attachmentClearDescriptor=[],this.attachmentView=[],this.resolveOutputIDs=[],this.resolveOutputExternalTexture=[],this.resolveOutputExternalTextureView=[],this.resolveTextureInputIDs=[],this.renderTargetExtraRefs=[],this.resolveTextureInputTextures=[],this.renderTargets=[],this.descriptor={colorAttachments:[],depthStencilAttachment:null,occlusionQueryPool:null},this.viewportX=0,this.viewportY=0,this.viewportW=1,this.viewportH=1,this.execFunc=null,this.postFunc=null}setDebugName(e){this.debugName=e}setViewport(e,t,s,n){this.viewportX=e,this.viewportY=t,this.viewportW=s,this.viewportH=n}attachRenderTargetID(e,t,s=null){(0,r.vA)(void 0===this.attachmentRenderTargetID[e]&&void 0===this.attachmentTexture[e]),this.attachmentRenderTargetID[e]=t,this.attachmentView[e]=null!==s?s:{level:0,z:0}}attachTexture(e,t,s=null,n=o){(0,r.vA)(void 0===this.attachmentRenderTargetID[e]&&void 0===this.attachmentTexture[e]),this.attachmentTexture[e]=t,this.attachmentClearDescriptor[e]=n,this.attachmentView[e]=null!==s?s:{level:0,z:0}}attachResolveTexture(e){this.resolveTextureInputIDs.push(e)}attachOcclusionQueryPool(e){this.descriptor.occlusionQueryPool=e}exec(e){(0,r.vA)(null===this.execFunc),this.execFunc=e}post(e){(0,r.vA)(null===this.postFunc),this.postFunc=e}addExtraRef(e){this.renderTargetExtraRefs[e]=!0}}class h{constructor(){this.renderTargetDescriptions=[],this.resolveTextureRenderTargetIDs=[],this.passes=[],this.renderTargetDebugNames=[],this.debugThumbnails=[]}}Symbol.species;class c{constructor(e,t){this.debugName="",this.dimension=i.bn.n2D,this.depthOrArrayLayers=1,this.width=0,this.height=0,this.numLevels=1,this.sampleCount=0,this.usage=i.Yw.RenderTarget,this.needsClear=!0,this.texture=null,this.age=0,this.pixelFormat=t.pixelFormat,this.width=t.width,this.height=t.height,this.numLevels=t.numLevels,this.sampleCount=t.sampleCount,(0,r.vA)(this.sampleCount>=1),this.sampleCount>1?this.renderTarget=e.createRenderTarget(this):(this.texture=e.createTexture(this),this.renderTarget=e.createRenderTargetFromTexture(this.texture))}setDebugName(e,t){this.debugName=t,null!==this.texture&&e.setResourceName(this.texture,this.debugName),e.setResourceName(this.renderTarget,this.debugName)}matchesDescription(e){return this.pixelFormat===e.pixelFormat&&this.width===e.width&&this.height===e.height&&this.numLevels===e.numLevels&&this.sampleCount===e.sampleCount}reset(){this.age=0}destroy(e){null!==this.texture&&e.destroyTexture(this.texture),e.destroyRenderTarget(this.renderTarget)}}class u{constructor(e,t){this.dimension=i.bn.n2D,this.depthOrArrayLayers=1,this.numLevels=1,this.usage=i.Yw.RenderTarget,this.width=0,this.height=0,this.age=0,this.pixelFormat=t.pixelFormat,this.width=t.width,this.height=t.height,this.texture=e.createTexture(this)}matchesDescription(e){return this.pixelFormat===e.pixelFormat&&this.width===e.width&&this.height===e.height}reset(){this.age=0}destroy(e){e.destroyTexture(this.texture)}}class d{constructor(){this.inputTexture=null,this.outputTexture=null}setDescription(e,t){this.inputTexture!==this.outputTexture&&(null!==this.inputTexture&&this.inputTexture.destroy(e),this.inputTexture=this.outputTexture),(0,r.vA)(this.inputTexture===this.outputTexture),null!==this.outputTexture&&this.outputTexture.matchesDescription(t)||(this.outputTexture=new u(e,t),null===this.inputTexture&&(this.inputTexture=this.outputTexture))}getTextureForSampling(){return null!==this.inputTexture?this.inputTexture.texture:null}getTextureForResolving(){return(0,r.Z1)(this.outputTexture).texture}destroy(e){null!==this.outputTexture&&this.outputTexture!==this.inputTexture&&(this.outputTexture.destroy(e),this.outputTexture=null),null!==this.inputTexture&&(this.inputTexture.destroy(e),this.inputTexture=null)}}function m(e,t,s){e.length=t,e.fill(s)}class p{constructor(e,t,s,n){this.renderTargetID=e,this.pass=t,this.attachmentSlot=s,this.debugLabel=n}}class f{constructor(e){this.device=e,this.currentPass=null,this.currentGraph=null,this.renderTargetDeadPool=[],this.singleSampledTextureDeadPool=[],this.renderTargetOutputCount=[],this.renderTargetResolveCount=[],this.resolveTextureUseCount=[],this.renderTargetAliveForID=[],this.singleSampledTextureForResolveTextureID=[],this.externalTextureRenderTargetPool=[]}newGraphBuilder(){return this.beginGraphBuilder(),this}execute(e){(0,r.vA)(e===this);const t=(0,r.Z1)(this.currentGraph);this.execGraph(t),this.currentGraph=null}destroy(){for(let e=0;e<this.renderTargetAliveForID.length;e++)(0,r.vA)(void 0===this.renderTargetAliveForID[e]);for(let e=0;e<this.singleSampledTextureForResolveTextureID.length;e++)(0,r.vA)(void 0===this.singleSampledTextureForResolveTextureID[e]);for(let e=0;e<this.renderTargetDeadPool.length;e++)this.renderTargetDeadPool[e].destroy(this.device);for(let e=0;e<this.singleSampledTextureDeadPool.length;e++)this.singleSampledTextureDeadPool[e].destroy(this.device)}beginGraphBuilder(){(0,r.vA)(null===this.currentGraph),this.currentGraph=new h}pushPass(e){const t=new l("render");e(t),this.currentGraph.passes.push(t)}pushComputePass(e){const t=new l("compute");e(t),this.currentGraph.passes.push(t)}createRenderTargetID(e,t){return this.currentGraph.renderTargetDebugNames.push(t),this.currentGraph.renderTargetDescriptions.push(e)-1}createResolveTextureID(e){return this.currentGraph.resolveTextureRenderTargetIDs.push(e)-1}findMostRecentPassThatAttachedRenderTarget(e){for(let t=this.currentGraph.passes.length-1;t>=0;t--){const s=this.currentGraph.passes[t];if(s.attachmentRenderTargetID.includes(e))return s}return null}findPassForResolveRenderTarget(e){const t=(0,r.Z1)(this.findMostRecentPassThatAttachedRenderTarget(e)),s=t.attachmentRenderTargetID.indexOf(e);return(0,r.vA)(void 0===t.resolveOutputExternalTexture[s]),t}resolveRenderTargetPassAttachmentSlot(e,t){const s=e;if(void 0===s.resolveOutputIDs[t]){const e=s.attachmentRenderTargetID[t],n=this.createResolveTextureID(e);s.resolveOutputIDs[t]=n}return s.resolveOutputIDs[t]}resolveRenderTarget(e){const t=this.findPassForResolveRenderTarget(e),s=t.attachmentRenderTargetID.indexOf(e);return this.resolveRenderTargetPassAttachmentSlot(t,s)}resolveRenderTargetToExternalTexture(e,t,s=null){const n=this.findPassForResolveRenderTarget(e),i=n.attachmentRenderTargetID.indexOf(e);(0,r.vA)(void 0===n.resolveOutputIDs[i]),n.resolveOutputExternalTexture[i]=t,n.resolveOutputExternalTextureView[i]=null!==s?s:{level:0,z:0}}getRenderTargetDescription(e){return(0,r.Z1)(this.currentGraph.renderTargetDescriptions[e])}pushDebugThumbnail(e,t){const s=this.findPassForResolveRenderTarget(e),n=s.attachmentRenderTargetID.indexOf(e);if(void 0===t){const n=this.currentGraph.renderTargetDebugNames[e];t=`${s.debugName}\n${n}`}this.currentGraph.debugThumbnails.push(new p(e,s,n,t))}getDebug(){return this}getDebugThumbnails(){return this.currentGraph.debugThumbnails}getResolveTextureForID(e){const t=this.currentPass,s=t.resolveTextureInputIDs.indexOf(e);return(0,r.vA)(s>=0),(0,r.Z1)(t.resolveTextureInputTextures[s])}getRenderTargetTexture(e){const t=this.currentPass.renderTargets[e];return t?t.texture:null}acquireRenderTargetForDescription(e){for(let t=0;t<this.renderTargetDeadPool.length;t++){const s=this.renderTargetDeadPool[t];if(s.matchesDescription(e))return s.reset(),this.renderTargetDeadPool.splice(t--,1),s}return new c(this.device,e)}acquireSingleSampledTextureForDescription(e){for(let t=0;t<this.singleSampledTextureDeadPool.length;t++){const s=this.singleSampledTextureDeadPool[t];if(s.matchesDescription(e))return s.reset(),this.singleSampledTextureDeadPool.splice(t--,1),s}return new u(this.device,e)}scheduleAddUseCount(e,t){for(let e=0;e<t.attachmentRenderTargetID.length;e++){const s=t.attachmentRenderTargetID[e];void 0!==s&&(this.renderTargetOutputCount[s]++,t.renderTargetExtraRefs[e]&&this.renderTargetOutputCount[s]++)}for(let s=0;s<t.resolveTextureInputIDs.length;s++){const n=t.resolveTextureInputIDs[s];if(void 0===n)continue;this.resolveTextureUseCount[n]++;const i=e.resolveTextureRenderTargetIDs[n];this.renderTargetResolveCount[i]++}}acquireRenderTargetForID(e,t){if((0,r.vA)(this.renderTargetOutputCount[t]>0),!this.renderTargetAliveForID[t]){const s=e.renderTargetDescriptions[t],n=this.acquireRenderTargetForDescription(s);n.setDebugName(this.device,e.renderTargetDebugNames[t]),this.renderTargetAliveForID[t]=n}return this.renderTargetAliveForID[t]}acquireRenderTargetForTexture(e,t){const s=this.device.createRenderTargetFromTexture(t);return this.externalTextureRenderTargetPool.push(s),s}releaseRenderTargetForID(e,t){if(void 0===e)return null;const s=(0,r.Z1)(this.renderTargetAliveForID[e]);return t?((0,r.vA)(this.renderTargetOutputCount[e]>0),this.renderTargetOutputCount[e]--):((0,r.vA)(this.renderTargetResolveCount[e]>0),this.renderTargetResolveCount[e]--),0===this.renderTargetOutputCount[e]&&0===this.renderTargetResolveCount[e]&&(s.needsClear=!0,delete this.renderTargetAliveForID[e],this.renderTargetDeadPool.push(s)),s}acquireResolveTextureInputTextureForID(e,t){const s=e.resolveTextureRenderTargetIDs[t];(0,r.vA)(this.resolveTextureUseCount[t]>0),this.resolveTextureUseCount[t]--;const n=(0,r.Z1)(this.releaseRenderTargetForID(s,!1));if(void 0!==this.singleSampledTextureForResolveTextureID[t]){const e=this.singleSampledTextureForResolveTextureID[t];return 0===this.resolveTextureUseCount[t]&&this.singleSampledTextureDeadPool.push(e),e.texture}return(0,r.Z1)(n.texture)}determineResolveParam(e,t,s){const n=t.attachmentRenderTargetID[s];(0,r.vA)(void 0!==n);const i=t.resolveOutputIDs[s],a=t.resolveOutputExternalTexture[s],o=void 0!==i,l=void 0!==a;(0,r.vA)(!(o&&l));let h=null,c=!1,u=null;if(this.renderTargetOutputCount[n]>1&&(c=!0),o){(0,r.vA)(e.resolveTextureRenderTargetIDs[i]===n),(0,r.vA)(this.resolveTextureUseCount[i]>0),(0,r.vA)(this.renderTargetOutputCount[n]>0);const t=(0,r.Z1)(this.renderTargetAliveForID[n]);if(null!==t.texture&&1===this.renderTargetOutputCount[n])h=null,c=!0;else{if(!this.singleSampledTextureForResolveTextureID[i]){const s=(0,r.Z1)(e.renderTargetDescriptions[n]);this.singleSampledTextureForResolveTextureID[i]=this.acquireSingleSampledTextureForDescription(s),this.device.setResourceName(this.singleSampledTextureForResolveTextureID[i].texture,t.debugName+` (Resolve ${i})`)}h=this.singleSampledTextureForResolveTextureID[i].texture,u={level:0,z:0}}}else l?(h=a,u=t.resolveOutputExternalTextureView[s]):h=null;return{resolveTo:h,resolveView:u,store:c}}determinePassAttachment(e,t,s){const n=t.attachmentRenderTargetID[s],i=t.attachmentTexture[s],r=t.attachmentView[s];if(void 0!==n){const i=this.acquireRenderTargetForID(e,n),a=i.width,o=i.height,l=i.sampleCount,{resolveTo:h,resolveView:c,store:u}=this.determineResolveParam(e,t,s);return{graphRenderTarget:i,renderTarget:i.renderTarget,view:r,clearColor:i.needsClear?e.renderTargetDescriptions[n].clearColor:"load",clearDepth:i.needsClear?e.renderTargetDescriptions[n].clearDepth:"load",clearStencil:i.needsClear?e.renderTargetDescriptions[n].clearStencil:"load",resolveTo:h,resolveView:c,store:u,width:a,height:o,sampleCount:l}}if(void 0!==i){const n=null,a=i.width,o=i.height,l=1,h=null,c=null,u=!0,d=this.acquireRenderTargetForTexture(e,i),m=t.attachmentClearDescriptor[s];return{graphRenderTarget:n,renderTarget:d,view:r,clearColor:m.clearColor,clearDepth:m.clearDepth,clearStencil:m.clearStencil,resolveTo:h,resolveView:c,store:u,width:a,height:o,sampleCount:l}}return null}schedulePass(e,t){let s=0,i=0,a=0;for(let o=n.Color0;o<=n.DepthStencil;o++){const l=this.determinePassAttachment(e,t,o);if(null===l)t.renderTargets[o]=null,o===n.DepthStencil?t.descriptor.depthStencilAttachment=null:t.descriptor.colorAttachments[o]=null;else{const e=l.view.level,h=l.width>>>e,c=l.height>>>e;0===s&&(s=h,i=c,a=l.sampleCount),(0,r.vA)(h===s),(0,r.vA)(c===i),(0,r.vA)(l.sampleCount===a),null!==l.graphRenderTarget&&(l.graphRenderTarget.needsClear=!1),t.renderTargets[o]=l.graphRenderTarget,o===n.DepthStencil?t.descriptor.depthStencilAttachment=l:t.descriptor.colorAttachments[o]=l}}if(s>0&&i>0){const e=s*t.viewportX,n=i*t.viewportY,r=s*t.viewportW,a=i*t.viewportH;t.viewportX=e,t.viewportY=n,t.viewportW=r,t.viewportH=a}for(let s=0;s<t.resolveTextureInputIDs.length;s++){const n=t.resolveTextureInputIDs[s];t.resolveTextureInputTextures[s]=this.acquireResolveTextureInputTextureForID(e,n)}for(let e=0;e<t.attachmentRenderTargetID.length;e++)this.releaseRenderTargetForID(t.attachmentRenderTargetID[e],!0);for(let e=0;e<t.renderTargetExtraRefs.length;e++)t.renderTargetExtraRefs[e]&&this.releaseRenderTargetForID(t.attachmentRenderTargetID[e],!0)}scheduleGraph(e){(0,r.vA)(0===this.renderTargetOutputCount.length),(0,r.vA)(0===this.renderTargetResolveCount.length),(0,r.vA)(0===this.resolveTextureUseCount.length);for(let e=0;e<this.renderTargetDeadPool.length;e++)this.renderTargetDeadPool[e].age++;for(let e=0;e<this.singleSampledTextureDeadPool.length;e++)this.singleSampledTextureDeadPool[e].age++;m(this.renderTargetOutputCount,e.renderTargetDescriptions.length,0),m(this.renderTargetResolveCount,e.renderTargetDescriptions.length,0),m(this.resolveTextureUseCount,e.resolveTextureRenderTargetIDs.length,0);for(let t=0;t<e.passes.length;t++)this.scheduleAddUseCount(e,e.passes[t]);for(let t=0;t<e.passes.length;t++)this.schedulePass(e,e.passes[t]);for(let e=0;e<this.renderTargetOutputCount.length;e++)(0,r.vA)(0===this.renderTargetOutputCount[e]);for(let e=0;e<this.renderTargetResolveCount.length;e++)(0,r.vA)(0===this.renderTargetResolveCount[e]);for(let e=0;e<this.resolveTextureUseCount.length;e++)(0,r.vA)(0===this.resolveTextureUseCount[e]);for(let e=0;e<this.renderTargetAliveForID.length;e++)(0,r.vA)(void 0===this.renderTargetAliveForID[e]);for(let e=0;e<this.renderTargetDeadPool.length;e++)this.renderTargetDeadPool[e].age>=1&&(this.renderTargetDeadPool[e].destroy(this.device),this.renderTargetDeadPool.splice(e--,1));for(let e=0;e<this.singleSampledTextureDeadPool.length;e++)this.singleSampledTextureDeadPool[e].age>=1&&(this.singleSampledTextureDeadPool[e].destroy(this.device),this.singleSampledTextureDeadPool.splice(e--,1));for(let e=0;e<this.externalTextureRenderTargetPool.length;e++)this.device.destroyRenderTarget(this.externalTextureRenderTargetPool[e]);this.externalTextureRenderTargetPool.length=0,this.renderTargetResolveCount.length=0,this.renderTargetOutputCount.length=0,this.resolveTextureUseCount.length=0}execRenderPass(e){const t=this.device.createRenderPass(e.descriptor);t.beginDebugGroup(e.debugName),t.setViewport(e.viewportX,e.viewportY,e.viewportW,e.viewportH),null!==e.execFunc&&e.execFunc(t,this),t.endDebugGroup(),this.device.submitPass(t),null!==e.postFunc&&e.postFunc(this)}execComputePass(e){const t=this.device.createComputePass();t.beginDebugGroup(e.debugName),null!==e.execFunc&&e.execFunc(t,this),t.endDebugGroup(),this.device.submitPass(t),null!==e.postFunc&&e.postFunc(this)}execPass(e){(0,r.vA)(null===this.currentPass),this.currentPass=e,"render"===e.passType?this.execRenderPass(e):"compute"===e.passType&&this.execComputePass(e),this.currentPass=null}execGraph(e){this.scheduleGraph(e);for(let t=0;t<e.passes.length;t++)this.execPass(e.passes[t]);this.singleSampledTextureForResolveTextureID.length=0}}},7911(e,t,s){"use strict";s.d(t,{EZ:()=>n,JB:()=>f,Nj:()=>h,Qz:()=>p,bx:()=>c,ze:()=>u});var n,i,r=s(5974),a=s(5339),o=s(7714),l=s(6726);function h(e,t){return(16777215&e|(255&t)<<24)>>>0}function c(e,t){return e>>>31&1?e:(4278190335&e|(65535&t)<<8)>>>0}function u(e,t,s=65536){const n=!!(e>>>31&1),i=function(e,t,s=65536){let n=(0,a.qE)(e,0,s)/s;return t&&(n=1-n),65535&65535*n}(t,n,s);return n?function(e,t){return(0,r.vA)(t>=0),(4278190335&e|t<<8)>>>0}(e,i):function(e,t){return(0,r.vA)(t>=0),(4294967040&e|t>>>8&255)>>>0}(e,i)}!function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.ALPHA_TEST=16]="ALPHA_TEST",e[e.OPAQUE=32]="OPAQUE",e[e.TRANSLUCENT=128]="TRANSLUCENT"}(n||(n={}));class d{constructor(){this.sortKey=0,this.debug=null,this.debugMarker=null,this._bindingDescriptors=(0,r.y5)(1,()=>({bindingLayout:null,samplerBindings:[],uniformBufferBindings:[]})),this._dynamicUniformBufferByteOffsets=(0,r.y5)(4,()=>0),this._allowSkippingPipelineIfNotReady=!1,this._vertexBuffers=null,this._indexBuffer=null,this._drawStart=0,this._drawCount=0,this._drawInstanceCount=0,this._renderPipelineDescriptor={bindingLayouts:[],inputLayout:null,megaStateDescriptor:(0,l.Ly)(l.bP),program:null,topology:o.sP.Triangles,colorAttachmentFormats:[],depthStencilAttachmentFormat:null,sampleCount:1}}copyFrom(e){(0,l.$b)(this._renderPipelineDescriptor.megaStateDescriptor,e._renderPipelineDescriptor.megaStateDescriptor),this._renderPipelineDescriptor.program=e._renderPipelineDescriptor.program,this._renderPipelineDescriptor.inputLayout=e._renderPipelineDescriptor.inputLayout,this._renderPipelineDescriptor.topology=e._renderPipelineDescriptor.topology,this._renderPipelineDescriptor.colorAttachmentFormats.length=Math.max(this._renderPipelineDescriptor.colorAttachmentFormats.length,e._renderPipelineDescriptor.colorAttachmentFormats.length);for(let t=0;t<e._renderPipelineDescriptor.colorAttachmentFormats.length;t++)this._renderPipelineDescriptor.colorAttachmentFormats[t]=e._renderPipelineDescriptor.colorAttachmentFormats[t];this._renderPipelineDescriptor.depthStencilAttachmentFormat=e._renderPipelineDescriptor.depthStencilAttachmentFormat,this._renderPipelineDescriptor.sampleCount=e._renderPipelineDescriptor.sampleCount,this._uniformBuffer=e._uniformBuffer,this._drawCount=e._drawCount,this._drawStart=e._drawStart,this._drawInstanceCount=e._drawInstanceCount,this._vertexBuffers=e._vertexBuffers,this._indexBuffer=e._indexBuffer,this._allowSkippingPipelineIfNotReady=e._allowSkippingPipelineIfNotReady,this.sortKey=e.sortKey;for(let t=0;t<e._bindingDescriptors.length;t++){const s=this._bindingDescriptors[t],n=e._bindingDescriptors[t];null!==n.bindingLayout&&this._setBindingLayout(t,n.bindingLayout);for(let e=0;e<Math.min(s.uniformBufferBindings.length,n.uniformBufferBindings.length);e++)s.uniformBufferBindings[e].wordCount=n.uniformBufferBindings[e].wordCount;this.setSamplerBindingsFromTextureMappings(n.samplerBindings)}for(let t=0;t<e._dynamicUniformBufferByteOffsets.length;t++)this._dynamicUniformBufferByteOffsets[t]=e._dynamicUniformBufferByteOffsets[t]}validate(){for(let e=0;e<this._bindingDescriptors.length;e++){const t=this._bindingDescriptors[e];for(let e=0;e<t.bindingLayout.numUniformBuffers;e++)(0,r.vA)(t.uniformBufferBindings[e].wordCount>0)}(0,r.vA)(this._drawCount>0)}setGfxProgram(e){this._renderPipelineDescriptor.program=e}setMegaStateFlags(e){return(0,l.$b)(this._renderPipelineDescriptor.megaStateDescriptor,e),this._renderPipelineDescriptor.megaStateDescriptor}getMegaStateFlags(){return this._renderPipelineDescriptor.megaStateDescriptor}setVertexInput(e,t,s){this._vertexBuffers=t,this._indexBuffer=s,this._renderPipelineDescriptor.inputLayout=e}_setBindingLayout(e,t){(0,r.vA)(t.numUniformBuffers<=this._dynamicUniformBufferByteOffsets.length),this._renderPipelineDescriptor.bindingLayouts[e]=t;const s=this._bindingDescriptors[e];s.bindingLayout=t;for(let e=s.uniformBufferBindings.length;e<t.numUniformBuffers;e++)s.uniformBufferBindings.push({buffer:null,wordCount:0});for(let e=s.samplerBindings.length;e<t.numSamplers;e++)s.samplerBindings.push({gfxSampler:null,gfxTexture:null,lateBinding:null})}setBindingLayouts(e){(0,r.vA)(e.length<=this._bindingDescriptors.length);for(let t=0;t<this._bindingDescriptors.length;t++)this._setBindingLayout(t,e[t])}setDrawCount(e,t=0,s=1){this._drawCount=e,this._drawStart=t,this._drawInstanceCount=s}setUniformBuffer(e){this._uniformBuffer=e}allocateUniformBuffer(e,t){return(0,r.vA)(this._bindingDescriptors[0].bindingLayout.numUniformBuffers<=this._dynamicUniformBufferByteOffsets.length),(0,r.vA)(e<this._bindingDescriptors[0].bindingLayout.numUniformBuffers),this._dynamicUniformBufferByteOffsets[e]=this._uniformBuffer.allocateChunk(t)<<2,this._bindingDescriptors[0].uniformBufferBindings[e].wordCount=t,this.getUniformBufferOffset(e)}getUniformBufferOffset(e){return this._dynamicUniformBufferByteOffsets[e]>>>2}setUniformBufferOffset(e,t,s){this._dynamicUniformBufferByteOffsets[e]=t<<2,this._bindingDescriptors[0].uniformBufferBindings[e].wordCount=s}mapUniformBufferF32(e){return this._uniformBuffer.mapBufferF32()}getUniformBuffer(){return this._uniformBuffer}setSamplerBindings(e,t){const s=this._bindingDescriptors[e];for(let e=0;e<s.samplerBindings.length;e++){const n=s.samplerBindings[e],i=t[e];null!=i?(n.gfxTexture=i.gfxTexture,n.gfxSampler=i.gfxSampler,n.lateBinding=i.lateBinding):(n.gfxTexture=null,n.gfxSampler=null,n.lateBinding=null)}}setSamplerBindingsFromTextureMappings(e){(0,r.vA)(1===this._bindingDescriptors.length),this.setSamplerBindings(0,e)}hasLateSamplerBinding(e){for(let t=0;t<this._bindingDescriptors.length;t++){const s=this._bindingDescriptors[t];for(let t=0;t<s.samplerBindings.length;t++)if(s.samplerBindings[t].lateBinding===e)return!0}return!1}resolveLateSamplerBinding(e,t){for(let s=0;s<this._bindingDescriptors.length;s++){const n=this._bindingDescriptors[s];for(let s=0;s<n.samplerBindings.length;s++){const i=n.samplerBindings[s];i.lateBinding===e&&(null===t?(i.gfxTexture=null,i.gfxSampler=null):((0,r.vA)(null===t.lateBinding),i.gfxTexture=t.gfxTexture,null!==t.gfxSampler&&(i.gfxSampler=t.gfxSampler)),i.lateBinding=null)}}}setAllowSkippingIfPipelineNotReady(e){this._allowSkippingPipelineIfNotReady=e}setAttachmentFormatsFromRenderPass(e,t){const s=e.queryRenderPass(t);let n=-1;for(let t=0;t<s.colorAttachments.length;t++){const i=null!==s.colorAttachments[t]?e.queryRenderTarget(s.colorAttachments[t].renderTarget):null;this._renderPipelineDescriptor.colorAttachmentFormats[t]=null!==i?i.pixelFormat:null,null!==i&&(-1===n?n=i.sampleCount:(0,r.vA)(n===i.sampleCount))}const i=null!==s.depthStencilAttachment?e.queryRenderTarget(s.depthStencilAttachment.renderTarget):null;this._renderPipelineDescriptor.depthStencilAttachmentFormat=null!==i?i.pixelFormat:null,null!==i&&(-1===n?n=i.sampleCount:(0,r.vA)(n==i.sampleCount)),(0,r.vA)(n>0),this._renderPipelineDescriptor.sampleCount=n}drawOnPass(e,t){const s=e.device;this.setAttachmentFormatsFromRenderPass(s,t);const n=e.createRenderPipeline(this._renderPipelineDescriptor);if(!s.pipelineQueryReady(n)){if(this._allowSkippingPipelineIfNotReady)return;s.pipelineForceReady(n)}null!==this.debugMarker&&t.beginDebugGroup(this.debugMarker),t.setPipeline(n),t.setVertexInput(this._renderPipelineDescriptor.inputLayout,this._vertexBuffers,this._indexBuffer);let i=0;for(let s=0;s<this._bindingDescriptors.length;s++){const n=this._bindingDescriptors[s];for(let e=0;e<n.uniformBufferBindings.length;e++)n.uniformBufferBindings[e].buffer=(0,r.Z1)(this._uniformBuffer.gfxBuffer);const a=e.createBindings(n),o=n.bindingLayout.numUniformBuffers;t.setBindings(s,a,this._dynamicUniformBufferByteOffsets.slice(i,i+o)),i+=o}const a=null!==this._indexBuffer;this._drawInstanceCount>1?((0,r.vA)(a),t.drawIndexedInstanced(this._drawCount,this._drawStart,this._drawInstanceCount)):a?t.drawIndexed(this._drawCount,this._drawStart):t.draw(this._drawCount,this._drawStart),null!==this.debugMarker&&t.endDebugGroup()}}function m(e,t){return e.sortKey-t.sortKey}!function(e){e[e.Forwards=0]="Forwards",e[e.Backwards=1]="Backwards"}(i||(i={}));class p{constructor(e=m,t=i.Forwards){this.compareFunction=e,this.executionOrder=t,this.renderInsts=[]}submitRenderInst(e){e.validate(),this.renderInsts.push(e)}hasLateSamplerBinding(e){for(let t=0;t<this.renderInsts.length;t++)if(this.renderInsts[t].hasLateSamplerBinding(e))return!0;return!1}resolveLateSamplerBinding(e,t){for(let s=0;s<this.renderInsts.length;s++)this.renderInsts[s].resolveLateSamplerBinding(e,t)}ensureSorted(){null!==this.compareFunction&&0!==this.renderInsts.length&&this.renderInsts.sort(this.compareFunction)}drawOnPassRendererNoReset(e,t){if(this.ensureSorted(),this.executionOrder===i.Forwards)for(let s=0;s<this.renderInsts.length;s++)this.renderInsts[s].drawOnPass(e,t);else for(let s=this.renderInsts.length-1;s>=0;s--)this.renderInsts[s].drawOnPass(e,t)}reset(){this.renderInsts.length=0}drawOnPassRenderer(e,t){this.drawOnPassRendererNoReset(e,t),this.reset()}}class f{constructor(e){this.gfxRenderCache=e,this.templateStack=[],this.currentRenderInstList=null}newRenderInst(){const e=new d;return this.templateStack.length>0&&e.copyFrom(this.getTemplateRenderInst()),e}submitRenderInst(e){this.currentRenderInstList.submitRenderInst(e)}setCurrentRenderInstList(e){this.currentRenderInstList=e}pushTemplateRenderInst(){const e=new d;return this.templateStack.length>0&&e.copyFrom(this.getTemplateRenderInst()),this.templateStack.push(e),e}popTemplateRenderInst(){this.templateStack.pop()}getTemplateRenderInst(){return this.templateStack[this.templateStack.length-1]}}},2898(e,t,s){"use strict";s.d(t,{ar:()=>c,hv:()=>h});var n=s(7714),i=s(1110),r=s(373);function a(e,t){return`#define ${e} ${t}`}function o(e){if(void 0===e)return null;const t=/binding\s*=\s*(\d+)/.exec(e);if(null!==t){const e=parseInt(t[1],10);if(!Number.isNaN(e))return e}return null}function l(e){let t="",s=e;return e.endsWith("Shadow")&&(s=s.slice(0,-6),t="Shadow"),[s,t]}function h(e,t,s,h=null,c=-1){const u=s.split("\n").map(e=>e.replace(/\s*[/][/].*$/,"")).filter(e=>!(!e||/^\s+$/.test(e)));let d="";null!==h&&(d=[...h.entries()].map(([e,t])=>a(e,t)).join("\n"));let m=u.filter(e=>e.startsWith("precision")).join("\n")||"precision mediump float;",p=u.filter(e=>!e.startsWith("precision")).join("\n"),f="";if(e.viewportOrigin===n.S0.UpperLeft&&(f+=`${a("GFX_VIEWPORT_ORIGIN_TL","1")}\n`),e.clipSpaceNearZ===n.uA.Zero&&(f+=`${a("GFX_CLIPSPACE_NEAR_ZERO","1")}\n`),e.explicitBindingLocations){let s=0,n=0,r=0;(0,i.vA)(e.separateSamplerTextures),p=p.replace(/^(layout\((.*)\))?\s*uniform sampler(\w+) (.*);/gm,(e,i,r,a,h)=>{let u=o(r);null===u&&(u=n++),c=Math.max(c,u);const[d,m]=l(a);return"frag"===t?`\nlayout(set = ${s}, binding = ${2*u+0}) uniform texture${d} T_${h};\nlayout(set = ${s}, binding = ${2*u+1}) uniform sampler${m} S_${h};`.trim():""});let h=2*c+2;p=p.replace(/^(layout\((.*)\))?\s*uniform(.+{)$/gm,(e,t,n,i)=>`layout(${n?`${n}, `:""}set = ${s}, binding = ${h++}) uniform ${i}`),p=p.replace("frag"===t?/^\b(varying|in)\b/gm:/^\b(varying|out)\b/gm,(e,t)=>`layout(location = ${r++}) ${t}`),f+=`${a("gl_VertexID","gl_VertexIndex")}\n`,f+=`${a("gl_InstanceID","gl_InstanceIndex")}\n`,m=m.replace(/^precision (.*) sampler(.*);$/gm,"")}else{let e=0;p=p.replace(/^(layout\((.*)\))?\s*uniform sampler(\w+) (.*);/gm,(t,s,n,i,r)=>{let a=o(n);return null===a&&(a=e++),`uniform sampler${i} ${r}; // BINDING=${a}`})}p=p.replace(/\bPU_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>`SAMPLER_${t}(P_${s})`),p=p.replace(/\bPF_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>`PP_SAMPLER_${t}(P_${s})`),p=p.replace(/\bPU_TEXTURE\((.*?)\)/g,(e,t)=>`TEXTURE(P_${t})`),e.separateSamplerTextures?(p=p.replace(/\bPD_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>{const[n,i]=l(t);return`texture${n} T_P_${s}, sampler${i} S_P_${s}`}),p=p.replace(/\bPP_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>`T_${s}, S_${s}`),p=p.replace(/\bSAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>`sampler${t}(T_${s}, S_${s})`),p=p.replace(/\bTEXTURE\((.*?)\)/g,(e,t)=>`T_${t}`)):(p=p.replace(/\bPD_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>`sampler${t} P_${s}`),p=p.replace(/\bPP_SAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>s),p=p.replace(/\bSAMPLER_(\w+)\((.*?)\)/g,(e,t,s)=>s),p=p.replace(/\bTEXTURE\((.*?)\)/g,(e,t)=>t));const g=p.includes("gl_FragColor");return`\n${e.glslVersion}\n${m}\n#define ${t.toUpperCase()}\n#define attribute in\n#define varying ${"vert"===t?"out":"in"}\n#define main${"vert"===t?"VS":"PS"} main\n${f}\n${g?`\n#define gl_FragColor o_color\n${"frag"===t?"layout(location = 0) out vec4 o_color;":""}\n`:""}\n${r.i.mat4}\n${d}\n${p}\n`.trim()}function c(e,t,s,n=null){return{vert:t,frag:s,preprocessedVert:h(e,"vert",t,n),preprocessedFrag:h(e,"frag",s,n)}}},1659(e,t,s){"use strict";s.d(t,{I:()=>c});var n=s(2003),i=s(8771);function r(e){return{lightingEnabled:e.lightingEnabled,matColorSource:e.matColorSource,ambColorSource:e.ambColorSource,litMask:e.litMask,diffuseFunction:e.diffuseFunction,attenuationFunction:e.attenuationFunction}}function a(e){return{alphaChannel:r(e.alphaChannel),colorChannel:r(e.colorChannel)}}function o(e){return{type:e.type,source:e.source,matrix:e.matrix,normalize:e.normalize,postMatrix:e.postMatrix}}function l(e){return{colorInA:e.colorInA,colorInB:e.colorInB,colorInC:e.colorInC,colorInD:e.colorInD,colorOp:e.colorOp,colorBias:e.colorBias,colorScale:e.colorScale,colorClamp:e.colorClamp,colorRegId:e.colorRegId,alphaInA:e.alphaInA,alphaInB:e.alphaInB,alphaInC:e.alphaInC,alphaInD:e.alphaInD,alphaOp:e.alphaOp,alphaBias:e.alphaBias,alphaScale:e.alphaScale,alphaClamp:e.alphaClamp,alphaRegId:e.alphaRegId,texCoordId:e.texCoordId,texMap:e.texMap,channelId:e.channelId,konstColorSel:e.konstColorSel,konstAlphaSel:e.konstAlphaSel,indTexStage:e.indTexStage,indTexFormat:e.indTexFormat,indTexBiasSel:e.indTexBiasSel,indTexAlphaSel:e.indTexAlphaSel,indTexMatrix:e.indTexMatrix,indTexWrapS:e.indTexWrapS,indTexWrapT:e.indTexWrapT,indTexAddPrev:e.indTexAddPrev,indTexUseOrigLOD:e.indTexUseOrigLOD,texSwapTable:e.texSwapTable,rasSwapTable:e.rasSwapTable}}function h(e){return{texture:e.texture,texCoordId:e.texCoordId,scaleS:e.scaleS,scaleT:e.scaleT}}class c{constructor(e=null){this.name=e,this.lightChannels=[],this.texGens=[],this.tevStages=[],this.indTexStages=[],this.reset()}reset(){this.cullMode=n.Ac.NONE,this.lightChannels.length=0,this.texGens.length=0,this.tevStages.length=0,this.indTexStages.length=0,this.alphaTest={},this.setAlphaCompare(n.oH.ALWAYS,0,n.O2.AND,n.oH.ALWAYS,0),this.ropInfo={},this.setFog(n.Du.NONE,!1),this.setBlendMode(n.Nx.NONE,n.dn.SRCALPHA,n.dn.INVSRCALPHA,n.Sn.CLEAR),this.setZMode(!0,n.oH.LEQUAL,!0),this.setColorUpdate(!0),this.setAlphaUpdate(!1),this.usePnMtxIdx=!0}setCullMode(e){this.cullMode=e}ensureTexCoordGen(e){return void 0===this.texGens[e]&&(this.texGens[e]={}),this.texGens[e]}setTexCoordGen(e,t,s,i,r=!1,a=n.eV.PTIDENTITY){const o=this.ensureTexCoordGen(e);o.type=t,o.source=s,o.matrix=i,o.normalize=r,o.postMatrix=a}ensureLightChannel(e){return void 0===this.lightChannels[e]&&(this.lightChannels[e]={colorChannel:{},alphaChannel:{}},this.setChanCtrlInternal(this.lightChannels[e].colorChannel,!1,n.uj.REG,n.uj.REG,0,n.jN.NONE,n.bg.NONE),this.setChanCtrlInternal(this.lightChannels[e].alphaChannel,!1,n.uj.REG,n.uj.REG,0,n.jN.NONE,n.bg.NONE)),this.lightChannels[e]}setChanCtrlInternal(e,t,s,n,i,r,a){e.lightingEnabled=t,e.ambColorSource=s,e.matColorSource=n,e.litMask=i,e.diffuseFunction=r,e.attenuationFunction=a}setChanCtrl(e,t,s,n,i,r,a){const o=this.ensureLightChannel(1&e),l=(e>>>1)+1;1&l&&this.setChanCtrlInternal(o.colorChannel,t,s,n,i,r,a),2&l&&this.setChanCtrlInternal(o.alphaChannel,t,s,n,i,r,a)}ensureTevStage(e){return void 0===this.tevStages[e]&&(this.tevStages[e]={},e<=7?this.setTevOrder(e,n.gw.TEXCOORD0+e,n.zH.TEXMAP0+e,n.Ug.COLOR0A0):this.setTevOrder(e,n.gw.TEXCOORD_NULL,n.zH.TEXMAP_NULL,n.Ug.COLOR0A0),this.setTevColorOp(e,n.fQ.ADD,n.bt.ZERO,n.mX.SCALE_1,!0,n.UZ.PREV),this.setTevAlphaOp(e,n.fQ.ADD,n.bt.ZERO,n.mX.SCALE_1,!0,n.UZ.PREV),this.setTevColorIn(e,n.CC.ZERO,n.CC.ZERO,n.CC.ZERO,n.CC.TEXC),this.setTevAlphaIn(e,n.CA.ZERO,n.CA.ZERO,n.CA.ZERO,n.CA.TEXA),this.setTevKColorSel(e,n.jl.KCSEL_2_8),this.setTevKAlphaSel(e,n.u_.KASEL_1),this.setTevDirect(e)),this.tevStages[e]}setTevOrder(e,t,s,n){const i=this.ensureTevStage(e);i.texCoordId=t,i.texMap=s,i.channelId=n}setTevColorOp(e,t,s,n,i,r){const a=this.ensureTevStage(e);a.colorOp=t,a.colorBias=s,a.colorScale=n,a.colorClamp=i,a.colorRegId=r}setTevAlphaOp(e,t,s,n,i,r){const a=this.ensureTevStage(e);a.alphaOp=t,a.alphaBias=s,a.alphaScale=n,a.alphaClamp=i,a.alphaRegId=r}setTevColorIn(e,t,s,n,i){const r=this.ensureTevStage(e);r.colorInA=t,r.colorInB=s,r.colorInC=n,r.colorInD=i}setTevAlphaIn(e,t,s,n,i){const r=this.ensureTevStage(e);r.alphaInA=t,r.alphaInB=s,r.alphaInC=n,r.alphaInD=i}setTevKColorSel(e,t){this.ensureTevStage(e).konstColorSel=t}setTevKAlphaSel(e,t){this.ensureTevStage(e).konstAlphaSel=t}setTevSwapMode(e,t,s){const n=this.ensureTevStage(e);n.rasSwapTable=t,n.texSwapTable=s}setTevIndirect(e,t,s,n,i,r,a,o,l,h){const c=this.ensureTevStage(e);c.indTexStage=t,c.indTexFormat=s,c.indTexBiasSel=n,c.indTexAlphaSel=h,c.indTexMatrix=i,c.indTexWrapS=r,c.indTexWrapT=a,c.indTexAddPrev=o,c.indTexUseOrigLOD=l}setTevIndWarp(e,t,s,i,r){const a=s?n.QE.ST:n.QE.NONE,o=i?n.D_._0:n.D_.OFF;this.setTevIndirect(e,t,n.yU._8,a,r,o,o,!1,!1,n.zi.OFF)}setTevDirect(e){this.setTevIndirect(e,n.Ei.STAGE0,n.yU._8,n.QE.NONE,n.fw.OFF,n.D_.OFF,n.D_.OFF,!1,!1,n.zi.OFF)}ensureIndTexStage(e){return void 0===this.indTexStages[e]&&(this.indTexStages[e]={},this.setIndTexScale(e,n.ru._1,n.ru._1)),this.indTexStages[e]}setIndTexOrder(e,t,s){const n=this.ensureIndTexStage(e);n.texCoordId=t,n.texture=s}setIndTexScale(e,t,s){const n=this.ensureIndTexStage(e);n.scaleS=t,n.scaleT=s}setAlphaCompare(e,t,s,n,i){this.alphaTest.compareA=e,this.alphaTest.referenceA=t/255,this.alphaTest.op=s,this.alphaTest.compareB=n,this.alphaTest.referenceB=i/255}setFog(e,t){this.ropInfo.fogType=e,this.ropInfo.fogAdjEnabled=t}setBlendMode(e,t,s,i=n.Sn.CLEAR){this.ropInfo.blendMode=e,this.ropInfo.blendSrcFactor=t,this.ropInfo.blendDstFactor=s,this.ropInfo.blendLogicOp=i}setZMode(e,t,s){this.ropInfo.depthTest=e,this.ropInfo.depthFunc=t,this.ropInfo.depthWrite=s}setDstAlpha(e){this.ropInfo.dstAlpha=e}setColorUpdate(e){this.ropInfo.colorUpdate=e}setAlphaUpdate(e){this.ropInfo.alphaUpdate=e}setUsePnMtxIdx(e){this.usePnMtxIdx=e}finish(e=null){null===e&&(e=this.name),null===e&&(e="");const t={name:e,cullMode:this.cullMode,lightChannels:this.lightChannels.map(a),texGens:this.texGens.map(o),tevStages:this.tevStages.map(l),indTexStages:this.indTexStages.map(h),alphaTest:(n=this.alphaTest,{compareA:n.compareA,referenceA:n.referenceA,op:n.op,compareB:n.compareB,referenceB:n.referenceB}),ropInfo:(s=this.ropInfo,{fogType:s.fogType,fogAdjEnabled:s.fogAdjEnabled,blendMode:s.blendMode,blendSrcFactor:s.blendSrcFactor,blendDstFactor:s.blendDstFactor,blendLogicOp:s.blendLogicOp,depthTest:s.depthTest,depthFunc:s.depthFunc,depthWrite:s.depthWrite,dstAlpha:s.dstAlpha,colorUpdate:s.colorUpdate,alphaUpdate:s.alphaUpdate}),usePnMtxIdx:this.usePnMtxIdx};var s,n;return(0,i.QX)(t),t}}},930(e,t,s){"use strict";s.d(t,{Cy:()=>O,Vt:()=>y,fg:()=>i,hj:()=>L});var n,i,r=s(5974),a=s(2003),o=s(8905),l=s(7653),h=s(2466),c=s(1110);function u(e){if(e===a.cg.POS)return i.POS;if(e===a.cg.NRM)return i.NRM;if(e===a.cg.CLR0)return i.CLR0;if(e===a.cg.CLR1)return i.CLR1;throw"whoops"}function d(e){return e===a.cg.PNMTXIDX||m(e)}function m(e){switch(e){case a.cg.TEX0MTXIDX:case a.cg.TEX1MTXIDX:case a.cg.TEX2MTXIDX:case a.cg.TEX3MTXIDX:case a.cg.TEX4MTXIDX:case a.cg.TEX5MTXIDX:case a.cg.TEX6MTXIDX:case a.cg.TEX7MTXIDX:return!0;default:return!1}}function p(e){switch(e){case a.cg.CLR0:case a.cg.CLR1:return!0;default:return!1}}function f(e){switch(e){case a.cg.TEX0:case a.cg.TEX1:case a.cg.TEX2:case a.cg.TEX3:case a.cg.TEX4:case a.cg.TEX5:case a.cg.TEX6:case a.cg.TEX7:return!0;default:return!1}}function g(e,t){return d(e)?1:function(e){switch(e){case a.aL.U8:case a.aL.S8:case a.aL.RGBA8:return 1;case a.aL.U16:case a.aL.S16:return 2;case a.aL.F32:return 4}}(t.compType)}function T(e,t){if(d(e))return 1;if(p(e))switch(t.compType){case a.aL.RGB565:return 2;case a.aL.RGB8:return 3;case a.aL.RGBX8:return 4;case a.aL.RGBA4:return 2;case a.aL.RGBA6:return 3;case a.aL.RGBA8:return 4}return g(e,t)*x(e,t)}function x(e,t){return e===a.cg.NRM&&t.compCnt===a.xA.NRM_NBT?9:(0,l.UX)(function(e,t){return d(e)?l.wd.R:function(e,t){switch(e){case a.cg.POS:if(t===a.xA.POS_XY)return l.wd.RG;if(t===a.xA.POS_XYZ)return l.wd.RGB;case a.cg.NRM:return l.wd.RGB;case a.cg.CLR0:case a.cg.CLR1:if(t===a.xA.CLR_RGB)return l.wd.RGB;if(t===a.xA.CLR_RGBA)return l.wd.RGBA;case a.cg.TEX0:case a.cg.TEX1:case a.cg.TEX2:case a.cg.TEX3:case a.cg.TEX4:case a.cg.TEX5:case a.cg.TEX6:case a.cg.TEX7:if(t===a.xA.TEX_S)return l.wd.R;if(t===a.xA.TEX_ST)return l.wd.RG;case a.cg.NULL:default:throw new Error("whoops")}}(e,t.compCnt)}(e,t))}function v(e,t){return d(e)?a.aL.U8:t.compType}function C(e,t){return e===a.cg.NRM&&t.compCnt===a.xA.NRM_NBT3?3:1}function b(e){switch(e){case a.cg.PNMTXIDX:return"PNMTXIDX";case a.cg.TEX0MTXIDX:return"TEX0MTXIDX";case a.cg.TEX1MTXIDX:return"TEX1MTXIDX";case a.cg.TEX2MTXIDX:return"TEX2MTXIDX";case a.cg.TEX3MTXIDX:return"TEX3MTXIDX";case a.cg.TEX4MTXIDX:return"TEX4MTXIDX";case a.cg.TEX5MTXIDX:return"TEX5MTXIDX";case a.cg.TEX6MTXIDX:return"TEX6MTXIDX";case a.cg.TEX7MTXIDX:return"TEX7MTXIDX";case a.cg.POS:return"POS";case a.cg.NRM:return"NRM";case a.cg.CLR0:return"CLR0";case a.cg.CLR1:return"CLR1";case a.cg.TEX0:return"TEX0";case a.cg.TEX1:return"TEX1";case a.cg.TEX2:return"TEX2";case a.cg.TEX3:return"TEX3";case a.cg.TEX4:return"TEX4";case a.cg.TEX5:return"TEX5";case a.cg.TEX6:return"TEX6";case a.cg.TEX7:return"TEX7";default:throw new Error("whoops")}}function _(e,t){let s=0;for(let n=0;n<t.length;n++){const i=t[n],o=e[n];if(!i||i.type===a.WP.NONE)continue;const l=C(n,o);d(n)&&(0,r.vA)(i.type===a.WP.DIRECT),i.type===a.WP.DIRECT?s+=T(n,o):i.type===a.WP.INDEX8?s+=1*l:i.type===a.WP.INDEX16&&(s+=2*l)}return{srcVertexSize:s,vatFormat:e,vcd:t}}function y(e,t=!1){function s(e,t=function(e){switch(e){case i.TEX0123MTXIDX:case i.TEX4567MTXIDX:return l.$Y.U8_RGBA_NORM;case i.POS:return l.$Y.F32_RGBA;case i.NRM:case i.TANGENT:case i.BINRM:return l.$Y.F32_RGB;case i.CLR0:case i.CLR1:return l.$Y.U8_RGBA_NORM;case i.TEX01:case i.TEX23:case i.TEX45:case i.TEX67:return l.$Y.F32_RGBA;default:throw"whoops"}}(e)){const s=h.find(t=>t.attrInput===e);if(void 0!==s)return s;{const s=(0,l.Su)(t),n=(0,l.Eo)(t);o=(0,r.MM)(o,s);const i=o;o+=s*n;const a={attrInput:e,bufferIndex:0,bufferOffset:i,format:t};return h.push(a),a}}let o=0;const h=[],c=[],d=[];for(let o=0;o<e.length;o++){const h=e[o];if(!h||h.type===a.WP.NONE)continue;const g=(0,r.rB)(h.outputMode,n.VertexData);if(g===n.None)continue;let T,x,v=0;if(g===n.Index)T=s(u(o),l.$Y.U16_R),x=T.format;else if(m(o))T=s(o<a.cg.TEX4MTXIDX?i.TEX0123MTXIDX:i.TEX4567MTXIDX),v=o-a.cg.TEX0MTXIDX&3,x=l.$Y.U8_RGBA;else if(o===a.cg.POS)T=s(i.POS),x=l.$Y.F32_RGB;else if(o===a.cg.PNMTXIDX)T=s(i.POS),v=3,x=l.$Y.F32_R;else if(o===a.cg.NRM&&t)T=s(i.NRM),s(i.BINRM),s(i.TANGENT),x=T.format;else if(o===a.cg.NRM)T=s(i.NRM),x=T.format;else if(f(o)){const e=o-a.cg.TEX0;T=s(i.TEX01+(e>>>1)),v=2*(1&e),x=l.$Y.F32_RG}else{if(!p(o))throw"whoops";T=s(u(o)),x=T.format}const C=(0,l.Su)(T.format)*v;c[o]=T.bufferOffset+C,d[o]=x}o=(0,r.MM)(o,4);const g=[o];return{indexFormat:l.$Y.U16_R,vertexBufferStrides:g,singleVertexInputLayouts:h,vertexAttributeOffsets:c,vertexAttributeFormats:d}}function S(e,t){function s(e){return`vtxArrayViews[${e}]`}function i(i){const h=t.vatFormat[i],c=t.vcd[i];if(!c||c.type===a.WP.NONE)return"";const u=(0,r.rB)(c.outputMode,n.VertexData),m=e.vertexAttributeFormats[i],f=e.vertexAttributeOffsets[i];let C=-1;function _(e){const t=1<<function(e,t){if(d(e))return 0;if(e===a.cg.NRM){if(t.compType===a.aL.U8||t.compType===a.aL.S8)return 6;if(t.compType===a.aL.U16||t.compType===a.aL.S16)return 14;throw"whoops"}return function(e,t){switch(e){case a.aL.F32:case a.aL.RGBA8:return 0;case a.aL.U8:case a.aL.U16:case a.aL.S8:case a.aL.S16:return t}}(t.compType,t.compShift)}(i,h);return 1===t?e:`(${e} / ${t})`}function y(e,t){switch(v(i,h)){case a.aL.F32:return`${e}.getFloat32(${t})`;case a.aL.U8:return _(`${e}.getUint8(${t})`);case a.aL.U16:return _(`${e}.getUint16(${t})`);case a.aL.S8:return _(`${e}.getInt8(${t})`);case a.aL.S16:return _(`${e}.getInt16(${t})`);default:throw"whoops"}}function S(e,t){const s=(0,l.pZ)(m),n=(0,l.vg)(m)&l.lk.Normalized;if(s===l.np.F32)return function(e,t){return`dstVertexDataView.setFloat32(dstVertexDataOffs + ${e}, ${t}, ${(0,o.G)()===o.H.LITTLE_ENDIAN})`}(e,t);if(s===l.np.U8&&n)return function(e,t){return`dstVertexDataView.setUint8(dstVertexDataOffs + ${e}, ${t} * 0xFF)`}(e,t);if(s===l.np.U8)return function(e,t){return`dstVertexDataView.setUint8(dstVertexDataOffs + ${e}, ${t})`}(e,t);throw"whoops"}function w(e,t){if(u===n.VertexData)return d(i)?function(e,t){let s="";const n=g(i,h),a=x(i,h);return(0,r.Z1)(1===n&&1===a),s+=`\n    ${S(f,`(${y(e,`${t}`)} / 3)`)};`,s}(e,t):p(i)?function(e,t){const s=f;(0,r.vA)(4===(0,l.Eo)(m));const n=`_T${i}`,o=v(i,h);if(o===a.aL.RGB565)return`\n    var ${n} = ${e}.getUint16(${t});\n    ${S(s+0,`(((${n} >>> 11) & 0x1F) / 0x1F)`)};\n    ${S(s+1,`(((${n} >>>  5) & 0x3F) / 0x3F)`)};\n    ${S(s+2,`(((${n} >>>  0) & 0x1F) / 0x1F)`)};\n    ${S(s+3,"1.0")};\n`;if(o===a.aL.RGB8||o===a.aL.RGBX8)return`\n    ${S(s+0,`${e}.getUint8(${t} + 0) / 0xFF`)};\n    ${S(s+1,`${e}.getUint8(${t} + 1) / 0xFF`)};\n    ${S(s+2,`${e}.getUint8(${t} + 2) / 0xFF`)};\n    ${S(s+3,"1.0")};\n`;if(o===a.aL.RGBA4)return`\n    var ${n} = ${e}.getUint16(${t});\n    ${S(s+0,`(((${n} >>> 12) & 0x0F) / 0x0F)`)};\n    ${S(s+1,`(((${n} >>>  8) & 0x0F) / 0x0F)`)};\n    ${S(s+2,`(((${n} >>>  4) & 0x0F) / 0x0F)`)};\n    ${S(s+3,`(((${n} >>>  0) & 0x0F) / 0x0F)`)};\n`;if(o===a.aL.RGBA6)return`\n    var ${n} = (${e}.getUint8(${t} + 0) << 16) | (${e}.getUint8(${t} + 1) << 8) | (${e}.getUint8(${t} + 2));\n    ${S(s+0,`(((${n} >>> 18) & 0x3F) / 0x3F)`)};\n    ${S(s+1,`(((${n} >>> 12) & 0x3F) / 0x3F)`)};\n    ${S(s+2,`(((${n} >>>  6) & 0x3F) / 0x3F)`)};\n    ${S(s+3,`(((${n} >>>  0) & 0x3F) / 0x3F)`)};\n`;if(o===a.aL.RGBA8)return`\n    ${S(s+0,`${e}.getUint8(${t} + 0) / 0xFF`)};\n    ${S(s+1,`${e}.getUint8(${t} + 1) / 0xFF`)};\n    ${S(s+2,`${e}.getUint8(${t} + 2) / 0xFF`)};\n    ${S(s+3,`${e}.getUint8(${t} + 3) / 0xFF`)};\n`;throw"whoops"}(e,t):function(e,t){let s="";const n=g(i,h),r=x(i,h),a=(0,l.Su)(m);for(let i=0;i<r;i++)s+=`\n    ${S(f+i*a,y(e,`${t} + ${i*n}`))};`;const o=(0,l.Eo)(m);for(let e=r;e<o;e++)s+=`\n    ${S(f+e*a,"0.0")};`;return s}(e,t);if(u===n.Index)throw"whoops";return""}function A(e,t,s,r=""){if(u===n.VertexData){const n=`arrayOffset${i}${r}`;return`\n    const ${n} = (${t}) * vtxArrayStrides[${i}];${w(e,n)}\n    drawCallIdx += ${s};`}return u===n.Index?`\n    // ${b(i)} - Index\n    ${a=f,l=t,`dstVertexDataView.setUint16(dstVertexDataOffs + ${a}, ${l}, ${(0,o.G)()===o.H.LITTLE_ENDIAN})`};\n    drawCallIdx += ${s};`:`\n    // ${b(i)} - None\n    drawCallIdx += ${s};`;var a,l}function E(e,t,s){return i===a.cg.NRM&&h.compCnt===a.xA.NRM_NBT3?`\n    // NRM\n    ${A(e,t,s,"_N")}\n    // BINRM\n    ${A(e,t,s,"_B")}\n    // TANGENT\n    ${A(e,t,s,"_T")}`:`\n    // ${b(i)}\n    ${A(e,t,s)}`}switch(c.type===a.WP.DIRECT&&(C=T(i,h)),c.type){case a.WP.DIRECT:return`\n    // ${b(i)}\n    ${w("dlView","drawCallIdx")}\n    drawCallIdx += ${C};`;case a.WP.INDEX8:return E(s(i),"dlView.getUint8(drawCallIdx)",1);case a.WP.INDEX16:return E(s(i),"dlView.getUint16(drawCallIdx)",2);default:throw"whoops"}}let h="";for(let e=0;e<=a.cg.MAX;e++)h+=i(e);return h}function w(e,t){return new Function(`\n"use strict";\n\n${e}\n\nreturn function() {\n    return ${t};\n}();\n`)()}function A(e,t){return w(`\nfunction run(dstVertexDataView, dstVertexDataOffs, dlView, drawCallIdx, vtxArrayViews, vtxArrayStrides) {\n    ${S(e,t)}\n    return drawCallIdx;\n}\n`,"run")}!function(e){e[e.VertexData=0]="VertexData",e[e.Index=1]="Index",e[e.None=2]="None"}(n||(n={})),function(e){e[e.TEX0123MTXIDX=0]="TEX0123MTXIDX",e[e.TEX4567MTXIDX=1]="TEX4567MTXIDX",e[e.POS=2]="POS",e[e.NRM=3]="NRM",e[e.BINRM=4]="BINRM",e[e.TANGENT=5]="TANGENT",e[e.CLR0=6]="CLR0",e[e.CLR1=7]="CLR1",e[e.TEX01=8]="TEX01",e[e.TEX23=9]="TEX23",e[e.TEX45=10]="TEX45",e[e.TEX67=11]="TEX67",e[e.COUNT=12]="COUNT"}(i||(i={}));class E{constructor(e,t,s){this.loadedVertexLayout=s,this.sourceLayouts=[],this.vtxLoaders=[],this.singleVatLoader=null;const n=function(e){let t=-1;for(let s=0;s<e.length;s++)if(void 0!==e[s]){if(t>=0)return null;t=s}return(0,r.vA)(t>=0),t}(e);if(null!==n){const i=_(e[n],t);this.sourceLayouts[n]=i,this.singleVatLoader=function(e,t){return w(`\nfunction run(dstVertexDataView, dstVertexDataOffs, loadedVertexLayout, dlView, drawCalls, vtxArrayViews, vtxArrayStrides) {\n    for (let i = 0; i < drawCalls.length; i++) {\n        const drawCall = drawCalls[i];\n\n        let drawCallIdx = drawCall.srcOffs;\n        for (let j = 0; j < drawCall.vertexCount; j++) {\n            ${S(e,t)}\n            dstVertexDataOffs += loadedVertexLayout.vertexBufferStrides[0];\n        }\n    }\n}\n`,"run")}(s,i)}else for(let n=0;n<e.length;n++){if(void 0===e[n])continue;const i=_(e[n],t);this.sourceLayouts[n]=i,this.vtxLoaders[n]=A(s,i)}this.vat=(0,c.rG)(e,k),this.vcd=(0,c.rG)(t,P)}parseDisplayList(e,t){function s(e){return{indexOffset:e,indexCount:0,posMatrixTable:Array(10).fill(65535),texMatrixTable:Array(10).fill(65535)}}const n=e.createDataView(),i=[],o=[];let l=0,h=0,c=0,u=null,d=null;for(;!(c>=e.byteLength);){const t=n.getUint8(c);if(0===t)break;switch(t){case a.uB.LOAD_INDX_A:{u=null,null===d&&(d=s(h));const e=12,t=0,i=d.posMatrixTable,r=n.getUint16(c+1),a=n.getUint16(c+3),o=((4095&a)-t)/e|0;if((a>>>12)+1!==e)throw Error();i[o]=r,c+=5;continue}case a.uB.LOAD_INDX_C:{u=null,null===d&&(d=s(h));const e=12,t=120,i=d.texMatrixTable,r=n.getUint16(c+1),a=n.getUint16(c+3),o=((4095&a)-t)/e|0;if((a>>>12)+1!==e)throw Error();i[o]=r,c+=5;continue}case a.uB.LOAD_INDX_B:case a.uB.LOAD_INDX_D:c+=5;continue}const m=248&t,p=7&t,f=n.getUint16(c+1);c+=3;const g=c;l+=f,null===u&&(null!==d?(u=d,d=null):u=s(h),o.push(u));let T=0;switch(m){case a.uB.DRAW_TRIANGLES:T=f;break;case a.uB.DRAW_TRIANGLE_FAN:case a.uB.DRAW_TRIANGLE_STRIP:T=3*(f-2);break;case a.uB.DRAW_QUADS:case a.uB.DRAW_QUADS_2:T=6*f/4*3;break;default:throw new Error(`Invalid data at ${(0,r.yq)(e.byteOffset,8)} / ${(0,r.yq)(c-3,4)} cmd ${(0,r.yq)(t,2)}`)}i.push({primType:m,vertexFormat:p,srcOffs:g,vertexCount:f}),u.indexCount+=T,h+=T,c+=this.sourceLayouts[p].srcVertexSize*f}const m=void 0!==t&&void 0!==t.firstVertexId?t.firstVertexId:0;let p=0;const f=new Uint16Array(h);let g=m;for(let e=0;e<i.length;e++){const t=i[e];switch(t.primType){case a.uB.DRAW_TRIANGLES:for(let e=0;e<t.vertexCount;e++)f[p++]=g++;break;case a.uB.DRAW_TRIANGLE_STRIP:for(let e=0;e<3;e++)f[p++]=g++;for(let e=3;e<t.vertexCount;e++)f[p++]=g-(1&e?1:2),f[p++]=g-(1&e?2:1),f[p++]=g++;break;case a.uB.DRAW_TRIANGLE_FAN:const e=g;for(let e=0;e<3;e++)f[p++]=g++;for(let s=3;s<t.vertexCount;s++)f[p++]=e,f[p++]=g-1,f[p++]=g++;break;case a.uB.DRAW_QUADS:case a.uB.DRAW_QUADS_2:for(let e=0;e<t.vertexCount;e+=4)f[p++]=g+0,f[p++]=g+1,f[p++]=g+2,f[p++]=g+0,f[p++]=g+2,f[p++]=g+3,g+=4}}const T=this.loadedVertexLayout.vertexBufferStrides[0]*l,x=[new ArrayBuffer(T)];return{indexData:f.buffer,totalIndexCount:h,totalVertexCount:l,draws:o,vertexId:g,vertexBuffers:x,dlView:n,drawCalls:i}}loadVertexDataInto(e,t,s,n){const i=[],o=[];for(let e=0;e<=a.cg.MAX;e++)void 0!==n[e]&&(i[e]=n[e].buffer.createDataView(n[e].offs),o[e]=n[e].stride);const l=(0,r.Z1)(s.dlView),h=(0,r.Z1)(s.drawCalls),c=this.loadedVertexLayout.vertexBufferStrides[0]*s.totalVertexCount;(0,r.vA)(e.byteLength>=c);let u=t;if(null!==this.singleVatLoader)this.singleVatLoader(e,u,this.loadedVertexLayout,l,h,i,o);else for(let t=0;t<h.length;t++){const s=h[t];let n=s.srcOffs;for(let t=0;t<s.vertexCount;t++)n=this.vtxLoaders[s.vertexFormat](e,u,l,n,i,o),u+=this.loadedVertexLayout.vertexBufferStrides[0]}}loadVertexData(e,t){const s=(0,r.Z1)(e.vertexBuffers[0]),n=new DataView(s);return this.loadVertexDataInto(n,0,e,t)}runVertices(e,t,s){const n=this.parseDisplayList(t,s);return this.loadVertexData(n,e),n}}function R(e){return void 0===e?void 0:{compCnt:e.compCnt,compShift:e.compShift,compType:e.compType}}function I(e,t){return void 0===e||void 0===t?e===t:e.compCnt===t.compCnt&&e.compShift===t.compShift&&e.compType===t.compType}function k(e){return void 0===e?void 0:(0,c.rG)(e,R)}function M(e,t){return void 0===e||void 0===t?e===t:(0,c.af)(e,t,I)}function P(e){return void 0===e?void 0:{outputMode:e.outputMode,type:e.type}}function D(e,t){return void 0===e||void 0===t?e===t:e.outputMode===t.outputMode&&e.type===t.type}const B=new h.Bs(function(e,t){return!!(0,c.af)(e.vat,t.vat,M)&&!!(0,c.af)(e.vcd,t.vcd,D)},h.Kt);function L(e,t){return function(e){let t=B.get(e);if(null===t){const{vat:s,vcd:n}=e,i=function(e){for(let t=0;t<e.length;t++){const s=e[t];if(void 0===s)continue;const n=s[a.cg.NRM];if(void 0===n)continue;const i=n.compCnt;if(i===a.xA.NRM_NBT||i===a.xA.NRM_NBT3)return!0}return!1}(s),r=y(n,i),o=new E(s,n,r);B.add(o,o),t=o}return t}({vat:e,vcd:t})}function O(e,t){const s=e,n=[],i=s.vcd,a=(0,r.y5)(8,()=>!1);for(let e=0;e<t.drawCalls.length;e++)a[t.drawCalls[e].vertexFormat]=!0;for(let e=0;e<a.length;e++)a[e]&&(n[e]=s.vat[e]);return L(n,i)}},2003(e,t,s){"use strict";var n,i,r,a,o,l,h,c,u,d,m,p,f,g,T,x,v,C,b,_,y,S,w,A,E,R,I,k,M,P,D,B,L,O,F,U,N,X,V,G,K,$,W,H,Y,Z,z,j,q,Q,J,ee;s.d(t,{Ac:()=>m,CA:()=>b,CC:()=>C,Ck:()=>r,D_:()=>K,Du:()=>ee,Ei:()=>$,Fc:()=>i,Kx:()=>E,Nx:()=>p,O2:()=>d,OR:()=>q,QE:()=>X,R7:()=>S,Sn:()=>g,TX:()=>Q,UQ:()=>B,UZ:()=>P,Ug:()=>L,WP:()=>F,aL:()=>c,b1:()=>k,bg:()=>j,bt:()=>x,cg:()=>l,dn:()=>f,eV:()=>M,fQ:()=>T,fw:()=>W,gw:()=>D,jN:()=>z,jl:()=>_,mX:()=>v,oH:()=>u,ru:()=>N,s3:()=>R,uB:()=>o,u_:()=>y,uj:()=>A,xA:()=>h,yU:()=>G,yf:()=>w,zH:()=>U,zL:()=>n,zi:()=>V}),function(e){e[e.I4=0]="I4",e[e.I8=1]="I8",e[e.IA4=2]="IA4",e[e.IA8=3]="IA8",e[e.RGB565=4]="RGB565",e[e.RGB5A3=5]="RGB5A3",e[e.RGBA8=6]="RGBA8",e[e.C4=8]="C4",e[e.C8=9]="C8",e[e.C14X2=10]="C14X2",e[e.CMPR=14]="CMPR"}(n||(n={})),function(e){e[e.IA8=0]="IA8",e[e.RGB565=1]="RGB565",e[e.RGB5A3=2]="RGB5A3"}(i||(i={})),function(e){e[e.NEAR=0]="NEAR",e[e.LINEAR=1]="LINEAR",e[e.NEAR_MIP_NEAR=2]="NEAR_MIP_NEAR",e[e.LIN_MIP_NEAR=3]="LIN_MIP_NEAR",e[e.NEAR_MIP_LIN=4]="NEAR_MIP_LIN",e[e.LIN_MIP_LIN=5]="LIN_MIP_LIN"}(r||(r={})),function(e){e[e._1=0]="_1",e[e._2=1]="_2",e[e._4=2]="_4"}(a||(a={})),function(e){e[e.NOOP=0]="NOOP",e[e.DRAW_QUADS=128]="DRAW_QUADS",e[e.DRAW_QUADS_2=136]="DRAW_QUADS_2",e[e.DRAW_TRIANGLES=144]="DRAW_TRIANGLES",e[e.DRAW_TRIANGLE_STRIP=152]="DRAW_TRIANGLE_STRIP",e[e.DRAW_TRIANGLE_FAN=160]="DRAW_TRIANGLE_FAN",e[e.DRAW_LINES=168]="DRAW_LINES",e[e.DRAW_LINE_STRIP=176]="DRAW_LINE_STRIP",e[e.DRAW_POINTS=184]="DRAW_POINTS",e[e.LOAD_INDX_A=32]="LOAD_INDX_A",e[e.LOAD_INDX_B=40]="LOAD_INDX_B",e[e.LOAD_INDX_C=48]="LOAD_INDX_C",e[e.LOAD_INDX_D=56]="LOAD_INDX_D",e[e.LOAD_BP_REG=97]="LOAD_BP_REG",e[e.LOAD_CP_REG=8]="LOAD_CP_REG",e[e.LOAD_XF_REG=16]="LOAD_XF_REG"}(o||(o={})),function(e){e[e.PNMTXIDX=0]="PNMTXIDX",e[e.TEX0MTXIDX=1]="TEX0MTXIDX",e[e.TEX1MTXIDX=2]="TEX1MTXIDX",e[e.TEX2MTXIDX=3]="TEX2MTXIDX",e[e.TEX3MTXIDX=4]="TEX3MTXIDX",e[e.TEX4MTXIDX=5]="TEX4MTXIDX",e[e.TEX5MTXIDX=6]="TEX5MTXIDX",e[e.TEX6MTXIDX=7]="TEX6MTXIDX",e[e.TEX7MTXIDX=8]="TEX7MTXIDX",e[e.POS=9]="POS",e[e.NRM=10]="NRM",e[e.CLR0=11]="CLR0",e[e.CLR1=12]="CLR1",e[e.TEX0=13]="TEX0",e[e.TEX1=14]="TEX1",e[e.TEX2=15]="TEX2",e[e.TEX3=16]="TEX3",e[e.TEX4=17]="TEX4",e[e.TEX5=18]="TEX5",e[e.TEX6=19]="TEX6",e[e.TEX7=20]="TEX7",e[e.MAX=20]="MAX",e[e._NBT=25]="_NBT",e[e.NULL=255]="NULL"}(l||(l={})),function(e){e[e.POS_XY=0]="POS_XY",e[e.POS_XYZ=1]="POS_XYZ",e[e.NRM_XYZ=0]="NRM_XYZ",e[e.NRM_NBT=1]="NRM_NBT",e[e.NRM_NBT3=2]="NRM_NBT3",e[e.CLR_RGB=0]="CLR_RGB",e[e.CLR_RGBA=1]="CLR_RGBA",e[e.TEX_S=0]="TEX_S",e[e.TEX_ST=1]="TEX_ST"}(h||(h={})),function(e){e[e.U8=0]="U8",e[e.S8=1]="S8",e[e.U16=2]="U16",e[e.S16=3]="S16",e[e.F32=4]="F32",e[e.RGB565=0]="RGB565",e[e.RGB8=1]="RGB8",e[e.RGBX8=2]="RGBX8",e[e.RGBA4=3]="RGBA4",e[e.RGBA6=4]="RGBA6",e[e.RGBA8=5]="RGBA8"}(c||(c={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LEQUAL=3]="LEQUAL",e[e.GREATER=4]="GREATER",e[e.NEQUAL=5]="NEQUAL",e[e.GEQUAL=6]="GEQUAL",e[e.ALWAYS=7]="ALWAYS"}(u||(u={})),function(e){e[e.AND=0]="AND",e[e.OR=1]="OR",e[e.XOR=2]="XOR",e[e.XNOR=3]="XNOR"}(d||(d={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(m||(m={})),function(e){e[e.NONE=0]="NONE",e[e.BLEND=1]="BLEND",e[e.LOGIC=2]="LOGIC",e[e.SUBTRACT=3]="SUBTRACT"}(p||(p={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRCCLR=2]="SRCCLR",e[e.INVSRCCLR=3]="INVSRCCLR",e[e.SRCALPHA=4]="SRCALPHA",e[e.INVSRCALPHA=5]="INVSRCALPHA",e[e.DSTALPHA=6]="DSTALPHA",e[e.INVDSTALPHA=7]="INVDSTALPHA"}(f||(f={})),function(e){e[e.CLEAR=0]="CLEAR",e[e.AND=1]="AND",e[e.REVAND=2]="REVAND",e[e.COPY=3]="COPY",e[e.INVAND=4]="INVAND",e[e.NOOP=5]="NOOP",e[e.XOR=6]="XOR",e[e.OR=7]="OR",e[e.NOR=8]="NOR",e[e.EQUIV=9]="EQUIV",e[e.INV=10]="INV",e[e.REVOR=11]="REVOR",e[e.INVCOPY=12]="INVCOPY",e[e.INVOR=13]="INVOR",e[e.NAND=14]="NAND",e[e.SET=15]="SET"}(g||(g={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.COMP_R8_GT=8]="COMP_R8_GT",e[e.COMP_R8_EQ=9]="COMP_R8_EQ",e[e.COMP_GR16_GT=10]="COMP_GR16_GT",e[e.COMP_GR16_EQ=11]="COMP_GR16_EQ",e[e.COMP_BGR24_GT=12]="COMP_BGR24_GT",e[e.COMP_BGR24_EQ=13]="COMP_BGR24_EQ",e[e.COMP_RGB8_GT=14]="COMP_RGB8_GT",e[e.COMP_RGB8_EQ=15]="COMP_RGB8_EQ",e[e.COMP_A8_GT=14]="COMP_A8_GT",e[e.COMP_A8_EQ=15]="COMP_A8_EQ"}(T||(T={})),function(e){e[e.ZERO=0]="ZERO",e[e.ADDHALF=1]="ADDHALF",e[e.SUBHALF=2]="SUBHALF",e[e.$HWB_COMPARE=3]="$HWB_COMPARE"}(x||(x={})),function(e){e[e.SCALE_1=0]="SCALE_1",e[e.SCALE_2=1]="SCALE_2",e[e.SCALE_4=2]="SCALE_4",e[e.DIVIDE_2=3]="DIVIDE_2",e[e.$HWB_R8=0]="$HWB_R8",e[e.$HWB_GR16=1]="$HWB_GR16",e[e.$HWB_BGR24=2]="$HWB_BGR24",e[e.$HWB_RGB8=3]="$HWB_RGB8"}(v||(v={})),function(e){e[e.CPREV=0]="CPREV",e[e.APREV=1]="APREV",e[e.C0=2]="C0",e[e.A0=3]="A0",e[e.C1=4]="C1",e[e.A1=5]="A1",e[e.C2=6]="C2",e[e.A2=7]="A2",e[e.TEXC=8]="TEXC",e[e.TEXA=9]="TEXA",e[e.RASC=10]="RASC",e[e.RASA=11]="RASA",e[e.ONE=12]="ONE",e[e.HALF=13]="HALF",e[e.KONST=14]="KONST",e[e.ZERO=15]="ZERO"}(C||(C={})),function(e){e[e.APREV=0]="APREV",e[e.A0=1]="A0",e[e.A1=2]="A1",e[e.A2=3]="A2",e[e.TEXA=4]="TEXA",e[e.RASA=5]="RASA",e[e.KONST=6]="KONST",e[e.ZERO=7]="ZERO"}(b||(b={})),function(e){e[e.KCSEL_1=0]="KCSEL_1",e[e.KCSEL_7_8=1]="KCSEL_7_8",e[e.KCSEL_6_8=2]="KCSEL_6_8",e[e.KCSEL_5_8=3]="KCSEL_5_8",e[e.KCSEL_4_8=4]="KCSEL_4_8",e[e.KCSEL_3_8=5]="KCSEL_3_8",e[e.KCSEL_2_8=6]="KCSEL_2_8",e[e.KCSEL_1_8=7]="KCSEL_1_8",e[e.KCSEL_K0=12]="KCSEL_K0",e[e.KCSEL_K1=13]="KCSEL_K1",e[e.KCSEL_K2=14]="KCSEL_K2",e[e.KCSEL_K3=15]="KCSEL_K3",e[e.KCSEL_K0_R=16]="KCSEL_K0_R",e[e.KCSEL_K1_R=17]="KCSEL_K1_R",e[e.KCSEL_K2_R=18]="KCSEL_K2_R",e[e.KCSEL_K3_R=19]="KCSEL_K3_R",e[e.KCSEL_K0_G=20]="KCSEL_K0_G",e[e.KCSEL_K1_G=21]="KCSEL_K1_G",e[e.KCSEL_K2_G=22]="KCSEL_K2_G",e[e.KCSEL_K3_G=23]="KCSEL_K3_G",e[e.KCSEL_K0_B=24]="KCSEL_K0_B",e[e.KCSEL_K1_B=25]="KCSEL_K1_B",e[e.KCSEL_K2_B=26]="KCSEL_K2_B",e[e.KCSEL_K3_B=27]="KCSEL_K3_B",e[e.KCSEL_K0_A=28]="KCSEL_K0_A",e[e.KCSEL_K1_A=29]="KCSEL_K1_A",e[e.KCSEL_K2_A=30]="KCSEL_K2_A",e[e.KCSEL_K3_A=31]="KCSEL_K3_A"}(_||(_={})),function(e){e[e.KASEL_1=0]="KASEL_1",e[e.KASEL_7_8=1]="KASEL_7_8",e[e.KASEL_6_8=2]="KASEL_6_8",e[e.KASEL_5_8=3]="KASEL_5_8",e[e.KASEL_4_8=4]="KASEL_4_8",e[e.KASEL_3_8=5]="KASEL_3_8",e[e.KASEL_2_8=6]="KASEL_2_8",e[e.KASEL_1_8=7]="KASEL_1_8",e[e.KASEL_K0_R=16]="KASEL_K0_R",e[e.KASEL_K1_R=17]="KASEL_K1_R",e[e.KASEL_K2_R=18]="KASEL_K2_R",e[e.KASEL_K3_R=19]="KASEL_K3_R",e[e.KASEL_K0_G=20]="KASEL_K0_G",e[e.KASEL_K1_G=21]="KASEL_K1_G",e[e.KASEL_K2_G=22]="KASEL_K2_G",e[e.KASEL_K3_G=23]="KASEL_K3_G",e[e.KASEL_K0_B=24]="KASEL_K0_B",e[e.KASEL_K1_B=25]="KASEL_K1_B",e[e.KASEL_K2_B=26]="KASEL_K2_B",e[e.KASEL_K3_B=27]="KASEL_K3_B",e[e.KASEL_K0_A=28]="KASEL_K0_A",e[e.KASEL_K1_A=29]="KASEL_K1_A",e[e.KASEL_K2_A=30]="KASEL_K2_A",e[e.KASEL_K3_A=31]="KASEL_K3_A"}(y||(y={})),function(e){e[e.R=0]="R",e[e.G=1]="G",e[e.B=2]="B",e[e.A=3]="A"}(S||(S={})),function(e){e[e.CLAMP=0]="CLAMP",e[e.REPEAT=1]="REPEAT",e[e.MIRROR=2]="MIRROR"}(w||(w={})),function(e){e[e.REG=0]="REG",e[e.VTX=1]="VTX"}(A||(A={})),function(e){e[e.POS=0]="POS",e[e.NRM=1]="NRM",e[e.BINRM=2]="BINRM",e[e.TANGENT=3]="TANGENT",e[e.TEX0=4]="TEX0",e[e.TEX1=5]="TEX1",e[e.TEX2=6]="TEX2",e[e.TEX3=7]="TEX3",e[e.TEX4=8]="TEX4",e[e.TEX5=9]="TEX5",e[e.TEX6=10]="TEX6",e[e.TEX7=11]="TEX7",e[e.TEXCOORD0=12]="TEXCOORD0",e[e.TEXCOORD1=13]="TEXCOORD1",e[e.TEXCOORD2=14]="TEXCOORD2",e[e.TEXCOORD3=15]="TEXCOORD3",e[e.TEXCOORD4=16]="TEXCOORD4",e[e.TEXCOORD5=17]="TEXCOORD5",e[e.TEXCOORD6=18]="TEXCOORD6",e[e.COLOR0=19]="COLOR0",e[e.COLOR1=20]="COLOR1"}(E||(E={})),function(e){e[e.MTX3x4=0]="MTX3x4",e[e.MTX2x4=1]="MTX2x4",e[e.BUMP0=2]="BUMP0",e[e.BUMP1=3]="BUMP1",e[e.BUMP2=4]="BUMP2",e[e.BUMP3=5]="BUMP3",e[e.BUMP4=6]="BUMP4",e[e.BUMP5=7]="BUMP5",e[e.BUMP6=8]="BUMP6",e[e.BUMP7=9]="BUMP7",e[e.SRTG=10]="SRTG"}(R||(R={})),function(e){e[e.PNMTX0=0]="PNMTX0",e[e.PNMTX1=3]="PNMTX1",e[e.PNMTX2=6]="PNMTX2",e[e.PNMTX3=9]="PNMTX3",e[e.PNMTX4=12]="PNMTX4",e[e.PNMTX5=15]="PNMTX5",e[e.PNMTX6=18]="PNMTX6",e[e.PNMTX7=21]="PNMTX7",e[e.PNMTX8=24]="PNMTX8",e[e.PNMTX9=27]="PNMTX9"}(I||(I={})),function(e){e[e.IDENTITY=60]="IDENTITY",e[e.TEXMTX0=30]="TEXMTX0",e[e.TEXMTX1=33]="TEXMTX1",e[e.TEXMTX2=36]="TEXMTX2",e[e.TEXMTX3=39]="TEXMTX3",e[e.TEXMTX4=42]="TEXMTX4",e[e.TEXMTX5=45]="TEXMTX5",e[e.TEXMTX6=48]="TEXMTX6",e[e.TEXMTX7=51]="TEXMTX7",e[e.TEXMTX8=54]="TEXMTX8",e[e.TEXMTX9=57]="TEXMTX9",e[e.PNMTX0=0]="PNMTX0",e[e.PNMTX1=3]="PNMTX1",e[e.PNMTX2=6]="PNMTX2",e[e.PNMTX3=9]="PNMTX3",e[e.PNMTX4=12]="PNMTX4",e[e.PNMTX5=15]="PNMTX5",e[e.PNMTX6=18]="PNMTX6",e[e.PNMTX7=21]="PNMTX7",e[e.PNMTX8=24]="PNMTX8",e[e.PNMTX9=27]="PNMTX9"}(k||(k={})),function(e){e[e.PTTEXMTX0=64]="PTTEXMTX0",e[e.PTTEXMTX1=67]="PTTEXMTX1",e[e.PTTEXMTX2=70]="PTTEXMTX2",e[e.PTTEXMTX3=73]="PTTEXMTX3",e[e.PTTEXMTX4=76]="PTTEXMTX4",e[e.PTTEXMTX5=79]="PTTEXMTX5",e[e.PTTEXMTX6=82]="PTTEXMTX6",e[e.PTTEXMTX7=85]="PTTEXMTX7",e[e.PTTEXMTX8=88]="PTTEXMTX8",e[e.PTTEXMTX9=91]="PTTEXMTX9",e[e.PTTEXMTX10=94]="PTTEXMTX10",e[e.PTTEXMTX11=97]="PTTEXMTX11",e[e.PTTEXMTX12=100]="PTTEXMTX12",e[e.PTTEXMTX13=103]="PTTEXMTX13",e[e.PTTEXMTX14=106]="PTTEXMTX14",e[e.PTTEXMTX15=109]="PTTEXMTX15",e[e.PTTEXMTX16=112]="PTTEXMTX16",e[e.PTTEXMTX17=115]="PTTEXMTX17",e[e.PTTEXMTX18=118]="PTTEXMTX18",e[e.PTTEXMTX19=121]="PTTEXMTX19",e[e.PTIDENTITY=125]="PTIDENTITY"}(M||(M={})),function(e){e[e.PREV=0]="PREV",e[e.REG0=1]="REG0",e[e.REG1=2]="REG1",e[e.REG2=3]="REG2"}(P||(P={})),function(e){e[e.TEXCOORD0=0]="TEXCOORD0",e[e.TEXCOORD1=1]="TEXCOORD1",e[e.TEXCOORD2=2]="TEXCOORD2",e[e.TEXCOORD3=3]="TEXCOORD3",e[e.TEXCOORD4=4]="TEXCOORD4",e[e.TEXCOORD5=5]="TEXCOORD5",e[e.TEXCOORD6=6]="TEXCOORD6",e[e.TEXCOORD7=7]="TEXCOORD7",e[e.TEXCOORD_NULL=255]="TEXCOORD_NULL"}(D||(D={})),function(e){e[e.COLOR0=0]="COLOR0",e[e.COLOR1=1]="COLOR1",e[e.ALPHA0=2]="ALPHA0",e[e.ALPHA1=3]="ALPHA1",e[e.COLOR0A0=4]="COLOR0A0",e[e.COLOR1A1=5]="COLOR1A1",e[e.COLOR_ZERO=6]="COLOR_ZERO",e[e.ALPHA_BUMP=7]="ALPHA_BUMP",e[e.ALPHA_BUMP_N=8]="ALPHA_BUMP_N",e[e.COLOR_NULL=255]="COLOR_NULL"}(B||(B={})),function(e){e[e.COLOR0A0=0]="COLOR0A0",e[e.COLOR1A1=1]="COLOR1A1",e[e.ALPHA_BUMP=5]="ALPHA_BUMP",e[e.ALPHA_BUMP_N=6]="ALPHA_BUMP_N",e[e.COLOR_ZERO=7]="COLOR_ZERO"}(L||(L={})),function(e){e[e.VTXFMT0=0]="VTXFMT0",e[e.VTXFMT1=1]="VTXFMT1",e[e.VTXFMT2=2]="VTXFMT2",e[e.VTXFMT3=3]="VTXFMT3",e[e.VTXFMT4=4]="VTXFMT4",e[e.VTXFMT5=5]="VTXFMT5",e[e.VTXFMT6=6]="VTXFMT6",e[e.VTXFMT7=7]="VTXFMT7"}(O||(O={})),function(e){e[e.NONE=0]="NONE",e[e.DIRECT=1]="DIRECT",e[e.INDEX8=2]="INDEX8",e[e.INDEX16=3]="INDEX16"}(F||(F={})),function(e){e[e.TEXMAP0=0]="TEXMAP0",e[e.TEXMAP1=1]="TEXMAP1",e[e.TEXMAP2=2]="TEXMAP2",e[e.TEXMAP3=3]="TEXMAP3",e[e.TEXMAP4=4]="TEXMAP4",e[e.TEXMAP5=5]="TEXMAP5",e[e.TEXMAP6=6]="TEXMAP6",e[e.TEXMAP7=7]="TEXMAP7",e[e.TEXMAP_NULL=255]="TEXMAP_NULL"}(U||(U={})),function(e){e[e._1=0]="_1",e[e._2=1]="_2",e[e._4=2]="_4",e[e._8=3]="_8",e[e._16=4]="_16",e[e._32=5]="_32",e[e._64=6]="_64",e[e._128=7]="_128",e[e._256=8]="_256"}(N||(N={})),function(e){e[e.NONE=0]="NONE",e[e.S=1]="S",e[e.T=2]="T",e[e.ST=3]="ST",e[e.U=4]="U",e[e.SU=5]="SU",e[e.TU=6]="TU",e[e.STU=7]="STU"}(X||(X={})),function(e){e[e.OFF=0]="OFF",e[e.S=1]="S",e[e.T=2]="T",e[e.U=3]="U"}(V||(V={})),function(e){e[e._8=0]="_8",e[e._5=1]="_5",e[e._4=2]="_4",e[e._3=3]="_3"}(G||(G={})),function(e){e[e.OFF=0]="OFF",e[e._256=1]="_256",e[e._128=2]="_128",e[e._64=3]="_64",e[e._32=4]="_32",e[e._16=5]="_16",e[e._0=6]="_0"}(K||(K={})),function(e){e[e.STAGE0=0]="STAGE0",e[e.STAGE1=1]="STAGE1",e[e.STAGE2=2]="STAGE2",e[e.STAGE3=3]="STAGE3"}($||($={})),function(e){e[e.OFF=0]="OFF",e[e._0=1]="_0",e[e._1=2]="_1",e[e._2=3]="_2",e[e.S0=5]="S0",e[e.S1=6]="S1",e[e.S2=7]="S2",e[e.T0=9]="T0",e[e.T1=10]="T1",e[e.T2=11]="T2"}(W||(W={})),function(e){e[e.XF_INVTXSPEC_ID=4104]="XF_INVTXSPEC_ID",e[e.XF_NUMCOLORS_ID=4105]="XF_NUMCOLORS_ID",e[e.XF_AMBIENT0_ID=4106]="XF_AMBIENT0_ID",e[e.XF_AMBIENT1_ID=4107]="XF_AMBIENT1_ID",e[e.XF_MATERIAL0_ID=4108]="XF_MATERIAL0_ID",e[e.XF_MATERIAL1_ID=4109]="XF_MATERIAL1_ID",e[e.XF_COLOR0CNTRL_ID=4110]="XF_COLOR0CNTRL_ID",e[e.XF_COLOR1CNTRL_ID=4111]="XF_COLOR1CNTRL_ID",e[e.XF_ALPHA0CNTRL_ID=4112]="XF_ALPHA0CNTRL_ID",e[e.XF_ALPHA1CNTRL_ID=4113]="XF_ALPHA1CNTRL_ID",e[e.XF_DUALTEXTRANS_ID=4114]="XF_DUALTEXTRANS_ID",e[e.XF_MATRIXINDEX0_ID=4120]="XF_MATRIXINDEX0_ID",e[e.XF_MATRIXINDEX1_ID=4121]="XF_MATRIXINDEX1_ID",e[e.XF_VPSCALEX_ID=4122]="XF_VPSCALEX_ID",e[e.XF_VPSCALEY_ID=4123]="XF_VPSCALEY_ID",e[e.XF_VPSCALEZ_ID=4124]="XF_VPSCALEZ_ID",e[e.XF_VPOFFSETX_ID=4125]="XF_VPOFFSETX_ID",e[e.XF_VPOFFSETY_ID=4126]="XF_VPOFFSETY_ID",e[e.XF_VPOFFSETZ_ID=4127]="XF_VPOFFSETZ_ID",e[e.XF_PROJECTIONA_ID=4128]="XF_PROJECTIONA_ID",e[e.XF_PROJECTIONB_ID=4129]="XF_PROJECTIONB_ID",e[e.XF_PROJECTIONC_ID=4130]="XF_PROJECTIONC_ID",e[e.XF_PROJECTIOND_ID=4131]="XF_PROJECTIOND_ID",e[e.XF_PROJECTIONE_ID=4132]="XF_PROJECTIONE_ID",e[e.XF_PROJECTIONF_ID=4133]="XF_PROJECTIONF_ID",e[e.XF_PROJECTORTHO_ID=4134]="XF_PROJECTORTHO_ID",e[e.XF_NUMTEX_ID=4159]="XF_NUMTEX_ID",e[e.XF_TEX0_ID=4160]="XF_TEX0_ID",e[e.XF_DUALTEX0_ID=4176]="XF_DUALTEX0_ID"}(H||(H={})),function(e){e[e.GEN_MODE_ID=0]="GEN_MODE_ID",e[e.IND_MTXA0_ID=6]="IND_MTXA0_ID",e[e.IND_MTXB0_ID=7]="IND_MTXB0_ID",e[e.IND_MTXC0_ID=8]="IND_MTXC0_ID",e[e.IND_CMD0_ID=16]="IND_CMD0_ID",e[e.RAS1_SS0_ID=37]="RAS1_SS0_ID",e[e.RAS1_IREF_ID=39]="RAS1_IREF_ID",e[e.RAS1_TREF_0_ID=40]="RAS1_TREF_0_ID",e[e.SU_SSIZE_I0_ID=48]="SU_SSIZE_I0_ID",e[e.SU_SSIZE_I1_ID=50]="SU_SSIZE_I1_ID",e[e.SU_SSIZE_I2_ID=52]="SU_SSIZE_I2_ID",e[e.SU_SSIZE_I3_ID=54]="SU_SSIZE_I3_ID",e[e.SU_SSIZE_I4_ID=56]="SU_SSIZE_I4_ID",e[e.SU_SSIZE_I5_ID=58]="SU_SSIZE_I5_ID",e[e.SU_SSIZE_I6_ID=60]="SU_SSIZE_I6_ID",e[e.SU_SSIZE_I7_ID=62]="SU_SSIZE_I7_ID",e[e.SU_TSIZE_I0_ID=49]="SU_TSIZE_I0_ID",e[e.SU_TSIZE_I1_ID=51]="SU_TSIZE_I1_ID",e[e.SU_TSIZE_I2_ID=53]="SU_TSIZE_I2_ID",e[e.SU_TSIZE_I3_ID=55]="SU_TSIZE_I3_ID",e[e.SU_TSIZE_I4_ID=57]="SU_TSIZE_I4_ID",e[e.SU_TSIZE_I5_ID=59]="SU_TSIZE_I5_ID",e[e.SU_TSIZE_I6_ID=61]="SU_TSIZE_I6_ID",e[e.SU_TSIZE_I7_ID=63]="SU_TSIZE_I7_ID",e[e.PE_ZMODE_ID=64]="PE_ZMODE_ID",e[e.PE_CMODE0_ID=65]="PE_CMODE0_ID",e[e.TX_LOADTLUT_I0_ID=100]="TX_LOADTLUT_I0_ID",e[e.TX_SETMODE0_I0_ID=128]="TX_SETMODE0_I0_ID",e[e.TX_SETMODE0_I4_ID=160]="TX_SETMODE0_I4_ID",e[e.TX_SETMODE1_I0_ID=132]="TX_SETMODE1_I0_ID",e[e.TX_SETMODE1_I4_ID=164]="TX_SETMODE1_I4_ID",e[e.TX_SETIMAGE0_I0_ID=136]="TX_SETIMAGE0_I0_ID",e[e.TX_SETIMAGE0_I4_ID=168]="TX_SETIMAGE0_I4_ID",e[e.TX_SETIMAGE1_I0_ID=140]="TX_SETIMAGE1_I0_ID",e[e.TX_SETIMAGE1_I4_ID=172]="TX_SETIMAGE1_I4_ID",e[e.TX_SETIMAGE2_I0_ID=144]="TX_SETIMAGE2_I0_ID",e[e.TX_SETIMAGE2_I4_ID=176]="TX_SETIMAGE2_I4_ID",e[e.TX_SETIMAGE3_I0_ID=148]="TX_SETIMAGE3_I0_ID",e[e.TX_SETIMAGE3_I4_ID=180]="TX_SETIMAGE3_I4_ID",e[e.TX_SETTLUT_I0_ID=152]="TX_SETTLUT_I0_ID",e[e.TX_SETTLUT_I4_ID=184]="TX_SETTLUT_I4_ID",e[e.TEV_COLOR_ENV_0_ID=192]="TEV_COLOR_ENV_0_ID",e[e.TEV_ALPHA_ENV_0_ID=193]="TEV_ALPHA_ENV_0_ID",e[e.TEV_REGISTERL_0_ID=224]="TEV_REGISTERL_0_ID",e[e.TEV_REGISTERH_0_ID=225]="TEV_REGISTERH_0_ID",e[e.TEV_FOG_PARAM_0_ID=238]="TEV_FOG_PARAM_0_ID",e[e.TEV_FOG_PARAM_1_ID=239]="TEV_FOG_PARAM_1_ID",e[e.TEV_FOG_PARAM_2_ID=240]="TEV_FOG_PARAM_2_ID",e[e.TEV_FOG_PARAM_3_ID=241]="TEV_FOG_PARAM_3_ID",e[e.TEV_FOG_COLOR_ID=242]="TEV_FOG_COLOR_ID",e[e.TEV_ALPHAFUNC_ID=243]="TEV_ALPHAFUNC_ID",e[e.TEV_KSEL_0_ID=246]="TEV_KSEL_0_ID",e[e.SS_MASK=254]="SS_MASK"}(Y||(Y={})),function(e){e[e.MATINDEX_A_ID=48]="MATINDEX_A_ID",e[e.MATINDEX_B_ID=64]="MATINDEX_B_ID",e[e.VCD_LO_ID=80]="VCD_LO_ID",e[e.VCD_HI_ID=96]="VCD_HI_ID",e[e.VAT_A_ID=112]="VAT_A_ID",e[e.VAT_B_ID=128]="VAT_B_ID",e[e.VAT_C_ID=144]="VAT_C_ID"}(Z||(Z={})),function(e){e[e.NONE=0]="NONE",e[e.SIGN=1]="SIGN",e[e.CLAMP=2]="CLAMP"}(z||(z={})),function(e){e[e.SPEC=0]="SPEC",e[e.SPOT=1]="SPOT",e[e.NONE=2]="NONE"}(j||(j={})),function(e){e[e.OFF=0]="OFF",e[e.GENTLE=1]="GENTLE",e[e.MEDIUM=2]="MEDIUM",e[e.STEEP=3]="STEEP"}(q||(q={})),function(e){e[e.OFF=0]="OFF",e[e.FLAT=1]="FLAT",e[e.COS=2]="COS",e[e.COS2=3]="COS2",e[e.SHARP=4]="SHARP",e[e.RING1=5]="RING1",e[e.RING2=6]="RING2"}(Q||(Q={})),function(e){e[e.PERSPECTIVE=0]="PERSPECTIVE",e[e.ORTHOGRAPHIC=1]="ORTHOGRAPHIC"}(J||(J={})),function(e){e[e.NONE=0]="NONE",e[e.PERSP_LIN=2]="PERSP_LIN",e[e.PERSP_EXP=4]="PERSP_EXP",e[e.PERSP_EXP2=5]="PERSP_EXP2",e[e.PERSP_REVEXP=6]="PERSP_REVEXP",e[e.PERSP_REVEXP2=7]="PERSP_REVEXP2",e[e.ORTHO_LIN=10]="ORTHO_LIN",e[e.ORTHO_EXP=12]="ORTHO_EXP",e[e.ORTHO_EXP2=13]="ORTHO_EXP2",e[e.ORTHO_REVEXP=14]="ORTHO_REVEXP",e[e.ORTHO_REVEXP2=15]="ORTHO_REVEXP2"}(ee||(ee={}))},9667(e,t,s){"use strict";s.d(t,{E4:()=>p,HG:()=>w,IY:()=>b,N_:()=>_,PY:()=>C,S4:()=>A,S_:()=>T,T3:()=>I,eV:()=>k,fE:()=>y,sX:()=>v,ve:()=>g,vn:()=>R,xT:()=>m,zj:()=>E});var n=s(2003),i=s(7459),r=s(7653),a=s(329),o=s(5974),l=s(7020),h=s(5339),c=s(930),u=s(5093),d=s(373);const m=640,p=528;var f;!function(e){e.TevOverflow="\nfloat TevOverflow(float a) { return clamp(a, 0.0, 1.0); }\nvec3 TevOverflow(vec3 a) { return clamp(a, 0.0, 1.0); }\nvec4 TevOverflow(vec4 a) { return clamp(a, 0.0, 1.0); }\n",e.GXIntensity="\nfloat GXIntensity(vec3 t_Color) {\n    // https://github.com/dolphin-emu/dolphin/blob/4cd48e609c507e65b95bca5afb416b59eaf7f683/Source/Core/VideoCommon/TextureConverterShaderGen.cpp#L237-L241\n    return dot(t_Color, vec3(0.257, 0.504, 0.098)) + 16.0/255.0;\n}\n",e.generateBlurFunction=function(e,t,s,n,i=0){let r=`\nvec3 ${e}(PD_SAMPLER_2D(t_Texture), in vec2 t_TexCoord, in vec2 t_Aspect) {\n    vec3 c = vec3(0.0);\n`;for(let e=0;e<t;e++){const a=i+h.wZ.TAU*(e/t),o=Math.cos(a),l=-Math.sin(a);r+=`\n    c += (texture(PU_SAMPLER_2D(t_Texture), t_TexCoord + t_Aspect * vec2(${(0,d.c)(o)} * ${s}, ${(0,d.c)(l)} * ${s})).rgb * ${n});`}return r+="\n    return c;\n}\n",r}}(f||(f={}));class g{constructor(){this.Position=a.vt(),this.Direction=a.vt(),this.DistAtten=a.vt(),this.CosAtten=a.vt(),this.Color=(0,i.Zv)(i.gh),this.reset()}reset(){a.v_(this.Position),a.hZ(this.Direction,0,0,-1),a.hZ(this.DistAtten,1,0,0),a.hZ(this.CosAtten,1,0,0),(0,i.gM)(this.Color,0,0,0,1)}copy(e){a.C(this.Position,e.Position),a.C(this.Direction,e.Direction),a.C(this.DistAtten,e.DistAtten),a.C(this.CosAtten,e.CosAtten),(0,i.z5)(this.Color,e.Color)}}class T{constructor(){this.Color=(0,i.Zv)(i.gh),this.A=0,this.B=0,this.C=0,this.AdjTable=new Uint16Array(10),this.AdjCenter=0}reset(){(0,i.gM)(this.Color,0,0,0,0),this.A=0,this.B=0,this.C=0,this.AdjTable.fill(0),this.AdjCenter=0}copy(e){(0,i.z5)(this.Color,e.Color),this.A=e.A,this.B=e.B,this.C=e.C,this.AdjTable.set(e.AdjTable),this.AdjCenter=e.AdjCenter}}n.R7.R,n.R7.G,n.R7.B,n.R7.A,n.R7.R,n.R7.R,n.R7.R,n.R7.A,n.R7.G,n.R7.G,n.R7.G,n.R7.A,n.R7.B,n.R7.B,n.R7.B,n.R7.A;const x=[{attrInput:c.fg.POS,name:"Position",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX0123MTXIDX,name:"TexMtx0123Idx",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX4567MTXIDX,name:"TexMtx4567Idx",format:r.$Y.F32_RGBA},{attrInput:c.fg.NRM,name:"Normal",format:r.$Y.F32_RGB},{attrInput:c.fg.BINRM,name:"Binormal",format:r.$Y.F32_RGB},{attrInput:c.fg.TANGENT,name:"Tangent",format:r.$Y.F32_RGB},{attrInput:c.fg.CLR0,name:"Color0",format:r.$Y.F32_RGBA},{attrInput:c.fg.CLR1,name:"Color1",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX01,name:"Tex01",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX23,name:"Tex23",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX45,name:"Tex45",format:r.$Y.F32_RGBA},{attrInput:c.fg.TEX67,name:"Tex67",format:r.$Y.F32_RGBA}];function v(e){return x.findIndex(t=>t.attrInput===e)}function C(e){return void 0===e.hasPostTexMtxBlock||e.hasPostTexMtxBlock}function b(e){return void 0===e.hasLightsBlock||e.hasLightsBlock}function _(e){return void 0!==e.hasFogBlock&&e.hasFogBlock}function y(e){return void 0===e.usePnMtxIdx||e.usePnMtxIdx}function S(e,t){return void 0!==e.useTexMtxIdx&&e.useTexMtxIdx[t]}function w(e){return void 0!==e.hasDynamicAlphaTest&&e.hasDynamicAlphaTest}function A(e){let t=216;return C(e)&&(t+=240),b(e)&&(t+=160),_(e)&&(t+=20),w(e)&&(t+=4),t}function E(e){let t=0;return y(e)?t+=120:t+=12,t}class R extends u.P{constructor(e,t=null){super(),this.material=e,this.hacks=t,this.name=e.name,this.generateShaders()}generateFloat(e){return(0,d.c)(e)}generateMaterialSource(e,t){if(null!==this.hacks&&this.hacks.disableVertexColors&&e.matColorSource===n.uj.VTX)return"vec4(1.0, 1.0, 1.0, 1.0)";switch(e.matColorSource){case n.uj.VTX:return`a_Color${t}`;case n.uj.REG:return`u_ColorMatReg[${t}]`}}generateAmbientSource(e,t){if(null!==this.hacks&&this.hacks.disableVertexColors&&e.ambColorSource===n.uj.VTX)return"vec4(1.0, 1.0, 1.0, 1.0)";switch(e.ambColorSource){case n.uj.VTX:return`a_Color${t}`;case n.uj.REG:return`u_ColorAmbReg[${t}]`}}generateLightDiffFn(e,t){const s="dot(t_Normal, t_LightDeltaDir)";let i=e.diffuseFunction;switch(e.attenuationFunction===n.bg.NONE&&(i=n.jN.NONE),i){case n.jN.NONE:return"1.0";case n.jN.SIGN:return`${s}`;case n.jN.CLAMP:return`max(${s}, 0.0)`}}generateLightAttnFn(e,t){if(e.attenuationFunction===n.bg.NONE)return"\n    t_Attenuation = 1.0;";if(e.attenuationFunction===n.bg.SPOT)return`\n    t_Attenuation = max(0.0, max(0.0, ApplyAttenuation(${t}.CosAtten.xyz, max(0.0, dot(t_LightDeltaDir, ${t}.Direction.xyz)))) / dot(${e.diffuseFunction!==n.jN.NONE?"normalize":""}(${t}.DistAtten.xyz), vec3(1.0, t_LightDeltaDist, t_LightDeltaDist2)));`;if(e.attenuationFunction===n.bg.SPEC)return`\n    t_Attenuation = (dot(t_Normal, t_LightDeltaDir) >= 0.0) ? max(0.0, dot(t_Normal, ${t}.Direction.xyz)) : 0.0;\n    t_Attenuation = max(0.0, ApplyAttenuation(${t}.CosAtten.xyz, t_Attenuation) / max(0.0, ApplyAttenuation(${t}.DistAtten.xyz, t_Attenuation)));`;throw"whoops"}generateColorChannel(e,t,s){const n=this.generateMaterialSource(e,s),i=this.generateAmbientSource(e,s);let r=e.lightingEnabled;if(null!==this.hacks&&this.hacks.disableLighting&&(r=!1),r&&null!==this.hacks&&this.hacks.lightingFudge){const e=`a_Color${s}`,r=`u_ColorAmbReg[${s}]`,a=`u_ColorMatReg[${s}]`;return`${t} = vec4(${this.hacks.lightingFudge({vtx:e,amb:r,mat:a,ambSource:i,matSource:n})}); // Fudge!`}let a="";if(r){a=`\n    t_LightAccum = ${i};`,0!==e.litMask&&(0,o.vA)(b(this.material));for(let t=0;t<8;t++){if(!(e.litMask&1<<t))continue;const s=`u_LightParams[${t}]`;a+=`\n    t_LightDelta = ${s}.Position.xyz - v_Position.xyz;\n    t_LightDeltaDist2 = dot(t_LightDelta, t_LightDelta);\n    t_LightDeltaDist = sqrt(t_LightDeltaDist2);\n    t_LightDeltaDir = t_LightDelta / t_LightDeltaDist;\n${this.generateLightAttnFn(e,s)}\n    t_LightAccum += ${this.generateLightDiffFn(e,s)} * t_Attenuation * ${s}.Color;\n`}}else a+="\n    t_LightAccum = vec4(1.0);";return`${a}\n    ${t} = ${n} * clamp(t_LightAccum, 0.0, 1.0);`.trim()}generateLightChannel(e,t,s){return n=e.colorChannel,i=e.alphaChannel,n.lightingEnabled===i.lightingEnabled&&n.litMask===i.litMask&&n.ambColorSource===i.ambColorSource&&n.matColorSource===i.matColorSource&&n.attenuationFunction===i.attenuationFunction&&n.diffuseFunction===i.diffuseFunction?`\n    ${this.generateColorChannel(e.colorChannel,t,s)}`:`\n    ${this.generateColorChannel(e.colorChannel,"t_ColorChanTemp",s)}\n    ${t}.rgb = t_ColorChanTemp.rgb;\n\n    ${this.generateColorChannel(e.alphaChannel,"t_ColorChanTemp",s)}\n    ${t}.a = t_ColorChanTemp.a;`;var n,i}generateLightChannels(){return this.material.lightChannels.map((e,t)=>this.generateLightChannel(e,`v_Color${t}`,t)).join("\n")}generateMulPntMatrixStatic(e,t,s="Mul"){if(e===n.b1.IDENTITY)return`${t}.xyz`;if(e>=n.b1.TEXMTX0)return`${s}(u_TexMtx[${(e-n.b1.TEXMTX0)/3}], ${t})`;if(e>=n.b1.PNMTX0)return`${s}(u_PosMtx[${(e-n.b1.PNMTX0)/3}], ${t})`;throw"whoops"}generateMulPntMatrixDynamic(e,t,s="Mul"){return`${s}(GetPosTexMatrix(${e}), ${t})`}generateTexMtxIdxAttr(e){if(e===n.gw.TEXCOORD0)return"(a_TexMtx0123Idx.x * 256.0)";if(e===n.gw.TEXCOORD1)return"(a_TexMtx0123Idx.y * 256.0)";if(e===n.gw.TEXCOORD2)return"(a_TexMtx0123Idx.z * 256.0)";if(e===n.gw.TEXCOORD3)return"(a_TexMtx0123Idx.w * 256.0)";if(e===n.gw.TEXCOORD4)return"(a_TexMtx4567Idx.x * 256.0)";if(e===n.gw.TEXCOORD5)return"(a_TexMtx4567Idx.y * 256.0)";if(e===n.gw.TEXCOORD6)return"(a_TexMtx4567Idx.z * 256.0)";if(e===n.gw.TEXCOORD7)return"(a_TexMtx4567Idx.w * 256.0)";throw"whoops"}generateTexGenSource(e){switch(e){case n.Kx.POS:return"vec4(a_Position.xyz, 1.0)";case n.Kx.NRM:return"vec4(a_Normal.xyz, 1.0)";case n.Kx.BINRM:return"vec4(a_Binormal.xyz, 1.0)";case n.Kx.TANGENT:return"vec4(a_Tangent.xyz, 1.0)";case n.Kx.COLOR0:return"v_Color0";case n.Kx.COLOR1:return"v_Color1";case n.Kx.TEX0:return"vec4(a_Tex01.xy, 1.0, 1.0)";case n.Kx.TEX1:return"vec4(a_Tex01.zw, 1.0, 1.0)";case n.Kx.TEX2:return"vec4(a_Tex23.xy, 1.0, 1.0)";case n.Kx.TEX3:return"vec4(a_Tex23.zw, 1.0, 1.0)";case n.Kx.TEX4:return"vec4(a_Tex45.xy, 1.0, 1.0)";case n.Kx.TEX5:return"vec4(a_Tex45.zw, 1.0, 1.0)";case n.Kx.TEX6:return"vec4(a_Tex67.xy, 1.0, 1.0)";case n.Kx.TEX7:return"vec4(a_Tex67.zw, 1.0, 1.0)";case n.Kx.TEXCOORD0:return"vec4(t_TexCoord0, 1.0)";case n.Kx.TEXCOORD1:return"vec4(t_TexCoord1, 1.0)";case n.Kx.TEXCOORD2:return"vec4(t_TexCoord2, 1.0)";case n.Kx.TEXCOORD3:return"vec4(t_TexCoord3, 1.0)";case n.Kx.TEXCOORD4:return"vec4(t_TexCoord4, 1.0)";case n.Kx.TEXCOORD5:return"vec4(t_TexCoord5, 1.0)";case n.Kx.TEXCOORD6:return"vec4(t_TexCoord6, 1.0)";default:throw new Error("whoops")}}generatePostTexGenMatrixMult(e,t){if(e.postMatrix===n.eV.PTIDENTITY)return`${t}.xyz`;if(e.postMatrix>=n.eV.PTTEXMTX0)return`Mul(u_PostTexMtx[${(e.postMatrix-n.eV.PTTEXMTX0)/3}], ${t})`;throw"whoops"}generateTexGenMatrixMult(e,t){if(S(this.material,e)){const s=this.generateTexMtxIdxAttr(e);return this.generateMulPntMatrixDynamic(s,t)}return this.generateMulPntMatrixStatic(this.material.texGens[e].matrix,t)}generateTexGenBump(e,t){const s=this.material.texGens[e];(0,o.vA)(s.type>=n.s3.BUMP0&&s.type<=n.s3.BUMP7);const i=`normalize(u_LightParams[${s.type-n.s3.BUMP0}].Position.xyz - v_Position.xyz)`;return`${t}.xyz + vec3(dot(${i}, ${this.generateMulNrm("a_Tangent",!1)}.xyz), dot(${i}, ${this.generateMulNrm("a_Binormal",!1)}.xyz), 0.0)`}generateTexGenType(e){const t=this.material.texGens[e],s=this.generateTexGenSource(t.source);return t.type===n.s3.SRTG?`vec3(${s}.xy, 1.0)`:t.type===n.s3.MTX2x4?`vec3(${this.generateTexGenMatrixMult(e,s)}.xy, 1.0)`:t.type===n.s3.MTX3x4?`${this.generateTexGenMatrixMult(e,s)}`:`${this.generateTexGenBump(e,s)}`}generateTexGenNrm(e){const t=this.material.texGens[e],s=this.generateTexGenType(e);return t.normalize?`normalize(${s})`:s}generateTexGenPost(e){const t=this.material.texGens[e],s=this.generateTexGenNrm(e);return t.postMatrix===n.eV.PTIDENTITY?s:this.generatePostTexGenMatrixMult(t,`vec4(${s}, 1.0)`)}generateTexGen(e){const t=this.material.texGens[e];let s;return s=t.type===n.s3.MTX2x4||t.type===n.s3.SRTG?".xy":".xyz",`\n    // TexGen ${e} Type: ${t.type} Source: ${t.source} Matrix: ${t.matrix}\n    vec3 t_TexCoord${e} = ${this.generateTexGenPost(e)};\n    v_TexCoord${e} = t_TexCoord${e}${s};`}generateTexGens(){return this.material.texGens.map((e,t)=>this.generateTexGen(t)).join("")}generateTexCoordVaryings(){return this.material.texGens.map((e,t)=>e.type===n.s3.MTX2x4||e.type===n.s3.SRTG?`varying vec2 v_TexCoord${t};\n`:`varying highp vec3 v_TexCoord${t};\n`).join("")}generateTexCoordGetters(){return this.material.texGens.map((e,t)=>e.type===n.s3.MTX2x4||e.type===n.s3.SRTG?`vec2 ReadTexCoord${t}() { return v_TexCoord${t}.xy; }\n`:`vec2 ReadTexCoord${t}() { return v_TexCoord${t}.xy / v_TexCoord${t}.z; }\n`).join("")}generateIndTexStageScaleN(e){switch(e){case n.ru._1:return"1.0";case n.ru._2:return"1.0/2.0";case n.ru._4:return"1.0/4.0";case n.ru._8:return"1.0/8.0";case n.ru._16:return"1.0/16.0";case n.ru._32:return"1.0/32.0";case n.ru._64:return"1.0/64.0";case n.ru._128:return"1.0/128.0";case n.ru._256:return"1.0/256.0";default:throw"whoops"}}generateIndTexStageScale(e){const t=`ReadTexCoord${e.texCoordId}()`;return e.scaleS===n.ru._1&&e.scaleT===n.ru._1?t:`${t} * vec2(${this.generateIndTexStageScaleN(e.scaleS)}, ${this.generateIndTexStageScaleN(e.scaleT)})`}generateTextureSample(e,t){return`texture(SAMPLER_2D(u_Texture${e}), ${t}, TextureLODBias(${e}))`}generateIndTexStage(e){const t=this.material.indTexStages[e];return`\n    // Indirect ${e}\n    vec3 t_IndTexCoord${e} = 255.0 * ${this.generateTextureSample(t.texture,this.generateIndTexStageScale(t))}.abg;`}generateIndTexStages(){return this.material.indTexStages.map((e,t)=>e.texCoordId>=this.material.texGens.length?"":this.generateIndTexStage(t)).join("")}generateKonstColorSel(e){switch(e){case n.jl.KCSEL_1:return"vec3(8.0/8.0)";case n.jl.KCSEL_7_8:return"vec3(7.0/8.0)";case n.jl.KCSEL_6_8:return"vec3(6.0/8.0)";case n.jl.KCSEL_5_8:return"vec3(5.0/8.0)";case n.jl.KCSEL_4_8:return"vec3(4.0/8.0)";case n.jl.KCSEL_3_8:return"vec3(3.0/8.0)";case n.jl.KCSEL_2_8:return"vec3(2.0/8.0)";case n.jl.KCSEL_1_8:return"vec3(1.0/8.0)";case n.jl.KCSEL_K0:return"s_kColor0.rgb";case n.jl.KCSEL_K0_R:return"s_kColor0.rrr";case n.jl.KCSEL_K0_G:return"s_kColor0.ggg";case n.jl.KCSEL_K0_B:return"s_kColor0.bbb";case n.jl.KCSEL_K0_A:return"s_kColor0.aaa";case n.jl.KCSEL_K1:return"s_kColor1.rgb";case n.jl.KCSEL_K1_R:return"s_kColor1.rrr";case n.jl.KCSEL_K1_G:return"s_kColor1.ggg";case n.jl.KCSEL_K1_B:return"s_kColor1.bbb";case n.jl.KCSEL_K1_A:return"s_kColor1.aaa";case n.jl.KCSEL_K2:return"s_kColor2.rgb";case n.jl.KCSEL_K2_R:return"s_kColor2.rrr";case n.jl.KCSEL_K2_G:return"s_kColor2.ggg";case n.jl.KCSEL_K2_B:return"s_kColor2.bbb";case n.jl.KCSEL_K2_A:return"s_kColor2.aaa";case n.jl.KCSEL_K3:return"s_kColor3.rgb";case n.jl.KCSEL_K3_R:return"s_kColor3.rrr";case n.jl.KCSEL_K3_G:return"s_kColor3.ggg";case n.jl.KCSEL_K3_B:return"s_kColor3.bbb";case n.jl.KCSEL_K3_A:return"s_kColor3.aaa"}}generateKonstAlphaSel(e){switch(e){case n.u_.KASEL_1:return"(8.0/8.0)";case n.u_.KASEL_7_8:return"(7.0/8.0)";case n.u_.KASEL_6_8:return"(6.0/8.0)";case n.u_.KASEL_5_8:return"(5.0/8.0)";case n.u_.KASEL_4_8:return"(4.0/8.0)";case n.u_.KASEL_3_8:return"(3.0/8.0)";case n.u_.KASEL_2_8:return"(2.0/8.0)";case n.u_.KASEL_1_8:return"(1.0/8.0)";case n.u_.KASEL_K0_R:return"s_kColor0.r";case n.u_.KASEL_K0_G:return"s_kColor0.g";case n.u_.KASEL_K0_B:return"s_kColor0.b";case n.u_.KASEL_K0_A:return"s_kColor0.a";case n.u_.KASEL_K1_R:return"s_kColor1.r";case n.u_.KASEL_K1_G:return"s_kColor1.g";case n.u_.KASEL_K1_B:return"s_kColor1.b";case n.u_.KASEL_K1_A:return"s_kColor1.a";case n.u_.KASEL_K2_R:return"s_kColor2.r";case n.u_.KASEL_K2_G:return"s_kColor2.g";case n.u_.KASEL_K2_B:return"s_kColor2.b";case n.u_.KASEL_K2_A:return"s_kColor2.a";case n.u_.KASEL_K3_R:return"s_kColor3.r";case n.u_.KASEL_K3_G:return"s_kColor3.g";case n.u_.KASEL_K3_B:return"s_kColor3.b";case n.u_.KASEL_K3_A:return"s_kColor3.a"}}generateIndTexCoordBase(e){return`(t_IndTexCoord${e.indTexStage})`}generateAlphaBumpSelChannel(e){const t=this.generateIndTexCoordBase(e);switch(e.indTexAlphaSel){case n.zi.S:return`${t}.x`;case n.zi.T:return`${t}.y`;case n.zi.U:return`${t}.z`;default:throw"whoops"}}generateAlphaBumpSel(e){const t=this.generateAlphaBumpSelChannel(e);switch(e.indTexFormat){case n.yU._8:return`TevMask(${t}, 0xF8)`;case n.yU._5:return`TevMask(${t}, 0xE0)`;case n.yU._4:return`TevMask(${t}, 0xF0)`;case n.yU._3:return`TevMask(${t}, 0xF8)`;default:throw"whoops"}}generateRas(e){switch(e.channelId){case n.Ug.COLOR0A0:return"v_Color0";case n.Ug.COLOR1A1:return"v_Color1";case n.Ug.ALPHA_BUMP:return`vec4(${this.generateAlphaBumpSel(e)})`;case n.Ug.ALPHA_BUMP_N:return`vec4(${this.generateAlphaBumpSel(e)} * (255.0/248.0))`;case n.Ug.COLOR_ZERO:return"vec4(0, 0, 0, 0)";default:throw new Error(`whoops ${e.channelId}`)}}stageUsesSimpleCoords(e){return e.indTexMatrix===n.fw.OFF&&!e.indTexAddPrev}generateTexAccess(e){if(e.texMap===n.zH.TEXMAP_NULL)return"vec4(1.0, 1.0, 1.0, 1.0)";if(null!==this.hacks&&this.hacks.disableTextures)return"vec4(1.0, 1.0, 1.0, 1.0)";const t=this.stageUsesSimpleCoords(e)?"":` * TextureInvScale(${e.texMap})`;return this.generateTextureSample(e.texMap,`t_TexCoord${t}`)}generateComponentSwizzle(e,t){return e&&(t=e[t]),["r","g","b","a"][t]}generateColorSwizzle(e,t){const s=this.generateComponentSwizzle(e,n.R7.R),i=this.generateComponentSwizzle(e,n.R7.G),r=this.generateComponentSwizzle(e,n.R7.B),a=this.generateComponentSwizzle(e,n.R7.A);switch(t){case n.CC.TEXC:case n.CC.RASC:return`${s}${i}${r}`;case n.CC.TEXA:case n.CC.RASA:return`${a}${a}${a}`;default:throw"whoops"}}generateColorIn(e,t){switch(t){case n.CC.CPREV:return"t_ColorPrev.rgb";case n.CC.APREV:return"t_ColorPrev.aaa";case n.CC.C0:return"t_Color0.rgb";case n.CC.A0:return"t_Color0.aaa";case n.CC.C1:return"t_Color1.rgb";case n.CC.A1:return"t_Color1.aaa";case n.CC.C2:return"t_Color2.rgb";case n.CC.A2:return"t_Color2.aaa";case n.CC.TEXC:case n.CC.TEXA:return`${this.generateTexAccess(e)}.${this.generateColorSwizzle(e.texSwapTable,t)}`;case n.CC.RASC:case n.CC.RASA:return`saturate(${this.generateRas(e)}.${this.generateColorSwizzle(e.rasSwapTable,t)})`;case n.CC.ONE:return"vec3(1)";case n.CC.HALF:return"vec3(1.0/2.0)";case n.CC.KONST:return`${this.generateKonstColorSel(e.konstColorSel)}`;case n.CC.ZERO:return"vec3(0)"}}generateAlphaIn(e,t){switch(t){case n.CA.APREV:return"t_ColorPrev.a";case n.CA.A0:return"t_Color0.a";case n.CA.A1:return"t_Color1.a";case n.CA.A2:return"t_Color2.a";case n.CA.TEXA:return`${this.generateTexAccess(e)}.${this.generateComponentSwizzle(e.texSwapTable,n.R7.A)}`;case n.CA.RASA:return`saturate(${this.generateRas(e)}.${this.generateComponentSwizzle(e.rasSwapTable,n.R7.A)})`;case n.CA.KONST:return`${this.generateKonstAlphaSel(e.konstAlphaSel)}`;case n.CA.ZERO:return"0.0";default:throw"whoops"}}generateTevInputs(e){return`\n    t_TevA = TevOverflow(vec4(${this.generateColorIn(e,e.colorInA)}, ${this.generateAlphaIn(e,e.alphaInA)}));\n    t_TevB = TevOverflow(vec4(${this.generateColorIn(e,e.colorInB)}, ${this.generateAlphaIn(e,e.alphaInB)}));\n    t_TevC = TevOverflow(vec4(${this.generateColorIn(e,e.colorInC)}, ${this.generateAlphaIn(e,e.alphaInC)}));\n    t_TevD = vec4(${this.generateColorIn(e,e.colorInD)}, ${this.generateAlphaIn(e,e.alphaInD)});\n`.trim()}generateTevRegister(e){switch(e){case n.UZ.PREV:return"t_ColorPrev";case n.UZ.REG0:return"t_Color0";case n.UZ.REG1:return"t_Color1";case n.UZ.REG2:return"t_Color2"}}generateTevOpBiasScaleClamp(e,t,s){let i=e;return t===n.bt.ADDHALF?i=`TevBias(${i}, 0.5)`:t===n.bt.SUBHALF&&(i=`TevBias(${i}, -0.5)`),s===n.mX.SCALE_2?i=`(${i}) * 2.0`:s===n.mX.SCALE_4?i=`(${i}) * 4.0`:s===n.mX.DIVIDE_2&&(i=`(${i}) * 0.5`),i}generateTevOp(e,t,s,i,r,a,o,l){switch(e){case n.fQ.ADD:case n.fQ.SUB:const h=`${e===n.fQ.SUB?"-":""}mix(${i}, ${r}, ${a}) + ${o}`;return this.generateTevOpBiasScaleClamp(h,t,s);case n.fQ.COMP_R8_GT:return`((t_TevA.r >  t_TevB.r) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_R8_EQ:return`((t_TevA.r == t_TevB.r) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_GR16_GT:return`((TevPack16(t_TevA.rg) >  TevPack16(t_TevB.rg)) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_GR16_EQ:return`((TevPack16(t_TevA.rg) == TevPack16(t_TevB.rg)) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_BGR24_GT:return`((TevPack24(t_TevA.rgb) >  TevPack24(t_TevB.rgb)) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_BGR24_EQ:return`((TevPack24(t_TevA.rgb) == TevPack24(t_TevB.rgb)) ? ${a} : ${l}) + ${o}`;case n.fQ.COMP_RGB8_GT:return`(TevPerCompGT(${i}, ${r}) * ${a}) + ${o}`;case n.fQ.COMP_RGB8_EQ:return`(TevPerCompEQ(${i}, ${r}) * ${a}) + ${o}`;default:throw new Error("whoops")}}generateTevOpValue(e,t,s,n,i,r,a,o,l){const h=this.generateTevOp(e,t,s,i,r,a,o,l);return n?`saturate(${h})`:`clamp(${h}, -4.0, 4.0)`}generateColorOp(e){const t=this.generateTevOpValue(e.colorOp,e.colorBias,e.colorScale,e.colorClamp,"t_TevA.rgb","t_TevB.rgb","t_TevC.rgb","t_TevD.rgb","vec3(0)");return`${this.generateTevRegister(e.colorRegId)}.rgb = ${t};`}generateAlphaOp(e){const t=this.generateTevOpValue(e.alphaOp,e.alphaBias,e.alphaScale,e.alphaClamp,"t_TevA.a","t_TevB.a","t_TevC.a","t_TevD.a","0.0");return`${this.generateTevRegister(e.alphaRegId)}.a = ${t};`}generateTevTexCoordWrapN(e,t){switch(t){case n.D_.OFF:return e;case n.D_._0:return"0.0";case n.D_._256:return`mod(${e}, 256.0)`;case n.D_._128:return`mod(${e}, 128.0)`;case n.D_._64:return`mod(${e}, 64.0)`;case n.D_._32:return`mod(${e}, 32.0)`;case n.D_._16:return`mod(${e}, 16.0)`}}generateTevTexCoordWrap(e){if(e.texCoordId===n.gw.TEXCOORD_NULL||e.texMap===n.zH.TEXMAP_NULL)return"";const t=this.material.texGens.length-1;let s=e.texCoordId;if(s>=t&&(s=t),s<0)return"vec2(0.0, 0.0)";const i=`ReadTexCoord${s}()${this.stageUsesSimpleCoords(e)?"":` * TextureScale(${e.texMap})`}`;return e.indTexWrapS===n.D_.OFF&&e.indTexWrapT===n.D_.OFF?i:`vec2(${this.generateTevTexCoordWrapN(`${i}.x`,e.indTexWrapS)}, ${this.generateTevTexCoordWrapN(`${i}.y`,e.indTexWrapT)})`}generateTevTexCoordIndTexCoordBias(e){const t=e.indTexFormat===n.yU._8?"-128.0":"1.0";switch(e.indTexBiasSel){case n.QE.NONE:return"";case n.QE.S:return` + vec3(${t}, 0.0, 0.0)`;case n.QE.ST:return` + vec3(${t}, ${t}, 0.0)`;case n.QE.SU:return` + vec3(${t}, 0.0, ${t})`;case n.QE.T:return` + vec3(0.0, ${t}, 0.0)`;case n.QE.TU:return` + vec3(0.0, ${t}, ${t})`;case n.QE.U:return` + vec3(0.0, 0.0, ${t})`;case n.QE.STU:return` + vec3(${t})`}}generateTevTexCoordIndTexCoord(e){const t=this.generateIndTexCoordBase(e);switch(e.indTexFormat){case n.yU._8:return t;default:case n.yU._5:throw new Error("whoops")}}generateTevTexCoordIndirectMtx(e){const t=`(${this.generateTevTexCoordIndTexCoord(e)}${this.generateTevTexCoordIndTexCoordBias(e)})`,s=(3&e.indTexMatrix)-1;switch(e.indTexMatrix){case n.fw._0:case n.fw._1:case n.fw._2:return`Mul(u_IndTexMtx[${s}], vec4(${t}, 0.0))`;case n.fw.S0:case n.fw.S1:case n.fw.S2:return`(u_IndTexMtx[${s}].mx.w * ReadTexCoord${e.texCoordId}() * ${t}.xx)`;case n.fw.T0:case n.fw.T1:case n.fw.T2:return`(u_IndTexMtx[${s}].mx.w * ReadTexCoord${e.texCoordId}() * ${t}.yy)`;default:throw"whoops"}}generateTevTexCoordIndirectTranslation(e){return e.indTexMatrix!==n.fw.OFF&&e.indTexStage<this.material.indTexStages.length?`${this.generateTevTexCoordIndirectMtx(e)}`:""}generateTevTexCoordIndirect(e){const t=this.generateTevTexCoordWrap(e),s=this.generateTevTexCoordIndirectTranslation(e);return""!==t&&""!==s?`${t} + ${s}`:""!==t?t:s}generateTevTexCoord(e){const t=this.generateTevTexCoordIndirect(e);return""!==t?e.indTexAddPrev?`t_TexCoord += ${t};`:`t_TexCoord = ${t};`:""}generateTevStage(e){const t=this.material.tevStages[e];return`\n    // TEV Stage ${e}\n    ${this.generateTevTexCoord(t)}\n    // Color Combine\n    // colorIn: ${t.colorInA} ${t.colorInB} ${t.colorInC} ${t.colorInD}  colorOp: ${t.colorOp} colorBias: ${t.colorBias} colorScale: ${t.colorScale} colorClamp: ${t.colorClamp} colorRegId: ${t.colorRegId}\n    // alphaIn: ${t.alphaInA} ${t.alphaInB} ${t.alphaInC} ${t.alphaInD}  alphaOp: ${t.alphaOp} alphaBias: ${t.alphaBias} alphaScale: ${t.alphaScale} alphaClamp: ${t.alphaClamp} alphaRegId: ${t.alphaRegId}\n    // texCoordId: ${t.texCoordId} texMap: ${t.texMap} channelId: ${t.channelId}\n    ${this.generateTevInputs(t)}\n    ${this.generateColorOp(t)}\n    ${this.generateAlphaOp(t)}`}generateTevStages(){return this.material.tevStages.map((e,t)=>this.generateTevStage(t)).join("\n")}generateTevStagesLastMinuteFixup(){const e=this.material.tevStages,t=e[e.length-1],s=this.generateTevRegister(t.colorRegId),n=this.generateTevRegister(t.alphaRegId);return s===n?`\n    vec4 t_TevOutput = ${s};`:`\n    vec4 t_TevOutput = vec4(${s}.rgb, ${n}.a);`}generateAlphaTestCompare(e,t){switch(e){case n.oH.NEVER:return"false";case n.oH.LESS:return`t_PixelOut.a <  ${t}`;case n.oH.EQUAL:return`t_PixelOut.a == ${t}`;case n.oH.LEQUAL:return`t_PixelOut.a <= ${t}`;case n.oH.GREATER:return`t_PixelOut.a >  ${t}`;case n.oH.NEQUAL:return`t_PixelOut.a != ${t}`;case n.oH.GEQUAL:return`t_PixelOut.a >= ${t}`;case n.oH.ALWAYS:return"true"}}generateAlphaTestOp(e){switch(e){case n.O2.AND:return"t_AlphaTestA && t_AlphaTestB";case n.O2.OR:return"t_AlphaTestA || t_AlphaTestB";case n.O2.XOR:return"t_AlphaTestA != t_AlphaTestB";case n.O2.XNOR:return"t_AlphaTestA == t_AlphaTestB"}}generateAlphaTest(){const e=this.material.alphaTest;if(e.op===n.O2.OR&&(e.compareA===n.oH.ALWAYS||e.compareB===n.oH.ALWAYS))return"";const t=w(this.material)?"u_DynamicAlphaParams.x":this.generateFloat(e.referenceA),s=w(this.material)?"u_DynamicAlphaParams.y":this.generateFloat(e.referenceB);return`\n    bool t_AlphaTestA = ${this.generateAlphaTestCompare(e.compareA,t)};\n    bool t_AlphaTestB = ${this.generateAlphaTestCompare(e.compareB,s)};\n    if (!(${this.generateAlphaTestOp(e.op)}))\n        discard;`}generateFogZCoord(){return l.KX?"(1.0 - gl_FragCoord.z)":"gl_FragCoord.z"}generateFogBase(){const e="u_FogBlock.Param.x",t=this.generateFogZCoord();return`((u_FogBlock.Param.y != 0.0)) ? (${e} / (u_FogBlock.Param.y - ${t})) : (${e} * ${t})`}generateFogAdj(e){return this.material.ropInfo.fogAdjEnabled,""}generateFogFunc(e){const t=7&this.material.ropInfo.fogType;if(t===n.Du.PERSP_LIN)return e;if(t===n.Du.PERSP_EXP)return`1.0 - exp2(-8.0 * ${e});`;if(t===n.Du.PERSP_EXP2)return`1.0 - exp2(-8.0 * ${e} * ${e});`;if(t===n.Du.ORTHO_REVEXP)return`1.0 - exp2(-8.0 * (1.0 - ${e}));`;if(t===n.Du.ORTHO_REVEXP2)return`1.0 - exp2(-8.0 * (1.0 - ${e}) * (1.0 - ${e}));`;throw"whoops"}generateFog(){return this.material.ropInfo.fogType===n.Du.NONE?"":`\n    float t_FogBase = ${this.generateFogBase()};\n${this.generateFogAdj("t_FogBase")}\n    float t_FogZ = saturate(t_FogBase - u_FogBlock.Param.z);\n    float t_Fog = ${this.generateFogFunc("t_FogZ")};\n    t_PixelOut.rgb = mix(t_PixelOut.rgb, u_FogBlock.Color.rgb, t_Fog);\n`}generateDstAlpha(){const e=this.material.ropInfo;return void 0===e.dstAlpha?"":`\n    t_PixelOut.a = ${this.generateFloat(e.dstAlpha)};\n`}generateAttributeStorageType(e){switch(e){case r.$Y.F32_R:return"float";case r.$Y.F32_RG:return"vec2";case r.$Y.F32_RGB:return"vec3";case r.$Y.F32_RGBA:return"vec4";default:throw"whoops"}}usesColorChannel(e){return e.matColorSource===n.uj.VTX||e.ambColorSource===n.uj.VTX}usesLightChannel(e){return void 0!==e&&(this.usesColorChannel(e.colorChannel)||this.usesColorChannel(e.alphaChannel))}usesNormalColorChannel(e){return!(!e.lightingEnabled||0===e.litMask||e.diffuseFunction===n.jN.NONE&&e.attenuationFunction!==n.bg.SPEC)}usesNormal(){return this.material.lightChannels.some(e=>this.usesNormalColorChannel(e.colorChannel)||this.usesNormalColorChannel(e.alphaChannel))}usesTexGenInput(e){return this.material.texGens.some(t=>t.source===e)}usesBump(){return this.material.texGens.some(e=>e.type>=n.s3.BUMP0&&e.type<=n.s3.BUMP7)}usesAttrib(e){switch(e.attrInput){case c.fg.POS:return!0;case c.fg.TEX0123MTXIDX:return S(this.material,0)||S(this.material,1)||S(this.material,2)||S(this.material,3);case c.fg.TEX4567MTXIDX:return S(this.material,4)||S(this.material,5)||S(this.material,6)||S(this.material,7);case c.fg.NRM:return this.usesNormal()||this.usesTexGenInput(n.Kx.NRM);case c.fg.TANGENT:return this.usesTexGenInput(n.Kx.TANGENT)||this.usesBump();case c.fg.BINRM:return this.usesTexGenInput(n.Kx.BINRM)||this.usesBump();case c.fg.CLR0:return this.usesLightChannel(this.material.lightChannels[0]);case c.fg.CLR1:return this.usesLightChannel(this.material.lightChannels[1]);case c.fg.TEX01:return this.usesTexGenInput(n.Kx.TEX0)||this.usesTexGenInput(n.Kx.TEX1);case c.fg.TEX23:return this.usesTexGenInput(n.Kx.TEX2)||this.usesTexGenInput(n.Kx.TEX3);case c.fg.TEX45:return this.usesTexGenInput(n.Kx.TEX4)||this.usesTexGenInput(n.Kx.TEX5);case c.fg.TEX67:return this.usesTexGenInput(n.Kx.TEX6)||this.usesTexGenInput(n.Kx.TEX7);default:return!1}}generateVertAttributeDefs(){return x.map((e,t)=>this.usesAttrib(e)?`layout(location = ${t}) in ${this.generateAttributeStorageType(e.format)} a_${e.name};`:"").join("\n")}generateMulPos(){const e="vec4(a_Position.xyz, 1.0)";return y(this.material)?this.generateMulPntMatrixDynamic("a_Position.w",e):this.generateMulPntMatrixStatic(n.b1.PNMTX0,e)}generateMulNrm(e,t){const s=`vec4(${e}.xyz, 0.0)`,i=y(this.material)?this.generateMulPntMatrixDynamic("a_Position.w",s,"MulNormalMatrix"):this.generateMulPntMatrixStatic(n.b1.PNMTX0,s,"MulNormalMatrix");return t?`normalize(${i})`:i}generateShaders(){const e=`\n// Expected to be constant across the entire scene.\nlayout(std140) uniform ub_SceneParams {\n    Mat4x4 u_Projection;\n    vec4 u_Misc0;\n};\n\n#define u_SceneTextureLODBias u_Misc0[0]\n\nstruct Light {\n    vec4 Color;\n    vec4 Position;\n    vec4 Direction;\n    vec4 DistAtten;\n    vec4 CosAtten;\n};\n\nstruct FogBlock {\n    // A, B, C, Center\n    vec4 Param;\n    // 10 items\n    vec4 AdjTable[3];\n    // Fog color is RGB\n    vec4 Color;\n};\n\n// Expected to change with each material.\nlayout(std140) uniform ub_MaterialParams {\n    vec4 u_ColorMatReg[2];\n    vec4 u_ColorAmbReg[2];\n    vec4 u_KonstColor[4];\n    vec4 u_Color[4];\n    Mat4x3 u_TexMtx[10];\n    vec4 u_TextureSizes[4];\n    vec4 u_TextureBiases[2];\n    Mat4x2 u_IndTexMtx[3];\n\n    // Optional parameters.\n${C(t=this.material)?"\n    Mat4x3 u_PostTexMtx[20];\n":""}\n${b(t)?"\n    Light u_LightParams[8];\n":""}\n${_(t)?"\n    FogBlock u_FogBlock;\n":""}\n${w(t)?"\n    vec4 u_DynamicAlphaParams;\n":""}\n};\n\n// Expected to change with each shape draw.\nlayout(std140) uniform ub_DrawParams {\n${y(t)?"\n    Mat4x3 u_PosMtx[10];\n":"\n    Mat4x3 u_PosMtx[1];\n"}\n};\n\nuniform sampler2D u_Texture0;\nuniform sampler2D u_Texture1;\nuniform sampler2D u_Texture2;\nuniform sampler2D u_Texture3;\nuniform sampler2D u_Texture4;\nuniform sampler2D u_Texture5;\nuniform sampler2D u_Texture6;\nuniform sampler2D u_Texture7;\n`;var t;const s=`\n// ${this.material.name}\nprecision mediump float;\n${e}\n${d.i.saturate}\n${f.TevOverflow}\n\nvarying vec3 v_Position;\nvarying vec4 v_Color0;\nvarying vec4 v_Color1;\n${this.generateTexCoordVaryings()}\n`;this.vert=`\n${s}\n${this.generateVertAttributeDefs()}\n\nMat4x3 GetPosTexMatrix(float t_MtxIdxFloat) {\n    uint t_MtxIdx = uint(t_MtxIdxFloat);\n    if (t_MtxIdx == 20u)\n        return _Mat4x3(1.0);\n    else if (t_MtxIdx >= 10u)\n        return u_TexMtx[(t_MtxIdx - 10u)];\n    else\n        return u_PosMtx[t_MtxIdx];\n}\n\n${d.i.MulNormalMatrix}\n\nvec3 MulNormalMatrix(Mat4x3 t_Matrix, vec4 t_Value) {\n    return MulNormalMatrix(t_Matrix, t_Value.xyz);\n}\n\nfloat ApplyAttenuation(vec3 t_Coeff, float t_Value) {\n    return dot(t_Coeff, vec3(1.0, t_Value, t_Value*t_Value));\n}\n\nvoid main() {\n    vec3 t_Position = ${this.generateMulPos()};\n    v_Position = t_Position;\n    vec3 t_Normal = ${this.usesNormal()?this.generateMulNrm("a_Normal",!0):"vec3(0.0)"};\n\n    vec4 t_LightAccum;\n    vec3 t_LightDelta, t_LightDeltaDir;\n    float t_LightDeltaDist2, t_LightDeltaDist, t_Attenuation;\n    vec4 t_ColorChanTemp;\n${this.generateLightChannels()}\n${this.generateTexGens()}\n    gl_Position = Mul(u_Projection, vec4(t_Position, 1.0));\n}\n`,this.frag=`\n${s}\n${this.generateTexCoordGetters()}\n\nfloat TextureLODBias(int index) {\n    vec4 elem = u_TextureBiases[index / 4]; // 01\n    int sub = index % 4; // 0123\n    return u_SceneTextureLODBias + elem[sub];\n}\nvec2 TextureScale(int index) {\n    vec4 elem = u_TextureSizes[index / 2];\n    int sub = 2 * (index % 2);\n    return vec2(elem[sub + 0], elem[sub + 1]);\n}\nvec2 TextureInvScale(int index) { return 1.0 / TextureScale(index); }\n\nvec3 TevBias(vec3 a, float b) { return a + vec3(b); }\nfloat TevBias(float a, float b) { return a + b; }\nfloat TevPack16(vec2 a) { return dot(a, vec2(1.0, 256.0)); }\nfloat TevPack24(vec3 a) { return dot(a, vec3(1.0, 256.0, 256.0 * 256.0)); }\nfloat TevPerCompGT(float a, float b) { return float(a >  b); }\nfloat TevPerCompEQ(float a, float b) { return float(a == b); }\nvec3 TevPerCompGT(vec3 a, vec3 b) { return vec3(greaterThan(a, b)); }\nvec3 TevPerCompEQ(vec3 a, vec3 b) { return vec3(greaterThan(a, b)); }\nfloat TevMask(float n, int mask) { return float(int((n * 255.0)) & mask) / 255.0; }\n\nvec4 MainColor() {\n    vec4 s_kColor0   = u_KonstColor[0];\n    vec4 s_kColor1   = u_KonstColor[1];\n    vec4 s_kColor2   = u_KonstColor[2];\n    vec4 s_kColor3   = u_KonstColor[3];\n\n    vec4 t_ColorPrev = u_Color[0];\n    vec4 t_Color0    = u_Color[1];\n    vec4 t_Color1    = u_Color[2];\n    vec4 t_Color2    = u_Color[3];\n\n${this.generateIndTexStages()}\n\n    vec2 t_TexCoord = vec2(0.0, 0.0);\n    vec4 t_TevA, t_TevB, t_TevC, t_TevD;\n${this.generateTevStages()}\n\n${this.generateTevStagesLastMinuteFixup()}\n    vec4 t_PixelOut = TevOverflow(t_TevOutput);\n${this.generateAlphaTest()}\n${this.generateFog()}\n${this.generateDstAlpha()}\n\n    return t_PixelOut;\n}\n\nlayout(location = 0) out vec4 o_OutColor0;\nlayout(location = 1) out vec4 o_OutColor1;\n\nvoid main() {\n    o_OutColor0 = MainColor();\n    // This is a hack for Galaxy shadow clearing...\n    // TODO(jstpierre): Make this configurable? Allow subclassing GX_Material? Yikes...\n    o_OutColor1 = vec4(0.0);\n}\n`}}function I(e,t,s){(t<=0||t>=90)&&(s=n.TX.OFF);const i=Math.cos(t*h.wZ.DEG_TO_RAD);if(s===n.TX.FLAT)a.hZ(e.CosAtten,-1e3*i,1e3,0);else if(s===n.TX.COS)a.hZ(e.CosAtten,-i/(1-i),1/(1-i),0);else if(s===n.TX.COS2)a.hZ(e.CosAtten,0,-i/(1-i),1/(1-i));else if(s===n.TX.SHARP){const t=(1-i)*(1-i);a.hZ(e.CosAtten,i*(i-2)/t,2/t,-1/t)}else if(s===n.TX.RING1){const t=(1-i)*(1-i);a.hZ(e.CosAtten,-4*i/t,4*(1+i)/t,-4/t)}else if(s===n.TX.RING2){const t=(1-i)*(1-i);a.hZ(e.CosAtten,1-2*i*i/t,4*i/t,-2/t)}else s===n.TX.OFF&&a.hZ(e.CosAtten,1,0,0)}function k(e,t,s,i){(t<0||s<=0||s>=1)&&(i=n.OR.OFF),i===n.OR.GENTLE?a.hZ(e.DistAtten,1,(1-s)/(s*t),0):i===n.OR.MEDIUM?a.hZ(e.DistAtten,1,.5*(1-s)/(s*t),.5*(1-s)/(s*t*t)):i===n.OR.STEEP?a.hZ(e.DistAtten,1,0,(1-s)/(s*t*t)):i===n.OR.OFF&&a.hZ(e.DistAtten,1,0,0)}R.ub_SceneParams=0,R.ub_MaterialParams=1,R.ub_DrawParams=2},8771(e,t,s){"use strict";s.d(t,{k2:()=>I,$r:()=>L,kg:()=>j,BC:()=>te,gA:()=>B,TD:()=>D,QX:()=>Z,D9:()=>q,gI:()=>G,E_:()=>F,$7:()=>ee,md:()=>Q,ln:()=>$,nw:()=>H,Hp:()=>W,sl:()=>O});var n=s(7684),i=s(2003),r=s(9667),a=s(4107),o=s(5974),l=s(930),h=s(305),c=s(3489),u=s(7714),d=s(1110),m=s(4439),p=s(6253),f=s(7911),g=s(9918);class T{constructor(e){this.device=e,this.currentBufferWordSize=-1,this.currentWordOffset=0,this.gfxBuffer=null,this.shadowBufferF32=null,this.shadowBufferU8=null;const t=e.queryLimits();this.uniformBufferWordAlignment=t.uniformBufferWordAlignment,this.uniformBufferMaxPageWordSize=t.uniformBufferMaxPageWordSize}findPageIndex(e){return e/this.uniformBufferMaxPageWordSize|0}allocateChunk(e){e=(0,d.nc)(e,this.uniformBufferWordAlignment),(0,d.vA)(e<=this.uniformBufferMaxPageWordSize);let t=this.currentWordOffset;return this.findPageIndex(t)!==this.findPageIndex(t+e-1)&&(t=(0,d.nc)(t,this.uniformBufferMaxPageWordSize)),this.currentWordOffset=t+e,this.ensureShadowBuffer(t,e),t}ensureShadowBuffer(e,t){if(null===this.shadowBufferU8||null===this.shadowBufferF32){const e=(0,d.nc)(this.currentWordOffset,this.uniformBufferMaxPageWordSize);this.shadowBufferU8=new Uint8Array(4*e),this.shadowBufferF32=new Float32Array(this.shadowBufferU8.buffer)}else if(e+t>=this.shadowBufferF32.length){(0,d.vA)(e<this.currentWordOffset&&e+t<=this.currentWordOffset);const s=(0,d.nc)(Math.max(this.currentWordOffset,2*this.shadowBufferF32.length),this.uniformBufferMaxPageWordSize),n=new Uint8Array(4*s);if(n.set(this.shadowBufferU8,0),this.shadowBufferU8=n,this.shadowBufferF32=new Float32Array(this.shadowBufferU8.buffer),!(this.currentWordOffset<=s))throw new Error(`Assert fail: this.currentWordOffset [${this.currentWordOffset}] <= newWordCount [${s}]`)}}mapBufferF32(){return(0,d.Z1)(this.shadowBufferF32)}prepareToRender(){if(null===this.shadowBufferF32)return;const e=(0,d.Z1)(this.shadowBufferF32);e.length!==this.currentBufferWordSize&&(this.currentBufferWordSize=e.length,null!==this.gfxBuffer&&this.device.destroyBuffer(this.gfxBuffer),this.gfxBuffer=this.device.createBuffer(this.currentBufferWordSize,u.B6.Uniform,u.R6.Dynamic));const t=(0,d.nc)(this.currentWordOffset,this.uniformBufferMaxPageWordSize);if(!(t<=this.currentBufferWordSize))throw new Error(`Assert fail: wordCount [${t}] (${this.currentWordOffset} aligned ${this.uniformBufferMaxPageWordSize}) <= this.currentBufferWordSize [${this.currentBufferWordSize}]`);const s=(0,d.Z1)(this.gfxBuffer);this.device.uploadBufferData(s,0,this.shadowBufferU8,0,4*t),this.currentWordOffset=0}destroy(){null!==this.gfxBuffer&&this.device.destroyBuffer(this.gfxBuffer),this.shadowBufferF32=null,this.shadowBufferU8=null}}var x=s(5144),v=s(373),C=s(2898),b=s(6726),_=s(5339),y=s(1158),S=s(7653);class w{constructor(e){this.helper=e,this.anim=[],this.textureMapping=(0,d.y5)(1,d.ds),this.enabled=!1,this.thumbnailWidth=128,this.thumbnailHeight=128,this.padding=32;const t=e.device,s=e.renderCache,n=(0,C.ar)(t.queryVendorInfo(),v.i.fullscreenVS,v.i.fullscreenBlitOneTexPS);this.blitProgram=s.createProgramSimple(n);const i=(0,C.ar)(t.queryVendorInfo(),v.i.fullscreenVS,"\nuniform sampler2D u_Texture;\nin vec2 v_TexCoord;\n\nvoid main() {\n    gl_FragColor = texture(SAMPLER_2D(u_Texture), v_TexCoord);\n    gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(1.0 / 2.2));\n}\n");this.blitProgramSRGB=s.createProgramSimple(i),this.textureMapping[0].gfxSampler=s.createSampler({magFilter:u.gD.Bilinear,minFilter:u.gD.Bilinear,mipFilter:u.P.Nearest,minLOD:0,maxLOD:100,wrapS:u.Vf.Clamp,wrapT:u.Vf.Clamp}),this.uniformBuffer=new T(t)}computeViewport(e,t){const s=e.width/e.height,n=t.x2-t.x1,i=n*(s/(n/(t.y2-t.y1)));return{x1:t.x1-.5*(i-n),x2:t.x2+.5*(i-n),y1:t.y1,y2:t.y2}}adjustAnim(e,t,s){const n=.05*(function(e,t,s){const{x1:n,y1:i,x2:r,y2:a}=e;return t>=n&&t<r&&s>=i&&s<a}(t,s.mouseX,s.mouseY)?1:-1);return this.anim[e]=(0,_.Ih)(this.anim[e]+n),(0,_.TF)(this.anim[e])}pushPasses(e,t,s,n){if(!this.enabled)return;const i=this.helper.getDebugTextDrawer(),r=e.getDebug().getDebugThumbnails();if(0===r.length)return;const a=[];for(let t=0;t<r.length;t++)a.push(e.resolveRenderTargetPassAttachmentSlot(r[t].pass,r[t].attachmentSlot));const o=e.getRenderTargetDescription(s),l={x1:0,y1:0,x2:o.width,y2:o.height},h=t.newRenderInst();h.setBindingLayouts([{numUniformBuffers:0,numSamplers:1}]),h.setMegaStateFlags(b.BT),h.setDrawCount(3);const c=this.thumbnailWidth*window.devicePixelRatio,u=this.thumbnailHeight*window.devicePixelRatio,m=o.height-this.padding,p=m-u,g=s=>{const i=e.getRenderTargetDescription(r[s].renderTargetID),a=r.length-1-s,h=o.width-(c+this.padding)*a-this.padding,u={x1:h-c,y1:p,x2:h,y2:m},d=this.adjustAnim(s,u,n);!function(e,t,s,n){e.x1=(0,_.Cc)(t.x1,s.x1,n),e.y1=(0,_.Cc)(t.y1,s.y1,n),e.x2=(0,_.Cc)(t.x2,s.x2,n),e.y2=(0,_.Cc)(t.y2,s.y2,n)}(u,u,l,d),(0,y.H)(t.gfxRenderCache.device)&&function(e,t){const s=e.y1;e.y1=t-e.y2,e.y2=t-s}(u,o.height);const f=this.computeViewport(i,u);return{t:d,location:u,vx:Math.max(0,Math.ceil(f.x1)),vy:Math.max(0,Math.ceil(f.y1)),vw:Math.min(o.width,Math.floor(f.x2-f.x1)),vh:Math.min(o.height,Math.floor(f.y2-f.y1))}},T=(e,s,n)=>{const i=new f.Qz(null),a=t.currentRenderInstList;t.currentRenderInstList=i,t.pushTemplateRenderInst().setUniformBuffer(this.uniformBuffer);const{t:o,vw:l,vh:h}=n,c=r[s].debugLabel.split("\n");for(let s=0;s<c.length;s++){e.textColor.a=(0,_.Cc)(.6,1,o),e.setFontScale((0,_.Cc)(.5,1,o));const n=(0,_.Cc)(5,20,o)+e.getScaledLineHeight()*s;e.drawString(t,l,h,c[s],l/2,h-n)}return t.popTemplateRenderInst(),t.currentRenderInstList=a,i},v=e=>(0,S.vg)(e.pixelFormat)&S.lk.sRGB?this.blitProgramSRGB:this.blitProgram,C=(s,n,i,o,l)=>{const c=s.getResolveTextureForID(a[i]);this.textureMapping[0].gfxTexture=c;const{location:u,vx:d,vy:m,vw:p,vh:f}=l;n.setViewport(d,m,p,f),n.setScissor(u.x1,u.y1,u.x2-u.x1,u.y2-u.y1);const g=e.getRenderTargetDescription(r[i].renderTargetID);h.setGfxProgram(v(g)),h.setSamplerBindingsFromTextureMappings(this.textureMapping),h.drawOnPass(t.gfxRenderCache,n),void 0!==o&&o.drawOnPassRenderer(t.gfxRenderCache,n)};for(let e=0;e<r.length;e++)this.anim[e]||(this.anim[e]=0);const w=(0,d.y1)(0,r.length);w.sort((e,t)=>this.anim[e]-this.anim[t]),e.pushPass(e=>{e.setDebugName("Debug Thumbnails"),e.attachRenderTargetID(x.jY.Color0,s);for(let t=0;t<r.length;t++)e.attachResolveTexture(a[t]);e.exec((e,s)=>{const n=r.map((e,t)=>g(w[t]));let a=[];if(null!==i){i.beginDraw();const e=r.map(e=>e.debugLabel.length).reduce((e,t)=>e+t);i.reserveString(e),a=r.map((e,t)=>T(i,w[t],n[t])),i.endDraw(t),this.uniformBuffer.prepareToRender()}r.forEach((t,i)=>C(s,e,w[i],a[i],n[i]))})})}destroy(){this.uniformBuffer.destroy()}}class A{constructor(e,t=null){this.device=e,this.renderCacheOwn=null,null===t?(this.renderCacheOwn=new g.g(e),this.renderCache=this.renderCacheOwn):this.renderCache=t,this.renderGraph=new x.EV(this.device),this.renderInstManager=new f.JB(this.renderCache),this.uniformBuffer=new T(this.device),this.debugThumbnails=new w(this),this.antialiasingSupport=new p.MD(this)}pushTemplateRenderInst(){const e=this.renderInstManager.pushTemplateRenderInst();return e.setUniformBuffer(this.uniformBuffer),e}prepareToRender(){this.renderCache.prepareToRender(),this.uniformBuffer.prepareToRender()}destroy(){null!==this.renderCacheOwn&&this.renderCacheOwn.destroy(),this.uniformBuffer.destroy(),this.renderGraph.destroy()}getDebugTextDrawer(){return null}}class E{constructor(e){this.func=e,this.value=null,this.completed=!1,this.promise=null}getValueOrStart(){return this.completed?this.value:(null===this.promise&&(this.promise=this.func(),this.promise.then(e=>{this.value=e,this.promise=null,this.completed=!0})),null)}}class R extends A{constructor(e,t=null,n=null){super(e,n),this.debugTextDrawer=new E(async()=>{const{makeDebugTextDrawer:e}=await s.e(84).then(s.bind(s,3084));return null!==t?e(t):null})}getDebugTextDrawer(){return this.debugTextDrawer.getValueOrStart()}destroy(){super.destroy(),this.debugThumbnails.destroy()}}var I,k=s(7459),M=s(7020);function P(e,t,s=u.$Y.U8_RGBA_NORM){const n=e.getContext("2d"),i=n.createImageData(e.width,e.height);!function(e,t,s){if(s===u.$Y.U8_RGBA_NORM)e.data.set(t.createTypedArray(Uint8Array));else{if(s!==u.$Y.S8_RGBA_NORM)throw"whoops";!function(e,t){for(let s=0;s<t.length;s++)e.data[s]=t[s]+128}(e,t.createTypedArray(Int8Array))}}(i,t,s),n.putImageData(i,0,0)}!function(e){e[e.MAT0=0]="MAT0",e[e.MAT1=1]="MAT1",e[e.AMB0=2]="AMB0",e[e.AMB1=3]="AMB1",e[e.K0=4]="K0",e[e.K1=5]="K1",e[e.K2=6]="K2",e[e.K3=7]="K3",e[e.CPREV=8]="CPREV",e[e.C0=9]="C0",e[e.C1=10]="C1",e[e.C2=11]="C2",e[e.COUNT=12]="COUNT"}(I||(I={}));class D{constructor(){this.u_Projection=n.vt(),this.u_SceneTextureLODBias=0}}class B{constructor(){this.m_TextureMapping=(0,o.y5)(8,()=>new c.C$),this.u_Color=(0,o.y5)(I.COUNT,()=>(0,k.Zv)(k.gh)),this.u_TexMtx=(0,o.y5)(10,()=>n.vt()),this.u_PostTexMtx=(0,o.y5)(20,()=>n.vt()),this.u_IndTexMtx=(0,o.y5)(3,()=>n.vt()),this.u_Lights=(0,o.y5)(8,()=>new r.ve),this.u_FogBlock=new r.S_,this.u_DynamicAlphaRefA=0,this.u_DynamicAlphaRefB=0,(0,k.gM)(this.u_Color[I.MAT0],1,1,1,1),(0,k.gM)(this.u_Color[I.MAT1],1,1,1,1)}clear(){for(let e=0;e<8;e++)this.m_TextureMapping[e].reset()}}class L{constructor(){this.u_PosMtx=(0,o.y5)(10,()=>n.vt())}clear(){for(let e=0;e<10;e++)n.D_(this.u_PosMtx[e])}}const O=20;function F(e,t,s){let n=t;n+=(0,m.lD)(e,n,s.u_Projection),n+=(0,m.up)(e,n,s.u_SceneTextureLODBias),(0,o.vA)(n===t+O),(0,o.vA)(e.length>=n)}function U(e,t,s){return t+=(0,m.pf)(e,t,s.Color),t+=(0,m.fW)(e,t,s.Position),t+=(0,m.fW)(e,t,s.Direction),t+=(0,m.fW)(e,t,s.DistAtten),t+=(0,m.fW)(e,t,s.CosAtten),20}function N(e,t,s){return e[t++]=s.width,e[t++]=s.height*(s.flipY?-1:1),2}function X(e,t,s){return e[t++]=s.lodBias,1}function V(e,t,s,n){let i=s;for(let e=0;e<12;e++)i+=(0,m.pf)(t,i,n.u_Color[e]);for(let e=0;e<10;e++)i+=(0,m.s2)(t,i,n.u_TexMtx[e]);for(let e=0;e<8;e++)i+=N(t,i,n.m_TextureMapping[e]);for(let e=0;e<8;e++)i+=X(t,i,n.m_TextureMapping[e]);for(let e=0;e<3;e++)i+=(0,m.lo)(t,i,n.u_IndTexMtx[e]);if(r.PY(e))for(let e=0;e<20;e++)i+=(0,m.s2)(t,i,n.u_PostTexMtx[e]);if(r.IY(e))for(let e=0;e<8;e++)i+=U(t,i,n.u_Lights[e]);r.N_(e)&&(i+=function(e,t,s){return t+=(0,m.up)(e,t,s.A,s.B,s.C,s.AdjCenter),t+=(0,m.up)(e,t,s.AdjTable[0],s.AdjTable[1],s.AdjTable[2],s.AdjTable[3]),t+=(0,m.up)(e,t,s.AdjTable[4],s.AdjTable[5],s.AdjTable[6],s.AdjTable[7]),t+=(0,m.up)(e,t,s.AdjTable[8],s.AdjTable[9]),t+=(0,m.pf)(e,t,s.Color),20}(t,i,n.u_FogBlock)),r.HG(e)&&(i+=(0,m.up)(t,i,n.u_DynamicAlphaRefA,n.u_DynamicAlphaRefB)),(0,o.vA)(t.length>=i)}function G(e,t,s,i,a=null){if(n.C(e.u_Projection,t),null!==a)e.u_SceneTextureLODBias=a;else{const t=Math.log2(Math.min(s/r.xT,i/r.E4));e.u_SceneTextureLODBias=t}}class K{constructor(e,t=null,s=e.name){this.mipChain=e,this.extraInfo=t,this.name=s,this.surfaces=[]}activate(){(0,o.vA)(0===this.surfaces.length);const e=[];for(let t=0;t<this.mipChain.mipLevels.length;t++){const s=this.mipChain.mipLevels[t],n=document.createElement("canvas");n.width=s.width,n.height=s.height,n.title=s.name,this.surfaces.push(n),e.push(a.eH(s).then(e=>{P(n,h.A.fromView(e.pixels))}))}return Promise.all(e)}}function $(e,t){const s=t.mipLevels[0],n=e.createTexture((0,u.xm)(u.$Y.U8_RGBA_NORM,s.width,s.height,t.mipLevels.length));e.setResourceName(n,t.name);const i=[];for(let s=0;s<t.mipLevels.length;s++){const r=s,o=t.mipLevels[s];i.push(a.eH(o).then(t=>{e.uploadTextureData(n,r,[t.pixels])}))}const r=new Map;r.set("Format",a.r0(s.format,s.paletteFormat));const o=new K(t,r);return{gfxTexture:n,viewerTexture:o}}function W(e){switch(e){case i.yf.CLAMP:return u.Vf.Clamp;case i.yf.MIRROR:return u.Vf.Mirror;case i.yf.REPEAT:return u.Vf.Repeat}}function H(e){switch(e){case i.Ck.LINEAR:return[u.gD.Bilinear,u.P.NoMip];case i.Ck.NEAR:return[u.gD.Point,u.P.NoMip];case i.Ck.LIN_MIP_LIN:return[u.gD.Bilinear,u.P.Linear];case i.Ck.NEAR_MIP_LIN:return[u.gD.Point,u.P.Linear];case i.Ck.LIN_MIP_NEAR:return[u.gD.Bilinear,u.P.Nearest];case i.Ck.NEAR_MIP_NEAR:return[u.gD.Point,u.P.Nearest]}}function Y(e){return e.lightingEnabled&&0!==e.litMask}function Z(e){void 0===e.hasPostTexMtxBlock&&(e.hasPostTexMtxBlock=function(e){for(let t=0;t<e.texGens.length;t++)if(e.texGens[t].postMatrix!==i.eV.PTIDENTITY)return!0;return!1}(e)),void 0===e.hasLightsBlock&&(e.hasLightsBlock=function(e){if(void 0!==e.lightChannels[0]){if(Y(e.lightChannels[0].colorChannel))return!0;if(Y(e.lightChannels[0].alphaChannel))return!0}if(void 0!==e.lightChannels[1]){if(Y(e.lightChannels[1].colorChannel))return!0;if(Y(e.lightChannels[1].alphaChannel))return!0}return!1}(e)),void 0===e.hasFogBlock&&(e.hasFogBlock=function(e){return e.ropInfo.fogType!==i.Du.NONE}(e))}function z(e){switch(e){case i.dn.ZERO:return u.MT.Zero;case i.dn.ONE:return u.MT.One;case i.dn.SRCALPHA:return u.MT.SrcAlpha;case i.dn.INVSRCALPHA:return u.MT.OneMinusSrcAlpha;case i.dn.DSTALPHA:return u.MT.DstAlpha;case i.dn.INVDSTALPHA:return u.MT.OneMinusDstAlpha;default:throw new Error("whoops")}}class j{constructor(e,t){this.material=e,this.materialHacks={},this.gfxProgram=null,t&&Object.assign(this.materialHacks,t),this.materialInvalidated()}autoOptimizeMaterial(){Z(this.material),this.materialInvalidated()}materialInvalidated(){this.materialParamsBufferSize=r.S4(this.material),this.drawParamsBufferSize=r.zj(this.material),this.createProgram(),this.megaStateFlags=function(e){const t={};t.cullMode=function(e){switch(e){case i.Ac.ALL:return u.js.FrontAndBack;case i.Ac.FRONT:return u.js.Front;case i.Ac.BACK:return u.js.Back;case i.Ac.NONE:return u.js.None}}(e.cullMode),t.depthWrite=e.ropInfo.depthWrite,t.depthCompare=e.ropInfo.depthTest?(0,M.z8)(function(e){switch(e){case i.oH.NEVER:return u.Ar.Never;case i.oH.LESS:return u.Ar.Less;case i.oH.EQUAL:return u.Ar.Equal;case i.oH.LEQUAL:return u.Ar.LessEqual;case i.oH.GREATER:return u.Ar.Greater;case i.oH.NEQUAL:return u.Ar.NotEqual;case i.oH.GEQUAL:return u.Ar.GreaterEqual;case i.oH.ALWAYS:return u.Ar.Always}}(e.ropInfo.depthFunc)):u.Ar.Always,t.frontFace=u.$Z.CW;const s={};return e.ropInfo.blendMode===i.Nx.NONE?(s.blendMode=u.Id.Add,s.blendSrcFactor=u.MT.One,s.blendDstFactor=u.MT.Zero):e.ropInfo.blendMode===i.Nx.BLEND?(s.blendMode=u.Id.Add,s.blendSrcFactor=function(e){switch(e){case i.dn.SRCCLR:return u.MT.Dst;case i.dn.INVSRCCLR:return u.MT.OneMinusDst;default:return z(e)}}(e.ropInfo.blendSrcFactor),s.blendDstFactor=function(e){switch(e){case i.dn.SRCCLR:return u.MT.Src;case i.dn.INVSRCCLR:return u.MT.OneMinusSrc;default:return z(e)}}(e.ropInfo.blendDstFactor)):e.ropInfo.blendMode===i.Nx.SUBTRACT?(s.blendMode=u.Id.ReverseSubtract,s.blendSrcFactor=u.MT.One,s.blendDstFactor=u.MT.One):e.ropInfo.blendMode===i.Nx.LOGIC&&(s.blendMode=u.Id.Add,s.blendSrcFactor=u.MT.One,s.blendDstFactor=u.MT.Zero,console.warn("Unimplemented LOGIC blend mode")),s.channelWriteMask=u.Mk.None,e.ropInfo.colorUpdate&&(s.channelWriteMask|=u.Mk.RGB),e.ropInfo.alphaUpdate&&(s.channelWriteMask|=u.Mk.Alpha),(0,b.bd)(t,s),t}(this.material)}cacheProgram(e){null===this.gfxProgram&&(this.gfxProgram=e.createProgram(this.program),this.programKey=this.gfxProgram.ResourceUniqueId)}createProgram(){this.program=new r.vn(this.material,this.materialHacks),this.gfxProgram=null}setMaterialHacks(e){Object.assign(this.materialHacks,e),this.createProgram()}fillMaterialParamsData(e,t,s){const n=e.getTemplateRenderInst().getUniformBuffer().mapBufferF32();V(this.material,n,t,s)}allocateMaterialParamsBlock(e){return e.getTemplateRenderInst().getUniformBuffer().allocateChunk(this.materialParamsBufferSize)}allocateMaterialParamsDataOnInst(e,t){const s=e.allocateUniformBuffer(r.vn.ub_MaterialParams,this.materialParamsBufferSize),n=e.mapUniformBufferF32(r.vn.ub_MaterialParams);V(this.material,n,s,t)}allocateDrawParamsDataOnInst(e,t){const s=e.allocateUniformBuffer(r.vn.ub_DrawParams,this.drawParamsBufferSize),n=e.mapUniformBufferF32(r.vn.ub_DrawParams);!function(e,t,s,n){let i=s;if(r.fE(e))for(let e=0;e<10;e++)i+=(0,m.s2)(t,i,n.u_PosMtx[e]);else i+=(0,m.s2)(t,i,n.u_PosMtx[0]);(0,o.vA)(t.length>=i)}(this.material,n,s,t)}setOnRenderInst(e,t){this.cacheProgram(e),t.setMegaStateFlags(this.megaStateFlags),t.setGfxProgram(this.gfxProgram),(0,f.bx)(t.sortKey,this.programKey)}}function q(e,t){const s=[];for(let e=0;e<l.fg.COUNT;e++){const n=r.sX(e),i=t.singleVertexInputLayouts.find(t=>t.attrInput===e);if(void 0!==i){const e=i.bufferOffset,t=i.bufferIndex;s.push({location:n,format:i.format,bufferIndex:t,bufferByteOffset:e})}}const n=[];for(let e=0;e<t.vertexBufferStrides.length;e++)n.push({byteStride:t.vertexBufferStrides[e],frequency:u.er.PerVertex});const i=t.indexFormat;return e.createInputLayout({vertexAttributeDescriptors:s,vertexBufferDescriptors:n,indexBufferFormat:i})}const Q=[{numUniformBuffers:3,numSamplers:8}],J=new D;function ee(e,t,s=null,n=J){G(n,t.camera.projectionMatrix,t.backbufferWidth,t.backbufferHeight,s);let i=e.getUniformBufferOffset(r.vn.ub_SceneParams);F(e.mapUniformBufferF32(r.vn.ub_SceneParams),i,J)}class te extends R{pushTemplateRenderInst(){const e=super.pushTemplateRenderInst();return e.setBindingLayouts(Q),e.allocateUniformBuffer(r.vn.ub_SceneParams,O),e}}},4107(e,t,s){"use strict";s.d(t,{HY:()=>l,eH:()=>u,r0:()=>c});var n=s(2003),i=s(5974),r=s(1413);const a={[n.zL.I4]:{blockWidth:8,blockHeight:8,bytesPerPixelShift:1},[n.zL.I8]:{blockWidth:8,blockHeight:4,bytesPerPixelShift:0},[n.zL.IA4]:{blockWidth:8,blockHeight:4,bytesPerPixelShift:0},[n.zL.IA8]:{blockWidth:4,blockHeight:4,bytesPerPixelShift:-1},[n.zL.RGB565]:{blockWidth:4,blockHeight:4,bytesPerPixelShift:-1},[n.zL.RGB5A3]:{blockWidth:4,blockHeight:4,bytesPerPixelShift:-1},[n.zL.RGBA8]:{blockWidth:4,blockHeight:4,bytesPerPixelShift:-2},[n.zL.C4]:{blockWidth:8,blockHeight:8,bytesPerPixelShift:1},[n.zL.C8]:{blockWidth:8,blockHeight:4,bytesPerPixelShift:0},[n.zL.C14X2]:{blockWidth:4,blockHeight:4,bytesPerPixelShift:-1},[n.zL.CMPR]:{blockWidth:8,blockHeight:8,bytesPerPixelShift:1}};function o(e,t,s){const n=a[e],r=(0,i.MM)(t,n.blockWidth)*(0,i.MM)(s,n.blockHeight);return n.bytesPerPixelShift>0?r>>>n.bytesPerPixelShift:r<<-n.bytesPerPixelShift}function l(e,t=e.mipCount){const s=[],n=e.name;let i=0,r=0;const a=e.format;let l=e.width,h=e.height;for(;r<t;){const t=null!==e.data?e.data.subarray(i):null,n=e.paletteFormat,c=e.paletteData,u=o(a,l,h);if(t&&u>t.byteLength)break;s.push({name:`${e.name} mip level ${r}`,format:a,width:l,height:h,data:t,paletteFormat:n,paletteData:c,mipCount:1}),r++,i+=Math.max(u,32),l/=2,h/=2}return{name:n,mipLevels:s,fullTextureSize:i}}function h(e){switch((0,i.Z1)(e)){case n.Fc.IA8:return"IA8";case n.Fc.RGB565:return"RGB565";case n.Fc.RGB5A3:return"RGB5A3";default:return"invalid"}}function c(e,t){switch(e){case n.zL.I4:return"I4";case n.zL.I8:return"I8";case n.zL.IA4:return"IA4";case n.zL.IA8:return"IA8";case n.zL.RGB565:return"RGB565";case n.zL.RGB5A3:return"RGB5A3";case n.zL.RGBA8:return"RGBA8";case n.zL.CMPR:return"CMPR";case n.zL.C4:return`C4 (${h(t)})`;case n.zL.C8:return`C8 (${h(t)})`;case n.zL.C14X2:return`C14X2 (${h(t)})`;default:return"invalid"}}async function u(e){return null===e.data?function(e){const t=new Uint8Array(e.width*e.height*4);return t.fill(255),{pixels:t}}(e):await async function(e){const t=e.format===n.zL.I4?r.T.PixelFormat.I4:e.format===n.zL.I8?r.T.PixelFormat.I8:e.format===n.zL.IA4?r.T.PixelFormat.IA4:e.format===n.zL.IA8?r.T.PixelFormat.IA8:e.format===n.zL.RGB565?r.T.PixelFormat.RGB565:e.format===n.zL.RGB5A3?r.T.PixelFormat.RGB5A3:e.format===n.zL.RGBA8?r.T.PixelFormat.RGBA8:e.format===n.zL.CMPR?r.T.PixelFormat.CMPR:e.format===n.zL.C4?r.T.PixelFormat.C4:e.format===n.zL.C8?r.T.PixelFormat.C8:e.format===n.zL.C14X2?r.T.PixelFormat.C14X2:void 0,s=e.paletteFormat===n.Fc.IA8?r.T.PaletteFormat.IA8:e.paletteFormat===n.Fc.RGB565?r.T.PaletteFormat.RGB565:e.paletteFormat===n.Fc.RGB5A3?r.T.PaletteFormat.RGB5A3:void 0,i=e.data.createTypedArray(Uint8Array,0,o(e.format,e.width,e.height)),a=e.paletteData?e.paletteData.createTypedArray(Uint8Array):void 0;return{pixels:r.T.decode_texture(t,s,i,a,e.width,e.height)}}(e)}},3996(e,t,s){"use strict";var n=s(381);const i={pathBase:"dinosaurplanet",subdirs:{}};function r(e,t,n,i){return{id:t,name:n,createScene:async(r,a)=>new((await Promise.resolve().then(s.bind(s,3292))).DPMapSceneDesc)(e,t,n,i).createScene(r,a)}}const a={id:"dp",name:"Dinosaur Planet",sceneDescs:["Model Viewer",(o="dp_models",l="DP: Model Exhibit",h=i,{id:o,name:l,createScene:async(e,t)=>new((await Promise.resolve().then(s.bind(s,3673))).DPModelExhibitSceneDesc)(o,l,h).createScene(e,t)}),"Full World Maps (experimental)",function(e,t,n){return{id:e,name:t,createScene:async(i,r)=>new((await Promise.resolve().then(s.bind(s,3292))).DPFullWorldSceneDesc)(e,t,n).createScene(i,r)}}("dp_full_world","DP: Full World",i),"Dinosaur Planet Maps",r(2,"dp02_dragrock_top","DP: Dragon Rock - Top",i),r(3,"dp03_krazoa_palace","DP: Krazoa Palace",i),r(4,"dp04_volcano_fp","DP: Volcano Force Point",i),r(5,"dp05_rolling_demo","DP: Rolling Demo",i),r(6,"dp06_discovery_falls","DP: Discovery Falls",i),r(7,"dp07_swaphol","DP: SwapStone Hollow",i),r(8,"dp08_swaphol2","DP: SwapStone Hollow 2",i),r(9,"dp09_golden_plains","DP: Golden Plains",i),r(10,"dp0a_northern_wastes","DP: Northern Wastes",i),r(11,"dp0b_warlock_mountain","DP: Warlock Mountain",i),r(12,"dp0c_crfort","DP: CloudRunner Fortress",i),r(13,"dp0d_walled_city","DP: Walled City",i),r(14,"dp0e_swapstone_circle","DP: SwapStone Circle",i),r(15,"dp0f_cr_treasure","DP: CloudRunner - Treasure",i),r(16,"dp10_cr_dungeon","DP: CloudRunner - Dungeon",i),r(17,"dp11_cr_traprooms","DP: CloudRunner - TrapRooms",i),r(18,"dp12_mmpass","DP: Moon Mountain Pass",i),r(19,"dp13_dim1","DP: DarkIce Mines Level 1",i),r(20,"dp14_krazoa_shrine_tpl","DP: Krazoa Shrine (Unused Template)",i),r(21,"dp15_dfp_bottom","DP: Desert Force Point Bottom",i),r(22,"dp16_krazchamber","DP: krazchamber (Alt Objects)",i),r(23,"dp17_newicemount1","DP: NewIceMt1",i),r(24,"dp18_newicemount2","DP: NewIceMt2",i),r(25,"dp19_newicemount3","DP: NewIceMt3",i),r(26,"dp1a_animtest","DP: Animtest",i),r(27,"dp1b_dim2","DP: DarkIce Mines Level 2",i),r(28,"dp1c_boss_galdon_dim3","DP: BOSS Galdon DIM3",i),r(29,"dp1d_capeclaw","DP: CapeClaw",i),r(30,"dp1e_inside_galleon","DP: InsideGalleon",i),r(31,"dp1f_dfshrine","DP: DFShrine",i),r(32,"dp20_mmshrine","DP: MMShrine",i),r(33,"dp21_ecshrine","DP: ECShrine",i),r(34,"dp22_gpshrine","DP: GPShrine",i),r(35,"dp23_diamond_bay","DP: Diamond Bay",i),r(36,"dp24_earthwalker_temple","DP: EarthWalker Temple (Unused)",i),r(37,"dp25_willow_grove","DP: Willow Grove",i),r(38,"dp26_blackwater_canyon","DP: BlackWater Canyon",i),r(39,"dp27_dbshrine","DP: DBShrine",i),r(40,"dp28_nwshrine","DP: NWShrine",i),r(41,"dp29_ccshrine","DP: CCShrine",i),r(42,"dp2a_wgshrine","DP: WGShrine",i),r(43,"dp2b_cr_race","DP: CloudRunner - Race",i),r(44,"dp2c_boss_drakor","DP: BOSS Drakor",i),r(45,"dp2d_wminsert","DP: WMinsert (Unused?)",i),r(46,"dp2e_dim_caves","DP: DarkIce Mines - Caves",i),r(47,"dp2f_dim_lava","DP: DarkIce Mines - Lava",i),r(48,"dp30_boss_trex","DP: BOSS TRex",i),r(49,"dp31_mikeslava","DP: MikesLava (Test)",i),r(50,"dp32_dfp_top","DP: Desert Force Point Top",i),r(51,"dp33_swap_store","DP: Swap Store",i),r(52,"dp34_dragrock_bottom","DP: Dragon Rock - Bottom",i),r(53,"dp35_boss_kamerian","DP: BOSS Kamerian Dragon",i),r(54,"dp36_magic_cave_small","DP: Magic Cave - Small",i)]};var o,l,h,c=s(3209),u=s(8880),d=s(7639),m=s(5974),p=s(1413),f=s(305),g=s(8834);function T(e,t){return e.startsWith("https://")||e.startsWith("http://")?e:((0,m.vA)(!e.startsWith("data/")),`${function(e){return e?"/data":"/SFA-Model-Viewer"}(t)}/${e}`)}class x{constructor(e,t,s){if(this.cache=e,this.url=t,this.options=s,this.progress=0,this.ondone=null,this.onprogress=null,this.started=!1,this.response=null,this.abortController=new AbortController,this.retriesLeft=2,this.request=new Request(this.url,{signal:this.abortController.signal}),void 0!==this.options.rangeStart&&void 0!==this.options.rangeSize){const e=this.options.rangeStart,t=e+this.options.rangeSize-1;this.request.headers.set("range",`bytes=${e}-${t}`),this.cache=null}this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}inFlight(){return this.started}isConsidered404Error(){const e=this.response;return null!==e&&404===e.status}resolveError(){if(this.options.allow404&&this.isConsidered404Error()||this.abortController.signal.aborted){const e=new f.A(new ArrayBuffer(0));return e.name=this.url,this.resolve(e),this.done(),!0}const e=this.response;let t=999;return!(null!==e&&(t=e.status,200===t||206===t)||(this.retriesLeft>0?(this.retriesLeft--,this.response=null,this.start(),0):(console.error(`DataFetcherRequest: Received non-success status code ${t} when fetching file ${this.url}.`),this.reject(null),this.done(),0)))}resolveArrayBuffer(e){const t=new f.A(e);t.name=this.url,this.resolve(t),this.done()}async start(){if(this.started=!0,null!==this.cache){const e=await this.cache.match(this.request);if(void 0!==e){const t=await e.arrayBuffer();return void this.resolveArrayBuffer(t)}}(0,m.vA)(null===this.response);try{this.response=await fetch(this.request)}catch(e){}if(this.resolveError())return;const e=this.response;206===e.status&&(this.cache=null);const t=e.clone();let s=e.headers.get("content-length");null===s&&(s="1");const n=parseInt(s,10);let i=null;const r=e.body.getReader();let a=0;for(;;)try{const{done:e,value:t}=await r.read();if(e)break;i=0===a?t.buffer:null,a+=t.byteLength,this.progress=Math.min(a/n,1),null!==this.onprogress&&this.onprogress()}catch(e){break}this.resolveError()||(null===i&&(i=await t.clone().arrayBuffer()),this.resolveArrayBuffer(i),null!==this.cache&&await this.cache.put(this.request,t),this.response=null)}done(){this.progress=1,null!==this.onprogress&&this.onprogress(),null!==this.ondone&&this.ondone()}destroy(){this.response=null,this.onprogress=null,this.ondone=null}abort(){this.abortController.abort(),void 0!==this.options.abortedCallback&&this.options.abortedCallback(),this.destroy()}}class v{constructor(e){this.mount=e}async getFileHandle(e){let t=this.mount;const s=e.split("/");for(;s.length>1;)try{t=await t.getDirectoryHandle(s.shift())}catch(e){return null}try{return await t.getFileHandle(s.shift())}catch(e){return null}}async fetchData(e,t){const s=await this.getFileHandle(e);if(null===s)return null;let n=await s.getFile();void 0!==t.rangeStart&&void 0!==t.rangeSize&&(n=n.slice(t.rangeStart,t.rangeSize));const i=await n.arrayBuffer(),r=new f.A(i);return r.name=e,r}}class C{constructor(e=null){this.progressMeter=e,this.requests=[],this.doneRequestCount=0,this.maxParallelRequests=10,this.aborted=!1,this.useDevelopmentStorage=null,this.cache=null,this.mounts=[],this.debug=g.DS,this.debugDisplay=null}async init(){if(g.DS){const e=T("",!0);try{await this.fetchURL(e,{}),this.useDevelopmentStorage=!0}catch(e){this.useDevelopmentStorage=!1}}else this.useDevelopmentStorage=!1}async mount(){let e;try{e=await window.showDirectoryPicker()}catch(e){return}const t=new v(e);this.mounts.push(t)}manageCache(){}abort(){this.aborted=!0;for(let e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[]}reset(){this.aborted=!1,this.doneRequestCount=0}waitForLoad(){return Promise.all(this.requests.map(e=>e.promise))}debugCalcProgress(){if(!this.debug)return void(null!==this.debugDisplay&&this.debugDisplay.parentElement.removeChild(this.debugDisplay));null==this.debugDisplay&&(this.debugDisplay=document.createElement("div"),this.debugDisplay.style.position="absolute",this.debugDisplay.style.bottom="16px",this.debugDisplay.style.right="16px",this.debugDisplay.style.color="white",this.debugDisplay.style.textShadow="1px 1px 2px black",this.debugDisplay.style.font="12pt monospace",this.debugDisplay.style.whiteSpace="pre",this.debugDisplay.style.textAlign="right",window.main.ui.elem.appendChild(this.debugDisplay));let e="";for(let t=0;t<this.requests.length;t++)e+=`${this.requests[t].url} ${100*this.requests[t].progress|0}%\n`;this.debugDisplay.textContent=e}calcProgress(){if(0===this.requests.length)return 1;let e=0;for(let t=0;t<this.requests.length;t++)e+=this.requests[t].progress;return e+=this.doneRequestCount,e/(this.requests.length+this.doneRequestCount)}setProgress(){null!==this.progressMeter&&this.progressMeter.setProgress(this.calcProgress())}pump(){for(let e=0;e<Math.min(this.requests.length,this.maxParallelRequests);e++)this.requests[e].inFlight()||this.requests[e].start()}fetchURL(e,t={}){if(this.aborted)throw new Error("Tried to fetch new data while aborted; should not happen");const s=new x(this.cache,e,t);return this.requests.push(s),s.ondone=()=>{this.doneRequestCount++,s.destroy(),this.requests.splice(this.requests.indexOf(s),1),this.pump(),this.manageCache(),this.debugCalcProgress()},s.onprogress=()=>{this.debugCalcProgress(),this.setProgress()},this.pump(),s.promise}getDataURLForPath(e){return T(e,(0,m.Z1)(this.useDevelopmentStorage))}async fetchData(e,t={}){for(let s=0;s<this.mounts.length;s++){const n=this.mounts[s],i=await n.fetchData(e,t);if(null!==i)return i}const s=this.getDataURLForPath(e);return await this.fetchURL(s,t)}}const b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+=-_,:;~/?[]@!$&()*{}|^";function _(e,t=0,s,n=b){(0,m.vA)(85===n.length);const i={};for(let e=0;e<85;e++)i[n.charAt(e)]=e;const r=s.length,a=4*((r+4)/5|0)-(5-r%5)%5;(0,m.vA)(a<=e.byteLength-t);e:for(let n=0;n<r;){let o=0;const l=n+5;for(;n<l;n++)o=85*o+(n<r?i[s.charAt(n)]:84);for(let s=0;s<4;s++)if(e[t++]=o>>24&255,o<<=8,t>=a)break e}return a}var y=s(7684),S=s(5098),w=s(6253),A=s(353),E=s(393);class R{constructor(e,t){this.object=e,this.lastUsedAge=t}}class I{constructor(){this.objects=new Map,this.currentAge=0}loadNewScene(){this.currentAge++}deleteObjectsOlderThan(e,t){for(const[s,n]of this.objects.entries())n.lastUsedAge<=t&&(n.object.destroy(e),this.objects.delete(s))}pruneOldObjects(e,t){const s=this.currentAge-t;this.deleteObjectsOlderThan(e,s)}setObject(e,t){const s=new R(t,this.currentAge);this.objects.set(e,s)}getObject(e){if(this.objects.has(e)){const t=this.objects.get(e);return t.lastUsedAge=this.currentAge,t.object}return null}async ensureObject(e,t){let s=this.getObject(e);return null===s&&(s=await t(),this.setObject(e,s)),s}}class k{constructor(e){this.swapChain=e,this.xrSession=null,this.onframe=null,this.onsupportedchanged=null,this.onstart=null,this.onend=null,this.isSupported=!1,this._onRequestAnimationFrame=(e,t)=>{const s=t.session,n=t.getViewerPose(this.xrLocalSpace);this.currentFrame=t,n&&(this.views=n.views),null!==this.onframe&&this.onframe(e),s.requestAnimationFrame(this._onRequestAnimationFrame)},this.checkIsSupported()}async checkIsSupported(){const e=window.navigator;if(void 0===e.xr)return;const t=await e.xr.isSessionSupported("immersive-vr");this.isSupported!==t&&(this.isSupported=t,null!==this.onsupportedchanged&&this.onsupportedchanged())}async start(){const e=window.navigator.xr;this.xrSession=await e.requestSession("immersive-vr",{requiredFeatures:[],optionalFeatures:["viewer","local"]}),this.xrSession.onend=()=>{this.sessionEnded()},[this.xrViewerSpace,this.xrLocalSpace]=await Promise.all([this.xrSession.requestReferenceSpace("viewer"),this.xrSession.requestReferenceSpace("local")]);const t=await this.swapChain.createWebXRLayer(this.xrSession);this.xrSession.updateRenderState({baseLayer:t,depthNear:.1,depthFar:5e3}),null!==this.onstart&&this.onstart(),this.xrSession.requestAnimationFrame(this._onRequestAnimationFrame)}sessionEnded(){this.xrSession=null,null!==this.onend&&this.onend()}end(){null!==this.xrSession&&this.xrSession.end()}}const M=["MAP + MODEL VIEWER FOR SFA AND DP",a,c.aL];var P;!function(e){e[e.Load=0]="Load",e[e.LoadDefault=1]="LoadDefault",e[e.Save=2]="Save",e[e.Delete=3]="Delete"}(P||(P={}));class D{constructor(){this.time=0,this.webXRContext=null,this.useRequestPostAnimationFrame=!1,this._timeoutCallback=()=>{this.onupdate(this)},this.requestPostAnimationFrame=()=>{this.time=window.performance.now(),this.useRequestPostAnimationFrame?setTimeout(this._timeoutCallback,0):this.onupdate(this)}}}function B(e,t){for(const s of e)"string"!=typeof s&&(s.hidden=!t.has(s))}window.main=new class{constructor(){this.saveManager=S._h,this.currentSceneGroup=null,this.currentSceneDesc=null,this.loadingSceneDesc=null,this.destroyablePool=[],this.dataShare=new I,this.lastUpdatedURLTimeSeconds=-1,this.postAnimFrameCanvas=new D,this.postAnimFrameWebXR=new D,this.sceneTimeScale=1,this.isEmbedMode=!1,this.isFrameStep=!1,this.pixelSize=1,this.debugJunk=A.CZ,this._onPostAnimFrameUpdate=e=>{this.checkKeyShortcuts(),(0,A._j)();const t=this.viewer.inputManager.isKeyDownEventTriggered("Numpad7")||this.viewer.inputManager.isKeyDownEventTriggered("BracketRight");let s=this.sceneTimeScale;this.ui.isPlaying||(this.isFrameStep?(s/=4,this.isFrameStep=!1):s=0),this.viewer.externalControl||(this.viewer.sceneTimeScale=s,this.viewer.update(e)),t&&this._takeScreenshot(),this.ui.update()},this._onRequestAnimationFrameCanvas=()=>{null!==this.webXRContext.xrSession||this.postAnimFrameCanvas.requestPostAnimationFrame(),window.requestAnimationFrame(this._onRequestAnimationFrameCanvas)},this._saveStateTmp=new Uint8Array(512),this._saveStateView=new DataView(this._saveStateTmp.buffer),this.loadSceneDelta=1,this.init()}setActiveGame(e){this.ui.sceneSelect.showGameLanding(!1);const t={sfa:[c.aL],dp:[a]},s=new Set(t[e]);B(this.groups,s),this.ui.sceneSelect.setForceVisible(!1),this._loadSceneGroups();const n=t[e][0];this.ui.sceneSelect.selectSceneGroup(n),this.ui.sceneSelect.showGameLanding(!1),this.ui.sceneSelect.setExpanded(!0)}showGamePicker(){this.ui.sceneSelect.showGameLanding(!0),B(this.groups,new Set),this._loadSceneGroups(),this.ui.sceneSelect.setExpanded(!0)}async init(){var e,t,s,i;this.isEmbedMode="/embed.html"===window.location.pathname,this.toplevel=document.createElement("div"),document.body.appendChild(this.toplevel),function(){const e=document.createElement("style");e.textContent='\n  :root{\n    /* SFA palette (dimmed gold) */\n    --sfa-gold:#E0B54E;\n    --sfa-purple:#2B2BB8; /* use as the blue outline */\n    --sfa-navy:#0B1124;\n    --sfa-border: rgba(43,43,184,.26);\n    --sfa-accent: var(--sfa-gold);\n    --sfa-accent-8: rgba(224,181,78,.10);\n    --sfa-white:#eef6ff;\n    --radius:16px; --radius-sm:12px;\n  }\n\n  /* Subtle SFA-ish page background */\n  html,body{\n    background:\n      radial-gradient(900px 420px at 10% 8%, rgba(43,43,184,.10), transparent 55%),\n      radial-gradient(900px 420px at 90% 6%, rgba(224,181,78,.08), transparent 58%),\n      var(--sfa-navy);\n  }\n\n  /* ---- universal rounded shell (clips children, fixes top corner seams) ---- */\n  .sfa-shell{\n    border-radius:var(--radius) !important;\n    overflow:hidden !important;\n    background-clip:padding-box !important;\n    isolation:isolate;\n    -webkit-mask-image:-webkit-radial-gradient(white,black);\n    box-shadow:0 18px 48px rgba(0,0,0,.6), inset 0 0 1px rgba(255,255,255,.04);\n  }\n  .sfa-shell > *{ border-radius:0 !important; }\n  .sfa-shell > :first-child{ border-top-left-radius:var(--radius) !important; border-top-right-radius:var(--radius) !important; }\n  .sfa-shell > :last-child{ border-bottom-left-radius:var(--radius) !important; border-bottom-right-radius:var(--radius) !important; }\n\n  /* MAPS header + card */\n  .sfa-title{\n    background:linear-gradient(180deg,var(--sfa-accent),#caa341) !important; /* gold header */\n    color:#1A1258 !important; /* indigo text/icon for contrast */\n    text-transform:uppercase; letter-spacing:.8px; border:0 !important;\n    box-shadow:inset 0 1px 0 rgba(255,255,255,.05);\n  }\n  #Panel .sfa-card{\n    background:rgba(9,22,36,.90);\n    box-shadow:inset 0 0 1px rgba(255,255,255,.03);\n    border:0 !important; backdrop-filter:blur(6px);\n  }\n\n  /* search + random */\n  .sfa-search{\n    border-radius:12px !important;\n    background:linear-gradient(180deg,rgba(8,16,30,.96),rgba(6,12,22,.96));\n    border:1px solid var(--sfa-border);\n    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);\n    color: var(--sfa-white);\n  }\n  .sfa-rand{\n    border-radius:12px !important;\n    background:linear-gradient(180deg,#0b182c,#081421);\n    border:1px solid var(--sfa-border);\n  }\n\n  /* lists */\n  .sfa-list{\n    background:linear-gradient(180deg,rgba(10,20,34,.94),rgba(7,14,26,.94));\n    border:1px solid var(--sfa-border);\n    border-radius:var(--radius) !important;\n    overflow:hidden !important;\n    box-shadow:0 16px 38px rgba(0,0,0,.6), inset 0 0 1px rgba(255,255,255,.03);\n  }\n  .sfa-list .selector:hover{ background:var(--sfa-accent-8); }\n  .sfa-list span.text{ color:#eaf7ff; text-shadow:0 2px 3px rgba(0,0,0,.6); font-weight:800; letter-spacing:.8px; }\n  .sfa-list span.header{\n    color:#cfdbff; text-transform:uppercase; letter-spacing:.9px; padding:8px;\n    border-bottom:1px solid rgba(43,43,184,.20);\n  }\n\n  /* RIGHT PANE SECTION TITLES: gold fill with blue outline */\n  .sfa-right-menu span.header{\n    color: var(--sfa-gold);          /* gold fill */\n    font-weight: 900;\n    letter-spacing: 1px;\n    text-transform: uppercase;\n\n    /* crisp blue edge for Chromium/WebKit */\n    -webkit-text-stroke: 2.2px var(--sfa-purple);\n    paint-order: stroke fill;\n\n    /* fallback blue outline for others */\n    text-shadow:\n      0 1px 0 var(--sfa-purple),  0 -1px 0 var(--sfa-purple),\n      1px 0 0 var(--sfa-purple),  -1px 0 0 var(--sfa-purple),\n      1px 1px 0 var(--sfa-purple), -1px 1px 0 var(--sfa-purple),\n      1px -1px 0 var(--sfa-purple), -1px -1px 0 var(--sfa-purple),\n      0 0 6px rgba(43,43,184,.25);\n  }\n\n  /* ---- left dock / toolbox buttons ---- */\n  .sfa-dock-btn,\n  #LeftBar button, #Toolbox button, #Tools button, #Dock button,\n  #LeftBar .button, #Toolbox .button, #Tools .button, #Dock .button {\n    position: relative;\n    border-radius: 12px !important;\n    overflow: hidden !important;\n    background: linear-gradient(180deg,#112540,#0b182c) !important;\n    border: 1px solid var(--sfa-border) !important;\n    box-shadow: 0 14px 28px rgba(0,0,0,.55), inset 0 0 1px rgba(255,255,255,.03) !important;\n    outline: none !important;\n    display: grid; place-items: center;\n  }\n  .sfa-dock-btn > *, \n  #LeftBar button > *, #Toolbox button > *, #Tools button > *, #Dock button > *,\n  #LeftBar .button > *, #Toolbox .button > *, #Tools .button > *, #Dock .button > * {\n    background: transparent !important;\n    background-image: none !important;\n    border: 0 !important;\n    box-shadow: none !important;\n  }\n  .sfa-dock-btn::after,\n  #LeftBar button::after, #Toolbox button::after, #Tools button::after, #Dock button::after,\n  #LeftBar .button::after, #Toolbox .button::after, #Tools .button::after, #Dock .button::after {\n    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;\n    box-shadow: inset 0 0 0 2px rgba(43,43,184,.20);\n  }\n  .sfa-dock-btn::before,\n  #LeftBar button::before, #Toolbox button::before, #Tools button::before, #Dock button::before,\n  #LeftBar .button::before, #Toolbox .button::before, #Tools .button::before, #Dock .button::before {\n    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;\n    background: radial-gradient(28px 28px at -6px 50%, rgba(224,181,78,.38), transparent 60%);\n  }\n  .sfa-dock-btn:focus,\n  .sfa-dock-btn[aria-pressed="true"],\n  #LeftBar button:focus, #Toolbox button:focus, #Tools button:focus, #Dock button:focus,\n  #LeftBar .button[aria-pressed="true"], #Toolbox .button[aria-pressed="true"],\n  #Tools .button[aria-pressed="true"], #Dock .button[aria-pressed="true"] {\n    box-shadow: 0 16px 32px rgba(0,0,0,.6), inset 0 0 0 2px rgba(224,181,78,.55) !important;\n  }\n    /* Right column item text size only */\n.sfa-right-menu .selector .text,\n.sfa-right-menu span.text{\n  font-size: 0.90em !important;   /* tweak this value */\n  line-height: 1.25em;            /* keeps rows tidy */\n}\n\n  ',document.head.appendChild(e)}(),this.canvas=document.createElement("canvas"),this.canvas.style.imageRendering="pixelated",this.canvas.style.outline="none",this.toplevel.appendChild(this.canvas),window.onresize=this._onResize.bind(this),this._onResize(),await(0,p.g)();const r=await(0,n.R4)(this,this.canvas);if(r!==n.qP.SUCCESS)return void this.toplevel.appendChild((0,n.Xv)(r));this.webXRContext=new k(this.viewer.gfxSwapChain),this.webXRContext.onframe=this.postAnimFrameWebXR.requestPostAnimationFrame,this.postAnimFrameCanvas.onupdate=this._onPostAnimFrameUpdate,this.postAnimFrameWebXR.webXRContext=this.webXRContext,this.postAnimFrameWebXR.useRequestPostAnimationFrame=!1,this.postAnimFrameWebXR.onupdate=this._onPostAnimFrameUpdate,this.toplevel.ondragover=e=>{e.dataTransfer&&e.dataTransfer.types.includes("Files")&&(this.ui.dragHighlight.style.display="block",e.preventDefault())},this.toplevel.ondragleave=e=>{this.ui.dragHighlight.style.display="none",e.preventDefault()},this.viewer.onstatistics=e=>{this.ui.statisticsPanel.addRenderStatistics(e)},this.viewer.oncamerachanged=e=>{this._saveState(e)},this.viewer.inputManager.ondraggingmodechanged=()=>{this.ui.setDraggingMode(this.viewer.inputManager.getDraggingMode())},this._makeUI(),this.dataFetcher=new C(this.ui.sceneSelect),await this.dataFetcher.init(),this.groups=M,B(this.groups,new Set),this._loadSceneGroups(),this.ui.sceneSelect.showGameLanding(!0),this.droppedFileGroup={id:"drops",name:"Dropped Files",sceneDescs:[],hidden:!0},this.groups.push("Other",this.droppedFileGroup),this._loadSceneGroups(),this.ui.sceneSelect.showGameLanding(!0);const a=this.ui.sceneSelect;if(a.elem.classList.add("sfa-shell"),null===(t=null===(e=a.headerContainer)||void 0===e?void 0:e.classList)||void 0===t||t.add("sfa-title"),null===(i=null===(s=a.contents)||void 0===s?void 0:s.classList)||void 0===i||i.add("sfa-card"),a.sceneGroupList.elem.classList.add("sfa-list"),a.sceneDescList.elem.classList.add("sfa-list","sfa-right-menu"),this.ui.sceneSelect.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" height="20" fill="white"><path d="M48 6l8 20 22 2-17 14 6 21-19-12-19 12 6-21-17-14 22-2 8-20z"/></svg>',"MAPS"),window.onhashchange=this._onHashChange.bind(this),null===this.currentSceneDesc&&this._onHashChange(),null===this.currentSceneDesc){const e=this.saveManager.getCurrentSceneDescId();if(null!==e){const t=this.saveManager.getSaveStateSlotKey(e,0),s=this.saveManager.loadState(t);this._loadSceneDescById(e,s)}}null===this.currentSceneDesc&&this.ui.sceneSelect.setExpanded(!0),this._onRequestAnimationFrameCanvas()}_onHashChange(){const e=window.location.hash;e.startsWith("#")&&this._loadState(decodeURIComponent(e.slice(1)))}_exportSaveData(){const e=this.saveManager.export(),t=new Date;(0,E.WN)(`noclip_export_${t.toISOString()}.nclsp`,new Blob([e]))}pickSaveStatesAction(e){return e.isKeyDown("ShiftLeft")?P.Save:e.isKeyDown("AltLeft")?P.Delete:P.Load}checkKeyShortcuts(){const e=this.viewer.inputManager;e.isKeyDownEventTriggered("KeyZ")&&this._toggleUI(),e.isKeyDownEventTriggered("KeyT")&&this.ui.sceneSelect.expandAndFocus();for(let t=1;t<=9;t++)if(e.isKeyDownEventTriggered("Digit"+t)&&this.currentSceneDesc){const s=this._getSaveStateSlotKey(t),n=this.pickSaveStatesAction(e);this.doSaveStatesAction(n,s)}e.isKeyDownEventTriggered("Numpad3")&&this._exportSaveData(),e.isKeyDownEventTriggered("Period")&&this.ui.togglePlayPause(),e.isKeyDown("Comma")&&(this.ui.togglePlayPause(!1),this.isFrameStep=!0),e.isKeyDownEventTriggered("F9")&&this._loadSceneDesc(this.currentSceneGroup,this.currentSceneDesc,this._getSceneSaveState(),!0)}async _onWebXRStateRequested(e){if(this.webXRContext)if(e)try{if(await this.webXRContext.start(),!this.webXRContext.xrSession)return;y.sC(this.viewer.xrCameraController.offset,this.viewer.camera.worldMatrix),this.webXRContext.xrSession.addEventListener("end",()=>{this.ui.toggleWebXRCheckbox(!1)})}catch(e){console.error("Failed to start XR"),this.ui.toggleWebXRCheckbox(!1)}else this.webXRContext.end()}_onResize(){(0,n.H5)(this.canvas,window.innerWidth,window.innerHeight,window.devicePixelRatio/this.pixelSize)}_getSceneSaveState(){let e=0;return this._saveStateView.setUint8(e,0),e++,e+=(0,d.MS)(this._saveStateView,e,this.viewer.camera),null!==this.viewer.scene&&this.viewer.scene.serializeSaveState&&(e=this.viewer.scene.serializeSaveState(this._saveStateTmp.buffer,e)),`ShareData=${function(e,t=e.byteLength,s=b,n=["0","0","0","0","0"]){(0,m.vA)(85===s.length);const i=t,r=3&-i;let a="";for(let t=0;t<i;){const o=Math.min(t+4,i);let l=0,h=24;for(;t<o;t++)l|=e[t]<<h,h-=8;l>>>=0,n.fill("0");for(let e=4;e>=0;e--){const t=s.charAt(l%85);(0,m.vA)(1===t.length),n[e]=t,l=l/85|0}a+=t===i?n.slice(0,5-r).join(""):n.join("")}return a}(this._saveStateTmp,e)}`}_loadSceneSaveStateVersion2(e){const t=_(this._saveStateTmp,0,e);let s=0;return this.viewer.sceneTime=this._saveStateView.getFloat32(s+0,!0),s+=4,s+=(0,d.Bt)(this.viewer.camera,this._saveStateView,s),null!==this.viewer.scene&&this.viewer.scene.deserializeSaveState&&(s=this.viewer.scene.deserializeSaveState(this._saveStateTmp.buffer,s,t)),null!==this.viewer.cameraController&&this.viewer.cameraController.cameraUpdateForced(),!0}_loadSceneSaveStateVersion3(e){const t=_(this._saveStateTmp,0,e);let s=0;const n=this._saveStateView.getUint8(s+0);return(0,m.vA)(0===n),s++,s+=(0,d.Bt)(this.viewer.camera,this._saveStateView,s),null!==this.viewer.scene&&this.viewer.scene.deserializeSaveState&&(s=this.viewer.scene.deserializeSaveState(this._saveStateTmp.buffer,s,t)),null!==this.viewer.cameraController&&this.viewer.cameraController.cameraUpdateForced(),!0}_tryLoadSceneSaveState(e){return e.startsWith("ZNCA8")&&e.endsWith("=")?this._loadSceneSaveStateVersion2(e.slice(5,-1)):e.startsWith("A")?this._loadSceneSaveStateVersion3(e.slice(1)):!!e.startsWith("ShareData=")&&this._loadSceneSaveStateVersion3(e.slice(10))}_loadSceneSaveState(e){return""!==e&&null!==e&&!!this._tryLoadSceneSaveState(e)&&(this._saveStateAndUpdateURL(),!0)}_loadSceneDescById(e,t){const[s,...n]=e.split("/");let i=decodeURIComponent(n.join("/"));const r=this.groups.find(e=>"string"!=typeof e&&e.id===s);if(!r)return;void 0!==r.sceneIdMap&&r.sceneIdMap.has(i)&&(i=r.sceneIdMap.get(i));const a=function(e){return e.sceneDescs.filter(e=>"string"!=typeof e)}(r).find(e=>e.id===i);a&&this._loadSceneDesc(r,a,t)}_loadState(e){let t="",s="";const n=e.indexOf(";");return n>=0?(t=e.slice(0,n),s=e.slice(n+1)):t=e,this._loadSceneDescById(t,s)}_getCurrentSceneDescId(){return null===this.currentSceneGroup||null===this.currentSceneDesc?null:`${this.currentSceneGroup.id}/${this.currentSceneDesc.id}`}_saveState(e=!1){if(null===this.currentSceneGroup||null===this.currentSceneDesc)return;const t=this._getSceneSaveState(),s=this._getCurrentSceneDescId(),n=this.saveManager.getSaveStateSlotKey(s,0);this.saveManager.saveTemporaryState(n,t);const i=`${s};${t}`;this.ui.setSaveState(i);let r=e;if(r||window.performance.now()/1e3-this.lastUpdatedURLTimeSeconds>=2&&(r=!0),r){window.history.replaceState("",document.title,`#${i}`);const e=window.performance.now()/1e3;this.lastUpdatedURLTimeSeconds=e}}_saveStateAndUpdateURL(){this._saveState(!0)}_getSaveStateSlotKey(e){return this.saveManager.getSaveStateSlotKey((0,m.Z1)(this._getCurrentSceneDescId()),e)}_onSceneChanged(e,t){e.onstatechanged=()=>{this._saveStateAndUpdateURL()};let s=[];e.createPanels&&(s=e.createPanels()),this.ui.setScenePanels(s),this.ui.togglePlayPause(!0);const n=this._getCurrentSceneDescId();if(this.saveManager.setCurrentSceneDescId(n),this._saveStateAndUpdateURL(),void 0!==e.createCameraController&&this.viewer.setCameraController(e.createCameraController()),null===this.viewer.cameraController&&this.viewer.setCameraController(new d.X),!this._loadSceneSaveState(t)){const t=this.viewer.camera,s=this.saveManager.getSaveStateSlotKey(n,1);this._loadSceneSaveState(this.saveManager.loadState(s))||(void 0!==e.getDefaultWorldMatrix?e.getDefaultWorldMatrix(t.worldMatrix):y.D_(t.worldMatrix)),y.sC(this.viewer.xrCameraController.offset,t.worldMatrix)}this.ui.sceneChanged()}_onSceneDescSelected(e,t){this._loadSceneDesc(e,t)}doSaveStatesAction(e,t){e===P.Save?this.saveManager.saveState(t,this._getSceneSaveState()):e===P.Delete?this.saveManager.deleteState(t):e===P.Load?this.saveManager.loadState(t)&&this._loadSceneSaveState(this.saveManager.loadState(t)):e===P.LoadDefault&&this._loadSceneSaveState(this.saveManager.loadStateFromLocation(t,S.y7.Defaults))}_loadSceneDesc(e,t,s=null,n=!1){if(this.currentSceneDesc===t&&!n)return void this._loadSceneSaveState(s);const i=this.viewer.gfxDevice;null!==this.dataFetcher&&this.dataFetcher.abort(),this.ui.destroyScene(),this.viewer.scene&&!this.destroyablePool.includes(this.viewer.scene)&&this.destroyablePool.push(this.viewer.scene),this.viewer.setScene(null);for(let e=0;e<this.destroyablePool.length;e++)this.destroyablePool[e].destroy(i);this.destroyablePool.length=0,e.hidden&&(e.hidden=!1),this.currentSceneGroup=e,this.currentSceneDesc=t,this.ui.sceneSelect.setCurrentDesc(this.currentSceneGroup,this.currentSceneDesc),this.ui.sceneSelect.setProgress(0);const r=this.dataShare,a=this.dataFetcher;a.reset();const o=document.createElement("div");this.ui.sceneUIContainer.appendChild(o);const l=this.destroyablePool,h=this.viewer.inputManager;h.reset();const c=this.viewer.viewerRenderInput,u={device:i,dataFetcher:a,dataShare:r,uiContainer:o,destroyablePool:l,inputManager:h,viewerInput:c};this.dataShare.pruneOldObjects(i,this.loadSceneDelta),0===this.loadSceneDelta&&this.viewer.gfxDevice.checkForLeaks(),this.dataShare.loadNewScene(),this.loadingSceneDesc=t;const d=t.createScene(i,u);if(null===d)throw console.error(`Cannot load ${t.id}. Probably an unsupported file extension.`),"whoops";d.then(e=>{this.loadingSceneDesc===t&&(a.setProgress(),this.loadingSceneDesc=null,this.viewer.setScene(e),this._onSceneChanged(e,s))}),document.title=`${t.name} - ${e.name} - noclip`}_loadSceneGroups(){this.ui.sceneSelect.setSceneGroups(this.groups)}_makeUI(){this.ui=new u.UI(this.viewer),this.ui.setEmbedMode(this.isEmbedMode),this.toplevel.appendChild(this.ui.elem),this.ui.sceneSelect.onscenedescselected=this._onSceneDescSelected.bind(this),this.ui.xrSettings.onWebXRStateRequested=this._onWebXRStateRequested.bind(this),this.webXRContext.onsupportedchanged=()=>{this._syncWebXRSettingsVisible()},this._syncWebXRSettingsVisible()}_syncWebXRSettingsVisible(){this.ui.xrSettings.setVisible(this.webXRContext.isSupported)}_toggleUI(e){this.ui.toggleUI(e)}_getSceneDownloadPrefix(){return`${this.currentSceneGroup.id}_${this.currentSceneDesc.id}_${(new Date).toISOString()}`}_takeScreenshot(e=!0){const t=this.viewer.takeScreenshotToCanvas(e),s=`${this._getSceneDownloadPrefix()}.png`;(function(e){return new Promise(t=>e.toBlob(e=>t((0,m.Z1)(e)),"image/png"))})(t).then(e=>(0,E.WN)(s,e))}getStandardClearColor(){return w.Od.clearColor}get scene(){return this.viewer.scene}},window.debug=!1},1413(e,t,s){"use strict";s.d(t,{T:()=>n,g:()=>i});let n=null;async function i(){null===n&&(n=await s.e(885).then(s.bind(s,2885)))}},8880(e,t,s){"use strict";s.d(t,{pW:()=>v,Sc:()=>X,t$:()=>x,QU:()=>A,Zk:()=>V,WY:()=>R,h2:()=>j,Kf:()=>I,VT:()=>S,Ap:()=>z,NH:()=>E,SX:()=>L,oA:()=>Z,UI:()=>pe,MC:()=>b,Y:()=>P});var n=s(381),i=s(5974),r=s(7639),a=s(7459),o=s(8834),l=s(5098),h=s(9009),c=s(5339),u=s(7165),d=s(841),m=s(6004);const p=s.p+"d05b662b807622333186.png",f=s.p+"0d589edf9e71b6967b57.png",g=s.p+"a42fc47a0a079a2980f2.png";var T=s(6253);window.musicState||(window.musicState={muted:!1,audio:null});const x="#ad8d03ff",v="#2B2BB8",C="#0B1124";function b(e){return document.createRange().createContextualFragment(e)}var _;function y(e,t){e.style.fontFamily="fontello",e.textContent=t}!function(e){e.share="",e.resize_full="",e.pause="",e.resize_small="",e.play="",e.fast_backward=""}(_||(_={}));const S='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 26.25" height="20" fill="white"><path d="M8.6953,14.3916 C5.5543,14.3916 3.0003,11.8356 3.0003,8.6956 C3.0003,5.5546 5.5543,2.9996 8.6953,2.9996 C11.8363,2.9996 14.3913,5.5546 14.3913,8.6956 C14.3913,11.8356 11.8363,14.3916 8.6953,14.3916 L8.6953,14.3916 Z M15.8423,13.7216 L15.6073,13.9566 C16.7213,12.4956 17.3913,10.6756 17.3913,8.6956 C17.3913,3.8936 13.4983,-0.0004 8.6953,-0.0004 C3.8933,-0.0004 0.0003,3.8936 0.0003,8.6956 C0.0003,13.4976 3.8933,17.3916 8.6953,17.3916 C10.6753,17.3916 12.4953,16.7216 13.9573,15.6076 L13.7213,15.8426 L18.3343,20.4546 L20.4553,18.3336 L15.8423,13.7216 Z"/></svg>',w='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="16" fill="white"><path d="M50,1.1C23,1.1,1.1,23,1.1,50S23,98.9,50,98.9C77,98.9,98.9,77,98.9,50S77,1.1,50,1.1z M55.3,77.7c0,1.7-1.4,3.1-3.1,3.1  h-7.9c-1.7,0-3.1-1.4-3.1-3.1v-5.1c0-1.7,1.4-3.1,3.1-3.1h7.9c1.7,0,3.1,1.4,3.1,3.1V77.7z M67.8,47.3c-2.1,2.9-4.7,5.2-7.9,6.9  c-1.8,1.2-3,2.4-3.6,3.8c-0.4,0.9-0.7,2.1-0.9,3.5c-0.1,1.1-1.1,1.9-2.2,1.9h-9.7c-1.3,0-2.3-1.1-2.2-2.3c0.2-2.7,0.9-4.8,2-6.4  c1.4-1.9,3.9-4.2,7.5-6.7c1.9-1.2,3.3-2.6,4.4-4.3c1.1-1.7,1.6-3.7,1.6-6c0-2.3-0.6-4.2-1.9-5.6c-1.3-1.4-3-2.1-5.3-2.1  c-1.9,0-3.4,0.6-4.7,1.7c-0.8,0.7-1.3,1.6-1.6,2.8c-0.4,1.4-1.7,2.3-3.2,2.3l-9-0.2c-1.1,0-2-1-1.9-2.1c0.3-4.8,2.2-8.4,5.5-11  c3.8-2.9,8.7-4.4,14.9-4.4c6.6,0,11.8,1.7,15.6,5c3.8,3.3,5.7,7.8,5.7,13.5C70.9,41.2,69.8,44.4,67.8,47.3z"/></svg>',A='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" height="20" fill="white"><g transform="translate(0,-1036.3622)"><path d="m 8,1039.2486 -0.21875,0.125 -4.90625,2.4375 5.125,2.5625 5.125,-2.5625 L 8,1039.2486 z m -3,4.5625 -2.125,0.9688 5.125,2.5625 5.125,-2.5625 -2.09375,-0.9688 -3.03125,1.5 -1,-0.5 -0.90625,-0.4375 L 5,1043.8111 z m 0,3 -2.125,0.9688 5.125,2.5625 5.125,-2.5625 -2.09375,-0.9688 -3.03125,1.5 -1,-0.5 -0.90625,-0.4375 L 5,1046.8111 z"/></g></svg>',E='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="20" fill="white"><path d="M50,93.4C74,93.4,93.4,74,93.4,50C93.4,26,74,6.6,50,6.6C26,6.6,6.6,26,6.6,50C6.6,74,26,93.4,50,93.4z M37.6,22.8  c-0.6,2.4-0.9,5-0.9,7.6c0,18.2,14.7,32.9,32.9,32.9c2.6,0,5.1-0.3,7.6-0.9c-4.7,10.3-15.1,17.4-27.1,17.4  c-16.5,0-29.9-13.4-29.9-29.9C20.3,37.9,27.4,27.5,37.6,22.8z"/></svg>',R='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 110 105" height="20" fill="white"><path d="M95,5v60H65c0-16.6-13.4-30-30-30V5H95z"/><path d="M65,65c0,16.6-13.4,30-30,30C18.4,95,5,81.6,5,65c0-16.6,13.4-30,30-30v30H65z"/></svg>',I='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="20" fill="white"><g><path d="M79.3,83.3h-6.2H24.9h-6.2c-1.7,0-3,1.3-3,3s1.3,3,3,3h60.6c1.7,0,3-1.3,3-3S81,83.3,79.3,83.3z"/><path d="M18.7,14.7h6.2h48.2h6.2c1.7,0,3-1.3,3-3s-1.3-3-3-3H18.7c-1.7,0-3,1.3-3,3S17,14.7,18.7,14.7z"/><path d="M73.1,66c0-0.9-0.4-1.8-1.1-2.4L52.8,48.5L72,33.4c0.7-0.6,1.1-1.4,1.1-2.4V20.7H24.9V31c0,0.9,0.4,1.8,1.1,2.4l19.1,15.1   L26,63.6c-0.7,0.6-1.1,1.4-1.1,2.4v11.3h48.2V66z"/></g></svg>';function k(e,t){for(let s=0;s<t.length;s++)t[s].parentNode!==e&&e.appendChild(t[s]);for(let s=0;s<e.childElementCount;){const n=e.children.item(s);t.includes(n)?s++:e.removeChild(n)}(0,i.vA)(e.childElementCount===t.length);for(let s=0;s<t.length-1;s++)e.children.item(s)!==t[s]&&e.insertBefore(t[s],e.children.item(s))}function M(e,t,s="block"){e.style.display=t?s:"none"}function P(e,t,s=""){t?(e.style.backgroundColor=x,e.style.color="black"):(e.style.backgroundColor=C,e.style.color=s)}function D(e){return`url(data:image/svg+xml,${encodeURI(e)})`}class B{constructor(){this.textarea=document.createElement("input"),this.textarea.style.color="white",this.textarea.style.backgroundColor="transparent",this.textarea.style.font="16px monospace",this.textarea.style.border="none",this.textarea.style.width="100%",this.textarea.style.caretColor="white",this.elem=this.textarea}selectAll(){this.textarea.setSelectionRange(0,this.textarea.value.length),this.textarea.scrollLeft=0}getValue(){return this.textarea.value}setValue(e){this.textarea.value=e}setPlaceholder(e){this.textarea.placeholder=e}}class L{setRange(e,t){throw new Error("Method not implemented.")}setLabel(e){throw new Error("Method not implemented.")}constructor(){this.ontext=null,this.onfocus=null,this.toplevel=document.createElement("div"),this.toplevel.style.position="relative",this.textfield=new B;const e=this.textfield.textarea;e.title="Search Bar",e.style.boxSizing="border-box",e.style.padding="12px",e.style.paddingLeft="32px",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="10px 14px",e.style.lineHeight="20px",e.onkeydown=e=>{"Escape"===e.code&&this.textfield.getValue().length>0&&(e.stopPropagation(),this.clear())},e.oninput=()=>{this.textChanged()},e.onfocus=()=>{null!==this.onfocus&&this.onfocus()},this.toplevel.appendChild(this.textfield.elem),this.clearButton=document.createElement("div"),this.clearButton.textContent="",this.clearButton.title="Clear",this.clearButton.style.color="white",this.clearButton.style.position="absolute",this.clearButton.style.width="24px",this.clearButton.style.height="24px",this.clearButton.style.right="4px",this.clearButton.style.top="12px",this.clearButton.style.bottom="12px",this.clearButton.style.lineHeight="20px",this.clearButton.style.cursor="pointer",this.clearButton.onclick=()=>{this.clear()},this.syncClearButtonVisible(),this.toplevel.appendChild(this.clearButton),this.elem=this.toplevel}syncClearButtonVisible(){this.clearButton.style.display=this.textfield.getValue().length>0?"":"none"}textChanged(){null!==this.ontext&&this.ontext(this.textfield.getValue()),this.syncClearButtonVisible()}clear(){this.textfield.setValue(""),this.textChanged()}setIcon(e){this.textfield.textarea.style.backgroundImage=D(e)}setPlaceholder(e){this.textfield.setPlaceholder(e)}}var O;!function(e){e[e.Selectable=0]="Selectable",e[e.Header=1]="Header"}(O||(O={}));class F{constructor(){this.flairs=[],this.internalFlairs=[],this.isDragging=!1,this.toplevel=document.createElement("div"),this.scrollContainer=document.createElement("div"),this.setHeight("200px"),this.setTextSelectable(!1),this.scrollContainer.style.overflow="auto",this.toplevel.appendChild(this.scrollContainer),this.elem=this.toplevel}setTextSelectable(e){this.scrollContainer.style.userSelect=e?"":"none"}setHeight(e){this.scrollContainer.style.height=e}getOuterForIndex(e){return this.scrollContainer.children.item(e)}focusItem(e){const t=this.getOuterForIndex(e);return!!this.itemIsVisible(t)&&(!!t.querySelector(".selector")&&(t.focus(),!0))}scrollItemIntoView(e){const t=this.getOuterForIndex(e);return!!this.itemIsVisible(t)&&(!!t.querySelector(".selector")&&(t.scrollIntoView(),!0))}setItems(e){for(this.scrollContainer.style.display=e.length>0?"":"none";this.scrollContainer.firstChild;)this.scrollContainer.removeChild(this.scrollContainer.firstChild);let t=!1;for(let s=0;s<e.length;s++){const n=e[s],i=document.createElement("div");if(i.tabIndex=-1,i.style.display="grid",i.style.gridAutoFlow="column",i.style.outline="none",n.type===O.Selectable){i.style.cursor="pointer",i.style.paddingLeft=t?"24px":"";const e=document.createElement("div");e.classList.add("selector"),e.style.display="list-item",e.style.lineHeight="24px",e.style.textShadow="0 0 8px black",i.appendChild(e);const r=document.createElement("span");if(r.classList.add("text"),void 0!==n.html)r.appendChild(n.html);else{if(void 0===n.name)throw"whoops";r.textContent=n.name}e.appendChild(r);const a=s;i.onfocus=()=>{this.itemFocused(a,!this.isDragging)},i.onmousedown=()=>{document.activeElement===i?i.onfocus(null):i.focus(),this.isDragging=!0},i.onmouseup=()=>{this.isDragging=!1},i.onmouseover=e=>{0===e.buttons&&(this.isDragging=!1),this.isDragging&&i.focus()}}else if(n.type===O.Header){const e=document.createElement("span");if(e.classList.add("header"),e.style.fontWeight="bold",e.style.lineHeight="36px",e.style.textShadow="0 0 8px black",e.style.paddingLeft="8px",e.style.verticalAlign="baseline",void 0!==n.html)e.appendChild(n.html);else{if(void 0===n.name)throw"whoops";e.textContent=n.name}i.appendChild(e),t=!0}const r=document.createElement("span");r.classList.add("extra"),r.style.justifySelf="end",i.appendChild(r),void 0!==n.visible&&this._setItemVisible(i,n.visible),this.scrollContainer.appendChild(i)}this.computeHeaderVisibility()}setStrings(e){this.setItems(e.map(e=>({type:O.Selectable,name:e})))}itemIsHeader(e){return!!e.querySelector("span.header")}itemIsVisible(e){return"none"!==e.style.display}computeHeaderVisibility(){const e=this.getNumItems();for(let t=0;t<e;){const s=this.getOuterForIndex(t);if(this.itemIsHeader(s)){let n=t+1,i=!1;for(;n<e;n++){const e=this.getOuterForIndex(n);if(this.itemIsHeader(e))break;if(this.itemIsVisible(e)){i=!0;break}}this._setItemVisible(s,i),t=n}else t++}}_setItemVisible(e,t){e.style.display=t?"grid":"none"}setItemVisible(e,t){const s=this.scrollContainer.children.item(e);this._setItemVisible(s,t)}getNumItems(){return this.scrollContainer.childElementCount}setFlairs(e){this.flairs=e,this.syncInternalFlairs()}setInternalFlairs(e){this.internalFlairs=e,this.syncFlairDisplay()}syncFlairDisplay(){const e=this.internalFlairs;for(let t=0;t<this.getNumItems();t++){const s=this.getOuterForIndex(t),n=s.firstElementChild;if(!n.classList.contains("selector"))continue;const r=e.find(e=>e.index===t),a=void 0!==r&&void 0!==r.background?r.background:"";s.style.background=a;const o=(0,i.Z1)(s.querySelector("span.text")),l=void 0!==r&&void 0!==r.color?r.color:"";o.style.color=l;const h=void 0!==r&&void 0!==r.fontWeight?r.fontWeight:"";o.style.fontWeight=h,void 0!==r&&void 0!==r.bulletColor?(n.style.listStyleType="disc",n.style.listStylePosition="inside",n.style.paddingLeft="4px",n.style.color=r.bulletColor):(n.style.listStyleType="none",n.style.color="");const c=void 0!==r&&r.extraHTML?r.extraHTML:"";(0,i.Z1)(s.querySelector("span.extra")).innerHTML=c}}}function U(e,t){const s=e.findIndex(e=>e.index===t);if(s>=0)return e[s]=Object.assign({},e[s]),e[s];{const s={index:t};return e.push(s),s}}class N extends F{constructor(){super(),this.highlightedIndex=-1,this.setHighlightFlair=!0,this.toplevel.onkeydown=e=>{let t=!1;"ArrowUp"===e.code?t=this.navigate(-1):"ArrowDown"===e.code&&(t=this.navigate(1)),t&&(e.stopPropagation(),e.preventDefault())}}navigate(e){const t=this.getNumItems();let s=this.highlightedIndex;for(s<0||s>=t||!this.itemIsVisible(this.getOuterForIndex(s))?e>0?s=0:e<0&&(s=t-1):s+=e;!(s<0||s>=t||this.focusItem(s));)s+=e;return!0}scrollFocus(){-1!==this.highlightedIndex&&this.scrollItemIntoView(this.highlightedIndex)}setItems(e){this.highlightedIndex=-1,super.setItems(e)}itemFocused(e,t){this.selectItem(e)}selectItem(e){this.setHighlighted(e),this.onselectionchange(e)}setHighlighted(e){this.highlightedIndex!==e&&(this.highlightedIndex=e,this.syncInternalFlairs())}syncInternalFlairs(){const e=[...this.flairs];if(this.setHighlightFlair&&this.highlightedIndex>=0){const t=U(e,this.highlightedIndex);t.background=x,t.fontWeight="bold"}this.setInternalFlairs(e)}}class X{constructor(e="",t=!1){this.checked=!1,this.onchanged=null,this.toplevel=document.createElement("div"),this.toplevel.style.display="grid",this.toplevel.style.gridTemplateColumns="1fr 24px",this.toplevel.style.alignItems="center",this.toplevel.style.cursor="pointer",this.toplevel.onclick=this._toggle.bind(this),this.label=document.createElement("div"),this.label.style.userSelect="none",this.toplevel.appendChild(this.label),this.emblem=document.createElement("div"),this.emblem.style.width="10px",this.emblem.style.height="10px",this.emblem.style.justifySelf="center",this.emblem.style.margin="4px",this.emblem.style.borderRadius="4px",this.emblem.style.border="2px solid white",this.toplevel.appendChild(this.emblem),this.setLabel(e),this.setChecked(t),this.elem=this.toplevel}setChecked(e){this.checked=e,this.checked?(this.emblem.style.backgroundColor=x,this.emblem.style.borderColor="white",this.label.style.fontWeight="bold",this.label.style.color="white"):(this.emblem.style.backgroundColor="transparent",this.emblem.style.borderColor="#aaa",this.label.style.fontWeight="",this.label.style.color="#aaa")}_toggle(){this.setChecked(!this.checked),null!==this.onchanged&&this.onchanged()}setLabel(e){this.label.textContent=e}}class V{constructor(){this.expanded=null,this.manuallyExpanded=!1,this.autoClosed=!1,this.customHeaderBackgroundColor="",this.ignoreAutoCloseTimeout=0,this.toplevel=document.createElement("div"),this.toplevel.style.color="white",this.toplevel.style.font="16px monospace",this.toplevel.style.overflow="hidden",this.toplevel.style.display="grid",this.toplevel.style.gridAutoFlow="column",this.toplevel.style.gap="20px",this.toplevel.style.transition=".25s ease-out",this.toplevel.style.alignItems="start",this.toplevel.style.outline="none",this.toplevel.onkeydown=this.onKeyDown.bind(this),this.toplevel.tabIndex=-1,this.mainPanel=document.createElement("div"),this.mainPanel.style.overflow="hidden",this.mainPanel.style.transition=".25s ease-out",this.mainPanel.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.toplevel.appendChild(this.mainPanel),this.extraRack=document.createElement("div"),this.extraRack.style.gridAutoFlow="column",this.extraRack.style.gap="20px",this.extraRack.style.transition=".15s ease-out .10s",this.toplevel.appendChild(this.extraRack),this.headerContainer=document.createElement("div"),this.mainPanel.appendChild(this.headerContainer),this.header=document.createElement("h1"),this.header.style.lineHeight="28px",this.header.style.width="440px",this.header.style.margin="0",this.header.style.fontSize="100%",this.header.style.cursor="pointer",this.header.style.userSelect="none",this.header.style.display="grid",this.header.style.gridTemplateColumns="28px 1fr",this.header.style.alignItems="center",this.header.style.justifyItems="center",this.header.style.gridAutoFlow="column",this.header.onclick=()=>{this.ignoreAutoCloseTimeout>0?this.ignoreAutoCloseTimeout=0:this.toggleExpanded()},this.headerContainer.appendChild(this.header),this.contents=document.createElement("div"),this.contents.style.width="440px",this.mainPanel.appendChild(this.contents),this.elem=this.toplevel}onKeyDown(e){"Escape"===e.code&&this.expanded&&(e.preventDefault(),e.stopPropagation(),this.setExpanded(!1))}syncSize(){const e=this.expanded;if(this.mainPanel.style.width=e?"440px":"28px",this.expanded){const e=Math.max(this.header.offsetHeight+this.contents.offsetHeight,this.extraRack.offsetHeight);this.toplevel.style.height=`${e}px`,this.extraRack.style.opacity="1",this.extraRack.style.width="auto"}else this.toplevel.style.transition=".25s ease-out",this.toplevel.style.height="28px",this.extraRack.style.opacity="0",this.extraRack.style.width="0"}setVisible(e){this.toplevel.style.display=e?"grid":"none"}setTitle(e,t){this.svgIcon=b(e).querySelector("svg"),this.svgIcon.style.gridColumn="1",this.header.textContent=t,this.header.appendChild(this.svgIcon),this.toplevel.dataset.title=t,this.setExpanded(!1)}syncHeaderStyle(){this.customHeaderBackgroundColor?(this.svgIcon.style.fill="",this.header.style.backgroundColor=this.customHeaderBackgroundColor,this.header.style.color="white"):(this.svgIcon.style.fill=this.expanded?"#1A1258":"",P(this.header,!!this.expanded,x))}syncExpanded(){const e=this.manuallyExpanded&&!this.autoClosed;return this.expanded!==e&&(this.expanded=e,this.syncHeaderStyle(),this.syncSize(),this.expanded||document.body.focus(),!0)}setExpanded(e,t=!0){this.manuallyExpanded=e,this.syncExpanded(),this.expanded&&t&&this.elem.focus()}toggleExpanded(){this.setExpanded(!this.expanded)}setAutoClosed(e){this.autoClosed!==e&&(this.autoClosed=e,this.syncExpanded()&&this.expanded&&(this.ignoreAutoCloseTimeout=window.setTimeout(()=>{this.ignoreAutoCloseTimeout=0},250)))}}function G(e,t){return 0===e.length||e.every(e=>e.test(t))}function K(e){const t=Math.floor(Math.random()*e.length);return(0,i.Z1)(e[t])}class $ extends V{constructor(e){super(),this.viewer=e,this.landingMode=!1,this.sceneGroups=[],this.sceneDescs=[],this.forceVisible=o.DS,this.currentSearchTokens=[],this.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 2 92 92" height="20" fill="white"><path d="M84.3765045,45.2316481 L77.2336539,75.2316205 L77.2336539,75.2316205 C77.1263996,75.6820886 76.7239081,76 76.2608477,76 L17.8061496,76 C17.2538649,76 16.8061496,75.5522847 16.8061496,75 C16.8061496,74.9118841 16.817796,74.8241548 16.8407862,74.739091 L24.7487983,45.4794461 C24.9845522,44.607157 25.7758952,44.0012839 26.6794815,44.0012642 L83.4036764,44.0000276 L83.4036764,44.0000276 C83.9559612,44.0000156 84.4036862,44.4477211 84.4036982,45.0000058 C84.4036999,45.0780163 84.3945733,45.155759 84.3765045,45.2316481 L84.3765045,45.2316481 Z M15,24 L26.8277004,24 L26.8277004,24 C27.0616369,24 27.2881698,24.0820162 27.4678848,24.2317787 L31.799078,27.8411064 L31.799078,27.8411064 C32.697653,28.5899189 33.8303175,29 35,29 L75,29 C75.5522847,29 76,29.4477153 76,30 L76,38 L76,38 C76,38.5522847 75.5522847,39 75,39 L25.3280454,39 L25.3280454,39 C23.0690391,39 21.0906235,40.5146929 20.5012284,42.6954549 L14.7844016,63.8477139 L14.7844016,63.8477139 C14.7267632,64.0609761 14.5071549,64.1871341 14.2938927,64.1294957 C14.1194254,64.0823423 13.9982484,63.9240598 13.9982563,63.7433327 L13.9999561,25 L14,25 C14.0000242,24.4477324 14.4477324,24.0000439 15,24.0000439 L15,24 Z"/></svg>',"Games"),this.gameRow=document.createElement("div"),this.gameRow.style.display="flex",this.gameRow.style.alignItems="center",this.gameRow.style.justifyContent="space-between",this.gameRow.style.gap="12px",this.gameRow.style.padding="10px 12px",this.gameRow.style.background="rgba(0, 0, 0, 1.0)",this.gameRow.style.borderBottom="1px solid rgba(255,255,255,0.06)";const t=document.createElement("div");t.textContent="SELECT GAME",t.style.fontWeight="bold",t.style.letterSpacing="1px",t.style.color="white",t.style.userSelect="none",this.gameMiniIcons=document.createElement("div"),this.gameMiniIcons.style.display="none",this.gameMiniIcons.style.display="none",this.gameMiniIcons.style.flexDirection="row",this.gameMiniIcons.style.gap="10px",this.gameMiniIcons.style.alignItems="center",this.gameMiniIcons.style.justifyContent="end",this.gameMiniIcons.style.pointerEvents="auto";const s=(e,t,s)=>{const n=document.createElement("img");return n.src=e,n.title=t,n.style.height="18px",n.style.width="auto",n.style.cursor="pointer",n.style.opacity="0.85",n.style.userSelect="none",n.draggable=!1,n.onmouseenter=()=>n.style.opacity="1",n.onmouseleave=()=>n.style.opacity="0.85",n.onclick=e=>{var t,n;e.stopPropagation(),null===(n=null===(t=window.main)||void 0===t?void 0:t.setActiveGame)||void 0===n||n.call(t,s)},n};this.gameMiniIcons.appendChild(s(f,"Star Fox Adventures","sfa")),this.gameMiniIcons.appendChild(s(g,"Dinosaur Planet","dp")),this.gameRow.appendChild(t),this.gameRow.appendChild(this.gameMiniIcons),this.contents.prepend(this.gameRow);const n=new X("Disable Music",!1);n.onchanged=()=>{const e=window.musicState;e.muted=n.checked,e.muted&&e.audio&&(e.audio.pause(),e.audio.currentTime=0)},this.contents.prepend(n.elem),this.topBox=document.createElement("div"),this.topBox.style.display="grid",this.topBox.style.gridTemplateColumns="1fr 40px",this.topBox.style.background="rgba(0, 0, 0, 1.0)",this.contents.append(this.topBox),this.randomButton=document.createElement("div"),this.randomButton.title="Random",this.randomButton.style.placeSelf="stretch",this.randomButton.style.color="white",this.randomButton.style.lineHeight="20px",this.randomButton.style.cursor="pointer",this.randomButton.style.backgroundRepeat="no-repeat",this.randomButton.style.backgroundPosition="center center",this.randomButton.style.backgroundImage=D('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="18" height="18" fill="white"><path d="M 12.161286,0.33596185 C 9.1715371,-0.03245869 6.4678746,2.0779729 6.099454,5.0677219 L 0.33596183,51.838714 c -0.36842076,2.989751 1.74201117,5.693411 4.73176007,6.061832 l 46.7709931,5.763492 c 2.98975,0.368421 5.69341,-1.742009 6.061831,-4.73176 L 63.664038,12.161286 C 64.032459,9.171537 61.922029,6.4678748 58.932279,6.0994541 Z M 20.047281,10.438667 a 5.4374807,5.4374806 7.0250241 0 1 4.731761,6.061832 5.4374807,5.4374806 7.0250241 0 1 -6.061833,4.73176 5.4374807,5.4374806 7.0250241 0 1 -4.73176,-6.061832 5.4374807,5.4374806 7.0250241 0 1 6.061832,-4.73176 z m 28.782293,3.546782 a 5.4374807,5.4374806 7.0250241 0 1 4.731295,6.061775 5.4374807,5.4374806 7.0250241 0 1 -6.061367,4.731817 5.4374807,5.4374806 7.0250241 0 1 -4.731761,-6.061832 5.4374807,5.4374806 7.0250241 0 1 6.061833,-4.73176 z M 32.665036,26.603204 a 5.4374807,5.4374806 7.0250241 0 1 4.731295,6.061775 5.4374807,5.4374806 7.0250241 0 1 -6.06131,4.731351 5.4374807,5.4374806 7.0250241 0 1 -4.731817,-6.061366 5.4374807,5.4374806 7.0250241 0 1 6.061832,-4.73176 z M 16.500499,39.220959 a 5.4374807,5.4374806 7.0250241 0 1 4.731761,6.061833 5.4374807,5.4374806 7.0250241 0 1 -6.061776,4.731295 5.4374807,5.4374806 7.0250241 0 1 -4.731817,-6.061367 5.4374807,5.4374806 7.0250241 0 1 6.061832,-4.731761 z m 28.782293,3.546782 a 5.4374807,5.4374806 7.0250241 0 1 4.731295,6.061776 5.4374807,5.4374806 7.0250241 0 1 -6.06131,4.731353 5.4374807,5.4374806 7.0250241 0 1 -4.731818,-6.061368 5.4374807,5.4374806 7.0250241 0 1 6.061833,-4.731761 z"/></svg>'),this.randomButton.onclick=()=>{this.selectRandom()},this.syncRandomButtonVisible(),this.topBox.appendChild(this.randomButton),this.sceneGroupList=new N,this.sceneGroupList.setHeight("400px"),this.contents.appendChild(this.sceneGroupList.elem),this.sceneDescList=new N,this.sceneDescList.setHighlightFlair=!1,this.sceneDescList.elem.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.sceneDescList.elem.style.width="440px",this.sceneDescList.setHeight("472px"),this.gameLanding=document.createElement("div"),this.gameLanding.style.width="440px",this.gameLanding.style.height="472px",this.gameLanding.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.gameLanding.style.display="grid",this.gameLanding.style.alignContent="start",this.gameLanding.style.padding="18px",this.gameLanding.style.gap="16px",this.gameLanding.style.borderRadius="16px",this.gameLanding.style.border="1px solid rgba(43,43,184,.26)",this.gameLanding.style.boxShadow="0 18px 48px rgba(0,0,0,.6), inset 0 0 1px rgba(255,255,255,.04)";const i=document.createElement("div");i.textContent="SELECT GAME",i.style.font="bold 20px monospace",i.style.letterSpacing="2px",i.style.color="white",i.style.userSelect="none",this.gameLanding.appendChild(i);const r=document.createElement("div");r.style.display="grid",r.style.gridTemplateColumns="1fr",r.style.gap="14px",this.gameLanding.appendChild(r);const a=(e,t,s)=>{const n=document.createElement("div");n.title=t,n.style.cursor="pointer",n.style.display="grid",n.style.placeItems="center",n.style.height="160px",n.style.borderRadius="16px",n.style.background="linear-gradient(180deg, rgba(17,37,64,1), rgba(11,24,44,1))",n.style.border="1px solid rgba(43,43,184,.26)",n.style.boxShadow="0 14px 28px rgba(0,0,0,.55), inset 0 0 1px rgba(255,255,255,.05)",n.style.transition="transform 0.12s ease, box-shadow 0.12s ease";const i=document.createElement("img");return i.src=e,i.style.width="220px",i.style.height="auto",i.style.objectFit="contain",i.style.userSelect="none",i.draggable=!1,n.appendChild(i),n.onmouseenter=()=>{n.style.transform="scale(1.03)",n.style.boxShadow="0 18px 40px rgba(0,0,0,.65), inset 0 0 1px rgba(255,255,255,.06)",n.style.borderColor="rgba(224,181,78,.55)"},n.onmouseleave=()=>{n.style.transform="scale(1)",n.style.boxShadow="0 14px 28px rgba(0,0,0,.55), inset 0 0 1px rgba(255,255,255,.05)",n.style.borderColor="rgba(43,43,184,.26)"},n.onclick=e=>{e.stopPropagation(),s()},n};r.appendChild(a(f,"Star Fox Adventures",()=>{var e,t;return null===(t=null===(e=window.main)||void 0===e?void 0:e.setActiveGame)||void 0===t?void 0:t.call(e,"sfa")})),r.appendChild(a(g,"Dinosaur Planet",()=>{var e,t;return null===(t=null===(e=window.main)||void 0===e?void 0:e.setActiveGame)||void 0===t?void 0:t.call(e,"dp")})),this.extraRack.appendChild(this.gameLanding),this.extraRack.appendChild(this.sceneDescList.elem),this.showGameLanding(!0),this.sceneGroupList.onselectionchange=e=>{this.selectSceneGroupIndex(e)},this.sceneDescList.onselectionchange=e=>{this.selectSceneDescIndex(e)}}onKeyDown(e){"ArrowUp"!==e.code&&"ArrowDown"!==e.code||this.sceneGroupList.elem.onkeydown(e),e.defaultPrevented||super.onKeyDown(e)}showGameLanding(e){this.gameLanding.style.display=e?"grid":"none",this.sceneDescList.elem.style.display=e?"none":"block",this.topBox.style.display=e?"none":"grid",this.sceneGroupList.elem.style.display=e?"none":"block",this.gameMiniIcons.style.display=e?"none":"flex"}expandAndFocus(){this.setExpanded(!0),this.setAutoClosed(!1),this.elem.focus()}_setSearchString(e){this.currentSearchTokens=e.split(/\s+/).filter(e=>e.length).map(e=>{return new RegExp(`(\\b${t=e,t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"i");var t}),this.syncVisibility()}syncRandomButtonVisible(){}setForceVisible(e){this.forceVisible=e,this.syncVisibility()}syncVisibility(){const e=this.currentSearchTokens;let t=!1;function s(s){return"string"==typeof s?(t=G(e,s),!1):!!t||G(e,s.name)}let n=!1,i=!1;for(let r=0;r<this.sceneGroups.length;r++){const a=this.sceneGroups[r];if("string"==typeof a)n=G(e,a);else{let o=!1,l=!1;const h=!!a.hidden&&!this.forceVisible;l=a.sceneDescs.length<=0||h,l||(!o==n&&(o=!0),!o&&(G(e,a.name)||a.altName&&G(e,a.altName))&&(o=!0),a===this.selectedSceneGroup&&(i=o),o||(t=!1,o=a.sceneDescs.some(e=>s(e)))),this.sceneGroupList.setItemVisible(r,o)}}t=!1;for(let e=0;e<this.sceneDescs.length;e++){let t;!t&&i&&(t=!0),t||(t=s(this.sceneDescs[e])),this.sceneDescList.setItemVisible(e,t)}this.sceneGroupList.computeHeaderVisibility(),this.sceneDescList.computeHeaderVisibility()}setCurrentDesc(e,t){this.selectedSceneGroup=e,this.currentSceneGroup=e,this.currentSceneDesc=t,this.syncSceneDescs(),this.sceneGroupList.setHighlighted(this.sceneGroups.indexOf(this.currentSceneGroup)),this.sceneDescList.setHighlighted(this.sceneDescs.indexOf(this.currentSceneDesc))}setSceneGroups(e){this.sceneGroups=e,this.sceneGroupList.setItems(e.map(e=>"string"==typeof e?{type:O.Header,name:e}:{type:O.Selectable,name:e.name})),this.syncSceneDescs()}setProgress(e){this.loadProgress=e,this.syncFlairs(),this.syncHeaderStyle()}selectSceneDesc(e){var t,s;const n=null===(t=window.main)||void 0===t?void 0:t.ui;null===(s=null==n?void 0:n.forcePanelsMouseOutState)||void 0===s||s.call(n),this.onscenedescselected(this.selectedSceneGroup,e)}selectSceneDescIndex(e){this.selectSceneDesc(this.sceneDescs[e])}selectRandom(){const e=this.sceneGroups.filter(e=>"string"!=typeof e&&!e.hidden&&e.sceneDescs.length>0);this.selectSceneGroup(K(e));const t=this.sceneDescs.filter(e=>"string"!=typeof e);this.selectSceneDesc(K(t)),this.sceneGroupList.scrollFocus(),this.sceneDescList.scrollFocus()}getLoadingGradient(e){const t=`${Math.round(100*this.loadProgress)}%`;return`linear-gradient(to right, ${x} ${t}, ${e} ${t})`}syncHeaderStyle(){super.syncHeaderStyle(),P(this.header,!!this.expanded),this.header.style.backgroundColor="transparent",this.expanded?this.headerContainer.style.background=x:this.headerContainer.style.background=this.getLoadingGradient(C)}syncFlairs(){const e=[],t=this.sceneGroups.indexOf(this.currentSceneGroup);t>=0&&(U(e,t).background="#666"),this.sceneGroupList.setFlairs(e);const s=[],n=this.sceneDescs.indexOf(this.currentSceneDesc);if(n>=0){const e=U(s,n);e.background=this.getLoadingGradient("transparent"),e.fontWeight="bold";const t=`${Math.round(100*this.loadProgress)}%`;e.extraHTML=this.loadProgress<1?`<span style="font-weight: bold; color: #aaa">${t}</span>`:""}this.sceneDescList.setFlairs(s)}selectSceneGroup(e){this.selectedSceneGroup=e,this.syncSceneDescs()}selectSceneGroupIndex(e){this.selectSceneGroup(this.sceneGroups[e])}syncSceneDescs(){this.selectedSceneGroup?this.setSceneDescs(this.selectedSceneGroup.sceneDescs):this.setSceneDescs([])}setSceneDescs(e){this.sceneDescs=e,this.sceneDescList.setItems(e.map(e=>"string"==typeof e?{type:O.Header,name:e}:{type:O.Selectable,name:e.name})),this.syncFlairs(),this.syncVisibility()}}function W(e,t){e.width=t.width,e.height=t.height,e.title=t.title,e.getContext("2d").drawImage(t,0,0)}const H='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGElEQVQYlWNgYGCQwoKxgqGgcJA5h3yFAAs8BRWVSwooAAAAAElFTkSuQmCC")';class Y{constructor(e=100){this.timeout=e,this.timeoutId=null,this.callback=null,this.onframe=()=>{null!==this.callback&&this.callback(),this.timeoutId=null}}trigger(){null!==this.timeoutId&&this.clear(),null!==this.callback&&(this.timeoutId=setTimeout(this.onframe,this.timeout))}clear(){null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}}class Z extends V{constructor(){super(),this.textureList=[],this.newTexturesDebouncer=new Y,this.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="20" fill="white"><path d="M143.5,143.5v300h300v-300H143.5z M274.8,237.2c10.3,0,18.7,8.4,18.7,18.9c0,10.3-8.4,18.7-18.7,18.7   c-10.3,0-18.7-8.4-18.7-18.7C256,245.6,264.4,237.2,274.8,237.2z M406,406H181v-56.2l56.2-56.1l37.5,37.3l75-74.8l56.2,56.1V406z"/><polygon points="387.2,68.6 68.5,68.6 68.5,368.5 106,368.5 106,106 387.2,106"/></svg>',"Textures"),this.scrollList=new N,this.scrollList.elem.style.height="200px",this.scrollList.elem.style.overflow="auto",this.scrollList.onselectionchange=e=>{this.selectTexture(e)},this.contents.appendChild(this.scrollList.elem),this.surfaceView=document.createElement("div"),this.surfaceView.style.width="100%",this.surfaceView.style.height="200px",this.surfaceView.onmouseover=()=>{this.surfaceView.style.backgroundColor="white",this.surfaceView.style.backgroundImage=H},this.surfaceView.onmouseout=()=>{this.surfaceView.style.backgroundColor="black",this.surfaceView.style.backgroundImage=""},this.surfaceView.onmouseout(null),this.contents.appendChild(this.surfaceView),this.properties=document.createElement("div"),this.contents.appendChild(this.properties),this.fullSurfaceView=document.createElement("div"),this.fullSurfaceView.style.backgroundColor="rgba(0, 0, 0, 0.2)",this.fullSurfaceView.style.padding="20px",this.extraRack.appendChild(this.fullSurfaceView)}async getViewerTextureList(){const e=[];for(let t=0;t<this.textureList.length;t++)e.push(this.maybeActivateTexture(this.textureList[t]));return await Promise.all(e),this.textureList}showInSurfaceView(e){this.surfaceView.innerHTML="",e.style.width="100%",e.style.height="100%",e.style.objectFit="scale-down",this.surfaceView.appendChild(e)}showInFullSurfaceView(e){this.fullSurfaceView.innerHTML="";for(let t=0;t<e.length;t++){const s=document.createElement("canvas");W(s,e[t]),s.style.display="block",s.style.backgroundColor="white",s.style.backgroundImage=H,this.fullSurfaceView.appendChild(s)}}async maybeActivateTexture(e){0===e.surfaces.length&&void 0!==e.activate&&await e.activate()}selectTexture(e){const t=this.textureList[e];if(0===t.surfaces.length&&void 0!==t.activate)return void t.activate().then(()=>{this.selectTexture(e)});this.scrollList.setHighlighted(e);const s=new Map;s.set("Name",t.name),s.set("Mipmaps",""+t.surfaces.length),s.set("Width",""+t.surfaces[0].width),s.set("Height",""+t.surfaces[0].height),t.extraInfo&&t.extraInfo.forEach((e,t)=>s.set(t,e)),this.properties.innerHTML='<div style="display: grid; grid-template-columns: 1fr 1fr"></div>';const n=this.properties.firstElementChild;s.forEach((e,t)=>{const s=document.createElement("span");s.textContent=t,n.appendChild(s);const i=document.createElement("span");i.style.textAlign="right",i.textContent=e,n.appendChild(i)}),t.surfaces.length>0&&this.showInSurfaceView(t.surfaces[0]),this.showInFullSurfaceView(t.surfaces)}setThingList(e){this.setTextureList(e.map(e=>e.viewerTexture))}setTextureList(e){if(e=e.filter(e=>e.surfaces.length>0||void 0!==e.activate),this.setVisible(e.length>0),0===e.length)return;const t=e.map(e=>e.name);this.scrollList.setStrings(t),this.textureList=e}setTextureHolder(e){this.newTexturesDebouncer.callback=()=>{this.setTextureList(e.viewerTextures)},e.onnewtextures=()=>{this.newTexturesDebouncer.trigger()},this.newTexturesDebouncer.trigger()}}class z{constructor(){this.onvalue=null,this.toplevel=document.createElement("div"),this.toplevel.innerHTML=`\n<style>\n.Slider {\n    -webkit-appearance: none;\n    width: 100%;\n    margin: 0;\n}\n.Slider::-moz-range-thumb {\n    width: 16px;\n    height: 24px;\n    cursor: pointer;\n    background: ${x};\n    border-radius: 0;\n    border: none;\n}\n.Slider::-webkit-slider-thumb {\n    -webkit-appearance: none;\n    width: 16px;\n    height: 24px;\n    cursor: pointer;\n    background: ${x};\n    border-radius: 0;\n    border: none;\n}\n.Slider::-moz-range-track {\n    cursor: pointer;\n    height: 24px;\n    background: #444;\n}\n.Slider::-webkit-slider-runnable-track {\n    cursor: pointer;\n    height: 24px;\n    background: #444;\n}\n</style>\n<div style="display: grid; grid-template-columns: 1fr 1fr; align-items: center">\n<div style="font-weight: bold; user-select: none" class="Label"></div>\n<input class="Slider" type="range">\n</div>\n`,this.sliderInput=this.toplevel.querySelector(".Slider"),this.sliderInput.oninput=this.onInput.bind(this),this.elem=this.toplevel}onInput(){null!==this.onvalue&&this.onvalue(this.getValue())}setRange(e,t,s=(t-e)/100){this.sliderInput.min=""+e,this.sliderInput.max=""+t,this.sliderInput.step=""+s}setLabel(e){this.toplevel.querySelector(".Label").textContent=e}getValue(){return+this.sliderInput.value}setValue(e,t=!1){this.sliderInput.value=""+e,t&&this.onInput()}getT(){return(0,c.po)(+this.sliderInput.min,+this.sliderInput.max,+this.sliderInput.value)}setT(e){const t=(0,c.Cc)(+this.sliderInput.min,+this.sliderInput.max,e);this.setValue(t)}}class j{constructor(e,t){this.selectedIndex=-1,this.onselectedchange=null,this.options=[],this.elem=document.createElement("div"),this.elem.style.display="grid";const s=(e.length?`${t.length}fr `:"")+`${t.map(()=>"1fr").join(" ")}`;if(this.elem.style.gridTemplateColumns=s,this.elem.style.alignItems="center",e.length){const t=document.createElement("div");t.style.fontWeight="bold",t.textContent=e,this.elem.appendChild(t)}t.forEach((e,t)=>{const s=document.createElement("div");s.style.fontWeight="bold",s.style.textAlign="center",s.style.lineHeight="24px",s.style.cursor="pointer",s.textContent=e,s.onclick=()=>{this.setSelectedIndex(t)},this.elem.appendChild(s),this.options.push(s)})}setVisible(e){this.elem.style.display=e?"grid":"none"}sync(){this.options.forEach((e,t)=>{P(e,t===this.selectedIndex)})}setSelectedIndex(e){this.selectedIndex!==e&&(this.selectedIndex=e,this.sync(),null!==this.onselectedchange&&this.onselectedchange())}}class q extends V{constructor(e,t){super(),this.ui=e,this.viewer=t,this.camControllerClasses=[r.X,r.wR,r.w2],this.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="20" fill="white"><polygon points="48.2573,19.8589 33.8981,15.0724 5,67.8384 48.2573,90.3684" /><polygon points="51.5652,19.8738 51.5652,90.3734 95,67.8392 65.9366,15.2701" /><polygon points="61.3189,13.2756 49.9911,9.6265 38.5411,13.1331 49.9213,16.9268" /></svg>',"Viewer Settings"),this.contents.style.lineHeight="36px",this.camRadioButtons=new j("Camera Controls",["WASD","Orbit","Ortho"]),this.camRadioButtons.onselectedchange=()=>{e.studioModeEnabled||this.setCameraControllerIndex(this.camRadioButtons.selectedIndex)},this.contents.appendChild(this.camRadioButtons.elem),this.fovSlider=new z,this.fovSlider.setLabel("Field of View"),this.fovSlider.setRange(1,100),this.fovSlider.setValue(n.jM.FOV_Y_DEFAULT/Math.PI*100),this.fovSlider.onvalue=this.onFovSliderChange.bind(this),this.contents.appendChild(this.fovSlider.elem),this.camSpeedSlider=new z,this.camSpeedSlider.setLabel("Camera Speed"),this.camSpeedSlider.setRange(0,200),this.camSpeedSlider.onvalue=this.updateCameraSpeedFromSlider.bind(this),this.contents.appendChild(this.camSpeedSlider.elem),this.viewer.addKeyMoveSpeedListener(this.onKeyMoveSpeedChanged.bind(this)),this.viewer.inputManager.addScrollListener(this.onScrollWheel.bind(this));const s=["None","FXAA"];this.viewer.gfxDevice.queryLimits().supportedSampleCounts.includes(4)&&s.push("4x MSAA"),this.antialiasingRadioButtons=new j("Antialiasing",s),this.antialiasingRadioButtons.onselectedchange=()=>{l._h.saveSetting("AntialiasingMode",this.antialiasingRadioButtons.selectedIndex)},this.contents.appendChild(this.antialiasingRadioButtons.elem),l._h.addSettingListener("AntialiasingMode",this.antialiasingChanged.bind(this)),this.invertYCheckbox=new X("Invert Y Axis?"),this.invertYCheckbox.onchanged=()=>{l._h.saveSetting("InvertY",this.invertYCheckbox.checked)},this.contents.appendChild(this.invertYCheckbox.elem),l._h.addSettingListener("InvertY",this.invertYChanged.bind(this)),this.invertXCheckbox=new X("Invert X Axis?"),this.invertXCheckbox.onchanged=()=>{l._h.saveSetting("InvertX",this.invertXCheckbox.checked)},this.contents.appendChild(this.invertXCheckbox.elem),l._h.addSettingListener("InvertX",this.invertXChanged.bind(this))}setCameraControllerIndex(e){const t=this.camRadioButtons.selectedIndex,s=this.camControllerClasses[t];this.setCameraControllerClass(s)}onFovSliderChange(){const e=this.fovSlider.getT();this.viewer.fovY=e*(.995*Math.PI)}onKeyMoveSpeedChanged(){const e=this.viewer.cameraController.getKeyMoveSpeed();null!==e?(M(this.camSpeedSlider.elem,!0),this.camSpeedSlider.setValue(e),this.ui.cameraSpeedIndicator.setCameraSpeed(e)):M(this.camSpeedSlider.elem,!1)}setInitialKeyMoveSpeed(e){this.camSpeedSlider.setValue(e)}setCameraControllerClass(e){this.viewer.cameraController instanceof e||(this.viewer.setCameraController(new e),this.cameraControllerSelected(e),this.updateCameraSpeedFromSlider())}onScrollWheel(){const e=(0,c.qE)(this.camSpeedSlider.getValue()+4*Math.sign(this.viewer.inputManager.dz),0,200);this.ui.setMouseActive(),this.viewer.setKeyMoveSpeed(e)}updateCameraSpeedFromSlider(){this.viewer.setKeyMoveSpeed(this.camSpeedSlider.getValue())}cameraControllerSelected(e){this.camRadioButtons.setSelectedIndex(this.camControllerClasses.indexOf(e)),M(this.fovSlider.elem,e!==r.w2)}invertYChanged(e,t){const s=e.loadSetting(t,!1);this.invertYCheckbox.setChecked(s)}invertXChanged(e,t){const s=e.loadSetting(t,!1);this.invertXCheckbox.setChecked(s)}antialiasingChanged(e,t){const s=e.loadSetting(t,T.Iq.FXAA);this.antialiasingRadioButtons.setSelectedIndex(s)}}class Q extends V{constructor(e,t){super(),this.ui=e,this.viewer=t,this.onWebXRStateRequested=e=>{},this.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" height="20" fill="white"><g><path d="M29,8H3A1,1,0,0,0,2,9V23a1,1,0,0,0,1,1H13a1,1,0,0,0,1-.83l.66-4A1.36,1.36,0,0,1,16,18a1.38,1.38,0,0,1,1.36,1.26L18,23.17A1,1,0,0,0,19,24H29a1,1,0,0,0,1-1V9A1,1,0,0,0,29,8ZM8.5,19A3.5,3.5,0,1,1,12,15.5,3.5,3.5,0,0,1,8.5,19Zm15,0A3.5,3.5,0,1,1,27,15.5,3.5,3.5,0,0,1,23.5,19Z"/></g></svg>',"VR Settings"),this.contents.style.lineHeight="36px",this.enableXRCheckBox=new X("Enable VR"),this.contents.appendChild(this.enableXRCheckBox.elem),this.enableXRCheckBox.onchanged=this.enableXRChecked.bind(this),this.detectXRSupport();const s=()=>{return`VR World Scale: ${e=this.viewer.xrCameraController.worldScale,e.toPrecision(5).toString()}`;var e};this.scaleSlider=new z,this.scaleSlider.setLabel(s()),this.scaleSlider.setRange(10,1e4),this.scaleSlider.setValue(this.viewer.xrCameraController.worldScale),this.scaleSlider.onvalue=()=>{this.viewer.xrCameraController.worldScale=this.scaleSlider.getValue(),this.scaleSlider.setValue(this.viewer.xrCameraController.worldScale),this.scaleSlider.setLabel(s())},this.contents.appendChild(this.scaleSlider.elem)}async detectXRSupport(){if(!("xr"in navigator))return this.enableXRCheckBox.setLabel("WebXR Not Supported"),this.enableXRCheckBox.elem.style.opacity="0.5",void(this.enableXRCheckBox.elem.style.pointerEvents="none");try{await navigator.xr.isSessionSupported("immersive-vr")||(this.enableXRCheckBox.setLabel("VR Not Available"),this.enableXRCheckBox.elem.style.opacity="0.5",this.enableXRCheckBox.elem.style.pointerEvents="none")}catch(e){this.enableXRCheckBox.setLabel("XR Error")}}enableXRChecked(){const e=this.enableXRCheckBox.checked;this.onWebXRStateRequested(e)}}class J{constructor(e=0,t=160){this.minY=e,this.maxY=t,this.textYOffset=0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}beginDraw(e,t){n.H5(this.canvas,e,t,window.devicePixelRatio),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.textYOffset=24}drawPoints(e,t){const s=this.canvas.width,n=this.canvas.height,i=this.ctx,r=s/(e.length-1),o=n/(this.maxY-this.minY-1);i.lineWidth=2,i.strokeStyle=(0,a.KK)(t),i.fillStyle=(0,a.KK)({r:t.r,g:t.g,b:t.b,a:t.a-.8}),i.beginPath(),i.lineTo(s+20,n+20);for(let t=0;t<e.length;t++)i.lineTo(s-t*r,n-(e[t]-this.minY)*o);i.lineTo(-20,n+20),i.closePath(),i.fill(),i.stroke()}drawText(e){const t=this.ctx;t.fillStyle="white",t.font="12pt monospace",t.fillText(e,16,this.textYOffset),this.textYOffset+=16}}class ee extends V{constructor(e){super(),this.viewer=e,this.fpsGraph=new J,this.fpsHistory=[],this.fpsPoints=[],this.fpsColor={r:.4,g:.9,b:.6,a:1},this.setTitle('<svg xmlns="http://www.w3.org/2000/svg" viewBox="5 0 55 60" height="16" fill="white"><g><polygon points="6.9,11.5 6.9,56 55.4,56 55.4,53 9.9,53 9.9,11.5"/><path d="M52.7,15.8c-2.7,0-4.9,2.2-4.9,4.9c0,1,0.3,1.8,0.8,2.6l-5,6.8c-0.4-0.1-0.9-0.2-1.3-0.2c-1.5,0-2.9,0.7-3.8,1.8l-5.6-2.8   c0-0.2,0.1-0.5,0.1-0.8c0-2.7-2.2-4.9-4.9-4.9s-4.9,2.2-4.9,4.9c0,1.1,0.3,2,0.9,2.8l-3.9,5.1c-0.5-0.2-1.1-0.3-1.7-0.3   c-2.7,0-4.9,2.2-4.9,4.9s2.2,4.9,4.9,4.9s4.9-2.2,4.9-4.9c0-1-0.3-2-0.8-2.7l4-5.2c0.5,0.2,1.1,0.3,1.6,0.3c1.4,0,2.6-0.6,3.5-1.5   l5.8,2.9c0,0.1,0,0.2,0,0.3c0,2.7,2.2,4.9,4.9,4.9c2.7,0,4.9-2.2,4.9-4.9c0-1.2-0.4-2.2-1.1-3.1l4.8-6.5c0.6,0.2,1.2,0.4,1.9,0.4   c2.7,0,4.9-2.2,4.9-4.9S55.4,15.8,52.7,15.8z"/></g></svg>',"Statistics"),this.contents.appendChild(this.fpsGraph.canvas)}addRenderStatistics(e){if(this.expanded){for(this.fpsHistory.unshift(e.fps);this.fpsHistory.length>100;)this.fpsHistory.pop();this.fpsPoints.length=100;for(let e=0;e<this.fpsPoints.length;e++)this.fpsPoints[e]=void 0!==this.fpsHistory[e]?this.fpsHistory[e]:0;this.fpsGraph.beginDraw(440,200),this.fpsGraph.drawPoints(this.fpsPoints,this.fpsColor);for(const t of e.lines)this.fpsGraph.drawText(t)}}}class te extends V{constructor(e){super(),this.ui=e,this.setTitle(m.BZ,"Studio"),document.head.insertAdjacentHTML("beforeend","\n            <style>\n                button.SettingsButton {\n                    font: 16px monospace;\n                    font-weight: bold;\n                    border: none;\n                    width: 100%;\n                    color: inherit;\n                    padding: 0.15rem;\n                    text-align: center;\n                    background-color: rgb(64, 64, 64);\n                    cursor: pointer;\n                }\n                #studioSidePanelHelpBtn {\n                    width: 32px;\n                    display: flex;\n                    justify-content: center;\n                    align-items: center;\n                    margin-left: 1rem;\n                    background: transparent;\n                    border: none;\n                    cursor: pointer;\n                }\n            </style>\n            "),this.contents.insertAdjacentHTML("beforeend",'\n            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; align-items: center;">\n                <div style="display: flex;">\n                    <span>Studio Mode</span>\n                    <button class="SettingsButton" id="studioSidePanelHelpBtn"></button>\n                </div>\n                <button id="enableStudioBtn" class="SettingsButton">Enable</button>\n                <button id="disableStudioBtn" class="SettingsButton">Disable</button>\n            </div>\n            <div id="studioPanelContents" hidden></div>\n        '),this.contents.style.lineHeight="36px",this.studioSidePanelHelpBtn=this.contents.querySelector("#studioSidePanelHelpBtn"),this.studioSidePanelHelpBtn.appendChild(b(w).querySelector("svg")),this.studioSidePanelHelpBtn.onclick=()=>{const e=document.createElement("a");e.rel="noopener noreferrer",e.target="_blank",e.href="https://github.com/magcius/noclip.website/wiki/Studio",e.click()},this.enableStudioBtn=this.contents.querySelector("#enableStudioBtn"),this.disableStudioBtn=this.contents.querySelector("#disableStudioBtn"),this.enableStudioBtn.onclick=()=>{e.studioModeEnabled||(e.enableStudioMode(),P(this.enableStudioBtn,!0),P(this.disableStudioBtn,!1),this.setExpanded(!1))},this.disableStudioBtn.onclick=()=>{e.studioModeEnabled&&(e.disableStudioMode(),P(this.disableStudioBtn,!0),P(this.enableStudioBtn,!1))},P(this.disableStudioBtn,!0),P(this.enableStudioBtn,!1)}}class se extends V{constructor(){super(),this.onfaq=null,this.setTitle(w,"About"),this.contents.innerHTML=`\n<div id="About">\n<style>\n#About {\n    padding: 12px;\n    line-height: 1.2;\n}\n#About a {\n    color: white;\n}\n#About li span {\n    color: #aaa;\n}\n#About h1 {\n    margin: 0px;\n    font-size: 2em;\n}\n#About h2 {\n    font-size: 12.8pt;\n}\n#About h1 span, #About h1 img {\n    vertical-align: middle;\n    line-height: 64px;\n}\n#About .BuildVersion a {\n    color: #666;\n    font-size: smaller;\n}\n</style>\n\n<h1> <img src="${p}"> <span> noclip.website </span> </h1>\n<h2> A digital museum of video game levels </h2>\n\n<a href="#" class="FAQLink"> What is this? / FAQ </a>\n\n<p> <strong>CLICK AND DRAG</strong> to look around and use <strong>WASD</strong> to move the camera </p>\n<p> Hold <strong>SHIFT</strong> to go faster, and use <strong>MOUSE WHEEL</strong> to fine tune the speed\n<strong>Z</strong> toggles the UI. </p>\n\n<p><a href="https://discord.gg/bkJmKKv"><strong>JOIN THE DISCORD</strong> by clicking here</a></p>\n\n<p><strong>CODE PRIMARILY WRITTEN</strong> by <a href="https://twitter.com/JasperRLZ">Jasper</a></p>\n<p><strong>ADDITIONAL CONTENT WRITTEN BY JEEBS2KX</a></p>\n\n<p><strong>OPEN SOURCE</strong> at <a href="${o.Oe}">GitHub</a></p>\n\n<p class="BuildVersion"><a href="${o.EH}">build ${o.g8}</a></p>\n</div>\n`,this.contents.querySelector(".FAQLink").onclick=()=>{null!==this.onfaq&&this.onfaq()}}}class ne{constructor(){this.toplevel=document.createElement("div"),this.toplevel.classList.add("FAQPanel"),this.toplevel.style.position="absolute",this.toplevel.style.left="0",this.toplevel.style.top="0",this.toplevel.style.right="0",this.toplevel.style.bottom="0",this.toplevel.style.background="rgba(0, 0, 0, 0.8)",this.toplevel.onclick=()=>{this.elem.style.display="none"};const e=b("\n<style>\n.FAQPanel a:link, .FAQPanel a:visited { color: #ddd; }\n.FAQPanel a:hover { color: #fff; }\n</style>\n");this.toplevel.appendChild(e),this.panel=document.createElement("div"),this.panel.style.boxSizing="border-box",this.panel.style.width="50vw",this.panel.style.margin="5vh auto",this.panel.style.height="90vh",this.panel.style.backgroundColor="black",this.panel.style.padding="2em",this.panel.style.font="11pt monospace",this.panel.style.overflow="auto",this.panel.style.color="#ddd",this.panel.style.textAlign="justify",this.panel.onclick=e=>{e.stopPropagation()};const t=document.createElement("div");this.panel.appendChild(t);const s="\n## What is noclip.website?\n\n<p>noclip.website is a celebration of video game level design and art. It's a chance to\nexplore and deepen your appreciation for some of your favorite games.</p>\n\n## Why did you make this?\n\n<p>I've always had an appreciation for the incredible worlds that game developers make.\nSometimes staring closely at levels might help you understand the challenges the designers\nwere facing, and what problems and techniques they used to solve them. You can learn a lot\nabout a game by looking in the places they <em>don't</em> show in the game itself. It's\nalso a ton of fun to test your memory, seeing if you can remember how a level is laid\nout, or where two rooms might connect to each other.</p>\n\n## It doesn't work!\n\n<p>Oops, sorry about that. Please let me know through either the <a href=\"https://discord.gg/bkJmKKv\">official noclip.website Discord</a>\nor <a href=\"https://twitter.com/JasperRLZ/\">Twitter</a>. Try to let me know what\nOS/browser/GPU you were using, and what game you tried to view, and I'll investigate.</p>\n\n## Can I request a game?\n\n<p>Maybe. Check around to see if anybody has looked at the game files before. If there's\nexisting community documentation, that helps a lot. And if you're around to help answer\nquestions or provide map names, I'm even more inclined.</p>\n\n<p>Even having documentation, games can take months of my time to add. So I have to be\nvery careful with which games I choose to spend my time with.</p>\n\n<p>If you have some programming skills and want to try to add a game yourself, I fully\nwelcome that. Join the Discord and I will be happy to help you get set up with a\ndevelopment environment and walk you through the code.</p>\n\n## Why do some levels look broken?\n\n<p>In order to put a game on the website, I first need to take apart the game, extract\nthe data, and then figure out how to put it back together. Some of these games, especially\nthe newer ones, are really complex with their levels and their models, and that often means\nit takes more work to make it look correct. The line between \"game engine\" and \"game data\"\nis only getting blurrier and blurrier.</p>\n\n<p>My dream is that the site contains fully accurate versions of each game, and I try\nto get closer to that goal when I can, but the effort and time involved to make an accurate\nrecreation can sometimes be far too much, or would push me more into recreating large\nparts of the original game's engine, which I'm less interested in doing myself.</p>\n\n## How do I export models from the site?\n\n<p>You can't. From the technical side, there is no one consistent file format that has\nall of the features that an accurate model would require. From a personal perspective,\nI'm not ready to take on the support burden of writing an export tool.</p>\n\n<p>That said, if you would like to use my work as a base to build your own tools, the website\nis open-source and source code can be found at <a href=\"https://github.com/magcius/noclip.website\">GitHub</a>.</p>\n\n<p>If you are looking for art for your own projects, there are some fantastic artists\nout there in the community that are always looking for work. Hire them instead of\nusing art assets from other games.</p>\n\n## This is cool! Any way I can help you out!\n\n<p>Absolutely. Join <a href=\"https://discord.gg/bkJmKKv\">the official Discord</a> and ask around if you would like to help out.\nThe easiest things to help out with are providing savestates and naming maps, and can\nbe done even if you do not know how to code. There's also some work that would be\nappreciated to help me improve accuracy, like running games in certain modes to help\nme compare the two.</p>\n\n<p>If you have a more tech-y background, there's always coding work to be done. All\nthe source code to the site is available at <a href=\"https://github.com/magcius/noclip.website\">GitHub</a>,\nwhether you want to browse around, use it for your own purposes, or help contribute.</p>\n\n## Are you afraid of being taken down?\n\n<p>Less than you might think. Companies take down fan projects when they're competing\nwith their in-house projects. I don't see noclip.website as competing with any game\nout there &mdash; it's more of a museum, not a game. The worlds on display are incredible\nand I hope they encourage you to go out and buy a copy of the game itself.</p>\n\n<p>That said, I have enormous respect for the developers and dev teams and if I received\na take-down request, I would honor it. It is their work on display, after all.</p>\n\n<p>Developers are only able to make these fantastic worlds if we collectively support\nthem. noclip would not exist without their hard work and dedication. To ensure that they\nremain healthy, please try to buy games instead of pirating them. I also put in extra effort\nto ensure that all assets available on this site cannot be used to pirate the game itself.</p>\n\n## Do you accept donations?\n\n<p>No. Use the money to buy some games instead.</p>\n\n## Any affiliation to noclip, the documentary people?\n\n<p>I chatted with them once, but the name is a coincidence. The name comes from an old Quake\ncommand that would let you fly through the levels here, just like in the game.</p>\n\n## Have you seen the YouTube show Boundary Break?\n\n<p>Of course! I love that show. I'm ecstatic to see that exploring video game levels from\ndifferent angles has captured the imaginations of such a wide audience. And I hope that this\nsite encourages that same curiosity that's visible all throughout Boundary Break, trekking\nthrough these levels on your own adventures!</p>\n\n## Who made this site?\n\n<p>In my opinion? The artists and game developers. They made everything you actually see here\non display.</p>\n\n<p>All icons you see are from <a href=\"https://thenounproject.com/\">The Noun Project</a>,\nused under Creative Commons CC-BY:</p>\n<ul>\n<li> Truncated Pyramid <span>by</span> Bohdan Burmich\n<li> Images <span>by</span> Creative Stall\n<li> Help <span>by</span> Gregor Cresnar\n<li> Open <span>by</span> Landan Lloyd\n<li> Nightshift <span>by</span> mikicon\n<li> Layer <span>by</span> Chameleon Design\n<li> Sand Clock <span>by</span> James\n<li> Line Chart <span>by</span> Shastry\n<li> Search <span>by</span> Alain W.\n<li> Save <span>by</span> Prime Icons\n<li> Overlap <span>by</span> Zach Bogart\n<li> VR <span>by</span> Fauzan Adaiima\n<li> Play Clapboard <span>by</span> Yoyon Pujiyono\n<li> Undo <span>by</span> Numero Uno\n<li> Redo <span>by</span> Numero Uno\n<li> Zoom In <span>by</span> Tanvir Islam\n<li> Zoom Out <span>by</span> Tanvir Islam\n\n</ul>\n".split("##").slice(1).map(e=>{const t=e.indexOf("\n");return{question:e.slice(0,t).trim(),answer:e.slice(t).trim()}});for(let e=0;e<s.length;e++){const n=document.createElement("div"),i=s[e].question,r=document.createElement("p");r.style.color="#ccc",r.style.fontWeight="bold",r.style.marginTop="0",r.style.fontSize="12pt",r.textContent=i,n.appendChild(r);const a=document.createElement("p");a.style.marginBottom="1.6em",a.innerHTML=s[e].answer,n.appendChild(a),t.appendChild(n)}this.toplevel.appendChild(this.panel),this.elem=this.toplevel}}class ie{constructor(){this.currentAnimation=null,this.elem=document.createElement("div"),this.elem.style.opacity="0",this.elem.style.textShadow="0 0 8px black",this.elem.style.padding="0 8px",this.elem.style.font="bold 16px monospace",this.elem.style.color="white",this.elem.style.pointerEvents="none",this.elem.style.lineHeight="32px"}setVisible(e){this.elem.style.display=e?"block":"none"}setArea(){}isAnyPanelExpanded(){return!1}setCameraSpeed(e,t=!0){const s=Math.max(e,1);this.elem.textContent=`Camera Speed: ${s.toFixed(0)}`;const n=s/200*100+"%";this.elem.style.backgroundImage=`linear-gradient(to right, ${x} ${n}, rgba(0, 0, 0, 0.75) ${n})`,t&&(null!==this.currentAnimation&&this.currentAnimation.cancel(),this.currentAnimation=this.elem.animate([{opacity:1,offset:0},{opacity:1,offset:.5},{opacity:0,offset:1}],2e3))}}var re;function ae(e,t){t===re.Left?(e.style.transform="",e.style.marginLeft="",e.style.right=""):t===re.Center?(e.style.transform="translate(-50%, 0)",e.style.marginLeft="16px",e.style.right=""):t===re.Right&&(e.style.transform="",e.style.marginLeft="",e.style.right="0")}!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(re||(re={}));class oe{constructor(){this.widgets=[],this.elem=document.createElement("div"),this.elem.id="BottomBar",this.elem.style.position="absolute",this.elem.style.bottom="32px",this.elem.style.left="32px",this.elem.style.right="32px",this.elem.style.display="grid",this.elem.style.gridTemplateColumns="1fr 1fr 1fr",this.elem.style.gap="8px",this.elem.style.transition=".1s ease-out",this.elem.style.pointerEvents="none";const e=this.newArea();e.style.justifySelf="start",this.elem.appendChild(e);const t=this.newArea();t.style.justifySelf="center",this.elem.appendChild(t);const s=this.newArea();s.style.justifySelf="end",this.elem.appendChild(s)}newArea(){const e=document.createElement("div");return e.style.display="grid",e.style.gridAutoFlow="column",e.style.gap="8px",e}addWidgets(e,t){t.setArea(e),this.widgets.push(t),this.elem.children.item(e).appendChild(t.elem)}isAnyPanelExpanded(){for(let e=0;e<this.widgets.length;e++)if(this.widgets[e].isAnyPanelExpanded())return!0;return!1}setActive(e){this.elem.style.opacity=e?"1":"0"}setVisible(e){this.elem.style.display=e?"grid":"none"}}class le{constructor(){this.isOpen=!1,this.isHover=!1,this.elem=document.createElement("div"),this.elem.style.position="relative",this.elem.style.transition=".1s ease-out",this.elem.style.width="32px",this.elem.style.height="32px",this.elem.style.pointerEvents="auto",this.elem.onclick=this.onClick.bind(this),this.elem.onmouseover=()=>{this.isHover=!0,this.syncStyle()},this.elem.onmouseout=()=>{this.isHover=!1,this.syncStyle()},this.icon=document.createElement("div"),this.icon.style.width="32px",this.icon.style.height="32px",this.icon.style.cursor="pointer",this.icon.style.font="16px monospace",this.icon.style.color="white",this.icon.style.lineHeight="32px",this.icon.style.textAlign="center",this.icon.style.textShadow="0px 0px 6px rgba(0, 0, 0, 0.5)",this.icon.style.transition="0.1s ease-out",this.icon.style.userSelect="none",this.elem.appendChild(this.icon),this.tooltipElem=document.createElement("div"),this.tooltipElem.style.position="absolute",this.tooltipElem.style.top="0",this.tooltipElem.style.marginTop="-32px",this.tooltipElem.style.padding="0 8px",this.tooltipElem.style.background="rgba(0, 0, 0, 0.75)",this.tooltipElem.style.font="bold 16px monospace",this.tooltipElem.style.lineHeight="32px",this.tooltipElem.style.color="white",this.tooltipElem.style.textShadow="0 0 8px black",this.tooltipElem.style.transition="0.1s ease-out",this.tooltipElem.style.pointerEvents="none",this.tooltipElem.style.userSelect="none",this.tooltipElem.style.opacity="0",this.elem.appendChild(this.tooltipElem)}setShow(e){this.elem.style.display=e?"block":"none"}setArea(e){ae(this.tooltipElem,e)}setVisible(e){this.elem.style.display=e?"block":"none"}isAnyPanelExpanded(){return this.isOpen}setIsOpen(e){this.isOpen=e,this.syncStyle()}syncStyle(){this.isOpen?(this.icon.style.background="rgba(0, 0, 0, 0.75)",this.icon.style.color=x,this.tooltipElem.style.opacity="0"):this.isHover?(this.icon.style.background="rgba(0, 0, 0, 0.75)",this.icon.style.color="white",this.tooltipElem.style.opacity="1"):(this.icon.style.background="rgba(0, 0, 0, 0.0)",this.icon.style.color="white",this.tooltipElem.style.opacity="0")}}class he extends le{constructor(){super(),this.panel=document.createElement("div"),this.panel.style.position="absolute",this.panel.style.top="0",this.panel.style.marginTop="-32px",this.panel.style.lineHeight="32px",this.panel.style.background="rgba(0, 0, 0, 0.75)",this.panel.style.transition="0.1s ease-out",this.elem.appendChild(this.panel),this.syncStyle()}setArea(e){super.setArea(e),ae(this.panel,e)}onClick(e){this.isOpen||(this.setIsOpen(!0),h.B.takeGrab(this,e,{takePointerLock:!1,useGrabbingCursor:!1,releaseOnMouseUp:!1,grabElement:this.panel}))}onMotion(){}onGrabReleased(){this.setIsOpen(!1)}syncStyle(){super.syncStyle(),this.isOpen?(this.panel.style.opacity="1",this.panel.style.pointerEvents=""):(this.panel.style.opacity="0",this.panel.style.pointerEvents="none")}}class ce extends he{constructor(){super(),this.tooltipElem.textContent="Share",y(this.icon,_.share),this.panel.style.display="grid",this.panel.style.width="400px",this.panel.style.gridAutoFlow="column",this.currentShareURLEntry=new B,this.currentShareURLEntry.textarea.readOnly=!0,this.currentShareURLEntry.textarea.onfocus=()=>{this.currentShareURLEntry.selectAll()},this.currentShareURLEntry.elem.style.width="auto",this.currentShareURLEntry.elem.style.lineHeight="32px",this.currentShareURLEntry.elem.style.padding="0 16px",this.panel.appendChild(this.currentShareURLEntry.elem),this.copyButton=document.createElement("div"),this.copyButton.style.font="16px monospace",this.copyButton.style.textShadow="0px 0px 6px rgba(0, 0, 0, 0.5)",this.copyButton.style.color="white",this.copyButton.style.lineHeight="32px",this.copyButton.style.textAlign="center",this.copyButton.style.userSelect="none",this.copyButton.onclick=()=>{"copy"===this.copyButtonState&&(window.navigator.clipboard.writeText(this.currentShareURLEntry.getValue()),this.currentShareURLEntry.selectAll(),this.setCopyButtonState("copied"))},this.setCopyButtonState("copy"),this.panel.appendChild(this.copyButton)}setCopyButtonState(e){this.copyButtonState!==e&&(this.copyButtonState=e,"copy"===e?(this.copyButton.style.backgroundColor=x,this.copyButton.style.cursor="pointer",this.copyButton.textContent="COPY"):(this.copyButton.style.backgroundColor="#666",this.copyButton.style.cursor="",this.copyButton.textContent="COPIED"))}setShareURL(e){this.setCopyButtonState("copy"),this.currentShareURLEntry.setValue(e)}}class ue extends le{constructor(){super(),void 0===document.body.requestFullscreen&&this.setShow(!1),document.addEventListener("fullscreenchange",this.syncStyle.bind(this)),this.syncStyle()}isFS(){return document.fullscreenElement===document.body}syncStyle(){super.syncStyle(),y(this.icon,this.isFS()?_.resize_small:_.resize_full),this.tooltipElem.textContent=this.isFS()?"Unfullscreen":"Fullscreen"}onClick(){this.isFS()?document.exitFullscreen():document.body.requestFullscreen()}}class de extends le{constructor(){super(...arguments),this.onplaypause=null}syncStyle(){super.syncStyle(),y(this.icon,this.isPlaying?_.pause:_.play),this.tooltipElem.textContent=this.isPlaying?"Pause":"Play"}setIsPlaying(e){this.isPlaying=e,this.syncStyle()}onClick(){null!==this.onplaypause&&this.onplaypause(!this.isPlaying)}}class me{constructor(){this.elem=document.createElement("div"),this.elem.style.position="absolute",this.elem.style.right="0",this.elem.style.bottom="0",this.elem.style.backgroundColor="rgba(0, 0, 0, 0.6)",this.elem.style.borderTopLeftRadius="8px",this.elem.style.font="24px Din",this.elem.style.fontWeight="600",this.elem.style.color="white",this.elem.style.padding="8px 9px 8px 12px",this.elem.style.pointerEvents="none",this.elem.style.textShadow="0px 0px 10px rgba(0, 0, 0, 0.8)",this.elem.style.visibility="hidden",this.elem.style.userSelect="none",this.elem.textContent="[ noclip.website ]"}v(){this.elem.style.visibility="",window.main.ui.toggleUI(!1)}}class pe{forcePanelsMouseOutState(){this.panelToplevel.style.backgroundColor="rgba(0, 0, 0, 0)",this.panelToplevel.style.overflow="hidden",this.shouldPanelsAutoClose()&&this.setPanelsAutoClosed(!0)}constructor(e){this.viewer=e,this.recordingBranding=new me,this.cameraSpeedIndicator=new ie,this.bottomBar=new oe,this.playPauseButton=new de,this.shareButton=new ce,this.fullscreenButton=new ue,this.debugFloaterHolder=new u.RB,this.isDragging=!1,this.lastMouseActiveTime=-1,this.isPlaying=!0,this.isEmbedMode=!1,this.isVisible=!0,this.studioModeEnabled=!1,this.toplevel=document.createElement("div"),this.sceneUIContainer=document.createElement("div"),this.sceneUIContainer.style.pointerEvents="none",this.toplevel.appendChild(this.sceneUIContainer),this.panelToplevel=document.createElement("div"),this.panelToplevel.id="Panel",this.panelToplevel.style.position="absolute",this.panelToplevel.style.left="0",this.panelToplevel.style.top="0",this.panelToplevel.style.bottom="0",this.panelToplevel.style.padding="2em",this.panelToplevel.style.transition=".2s background-color",this.panelToplevel.onmouseover=()=>{this.panelToplevel.style.backgroundColor="rgba(0, 0, 0, 0.2)",this.panelToplevel.style.overflow="auto";for(const e of this.panels)if(e.manuallyExpanded){this.setPanelsAutoClosed(!1);break}},this.panelToplevel.onmouseout=()=>{this.panelToplevel.style.backgroundColor="rgba(0, 0, 0, 0)",this.panelToplevel.style.overflow="hidden"},this.panelContainer=document.createElement("div"),this.panelContainer.style.display="grid",this.panelContainer.style.gridTemplateColumns="1fr",this.panelContainer.style.gap="20px",this.panelToplevel.appendChild(this.panelContainer),this.toplevel.appendChild(this.panelToplevel),this.dragHighlight=document.createElement("div"),this.toplevel.appendChild(this.dragHighlight),this.dragHighlight.style.position="absolute",this.dragHighlight.style.left="0",this.dragHighlight.style.right="0",this.dragHighlight.style.top="0",this.dragHighlight.style.bottom="0",this.dragHighlight.style.backgroundColor="rgba(255, 255, 255, 0.5)",this.dragHighlight.style.boxShadow="0 0 40px 5px white inset",this.dragHighlight.style.display="none",this.dragHighlight.style.pointerEvents="none",this.toplevel.appendChild(this.debugFloaterHolder.elem),this.toplevel.appendChild(this.recordingBranding.elem),this.toplevel.appendChild(this.bottomBar.elem),this.bottomBar.addWidgets(re.Left,this.cameraSpeedIndicator),this.bottomBar.addWidgets(re.Center,this.playPauseButton),this.bottomBar.addWidgets(re.Right,this.shareButton),this.bottomBar.addWidgets(re.Right,this.fullscreenButton),this.sceneSelect=new $(e),this.textureViewer=new Z,this.viewerSettings=new q(this,e),this.xrSettings=new Q(this,e),this.statisticsPanel=new ee(e),this.about=new se,this.faqPanel=new ne,this.faqPanel.elem.style.display="none",this.toplevel.appendChild(this.faqPanel.elem),this.studioSidePanel=new te(this),this.studioPanel=new m.JT(this,e),this.toplevel.appendChild(this.studioPanel.elem),this.playPauseButton.onplaypause=e=>{this.togglePlayPause(e)},this.playPauseButton.setIsPlaying(this.isPlaying),this.about.onfaq=()=>{this.faqPanel.elem.style.display="block"},window.onmousemove=()=>{this.setMouseActive()},this.setMouseActive(),this.setScenePanels(null),this.elem=this.toplevel}togglePlayPause(e=!this.isPlaying){this.isPlaying=e,this.playPauseButton.setIsPlaying(this.isPlaying)}toggleWebXRCheckbox(e=!this.xrSettings.enableXRCheckBox.checked){this.xrSettings.enableXRCheckBox.setChecked(e)}setMouseActive(){this.lastMouseActiveTime=window.performance.now()}update(){this.syncVisibilityState()}setSaveState(e){const t=function(e){const t=window.location;return`${t.origin}${t.pathname}#${s=e,s.replace(/[{}()^]/g,e=>`%${e.charCodeAt(0).toString(16)}`)}`;var s}(e);this.shareButton.setShareURL(t)}sceneChanged(){if(!this.viewer.cameraController)return;const e=this.viewer.cameraController.constructor;this.viewerSettings.cameraControllerSelected(e);const t=this.viewer.cameraController.getKeyMoveSpeed();if(null!==t&&this.viewerSettings.setInitialKeyMoveSpeed(t),null!==this.viewer.scene){const e=this.viewer.scene;void 0!==e.textureHolder?this.textureViewer.setTextureHolder(e.textureHolder):this.textureViewer.setTextureList([])}this.studioModeEnabled&&this.studioPanel.onSceneChange()}setPanels(e){this.panels=e,k(this.panelContainer,e.map(e=>e.elem))}destroyScene(){this.setScenePanels([]),k(this.sceneUIContainer,[]),this.debugFloaterHolder.destroyScene()}setScenePanels(e){null!==e?this.setPanels([this.sceneSelect,...e,this.textureViewer,this.viewerSettings,this.xrSettings,this.statisticsPanel,this.studioSidePanel,this.about]):this.setPanels([this.sceneSelect,this.about])}setPanelsAutoClosed(e){for(let t=0;t<this.panels.length;t++)this.panels[t].setAutoClosed(e)}shouldPanelsAutoClose(){return!this.statisticsPanel.manuallyExpanded}shouldBottomBarBeFadeIn(){return!!this.bottomBar.isAnyPanelExpanded()||(!!this.isDragging||!(window.performance.now()>this.lastMouseActiveTime+1e3))}setDraggingMode(e){const t=e!==d.p.None,s=e===d.p.PointerLocked;this.isDragging=t,this.elem.style.pointerEvents=t&&!s?"none":"",t&&this.shouldPanelsAutoClose()&&this.setPanelsAutoClosed(!0),this.syncVisibilityState()}syncVisibilityState(){const e=!this.isEmbedMode&&this.isVisible;this.panelToplevel.style.display=e?"":"none";const t=this.isVisible;this.bottomBar.setVisible(t),this.bottomBar.setActive(this.shouldBottomBarBeFadeIn());const s=!this.isEmbedMode;this.cameraSpeedIndicator.setVisible(s),this.shareButton.setVisible(s)}setEmbedMode(e){this.isEmbedMode!==e&&(this.isEmbedMode=e,this.syncVisibilityState())}toggleUI(e=!this.isVisible){this.isVisible!==e&&(this.isVisible=e,this.syncVisibilityState())}enableStudioMode(){this.viewerSettings.setCameraControllerIndex(0),this.studioPanel.initStudio(),this.studioPanel.show(),this.viewer.setCameraController(this.studioPanel.studioCameraController),this.studioModeEnabled=!0}disableStudioMode(){this.studioModeEnabled=!1,this.viewerSettings.setCameraControllerIndex(0),this.studioPanel.hide()}}},5974(e,t,s){"use strict";function n(e,t=""){if(!e)throw console.error((new Error).stack),new Error(`Assert fail: ${t}`)}function i(e,t=""){if(null!=e)return e;throw new Error(`Missing object ${t}`)}function r(e){return void 0===e?null:e}function a(e,t,s=-1,n=!0,i=null){const r=e.createTypedArray(Uint8Array,t);let a=0;for(;!(s>=0&&a>=s||n&&0===r[a]);)a++;return 0===a?"":null!==i?function(e,t,s,n="utf8"){return new TextDecoder(n).decode(e.copyToBuffer(t,s))}(e,t,a,i):function(e,t,s){const n=e.createTypedArray(Uint8Array,t);let i="";for(let e=0;e<s;e++)i+=String.fromCharCode(n[e]);return i}(e,t,a)}function o(e,t){const s=t-1;return e+s&~s}function l(e,t){const s=new Array(e);for(let n=0;n<e;n++)s[n]=t(n);return s}function h(e,t){return function(e,t,s="0"){for(;e.length<t;)e=`${s}${e}`;return e}((e>>>0).toString(16),t)}function c(e,t){return null!=e?e:t}function u(e,t,s){const n=function(e,t,s){let n=0,i=e.length;for(;n<i;){const r=n+(i-n>>>1);s(t,e[r])<0?i=r:n=r+1}return n}(e,t,s);e.splice(n,0,t)}s.d(t,{E3:()=>a,MM:()=>o,Z1:()=>i,g_:()=>r,lL:()=>u,rB:()=>c,vA:()=>n,y5:()=>l,yq:()=>h})},381(e,t,s){"use strict";s.d(t,{qP:()=>re,jM:()=>me,R4:()=>pe,Xv:()=>ge,H5:()=>de});var n,i=s(8880),r=s(841),a=s(7639),o=s(7714),l=s(7653);!function(e){e[e.Buffer=0]="Buffer",e[e.Texture=1]="Texture",e[e.RenderTarget=2]="RenderTarget",e[e.Sampler=3]="Sampler",e[e.Program=4]="Program",e[e.Bindings=5]="Bindings",e[e.InputLayout=6]="InputLayout",e[e.RenderPipeline=7]="RenderPipeline",e[e.ComputePipeline=8]="ComputePipeline",e[e.Readback=9]="Readback",e[e.QueryPool=10]="QueryPool"}(n||(n={}));const h={formatKind:o.dG.Float,dimension:o.bn.n2D};var c,u=s(6726),d=s(1110);function m(e){const t=(0,l.pZ)(e),s=(0,l._z)(e),n=(0,l.vg)(e),i=function(e){switch(e){case l.np.U8:return WebGL2RenderingContext.UNSIGNED_BYTE;case l.np.U16:return WebGL2RenderingContext.UNSIGNED_SHORT;case l.np.U32:return WebGL2RenderingContext.UNSIGNED_INT;case l.np.S8:return WebGL2RenderingContext.BYTE;case l.np.S16:return WebGL2RenderingContext.SHORT;case l.np.S32:return WebGL2RenderingContext.INT;case l.np.F16:return WebGL2RenderingContext.HALF_FLOAT;case l.np.F32:return WebGL2RenderingContext.FLOAT;default:throw"whoops"}}(t),r=function(e){switch(e){case l.wd.R:return 1;case l.wd.RG:return 2;case l.wd.RGB:return 3;case l.wd.RGBA:return 4}}(s);return{size:r,type:i,normalized:!!(n&l.lk.Normalized)}}function p(e){if((0,l.vg)(e)&l.lk.Normalized)return!1;const t=(0,l.pZ)(e);return t===l.np.S8||t===l.np.S16||t===l.np.S32||t===l.np.U8||t===l.np.U16||t===l.np.U32}function f(e){if(e&o.B6.Index)return WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER;if(e&o.B6.Vertex)return WebGL2RenderingContext.ARRAY_BUFFER;if(e&o.B6.Uniform)return WebGL2RenderingContext.UNIFORM_BUFFER;if(e&(o.B6.Storage|o.B6.CopySrc))return WebGL2RenderingContext.COPY_WRITE_BUFFER;throw"whoops"}function g(e){switch(e){case o.Vf.Clamp:return WebGL2RenderingContext.CLAMP_TO_EDGE;case o.Vf.Repeat:return WebGL2RenderingContext.REPEAT;case o.Vf.Mirror:return WebGL2RenderingContext.MIRRORED_REPEAT;default:throw"whoops"}}function T(e,t){if(t===o.P.Linear&&e===o.gD.Bilinear)return WebGL2RenderingContext.LINEAR_MIPMAP_LINEAR;if(t===o.P.Linear&&e===o.gD.Point)return WebGL2RenderingContext.NEAREST_MIPMAP_LINEAR;if(t===o.P.Nearest&&e===o.gD.Bilinear)return WebGL2RenderingContext.LINEAR_MIPMAP_NEAREST;if(t===o.P.Nearest&&e===o.gD.Point)return WebGL2RenderingContext.NEAREST_MIPMAP_NEAREST;if(t===o.P.NoMip&&e===o.gD.Bilinear)return WebGL2RenderingContext.LINEAR;if(t===o.P.NoMip&&e===o.gD.Point)return WebGL2RenderingContext.NEAREST;throw new Error("Unknown texture filter mode")}function x(e){if(e===o.bn.n2D)return WebGL2RenderingContext.TEXTURE_2D;if(e===o.bn.n2DArray)return WebGL2RenderingContext.TEXTURE_2D_ARRAY;if(e===o.bn.Cube)return WebGL2RenderingContext.TEXTURE_CUBE_MAP;if(e===o.bn.n3D)return WebGL2RenderingContext.TEXTURE_3D;throw"whoops"}function v(e,t=0){const s=e;return s.gl_buffer_pages[t/s.pageByteSize|0]}function C(e){return e.gl_texture}function b(e){return e.gl_sampler}function _(e,t){e.name=t,e.__SPECTOR_Metadata={name:t}}function y(e,t){const s=[];for(;;){const n=t.exec(e);if(!n)break;s.push(n)}return s}function S(e){return e.blendMode==o.Id.Add&&e.blendSrcFactor==o.MT.One&&e.blendDstFactor===o.MT.Zero}function w(e,t,s,n){return e%s===0&&t%n===0}!function(e){e[e.NeedsCompile=0]="NeedsCompile",e[e.Compiling=1]="Compiling",e[e.NeedsBind=2]="NeedsBind",e[e.ReadyToUse=3]="ReadyToUse"}(c||(c={}));class A{constructor(){this.liveObjects=new Set,this.creationStacks=new WeakMap,this.deletionStacks=new WeakMap}trackResourceCreated(e){this.creationStacks.set(e,(new Error).stack),this.liveObjects.add(e)}trackResourceDestroyed(e){this.deletionStacks.has(e)&&console.warn("Object double freed:",e,"\n\nCreation stack: ",this.creationStacks.get(e),"\n\nDeletion stack: ",this.deletionStacks.get(e),"\n\nThis stack: ",(new Error).stack),this.deletionStacks.set(e,(new Error).stack),this.liveObjects.delete(e)}checkForLeaks(){for(const e of this.liveObjects.values())console.warn("Object leaked:",e,"Creation stack:",this.creationStacks.get(e))}setResourceLeakCheck(e,t){t?this.liveObjects.add(e):this.liveObjects.delete(e)}}class E{constructor(){this.trackResources=!1,this.shaderDebug=!1}}class R{constructor(e,t){this.gl=e,this._shaderDebug=!1,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._EXT_clip_control=null,this._EXT_texture_compression_rgtc=null,this._EXT_texture_filter_anisotropic=null,this._EXT_texture_norm16=null,this._KHR_parallel_shader_compile=null,this._OES_draw_buffers_indexed=null,this._OES_texture_float_linear=null,this._OES_texture_half_float_linear=null,this._WEBGL_polygon_mode=null,this._WEBGL_provoking_vertex=null,this._scTexture=null,this._scPlatformFramebuffer=null,this._currentActiveTexture=null,this._currentBoundVAO=null,this._currentProgram=null,this._resourceCreationTracker=null,this._resourceUniqueId=0,this._currentColorAttachment=[],this._currentColorAttachmentView=[],this._currentColorResolveTo=[],this._currentColorResolveView=[],this._currentDepthStencilAttachment=null,this._currentDepthStencilAttachmentView=null,this._currentDepthStencilResolveTo=null,this._currentDepthStencilResolveView=null,this._currentSampleCount=-1,this._currentIndexBufferByteOffset=null,this._currentMegaState=(0,u.Ly)(u.bP),this._currentSamplers=[],this._currentTextures=[],this._currentUniformBuffers=[],this._currentUniformBufferByteOffsets=[],this._currentUniformBufferByteSizes=[],this._currentScissorEnabled=!1,this._currentStencilRef=null,this._currentRenderPassDescriptor=null,this._statisticsGroupStack=[],this._resolveColorAttachmentsChanged=!1,this._resolveDepthStencilAttachmentsChanged=!1,this._fallbackTexture2DDepth=void 0,this.platformString="WebGL2",this.glslVersion="#version 300 es",this.explicitBindingLocations=!1,this.separateSamplerTextures=!1,this.viewportOrigin=o.S0.LowerLeft,this.computeShadersSupported=!1,this.wireframeSupported=!1,this._contextAttributes=(0,d.Z1)(e.getContextAttributes()),this._WEBGL_compressed_texture_s3tc=e.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._EXT_clip_control=e.getExtension("EXT_clip_control"),this._EXT_texture_compression_rgtc=e.getExtension("EXT_texture_compression_rgtc"),this._EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic"),this._EXT_texture_norm16=e.getExtension("EXT_texture_norm16"),this._KHR_parallel_shader_compile=e.getExtension("KHR_parallel_shader_compile"),this._OES_texture_float_linear=e.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=e.getExtension("OES_texture_half_float_linear"),this._OES_draw_buffers_indexed=e.getExtension("OES_draw_buffers_indexed"),this._WEBGL_polygon_mode=e.getExtension("WEBGL_polygon_mode"),this._WEBGL_provoking_vertex=e.getExtension("WEBGL_provoking_vertex"),this._uniformBufferMaxPageByteSize=Math.min(e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),65536),null!==this._EXT_clip_control?(this._EXT_clip_control.clipControlEXT(this._EXT_clip_control.LOWER_LEFT_EXT,this._EXT_clip_control.ZERO_TO_ONE_EXT),this.clipSpaceNearZ=o.uA.Zero):this.clipSpaceNearZ=o.uA.NegativeOne,null!==this._WEBGL_provoking_vertex&&this._WEBGL_provoking_vertex.provokingVertexWEBGL(this._WEBGL_provoking_vertex.FIRST_VERTEX_CONVENTION_WEBGL),this._scTexture={_T:n.Texture,dimension:o.bn.n2D,usage:o.Yw.RenderTarget,ResourceUniqueId:this.getNextUniqueId(),width:0,height:0,depthOrArrayLayers:1,numLevels:1,gl_target:null,gl_texture:null,pixelFormat:!1===this._contextAttributes.alpha?l.$Y.U8_RGB_RT:l.$Y.U8_RGBA_RT,formatKind:o.dG.Float},this._resolveColorReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._resolveColorDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._resolveDepthStencilReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._resolveDepthStencilDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._renderPassDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._readbackFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this._fallbackTexture2D=this.createFallbackTexture(o.bn.n2D,o.dG.Float),this._fallbackTexture2DArray=this.createFallbackTexture(o.bn.n2DArray,o.dG.Float),this._fallbackTexture3D=this.createFallbackTexture(o.bn.n3D,o.dG.Float),this._fallbackTextureCube=this.createFallbackTexture(o.bn.Cube,o.dG.Float),this._fallbackVertexBuffer=this.createBuffer(1,o.B6.Vertex,o.R6.Static),this._currentMegaState.depthCompare=o.Ar.Less,this._currentMegaState.depthWrite=!1,this._currentMegaState.attachmentsState[0].channelWriteMask=o.Mk.AllChannels,e.enable(e.DEPTH_TEST),e.enable(e.STENCIL_TEST),this._checkLimits(),this._checkForBugQuirks(),t.shaderDebug&&(this._shaderDebug=!0),t.trackResources&&(this._resourceCreationTracker=new A)}createFallbackTexture(e,t){const s=e===o.bn.Cube?6:1,n=t===o.dG.Depth?l.$Y.D32F:l.$Y.U8_RGBA_NORM,i=this.createTexture({dimension:e,pixelFormat:n,usage:o.Yw.Sampled,width:1,height:1,depthOrArrayLayers:s,numLevels:1});return t===o.dG.Float&&this.uploadTextureData(i,0,[new Uint8Array(4*s)]),C(i)}_checkLimits(){const e=this.gl;this.uniformBufferWordAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)/4,this.uniformBufferMaxPageWordSize=this._uniformBufferMaxPageByteSize/4;const t=e.getInternalformatParameter(e.RENDERBUFFER,e.DEPTH32F_STENCIL8,e.SAMPLES);this.supportedSampleCounts=t?[...t]:[],this.supportedSampleCounts.includes(1)||this.supportedSampleCounts.push(1),this.supportedSampleCounts.sort((e,t)=>e-t),this.occlusionQueriesRecommended=!0,null!==this._WEBGL_polygon_mode&&(this.wireframeSupported=!0)}_checkForBugQuirks(){navigator.userAgent.includes("Firefox")&&(this.occlusionQueriesRecommended=!1)}configureSwapChain(e,t,s){const n=this._scTexture;n.width=e,n.height=t,this._scPlatformFramebuffer=(0,d.g_)(s)}getDevice(){return this}getCanvas(){return this.gl.canvas}getOnscreenTexture(){return this._scTexture}translateTextureInternalFormat(e){switch(e){case l.$Y.F16_R:return WebGL2RenderingContext.R16F;case l.$Y.F16_RG:return WebGL2RenderingContext.RG16F;case l.$Y.F16_RGB:return WebGL2RenderingContext.RGB16F;case l.$Y.F16_RGBA:return WebGL2RenderingContext.RGBA16F;case l.$Y.F32_R:return WebGL2RenderingContext.R32F;case l.$Y.F32_RG:return WebGL2RenderingContext.RG32F;case l.$Y.F32_RGB:return WebGL2RenderingContext.RGB32F;case l.$Y.F32_RGBA:return WebGL2RenderingContext.RGBA32F;case l.$Y.U8_R_NORM:return WebGL2RenderingContext.R8;case l.$Y.U8_RG_NORM:return WebGL2RenderingContext.RG8;case l.$Y.U8_RGB_NORM:case l.$Y.U8_RGB_RT:return WebGL2RenderingContext.RGB8;case l.$Y.U8_RGB_SRGB:return WebGL2RenderingContext.SRGB8;case l.$Y.U8_RGBA_NORM:case l.$Y.U8_RGBA_RT:return WebGL2RenderingContext.RGBA8;case l.$Y.U8_RGBA_SRGB:case l.$Y.U8_RGBA_RT_SRGB:return WebGL2RenderingContext.SRGB8_ALPHA8;case l.$Y.U16_R:return WebGL2RenderingContext.R16UI;case l.$Y.U16_R_NORM:return this._EXT_texture_norm16.R16_EXT;case l.$Y.U16_RG_NORM:return this._EXT_texture_norm16.RG16_EXT;case l.$Y.U16_RGBA_NORM:return this._EXT_texture_norm16.RGBA16_EXT;case l.$Y.U16_RGBA_5551:return WebGL2RenderingContext.RGB5_A1;case l.$Y.U16_RGB_565:return WebGL2RenderingContext.RGB565;case l.$Y.U32_R:return WebGL2RenderingContext.R32UI;case l.$Y.S8_RGBA_NORM:return WebGL2RenderingContext.RGBA8_SNORM;case l.$Y.S8_RG_NORM:return WebGL2RenderingContext.RG8_SNORM;case l.$Y.BC1:return this._WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;case l.$Y.BC1_SRGB:return this._WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case l.$Y.BC2:return this._WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;case l.$Y.BC2_SRGB:return this._WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case l.$Y.BC3:return this._WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;case l.$Y.BC3_SRGB:return this._WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case l.$Y.BC4_UNORM:return this._EXT_texture_compression_rgtc.COMPRESSED_RED_RGTC1_EXT;case l.$Y.BC4_SNORM:return this._EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT;case l.$Y.BC5_UNORM:return this._EXT_texture_compression_rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT;case l.$Y.BC5_SNORM:return this._EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT;case l.$Y.D32F_S8:return WebGL2RenderingContext.DEPTH32F_STENCIL8;case l.$Y.D24_S8:return WebGL2RenderingContext.DEPTH24_STENCIL8;case l.$Y.D32F:return WebGL2RenderingContext.DEPTH_COMPONENT32F;case l.$Y.D24:return WebGL2RenderingContext.DEPTH_COMPONENT24;default:throw"whoops"}}translateTextureFormat(e){if(this.isTextureFormatCompressed(e))return this.translateTextureInternalFormat(e);switch(e){case l.$Y.D24_S8:case l.$Y.D32F_S8:return WebGL2RenderingContext.DEPTH_STENCIL;case l.$Y.D24:case l.$Y.D32F:return WebGL2RenderingContext.DEPTH_COMPONENT}const t=p(e);switch((0,l._z)(e)){case l.wd.R:return t?WebGL2RenderingContext.RED_INTEGER:WebGL2RenderingContext.RED;case l.wd.RG:return t?WebGL2RenderingContext.RG_INTEGER:WebGL2RenderingContext.RG;case l.wd.RGB:return t?WebGL2RenderingContext.RGB_INTEGER:WebGL2RenderingContext.RGB;case l.wd.RGBA:return t?WebGL2RenderingContext.RGBA_INTEGER:WebGL2RenderingContext.RGBA}}translateTextureType(e){switch((0,l.pZ)(e)){case l.np.U8:return WebGL2RenderingContext.UNSIGNED_BYTE;case l.np.U16:return WebGL2RenderingContext.UNSIGNED_SHORT;case l.np.U32:return WebGL2RenderingContext.UNSIGNED_INT;case l.np.S8:return WebGL2RenderingContext.BYTE;case l.np.F16:return WebGL2RenderingContext.HALF_FLOAT;case l.np.F32:return WebGL2RenderingContext.FLOAT;case l.np.U16_PACKED_5551:return WebGL2RenderingContext.UNSIGNED_SHORT_5_5_5_1;case l.np.U16_PACKED_565:return WebGL2RenderingContext.UNSIGNED_SHORT_5_6_5;case l.np.D32F:return WebGL2RenderingContext.FLOAT;case l.np.D24:case l.np.D24S8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case l.np.D32FS8:return WebGL2RenderingContext.FLOAT_32_UNSIGNED_INT_24_8_REV;default:throw"whoops"}}isTextureFormatCompressed(e){switch((0,l.pZ)(e)){case l.np.BC1:case l.np.BC2:case l.np.BC3:case l.np.BC4_UNORM:case l.np.BC4_SNORM:case l.np.BC5_UNORM:case l.np.BC5_SNORM:return!0;default:return!1}}_setActiveTexture(e){this._currentActiveTexture!==e&&(this.gl.activeTexture(e),this._currentActiveTexture=e)}_setVAO(e){this._currentBoundVAO!==e&&(this.gl.bindVertexArray(e),this._currentBoundVAO=e)}_programCompiled(e){(0,d.vA)(e.compileState!==c.NeedsCompile),e.compileState===c.Compiling&&(e.compileState=c.NeedsBind,this._shaderDebug&&this._checkProgramCompilationForErrors(e))}_setProgram(e){const t=e.gl_program;this._currentProgram!==t&&(this._programCompiled(e),this.gl.useProgram(t),this._currentProgram=t)}ensureResourceExists(e){if(null===e){const e=this.gl.getError();throw new Error(`Created resource is null; GL error encountered: ${e}`)}return e}_createBufferPage(e,t,s){const n=this.gl,i=this.ensureResourceExists(n.createBuffer()),r=f(t),a=function(e){switch(e){case o.R6.Static:return WebGL2RenderingContext.STATIC_DRAW;case o.R6.Dynamic:return WebGL2RenderingContext.DYNAMIC_DRAW}}(s);return n.bindBuffer(r,i),n.bufferData(r,e,a),i}getNextUniqueId(){return++this._resourceUniqueId}createBuffer(e,t,s,i){const r=4*e,a=[];let l;if(t===o.B6.Uniform){(0,d.vA)(r%this._uniformBufferMaxPageByteSize===0);let e=r;for(;e>0;)a.push(this._createBufferPage(Math.min(e,this._uniformBufferMaxPageByteSize),t,s)),e-=this._uniformBufferMaxPageByteSize;l=this._uniformBufferMaxPageByteSize}else this.gl.bindVertexArray(null),a.push(this._createBufferPage(r,t,s)),l=r,this.gl.bindVertexArray(this._currentBoundVAO);const h=f(t),c={_T:n.Buffer,ResourceUniqueId:this.getNextUniqueId(),gl_buffer_pages:a,gl_target:h,usage:t,byteSize:r,pageByteSize:l};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(c),void 0!==i&&this.uploadBufferData(c,0,i),c}_createTexture(e){const t=this.gl,s=this.ensureResourceExists(t.createTexture());let i;const r=this.translateTextureInternalFormat(e.pixelFormat);this._setActiveTexture(t.TEXTURE0),this._currentTextures[0]=null;const a=e.numLevels;if(e.dimension===o.bn.n2D)i=WebGL2RenderingContext.TEXTURE_2D,t.bindTexture(i,s),t.texStorage2D(i,a,r,e.width,e.height),(0,d.vA)(1===e.depthOrArrayLayers);else if(e.dimension===o.bn.n2DArray)i=WebGL2RenderingContext.TEXTURE_2D_ARRAY,t.bindTexture(i,s),t.texStorage3D(i,a,r,e.width,e.height,e.depthOrArrayLayers);else if(e.dimension===o.bn.n3D)i=WebGL2RenderingContext.TEXTURE_3D,t.bindTexture(i,s),t.texStorage3D(i,a,r,e.width,e.height,e.depthOrArrayLayers);else{if(e.dimension!==o.bn.Cube)throw"whoops";i=WebGL2RenderingContext.TEXTURE_CUBE_MAP,t.bindTexture(i,s),t.texStorage2D(i,a,r,e.width,e.height),(0,d.vA)(6===e.depthOrArrayLayers)}return{_T:n.Texture,ResourceUniqueId:this.getNextUniqueId(),gl_texture:s,gl_target:i,dimension:e.dimension,pixelFormat:e.pixelFormat,width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers,numLevels:e.numLevels,usage:e.usage,formatKind:(0,l.kk)(e.pixelFormat)}}createTexture(e){const t=this._createTexture(e);return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(t),t}createSampler(e){var t,s;const i=this.gl,r=this.ensureResourceExists(i.createSampler());i.samplerParameteri(r,i.TEXTURE_WRAP_S,g(e.wrapS)),i.samplerParameteri(r,i.TEXTURE_WRAP_T,g(e.wrapT)),i.samplerParameteri(r,i.TEXTURE_WRAP_R,g(null!==(t=e.wrapQ)&&void 0!==t?t:e.wrapS)),i.samplerParameteri(r,i.TEXTURE_MIN_FILTER,T(e.minFilter,e.mipFilter)),i.samplerParameteri(r,i.TEXTURE_MAG_FILTER,T(e.magFilter,o.P.NoMip)),void 0!==e.minLOD&&i.samplerParameterf(r,i.TEXTURE_MIN_LOD,e.minLOD),void 0!==e.maxLOD&&i.samplerParameterf(r,i.TEXTURE_MAX_LOD,e.maxLOD),void 0!==e.compareMode&&(i.samplerParameteri(r,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE),i.samplerParameteri(r,i.TEXTURE_COMPARE_FUNC,e.compareMode));const a=null!==(s=e.maxAnisotropy)&&void 0!==s?s:1;a>1&&null!==this._EXT_texture_filter_anisotropic&&((0,d.vA)(e.minFilter===o.gD.Bilinear&&e.magFilter===o.gD.Bilinear&&e.mipFilter===o.P.Linear),i.samplerParameterf(r,this._EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a));const l={_T:n.Sampler,ResourceUniqueId:this.getNextUniqueId(),gl_sampler:r};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(l),l}createRenderTarget(e){const{pixelFormat:t,width:s,height:i,sampleCount:r}=e,a=this.gl,o=this.ensureResourceExists(a.createRenderbuffer());a.bindRenderbuffer(a.RENDERBUFFER,o),a.renderbufferStorageMultisample(a.RENDERBUFFER,r,this.translateTextureInternalFormat(t),s,i);const l={_T:n.RenderTarget,ResourceUniqueId:this.getNextUniqueId(),gl_renderbuffer:o,gfxTexture:null,pixelFormat:t,width:s,height:i,sampleCount:r};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(l),l}createRenderTargetFromTexture(e){const{pixelFormat:t,width:s,height:i}=e,r={_T:n.RenderTarget,ResourceUniqueId:this.getNextUniqueId(),gl_renderbuffer:null,gfxTexture:e,pixelFormat:t,width:s,height:i,sampleCount:1};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(r),r}_createProgram(e){const t=this.gl,s=this.ensureResourceExists(t.createProgram()),i=c.NeedsCompile,r={_T:n.Program,ResourceUniqueId:this.getNextUniqueId(),descriptor:e,compileState:i,gl_program:s,gl_shader_vert:null,gl_shader_frag:null};return this._tryCompileProgram(r),r}createComputeProgram(e){throw"whoops"}createProgramSimple(e){const t=this._createProgram(e);return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(t),t}createBindings(e){const{bindingLayout:t,uniformBufferBindings:s,samplerBindings:i}=e;(0,d.vA)(s.length>=t.numUniformBuffers),(0,d.vA)(i.length>=t.numSamplers);for(let e=0;e<t.numUniformBuffers;e++)(0,d.vA)(s[e].wordCount>0);const r={_T:n.Bindings,ResourceUniqueId:this.getNextUniqueId(),uniformBufferBindings:s,samplerBindings:i};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(r),r}createInputLayout(e){const{vertexAttributeDescriptors:t,vertexBufferDescriptors:s,indexBufferFormat:i}=e;(0,d.vA)(i===l.$Y.U16_R||i===l.$Y.U32_R||null===i);const r=null!==i?function(e){switch(e){case l.$Y.U8_R:return WebGL2RenderingContext.UNSIGNED_BYTE;case l.$Y.U16_R:return WebGL2RenderingContext.UNSIGNED_SHORT;case l.$Y.U32_R:return WebGL2RenderingContext.UNSIGNED_INT;default:throw"whoops"}}(i):null,a=null!==i?(0,l.Su)(i):null,h=this.gl,c=this.ensureResourceExists(h.createVertexArray());h.bindVertexArray(c),h.bindBuffer(h.ARRAY_BUFFER,v(this._fallbackVertexBuffer));const u=[];for(let t=0;t<e.vertexAttributeDescriptors.length;t++){const s=e.vertexAttributeDescriptors[t];p(s.format);const n=(0,d.Z1)(e.vertexBufferDescriptors[s.bufferIndex]),i=m(s.format);u.push(i),h.vertexAttribPointer(s.location,i.size,i.type,i.normalized,0,0),n.frequency===o.er.PerInstance&&h.vertexAttribDivisor(s.location,1),h.enableVertexAttribArray(s.location)}h.bindVertexArray(null);const f={_T:n.InputLayout,ResourceUniqueId:this.getNextUniqueId(),vertexAttributeDescriptors:t,vertexBufferDescriptors:s,vao:c,vertexBufferFormats:u,indexBufferFormat:i,indexBufferType:r,indexBufferCompByteSize:a};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(f),f}createRenderPipeline(e){const t=function(e){let t=0,s=0;const n=[];for(let i=0;i<e.length;i++){const{numUniformBuffers:r,numSamplers:a,samplerEntries:o}=e[i],l=[];void 0!==o&&(0,d.vA)(o.length===a);for(let e=0;e<a;e++){const t=void 0!==o?o[e]:h,{dimension:s,formatKind:n}=t;l.push({gl_target:x(s),formatKind:n})}n.push({firstUniformBuffer:t,numUniformBuffers:r,firstSampler:s,numSamplers:a,samplerEntries:l}),t+=r,s+=a}return{numUniformBuffers:t,numSamplers:s,bindingLayoutTables:n}}(e.bindingLayouts),s=function(e){if(e===o.sP.Triangles)return WebGL2RenderingContext.TRIANGLES;throw new Error("Unknown primitive topology mode")}(e.topology),i=e.program,r=e.inputLayout,a=e.megaStateDescriptor,l=e.colorAttachmentFormats.slice(),c=e.depthStencilAttachmentFormat,u=e.sampleCount,m={_T:n.RenderPipeline,ResourceUniqueId:this.getNextUniqueId(),bindingLayouts:t,drawMode:s,program:i,megaState:a,inputLayout:r,colorAttachmentFormats:l,depthStencilAttachmentFormat:c,sampleCount:u};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(m),m}createComputePipeline(e){throw"whoops"}createReadback(e){const t=this.gl,s=this.ensureResourceExists(t.createBuffer());t.bindBuffer(t.PIXEL_PACK_BUFFER,s),t.bufferData(t.PIXEL_PACK_BUFFER,e,t.STREAM_READ),t.bindBuffer(t.PIXEL_PACK_BUFFER,null);const i={_T:n.Readback,ResourceUniqueId:this.getNextUniqueId(),byteSize:e,gl_buffer:s,gl_sync:null};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(i),i}createQueryPool(e,t){const s=this.gl,i=(0,d.y5)(t,()=>this.ensureResourceExists(s.createQuery())),r=function(e){if(e===o.o8.OcclusionConservative)return WebGL2RenderingContext.ANY_SAMPLES_PASSED_CONSERVATIVE;throw"whoops"}(e),a={_T:n.QueryPool,ResourceUniqueId:this.getNextUniqueId(),gl_query:i,gl_query_type:r};return null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceCreated(a),a}async createWebXRLayer(e){return await this.gl.makeXRCompatible(),new XRWebGLLayer(e,this.gl,{antialias:!1})}destroyBuffer(e){const{gl_buffer_pages:t}=e;for(let e=0;e<t.length;e++)this.gl.deleteBuffer(t[e]);null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}_destroyTexture(e){this.gl.deleteTexture(C(e))}destroyTexture(e){this._destroyTexture(e),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroySampler(e){this.gl.deleteSampler(b(e)),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyRenderTarget(e){const t=e;null!==t.gl_renderbuffer&&this.gl.deleteRenderbuffer(t.gl_renderbuffer),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(t)}destroyProgram(e){const t=e;this.gl.deleteProgram(t.gl_program),this.gl.deleteShader(t.gl_shader_vert),this.gl.deleteShader(t.gl_shader_frag),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyBindings(e){null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyInputLayout(e){const t=e;this._currentBoundVAO===t.vao&&(this.gl.bindVertexArray(null),this._currentBoundVAO=null),this.gl.deleteVertexArray(t.vao),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyComputePipeline(e){null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyRenderPipeline(e){null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyReadback(e){const t=e;null!==t.gl_sync&&this.gl.deleteSync(t.gl_sync),null!==t.gl_buffer&&this.gl.deleteBuffer(t.gl_buffer),null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(e)}destroyQueryPool(e){const t=e;for(let e=0;e<t.gl_query.length;e++)this.gl.deleteQuery(t.gl_query[e]);null!==this._resourceCreationTracker&&this._resourceCreationTracker.trackResourceDestroyed(t)}pipelineQueryReady(e){const t=e;return this.queryProgramReady(t.program)}pipelineForceReady(e){}createRenderPass(e){(0,d.vA)(null===this._currentRenderPassDescriptor),this._currentRenderPassDescriptor=e;const{colorAttachments:t,depthStencilAttachment:s}=e;this._setRenderPassParametersBegin(t.length);for(let e=0;e<t.length;e++)this._setRenderPassParametersColor(e,t[e]);this._setRenderPassParametersDepthStencil(s),this._validateCurrentAttachments();for(let e=0;e<t.length;e++){const s=t[e];if(null===s)continue;const n=s.clearColor;"load"!==n&&this._setRenderPassParametersClearColor(e,n.r,n.g,n.b,n.a)}return null!==s&&this._setRenderPassParametersClearDepthStencil(s.clearDepth,s.clearStencil),this}createComputePass(){throw"whoops"}submitPass(e){(0,d.vA)(e===this),(0,d.vA)(null!==this._currentRenderPassDescriptor),this.endPass(),this._currentRenderPassDescriptor=null}beginFrame(){}endFrame(){const e=this.gl;this._currentMegaState.attachmentsState[0].channelWriteMask!==o.Mk.Alpha&&(e.colorMask(!1,!1,!1,!0),this._currentMegaState.attachmentsState[0].channelWriteMask=o.Mk.Alpha),e.clearBufferfv(e.COLOR,0,[0,0,0,1])}zeroBuffer(e,t,s){this.uploadBufferData(e,t,new Uint8Array(s))}copySubTexture2D(e,t,s,n,i,r){const a=this.gl,o=e,l=n;(0,d.vA)(1===l.numLevels),(0,d.vA)(1===o.numLevels),o===this._scTexture?a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this._scPlatformFramebuffer):(a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this._resolveColorDrawFramebuffer),this._bindFramebufferAttachment(a.DRAW_FRAMEBUFFER,a.COLOR_ATTACHMENT0,o)),a.bindFramebuffer(a.READ_FRAMEBUFFER,this._resolveColorReadFramebuffer),this._bindFramebufferAttachment(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,l),a.blitFramebuffer(i,r,i+l.width,r+l.height,t,s,t+l.width,s+l.height,a.COLOR_BUFFER_BIT,a.LINEAR),a.bindFramebuffer(a.READ_FRAMEBUFFER,null),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,null)}uploadBufferData(e,t,s,n=0,i=s.byteLength-n){const r=this.gl,{gl_target:a,byteSize:o,pageByteSize:l}=e;if(a===r.UNIFORM_BUFFER){if(t%l!==0)throw new Error(`Assert fail: (dstByteOffset [${t}] % dstPageByteSize [${l}]) === 0`);if(i%l!==0)throw new Error(`Assert fail: (byteSize [${i}] % dstPageByteSize [${l}]) === 0`)}if(!(t+i<=o))throw new Error(`Assert fail: (dstByteOffset [${t}] + byteSize [${i}]) <= dstByteSize [${o}], gl_target ${a}`);const h=t+i;let c=t,u=t%l;for(;c<h;)r.bindBuffer(r.COPY_WRITE_BUFFER,v(e,c)),r.bufferSubData(r.COPY_WRITE_BUFFER,u,s,n,Math.min(h-c,l)),c+=l,u=0,n+=l,this._debugGroupStatisticsBufferUpload()}uploadTextureData(e,t,s){const n=this.gl,{gl_texture:i,gl_target:r,pixelFormat:a,width:o,height:l,depthOrArrayLayers:h,numLevels:c}=e,u=this.isTextureFormatCompressed(a),d=r===WebGL2RenderingContext.TEXTURE_3D||r===WebGL2RenderingContext.TEXTURE_2D_ARRAY,m=r===WebGL2RenderingContext.TEXTURE_CUBE_MAP;this._setActiveTexture(n.TEXTURE0),this._currentTextures[0]=null,n.bindTexture(r,i);let p=o,f=l,g=h;const T=Math.min(t+s.length,c),x=this.translateTextureFormat(a);for(let e=0,i=0;e<T;e++){if(e>=t){const t=s[i++],o=t.length/h;if(m)for(let s=0;s<h;s++){const i=WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_X+s%6;if(u)n.compressedTexSubImage2D(i,e,0,0,p,f,x,t,s*o,o);else{const r=this.translateTextureType(a);n.texSubImage2D(i,e,0,0,p,f,x,r,t,s*o)}}else if(d)if(u)n.compressedTexSubImage3D(r,e,0,0,0,p,f,g,x,t);else{const s=this.translateTextureType(a);n.texSubImage3D(r,e,0,0,0,p,f,g,x,s,t)}else if(u)n.compressedTexSubImage2D(r,e,0,0,p,f,x,t);else{const s=this.translateTextureType(a);n.texSubImage2D(r,e,0,0,p,f,x,s,t)}}p=Math.max(p/2|0,1),f=Math.max(f/2|0,1)}}readBuffer(e,t,s,n,i){const r=this.gl,a=e,o=s,l=n+i;for((0,d.vA)(l<=o.byteSize),(0,d.vA)(t+i<=a.byteSize);n<l;){const e=n/o.pageByteSize|0,s=n-e*o.pageByteSize,i=o.pageByteSize-s;r.bindBuffer(r.COPY_READ_BUFFER,o.gl_buffer_pages[e]),r.bindBuffer(r.COPY_WRITE_BUFFER,a.gl_buffer),r.copyBufferSubData(r.COPY_READ_BUFFER,r.COPY_WRITE_BUFFER,s,t,i),n+=i,t+=i}r.bindBuffer(r.COPY_READ_BUFFER,null),r.bindBuffer(r.COPY_WRITE_BUFFER,null)}readPixelFromTexture(e,t,s,n,i){const r=this.gl,a=e;r.bindFramebuffer(r.READ_FRAMEBUFFER,this._readbackFramebuffer);const o=s;r.framebufferTexture2D(r.READ_FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,o.gl_texture,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,a.gl_buffer);const h=this.translateTextureFormat(o.pixelFormat),c=this.translateTextureType(o.pixelFormat),u=(0,l.$U)(o.pixelFormat);r.readPixels(n,i,1,1,h,c,t*u),r.bindBuffer(r.PIXEL_PACK_BUFFER,null)}submitReadback(e){const t=this.gl,s=e;null!==s.gl_sync&&t.deleteSync(s.gl_sync),s.gl_sync=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0)}queryReadbackFinished(e,t,s){const n=this.gl,i=s,r=(0,d.Z1)(i.gl_sync);return n.getSyncParameter(r,n.SYNC_STATUS)===n.SIGNALED&&(n.bindBuffer(n.PIXEL_UNPACK_BUFFER,i.gl_buffer),n.getBufferSubData(n.PIXEL_UNPACK_BUFFER,0,e,t),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),!0)}queryPoolResultOcclusion(e,t){const s=this.gl,n=e.gl_query[t];return s.getQueryParameter(n,s.QUERY_RESULT_AVAILABLE)?!!s.getQueryParameter(n,s.QUERY_RESULT):null}queryLimits(){return this}queryTextureFormatSupported(e,t,s){switch(e){case l.$Y.BC1_SRGB:case l.$Y.BC2_SRGB:case l.$Y.BC3_SRGB:return null!==this._WEBGL_compressed_texture_s3tc_srgb&&w(t,s,4,4);case l.$Y.BC1:case l.$Y.BC2:case l.$Y.BC3:return null!==this._WEBGL_compressed_texture_s3tc&&w(t,s,4,4);case l.$Y.BC4_UNORM:case l.$Y.BC4_SNORM:case l.$Y.BC5_UNORM:case l.$Y.BC5_SNORM:return null!==this._EXT_texture_compression_rgtc&&w(t,s,4,4);case l.$Y.U16_R_NORM:case l.$Y.U16_RG_NORM:case l.$Y.U16_RGBA_NORM:return null!==this._EXT_texture_norm16;case l.$Y.F32_R:case l.$Y.F32_RG:case l.$Y.F32_RGB:case l.$Y.F32_RGBA:return null!==this._OES_texture_float_linear;case l.$Y.F16_R:case l.$Y.F16_RG:case l.$Y.F16_RGB:case l.$Y.F16_RGBA:return null!==this._OES_texture_half_float_linear;default:return!0}}queryProgramReady(e){const t=this.gl;if(e.compileState===c.NeedsCompile)throw"whoops";if(e.compileState===c.Compiling){let s;return s=null===this._KHR_parallel_shader_compile||t.getProgramParameter(e.gl_program,this._KHR_parallel_shader_compile.COMPLETION_STATUS_KHR),s&&this._programCompiled(e),s}return e.compileState===c.NeedsBind||e.compileState===c.ReadyToUse}queryVendorInfo(){return this}queryRenderPass(e){return this._currentRenderPassDescriptor}queryRenderTarget(e){return e}setResourceName(e,t){if(e.ResourceName=t,e._T===n.Buffer){const{gl_buffer_pages:s}=e;for(let e=0;e<s.length;e++)_(s[e],`${t} Page ${e}`)}else if(e._T===n.Texture)_(C(e),t);else if(e._T===n.Sampler)_(b(e),t);else if(e._T===n.RenderTarget){const{gl_renderbuffer:s}=e;null!==s&&_(s,t)}else e._T===n.InputLayout&&_(e.vao,t)}setResourceLeakCheck(e,t){null!==this._resourceCreationTracker&&this._resourceCreationTracker.setResourceLeakCheck(e,t)}checkForLeaks(){null!==this._resourceCreationTracker&&this._resourceCreationTracker.checkForLeaks()}pushStatisticsGroup(e){this._statisticsGroupStack.push(e)}popStatisticsGroup(){this._statisticsGroupStack.pop()}programPatched(e,t){(0,d.vA)(this._shaderDebug);const s=e,n=this.gl;n.deleteProgram(s.gl_program),s.descriptor=t,s.gl_program=this.ensureResourceExists(n.createProgram()),s.compileState=c.NeedsCompile,this._tryCompileProgram(s),this._checkProgramCompilationForErrors(s)}getBufferData(e,t,s=0){const n=this.gl;n.bindBuffer(n.COPY_READ_BUFFER,v(e,4*s)),n.getBufferSubData(n.COPY_READ_BUFFER,4*s,t)}_debugGroupStatisticsDrawCall(e=1){for(let t=this._statisticsGroupStack.length-1;t>=0;t--)this._statisticsGroupStack[t].drawCallCount+=e}_debugGroupStatisticsBufferUpload(e=1){for(let t=this._statisticsGroupStack.length-1;t>=0;t--)this._statisticsGroupStack[t].bufferUploadCount+=e}_debugGroupStatisticsTextureBind(e=1){for(let t=this._statisticsGroupStack.length-1;t>=0;t--)this._statisticsGroupStack[t].textureBindCount+=e}_debugGroupStatisticsTriangles(e){for(let t=this._statisticsGroupStack.length-1;t>=0;t--)this._statisticsGroupStack[t].triangleCount+=e}_compileShader(e,t){const s=this.gl,n=this.ensureResourceExists(s.createShader(t));return s.shaderSource(n,e),s.compileShader(n),n}_reportShaderError(e,t){const s=this.gl,n=s.getShaderParameter(e,s.COMPILE_STATUS);if(!n){console.error(function(e,t=1){return e.split("\n").map((e,s)=>`${(0,d.PX)(""+(t+s),4," ")}  ${e}`).join("\n")}(t));const n=s.getExtension("WEBGL_debug_shaders");n&&console.error(n.getTranslatedShaderSource(e)),console.error(s.getShaderInfoLog(e))}return n}_checkProgramCompilationForErrors(e){const t=this.gl,s=e.gl_program;if(!t.getProgramParameter(s,t.LINK_STATUS)){const s=e.descriptor;if(!this._reportShaderError(e.gl_shader_vert,s.preprocessedVert))return;if(null!==e.gl_shader_frag&&!this._reportShaderError(e.gl_shader_frag,s.preprocessedFrag))return;console.error(t.getProgramInfoLog(e.gl_program))}}_tryCompileProgram(e){(0,d.vA)(e.compileState===c.NeedsCompile);const t=e.descriptor,s=this.gl;null!==e.gl_shader_vert&&s.deleteShader(e.gl_shader_vert),null!==e.gl_shader_frag&&s.deleteShader(e.gl_shader_frag),e.gl_shader_vert=this._compileShader(t.preprocessedVert,s.VERTEX_SHADER),s.attachShader(e.gl_program,e.gl_shader_vert),null!==t.preprocessedFrag&&(e.gl_shader_frag=this._compileShader(t.preprocessedFrag,s.FRAGMENT_SHADER),s.attachShader(e.gl_program,e.gl_shader_frag)),s.linkProgram(e.gl_program),e.compileState=c.Compiling}_getTextureFramebufferTarget(e,t){const s=this.gl,n=e;if(n.gl_target===s.TEXTURE_2D)return(0,d.vA)(0===t),s.TEXTURE_2D;if(n.gl_target===s.TEXTURE_CUBE_MAP)return(0,d.vA)(t<6),s.TEXTURE_CUBE_MAP_POSITIVE_X+t;throw"whoops"}_bindFramebufferAttachment(e,t,s,i=null){const r=this.gl,a=null!==i?i.level:0,o=null!==i?i.z:0;null===s?r.framebufferRenderbuffer(e,t,r.RENDERBUFFER,null):s._T===n.RenderTarget?null!==s.gl_renderbuffer?r.framebufferRenderbuffer(e,t,r.RENDERBUFFER,s.gl_renderbuffer):null!==s.gfxTexture&&r.framebufferTexture2D(e,t,this._getTextureFramebufferTarget(s.gfxTexture,o),C(s.gfxTexture),a):s._T===n.Texture&&r.framebufferTexture2D(e,t,this._getTextureFramebufferTarget(s,o),C(s),a)}_bindFramebufferDepthStencilAttachment(e,t){const s=this.gl,n=null!==t?(0,l.vg)(t.pixelFormat):l.lk.Depth|l.lk.Stencil,i=!!(n&l.lk.Depth),r=!!(n&l.lk.Stencil);i&&r?this._bindFramebufferAttachment(e,s.DEPTH_STENCIL_ATTACHMENT,t):i?(this._bindFramebufferAttachment(e,s.DEPTH_ATTACHMENT,t),this._bindFramebufferAttachment(e,s.STENCIL_ATTACHMENT,null)):r&&(this._bindFramebufferAttachment(e,s.STENCIL_ATTACHMENT,t),this._bindFramebufferAttachment(e,s.DEPTH_ATTACHMENT,null))}_validateCurrentAttachments(){let e=-1,t=-1,s=-1;for(let n=0;n<this._currentColorAttachment.length;n++){const i=this._currentColorAttachment[n];null!==i&&(-1===e?(e=i.sampleCount,t=i.width,s=i.height):((0,d.vA)(e===i.sampleCount),(0,d.vA)(t===i.width),(0,d.vA)(s===i.height)))}this._currentSampleCount=e}_setRenderPassParametersBegin(e){const t=this.gl;t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._renderPassDrawFramebuffer),t.drawBuffers([t.COLOR_ATTACHMENT0,t.COLOR_ATTACHMENT1,t.COLOR_ATTACHMENT2,t.COLOR_ATTACHMENT3]);for(let s=e;s<this._currentColorAttachment.length;s++){const e=this._currentColorAttachment[s];e&&(null!==e.gl_renderbuffer?t.framebufferRenderbuffer(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+s,t.RENDERBUFFER,null):null!==e.gfxTexture&&t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+s,t.TEXTURE_2D,null,0),this._currentColorAttachment[s]=null)}this._currentColorAttachment.length=e;for(let t=this._currentMegaState.attachmentsState.length;t<e;t++)this._currentMegaState.attachmentsState[t]=(0,u.w)(void 0,u.bP.attachmentsState[0])}_setRenderPassParametersColor(e,t){const s=this.gl,n=null!==t?t.renderTarget:null,i=null!==t?t.view:null;(0,d.vA)(!!n==!!i),this._currentColorAttachment[e]===n&&(0,d.PB)(this._currentColorAttachmentView[e],i)||(this._currentColorAttachment[e]=n,this._currentColorAttachmentView[e]=i,this._bindFramebufferAttachment(s.DRAW_FRAMEBUFFER,s.COLOR_ATTACHMENT0+e,n,i),this._resolveColorAttachmentsChanged=!0);const r=null!==t?t.resolveTo:null,a=null!==t?t.resolveView:null;(0,d.vA)(!!r==!!a),this._currentColorResolveTo[e]===r&&this._currentColorResolveView[e]===a||(this._currentColorResolveTo[e]=r,this._currentColorResolveView[e]=a,null!==r&&(this._resolveColorAttachmentsChanged=!0))}_setRenderPassParametersDepthStencil(e){const t=this.gl,s=null!==e?e.renderTarget:null;null!==e&&e.view,this._currentDepthStencilAttachment!==s&&(this._currentDepthStencilAttachment=s,this._bindFramebufferDepthStencilAttachment(t.DRAW_FRAMEBUFFER,this._currentDepthStencilAttachment),this._resolveDepthStencilAttachmentsChanged=!0);const n=null!==e?e.resolveTo:null;null!==e&&e.resolveView,this._currentDepthStencilResolveTo!==n&&(this._currentDepthStencilResolveTo=n,null!==n&&(this._resolveDepthStencilAttachmentsChanged=!0))}_setScissorEnabled(e){if(this._currentScissorEnabled===e)return;const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this._currentScissorEnabled=e}_setRenderPassParametersClearColor(e,t,s,n,i){const r=this.gl;if(null!==this._OES_draw_buffers_indexed){const t=this._currentMegaState.attachmentsState[e];t.channelWriteMask!==o.Mk.AllChannels&&(this._OES_draw_buffers_indexed.colorMaskiOES(e,!0,!0,!0,!0),t.channelWriteMask=o.Mk.AllChannels)}else{const e=this._currentMegaState.attachmentsState[0];e.channelWriteMask!==o.Mk.AllChannels&&(r.colorMask(!0,!0,!0,!0),e.channelWriteMask=o.Mk.AllChannels)}this._setScissorEnabled(!1),r.clearBufferfv(r.COLOR,e,[t,s,n,i])}_setRenderPassParametersClearDepthStencil(e,t){const s=this.gl;"load"!==e&&((0,d.vA)(null!==this._currentDepthStencilAttachment),this._currentMegaState.depthWrite||(s.depthMask(!0),this._currentMegaState.depthWrite=!0),s.clearBufferfv(s.DEPTH,0,[e])),"load"!==t&&((0,d.vA)(null!==this._currentDepthStencilAttachment),this._currentMegaState.stencilWrite||(s.stencilMask(255),this._currentMegaState.stencilWrite=!0),s.clearBufferiv(s.STENCIL,0,[t]))}_getFallbackTexture(e){const t=this.gl,s=e.gl_target,n=e.formatKind;if(s===t.TEXTURE_2D&&n===o.dG.Depth)return this._fallbackTexture2DDepth;if(s===t.TEXTURE_2D)return this._fallbackTexture2D;if(s===t.TEXTURE_2D_ARRAY)return this._fallbackTexture2DArray;if(s===t.TEXTURE_3D)return this._fallbackTexture3D;if(s===t.TEXTURE_CUBE_MAP)return this._fallbackTextureCube;throw"whoops"}setBindings(e,t,s){const n=this.gl;(0,d.vA)(e<this._currentPipeline.bindingLayouts.bindingLayoutTables.length);const i=this._currentPipeline.bindingLayouts.bindingLayoutTables[e],{uniformBufferBindings:r,samplerBindings:a}=t;(0,d.vA)(r.length>=i.numUniformBuffers),(0,d.vA)(s.length>=i.numUniformBuffers),(0,d.vA)(a.length>=i.numSamplers);for(let e=0;e<i.numUniformBuffers;e++){const t=r[e];if(0===t.wordCount)continue;const a=i.firstUniformBuffer+e,o=t.buffer,l=s[e],h=4*t.wordCount;if(o!==this._currentUniformBuffers[a]||l!==this._currentUniformBufferByteOffsets[a]||h!==this._currentUniformBufferByteSizes[a]){const e=l%o.pageByteSize,t=o.gl_buffer_pages[l/o.pageByteSize|0];(0,d.vA)(e+h<=o.pageByteSize),n.bindBufferRange(n.UNIFORM_BUFFER,a,t,e,h),this._currentUniformBuffers[a]=o,this._currentUniformBufferByteOffsets[a]=l,this._currentUniformBufferByteSizes[a]=h}}for(let e=0;e<i.numSamplers;e++){const t=a[e],s=i.firstSampler+e,r=i.samplerEntries[e],o=null!==t?t.gfxTexture:null,l=null!==o?C(o):null,h=null!==t&&null!==t.gfxSampler?b(t.gfxSampler):null;if(this._currentSamplers[s]!==h&&(n.bindSampler(s,h),this._currentSamplers[s]=h),this._currentTextures[s]!==l){if(this._setActiveTexture(n.TEXTURE0+s),null!==o){const{gl_target:e,formatKind:t}=o;n.bindTexture(e,l),this._debugGroupStatisticsTextureBind(),(0,d.vA)(r.gl_target===e),(0,d.vA)(r.formatKind===t)}else n.bindTexture(r.gl_target,this._getFallbackTexture(r));this._currentTextures[s]=l}}}setViewport(e,t,s,n){this.gl.viewport(e,t,s,n)}setScissor(e,t,s,n){const i=this.gl;this._setScissorEnabled(!0),i.scissor(e,t,s,n)}_setAttachmentStateIndexed(e,t){const s=this.gl,n=this._OES_draw_buffers_indexed,i=this._currentMegaState.attachmentsState[e];i.channelWriteMask!==t.channelWriteMask&&(n.colorMaskiOES(e,!!(t.channelWriteMask&o.Mk.Red),!!(t.channelWriteMask&o.Mk.Green),!!(t.channelWriteMask&o.Mk.Blue),!!(t.channelWriteMask&o.Mk.Alpha)),i.channelWriteMask=t.channelWriteMask);const r=i.rgbBlendState.blendMode!==t.rgbBlendState.blendMode||i.alphaBlendState.blendMode!==t.alphaBlendState.blendMode,a=i.rgbBlendState.blendSrcFactor!==t.rgbBlendState.blendSrcFactor||i.alphaBlendState.blendSrcFactor!==t.alphaBlendState.blendSrcFactor||i.rgbBlendState.blendDstFactor!==t.rgbBlendState.blendDstFactor||i.alphaBlendState.blendDstFactor!==t.alphaBlendState.blendDstFactor,l=S(t.rgbBlendState)&&S(t.alphaBlendState);(a||r)&&(S(i.rgbBlendState)&&S(i.alphaBlendState)?n.enableiOES(s.BLEND,e):l&&n.disableiOES(s.BLEND,e)),r&&(n.blendEquationSeparateiOES(e,t.rgbBlendState.blendMode,t.alphaBlendState.blendMode),i.rgbBlendState.blendMode=t.rgbBlendState.blendMode,i.alphaBlendState.blendMode=t.alphaBlendState.blendMode),a&&(n.blendFuncSeparateiOES(e,t.rgbBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor,t.alphaBlendState.blendSrcFactor,t.alphaBlendState.blendDstFactor),i.rgbBlendState.blendSrcFactor=t.rgbBlendState.blendSrcFactor,i.alphaBlendState.blendSrcFactor=t.alphaBlendState.blendSrcFactor,i.rgbBlendState.blendDstFactor=t.rgbBlendState.blendDstFactor,i.alphaBlendState.blendDstFactor=t.alphaBlendState.blendDstFactor)}_setAttachmentState(e){const t=this.gl,s=this._currentMegaState.attachmentsState[0];s.channelWriteMask!==e.channelWriteMask&&(t.colorMask(!!(e.channelWriteMask&o.Mk.Red),!!(e.channelWriteMask&o.Mk.Green),!!(e.channelWriteMask&o.Mk.Blue),!!(e.channelWriteMask&o.Mk.Alpha)),s.channelWriteMask=e.channelWriteMask);const n=s.rgbBlendState.blendMode!==e.rgbBlendState.blendMode||s.alphaBlendState.blendMode!==e.alphaBlendState.blendMode,i=s.rgbBlendState.blendSrcFactor!==e.rgbBlendState.blendSrcFactor||s.alphaBlendState.blendSrcFactor!==e.alphaBlendState.blendSrcFactor||s.rgbBlendState.blendDstFactor!==e.rgbBlendState.blendDstFactor||s.alphaBlendState.blendDstFactor!==e.alphaBlendState.blendDstFactor;(i||n)&&(S(s.rgbBlendState)&&S(s.alphaBlendState)?t.enable(t.BLEND):S(e.rgbBlendState)&&S(e.alphaBlendState)&&t.disable(t.BLEND)),n&&(t.blendEquationSeparate(e.rgbBlendState.blendMode,e.alphaBlendState.blendMode),s.rgbBlendState.blendMode=e.rgbBlendState.blendMode,s.alphaBlendState.blendMode=e.alphaBlendState.blendMode),i&&(t.blendFuncSeparate(e.rgbBlendState.blendSrcFactor,e.rgbBlendState.blendDstFactor,e.alphaBlendState.blendSrcFactor,e.alphaBlendState.blendDstFactor),s.rgbBlendState.blendSrcFactor=e.rgbBlendState.blendSrcFactor,s.alphaBlendState.blendSrcFactor=e.alphaBlendState.blendSrcFactor,s.rgbBlendState.blendDstFactor=e.rgbBlendState.blendDstFactor,s.alphaBlendState.blendDstFactor=e.alphaBlendState.blendDstFactor)}_applyStencil(){null!==this._currentStencilRef&&this.gl.stencilFunc(this._currentMegaState.stencilCompare,this._currentStencilRef,255)}_setMegaState(e){const t=this.gl,s=this._currentMegaState;if(null!==this._OES_draw_buffers_indexed){(0,d.vA)(1===e.attachmentsState.length||e.attachmentsState.length>=this._currentColorAttachment.length);for(let t=0;t<this._currentColorAttachment.length;t++){if(null===this._currentColorAttachment[t])continue;const s=1===e.attachmentsState.length?e.attachmentsState[0]:e.attachmentsState[t];this._setAttachmentStateIndexed(t,s)}}else(0,d.vA)(1===e.attachmentsState.length),this._setAttachmentState(e.attachmentsState[0]);(0,d.f$)(s.blendConstant,e.blendConstant)||(t.blendColor(e.blendConstant.r,e.blendConstant.g,e.blendConstant.b,e.blendConstant.a),(0,d.EQ)(s.blendConstant,e.blendConstant)),s.depthCompare!==e.depthCompare&&(t.depthFunc(e.depthCompare),s.depthCompare=e.depthCompare),s.depthWrite!==e.depthWrite&&(t.depthMask(e.depthWrite),s.depthWrite=e.depthWrite),s.stencilCompare!==e.stencilCompare&&(s.stencilCompare=e.stencilCompare,this._applyStencil()),s.stencilWrite!==e.stencilWrite&&(t.stencilMask(e.stencilWrite?255:0),s.stencilWrite=e.stencilWrite),s.stencilWrite&&s.stencilPassOp!==e.stencilPassOp&&(t.stencilOp(t.KEEP,t.KEEP,e.stencilPassOp),s.stencilPassOp=e.stencilPassOp),s.cullMode!==e.cullMode&&(s.cullMode===o.js.None?t.enable(t.CULL_FACE):e.cullMode===o.js.None&&t.disable(t.CULL_FACE),e.cullMode===o.js.Back?t.cullFace(t.BACK):e.cullMode===o.js.Front?t.cullFace(t.FRONT):e.cullMode===o.js.FrontAndBack&&t.cullFace(t.FRONT_AND_BACK),s.cullMode=e.cullMode),s.frontFace!==e.frontFace&&(t.frontFace(e.frontFace),s.frontFace=e.frontFace),s.polygonOffset!==e.polygonOffset&&(e.polygonOffset?(t.polygonOffset(1,1),t.enable(t.POLYGON_OFFSET_FILL)):t.disable(t.POLYGON_OFFSET_FILL),s.polygonOffset=e.polygonOffset),s.wireframe!==e.wireframe&&((0,d.vA)(this.wireframeSupported||!s.wireframe),e.wireframe?this._WEBGL_polygon_mode.polygonModeWEBGL(t.FRONT_AND_BACK,this._WEBGL_polygon_mode.LINE_WEBGL):this._WEBGL_polygon_mode.polygonModeWEBGL(t.FRONT_AND_BACK,this._WEBGL_polygon_mode.FILL_WEBGL),s.wireframe=e.wireframe)}_validatePipelineFormats(e){for(let t=0;t<this._currentColorAttachment.length;t++){const s=this._currentColorAttachment[t];null!==s&&(0,d.vA)(s.pixelFormat===e.colorAttachmentFormats[t])}null!==this._currentDepthStencilAttachment&&(0,d.vA)(this._currentDepthStencilAttachment.pixelFormat===e.depthStencilAttachmentFormat),-1!==this._currentSampleCount&&(0,d.vA)(this._currentSampleCount===e.sampleCount)}setPipeline(e){this._currentPipeline=e,this._validatePipelineFormats(this._currentPipeline),this._setMegaState(this._currentPipeline.megaState);const t=this._currentPipeline.program;if(this._setProgram(t),t.compileState===c.NeedsBind){const e=this.gl,s=t.gl_program,n=t.descriptor,i=y(n.preprocessedVert,/uniform (\w+) {([^]*?)}/g);for(let t=0;t<i.length;t++){const[n,r,a]=i[t],o=e.getUniformBlockIndex(s,r);-1!==o&&4294967295!==o&&e.uniformBlockBinding(s,o,t)}const r=y(n.preprocessedVert,/^uniform .*sampler\S+ (\w+);\s* \/\/ BINDING=(\d+)$/gm);for(let t=0;t<r.length;t++){const[n,i,a]=r[t],o=e.getUniformLocation(s,i);e.uniform1i(o,parseInt(a))}t.compileState=c.ReadyToUse}}setVertexInput(e,t,s){if(null!==e){(0,d.vA)(this._currentPipeline.inputLayout===e);const n=e;this._setVAO(n.vao);const i=this.gl;for(let e=0;e<n.vertexAttributeDescriptors.length;e++){const s=n.vertexAttributeDescriptors[e],r=t[s.bufferIndex];if(null===r)continue;i.bindBuffer(i.ARRAY_BUFFER,v(r.buffer));const a=r.byteOffset+s.bufferByteOffset,o=n.vertexBufferFormats[e],l=n.vertexBufferDescriptors[s.bufferIndex];i.vertexAttribPointer(s.location,o.size,o.type,o.normalized,l.byteStride,a)}if((0,d.vA)(null!==s==(null!==n.indexBufferFormat)),null!==s){const e=s.buffer;(0,d.vA)(e.usage===o.B6.Index),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,v(e)),this._currentIndexBufferByteOffset=s.byteOffset}else this._currentIndexBufferByteOffset=null}else(0,d.vA)(null===this._currentPipeline.inputLayout),(0,d.vA)(null===s),this._setVAO(null),this._currentIndexBufferByteOffset=0}setStencilRef(e){this._currentStencilRef!==e&&(this._currentStencilRef=e,this._applyStencil())}draw(e,t){const s=this.gl,n=this._currentPipeline;s.drawArrays(n.drawMode,t,e),this._debugGroupStatisticsDrawCall(),this._debugGroupStatisticsTriangles(e/3)}drawIndexed(e,t){const s=this.gl,n=this._currentPipeline,i=(0,d.Z1)(n.inputLayout),r=(0,d.Z1)(this._currentIndexBufferByteOffset)+t*i.indexBufferCompByteSize;s.drawElements(n.drawMode,e,i.indexBufferType,r),this._debugGroupStatisticsDrawCall(),this._debugGroupStatisticsTriangles(e/3)}drawIndexedInstanced(e,t,s){const n=this.gl,i=this._currentPipeline,r=(0,d.Z1)(i.inputLayout),a=(0,d.Z1)(this._currentIndexBufferByteOffset)+t*r.indexBufferCompByteSize;n.drawElementsInstanced(i.drawMode,e,r.indexBufferType,a,s),this._debugGroupStatisticsDrawCall(),this._debugGroupStatisticsTriangles(e/3*s)}beginOcclusionQuery(e){const t=this.gl,s=this._currentRenderPassDescriptor.occlusionQueryPool;t.beginQuery(s.gl_query_type,s.gl_query[e])}endOcclusionQuery(){const e=this.gl,t=this._currentRenderPassDescriptor.occlusionQueryPool;e.endQuery(t.gl_query_type)}beginDebugGroup(e){}endDebugGroup(){}endPass(){const e=this.gl,t=this._currentRenderPassDescriptor;for(let s=0;s<this._currentColorAttachment.length;s++){const n=this._currentColorAttachment[s];if(null!==n){const i=this._currentColorResolveTo[s],r=t.colorAttachments[s].store,a=null!==i||!r;if(a&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,this._resolveColorReadFramebuffer),this._resolveColorAttachmentsChanged&&this._bindFramebufferAttachment(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,n,this._currentColorAttachmentView[s])),null!==i){if((0,d.vA)(n.width===i.width&&n.height===i.height),(0,d.vA)(n.pixelFormat===i.pixelFormat),this._setScissorEnabled(!1),i===this._scTexture)e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._scPlatformFramebuffer);else if(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._resolveColorDrawFramebuffer),this._resolveColorAttachmentsChanged){const t=(0,d.Z1)(this._currentColorResolveView[s]);e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,this._getTextureFramebufferTarget(i,t.z),i.gl_texture,t.level)}e.blitFramebuffer(0,0,n.width,n.height,0,0,i.width,i.height,e.COLOR_BUFFER_BIT,e.LINEAR)}r||e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[e.COLOR_ATTACHMENT0]),a&&e.bindFramebuffer(e.READ_FRAMEBUFFER,null)}}this._resolveColorAttachmentsChanged=!1;const s=this._currentDepthStencilAttachment;if(null!==s){const n=this._currentDepthStencilResolveTo,i=t.depthStencilAttachment.store,r=null!==n||!i;r&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,this._resolveDepthStencilReadFramebuffer),this._resolveDepthStencilAttachmentsChanged&&this._bindFramebufferDepthStencilAttachment(e.READ_FRAMEBUFFER,s)),null!==n&&((0,d.vA)(s.width===n.width&&s.height===n.height),this._setScissorEnabled(!1),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._resolveDepthStencilDrawFramebuffer),this._resolveDepthStencilAttachmentsChanged&&this._bindFramebufferDepthStencilAttachment(e.DRAW_FRAMEBUFFER,n),e.blitFramebuffer(0,0,s.width,s.height,0,0,n.width,n.height,e.DEPTH_BUFFER_BIT,e.NEAREST)),i||e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[e.DEPTH_STENCIL_ATTACHMENT]),r&&e.bindFramebuffer(e.READ_FRAMEBUFFER,null),this._resolveDepthStencilAttachmentsChanged=!1}e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)}}var I=s(2466),k=s(1413);function M(e){if(e===o.Vf.Clamp)return"clamp-to-edge";if(e===o.Vf.Repeat)return"repeat";if(e===o.Vf.Mirror)return"mirror-repeat";throw"whoops"}function P(e){if(e===o.gD.Bilinear)return"linear";if(e===o.gD.Point)return"nearest";throw"whoops"}function D(e){if(e===o.P.Linear)return"linear";if(e===o.P.Nearest)return"nearest";if(e===o.P.NoMip)return"nearest";throw"whoops"}function B(e){if(e===o.$Y.U8_R_NORM)return"r8unorm";if(e===o.$Y.U8_RG_NORM)return"rg8unorm";if(e===o.$Y.U8_RGBA_RT)return"bgra8unorm";if(e===o.$Y.U8_RGBA_RT_SRGB)return"bgra8unorm-srgb";if(e===o.$Y.U8_RGBA_NORM)return"rgba8unorm";if(e===o.$Y.U8_RGBA_SRGB)return"rgba8unorm-srgb";if(e===o.$Y.S8_R_NORM)return"r8snorm";if(e===o.$Y.S8_RG_NORM)return"rg8snorm";if(e===o.$Y.S8_RGBA_NORM)return"rgba8snorm";if(e===o.$Y.U32_R)return"r32uint";if(e===o.$Y.F16_RGBA)return"rgba16float";if(e===o.$Y.F32_RGBA)return"rgba32float";if(e===o.$Y.D24)return"depth24plus";if(e===o.$Y.D24_S8)return"depth24plus-stencil8";if(e===o.$Y.D32F)return"depth32float";if(e===o.$Y.D32F_S8)return"depth32float-stencil8";if(e===o.$Y.BC1)return"bc1-rgba-unorm";if(e===o.$Y.BC1_SRGB)return"bc1-rgba-unorm-srgb";if(e===o.$Y.BC2)return"bc2-rgba-unorm";if(e===o.$Y.BC2_SRGB)return"bc2-rgba-unorm-srgb";if(e===o.$Y.BC3)return"bc3-rgba-unorm";if(e===o.$Y.BC3_SRGB)return"bc3-rgba-unorm-srgb";if(e===o.$Y.BC4_SNORM)return"bc4-r-snorm";if(e===o.$Y.BC4_UNORM)return"bc4-r-unorm";if(e===o.$Y.BC5_SNORM)return"bc5-rg-snorm";if(e===o.$Y.BC5_UNORM)return"bc5-rg-unorm";throw"whoops"}function L(e){if(e===o.bn.n2D)return"2d";if(e===o.bn.n2DArray)return"2d-array";if(e===o.bn.n3D)return"3d";if(e===o.bn.Cube)return"cube";throw"whoops"}function O(e){return e.gpuBuffer}function F(e){return e.gpuSampler}function U(e){if(e===o.sP.Triangles)return"triangle-list";throw"whoops"}function N(e){if(e===o.js.None)return"none";if(e===o.js.Front)return"front";if(e===o.js.Back)return"back";throw"whoops"}function X(e){if(e===o.$Z.CCW)return"ccw";if(e===o.$Z.CW)return"cw";throw"whoops"}function V(e){if(e===o.MT.Zero)return"zero";if(e===o.MT.One)return"one";if(e===o.MT.Src)return"src";if(e===o.MT.OneMinusSrc)return"one-minus-src";if(e===o.MT.Dst)return"dst";if(e===o.MT.OneMinusDst)return"one-minus-dst";if(e===o.MT.SrcAlpha)return"src-alpha";if(e===o.MT.OneMinusSrcAlpha)return"one-minus-src-alpha";if(e===o.MT.DstAlpha)return"dst-alpha";if(e===o.MT.OneMinusDstAlpha)return"one-minus-dst-alpha";throw"whoops"}function G(e){if(e===o.Id.Add)return"add";if(e===o.Id.Subtract)return"subtract";if(e===o.Id.ReverseSubtract)return"reverse-subtract";throw"whoops"}function K(e){return{operation:G(e.blendMode),srcFactor:V(e.blendSrcFactor),dstFactor:V(e.blendDstFactor)}}function $(e){return e.blendMode===o.Id.Add&&e.blendSrcFactor===o.MT.One&&e.blendDstFactor===o.MT.Zero}function W(e){return $(e.rgbBlendState)&&$(e.alphaBlendState)?void 0:{color:K(e.rgbBlendState),alpha:K(e.alphaBlendState)}}function H(e){if(e===o.Ar.Never)return"never";if(e===o.Ar.Less)return"less";if(e===o.Ar.Equal)return"equal";if(e===o.Ar.LessEqual)return"less-equal";if(e===o.Ar.Greater)return"greater";if(e===o.Ar.NotEqual)return"not-equal";if(e===o.Ar.GreaterEqual)return"greater-equal";if(e===o.Ar.Always)return"always";throw"whoops"}function Y(e){if(e===o.er.PerVertex)return"vertex";if(e===o.er.PerInstance)return"instance";throw"whoops"}function Z(e){if(e===o.$Y.U8_R)return"uint8x2";if(e===o.$Y.U8_RG)return"uint8x2";if(e===o.$Y.U8_RGB)return"uint8x4";if(e===o.$Y.U8_RGBA)return"uint8x4";if(e===o.$Y.U8_RG_NORM)return"unorm8x2";if(e===o.$Y.U8_RGBA_NORM)return"unorm8x4";if(e===o.$Y.S8_RGB_NORM)return"snorm8x4";if(e===o.$Y.S8_RGBA_NORM)return"snorm8x4";if(e===o.$Y.U16_RG_NORM)return"unorm16x2";if(e===o.$Y.U16_RGBA_NORM)return"unorm16x4";if(e===o.$Y.S16_RG_NORM)return"snorm16x2";if(e===o.$Y.S16_RGBA_NORM)return"snorm16x4";if(e===o.$Y.S16_RG)return"uint16x2";if(e===o.$Y.S16_RGBA)return"uint16x4";if(e===o.$Y.F16_RG)return"float16x2";if(e===o.$Y.F16_RGBA)return"float16x4";if(e===o.$Y.F32_R)return"float32";if(e===o.$Y.F32_RG)return"float32x2";if(e===o.$Y.F32_RGB)return"float32x3";if(e===o.$Y.F32_RGBA)return"float32x4";throw"whoops"}function z(e){if(e===o.o8.OcclusionConservative)return"occlusion";throw"whoops"}function j(e){if(e===o.dG.Float)return"float";if(e===o.dG.Depth)return"depth";throw"whoops"}function q(e){return{sampleType:j(e.formatKind),viewDimension:L(e.dimension)}}function Q(e){return e.formatKind===o.dG.Depth&&e.comparison?{type:"comparison"}:e.formatKind===o.dG.Float?{type:"filtering"}:{type:"non-filtering"}}class J{constructor(){this.occlusionQueryPool=null,this.gpuRenderPassEncoder=null,this.gfxColorAttachment=[],this.gfxColorAttachmentView=[],this.gfxColorResolveTo=[],this.gfxColorResolveToView=[],this.gfxDepthStencilAttachment=null,this.gfxDepthStencilResolveTo=null,this.gpuColorAttachments=[],this.gpuDepthStencilAttachment={view:null,depthLoadOp:"load",depthStoreOp:"store",stencilLoadOp:"load",stencilStoreOp:"store"},this.gpuRenderPassDescriptor={colorAttachments:this.gpuColorAttachments,depthStencilAttachment:this.gpuDepthStencilAttachment}}getTextureView(e,t){const s=t.level,n=t.z;return(0,d.vA)(s<e.numLevels),(0,d.vA)(n<e.depthOrArrayLayers),1===e.numLevels&&1===e.depthOrArrayLayers?e.gpuTextureView:e.gpuTexture.createView({baseMipLevel:s,mipLevelCount:1,baseArrayLayer:n,arrayLayerCount:1})}setRenderPassDescriptor(e){this.descriptor=e,this.gpuRenderPassDescriptor.colorAttachments=this.gpuColorAttachments;const t=e.colorAttachments.length;this.gfxColorAttachment.length=t,this.gfxColorResolveTo.length=t;for(let t=0;t<e.colorAttachments.length;t++){const s=e.colorAttachments[t];if(null!==s){const e=s.renderTarget,n=s.resolveTo;this.gfxColorAttachment[t]=e,this.gfxColorAttachmentView[t]=s.view,this.gfxColorResolveTo[t]=n,this.gfxColorResolveToView[t]=s.resolveView,this.gpuColorAttachments[t]||(this.gpuColorAttachments[t]={});const i=this.gpuColorAttachments[t];i.view=this.getTextureView(e,s.view);const r=s.clearColor;"load"===r?i.loadOp="load":(i.loadOp="clear",i.clearValue=r),i.storeOp=s.store?"store":"discard",i.resolveTarget=void 0,null!==n&&(e.sampleCount>1?i.resolveTarget=this.getTextureView(n,(0,d.Z1)(s.resolveView)):i.storeOp="store")}else this.gpuColorAttachments[t]=null,this.gfxColorAttachment[t]=null,this.gfxColorResolveTo[t]=null}{const t=e.depthStencilAttachment;if(null!==t){const e=t.renderTarget,s=t.resolveTo;this.gfxDepthStencilAttachment=e,this.gfxDepthStencilResolveTo=s;const n=this.gpuDepthStencilAttachment;n.view=e.gpuTextureView,(0,l.vg)(e.pixelFormat)&l.lk.Depth?("load"===t.clearDepth?n.depthLoadOp="load":(n.depthLoadOp="clear",n.depthClearValue=t.clearDepth),t.store||null!==this.gfxDepthStencilResolveTo?n.depthStoreOp="store":n.depthStoreOp="discard"):(n.depthLoadOp=void 0,n.depthStoreOp=void 0),(0,l.vg)(e.pixelFormat)&l.lk.Stencil?("load"===t.clearStencil?n.stencilLoadOp="load":(n.stencilLoadOp="clear",n.stencilClearValue=t.clearStencil),t.store||null!==this.gfxDepthStencilResolveTo?n.stencilStoreOp="store":n.stencilStoreOp="discard"):(n.stencilLoadOp=void 0,n.stencilStoreOp=void 0),this.gpuRenderPassDescriptor.depthStencilAttachment=this.gpuDepthStencilAttachment}else this.gfxDepthStencilAttachment=null,this.gfxDepthStencilResolveTo=null,this.gpuRenderPassDescriptor.depthStencilAttachment=void 0}this.occlusionQueryPool=e.occlusionQueryPool,null!==this.occlusionQueryPool&&(this.occlusionQueryPool.cpuBuffer.unmap(),this.occlusionQueryPool.results=null),this.gpuRenderPassDescriptor.occlusionQuerySet=null!==this.occlusionQueryPool?this.occlusionQueryPool.querySet:void 0}beginRenderPass(e,t){(0,d.vA)(null===this.gpuRenderPassEncoder),this.setRenderPassDescriptor(t),this.frameCommandEncoder=e,this.gpuRenderPassEncoder=this.frameCommandEncoder.beginRenderPass(this.gpuRenderPassDescriptor)}setViewport(e,t,s,n){this.gpuRenderPassEncoder.setViewport(e,t,s,n,0,1)}setScissor(e,t,s,n){this.gpuRenderPassEncoder.setScissorRect(e,t,s,n)}setPipeline(e){const t=e,s=(0,d.Z1)(t.gpuRenderPipeline);this.gpuRenderPassEncoder.setPipeline(s)}setVertexInput(e,t,s){if(null===e)return;const n=e;null!==s&&this.gpuRenderPassEncoder.setIndexBuffer(O(s.buffer),(0,d.Z1)(n.indexFormat),s.byteOffset);for(let e=0;e<t.length;e++){const s=t[e];null!==s&&this.gpuRenderPassEncoder.setVertexBuffer(e,O(s.buffer),s.byteOffset)}}setBindings(e,t,s){const n=t;this.gpuRenderPassEncoder.setBindGroup(e,n.gpuBindGroup,s)}setStencilRef(e){this.gpuRenderPassEncoder.setStencilReference(e)}draw(e,t){this.gpuRenderPassEncoder.draw(e,1,t,0)}drawIndexed(e,t){this.gpuRenderPassEncoder.drawIndexed(e,1,t,0,0)}drawIndexedInstanced(e,t,s){this.gpuRenderPassEncoder.drawIndexed(e,s,t,0,0)}beginOcclusionQuery(e){this.gpuRenderPassEncoder.beginOcclusionQuery(e)}endOcclusionQuery(){this.gpuRenderPassEncoder.endOcclusionQuery()}beginDebugGroup(e){this.gpuRenderPassEncoder.pushDebugGroup(e)}endDebugGroup(){this.gpuRenderPassEncoder.popDebugGroup()}copyAttachment(e,t,s,n){(0,d.vA)(1===s.sampleCount);const i={texture:s.gpuTexture,mipLevel:n.level,origin:[0,0,n.z]},r={texture:e.gpuTexture,mipLevel:t.level,origin:[0,0,t.z]};(0,d.vA)(s.width>>>n.level===e.width>>>t.level),(0,d.vA)(s.height>>>n.level===e.height>>>t.level),(0,d.vA)(!!(s.usage&GPUTextureUsage.COPY_SRC)),(0,d.vA)(!!(e.usage&GPUTextureUsage.COPY_DST)),this.frameCommandEncoder.copyTextureToTexture(i,r,[e.width,e.height,1])}finish(){this.gpuRenderPassEncoder.end(),this.gpuRenderPassEncoder=null;for(let e=0;e<this.gfxColorAttachment.length;e++){const t=this.gfxColorAttachment[e],s=this.gfxColorResolveTo[e];null!==t&&null!==s&&1===t.sampleCount&&this.copyAttachment(s,(0,d.Z1)(this.gfxColorAttachmentView[e]),t,(0,d.Z1)(this.gfxColorResolveToView[e]))}null!==this.gfxDepthStencilAttachment&&null!==this.gfxDepthStencilResolveTo&&(this.gfxDepthStencilAttachment.sampleCount>1||this.copyAttachment(this.gfxDepthStencilResolveTo,{level:0,z:0},this.gfxDepthStencilAttachment,{level:0,z:0}));const e=this.occlusionQueryPool;null!==e&&(this.frameCommandEncoder.resolveQuerySet(e.querySet,0,e.querySet.count,e.resolveBuffer,0),this.frameCommandEncoder.copyBufferToBuffer(e.resolveBuffer,0,e.cpuBuffer,0,8*e.querySet.count)),this.frameCommandEncoder=null}}class ee{constructor(){this.gpuComputePassEncoder=null}beginRenderPass(e){(0,d.vA)(null===this.gpuComputePassEncoder),this.frameCommandEncoder=e,this.gpuComputePassEncoder=this.frameCommandEncoder.beginComputePass()}setPipeline(e){const t=e,s=(0,d.Z1)(t.gpuComputePipeline);this.gpuComputePassEncoder.setPipeline(s)}setBindings(e,t,s){this.gpuComputePassEncoder.setBindGroup(e+0,t,s)}dispatch(e,t,s){this.gpuComputePassEncoder.dispatchWorkgroups(e,t,s)}beginDebugGroup(e){this.gpuComputePassEncoder.pushDebugGroup(e)}endDebugGroup(){this.gpuComputePassEncoder.popDebugGroup()}finish(){this.gpuComputePassEncoder.end(),this.gpuComputePassEncoder=null,this.frameCommandEncoder=null}}function te(e){switch((0,l.pZ)(e)){case l.np.BC1:case l.np.BC2:case l.np.BC3:case l.np.BC4_SNORM:case l.np.BC4_UNORM:case l.np.BC5_SNORM:case l.np.BC5_UNORM:return 4}return 1}function se(e,t,s,n,i){const r=te(s);e.width=(0,d.MM)(n,r),e.height=(0,d.MM)(i,r);const a=e.width/r|0,o=e.height/r|0;t.bytesPerRow=a*function(e){switch((0,l.pZ)(e)){case l.np.BC1:case l.np.BC4_SNORM:case l.np.BC4_UNORM:return 8;case l.np.BC2:case l.np.BC3:case l.np.BC5_SNORM:case l.np.BC5_UNORM:return 16}return(0,l.$U)(e)}(s),t.rowsPerImage=o}class ne{constructor(e,t,s,n,i){this.adapter=e,this.device=t,this.canvas=s,this.canvasContext=n,this.glsl_compile=i,this._swapChainWidth=0,this._swapChainHeight=0,this._swapChainTextureUsage=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST,this._resourceUniqueId=0,this._renderPassPool=[],this._computePassPool=[],this._featureTextureCompressionBC=!1,this._bindGroupLayoutCache=new I.Bs(d.yN,I.Kt),this._frameCommandEncoder=null,this._readbacksSubmitted=[],this._queryPoolsSubmitted=[],this.platformString="WebGPU",this.glslVersion="#version 440",this.explicitBindingLocations=!0,this.separateSamplerTextures=!0,this.viewportOrigin=o.S0.UpperLeft,this.clipSpaceNearZ=o.uA.Zero,this._fallbackTexture2D=this.createFallbackTexture(o.bn.n2D,o.dG.Float),this._fallbackTexture2DDepth=this.createFallbackTexture(o.bn.n2D,o.dG.Depth),this._fallbackTexture2DArray=this.createFallbackTexture(o.bn.n2DArray,o.dG.Float),this._fallbackTexture3D=this.createFallbackTexture(o.bn.n3D,o.dG.Float),this._fallbackTextureCube=this.createFallbackTexture(o.bn.Cube,o.dG.Float),this._fallbackSamplerFiltering=this.createSampler({wrapS:o.Vf.Repeat,wrapT:o.Vf.Repeat,minFilter:o.gD.Point,magFilter:o.gD.Point,mipFilter:o.P.Nearest}),this.setResourceName(this._fallbackSamplerFiltering,"Fallback Sampler Filtering"),this._fallbackSamplerComparison=this.createSampler({wrapS:o.Vf.Repeat,wrapT:o.Vf.Repeat,minFilter:o.gD.Point,magFilter:o.gD.Point,mipFilter:o.P.Nearest,compareMode:o.Ar.Always}),this.setResourceName(this._fallbackSamplerFiltering,"Fallback Sampler Comparison"),this._featureTextureCompressionBC=this.device.features.has("texture-compression-bc"),this.device.onuncapturederror=e=>{console.error(e.error)},this._swapChainFormat=navigator.gpu.getPreferredCanvasFormat(),this.canvasContext.configure({device:this.device,format:this._swapChainFormat,usage:this._swapChainTextureUsage,alphaMode:"opaque"})}createFallbackTexture(e,t){const s=e===o.bn.Cube?6:1,n=t===o.dG.Float?o.$Y.U8_RGBA_NORM:o.$Y.D24;return this.createTexture({dimension:e,pixelFormat:n,usage:o.Yw.Sampled,width:1,height:1,depthOrArrayLayers:s,numLevels:1})}configureSwapChain(e,t){this._swapChainWidth=e,this._swapChainHeight=t}getOnscreenTexture(){const e=this.canvasContext.getCurrentTexture(),t=e.createView();return{_T:n.Texture,ResourceUniqueId:0,gpuTexture:e,gpuTextureView:t,pixelFormat:o.$Y.U8_RGBA_RT,width:this._swapChainWidth,height:this._swapChainHeight,depthOrArrayLayers:1,numLevels:1,usage:this._swapChainTextureUsage,sampleCount:1,dimension:o.bn.n2D}}getDevice(){return this}getCanvas(){return this.canvas}getNextUniqueId(){return++this._resourceUniqueId}createBuffer(e,t,s,i){let r=function(e){let t=0;return e&o.B6.Index&&(t|=GPUBufferUsage.INDEX),e&o.B6.Vertex&&(t|=GPUBufferUsage.VERTEX),e&o.B6.Uniform&&(t|=GPUBufferUsage.UNIFORM),e&o.B6.Storage&&(t|=GPUBufferUsage.STORAGE),e&o.B6.CopySrc&&(t|=GPUBufferUsage.COPY_SRC),t|=GPUBufferUsage.COPY_DST,t}(t);const a=4*e,l=this.device.createBuffer({usage:r,size:a,mappedAtCreation:void 0!==i});return void 0!==i&&(new Uint8Array(l.getMappedRange()).set(i),l.unmap()),{_T:n.Buffer,ResourceUniqueId:this.getNextUniqueId(),gpuBuffer:l,size:a}}createTextureShared(e){const t={width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers},s=e.numLevels,n=B(e.pixelFormat),i=function(e){if(e===o.bn.n2D)return"2d";if(e===o.bn.n2DArray)return"2d";if(e===o.bn.n3D)return"3d";if(e===o.bn.Cube)return"2d";throw"whoops"}(e.dimension),r=function(e){let t=0;return e&o.Yw.Sampled&&(t|=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST),e&o.Yw.RenderTarget&&(t|=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST),t}(e.usage),a=this.device.createTexture({size:t,mipLevelCount:s,format:n,dimension:i,usage:r}),l=a.createView({dimension:L(e.dimension)});return{pixelFormat:e.pixelFormat,width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers,numLevels:s,usage:r,sampleCount:1,gpuTexture:a,gpuTextureView:l,dimension:e.dimension}}createTexture(e){const t=this.createTextureShared({pixelFormat:e.pixelFormat,dimension:e.dimension,width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers,numLevels:e.numLevels,usage:e.usage,sampleCount:1});return Object.assign({_T:n.Texture,ResourceUniqueId:this.getNextUniqueId()},t)}createSampler(e){var t,s;const i=e.minLOD,r=e.mipFilter===o.P.NoMip?e.minLOD:e.maxLOD;let a=null!==(t=e.maxAnisotropy)&&void 0!==t?t:1;a>1&&(0,d.vA)(e.minFilter===o.gD.Bilinear&&e.magFilter===o.gD.Bilinear&&e.mipFilter===o.P.Linear);const l=this.device.createSampler({addressModeU:M(e.wrapS),addressModeV:M(e.wrapT),addressModeW:M(null!==(s=e.wrapQ)&&void 0!==s?s:e.wrapS),lodMinClamp:i,lodMaxClamp:r,minFilter:P(e.minFilter),magFilter:P(e.magFilter),mipmapFilter:D(e.mipFilter),compare:void 0!==e.compareMode?H(e.compareMode):void 0,maxAnisotropy:a});return{_T:n.Sampler,ResourceUniqueId:this.getNextUniqueId(),gpuSampler:l}}createRenderTarget(e){const t=this.createTextureShared({pixelFormat:e.pixelFormat,dimension:o.bn.n2D,width:e.width,height:e.height,depthOrArrayLayers:1,numLevels:1,usage:o.Yw.RenderTarget,sampleCount:e.sampleCount});return Object.assign(Object.assign({_T:n.RenderTarget,ResourceUniqueId:this.getNextUniqueId()},t),{ownsTexture:!0})}createRenderTargetFromTexture(e){const{pixelFormat:t,width:s,height:i,depthOrArrayLayers:r,sampleCount:a,numLevels:o,gpuTexture:l,gpuTextureView:h,usage:c,dimension:u}=e;return(0,d.vA)(!!(c&GPUTextureUsage.RENDER_ATTACHMENT)),{_T:n.RenderTarget,ResourceUniqueId:this.getNextUniqueId(),pixelFormat:t,width:s,height:i,depthOrArrayLayers:r,sampleCount:a,numLevels:o,usage:c,dimension:u,gpuTexture:l,gpuTextureView:h,ownsTexture:!1}}_createShaderStageGLSL(e,t){let s;try{s=this.glsl_compile(e,t,!1)}catch(t){throw console.error(e),"whoops"}for(const e of["u_TextureFramebufferDepth"])s.includes(e)&&(s=s.replace(`var T_${e}: texture_2d<f32>;`,`var T_${e}: texture_depth_2d;`),s=s.replace(new RegExp(`textureSample\\(T_${e}(.*)\\);$`,"gm"),(t,s)=>`vec4<f32>(textureSample(T_${e}${s}), 0.0, 0.0, 0.0);`));return s=s.replace("<i32> = textureDimensions(","<u32> = textureDimensions("),{module:this.device.createShaderModule({code:s}),entryPoint:"main"}}_createShaderStage(e,t,s){if(s===o.MN.GLSL)return this._createShaderStageGLSL(e,t);{const t=e;return{module:this.device.createShaderModule({code:t}),entryPoint:"main"}}}createProgramSimple(e){const t=this._createShaderStageGLSL(e.preprocessedVert,"vertex"),s=null!==e.preprocessedFrag?this._createShaderStageGLSL(e.preprocessedFrag,"fragment"):null;return{_T:n.Program,ResourceUniqueId:this.getNextUniqueId(),descriptor:e,vertexStage:t,fragmentStage:s}}createComputeProgram(e){const t=this._createShaderStage(e.preprocessedComp,"compute",e.shadingLanguage);return{_T:n.Program,ResourceUniqueId:this.getNextUniqueId(),descriptor:e,computeStage:t}}_createBindGroupLayoutInternal(e){const t=[];for(let s=0;s<e.numSamplers;s++){const n=void 0!==e.samplerEntries?e.samplerEntries[s]:h;t.push({binding:t.length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,texture:q(n)}),t.push({binding:t.length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,sampler:Q(n)})}for(let s=0;s<e.numUniformBuffers;s++)t.push({binding:t.length,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!0}});return this.device.createBindGroupLayout({entries:t})}_createBindGroupLayout(e){let t=this._bindGroupLayoutCache.get(e);return null===t&&(t=this._createBindGroupLayoutInternal(e),this._bindGroupLayoutCache.add(e,t)),t}_getFallbackTexture(e){const t=e.dimension,s=e.formatKind;if(t===o.bn.n2D)return s===o.dG.Depth?this._fallbackTexture2DDepth:this._fallbackTexture2D;if(t===o.bn.n2DArray)return this._fallbackTexture2DArray;if(t===o.bn.n3D)return this._fallbackTexture3D;if(t===o.bn.Cube)return this._fallbackTextureCube;throw"whoops"}_getFallbackSampler(e){return e.formatKind===o.dG.Depth&&e.comparison?this._fallbackSamplerComparison:this._fallbackSamplerFiltering}createBindings(e){const t=e.bindingLayout,s=this._createBindGroupLayout(t),i=[];let r=0;for(let s=0;s<t.numSamplers;s++){const n=void 0!==t.samplerEntries?t.samplerEntries[s]:h,a=e.samplerBindings[s],o=null!==a.gfxTexture?a.gfxTexture:this._getFallbackTexture(n);(0,d.vA)(n.dimension===o.dimension),(0,d.vA)(n.formatKind===(0,l.kk)(o.pixelFormat));const c=o.gpuTextureView;i.push({binding:r++,resource:c});const u=F(null!==a.gfxSampler?a.gfxSampler:this._getFallbackSampler(n));i.push({binding:r++,resource:u})}for(let s=0;s<t.numUniformBuffers;s++){const t=e.uniformBufferBindings[s];(0,d.vA)(t.wordCount>0);const n={buffer:O(t.buffer),offset:0,size:t.wordCount<<2};i.push({binding:r++,resource:n})}const a=this.device.createBindGroup({layout:s,entries:i});return{_T:n.Bindings,ResourceUniqueId:this._resourceUniqueId,bindingLayout:e.bindingLayout,bindGroupLayout:s,gpuBindGroup:a}}createInputLayout(e){const t=[];for(let s=0;s<e.vertexAttributeDescriptors.length;s++){const n=e.vertexAttributeDescriptors[s],i={shaderLocation:n.location,format:Z(n.format),offset:n.bufferByteOffset};if(void 0!==t[n.bufferIndex])t[n.bufferIndex].attributes.push(i);else{const s=(0,d.Z1)(e.vertexBufferDescriptors[n.bufferIndex]),r=s.byteStride,a=Y(s.frequency),o=[i];t[n.bufferIndex]={arrayStride:r,stepMode:a,attributes:o}}}const s=function(e){if(null!==e){if(e===o.$Y.U16_R)return"uint16";if(e===o.$Y.U32_R)return"uint32";throw"whoops"}}(e.indexBufferFormat);return{_T:n.InputLayout,ResourceUniqueId:this.getNextUniqueId(),buffers:t,indexFormat:s}}_createPipelineLayout(e){const t=e.map(e=>this._createBindGroupLayout(e));return this.device.createPipelineLayout({bindGroupLayouts:t})}createRenderPipeline(e){const t={_T:n.RenderPipeline,ResourceUniqueId:this.getNextUniqueId(),descriptor:e,isCreatingAsync:!1,gpuRenderPipeline:null};return this._createRenderPipeline(t,!0),t}async _createRenderPipeline(e,t){if(t&&e.isCreatingAsync)return;if(null!==e.gpuRenderPipeline)return;const s=e.descriptor,n=s.program,i=(0,d.Z1)(n.vertexStage),r=n.fragmentStage,a=this._createPipelineLayout(s.bindingLayouts),o=(l=s.topology,h=s.megaStateDescriptor,{topology:U(l),cullMode:N(h.cullMode),frontFace:X(h.frontFace)});var l,h;const c=function(e,t){return e.map((e,s)=>{if(null===e)return null;let n=t.attachmentsState[s];return void 0===n&&(n=t.attachmentsState[0]),function(e,t){return{format:B(t),blend:W(e),writeMask:e.channelWriteMask}}(n,e)}).filter(e=>null!==e)}(s.colorAttachmentFormats,s.megaStateDescriptor),u=function(e,t){if(null!==e)return{format:B(e),depthWriteEnabled:t.depthWrite,depthCompare:H(t.depthCompare),depthBias:t.polygonOffset?1:0,depthBiasSlopeScale:t.polygonOffset?1:0}}(s.depthStencilAttachmentFormat,s.megaStateDescriptor);let m;null!==s.inputLayout&&(m=s.inputLayout.buffers);const p=s.sampleCount;let f;e.isCreatingAsync=!0,null!==r&&(f=Object.assign(Object.assign({},r),{targets:c}));const g={layout:a,vertex:Object.assign(Object.assign({},i),{buffers:m}),primitive:o,depthStencil:u,multisample:{count:p},fragment:f};if(t){const t=await this.device.createRenderPipelineAsync(g);null===e.gpuRenderPipeline&&(e.gpuRenderPipeline=t)}else e.gpuRenderPipeline=this.device.createRenderPipeline(g);void 0!==e.ResourceName&&(e.gpuRenderPipeline.label=e.ResourceName),e.isCreatingAsync=!1}createComputePipeline(e){const t={_T:n.ComputePipeline,ResourceUniqueId:this.getNextUniqueId(),descriptor:e,isCreatingAsync:!1,gpuComputePipeline:null};return this._createComputePipeline(t,!0),t}async _createComputePipeline(e,t){if(t&&e.isCreatingAsync)return;if(null!==e.gpuComputePipeline)return;const s=e.descriptor,n=s.program,i=s.pipelineLayout,r=n.computeStage;e.isCreatingAsync=!0;const a={layout:i,compute:r};if(t){const t=await this.device.createComputePipelineAsync(a);null===e.gpuComputePipeline&&(e.gpuComputePipeline=t)}else e.gpuComputePipeline=this.device.createComputePipeline(a);void 0!==e.ResourceName&&(e.gpuComputePipeline.label=e.ResourceName),e.isCreatingAsync=!1}createReadback(e){return{_T:n.Readback,ResourceUniqueId:this.getNextUniqueId(),cpuBuffer:this.device.createBuffer({size:e,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),done:!1,destroyed:!1}}createQueryPool(e,t){const s=this.device.createQuerySet({type:z(e),count:t});return{_T:n.QueryPool,ResourceUniqueId:this.getNextUniqueId(),querySet:s,resolveBuffer:this.device.createBuffer({size:8*t,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),cpuBuffer:this.device.createBuffer({size:8*t,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),results:null,destroyed:!1}}createWebXRLayer(e){throw"createWebXRLayer not implemented on WebGPU"}destroyBuffer(e){O(e).destroy()}destroyTexture(e){e.gpuTexture.destroy()}destroySampler(e){}destroyRenderTarget(e){const t=e;t.ownsTexture&&t.gpuTexture.destroy()}destroyProgram(e){}destroyBindings(e){}destroyInputLayout(e){}destroyRenderPipeline(e){}destroyComputePipeline(e){}destroyReadback(e){const t=e;"pending"===t.cpuBuffer.mapState?t.destroyed=!0:t.cpuBuffer.destroy()}destroyQueryPool(e){const t=e;t.querySet.destroy(),t.resolveBuffer.destroy(),"pending"===t.cpuBuffer.mapState?t.destroyed=!0:t.cpuBuffer.destroy()}pipelineQueryReady(e){return null!==e.gpuRenderPipeline}pipelineForceReady(e){const t=e;this._createRenderPipeline(t,!1)}createRenderPass(e){let t=this._renderPassPool.pop();return void 0===t&&(t=new J),t.beginRenderPass(this._frameCommandEncoder,e),t}createComputePass(){let e=this._computePassPool.pop();return void 0===e&&(e=new ee),e.beginRenderPass(this._frameCommandEncoder),e}submitPass(e){if(e instanceof J){const t=e;t.finish(),this._renderPassPool.push(t),null!==t.occlusionQueryPool&&this._queryPoolsSubmitted.push(t.occlusionQueryPool)}else if(e instanceof ee){const t=e;t.finish(),this._computePassPool.push(t)}}beginFrame(){(0,d.vA)(null===this._frameCommandEncoder),this._frameCommandEncoder=this.device.createCommandEncoder()}endFrame(){(0,d.vA)(null!==this._frameCommandEncoder),this.device.queue.submit([this._frameCommandEncoder.finish()]),this._frameCommandEncoder=null;for(let e=0;e<this._readbacksSubmitted.length;e++){const t=this._readbacksSubmitted[e];t.cpuBuffer.mapAsync(GPUMapMode.READ).then(()=>{t.done=!0,t.destroyed&&t.cpuBuffer.destroy()})}this._readbacksSubmitted.length=0;for(let e=0;e<this._queryPoolsSubmitted.length;e++){const t=this._queryPoolsSubmitted[e];t.cpuBuffer.mapAsync(GPUMapMode.READ).then(()=>{t.results=new BigUint64Array(t.cpuBuffer.getMappedRange()),t.destroyed&&t.cpuBuffer.destroy()})}this._queryPoolsSubmitted.length=0}copySubTexture2D(e,t,s,n,i,r){const a=e,o=n,l={texture:o.gpuTexture,origin:[i,r,0]},h={texture:a.gpuTexture,origin:[t,s,0]};(0,d.vA)(!!(o.usage&GPUTextureUsage.COPY_SRC)),(0,d.vA)(!!(a.usage&GPUTextureUsage.COPY_DST)),this._frameCommandEncoder.copyTextureToTexture(l,h,[o.width,o.height,1])}zeroBuffer(e,t,s){this._frameCommandEncoder.clearBuffer(O(e),t,s)}uploadBufferData(e,t,s,n,i){if(void 0===i&&(i=s.byteLength),void 0===n&&(n=0),i%4!=0){const e=s.subarray(n,i);i=(0,d.MM)(i,4),(s=new Uint8Array(i)).set(e)}(0,d.vA)(s.byteLength-n>=i),this.device.queue.writeBuffer(O(e),t,s,n,i)}uploadTextureData(e,t,s){const n=e,i={texture:n.gpuTexture},r={},a={width:0,height:0,depthOrArrayLayers:n.depthOrArrayLayers};for(let e=0;e<s.length;e++){const o=t+e;i.mipLevel=o;const l=n.width>>>o,h=n.height>>>o;se(a,r,n.pixelFormat,l,h),this.device.queue.writeTexture(i,s[e],r,a)}}readBuffer(e,t,s,n,i){const r=e,a=s;this._frameCommandEncoder.copyBufferToBuffer(a.gpuBuffer,n,r.cpuBuffer,t,i)}readPixelFromTexture(e,t,s,n,i){const r=e,a=s,o=(0,l.$U)(a.pixelFormat),h={texture:a.gpuTexture,origin:[n,i,0]},c={buffer:r.cpuBuffer,offset:t*o};this._frameCommandEncoder.copyTextureToBuffer(h,c,[1,1,1])}submitReadback(e){const t=e;(0,d.vA)(!t.done),this._readbacksSubmitted.push(t)}queryReadbackFinished(e,t,s){const n=s;if(n.done){const s=new Uint32Array(n.cpuBuffer.getMappedRange());return e.set(s,t),n.cpuBuffer.unmap(),n.done=!1,!0}return!1}queryPoolResultOcclusion(e,t){const s=e;return null===s.results?null:s.results[t]!==BigInt(0)}queryLimits(){return{uniformBufferMaxPageWordSize:this.device.limits.maxUniformBufferBindingSize>>>2,uniformBufferWordAlignment:this.device.limits.minUniformBufferOffsetAlignment>>>2,supportedSampleCounts:[1],occlusionQueriesRecommended:!0,computeShadersSupported:!0,wireframeSupported:!1}}queryTextureFormatSupported(e,t,s){if(function(e){switch((0,l.pZ)(e)){case l.np.BC1:case l.np.BC2:case l.np.BC3:case l.np.BC4_SNORM:case l.np.BC4_UNORM:case l.np.BC5_SNORM:case l.np.BC5_UNORM:return!0}return!1}(e)){if(!this._featureTextureCompressionBC)return!1;const n=te(e);return t%n===0&&s%n===0&&this._featureTextureCompressionBC}switch(e){case o.$Y.U16_RGB_565:case o.$Y.U16_RGBA_NORM:case o.$Y.F32_RGBA:return!1}return!0}queryVendorInfo(){return this}queryRenderPass(e){return e.descriptor}queryRenderTarget(e){return e}setResourceName(e,t){if(e.ResourceName=t,e._T===n.Buffer)e.gpuBuffer.label=t;else if(e._T===n.Texture){const s=e;s.gpuTexture.label=t,s.gpuTextureView.label=t}else if(e._T===n.RenderTarget){const s=e;s.gpuTexture.label=t,s.gpuTextureView.label=t}else if(e._T===n.Sampler)e.gpuSampler.label=t;else if(e._T===n.RenderPipeline){const s=e;null!==s.gpuRenderPipeline&&(s.gpuRenderPipeline.label=t)}else if(e._T===n.QueryPool){const s=e;s.querySet.label=`${t} QuerySet`,s.resolveBuffer.label=`${t} Resolve Buffer`,s.cpuBuffer.label=`${t} CPU Buffer`}else if(e._T===n.Program){const s=e;null!==s.vertexStage&&(s.vertexStage.module.label=t),null!==s.fragmentStage&&(s.fragmentStage.module.label=t)}}setResourceLeakCheck(e,t){}checkForLeaks(){}programPatched(e){}pushStatisticsGroup(e){}popStatisticsGroup(){}}ne.optionalFeatures=["depth32float-stencil8","texture-compression-bc"];class ie{constructor(){this.frameStartCPUTime=0,this.frameCPUTime=0,this.fps=0,this.lines=[],this.gameLines=[]}addInfoLine(e){this.lines.push(e)}beginFrame(){this.frameStartCPUTime=window.performance.now(),this.lines.length=0,this.frameCPUTime=0,this.fps=0}endFrame(){return this.frameCPUTime=window.performance.now()-this.frameStartCPUTime,this.fps=1e3/this.frameCPUTime,this.lines.push(`CPU Time: ${this.frameCPUTime.toFixed(2)}ms`),this.lines.push("FPS: "+(0|this.fps)),this}}var re,ae=s(6253),oe=s(5339),le=s(8834),he=s(5098),ce=s(7684);function ue(e){e.bufferUploadCount=0,e.drawCallCount=0,e.textureBindCount=0,e.triangleCount=0}function de(e,t,s,n){const i=t*n,r=s*n;e.width===i&&e.height===r||(e.style.width=`${t}px`,e.style.height=`${s}px`,e.width=i,e.height=r)}class me{constructor(e,t){this.gfxSwapChain=e,this.canvas=t,this.cameraController=null,this.xrCameraController=new a.wl,this.camera=new a.i7,this.fovY=me.FOV_Y_DEFAULT,this.sceneTime=0,this.rafTime=0,this.sceneTimeScale=1,this.externalControl=!1,this.renderStatisticsTracker=new ie,this.scene=null,this.oncamerachanged=()=>{},this.onstatistics=()=>{},this.keyMoveSpeedListeners=[],this.statisticsGroup={drawCallCount:0,bufferUploadCount:0,textureBindCount:0,triangleCount:0},this.xrTempRT=null,this.xrTempWidth=-1,this.xrTempHeight=-1,window.viewer=this,this.inputManager=new r.A(this.canvas),this.rafTime=window.performance.now(),this.gfxDevice=this.gfxSwapChain.getDevice(),this.viewerRenderInput={camera:this.camera,time:this.sceneTime,deltaTime:0,backbufferWidth:0,backbufferHeight:0,onscreenTexture:null,antialiasingMode:ae.Iq.None,mouseLocation:this.inputManager,debugConsole:this.renderStatisticsTracker},he._h.addSettingListener("AntialiasingMode",(e,t)=>{const s=e.loadSetting(t,ae.Iq.FXAA);this.viewerRenderInput.antialiasingMode=s})}onKeyMoveSpeed(){for(let e=0;e<this.keyMoveSpeedListeners.length;e++)this.keyMoveSpeedListeners[e](this)}setKeyMoveSpeed(e){null!==this.cameraController&&(this.cameraController.setKeyMoveSpeed(e),this.onKeyMoveSpeed())}addKeyMoveSpeedListener(e){this.keyMoveSpeedListeners.push(e)}renderViewport(){null!==this.scene&&this.scene.render(this.gfxDevice,this.viewerRenderInput)}render(){this.viewerRenderInput.camera=this.camera,this.viewerRenderInput.time=this.sceneTime,this.viewerRenderInput.backbufferWidth=this.canvas.width,this.viewerRenderInput.backbufferHeight=this.canvas.height,this.gfxSwapChain.configureSwapChain(this.canvas.width,this.canvas.height),this.viewerRenderInput.onscreenTexture=this.gfxSwapChain.getOnscreenTexture(),this.gfxDevice.beginFrame(),this.renderStatisticsTracker.beginFrame(),ue(this.statisticsGroup),this.gfxDevice.pushStatisticsGroup(this.statisticsGroup),this.renderViewport(),this.gfxDevice.popStatisticsGroup(),this.gfxDevice.endFrame();const e=this.renderStatisticsTracker.endFrame();this.finishRenderStatistics(e,this.statisticsGroup),this.onstatistics(e)}getXRTempRT(e,t){return this.xrTempWidth===e&&this.xrTempHeight===t||(null!==this.xrTempRT&&this.gfxDevice.destroyTexture(this.xrTempRT),this.xrTempRT=this.gfxDevice.createTexture((0,o.xm)(o.$Y.U8_RGBA_RT,e,t,1)),this.xrTempWidth=e,this.xrTempHeight=t),this.xrTempRT}renderWebXR(e){if(null===e.xrSession)return;const t=e.xrSession.renderState.baseLayer;if(void 0===t)return;this.viewerRenderInput.time=this.sceneTime,this.gfxSwapChain.configureSwapChain(t.framebufferWidth,t.framebufferHeight,t.framebuffer);const s=this.gfxSwapChain.getOnscreenTexture();this.gfxDevice.beginFrame(),this.renderStatisticsTracker.beginFrame(),ue(this.statisticsGroup),this.gfxDevice.pushStatisticsGroup(this.statisticsGroup);for(let n=0;n<e.views.length;n++){this.viewerRenderInput.camera=this.xrCameraController.cameras[n];const i=e.views[n],r=this.viewerRenderInput.camera,a=.1;r.projectionMatrix[10]=0,r.projectionMatrix[14]=a,r.projectionMatrix[11]=-1,r.projectionMatrix[15]=0;const o=t.getViewport(i);if(!o)continue;this.viewerRenderInput.backbufferWidth=o.width,this.viewerRenderInput.backbufferHeight=o.height;const l=this.getXRTempRT(o.width,o.height);this.viewerRenderInput.onscreenTexture=l,this.renderViewport(),this.gfxDevice.copySubTexture2D(s,o.x,o.y,l,0,0),this.viewerRenderInput.deltaTime=0}this.gfxDevice.popStatisticsGroup(),this.gfxDevice.endFrame();const n=this.renderStatisticsTracker.endFrame();this.onstatistics(n)}finishRenderStatistics(e,t){t.drawCallCount&&e.lines.push(`Draw Calls: ${t.drawCallCount}`),t.triangleCount&&e.lines.push(`Drawn Triangles: ${t.triangleCount}`),t.textureBindCount&&e.lines.push(`Texture Binds: ${t.textureBindCount}`),t.bufferUploadCount&&e.lines.push(`Buffer Uploads: ${t.bufferUploadCount}`);const s=this.camera.worldMatrix,n=s[12].toFixed(2),i=s[13].toFixed(2),r=s[14].toFixed(2);e.lines.push(`Camera Position: ${n} ${i} ${r}`);const a=this.gfxDevice.queryVendorInfo();if(e.lines.push(`Platform: ${a.platformString}`),"WebGL2"===a.platformString){const t=this.gfxDevice,s=t.gl.drawingBufferWidth,n=t.gl.drawingBufferHeight;e.lines.push(`Drawing Buffer Size: ${s}x${n}`)}}setCameraController(e){this.cameraController=e,null!==this.scene&&void 0!==this.scene.adjustCameraController&&this.scene.adjustCameraController(e),this.cameraController.camera=this.camera,this.cameraController.forceUpdate=!0}setScene(e){this.scene=e,this.cameraController=null}update(e){const t=e.time-this.rafTime;this.updateDT(t,e)}updateDT(e,t){if(e<0)return;this.rafTime+=e;const s=this.camera;s.clipSpaceNearZ=this.gfxDevice.queryVendorInfo().clipSpaceNearZ,s.newFrame();const n=this.canvas.width/this.canvas.height;if(s.fovY=this.fovY,s.aspect=n,null!==t.webXRContext&&t.webXRContext.views&&t.webXRContext.xrSession||s.setClipPlanes(.01),this.cameraController){const t=this.cameraController.update(this.inputManager,e,this.sceneTimeScale);t!==a.cK.Unchanged&&this.oncamerachanged(t===a.cK.ImportantChange)}const i=e*this.sceneTimeScale;if(this.viewerRenderInput.deltaTime+=i,this.sceneTime+=i,null!==t.webXRContext&&t.webXRContext.views&&t.webXRContext.xrSession){if(!this.__xrSynced){const e=this.xrCameraController.cameras[0];e&&ce.C(e.worldMatrix,this.camera.worldMatrix),this.__xrSynced=!0}this.xrCameraController.update(t.webXRContext),this.renderWebXR(t.webXRContext)}else this.__xrSynced=!1,this.render();this.inputManager.afterFrame(),this.viewerRenderInput.deltaTime=0}takeScreenshotToCanvas(e){const t=document.createElement("canvas");if(null!==this.scene){const s=this.gfxDevice.gl;!function(e,t,s,n,i){!function(e,t,s,n,i){const r=new Uint8Array(t*s*4);if(e.readPixels(0,0,t,s,e.RGBA,e.UNSIGNED_BYTE,r),i)for(let e=3;e<r.length;e+=4)r[e]=255;n.width=e.drawingBufferWidth,n.height=e.drawingBufferHeight;const a=n.getContext("2d"),o=a.createImageData(t,s);o.data.set(r),a.putImageData(o,0,0),a.save(),a.globalCompositeOperation="copy",a.setTransform(1,0,0,-1,0,s),a.drawImage(n,0,0),a.restore()}(e,t,s,n,i)}(s,s.drawingBufferWidth,s.drawingBufferHeight,t,e)}return t}}async function pe(e,t){return"WebGPU"===he._h.loadSetting("PlatformBackend","WebGL2")?async function(e,t){const s=await async function(e){if(void 0===navigator.gpu)return null;const t=await navigator.gpu.requestAdapter();if(null===t)return null;const s=ne.optionalFeatures.filter(e=>t.features.has(e)),n=await t.requestDevice({requiredFeatures:s});if(null===n)return null;const i=e.getContext("webgpu");return i?new ne(t,n,e,i,k.T.glsl_compile):null}(t);return null===s?re.MISSING_MISC_WEB_APIS:(e.viewer=new me(s,t),re.SUCCESS)}(e,t):async function(e,t){const s=t.getContext("webgl2",{antialias:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1});if(window.gl=s,!s)return re.NO_WEBGL2_GENERIC;const n=s.getExtension("WEBGL_debug_renderer_info");if(n&&s.getParameter(n.UNMASKED_RENDERER_WEBGL).includes("SwiftShader"))return re.GARBAGE_WEBGL2_SWIFTSHADER;const i=new E;i.trackResources=!1,i.shaderDebug=le.DS;const r=function(e,t){return new R(e,t)}(s,i);return e.viewer=new me(r,t),re.SUCCESS}(e,t)}function fe(e){return i.MC(`\n<div style="display: flex; background-color: #220000; flex-direction: column; position: absolute; top: 0; bottom: 0; left: 0; right: 0; justify-content: center;">\n<div style="display: flex; background-color: #aa2233; justify-content: center; box-shadow: 0 0 32px black;">\n<div style="max-width: 1000px; font: 16pt sans-serif; color: white; text-align: justify;">\n<style>\na:link, a:visited { color: #ccc; transition: .5s color; }\na:hover { color: #fff; }\n</style>\n${e}\n`)}function ge(e){if(e===re.NO_WEBGL2_GENERIC)return fe('\n<p>Your browser does not appear to have WebGL 2 support.\n<p>If <a href="http://webglreport.com/?v=2">WebGL Report</a> says your browser supports WebGL 2, please open a <a href="https://github.com/magcius/noclip.website/issues/new?template=tech_support.md">GitHub issue</a> with as much as information as possible.\n<p style="text-align: right">Thanks, Jasper.\n');if(e===re.GARBAGE_WEBGL2_SWIFTSHADER)return fe('\n<p>This application requires hardware acceleration to be enabled.\n<p>Please enable hardware acceleration in your\'s browser settings.\n<p>If you have enabled hardware acceleration and are still getting this error message, try restarting your browser and computer.\n<p style="text-align: right">Thanks, Jasper.\n');if(e===re.GARBAGE_WEBGL2_GENERIC)return fe('\n<p>This browser has a non-functioning version of WebGL 2 that I have not seen before.\n<p>If <a href="http://webglreport.com/?v=2">WebGL Report</a> says your browser supports WebGL 2, please open a <a href="https://github.com/magcius/noclip.website/issues/new?template=tech_support.md">GitHub issue</a> with as much as information as possible.\n<p style="text-align: right">Thanks, Jasper.\n');if(e===re.MISSING_MISC_WEB_APIS)return fe("\n<p>Your browser is too old and is missing support for web APIs that I rely on.\n<p>Please try to update your browser to a more recent version.\n");throw"whoops"}me.FOV_Y_DEFAULT=oe.wZ.TAU/6,function(e){e[e.SUCCESS=0]="SUCCESS",e[e.NO_WEBGL2_GENERIC=1]="NO_WEBGL2_GENERIC",e[e.GARBAGE_WEBGL2_GENERIC=2]="GARBAGE_WEBGL2_GENERIC",e[e.GARBAGE_WEBGL2_SWIFTSHADER=3]="GARBAGE_WEBGL2_SWIFTSHADER",e[e.MISSING_MISC_WEB_APIS=4]="MISSING_MISC_WEB_APIS"}(re||(re={}))}},fe={};function ge(e){var t=fe[e];if(void 0!==t)return t.exports;var s=fe[e]={id:e,loaded:!1,exports:{}};return pe[e](s,s.exports,ge),s.loaded=!0,s.exports}ge.m=pe,ge.c=fe,ge.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return ge.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,ge.t=function(s,n){if(1&n&&(s=this(s)),8&n)return s;if("object"==typeof s&&s){if(4&n&&s.__esModule)return s;if(16&n&&"function"==typeof s.then)return s}var i=Object.create(null);ge.r(i);var r={};e=e||[null,t({}),t([]),t(t)];for(var a=2&n&&s;("object"==typeof a||"function"==typeof a)&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach(e=>r[e]=()=>s[e]);return r.default=()=>s,ge.d(i,r),i},ge.d=(e,t)=>{for(var s in t)ge.o(t,s)&&!ge.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},ge.f={},ge.e=e=>Promise.all(Object.keys(ge.f).reduce((t,s)=>(ge.f[s](e,t),t),[])),ge.u=e=>e+"-"+{84:"7f89cbc916fed7fd1d8d",885:"0102d34e5f1f2b046ea6"}[e]+".js",ge.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),ge.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),ge.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},n="@jstpierre/noclip.website:",ge.l=(e,t,i,r)=>{if(s[e])s[e].push(t);else{var a,o;if(void 0!==i)for(var l=document.getElementsByTagName("script"),h=0;h<l.length;h++){var c=l[h];if(c.getAttribute("src")==e||c.getAttribute("data-webpack")==n+i){a=c;break}}a||(o=!0,(a=document.createElement("script")).charset="utf-8",ge.nc&&a.setAttribute("nonce",ge.nc),a.setAttribute("data-webpack",n+i),a.src=e),s[e]=[t];var u=(t,n)=>{a.onerror=a.onload=null,clearTimeout(d);var i=s[e];if(delete s[e],a.parentNode&&a.parentNode.removeChild(a),i&&i.forEach(e=>e(n)),t)return t(n)},d=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),o&&document.head.appendChild(a)}},ge.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;ge.g.importScripts&&(e=ge.g.location+"");var t=ge.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var n=s.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=s[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),ge.p=e})(),(()=>{var e={792:0};ge.f.j=(t,s)=>{var n=ge.o(e,t)?e[t]:void 0;if(0!==n)if(n)s.push(n[2]);else{var i=new Promise((s,i)=>n=e[t]=[s,i]);s.push(n[2]=i);var r=ge.p+ge.u(t),a=new Error;ge.l(r,s=>{if(ge.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var i=s&&("load"===s.type?"missing":s.type),r=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+i+": "+r+")",a.name="ChunkLoadError",a.type=i,a.request=r,n[1](a)}},"chunk-"+t,t)}};var t=(t,s)=>{var n,i,[r,a,o]=s,l=0;if(r.some(t=>0!==e[t])){for(n in a)ge.o(a,n)&&(ge.m[n]=a[n]);o&&o(ge)}for(t&&t(s);l<r.length;l++)i=r[l],ge.o(e,i)&&e[i]&&e[i][0](),e[i]=0},s=self.webpackChunk_jstpierre_noclip_website=self.webpackChunk_jstpierre_noclip_website||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),ue={},de={5403:function(){return{"./noclip_support_bg.js":{__wbg_wowwmomaterial_new:function(e){return void 0===i&&(i=ge.c[6548].exports),i._kp(e)},__wbg_wowvec3_new:function(e){return void 0===r&&(r=ge.c[6548].exports),r.nd8(e)},__wbindgen_string_new:function(e,t){return void 0===a&&(a=ge.c[6548].exports),a.ycJ(e,t)},__wbindgen_object_drop_ref:function(e){return void 0===o&&(o=ge.c[6548].exports),o.bkt(e)},__wbg_wowwmomaterialbatch_unwrap:function(e){return void 0===l&&(l=ge.c[6548].exports),l.bs0(e)},__wbg_wowwmomaterialinfo_unwrap:function(e){return void 0===h&&(h=ge.c[6548].exports),h.fpt(e)},__wbg_wowwmofog_unwrap:function(e){return void 0===c&&(c=ge.c[6548].exports),c.MqF(e)},__wbg_wowdoodaddef_unwrap:function(e){return void 0===u&&(u=ge.c[6548].exports),u.fgT(e)},__wbg_wowwmogroupinfo_unwrap:function(e){return void 0===d&&(d=ge.c[6548].exports),d.Z$g(e)},__wbg_wowwmomaterial_unwrap:function(e){return void 0===m&&(m=ge.c[6548].exports),m.x8Z(e)},__wbg_wowadtwmodefinition_new:function(e){return void 0===p&&(p=ge.c[6548].exports),p.FbL(e)},__wbg_wowwmobspnode_new:function(e){return void 0===f&&(f=ge.c[6548].exports),f.qsB(e)},__wbg_haloshadertransparencygeneric_new:function(e){return void 0===g&&(g=ge.c[6548].exports),g.$YN(e)},__wbg_halomodelpart_new:function(e){return void 0===T&&(T=ge.c[6548].exports),T.VpS(e)},__wbg_haloshadertransparencychicago_new:function(e){return void 0===x&&(x=ge.c[6548].exports),x.oO(e)},__wbg_wowwmoliquidresult_new:function(e){return void 0===v&&(v=ge.c[6548].exports),v.aKA(e)},__wbg_halobsp_new:function(e){return void 0===C&&(C=ge.c[6548].exports),C.O33(e)},__wbg_wowwmogroupinfo_new:function(e){return void 0===b&&(b=ge.c[6548].exports),b.O1C(e)},__wbg_wowskinsubmesh_new:function(e){return void 0===_&&(_=ge.c[6548].exports),_.uEz(e)},__wbg_wowwmoportalref_new:function(e){return void 0===y&&(y=ge.c[6548].exports),y.gC2(e)},__wbg_wowwmoportal_new:function(e){return void 0===S&&(S=ge.c[6548].exports),S.JJ5(e)},__wbg_wowdoodaddef_new:function(e){return void 0===w&&(w=ge.c[6548].exports),w.OJ4(e)},__wbg_wowm2legacytexture_new:function(e){return void 0===A&&(A=ge.c[6548].exports),A.zK0(e)},__wbg_haloshadermodel_new:function(e){return void 0===E&&(E=ge.c[6548].exports),E.XvI(e)},__wbg_haloshaderenvironment_new:function(e){return void 0===R&&(R=ge.c[6548].exports),R.Ncr(e)},__wbg_halomaterial_new:function(e){return void 0===I&&(I=ge.c[6548].exports),I.SJG(e)},__wbg_wowm2material_new:function(e){return void 0===k&&(k=ge.c[6548].exports),k.Al0(e)},__wbg_wowwmofog_new:function(e){return void 0===M&&(M=ge.c[6548].exports),M.PnN(e)},__wbg_wowm2boneflags_new:function(e){return void 0===P&&(P=ge.c[6548].exports),P.QJA(e)},__wbg_haloscenery_new:function(e){return void 0===D&&(D=ge.c[6548].exports),D.UkX(e)},__wbg_wowadtliquidlayer_new:function(e){return void 0===B&&(B=ge.c[6548].exports),B.m7O(e)},__wbg_wowmapfiledataids_new:function(e){return void 0===L&&(L=ge.c[6548].exports),L.acc(e)},__wbg_wowmodelbatch_new:function(e){return void 0===O&&(O=ge.c[6548].exports),O.RS1(e)},__wbg_halolightmap_new:function(e){return void 0===F&&(F=ge.c[6548].exports),F.DN1(e)},__wbg_wowwmomaterialinfo_new:function(e){return void 0===U&&(U=ge.c[6548].exports),U.URn(e)},__wbg_haloshadertransparentwater_new:function(e){return void 0===N&&(N=ge.c[6548].exports),N.nyP(e)},__wbg_halosceneryinstance_new:function(e){return void 0===X&&(X=ge.c[6548].exports),X.rnZ(e)},__wbg_wowwmomaterialbatch_new:function(e){return void 0===V&&(V=ge.c[6548].exports),V.gq9(e)},__wbg_wowadtchunkdescriptor_new:function(e){return void 0===G&&(G=ge.c[6548].exports),G.lVu(e)},__wbg_wowdoodad_new:function(e){return void 0===K&&(K=ge.c[6548].exports),K.Drf(e)},__wbg_halosky_new:function(e){return void 0===$&&($=ge.c[6548].exports),$.AWH(e)},__wbg_wowm2material_unwrap:function(e){return void 0===W&&(W=ge.c[6548].exports),W.lKZ(e)},__wbg_wowadtchunkdescriptor_unwrap:function(e){return void 0===H&&(H=ge.c[6548].exports),H.OQ2(e)},__wbg_wowskinsubmesh_unwrap:function(e){return void 0===Y&&(Y=ge.c[6548].exports),Y.FSz(e)},__wbg_wowmodelbatch_unwrap:function(e){return void 0===Z&&(Z=ge.c[6548].exports),Z.AOY(e)},__wbg_new_abda76e883ba8a5f:function(){return void 0===z&&(z=ge.c[6548].exports),z.V5T()},__wbg_stack_658279fe44541cf6:function(e,t){return void 0===j&&(j=ge.c[6548].exports),j.u$W(e,t)},__wbg_error_f851667af71bcfc6:function(e,t){return void 0===q&&(q=ge.c[6548].exports),q.Xur(e,t)},__wbg_log_5bb5f88f245d7762:function(e){return void 0===Q&&(Q=ge.c[6548].exports),Q.A9N(e)},__wbg_log_1746d5c75ec89963:function(e,t){return void 0===J&&(J=ge.c[6548].exports),J.Ogn(e,t)},__wbg_new_16b304a2cfa7ff4a:function(){return void 0===ee&&(ee=ge.c[6548].exports),ee.M22()},__wbg_push_a5b05aedc7234f9f:function(e,t){return void 0===te&&(te=ge.c[6548].exports),te.cow(e,t)},__wbg_buffer_12d079cc21e14bdb:function(e){return void 0===se&&(se=ge.c[6548].exports),se.Fmw(e)},__wbg_newwithbyteoffsetandlength_9fd64654bc0b0817:function(e,t,s){return void 0===ne&&(ne=ge.c[6548].exports),ne.mtA(e,t,s)},__wbg_new_d300acbe953d12e8:function(e){return void 0===ie&&(ie=ge.c[6548].exports),ie.Wyz(e)},__wbg_newwithbyteoffsetandlength_4a659d079a1650e0:function(e,t,s){return void 0===re&&(re=ge.c[6548].exports),re.oUX(e,t,s)},__wbg_set_bd975934d1b1fddb:function(e,t,s){return void 0===ae&&(ae=ge.c[6548].exports),ae.ctt(e,t,s)},__wbg_length_d25bbcbc3367f684:function(e){return void 0===oe&&(oe=ge.c[6548].exports),oe.jhn(e)},__wbg_setindex_e8a148aab2078037:function(e,t,s){return void 0===le&&(le=ge.c[6548].exports),le.LS8(e,t,s)},__wbindgen_throw:function(e,t){return void 0===he&&(he=ge.c[6548].exports),he.Qnr(e,t)},__wbindgen_memory:function(){return void 0===ce&&(ce=ge.c[6548].exports),ce.Py0()}}}}},me={885:[5403]},ge.w={},ge.f.wasm=function(e,t){(me[e]||[]).forEach(function(s,n){var i=ue[s];if(i)t.push(i);else{var r,a=de[s](),o=fetch(ge.p+""+{885:{5403:"bd8fe483625438d2f9a1"}}[e][s]+".module.wasm");r=a&&"function"==typeof a.then&&"function"==typeof WebAssembly.compileStreaming?Promise.all([WebAssembly.compileStreaming(o),a]).then(function(e){return WebAssembly.instantiate(e[0],e[1])}):"function"==typeof WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(o,a):o.then(function(e){return e.arrayBuffer()}).then(function(e){return WebAssembly.instantiate(e,a)}),t.push(ue[s]=r.then(function(e){return ge.w[s]=(e.instance||e).exports}))}})},ge(3996)})();